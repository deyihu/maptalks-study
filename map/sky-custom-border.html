<!DOCTYPE html>
<html>
<meta charset='UTF-8' />
<meta name='viewport' content='width=device-width, initial-scale=1' />
<title>3dtiles功能示例 - 模型单体化</title>
<style type='text/css'>
    html,
    body {
        margin: 0px;
        height: 100%;
        width: 100%;
        overflow: hidden;
    }

    .container {
        width: 100%;
        height: 100%;
        /* background-color: gray; */
    }
</style>
<link rel='stylesheet' href='./../assets/lib/maptalks/maptalks.css' />
<script type='text/javascript' src='./../assets/lib/maptalks/maptalks-gl.js'></script>
<script type='text/javascript' src='./../assets/lib/lil-gui.min.js'></script>

<body>

    <div id="map" class="container"></div>

    <script>
        const map = new maptalks.Map("map", {
            center: [123, 41],
            zoom: 10,
            pitch: 80,
            bearing: 0
        });






        class SkyLayer extends maptalks.Layer {

            //设置天空盒图片
            setSky(skyUrl) {
                this.skyUrl = skyUrl;
                this.loading = false;
                this.skyImage = null;
                this._loadImage();

            }

            getSky() {
                return this.skyUrl;
            }

            //设置天空盒底部偏移量
            setBottomY(y) {
                this.bottomY = y;
                const renderer = this.getRenderer();
                renderer.setToRedraw();
            }

            _loadImage() {
                if (this.loading) {
                    return this;
                }
                const image = new Image();
                image.onload = () => {
                    this.skyImage = image;
                    this.loading = false;
                    const renderer = this.getRenderer();
                    renderer.setToRedraw();
                    this.fire('skyload', { skyUrl: this.skyUrl });

                };
                image.onerror = () => {
                    this.fire('skyloaderror', { skyUrl: this.skyUrl });
                }
                image.src = this.skyUrl;
                this.loading = true;
            }
        }

        // 定义默认的图层配置属性
        SkyLayer.mergeOptions({
            zIndex: -Infinity,
            forceRenderOnMoving: true,
            forceRenderOnZooming: true,
            forceRenderOnRotating: true
        });

        class SkyLayerRenderer extends maptalks.renderer.CanvasRenderer {
            checkResources() {
                // HelloLayer只是绘制文字, 没有外部图片, 所以返回空数组
                return [];
            }

            draw() {
                this._drawSky();
                this.completeRender();
            }

            drawOnInteracting(evtParam) {
                this._drawSky();
                this.completeRender();
            }

            _drawSky() {
                const layer = this.layer;
                if (!layer) {
                    return;
                }
                this.prepareCanvas();
                const ctx = this.context;
                ctx.canvas._drawn = false;
                const skyImage = this.layer.skyImage;
                const bottomY = this.layer.bottomY || 0;
                const map = layer.getMap();
                const height = map.getGroundExtent().ymin;
                if (height > 0) {
                    const width = map.width;
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.rect(0, 0, width, height);
                    ctx.stroke();

                }


                return true;
            }
        }

        SkyLayer.registerRenderer('canvas', SkyLayerRenderer);



        const baseLayer = new maptalks.TileLayer("base", {
            // debug: true,
            urlTemplate: "https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
            subdomains: ["a", "b", "c", "d"],
            maxAvailableZoom: 18,
        });
        const groupLayer = new maptalks.GroupGLLayer("group", [baseLayer], {

        }).addTo(map);



        // map.setView({
        //     "center": [120.06864866, 30.12911788, 430.3062438964844], "zoom": 12.814714048170666, "pitch": 56.45000000000009, "bearing": 2.7148818684635216
        // })

        map.setView({
            "center": [118.25079334, 30.1210681, 430.3062438964844], "zoom": 11.892086520379873, "pitch": 80.64999999999992, "bearing": 112.90705084326646
        })

        const skyLayer = new SkyLayer('sky').addTo(map);
        skyLayer.setZIndex(-1000);






    </script>
</body>

</html>