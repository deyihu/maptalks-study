/*!
 * maptalks.three v0.41.2
 * LICENSE : MIT
 * (c) 2016-2025 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("three")):"function"==typeof define&&define.amd?define(["exports","maptalks","three"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).maptalks=t.maptalks||{},t.maptalks,t.THREE)}(this,(function(t,e,n){"use strict";function i(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,i.get?i:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}var r=i(e),s=i(n);const o=parseInt(s.REVISION.replace("dev",""));function a(t,e,n){return o>109?t.setAttribute(e,n):t.addAttribute(e,n),t}function h(){return s}function c(){return(t=h()).VertexColors?t.VertexColors:2;var t}function l(t,e,n){const i=h();return o>=144?new i.BoxGeometry(t,e,n):i.BoxBufferGeometry?new i.BoxBufferGeometry(t,e,n):i.BoxGeometry?new i.BoxGeometry(t,e,n):void 0}console.log(`maptalks.three log: current three.js version is %c${o}`,"color:red;font-size: 16px;font-weight: bold;");class u extends s.InstancedBufferGeometry{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),a(this,"position",new s.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),a(this,"uv",new s.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}applyMatrix(t){var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==e&&(t.applyToBufferAttribute(e),t.applyToBufferAttribute(n),e.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}setPositions(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new s.InstancedInterleavedBuffer(e,6,1);return a(this,"instanceStart",new s.InterleavedBufferAttribute(n,3,0)),a(this,"instanceEnd",new s.InterleavedBufferAttribute(n,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new s.InstancedInterleavedBuffer(e,6,1);return a(this,"instanceColorStart",new s.InterleavedBufferAttribute(n,3,0)),a(this,"instanceColorEnd",new s.InterleavedBufferAttribute(n,3,3)),this}fromWireframeGeometry(t){return this.setPositions(t.attributes.position.array),this}fromEdgesGeometry(t){return this.setPositions(t.attributes.position.array),this}fromMesh(t){return this.fromWireframeGeometry(new s.WireframeGeometry(t.geometry)),this}fromLineSegements(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this}computeBoundingBox(){var t=new s.Box3;null===this.boundingBox&&(this.boundingBox=new s.Box3);var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;void 0!==e&&void 0!==n&&(this.boundingBox.setFromBufferAttribute(e),t.setFromBufferAttribute(n),this.boundingBox.union(t))}computeBoundingSphere(){var t=new s.Vector3;null===this.boundingSphere&&(this.boundingSphere=new s.Sphere),null===this.boundingBox&&this.computeBoundingBox();var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;if(void 0!==e&&void 0!==n){var i=this.boundingSphere.center;this.boundingBox.getCenter(i);for(var r=0,o=0,a=e.count;o<a;o++)t.fromBufferAttribute(e,o),r=Math.max(r,i.distanceToSquared(t)),t.fromBufferAttribute(n,o),r=Math.max(r,i.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}copy(t){return this}}const d={},f={};d.line={linewidth:{value:1},resolution:{value:new s.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},f.line={uniforms:s.UniformsUtils.merge([s.UniformsLib.common,s.UniformsLib.fog,d.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"};class p extends s.ShaderMaterial{constructor(t){super({uniforms:s.UniformsUtils.clone(f.line.uniforms),vertexShader:f.line.vertexShader,fragmentShader:f.line.fragmentShader}),this.dashed=!0,this.isLineMaterial=!0,this.type="LineMaterial",Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),this.setValues(t)}}class g extends s.Mesh{constructor(t,e){super(t,e),this.isLineSegments2=!0,this.type="LineSegments2",this.geometry=void 0!==t?t:new u,this.material=void 0!==e?e:new p({color:16777215*Math.random()})}computeLineDistances(){var t=new s.Vector3,e=new s.Vector3,n=this.geometry,i=n.attributes.instanceStart,r=n.attributes.instanceEnd;if(!i||!r)return this;for(var o=new Float32Array(2*i.data.count),h=0,c=0,l=i.data.count;h<l;h++,c+=2)t.fromBufferAttribute(i,h),e.fromBufferAttribute(r,h),o[c]=0===c?0:o[c-1],o[c+1]=o[c]+t.distanceTo(e);var u=new s.InstancedInterleavedBuffer(o,2,1);return a(n,"instanceDistanceStart",new s.InterleavedBufferAttribute(u,1,0)),a(n,"instanceDistanceEnd",new s.InterleavedBufferAttribute(u,1,1)),this}}class y extends u{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}fromLine(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this}}class x extends g{constructor(t,e){super(t,e),this.isLine2=!0,this.type="Line2",this.geometry=void 0!==t?t:new y,this.material=void 0!==e?e:new p({color:16777215*Math.random()})}copy(t){return this}}const m={interactive:!0,altitude:0,minZoom:0,maxZoom:30,asynchronous:!1,bloom:!1,pickWeight:-1};function _(){}class v extends(r.Eventable(_)){constructor(t){super(),this.isAdd=!1,this._mouseover=!1,this._visible=!0,this._zoomVisible=!0,this.picked=!1,this.isBaseObject=!0,void 0===t&&(t=r.Util.GUID()),this.id=t}addTo(t){return t&&"ThreeLayer"===t.type?t.addMesh([this]):console.error("layer only support maptalks.ThreeLayer"),this}remove(){const t=this.getLayer();return t&&t.removeMesh([this]),this}getObject3d(){return this.object3d}getId(){return this.id}setId(t){const e=this.getId();return this.id=t,this._fire("idchange",{old:e,new:t,target:this}),this}getType(){return this.type}getOptions(){return this.options}getProperties(){return(this.options||{}).properties}setProperties(t){const e=Object.assign({},this.getProperties());return this.options.properties=t,this._fire("propertieschange",{old:e,new:t,target:this}),this}getLayer(){return this.options.layer}getMap(){const t=this.getLayer();if(t)return t.getMap()}getCenter(){const t=this.getOptions(),{coordinate:e,lineString:n,polygon:i}=t;if(e)return e instanceof r.Coordinate?e:new r.Coordinate(e);{const t=i||n;if(t&&t.getCenter)return t.getCenter()}}getAltitude(){return this.getOptions().altitude}setAltitude(t){if(r.Util.isNumber(t)){const e=this.getLayer().altitudeToVector3(t,t).x;if(this.getObject3d().position.z=e,this.options.altitude=t,this.pickObject3d&&(this.pickObject3d.position.z=e),this._baseObjects&&Array.isArray(this._baseObjects))for(let t=0,n=this._baseObjects.length;t<n;t++)this._baseObjects[t]&&(this._baseObjects[t].getObject3d().position.z=e)}return this}supportHeight(){return this.getOptions().heightEnable}getHeight(){const{height:t}=this.getOptions();return r.Util.isNumber(t)?t:0}setHeight(t){if(!r.Util.isNumber(t)||this._baseObjects||!this.supportHeight())return this;const e=this.getLayer();if(!e)return this;const{geometry:n}=this.getObject3d();if(n instanceof s.BufferGeometry){const{position:i}=n.attributes||{};if(!i)return this;const r=i.array;let s=1/0,o=-1/0;for(let t=0,e=r.length;t<e;t+=3){const e=r[t+2];s=Math.min(e,s),o=Math.max(e,o)}const a=(s+o)/2;let h=e.altitudeToVector3(t,t).x;h=Math.max(h,1e-6);for(let t=0,e=r.length;t<e;t+=3)r[t+2]>a&&(r[t+2]=h);n.attributes.position.needsUpdate=!0,n.computeBoundingBox(),n.computeBoundingSphere(),this.getOptions().height=t}return this}show(){return this._zoomVisible&&(this.getObject3d().visible=!0,this._fire("show")),this._visible=!0,this}hide(){return this.getObject3d().visible=!1,this._fire("hide"),this._visible=!1,this._hideUI(),this}isVisible(){return!!this.getObject3d().visible}getSymbol(){return this.getObject3d().material}setSymbol(t){if(t&&t instanceof s.Material){t.needsUpdate=!0,t.vertexColors=this.getObject3d().material.vertexColors;const e=this.getObject3d().material.clone();this.getObject3d().material=t,this._fire("symbolchange",{old:e,new:t,target:this})}return this}setInfoWindow(t){return this.removeInfoWindow(),this.infoWindow=new r.ui.InfoWindow(t),this.infoWindow.addTo(this),this}getInfoWindow(){return this.infoWindow}openInfoWindow(t){return(t=t||this.getCenter())instanceof r.Coordinate||(t=new r.Coordinate(t)),t&&this.infoWindow&&this.infoWindow.show(t),this}closeInfoWindow(){return this.infoWindow&&this.infoWindow.hide(),this}removeInfoWindow(){return this.infoWindow&&(this.infoWindow.remove(),delete this.infoWindow),this}setToolTip(t,e){return this.removeToolTip(),this.toolTip=new r.ui.ToolTip(t,e),this.toolTip.addTo(this),this}getToolTip(){return this.toolTip}openToolTip(t){return this}closeToolTip(){return this.toolTip&&this.toolTip.hide(),this}removeToolTip(){return this.toolTip&&(this.toolTip.remove(),delete this.toolTip),this}_hideUI(){return this.closeInfoWindow(),this.closeToolTip(),this}animateShow(t={},e){this._showPlayer&&this._showPlayer.cancel(),r.Util.isFunction(t)&&(e=t={});const n=t.duration||1e3,i=t.easing||"out",s=this._showPlayer=r.animation.Animation.animate({scale:1},{duration:n,easing:i},(t=>{const n=t.styles.scale;n>0&&(this.getObject3d().scale.z=n),e&&e(t,n)}));return s.play(),s}getMinZoom(){return this.getOptions().minZoom}getMaxZoom(){return this.getOptions().maxZoom}isAsynchronous(){return this.getOptions().asynchronous}get bloom(){return this.getOptions().bloom}fire(t,e){return this._fire(t,e),this._vt&&this._vt.onSelectMesh&&this._vt.onSelectMesh(t,e),this}config(){return this}setPickObject3d(t){return this.pickObject3d=t,this.pickObject3d.__parent=this,this}getPickObject3d(){return this.pickObject3d}_initOptions(t){return this.options=r.Util.extend({},m,t),this}_createMesh(t,e){return this.object3d=new s.Mesh(t,e),this.object3d.__parent=this,this}_createInstancedMesh(t,e,n){return this.object3d=new s.InstancedMesh(t,e,n),this.object3d.__parent=this,this}_createGroup(){return this.object3d=new s.Group,this.object3d.__parent=this,this}_createLine(t,e){return this.object3d=new s.Line(t,e),this._computeLineDistances(t),this.object3d.__parent=this,this}_createLine2(t,e){return this.object3d=new x(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this}_createPoints(t,e){return this.object3d=new s.Points(t,e),this.object3d.__parent=this,this}_createLineSegments(t,e){return this.object3d=new s.LineSegments(t,e),this._computeLineDistances(t),this.object3d.__parent=this,this}_computeLineDistances(t){const e=t.attributes.position.array,n=t.attributes.position.count,i=new Float32Array(n);i[0]=0;const r=new s.Vector3(0,0,0),o=new s.Vector3(0,0,0);for(let t=1;t<n;t++){const n=3*(t-1);r.x=e[n],r.y=e[n+1],r.z=e[n+2];const s=3*t;o.x=e[s],o.y=e[s+1],o.z=e[s+2];const a=o.distanceTo(r);i[t]=i[t-1]+a}a(t,"lineDistance",new s.BufferAttribute(i,1))}}const b=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"];function w(t){return t.geometry?t.geometry.type:null}function M(t){const e=w(t);if(e)for(let t=0,n=b.length;t<n;t++)if(b[t]===e)return!0;return!1}function z(t){const e=w(t);return!(!e||e!==b[4]&&e!==b[5])}function O(t){const e=w(t);return!(!e||e!==b[2]&&e!==b[3])}function A(t){const e=w(t);return!(!e||e!==b[0]&&e!==b[1])}function S(t){const e=w(t);return!!(e&&e.indexOf("Multi")>-1)}function j(t){return t.geometry?t.geometry.coordinates:[]}function C(t,e){const n=w(t);if(!n||!t.geometry)return null;const i=t.geometry.coordinates;if(!i)return null;let s=0,o=0,a=0;switch(n){case"Point":s=i[0],o=i[1],a++;break;case"MultiPoint":case"LineString":for(let t=0,e=i.length;t<e;t++)s+=i[t][0],o+=i[t][1],a++;break;case"MultiLineString":case"Polygon":for(let t=0,e=i.length;t<e;t++)for(let e=0,n=i[t].length;e<n;e++)s+=i[t][e][0],o+=i[t][e][1],a++;break;case"MultiPolygon":for(let t=0,e=i.length;t<e;t++)for(let e=0,n=i[t].length;e<n;e++)for(let n=0,r=i[t][e].length;n<r;n++)s+=i[t][e][n][0],o+=i[t][e][n][1],a++}const h=s/a,c=o/a;return e?(e.x=h,e.y=c,e):new r.Coordinate(h,c)}function k(t){const e=w(t);if(!e||!t.geometry)return null;const n=t.geometry,i=t.properties||{},r=n.coordinates;if(!r)return null;const s=[];let o;switch(e){case"MultiPoint":o="Point";break;case"MultiLineString":o="LineString";break;case"MultiPolygon":o="Polygon"}if(o)for(let t=0,e=r.length;t<e;t++)s.push({type:"Feature",geometry:{type:o,coordinates:r[t]},properties:i});else s.push(t);return s}var T=Object.freeze({__proto__:null,isGeoJSON:M,isGeoJSONPolygon:z,isGeoJSONLine:O,isGeoJSONPoint:A,isGeoJSONMulti:S,getGeoJSONCoordinates:j,getGeoJSONCenter:C,spliteGeoJSONMulti:k});
/*!
     * poly-extrude v0.16.0
      */function P(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function V(t,e){return V=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},V(t,e)}function L(t,e,n){void 0===n&&(n=2);var i,r,s,o=e&&e.length,a=o?e[0]*n:t.length,h=B(t,0,a,n,!0),c=[];if(!h||h.next===h.prev)return c;if(o&&(h=function(t,e,n,i){for(var r=[],s=0,o=e.length;s<o;s++){var a=B(t,e[s]*i,s<o-1?e[s+1]*i:t.length,i,!1);a===a.next&&(a.steiner=!0),r.push(W(a))}r.sort(Z);for(var h=0;h<r.length;h++)n=Q(r[h],n);return n}(t,e,h,n)),t.length>80*n){i=1/0,r=1/0;for(var l=-1/0,u=-1/0,d=n;d<a;d+=n){var f=t[d],p=t[d+1];f<i&&(i=f),p<r&&(r=p),f>l&&(l=f),p>u&&(u=p)}s=0!==(s=Math.max(l-i,u-r))?32767/s:0}return E(h,c,n,i,r,s,0),c}function B(t,e,n,i,r){var s;if(r===function(t,e,n,i){for(var r=0,s=e,o=n-i;s<n;s+=i)r+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return r}(t,e,n,i)>0)for(var o=e;o<n;o+=i)s=it(o/i|0,t[o],t[o+1],s);else for(var a=n-i;a>=e;a-=i)s=it(a/i|0,t[a],t[a+1],s);return s&&Y(s,s.next)&&(rt(s),s=s.next),s}function U(t,e){if(!t)return t;e||(e=t);var n,i=t;do{if(n=!1,i.steiner||!Y(i,i.next)&&0!==K(i.prev,i,i.next))i=i.next;else{if(rt(i),(i=e=i.prev)===i.next)break;n=!0}}while(n||i!==e);return e}function E(t,e,n,i,r,s,o){if(t){!o&&s&&function(t,e,n,i){var r=t;do{0===r.z&&(r.z=H(r.x,r.y,e,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e,n=1;do{var i=t,r=void 0;t=null;var s=null;for(e=0;i;){e++;for(var o=i,a=0,h=0;h<n&&(a++,o=o.nextZ);h++);for(var c=n;a>0||c>0&&o;)0!==a&&(0===c||!o||i.z<=o.z)?(r=i,i=i.nextZ,a--):(r=o,o=o.nextZ,c--),s?s.nextZ=r:t=r,r.prevZ=s,s=r;i=o}s.nextZ=null,n*=2}while(e>1)}(r)}(t,i,r,s);for(var a=t;t.prev!==t.next;){var h=t.prev,c=t.next;if(s?F(t,i,r,s):I(t))e.push(h.i,t.i,c.i),rt(t),t=c.next,a=c.next;else if((t=c)===a){o?1===o?E(t=R(U(t),e),e,n,i,r,s,2):2===o&&G(t,e,n,i,r,s):E(U(t),e,n,i,r,s,1);break}}}}function I(t){var e=t.prev,n=t,i=t.next;if(K(e,n,i)>=0)return!1;for(var r=e.x,s=n.x,o=i.x,a=e.y,h=n.y,c=i.y,l=Math.min(r,s,o),u=Math.min(a,h,c),d=Math.max(r,s,o),f=Math.max(a,h,c),p=i.next;p!==e;){if(p.x>=l&&p.x<=d&&p.y>=u&&p.y<=f&&N(r,a,s,h,o,c,p.x,p.y)&&K(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function F(t,e,n,i){var r=t.prev,s=t,o=t.next;if(K(r,s,o)>=0)return!1;for(var a=r.x,h=s.x,c=o.x,l=r.y,u=s.y,d=o.y,f=Math.min(a,h,c),p=Math.min(l,u,d),g=Math.max(a,h,c),y=Math.max(l,u,d),x=H(f,p,e,n,i),m=H(g,y,e,n,i),_=t.prevZ,v=t.nextZ;_&&_.z>=x&&v&&v.z<=m;){if(_.x>=f&&_.x<=g&&_.y>=p&&_.y<=y&&_!==r&&_!==o&&N(a,l,h,u,c,d,_.x,_.y)&&K(_.prev,_,_.next)>=0)return!1;if(_=_.prevZ,v.x>=f&&v.x<=g&&v.y>=p&&v.y<=y&&v!==r&&v!==o&&N(a,l,h,u,c,d,v.x,v.y)&&K(v.prev,v,v.next)>=0)return!1;v=v.nextZ}for(;_&&_.z>=x;){if(_.x>=f&&_.x<=g&&_.y>=p&&_.y<=y&&_!==r&&_!==o&&N(a,l,h,u,c,d,_.x,_.y)&&K(_.prev,_,_.next)>=0)return!1;_=_.prevZ}for(;v&&v.z<=m;){if(v.x>=f&&v.x<=g&&v.y>=p&&v.y<=y&&v!==r&&v!==o&&N(a,l,h,u,c,d,v.x,v.y)&&K(v.prev,v,v.next)>=0)return!1;v=v.nextZ}return!0}function R(t,e){var n=t;do{var i=n.prev,r=n.next.next;!Y(i,r)&&J(i,n,n.next,r)&&et(i,r)&&et(r,i)&&(e.push(i.i,n.i,r.i),rt(n),rt(n.next),n=t=r),n=n.next}while(n!==t);return U(n)}function G(t,e,n,i,r,s){var o=t;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&X(o,a)){var h=nt(o,a);return o=U(o,o.next),h=U(h,h.next),E(o,e,n,i,r,s,0),void E(h,e,n,i,r,s,0)}a=a.next}o=o.next}while(o!==t)}function Z(t,e){var n=t.x-e.x;0===n&&(0===(n=t.y-e.y)&&(n=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)));return n}function Q(t,e){var n=function(t,e){var n,i=e,r=t.x,s=t.y,o=-1/0;if(Y(t,i))return i;do{if(Y(t,i.next))return i.next;if(s<=i.y&&s>=i.next.y&&i.next.y!==i.y){var a=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(a<=r&&a>o&&(o=a,n=i.x<i.next.x?i:i.next,a===r))return n}i=i.next}while(i!==e);if(!n)return null;var h=n,c=n.x,l=n.y,u=1/0;i=n;do{if(r>=i.x&&i.x>=c&&r!==i.x&&q(s<l?r:o,s,c,l,s<l?o:r,s,i.x,i.y)){var d=Math.abs(s-i.y)/(r-i.x);et(i,t)&&(d<u||d===u&&(i.x>n.x||i.x===n.x&&D(n,i)))&&(n=i,u=d)}i=i.next}while(i!==h);return n}(t,e);if(!n)return e;var i=nt(n,t);return U(i,i.next),U(n,n.next)}function D(t,e){return K(t.prev,t,e.prev)<0&&K(e.next,t,t.next)<0}function H(t,e,n,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function W(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function q(t,e,n,i,r,s,o,a){return(r-o)*(e-a)>=(t-o)*(s-a)&&(t-o)*(i-a)>=(n-o)*(e-a)&&(n-o)*(s-a)>=(r-o)*(i-a)}function N(t,e,n,i,r,s,o,a){return!(t===o&&e===a)&&q(t,e,n,i,r,s,o,a)}function X(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&J(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(et(t,e)&&et(e,t)&&function(t,e){var n=t,i=!1,r=(t.x+e.x)/2,s=(t.y+e.y)/2;do{n.y>s!=n.next.y>s&&n.next.y!==n.y&&r<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)&&(K(t.prev,t,e.prev)||K(t,e.prev,e))||Y(t,e)&&K(t.prev,t,t.next)>0&&K(e.prev,e,e.next)>0)}function K(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function Y(t,e){return t.x===e.x&&t.y===e.y}function J(t,e,n,i){var r=tt(K(t,e,n)),s=tt(K(t,e,i)),o=tt(K(n,i,t)),a=tt(K(n,i,e));return r!==s&&o!==a||(!(0!==r||!$(t,n,e))||(!(0!==s||!$(t,i,e))||(!(0!==o||!$(n,t,i))||!(0!==a||!$(n,e,i)))))}function $(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function tt(t){return t>0?1:t<0?-1:0}function et(t,e){return K(t.prev,t,t.next)<0?K(t,e,t.next)>=0&&K(t,t.prev,e)>=0:K(t,e,t.prev)<0||K(t,t.next,e)<0}function nt(t,e){var n=st(t.i,t.x,t.y),i=st(e.i,e.x,e.y),r=t.next,s=e.prev;return t.next=e,e.prev=t,n.next=r,r.prev=n,i.next=n,n.prev=i,s.next=i,i.prev=s,i}function it(t,e,n,i){var r=st(t,e,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function rt(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function st(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}var ot=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),this.isQuaternion=!0,this._x=t,this._y=e,this._z=n,this._w=i}t.slerpFlat=function(t,e,n,i,r,s,o){var a=n[i+0],h=n[i+1],c=n[i+2],l=n[i+3],u=r[s+0],d=r[s+1],f=r[s+2],p=r[s+3];if(0===o)return t[e+0]=a,t[e+1]=h,t[e+2]=c,void(t[e+3]=l);if(1===o)return t[e+0]=u,t[e+1]=d,t[e+2]=f,void(t[e+3]=p);if(l!==p||a!==u||h!==d||c!==f){var g=1-o,y=a*u+h*d+c*f+l*p,x=y>=0?1:-1,m=1-y*y;if(m>Number.EPSILON){var _=Math.sqrt(m),v=Math.atan2(_,y*x);g=Math.sin(g*v)/_,o=Math.sin(o*v)/_}var b=o*x;if(a=a*g+u*b,h=h*g+d*b,c=c*g+f*b,l=l*g+p*b,g===1-o){var w=1/Math.sqrt(a*a+h*h+c*c+l*l);a*=w,h*=w,c*=w,l*=w}}t[e]=a,t[e+1]=h,t[e+2]=c,t[e+3]=l},t.multiplyQuaternionsFlat=function(t,e,n,i,r,s){var o=n[i],a=n[i+1],h=n[i+2],c=n[i+3],l=r[s],u=r[s+1],d=r[s+2],f=r[s+3];return t[e]=o*f+c*l+a*d-h*u,t[e+1]=a*f+c*u+h*l-o*d,t[e+2]=h*f+c*d+o*u-a*l,t[e+3]=c*f-o*l-a*u-h*d,t};var e,n,i,r=t.prototype;return r.set=function(t,e,n,i){return this._x=t,this._y=e,this._z=n,this._w=i,this._onChangeCallback(),this},r.clone=function(){return new this.constructor(this._x,this._y,this._z,this._w)},r.copy=function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this},r.setFromEuler=function(t,e){void 0===e&&(e=!0);var n=t._x,i=t._y,r=t._z,s=t._order,o=Math.cos,a=Math.sin,h=o(n/2),c=o(i/2),l=o(r/2),u=a(n/2),d=a(i/2),f=a(r/2);switch(s){case"XYZ":this._x=u*c*l+h*d*f,this._y=h*d*l-u*c*f,this._z=h*c*f+u*d*l,this._w=h*c*l-u*d*f;break;case"YXZ":this._x=u*c*l+h*d*f,this._y=h*d*l-u*c*f,this._z=h*c*f-u*d*l,this._w=h*c*l+u*d*f;break;case"ZXY":this._x=u*c*l-h*d*f,this._y=h*d*l+u*c*f,this._z=h*c*f+u*d*l,this._w=h*c*l-u*d*f;break;case"ZYX":this._x=u*c*l-h*d*f,this._y=h*d*l+u*c*f,this._z=h*c*f-u*d*l,this._w=h*c*l+u*d*f;break;case"YZX":this._x=u*c*l+h*d*f,this._y=h*d*l+u*c*f,this._z=h*c*f-u*d*l,this._w=h*c*l-u*d*f;break;case"XZY":this._x=u*c*l-h*d*f,this._y=h*d*l-u*c*f,this._z=h*c*f+u*d*l,this._w=h*c*l+u*d*f;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+s)}return!0===e&&this._onChangeCallback(),this},r.setFromAxisAngle=function(t,e){var n=e/2,i=Math.sin(n);return this._x=t.x*i,this._y=t.y*i,this._z=t.z*i,this._w=Math.cos(n),this._onChangeCallback(),this},r.setFromRotationMatrix=function(t){var e=t.elements,n=e[0],i=e[4],r=e[8],s=e[1],o=e[5],a=e[9],h=e[2],c=e[6],l=e[10],u=n+o+l;if(u>0){var d=.5/Math.sqrt(u+1);this._w=.25/d,this._x=(c-a)*d,this._y=(r-h)*d,this._z=(s-i)*d}else if(n>o&&n>l){var f=2*Math.sqrt(1+n-o-l);this._w=(c-a)/f,this._x=.25*f,this._y=(i+s)/f,this._z=(r+h)/f}else if(o>l){var p=2*Math.sqrt(1+o-n-l);this._w=(r-h)/p,this._x=(i+s)/p,this._y=.25*p,this._z=(a+c)/p}else{var g=2*Math.sqrt(1+l-n-o);this._w=(s-i)/g,this._x=(r+h)/g,this._y=(a+c)/g,this._z=.25*g}return this._onChangeCallback(),this},r.setFromUnitVectors=function(t,e){var n=t.dot(e)+1;return n<Number.EPSILON?(n=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=n):(this._x=0,this._y=-t.z,this._z=t.y,this._w=n)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=n),this.normalize()},r.rotateTowards=function(t,e){var n=this.angleTo(t);if(0===n)return this;var i=Math.min(1,e/n);return this.slerp(t,i),this},r.identity=function(){return this.set(0,0,0,1)},r.invert=function(){return this.conjugate()},r.conjugate=function(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this},r.dot=function(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w},r.lengthSq=function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},r.length=function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},r.normalize=function(){var t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this},r.multiply=function(t){return this.multiplyQuaternions(this,t)},r.premultiply=function(t){return this.multiplyQuaternions(t,this)},r.multiplyQuaternions=function(t,e){var n=t._x,i=t._y,r=t._z,s=t._w,o=e._x,a=e._y,h=e._z,c=e._w;return this._x=n*c+s*o+i*h-r*a,this._y=i*c+s*a+r*o-n*h,this._z=r*c+s*h+n*a-i*o,this._w=s*c-n*o-i*a-r*h,this._onChangeCallback(),this},r.slerp=function(t,e){if(0===e)return this;if(1===e)return this.copy(t);var n=this._x,i=this._y,r=this._z,s=this._w,o=s*t._w+n*t._x+i*t._y+r*t._z;if(o<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,o=-o):this.copy(t),o>=1)return this._w=s,this._x=n,this._y=i,this._z=r,this;var a=1-o*o;if(a<=Number.EPSILON){var h=1-e;return this._w=h*s+e*this._w,this._x=h*n+e*this._x,this._y=h*i+e*this._y,this._z=h*r+e*this._z,this.normalize(),this}var c=Math.sqrt(a),l=Math.atan2(c,o),u=Math.sin((1-e)*l)/c,d=Math.sin(e*l)/c;return this._w=s*u+this._w*d,this._x=n*u+this._x*d,this._y=i*u+this._y*d,this._z=r*u+this._z*d,this._onChangeCallback(),this},r.slerpQuaternions=function(t,e,n){return this.copy(t).slerp(e,n)},r.random=function(){var t=2*Math.PI*Math.random(),e=2*Math.PI*Math.random(),n=Math.random(),i=Math.sqrt(1-n),r=Math.sqrt(n);return this.set(i*Math.sin(t),i*Math.cos(t),r*Math.sin(e),r*Math.cos(e))},r.equals=function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w},r.fromArray=function(t,e){return void 0===e&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this},r.toArray=function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t},r.fromBufferAttribute=function(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this._onChangeCallback(),this},r.toJSON=function(){return this.toArray()},r._onChange=function(t){return this._onChangeCallback=t,this},r._onChangeCallback=function(){},e=t,(n=[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onChangeCallback()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onChangeCallback()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this._onChangeCallback()}},{key:"w",get:function(){return this._w},set:function(t){this._w=t,this._onChangeCallback()}}])&&P(e.prototype,n),i&&P(e,i),Object.defineProperty(e,"prototype",{writable:!1}),t}(),at=new ot,ht=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=n}var e=t.prototype;return e.set=function(t,e,n){return void 0===n&&(n=this.z),this.x=t,this.y=e,this.z=n,this},e.clone=function(){return new this.constructor(this.x,this.y,this.z)},e.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},e.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},e.addScalar=function(t){return this.x+=t,this.y+=t,this.z+=t,this},e.addVectors=function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},e.addScaledVector=function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this},e.sub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},e.subScalar=function(t){return this.x-=t,this.y-=t,this.z-=t,this},e.subVectors=function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},e.multiply=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},e.multiplyScalar=function(t){return this.x*=t,this.y*=t,this.z*=t,this},e.multiplyVectors=function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this},e.applyAxisAngle=function(t,e){return this.applyQuaternion(at.setFromAxisAngle(t,e))},e.applyMatrix4=function(t){var e=this.x,n=this.y,i=this.z,r=t.elements,s=1/(r[3]*e+r[7]*n+r[11]*i+r[15]);return this.x=(r[0]*e+r[4]*n+r[8]*i+r[12])*s,this.y=(r[1]*e+r[5]*n+r[9]*i+r[13])*s,this.z=(r[2]*e+r[6]*n+r[10]*i+r[14])*s,this},e.applyQuaternion=function(t){var e=this.x,n=this.y,i=this.z,r=t.x,s=t.y,o=t.z,a=t.w,h=a*e+s*i-o*n,c=a*n+o*e-r*i,l=a*i+r*n-s*e,u=-r*e-s*n-o*i;return this.x=h*a+u*-r+c*-o-l*-s,this.y=c*a+u*-s+l*-r-h*-o,this.z=l*a+u*-o+h*-s-c*-r,this},e.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},e.divideScalar=function(t){return this.multiplyScalar(1/t)},e.min=function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this},e.max=function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this},e.clamp=function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this},e.clampScalar=function(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this},e.clampLength=function(t,e){var n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(t,Math.min(e,n)))},e.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},e.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z},e.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},e.normalize=function(){return this.divideScalar(this.length()||1)},e.setLength=function(t){return this.normalize().multiplyScalar(t)},e.lerp=function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this},e.lerpVectors=function(t,e,n){return this.x=t.x+(e.x-t.x)*n,this.y=t.y+(e.y-t.y)*n,this.z=t.z+(e.z-t.z)*n,this},e.cross=function(t){return this.crossVectors(this,t)},e.crossVectors=function(t,e){var n=t.x,i=t.y,r=t.z,s=e.x,o=e.y,a=e.z;return this.x=i*a-r*o,this.y=r*s-n*a,this.z=n*o-i*s,this},e.distanceTo=function(t){return Math.sqrt(this.distanceToSquared(t))},e.equals=function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},e.fromArray=function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this},e.random=function(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this},t}();function ct(t){let e,n,i=0,r=1;const s=t.length;for(;r<s;)e=n||t[0],n=t[r],i+=(n[0]-e[0])*(n[1]+e[1]),r++;return i>0}function lt(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function ut(t,e){const n=e[0],i=e[1],r=e[2],s=Math.sqrt(n*n+i*i+r*r)||1;return t[0]=n/s,t[1]=i/s,t[2]=r/s,t}function dt(t,e,n){const i=e[0],r=e[1],s=e[2],o=n[0],a=n[1],h=n[2];return t[0]=r*h-s*a,t[1]=s*o-i*h,t[2]=i*a-r*o,t}function ft(t,e){function n(t,e,n,i){t[0]=e,t[1]=n,t[2]=i}const i=[],r=[],s=[],o=[],a=[],h=[],c=t.length,l=new Float32Array(e.length);let u=0;for(;u<c;){const c=3*t[u],d=3*t[u+1],f=3*t[u+2];n(i,e[c],e[c+1],e[c+2]),n(r,e[d],e[d+1],e[d+2]),n(s,e[f],e[f+1],e[f+2]),lt(a,s,r),lt(o,i,r),dt(h,a,o);for(let t=0;t<3;t++)l[c+t]+=h[t],l[d+t]+=h[t],l[f+t]+=h[t];u+=3}let d=0;const f=l.length;for(;d<f;)n(h,l[d],l[d+1],l[d+2]),ut(h,h),l[d]=h[0]||0,l[d+1]=h[1]||0,l[d+2]=h[2]||0,d+=3;return l}function pt(t){if(1===t.length){return{position:t[0].position,normal:t[0].normal,uv:t[0].uv,indices:t[0].indices,results:t}}let e=0,n=0;for(let i=0,r=t.length;i<r;i++){const{position:r,indices:s}=t[i];e+=r.length,n+=s.length}const i={position:new Float32Array(e),normal:new Float32Array(e),uv:new Float32Array(e/3*2),indices:new Uint32Array(n),results:t};let r=0,s=0,o=0,a=0;for(let e=0,n=t.length;e<n;e++){const{position:n,indices:h,normal:c,uv:l}=t[e];i.position.set(n,r),i.normal.set(c,r),i.uv.set(l,a);let u=0;const d=h.length;for(;u<d;){const t=h[u]+s;i.indices[o]=t,o++,u++}a+=l.length,r+=n.length,s+=n.length/3}return i}function gt(t){return 180*t/Math.PI}function yt(t){return t/180*Math.PI}function xt(t,e,n,i,r,s){const o=3*n,a=3*i,h=3*r,c=3*s,l=e[o],u=e[o+1],d=e[o+2],f=e[a],p=e[a+1],g=e[a+2],y=e[h],x=e[h+1],m=e[h+2],_=e[c],v=e[c+1],b=e[c+2];let w=t.length-1;Math.abs(u-p)<Math.abs(l-f)?(t[++w]=l,t[++w]=1-d,t[++w]=f,t[++w]=1-g,t[++w]=y,t[++w]=1-m,t[++w]=_,t[++w]=1-b):(t[++w]=u,t[++w]=1-d,t[++w]=p,t[++w]=1-g,t[++w]=x,t[++w]=1-m,t[++w]=v,t[++w]=1-b)}function mt(t){const e=[];for(let n=0,i=t.length;n<i;n++){const i=t[n],[r,s,o]=i,a=new ht(r,s,o||0);e[n]=a}return e}function _t(t,e){e=Object.assign({},{depth:2,top:!0},e);const n=t.map((t=>{for(let e=0,n=t.length;e<n;e++){const n=t[e];vt(n),0===e?ct(n)||(t[e]=n.reverse()):ct(n)&&(t[e]=n.reverse()),bt(n)&&n.splice(n.length-1,1)}const n=function(t,e){const n=function(t){let e=0,n=0;const i=t.length;for(;n<i;)e+=t[n].length,n++;return e}(t),i=t.length,r=[],s=new Float32Array(2*n),o=[],a=[],h=3*n,c=2*n,l=e.depth;let u=0,d=0,f=0;for(let e=0;e<i;e++){const n=t[e];e>0&&r.push(u/2);let i=0;const p=n.length;for(;i<p;){const t=n[i],e=t[0],r=t[1],p=t[2]||0;s[u++]=e,s[u++]=r,o[d]=e,o[d+1]=r,o[d+2]=l+p,o[h+d]=e,o[h+d+1]=r,o[h+d+2]=p,a[f]=e,a[f+1]=r,a[c+f]=e,a[c+f+1]=r,d+=3,f+=2,i++}}return{flatVertices:s,holes:r,points:o,count:n,uv:a}}(t,e);n.polygon=t;return function(t,e,n){const i=[],{count:r}=t,s=n.top;for(let t=0,n=e.length;t<n;t+=3){const o=e[t],a=e[t+1],h=e[t+2];s&&(i[t]=o,i[t+1]=a,i[t+2]=h);let c=n+t;const l=r+o,u=r+a,d=r+h;s||(c=t),i[c]=l,i[c+1]=u,i[c+2]=d}t.indices=i}(n,L(n.flatVertices,n.holes,2),e),function(t,e){const{points:n,indices:i,polygon:r,uv:s}=t,o=e.depth;let a=n.length-1,h=i.length-1;for(let t=0,e=r.length;t<e;t++){const e=r[t];let c=0;const l=e.length;for(;c<l;){const t=e[c];let r=e[c+1];c===l-1&&(r=e[0]);const u=n.length/3,d=t[0],f=t[1],p=t[2]||0,g=r[0],y=r[1],x=r[2]||0;n[++a]=d,n[++a]=f,n[++a]=p+o,n[++a]=g,n[++a]=y,n[++a]=x+o,n[++a]=d,n[++a]=f,n[++a]=p,n[++a]=g,n[++a]=y,n[++a]=x;const m=u+2,_=u+3,v=u,b=u+1;i[++h]=m,i[++h]=v,i[++h]=_,i[++h]=v,i[++h]=b,i[++h]=_,xt(s,n,m,_,v,b),c++}}}(n,e),n.position=new Float32Array(n.points),n.indices=new Uint32Array(n.indices),n.uv=new Float32Array(n.uv),n.normal=ft(n.indices,n.position),n})),i=pt(n);return i.polygons=t,i}function vt(t){bt(t)||t.push(t[0])}function bt(t){const e=t.length,[n,i]=t[0],[r,s]=t[e-1];return n===r&&i===s}function wt(t){t.lineWidth=Math.max(0,t.lineWidth),t.depth=Math.max(0,t.depth),t.sideDepth=Math.max(0,t.sideDepth)}function Mt(t,e){wt(e=Object.assign({},{depth:2,lineWidth:1,bottomStickGround:!1,pathUV:!1},e));const n=t.map((t=>{const n=jt(t,e);return n.line=t,zt(n,e),Ot(n,e),n.position=new Float32Array(n.points),n.indices=new Uint32Array(n.indices),n.uv=new Float32Array(n.uv),n.normal=ft(n.indices,n.position),n})),i=pt(n);return i.lines=t,i}function zt(t,e){const n=e.bottomStickGround,i=e.depth,r=t.depths;let s=i,o=i;r&&(s=r[0],o=r[1]);const{leftPoints:a,rightPoints:h}=t,c=t.line,l=e.pathUV;if(l){!function(t){let e=0;for(let n=0,i=t.length;n<i;n++){const i=t[n],r=t[n+1];if(0===n&&(i.distance=0),i&&r){const[t,n,s]=i,[o,a,h]=r,c=t-o,l=n-a,u=(s||0)-(h||0);e+=Math.sqrt(c*c+l*l+u*u),r.distance=e}}}(c);for(let t=0,e=c.length;t<e;t++)a[t].distance=h[t].distance=c[t].distance}let u=0,d=a.length;const f=[],p=[],g=[];for(;u<d;){const t=3*u,[e,i,r]=a[u];f[t]=e,f[t+1]=i,f[t+2]=s+r;const[p,y,x]=h[u],m=3*d+t;f[m]=p,f[m+1]=y,f[m+2]=o+x;const _=2*d*3+t;f[_]=e,f[_+1]=i,f[_+2]=r,n&&(f[_+2]=0);const v=2*d*3+3*d+t;if(f[v]=p,f[v+1]=y,f[v+2]=x,n&&(f[v+2]=0),l){const t=c[u].distance,e=2*u;g[e]=t,g[e+1]=1;const n=2*d+e;g[n]=t,g[n+1]=0;const i=2*d*2+e;g[i]=t,g[i+1]=1;const r=2*d*2+2*d+e;g[r]=t,g[r+1]=0}u++}if(!l){u=0,d=f.length;let t=g.length-1;for(;u<d;){const e=f[u],n=f[u+1];g[++t]=e,g[++t]=n,u+=3}}u=0,d=a.length;let y=p.length-1;for(;u<d-1;){const t=u,e=u+1,n=t+d,i=e+d;p[++y]=t,p[++y]=n,p[++y]=e,p[++y]=n,p[++y]=i,p[++y]=e;const r=u+2*d,s=r+1,o=r+d,a=s+d;p[++y]=r,p[++y]=o,p[++y]=s,p[++y]=o,p[++y]=a,p[++y]=s,u++}if(t.indices=p,t.points=f,t.uv=g,r)for(d=a.length,u=0;u<d;)a[u].depth=s,h[u].depth=o,u++}function Ot(t,e){const{points:n,indices:i,leftPoints:r,rightPoints:s,uv:o}=t,a=e.depth,h=e.bottomStickGround,c=[r,s],l=t.depths,u=e.pathUV,d=e.lineWidth;let f=n.length-1,p=i.length-1,g=o.length-1;function y(t,e){const r=n.length/3,s=l?t.depth:a,c=l?e.depth:a;n[++f]=t[0],n[++f]=t[1],n[++f]=s+t[2],n[++f]=e[0],n[++f]=e[1],n[++f]=c+e[2],n[++f]=t[0],n[++f]=t[1],n[++f]=h?0:t[2],n[++f]=e[0],n[++f]=e[1],n[++f]=h?0:e[2];const y=r+2,x=r+3,m=r,_=r+1;i[++p]=y,i[++p]=m,i[++p]=x,i[++p]=m,i[++p]=_,i[++p]=x,u?(o[++g]=t.distance,o[++g]=s/d,o[++g]=e.distance,o[++g]=c/d,o[++g]=t.distance,o[++g]=0,o[++g]=e.distance,o[++g]=0):xt(o,n,y,x,m,_)}for(let t=0,e=c.length;t<e;t++){let e=c[t];t>0&&(e=e.map((t=>t)),e=e.reverse());let n=0;const i=e.length-1;for(;n<i;){y(e[n],e[n+1]),n++}}const x=r.length,m=[s[0],r[0],r[x-1],s[x-1]];for(let t=0;t<m.length;t+=2){y(m[t],m[t+1])}}const At={x:0,y:0},St={x:0,y:0};function jt(t,e){let n=e.lineWidth/2;e.isSlope&&(n*=2);const i=[],r=[],s=[],o=t.length;let a=0;for(;a<o;){let e=t[a],h=t[a+1];const c=t[a];a===o-1&&(e=t[o-2],h=t[o-1]);const l=h[1]-e[1],u=h[0]-e[0];let d=0;const f=gt(Math.atan(l/u));if(0===a||a===o-1)d=f,d-=90;else{const n=t[a-1];At.x=n[0]-e[0],At.y=n[1]-e[1],St.x=h[0]-e[0],St.y=h[1]-e[1];d=f-Ct(At,St)/2}const p=yt(d),g=c,y=[Math.cos(p)+g[0],Math.sin(p)+g[1]],[x,m]=Tt(e,h,n);let _=Pt(x[0],x[1],g,y),v=Pt(m[0],m[1],g,y);if(!_||!v){const t=i.length,e=i[t-2],n=i[t-1];if(!e||!n)continue;_=[e[0],e[1]],v=[n[0],n[1]]}_[2]=c[2]||0,v[2]=c[2]||0,i.push(_,v),kt(_,e,h)?(r.push(_),s.push(v)):(r.push(v),s.push(_)),a++}return{offsetPoints:i,leftPoints:r,rightPoints:s,line:t}}const Ct=({x:t,y:e},{x:n,y:i})=>{const r=t*n+e*i,s=t*i-e*n;return(Math.atan2(s,r)/Math.PI*180+360)%360};function kt(t,e,n){const[i,r]=e,[s,o]=n,[a,h]=t;return(r-o)*a+(s-i)*h+i*o-s*r>0}function Tt(t,e,n){const i=e[1]-t[1],r=e[0]-t[0],s=Math.atan2(i,r),o=s+Math.PI/2;let a=Math.cos(o)*n,h=Math.sin(o)*n;const c=[t[0]+a,t[1]+h],l=[e[0]+a,e[1]+h],u=s-Math.PI/2;a=Math.cos(u)*n,h=Math.sin(u)*n;return[[c,l],[[t[0]+a,t[1]+h],[e[0]+a,e[1]+h]]]}function Pt(t,e,n,i){const r=e[0]-t[0],s=e[1]-t[1],o=i[0]-n[0],a=i[1]-n[1];if(0===r&&0===o)return null;if(0===s&&0===a)return null;const h=s/r,c=a/o,l=t[1]-h*t[0],u=n[1]-c*n[0];let d,f;return 0===r?(d=t[0],f=c*d+u):0===o?(d=n[0],f=h*d+l):0===s?(f=t[1],d=(f-u)/c):0===a?(f=n[1],d=(f-l)/h):(d=(u-l)/(h-c),f=h*d+l),[d,f]}function Vt(t,e){e=Object.assign({},{radius:1,height:2,radialSegments:6},e);const n=Math.round(Math.max(4,e.radialSegments));let{radius:i,height:r}=e;i=i,r=r;const s=360/n/360*Math.PI*2,o=n+1,a=new Float32Array(3*o*2),[h,c]=t;let l=0,u=0;const d=3*o,f=2*o,p=[],g=[];let y=p.length-1;for(let t=-1;t<n;t++){const e=s*t,n=Math.cos(e)*i+h,o=Math.sin(e)*i+c;a[l]=n,a[l+1]=o,a[l+2]=0,a[l+d]=n,a[l+1+d]=o,a[l+2+d]=r;let x=0,m=0;x=.5+n/i/2,m=.5+o/i/2,g[u]=x,g[u+1]=m,g[u+f]=x,g[u+1+f]=m,l+=3,u+=2,t>1&&(p[++y]=0,p[++y]=t-1,p[++y]=t)}l-=3,a[l]=a[0],a[l+1]=a[1],a[l+2]=a[2];const x=a.length;a[x-3]=a[0],a[x-2]=a[1],a[x-1]=r;const m=p.length;y=p.length-1;for(let t=0;t<m;t++){const e=p[t];p[++y]=e+o}const _=new Float32Array(2*(3*o*2-6));let v=-1;l=2*o,u=0,y=p.length-1;let b=g.length-1;for(let t=0,e=a.length/2;t<e-3;t+=3){const e=a[t],n=a[t+1],s=a[t+3],h=a[t+4];_[++v]=e,_[++v]=n,_[++v]=r,_[++v]=s,_[++v]=h,_[++v]=r,_[++v]=e,_[++v]=n,_[++v]=0,_[++v]=s,_[++v]=h,_[++v]=0;const c=l+2,d=l+3,f=l,x=l+1;p[++y]=f,p[++y]=c,p[++y]=x,p[++y]=c,p[++y]=d,p[++y]=x,l+=4;const m=u/o,w=(u+1)/o;g[++b]=m,g[++b]=r/i/2,g[++b]=w,g[++b]=r/i/2,g[++b]=m,g[++b]=0,g[++b]=w,g[++b]=0,u++}const w=new Float32Array(a.length+_.length);w.set(a,0),w.set(_,a.length);const M=ft(p,w);return{points:a,indices:new Uint32Array(p),position:w,normal:M,uv:new Float32Array(g)}}var Lt=function(){function t(){this.pos=new ht,this.dir=new ht,this.right=new ht,this.up=new ht,this.dist=0,this.widthScale=1,this.sharp=!1}var e=t.prototype;return e.lerpPathPoints=function(t,e,n){this.pos.lerpVectors(t.pos,e.pos,n),this.dir.lerpVectors(t.dir,e.dir,n),this.up.lerpVectors(t.up,e.up,n),this.right.lerpVectors(t.right,e.right,n),this.dist=(e.dist-t.dist)*n+t.dist,this.widthScale=(e.widthScale-t.widthScale)*n+t.widthScale},e.copy=function(t){this.pos.copy(t.pos),this.dir.copy(t.dir),this.up.copy(t.up),this.right.copy(t.right),this.dist=t.dist,this.widthScale=t.widthScale},t}(),Bt=function(){function t(t,e,n,i,r,s,o,a,h,c,l,u,d,f,p,g){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,e,n,i,r,s,o,a,h,c,l,u,d,f,p,g)}var e=t.prototype;return e.set=function(t,e,n,i,r,s,o,a,h,c,l,u,d,f,p,g){var y=this.elements;return y[0]=t,y[4]=e,y[8]=n,y[12]=i,y[1]=r,y[5]=s,y[9]=o,y[13]=a,y[2]=h,y[6]=c,y[10]=l,y[14]=u,y[3]=d,y[7]=f,y[11]=p,y[15]=g,this},e.multiply=function(t){return this.multiplyMatrices(this,t)},e.makeRotationAxis=function(t,e){var n=Math.cos(e),i=Math.sin(e),r=1-n,s=t.x,o=t.y,a=t.z,h=r*s,c=r*o;return this.set(h*s+n,h*o-i*a,h*a+i*o,0,h*o+i*a,c*o+n,c*a-i*s,0,h*a-i*o,c*a+i*s,r*a*a+n,0,0,0,0,1),this},e.equals=function(t){for(var e=this.elements,n=t.elements,i=0;i<16;i++)if(e[i]!==n[i])return!1;return!0},t}(),Ut=function(){function t(){this.type="Curve",this.arcLengthDivisions=200}var e=t.prototype;return e.getPoint=function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},e.getPointAt=function(t,e){var n=this.getUtoTmapping(t);return this.getPoint(n,e)},e.getPoints=function(t){void 0===t&&(t=5);for(var e=[],n=0;n<=t;n++)e.push(this.getPoint(n/t));return e},e.getLength=function(){var t=this.getLengths();return t[t.length-1]},e.getLengths=function(t){if(void 0===t&&(t=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var e,n=[],i=this.getPoint(0),r=0;n.push(0);for(var s=1;s<=t;s++)r+=(e=this.getPoint(s/t)).distanceTo(i),n.push(r),i=e;return this.cacheArcLengths=n,n},e.getUtoTmapping=function(t,e){var n,i=this.getLengths(),r=0,s=i.length;n=e||t*i[s-1];for(var o,a=0,h=s-1;a<=h;)if((o=i[r=Math.floor(a+(h-a)/2)]-n)<0)a=r+1;else{if(!(o>0)){h=r;break}h=r-1}if(i[r=h]===n)return r/(s-1);var c=i[r];return(r+(n-c)/(i[r+1]-c))/(s-1)},t}();function Et(t,e,n,i){return function(t,e){var n=1-t;return n*n*e}(t,e)+function(t,e){return 2*(1-t)*t*e}(t,n)+function(t,e){return t*t*e}(t,i)}var It=function(t){var e,n;function i(e,n,i){var r;return void 0===e&&(e=new ht),void 0===n&&(n=new ht),void 0===i&&(i=new ht),(r=t.call(this)||this).isQuadraticBezierCurve3=!0,r.type="QuadraticBezierCurve3",r.v0=e,r.v1=n,r.v2=i,r}return n=t,(e=i).prototype=Object.create(n.prototype),e.prototype.constructor=e,V(e,n),i.prototype.getPoint=function(t,e){void 0===e&&(e=new ht);var n=e,i=this.v0,r=this.v1,s=this.v2;return n.set(Et(t,i.x,r.x,s.x),Et(t,i.y,r.y,s.y),Et(t,i.z,r.z,s.z)),n},i}(Ut),Ft=new ht,Rt=new ht,Gt=new ht,Zt=new Bt,Qt=new It;var Dt=function(){function t(){this.array=[],this.count=0}var e=t.prototype;return e.set=function(t,e,n,i,r){if(void 0===e&&(e=.1),void 0===n&&(n=10),void 0===i&&(i=null),void 0===r&&(r=!1),(t=t.slice(0)).length<2)return console.warn("PathPointList: points length less than 2."),void(this.count=0);r&&!t[0].equals(t[t.length-1])&&t.push((new ht).copy(t[0]));for(var s=0,o=t.length;s<o;s++)if(0===s)this._start(t[s],t[s+1],i);else if(s===o-1)if(r){this._corner(t[s],t[1],e,n,i);var a=this.array[0].dist;this.array[0].copy(this.array[this.count-1]),this.array[0].dist=a}else this._end(t[s]);else this._corner(t[s],t[s+1],e,n,i)},e.distance=function(){return this.count>0?this.array[this.count-1].dist:0},e._getByIndex=function(t){return this.array[t]||(this.array[t]=new Lt),this.array[t]},e._start=function(t,e,n){this.count=0;var i=this._getByIndex(this.count);if(i.pos.copy(t),i.dir.subVectors(e,t),n)i.up.copy(n);else{var r=Number.MAX_VALUE,s=Math.abs(i.dir.x),o=Math.abs(i.dir.y),a=Math.abs(i.dir.z);s<r&&(r=s,i.up.set(1,0,0)),o<r&&(r=o,i.up.set(0,1,0)),a<r&&i.up.set(0,0,1)}i.right.crossVectors(i.dir,i.up).normalize(),i.up.crossVectors(i.right,i.dir).normalize(),i.dist=0,i.widthScale=1,i.sharp=!1,i.dir.normalize(),this.count++},e._end=function(t){var e=this.array[this.count-1],n=this._getByIndex(this.count);n.pos.copy(t),n.dir.subVectors(t,e.pos);var i=n.dir.length();n.dir.normalize(),n.up.copy(e.up);var r=Ft.crossVectors(e.dir,n.dir);if(r.length()>Number.EPSILON){r.normalize();var s=Math.acos(Math.min(Math.max(e.dir.dot(n.dir),-1),1));n.up.applyMatrix4(Zt.makeRotationAxis(r,s))}n.right.crossVectors(n.dir,n.up).normalize(),n.dist=e.dist+i,n.widthScale=1,n.sharp=!1,this.count++},e._corner=function(t,e,n,i,r){if(n>0&&i>0){for(var s=function(t,e,n,i,r,s){var o=Ft.subVectors(e,t),a=Rt.subVectors(n,e),h=o.length(),c=a.length();o.normalize(),a.normalize();var l=Math.min(.999999*(r?h/2:h),i);s.v0.copy(e).sub(o.multiplyScalar(l)),s.v1.copy(e);var u=Math.min(c/2*.999999,i);return s.v2.copy(e).add(a.multiplyScalar(u)),s}(this.array[this.count-1].pos,t,e,n,this.count-1==0,Qt),o=s.getPoints(i),a=0;a<i;a++)this._sharpCorner(o[a],o[a+1],r,0===a?1:0);o[i].equals(e)||this._sharpCorner(o[i],e,r,2)}else this._sharpCorner(t,e,r,0,!0)},e._sharpCorner=function(t,e,n,i,r){void 0===i&&(i=0),void 0===r&&(r=!1);var s=this.array[this.count-1],o=this._getByIndex(this.count),a=Ft.subVectors(t,s.pos),h=Rt.subVectors(e,t),c=a.length();if(a.normalize(),h.normalize(),o.pos.copy(t),1===i?o.dir.copy(a):2===i?o.dir.copy(h):(o.dir.addVectors(a,h),o.dir.normalize()),n)1===o.dir.dot(n)?o.right.crossVectors(h,n).normalize():o.right.crossVectors(o.dir,n).normalize(),o.up.crossVectors(o.right,o.dir).normalize();else{o.up.copy(s.up);var l=Gt.crossVectors(s.dir,o.dir);if(l.length()>Number.EPSILON){l.normalize();var u=Math.acos(Math.min(Math.max(s.dir.dot(o.dir),-1),1));o.up.applyMatrix4(Zt.makeRotationAxis(l,u))}o.right.crossVectors(o.dir,o.up).normalize()}o.dist=s.dist+c;var d=a.dot(h);o.widthScale=Math.min(1/Math.sqrt((1+d)/2),1.415)||1,o.sharp=Math.abs(d-1)>.05&&r,this.count++},t}();const Ht=new ht(0,0,1),Wt=new ht,qt=new ht,Nt=new ht,Xt=new ht,Kt=new ht,Yt=new ht;function Jt(t,e){e=Object.assign({},{lineWidth:1,cornerRadius:0,cornerSplit:10},e);const n=t.map((t=>{const n=mt(t),i=new Dt;i.set(n,e.cornerRadius,e.cornerSplit,Ht);const r=function(t,e){const n=e.lineWidth||.1,i=1,r=n/2,s=n,o=t.distance(),a=i*o;let h=0;const c=[],l=[],u=[],d=[];let f=0;if(0===o)return{position:c,normal:l,uv:u,indices:d,count:h};const p=r/s;let g,y=c.length-1,x=l.length-1,m=u.length-1,_=d.length-1;function v(t){const e=0===c.length,n=t.sharp&&!e,i=t.dist/s,o=t.dir,a=t.up,g=t.right;if(Wt.copy(g).multiplyScalar(r*t.widthScale),qt.copy(g).multiplyScalar(-r*t.widthScale),Wt.add(t.pos),qt.add(t.pos),n){Nt.fromArray(c,c.length-6).sub(qt),Xt.fromArray(c,c.length-3).sub(Wt);const t=Nt.length()-Xt.length();let e,n;t>0?(e=Nt,n=qt):(e=Xt,n=Wt),Kt.copy(e).setLength(Math.abs(t)).add(n);let r=Yt.copy(n).sub(Kt).normalize().dot(o)*Yt.copy(n).sub(Kt).length()*2;Yt.copy(o).setLength(r).add(Kt),t>0?(c[++y]=Kt.x,c[++y]=Kt.y,c[++y]=Kt.z,c[++y]=Wt.x,c[++y]=Wt.y,c[++y]=Wt.z,c[++y]=qt.x,c[++y]=qt.y,c[++y]=qt.z,c[++y]=Wt.x,c[++y]=Wt.y,c[++y]=Wt.z,c[++y]=Yt.x,c[++y]=Yt.y,c[++y]=Yt.z,c[++y]=Wt.x,c[++y]=Wt.y,c[++y]=Wt.z,f+=6,d[++_]=f-6,d[++_]=f-8,d[++_]=f-7,d[++_]=f-6,d[++_]=f-7,d[++_]=f-5,d[++_]=f-4,d[++_]=f-6,d[++_]=f-5,d[++_]=f-2,d[++_]=f-4,d[++_]=f-1,h+=12):(c[++y]=qt.x,c[++y]=qt.y,c[++y]=qt.z,c[++y]=Kt.x,c[++y]=Kt.y,c[++y]=Kt.z,c[++y]=qt.x,c[++y]=qt.y,c[++y]=qt.z,c[++y]=Wt.x,c[++y]=Wt.y,c[++y]=Wt.z,c[++y]=qt.x,c[++y]=qt.y,c[++y]=qt.z,c[++y]=Yt.x,c[++y]=Yt.y,c[++y]=Yt.z,f+=6,d[++_]=f-6,d[++_]=f-8,d[++_]=f-7,d[++_]=f-6,d[++_]=f-7,d[++_]=f-5,d[++_]=f-6,d[++_]=f-5,d[++_]=f-3,d[++_]=f-2,d[++_]=f-3,d[++_]=f-1,h+=12);for(let t=0;t<6;t++)l[++x]=a.x,l[++x]=a.y,l[++x]=a.z;u[++m]=i-p,u[++m]=0,u[++m]=i-p,u[++m]=1,u[++m]=i,u[++m]=0,u[++m]=i,u[++m]=1,u[++m]=i+p,u[++m]=0,u[++m]=i+p,u[++m]=1}else c[++y]=qt.x,c[++y]=qt.y,c[++y]=qt.z,c[++y]=Wt.x,c[++y]=Wt.y,c[++y]=Wt.z,l[++x]=a.x,l[++x]=a.y,l[++x]=a.z,l[++x]=a.x,l[++x]=a.y,l[++x]=a.z,u[++m]=i,u[++m]=0,u[++m]=i,u[++m]=1,f+=2,e||(d[++_]=f-2,d[++_]=f-4,d[++_]=f-3,d[++_]=f-2,d[++_]=f-3,d[++_]=f-1,h+=6)}if(a>0)for(let e=0;e<t.count;e++){const n=t.array[e];if(n.dist>a){const i=t.array[e-1];g=new Lt;const r=(a-i.dist)/(n.dist-i.dist);g.lerpPathPoints(i,n,r),v(g);break}v(n)}else g=t.array[0];return{position:c,normal:l,uv:u,indices:d,count:h}}(i,e);return{position:new Float32Array(r.position),indices:new Uint32Array(r.indices),uv:new Float32Array(r.uv),normal:new Float32Array(r.normal),line:t,count:r.count}})),i=pt(n);return i.lines=t,i}const $t=new ht(0,0,1),te=new ht;var ee=Object.freeze({__proto__:null,cylinder:Vt,expandLine:jt,expandPaths:Jt,expandTubes:function(t,e){e=Object.assign({},{radius:1,cornerSplit:0,radialSegments:8,startRad:-Math.PI/4},e);const n=t.map((t=>{const n=mt(t),i=new Dt;i.set(n,0,e.cornerSplit,$t);const r=function(t,e){const n=Math.max(e.radius||1,1e-8),i=void 0!==e.progress?e.progress:1,r=Math.max(3,e.radialSegments||8),s=e.startRad||0,o=2*n*Math.PI,a=t.distance(),h=i*a;if(0===h)return null;let c=0;const l=[],u=[],d=[],f=[];let p=0,g=-1,y=-1,x=-1,m=-1;function _(t,e,n){const i=0===l.length,r=t.dist/o;for(let i=0;i<=n;i++){let o=i;o===n&&(o=0),te.copy(t.up).applyAxisAngle(t.dir,s+2*Math.PI*o/n).normalize();const a=e*t.widthScale;l[++g]=t.pos.x+te.x*a,l[++g]=t.pos.y+te.y*a,l[++g]=t.pos.z+te.z*a,u[++y]=te.x,u[++y]=te.y,u[++y]=te.z,d[++x]=r,d[++x]=i/n,p++}if(!i){const t=p-2*(n+1),e=p-(n+1);for(let i=0;i<n;i++)f[++m]=e+i,f[++m]=t+i,f[++m]=t+i+1,f[++m]=e+i,f[++m]=t+i+1,f[++m]=e+i+1,c+=6}}if(h>0)for(let e=0;e<t.count;e++){const i=t.array[e];if(i.dist>h){const s=t.array[e-1],o=new Lt,a=(h-s.dist)/(i.dist-s.dist);o.lerpPathPoints(s,i,a),_(o,n,r);break}_(i,n,r)}return{points:l,normal:u,uv:d,indices:f,count:c}}(i,e);return r.line=t,r.position=new Float32Array(r.points),r.indices=new Uint32Array(r.indices),r.uv=new Float32Array(r.uv),r.normal=new Float32Array(r.normal),r})),i=pt(n);return i.lines=t,i},extrudePolygons:_t,extrudePolylines:Mt,extrudeSlopes:function(t,e){wt(e=Object.assign({},{depth:2,lineWidth:1,side:"left",sideDepth:0,bottomStickGround:!1,pathUV:!1,isSlope:!0},e));const{depth:n,side:i,sideDepth:r}=e,s=t.map((t=>{const s=jt(t,e);s.line=t;const{leftPoints:o,rightPoints:a}=s,h={line:t};let c;for(let e=0,n=t.length;e<n;e++)t[e][2]=t[e][2]||0;return"left"===i?(h.leftPoints=o,h.rightPoints=t,c=[r,n]):(h.leftPoints=t,h.rightPoints=a,c=[n,r]),h.depths=c,zt(h,e),Ot(h,e),h.position=new Float32Array(h.points),h.indices=new Uint32Array(h.indices),h.uv=new Float32Array(h.uv),h.normal=ft(h.indices,h.position),h})),o=pt(s);return o.lines=t,o},isClockwise:ct,leftOnLine:kt,merge:pt,plane:function(t,e,n,i){const r=t/(n=Math.max(1,n)),s=e/(i=Math.max(1,i)),o=-t/2,a=e/2,h=-e/2,c=(n+1)*(i+1),l=new Float32Array(3*c),u=new Float32Array(2*c),d=new Float32Array(3*c),f=new Uint32Array(10*c);let p=0,g=0,y=0;for(let c=0;c<=i;c++)for(let x=0;x<=n;x++){const m=o+r*x,_=a-s*c;l[p]=m,l[p+1]=_,l[p+2]=0,d[p]=0,d[p+1]=0,d[p+2]=1;const v=(m-o)/t,b=(_-h)/e;if(u[g]=v,u[g+1]=b,p+=3,g+=2,x<n&&c<i){const t=c*(n+1)+x,e=t+1,i=(n+1)*(c+1)+x,r=i+1;f[y]=t,f[y+1]=i,f[y+2]=e,f[y+3]=i,f[y+4]=r,f[y+5]=e,y+=6}}const x=new Uint32Array(y);for(let t=0,e=x.length;t<e;t++)x[t]=f[t];return{position:l,uv:u,normal:d,indices:x}}});function ne(t,e,n={}){return void 0===n[t]&&(n[t]=e.distanceToVector3(t,t).x),n[t]}function ie(t,e,n={}){return void 0===n[t]&&(n[t]=e.altitudeToVector3(t,t).x),n[t]}function re(t=[]){let e=0,n=0;const i=t.length;for(let s=0;s<i;s++){const{coordinate:i,lnglat:o,lnglats:a,xy:h,xys:c}=t[s],l=i||o||a||h||c||t[s];let u,d;Array.isArray(l)?(u=l[0],d=l[1]):l instanceof r.Coordinate&&(u=l.x,d=l.y),e+=u,n+=d}return new r.Coordinate(e/i,n/i)}function se(t,e,n,i){if(void 0===e||"number"!=typeof e||0===e)return 0;let r;r=t instanceof s.BufferGeometry?t.attributes.position.array:Array.isArray(t)||t instanceof Float32Array?t:t.position;let o=0;if(r){i?(void 0===i[e]&&(i[e]=n.altitudeToVector3(e,e).x),o=i[e]):o=n.altitudeToVector3(e,e).x;const t=r.length;if(r[0]instanceof s.Vector3)for(let e=0;e<t;e++)r[e].z+=o;else for(let e=0;e<t;e+=3)r[e+2]+=o}return o}function oe(t){const e=t.length;let n=0;for(let i=0;i<e;i++){const{count:e}=t[i].position;n+=e}return new Float32Array(3*n)}const ae=new s.Vector3,he=new Map;function ce(t=[],e){const n=t.length,i=!!e,r=i?3:2,s=new Float64Array(n*r);he.clear();for(let o=0;o<n;o++){let n,a;const h=t[o];let c;if(h.x?(n=h.x,a=h.y,c=h.z):(n=h[0],a=h[1],c=h[2]),s[o*r]=n,s[o*r+1]=a,c=c||0,i&&0!==c){if(!he.has(c)){const t=e.altitudeToVector3(c,c,null,ae).x;he.set(c,t)}s[o*r+2]=he.get(c)}}return s.buffer}function le(t){return(z(t)?t.properties:t.getProperties())||{}}function ue(t){return(O(t)?t.properties:t.getProperties())||{}}const de=new s.Color("#fff"),fe=new s.Color("#fff");function pe(t,e,n,i,r){const{position:o,normal:h,uv:c,indices:l}=ge(t,e,n,i,r),u=new Float32Array(o.length);u.fill(1,0,o.length);const d=new s.BufferGeometry;return a(d,"color",new s.BufferAttribute(u,3)),a(d,"normal",new s.BufferAttribute(h,3)),a(d,"position",new s.BufferAttribute(o,3)),a(d,"uv",new s.BufferAttribute(c,2)),d.setIndex(new s.BufferAttribute(l,1)),d}function ge(t,e,n,i,r,s,o){const a=xe(t,i,r,s,!1);if(!a)return null;o?(null==o[e]&&(o[e]=i.altitudeToVector3(e,e).x),e=o[e]):e=i.altitudeToVector3(e,e).x;const{position:h,normal:c,uv:l,indices:u}=_t(a,{depth:e,top:n});return{position:h,normal:c,uv:l,indices:u}}function ye(t,e,n,i){void 0===i&&(i=0);const r=t.attributes.position.array,o=r.length;let h;if(fe.setStyle(e),de.setStyle(n),Array.isArray(i)){let t=0;for(let e=0,n=i.length;e<n;e++){const{count:n}=i[e].position;t+=3*n}h=new Float32Array(t)}else h=new Float32Array(r.length);if(Array.isArray(i))for(let t=0,e=i.length;t<e;t++){const{middleZ:e,start:n,end:s}=i[t].position;for(let t=n;t<s;t+=3){r[t+2]>e?(h[t]=de.r,h[t+1]=de.g,h[t+2]=de.b):(h[t]=fe.r,h[t+1]=fe.g,h[t+2]=fe.b)}}else for(let t=0;t<o;t+=3){r[t+2]>i?(h[t]=de.r,h[t+1]=de.g,h[t+2]=de.b):(h[t]=fe.r,h[t+1]=fe.g,h[t+2]=fe.b)}return a(t,"color",new s.BufferAttribute(h,3,!0)),h}function xe(t,e,n,i,s=!1){if(!t)return null;let o=[];if(t instanceof r.MultiPolygon)o=t.getGeometries().map((r=>me(r,e,n||t.getCenter(),i,s)));else if(t instanceof r.Polygon){const r=me(t,e,n||t.getCenter(),i,s);o.push(r)}else if(z(t))if(S(t)){const r=k(t);for(let a=0,h=r.length;a<h;a++)o.push(me(r[a],e,n||C(t),i,s))}else{const r=me(t,e,n||C(t),i,s);o.push(r)}return o}function me(t,e,n,i,s=!1){let o,a,h;if(z(t)){const e=j(t);o=e[0],a=e.slice(1,e.length),n=n||C(t)}else t instanceof r.Polygon&&(o=t.getShell(),a=t.getHoles(),n=n||t.getCenter());i=i||e.coordinateToVector3(n),h=s?e.coordinatiesToGLFloatArray(o,i).positons2d:e.coordinatiesToGLArray(o,i);const c=[s?h.buffer:h];if(a&&a.length>0)for(let t=0,n=a.length;t<n;t++){let n;n=s?e.coordinatiesToGLFloatArray(a[t],i).positons2d:e.coordinatiesToGLArray(a[t],i),c.push(s?n.buffer:n)}return c}function _e(t){if(!t)return null;let e=[];if(t instanceof r.MultiPolygon)e=t.getGeometries().map((t=>ve(t,!1)));else if(t instanceof r.Polygon){const n=ve(t,!1);e.push(n)}else if(z(t))if(S(t)){const n=k(t);for(let t=0,i=n.length;t<i;t++)e.push(ve(n[t],!0))}else{const n=ve(t,!0);e.push(n)}return e}function ve(t,e){let n,i;if(e){const e=j(t);n=e[0],i=e.slice(1,e.length)}else t instanceof r.Polygon&&(n=t.getShell(),i=t.getHoles());const s=[ce(n)];if(i&&i.length>0)for(let t=0,e=i.length;t<e;t++){const e=ce(i[t]);s.push(e)}return s}var be=Object.freeze({__proto__:null,getExtrudeGeometry:pe,getExtrudeGeometryParams:ge,initVertexColors:ye,getPolygonPositions:xe,getSinglePolygonPositions:me,getPolygonArrayBuffer:_e,getSinglePolygonArrayBuffer:ve});const we=new Map,Me=new s.Vector3;function ze(t,e,n,i=!0){let o,a,h=[];if(Array.isArray(t)&&t[0]instanceof s.Vector3)h=t;else{Array.isArray(t)&&(t=new r.LineString(t));const s=0;let c,l;M(t)?(c=j(t),n||(l=C(t))):t instanceof r.LineString&&(c=t.getCoordinates(),n||(l=t.getCenter()));const u=e.coordinateToVector3(n||l);if(i){we.clear();for(let t=0,n=c.length;t<n;t++){const n=c[t],i=n.z||n[2]||0;if(!we.has(i)){const t=e.altitudeToVector3(i,i,null,Me).x;we.set(i,t)}const r=e.coordinateToVector3(n,s).sub(u);r.z+=we.get(i)||0,h.push(r)}}else{const t=e.coordinatiesToGLFloatArray(c,u,!0);o=t.positions,a=t.positons2d}}if(!i)return{positions:o,positionsV:h,positions2d:a,arrayBuffer:o.buffer};a=new Float32Array(2*h.length),o=new Float32Array(3*h.length);for(let t=0,e=h.length;t<e;t++){const e=3*t,n=h[t];o[e]=n.x,o[e+1]=n.y,o[e+2]=n.z;const i=2*t;a[i]=n.x,a[i+1]=n.y}return{positions:o,positionsV:h,positions2d:a,arrayBuffer:o.buffer}}function Oe(t,e,n,i){const r=[],s=[],o=[];let a,h;for(let n=0,c=t.length;n<c;n++){const c=t[n];for(let t=0,n=c.length;t<n;t++){const n=c[t],l=n.join(",").toString();a?(l!==a&&(h=e.coordinateToVector3(n,0).sub(i),r.push(h.x,h.y,h.z),s.push(h),o.push(n)),a=l):(o.push(n),a=l,h=e.coordinateToVector3(n,0).sub(i),r.push(h.x,h.y,h.z),s.push(h))}}return{positions:r,positionsV:s,lnglats:o}}function Ae(t){let e;const n=[];for(let i=0,r=t.length;i<r;i++){const r=t[i];for(let t=0,i=r.length;t<i;t++){const i=r[t],s=i.join(",").toString();e?(s!==e&&n.push(i),e=s):(n.push(i),e=s)}}return n}function Se(t,e=1,n=1,i=!1,r,s){const o=ze(t,r,s).positionsV,a=[];for(let t=0,e=o.length;t<e;t++){const e=o[t];a.push([e.x,e.y,e.z])}const{indices:h,position:c,normal:l,uv:u}=Mt([a],{lineWidth:e,depth:n,pathUV:i});return{position:c,normal:l,indices:h,uv:u}}function je(t,e=1,n=1,i,r){const s=ze(t,i,r).positionsV,o=[];for(let t=0,e=s.length;t<e;t++){const e=s[t];o.push([e.x,e.y,e.z])}const{indices:a,position:h,normal:c,uv:l}=Jt([o],{lineWidth:e,cornerRadius:n});return{position:h,normal:c,indices:a,uv:l}}function Ce(t){let e,n=[];return t instanceof r.MultiLineString?(n=t.getGeometries(),e=t.getCenter()):t instanceof r.LineString?(n.push(t),e=t.getCenter()):M(t)&&(e=C(t),S(t)?n=k(t):n.push(t)),{lineStrings:n,center:e}}function ke(t){const e=new Float32Array(2*t.length-6);let n=0;for(let i=0,r=t.length/3;i<r;i++){const s=t[3*i],o=t[3*i+1],a=t[3*i+2];if(i>0&&i<r-1){const t=3*n;e[t]=s,e[t+1]=o,e[t+2]=a,n++}const h=3*n;e[h]=s,e[h+1]=o,e[h+2]=a,n++}return e}function Te(t){let e=0;const n=t.length;if(1===n)return t[0];for(let i=0;i<n;i++)e+=t[i].length;const i=new Float32Array(e);let r=0;for(let e=0;e<n;e++)i.set(t[e],r),r+=t[e].length;return i}function Pe(t,e){return t instanceof r.LineString?ce(t.getCoordinates(),e):O(t)?ce(t.geometry.coordinates,e):void 0}let Ve;function Le(){return Ve||(Ve=new s.BufferGeometry,a(Ve,"position",new s.BufferAttribute(new Float32Array(3),3))),Ve}var Be=Object.freeze({__proto__:null,getLinePosition:ze,getExtrudeLineGeometry:function(t,e=1,n=1,i=!1,r,o){const{indices:h,position:c,normal:l,uv:u}=Se(t,e,n,i,r,o),d=new s.BufferGeometry;return a(d,"position",new s.BufferAttribute(c,3)),a(d,"normal",new s.BufferAttribute(l,3)),a(d,"uv",new s.BufferAttribute(u,2)),d.setIndex(new s.BufferAttribute(h,1)),d},getChunkLinesPosition:Oe,mergeChunkLineCoordinates:Ae,getExtrudeLineParams:Se,getPathParams:je,LineStringSplit:Ce,setLineSegmentPosition:function(t,e){for(let n=0,i=e.length;n<i;n++){const r=e[n];n>0&&n<i-1&&t.push(r.x,r.y,r.z),t.push(r.x,r.y,r.z)}},getLineSegmentPosition:ke,mergeLinePositions:Te,getLineArrayBuffer:Pe,getDefaultLineGeometry:Le});let Ue;var Ee;function Ie(){return r.worker||console.error("maptalks.worker is not defined,You can't use ThreeVectorTileLayer"),!Ee&&Ue&&(Ee=new Ue("__maptalks.three__")),Ee}function Fe(t,e,n={}){return void 0!==t&&"number"==typeof t&&0!==t?(void 0===n[t]&&(n[t]=e.distanceToVector3(t,t).x),n[t]):0}function Re(t,e,n={}){return void 0!==t&&"number"==typeof t&&0!==t?(void 0===n[t]&&(n[t]=e.altitudeToVector3(t,t).x),n[t]):0}function Ge(t,e){return e?Object.assign({},e,t):t||{}}function Ze(t,e,n,i,r=[],s){const o=n.isMercator();let a,h,c;if(o){const t=n.getMap();a=t.getGLRes(),h=t.getSpatialReference().getTransformation().matrix}e&&(c=n.coordinateToVector3(e));const l=[],u=[],d={},f={},p=t.length;for(let a=0;a<p;a++){const h=t[a];let p=r[a]?r[a]:ue(i[a]);p=Ge(p,s),e||(c=n.coordinateToVector3(p.center));let g=p.width||1,y=p.height||1,x=p.cornerRadius||0,m=p.bottomHeight||0;const _=p.pathUV,v=p.parentCenter;g=Fe(g,n,d),x=Fe(x,n,d),y=Re(y,n,f),m=Re(m,n,f);const b=[];for(let t=0,i=h.length;t<i;t++){const i=h[t];let r;r=o?Pe(i,n):ze(i,n,v||e,!1).arrayBuffer,u.push(r),b.push(r)}const w={id:p.id,data:b,height:y,width:g,cornerRadius:x,bottomHeight:m,pathUV:_};o&&(w.center=[c.x,c.y]),l.push(w)}return{datas:l,transfer:u,glRes:a,matrix:h,center:o?[c.x,c.y]:null}}function Qe(t,e,n,i,r=[],s){const o=n.isMercator();let a,h,c;if(o){const t=n.getMap();a=t.getGLRes(),h=t.getSpatialReference().getTransformation().matrix}e&&(c=n.coordinateToVector3(e));const l=[],u=[],d={},f=t.length;for(let a=0;a<f;a++){const h=t[a];let f=r[a]?r[a]:ue(i[a]);f=Ge(f,s),e||(c=n.coordinateToVector3(f.center));let p=f.bottomHeight||0;p=Re(p,n,d);const g=[];for(let t=0,i=h.length;t<i;t++){const i=h[t];if(o){const t=Pe(i,n);u.push(t),g.push(t)}else{const t=ze(i,n,e,!1).arrayBuffer;u.push(t),g.push(t)}}const y={id:f.id,data:g,bottomHeight:p};o&&(y.center=[c.x,c.y]),l.push(y)}return{datas:l,transfer:u,glRes:a,matrix:h,center:o?[c.x,c.y]:null}}function De(t){return t.map((t=>t.data))}function He(t){return t.map((t=>t.option||t.baseObject.getOptions()))}r.worker&&(Ue=class extends r.worker.Actor{test(t,e){this.send(t,null,e)}pushQueue(t={}){const{type:e,data:n,callback:i,layer:r,key:s,center:o,lineStrings:a,options:h,id:c,baseOptions:l}=t;let u;e.indexOf("ExtrudePolygon")>-1?u=function(t=[],e,n,i=[],r){const s=n.isMercator();let o,a,h;if(s){const t=n.getMap();o=t.getGLRes(),a=t.getSpatialReference().getTransformation().matrix}e&&(h=n.coordinateToVector3(e));const c=t.length,l=[],u=[],d={};for(let o=0;o<c;o++){const a=t[o],c=a;let f,p=i[o]?i[o]:le(c);p=Ge(p,r),e||(h=n.coordinateToVector3(p.center)),f=s?_e(a):xe(a,n,p.center||e,h,!0);for(let t=0,e=f.length;t<e;t++){const e=f[t];for(let t=0,n=e.length;t<n;t++)u.push(e[t])}let g=p.height||1,y=p.bottomHeight||0;const x=p.top;g=Re(g,n,d),y=Re(y,n,d);const m={id:p.id,data:f,height:g,bottomHeight:y,top:x};s&&(m.center=[h.x,h.y]),l.push(m),c._properties&&delete c._properties}return{datas:l,transfer:u,glRes:o,matrix:a,center:s?[h.x,h.y]:null}}(n,o,r,h,l):"ExtrudeLines"===e||"Paths"===e?u=Ze(n,o,r,a,h,l):"Point"===e||("Line"===e||"FatLine"===e||"Lines"===e||"FatLines"===e?u=Qe(n,o,r,a,h,l):"ExtrudeLine"===e||"Path"===e?u=Ze(n,o,r,a,h,l):"Bar"!==e&&"Bars"!==e||(u=function(t){const e=t.length,n=new Float32Array(7*e);let i=0;for(let r=0;r<e;r++){let{center:e,radialSegments:s,radius:o,height:a,altitude:h,id:c}=t[r];e=e||[0,0],n[i]=e[0],n[i+1]=e[1],n[i+2]=s||6,n[i+3]=o||1,n[i+4]=a,n[i+5]=h||0,n[i+6]=c,i+=7}const r=n.buffer;return{datas:r,transfer:[r]}}(n))),u?this.send({type:e,datas:u.datas,glRes:u.glRes,matrix:u.matrix,center:u.center},u.transfer,(function(t,e){t&&console.error(t),e.key=s,e.id=c,i(e)})):console.error(`No processing logic found for type:${e}`)}});class We{constructor(){this.queueMap={},this.tempQueue=[],this.time=this.getCurrentTime(),this.deQueueCount=5,this.resultQueue=[]}getActor(){return Ie()}getCurrentTime(){return r.Util.now()}loop(){this.deQueue()}push(t){return this.tempQueue.push(t),t.id&&(this.queueMap[t.id]=t),this}reset(){return this.time=this.getCurrentTime(),this.tempQueue=[],this}pushResult(t){if(t)return Array.isArray(t)||(t=[t]),t.forEach((t=>{this.resultQueue.push(t)})),this}deQueue(){if(!this.resultQueue.length)return this;const t=this.deQueueCount;return(this.resultQueue.slice(0,t)||[]).forEach((t=>{const{id:e}=t;if(this.queueMap[e]){const{baseObject:n}=this.queueMap[e];if(n&&n._workerLoad){n.getLayer()?n._workerLoad(t):console.warn(n," worker Processing completed but removed from the layer")}delete this.queueMap[e]}})),this.resultQueue.splice(0,t),this}}const qe=new class extends We{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){Ie().pushQueue({type:"ExtrudePolygon",layer:this.tempQueue[0].layer,data:De(this.tempQueue),options:He(this.tempQueue),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},Ne=new class extends We{loop(){if(this.tempQueue.length){const t=Ie();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"ExtrudePolygons",layer:e.layer,data:e.data,key:e.key,center:e.center,baseOptions:e.option,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},Xe=new class extends We{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){Ie().pushQueue({type:"ExtrudeLine",layer:this.tempQueue[0].layer,data:De(this.tempQueue),options:He(this.tempQueue),lineStrings:this.tempQueue.map((t=>t.lineString)),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},Ke=new class extends We{loop(){if(this.tempQueue.length){const t=Ie();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"ExtrudeLines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,baseOptions:e.option,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},Ye=new class extends We{constructor(){super(),this.deQueueCount=200}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){Ie().pushQueue({type:"Line",layer:this.tempQueue[0].layer,data:De(this.tempQueue),options:He(this.tempQueue),lineStrings:this.tempQueue.map((t=>t.lineString)),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},Je=new class extends We{loop(){if(this.tempQueue.length){const t=Ie();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"Lines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,baseOptions:e.option,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},$e=new class extends We{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){Ie().pushQueue({type:"FatLine",layer:this.tempQueue[0].layer,data:De(this.tempQueue),options:He(this.tempQueue),lineStrings:this.tempQueue.map((t=>t.lineString)),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},tn=new class extends We{loop(){if(this.tempQueue.length){const t=Ie();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"FatLines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,baseOptions:e.option,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},en=new class extends We{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){Ie().pushQueue({type:"Bar",layer:this.tempQueue[0].layer,data:De(this.tempQueue),options:He(this.tempQueue),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},nn=new class extends We{constructor(){super(),this.deQueueCount=1}loop(){if(this.tempQueue.length){const t=Ie();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"Bars",layer:e.layer,data:e.data,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},rn=new class extends We{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){Ie().pushQueue({type:"Path",layer:this.tempQueue[0].layer,data:De(this.tempQueue),options:He(this.tempQueue),lineStrings:this.tempQueue.map((t=>t.lineString)),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},sn=new class extends We{loop(){if(this.tempQueue.length){const t=Ie();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"Paths",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,baseOptions:e.option,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},on={isRunning:!1,tasks:[],addTask:t=>{t&&on.tasks.push(t)},removeTask:t=>{const e=on.tasks.indexOf(t);e>-1&&on.tasks.splice(e,1)},loop(){qe.loop(),Ne.loop(),Xe.loop(),Ke.loop(),Ye.loop(),Je.loop(),$e.loop(),tn.loop(),en.loop(),nn.loop(),rn.loop(),sn.loop(),on.tasks.forEach((t=>{t&&t.loop&&t.loop()})),requestAnimationFrame(on.loop)},star(){on.isRunning||(on.isRunning=!0,on.loop())}};function an(t){const{position:e,normal:n,uv:i,indices:r}=hn(t),o=new s.BufferGeometry,h=new Float32Array(e.length);return h.fill(1,0,e.length),a(o,"color",new s.BufferAttribute(h,3)),a(o,"normal",new s.BufferAttribute(n,3)),a(o,"position",new s.BufferAttribute(e,3)),i&&i.length&&a(o,"uv",new s.BufferAttribute(i,2)),o.setIndex(new s.BufferAttribute(r,1)),o}function hn(t){const e={},n={};for(let i=0;i<t.length;++i){const r=t[i];for(const t in r)void 0===e[t]&&(e[t]=[],n[t]=0),e[t].push(r[t]),n[t]+=r[t].length}const i={};let r=0;const s=new Uint32Array(n.indices);for(const t in e)if("indices"===t){const n=e[t];let i=0;for(let t=0,o=n.length;t<o;t++){const o=n[t];for(let t=0,e=o.length;t<e;t++)s[i]=o[t]+r,i++;r+=e.position[t].length/3}}else{const r=cn(e[t],n[t]);if(!r)return null;i[t]=r}return i.indices=s,i}function cn(t,e){const n=new Float32Array(e);let i=0;for(let e=0;e<t.length;++e)n.set(t[e],i),i+=t[e].length;return n}function ln(t){const{position:e,normal:n,uv:i,indices:r}=t,o=new s.BufferGeometry;return a(o,"normal",new s.BufferAttribute(new Float32Array(n),3)),a(o,"position",new s.BufferAttribute(new Float32Array(e),3)),a(o,"uv",new s.BufferAttribute(new Float32Array(i),2)),o.setIndex(new s.BufferAttribute(new Uint32Array(r),1)),o}function un(t){const e=new s.BufferGeometry;return a(e,"normal",t.getAttribute("normal")),a(e,"position",t.getAttribute("position").clone()),e.setIndex(t.getIndex()),e}let dn;function fn(){if(!dn){const t=1e-6;dn=l(t,t,t)}return dn}fn();var pn=Object.freeze({__proto__:null,mergeBufferGeometries:an,mergeBufferGeometriesAttribute:hn,generateBufferGeometry:ln,generatePickBufferGeometry:un,getDefaultBufferGeometry:fn});const gn=l(1,1,1);gn.translate(0,0,.5);const yn=new s.Color("#fff"),xn=new s.Color("#fff");function mn(t){const e=Object.assign({},t);return e._radius&&(e.radius=e._radius),function(t){const{position:e,normal:n,uv:i,indices:r}=Vt(t.center||[0,0],t),o=new s.BufferGeometry;return a(o,"normal",new s.BufferAttribute(n,3)),a(o,"position",new s.BufferAttribute(e,3)),a(o,"uv",new s.BufferAttribute(i,2)),o.setIndex(new s.BufferAttribute(r,1)),o}(e)}function _n(t,e,n,i="y",r=0){let o=0;"y"===i?o=1:"z"===i&&(o=2);const h=t.attributes.position.array,c=h.length;xn.setStyle(e),yn.setStyle(n);const l=new Float32Array(c);if(Array.isArray(r))for(let t=0,e=r.length;t<e;t++){const{middleZ:e,start:n,end:i}=r[t].position;for(let t=n;t<i;t+=3){h[t+2]>e?(l[t]=yn.r,l[t+1]=yn.g,l[t+2]=yn.b):(l[t]=xn.r,l[t+1]=xn.g,l[t+2]=xn.b)}}else for(let t=0;t<c;t+=3){h[t+o]>r?(l[t]=yn.r,l[t+1]=yn.g,l[t+2]=yn.b):(l[t]=xn.r,l[t+1]=xn.g,l[t+2]=xn.b)}return a(t,"color",new s.BufferAttribute(l,3,!0)),l}function vn(t){const e=[],n=t.length;let i=0;for(let e=0;e<n;e++){const{color:n}=t[e].attributes;n&&(i+=n.array.length)}const r=new Float32Array(i);let o=0;for(let n=0,i=t.length;n<i;n++){const{color:i,normal:s,position:a,uv:h}=t[n].attributes,c=t[n].index;i&&(r.set(i.array,o),o+=i.array.length),e.push({normal:s.array,uv:h.array,position:a.array,indices:c.array})}const h=an(e);r.length&&a(h,"color",new s.BufferAttribute(r,3,!0));for(let e=0,n=t.length;e<n;e++)t[e].dispose();return h}function bn(){return gn}const wn={radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61",heightEnable:!0};class Mn extends v{constructor(t,e,n,i){e=r.Util.extend({},wn,e,{layer:i,coordinate:t}),super(),this._initOptions(e);const{height:s,radius:o,topColor:a,bottomColor:h,altitude:l,asynchronous:u}=e;let d;if(e.height=i.altitudeToVector3(s,s).x,e.radius=i.distanceToVector3(o,o).x,u){d=fn();const t=r.Util.GUID();this.getOptions().id=t,en.push({data:{radius:e.radius,height:e.height,radialSegments:e.radialSegments,id:t},layer:i,id:t,baseObject:this})}else d=mn(e),a&&(_n(d,h,a,"z",e.height/2),n.vertexColors=c());this._createMesh(d,n);const f=i.altitudeToVector3(l,l).x,p=i.coordinateToVector3(t,f);this.getObject3d().position.copy(p),this.type="Bar"}_workerLoad(t){const e=ln(t),{topColor:n,bottomColor:i,height:r}=this.getOptions(),s=this.getObject3d(),o=s.material;if(n){_n(e,i,n,"z",this.getLayer().altitudeToVector3(r,r).x/2),o.vertexColors=c()}s.geometry=e,s.material.needsUpdate=!0,this._fire("workerload",{target:this})}}function zn(t){const e=[];return t&&t.length&&t.forEach((t=>{t=t instanceof s.Color?t:new s.Color(t),e.push(t.r,t.g,t.b)})),e}const On={altitude:0,bottomHeight:0,colors:null};class An extends v{constructor(t,e,n,i){e=r.Util.extend({},On,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{lineStrings:o,center:h}=Ce(t),{asynchronous:l}=e;let u;if(l){u=Le();const n=r.Util.GUID();this.getOptions().id=n,this.getOptions().center=h,Ye.push({id:n,data:o,layer:i,key:e.key,lineString:t,baseObject:this})}else{const t=[];for(let e=0,n=o.length;e<n;e++){const n=o[e],{positions:r}=ze(n,i,h,!1);t.push(ke(r))}const r=Te(t);u=new s.BufferGeometry,a(u,"position",new s.BufferAttribute(r,3)),se(u,e.bottomHeight,i);const l=zn(e.colors);l&&l.length&&(a(u,"color",new s.Float32BufferAttribute(l,3)),n.vertexColors=c())}this._createLineSegments(u,n);const{altitude:d}=e,f=i.altitudeToVector3(d,d).x,p=i.coordinateToVector3(h,f);this.getObject3d().position.copy(p),this.type="Line"}_workerLoad(t){const e=new s.BufferGeometry;a(e,"position",new s.BufferAttribute(new Float32Array(t.position),3));const n=zn(this.getOptions().colors),i=this.getObject3d(),r=i.material;n&&n.length&&(a(e,"color",new s.Float32BufferAttribute(n,3)),r.vertexColors=c()),this._computeLineDistances(e),i.geometry=e,i.material.needsUpdate=!0,this._fire("workerload",{target:this})}}const Sn={bottomHeight:0,width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61",heightEnable:!0,pathUV:!1};class jn extends v{constructor(t,e,n,i){e=r.Util.extend({},Sn,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{height:s,width:o,bottomColor:a,topColor:h,bottomHeight:l,altitude:u,asynchronous:d,pathUV:f}=e,p=i.altitudeToVector3(s,s).x,g=i.distanceToVector3(o,o).x,{lineStrings:y,center:x}=Ce(t);let m;if(d){m=fn();const e=r.Util.GUID();this.getOptions().id=e,this.getOptions().center=x,Xe.push({id:e,data:y,layer:i,center:x,lineString:t,baseObject:this})}else{const t=[];let e=0;const r={};for(let n=0,s=y.length;n<s;n++){const s=Se(y[n],g,p,f,i,x);e=se(s,l,i,r),t.push(s)}m=an(t),h&&(ye(m,a,h,e+p/2),n.vertexColors=c())}this._createMesh(m,n);const _=i.altitudeToVector3(u,u).x,v=i.coordinateToVector3(x,_);this.getObject3d().position.copy(v),this.type="ExtrudeLine"}_workerLoad(t){const e=ln(t),{topColor:n,bottomColor:i,bottomHeight:r,height:s}=this.getOptions(),o=this.getObject3d(),a=o.material;if(n){const t=this.getLayer();ye(e,i,n,t.altitudeToVector3(r,r).x+t.altitudeToVector3(s,s).x/2),a.vertexColors=c()}o.geometry=e,o.material.needsUpdate=!0,this._fire("workerload",{target:this})}}const Cn={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61",heightEnable:!0,top:!0};class kn extends v{constructor(t,e,n,i){e=r.Util.extend({},Cn,e,{layer:i,polygon:t}),super(),this._initOptions(e);const{height:s,topColor:o,bottomColor:a,altitude:h,bottomHeight:l,asynchronous:u,top:d}=e;let f;const p=z(t)?C(t):t.getCenter();if(u){f=fn();const e=r.Util.GUID();this.getOptions().id=e,this.getOptions().center=p,qe.push({data:t,layer:i,id:e,baseObject:this})}else{f=pe(t,s,d,i);const e=se(f,l,i);if(o){ye(f,a,o,e+i.altitudeToVector3(s,s).x/2),n.vertexColors=c()}}this._createMesh(f,n);const g=i.altitudeToVector3(h,h).x,y=i.coordinateToVector3(p,g);this.getObject3d().position.copy(y),this.type="ExtrudePolygon"}_workerLoad(t){const e=ln(t),{topColor:n,bottomColor:i,bottomHeight:r,height:s}=this.getOptions(),o=this.getObject3d(),a=o.material;if(n){const t=this.getLayer();ye(e,i,n,t.altitudeToVector3(r,r).x+t.altitudeToVector3(s,s).x/2),a.vertexColors=c()}o.geometry=e,o.material.needsUpdate=!0,this._fire("workerload",{target:this})}}const Tn={altitude:0,coordinate:null};class Pn extends v{constructor(t,e={},n){e.coordinate||(console.warn("coordinate is null,it is important to locate the model"),e.coordinate=n.getMap().getCenter()),e=r.Util.extend({},Tn,e,{layer:n,model:t}),super(),this._initOptions(e),this._createGroup(),this.getObject3d().add(t);const{altitude:i,coordinate:s}=e,o=n.altitudeToVector3(i,i).x,a=n.coordinateToVector3(s,o);this.getObject3d().position.copy(a),this.type="Model"}getCoordinates(){const t=this.options.coordinate,e=this.options.altitude,n=new r.Coordinate(t);return n.z=e,n}}const Vn=Math.PI/180;function Ln(t){return t.getCoordinates().map((t=>t.toArray()))}function Bn(t){return t*Vn}function Un(t,e){if(!t||!e)return 0;Array.isArray(t)||(t=t.toArray()),Array.isArray(e)||(e=e.toArray());let n=Bn(t[1]);const i=Bn(e[1]),r=n-i,s=Bn(t[0])-Bn(e[0]);return n=2*Math.asin(Math.sqrt(Math.pow(Math.sin(r/2),2)+Math.cos(n)*Math.cos(i)*Math.pow(Math.sin(s/2),2))),n*=6378137,Math.round(1e5*n)/1e5}function En(t,e){const{len:n,c1:i,c2:r}=t,s=r[0]-i[0],o=r[1]-i[1],a=e/n;return[i[0]+a*s,i[1]+a*o]}function In(t,e=10){e=Math.max(e,.1),Array.isArray(t)||(t=Ln(t));const n=t.length;let i=[],r=0;for(let e=0;e<n-1;e++){const n=Un(t[e],t[e+1]),s=Math.floor(n);i.push({c1:t[e],len:s,c2:t[e+1]}),r+=s}if(r<=e){return i.map((t=>[t.c1,t.c2]))}if(1===i.length&&i[0].len<=e)return[[i[0].c1,i[0].c2]];const s=i.length;let o,a=0,h=0;const c=[];let l=[i[0].c1];for(;a<s;){const{len:t,c2:n}=i[a];if(h+=t,h<e&&(l.push(n),a===s-1&&c.push(l),a++),h===e&&(l.push(n),h=0,c.push(l),l=[n],a++),h>e){const n=t-h+e;o=En(i[a],n),l.push(o),c.push(l),h=0,i[a].c1=o,i[a].len=t-n,l=[],l.push(o)}}return c}var Fn=Object.freeze({__proto__:null,distance:Un,lineLength:function(t){let e=t;Array.isArray(t)||(e=Ln(t));let n=0;for(let t=0,i=e.length;t<i-1;t++)n+=Un(e[t],e[t+1]);return n},lineSlice:In});const Rn=1e3;const Gn={trail:5,chunkLength:50,width:2,height:1,speed:1,altitude:0,interactive:!1,heightEnable:!0,pathUV:!1};class Zn extends v{constructor(t,e,n,i){e=r.Util.extend({},Gn,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{width:o,height:h,altitude:c,speed:l,chunkLength:u,trail:d,pathUV:f}=e;let p,g;M(t)?(p=C(t),g=j(t)):(p=t.getCenter(),g=t);const y=In(g,u),x=i.coordinateToVector3(p),m=new s.BufferGeometry,_=new Float32Array(3e3),v=new Float32Array(3e3),b=new Uint16Array(Rn);a(m,"position",new s.BufferAttribute(_,3)),a(m,"normal",new s.BufferAttribute(v,3)),m.setIndex(new s.BufferAttribute(b,1));const w=i.distanceToVector3(o,o).x,z=i.altitudeToVector3(h,h).x;this._createMesh(m,n);const O=i.altitudeToVector3(c,c).x,A=i.coordinateToVector3(p,O);this.getObject3d().position.copy(A),this._params={index:0,chunkLines:y,geometries:[],layer:i,trail:Math.max(1,d),lineWidth:w,depth:z,speed:Math.min(1,l),idx:0,loaded:!0,center:p,centerPt:x,workerInitCount:0,pathUV:f},this._init(this._params),this.type="ExtrudeLineTrail"}_init(t){const{layer:e,trail:n,lineWidth:i,depth:s,chunkLines:o,positionMap:a,centerPt:h,center:c,pathUV:l}=t,u=o.length,d=[];if(this.options.asynchronous){t.loaded=!1;const i=r.Util.GUID();for(let t=0;t<u;t++){const s={type:"Feature",geometry:{type:"LineString",coordinates:Ae(o.slice(t,t+n))}},a=`${i}-${t}`,h=r.Util.extend({},this.options);h.parentCenter=c,h.id=a,h.center=c,Xe.push({id:a,data:[s],layer:e,center:c,lineString:s,baseObject:this,option:h})}}else for(let t=0;t<u;t++){const r=Oe(o.slice(t,t+n),e,0,h).positionsV;d.push(Se(r,i,s,l,e))}}_animation(){const{index:t,geometries:e,speed:n,idx:i,chunkLines:r,trail:s,lineWidth:o,depth:a,loaded:h,layer:c,positionMap:l,centerPt:u,pathUV:d}=this._params;if(!h)return;const f=Math.round(t);if(f>i&&f<=r.length-1){this._params.idx++;let t=e[f];if(!t){t=Se(Oe(r.slice(f,f+s),c,0,u).positionsV,o,a,d,c),e[f]=t}const n=this.getObject3d();!function(t,e,n,i){const r=e.length;t.attributes.normal.count=r,t.attributes.position.count=r;const s=t.attributes.position.array,o=t.attributes.normal.array;for(let t=0;t<r;t++)s[t]=e[t],o[t]=n[t];t.index.count=i.length;for(let e=0,n=i.length;e<n;e++)t.index.array[e]=i[e]}(n.geometry,t.position,t.normal,t.indices),n.geometry.attributes.position.needsUpdate=!0,n.geometry.attributes.normal.needsUpdate=!0,n.geometry.index.needsUpdate=!0}t>=r.length-1&&(this._params.index=-1,this._params.idx=-1),this._params.index+=n}_workerLoad(t){if(!t)return this;const{id:e,indices:n,position:i,normal:s,uv:o}=t;if(!(e&&n&&i&&s&&o))return;let a=e.split("-")[1];if(a=parseInt(a),r.Util.isNumber(a)){this._params.geometries[a]={indices:new Uint32Array(n),position:new Float32Array(i),uv:new Float32Array(o),normal:new Float32Array(s)},this._params.workerInitCount++}this._params.workerInitCount===this._params.chunkLines.length&&(this._params.loaded=!0,this._fire("workerload",{target:this}))}}const Qn=["click","mousemove","mousedown","mouseup","dblclick","contextmenu"].join(" ").toString(),Dn=new s.MeshBasicMaterial;Dn.vertexColors=c();const Hn=t=>class extends t{_initBaseObjectsEvent(t){if(t&&Array.isArray(t)&&t.length)for(let e=0,n=t.length;e<n;e++){const n=t[e];this._proxyEvent(n)}return this}_proxyEvent(t){t.on("add",(t=>{this._showGeometry(t.target,!0)})),t.on("remove",(t=>{this._showGeometry(t.target,!1)})),t.on("mouseout",(t=>{this._mouseover=!1,this.fire("mouseout",Object.assign({},t,{target:this,selectMesh:this.getSelectMesh?this.getSelectMesh():null}))})),t.on(Qn,(t=>{this.fire(t.type,Object.assign({},t,{target:this,selectMesh:this.getSelectMesh?this.getSelectMesh():null}))}))}_getHideGeometryIndex(t){const e=[];let n=0;for(let i=0,r=this._geometriesAttributes.length;i<r;i++)!0===this._geometriesAttributes[i].hide&&(e.push(i),n+=this._geometriesAttributes[i][t].count);return{indexs:e,count:n}}_updateAttribute(t,e){const{indexs:n}=this._getHideGeometryIndex(e),i=this._geometryCache.attributes[e].array,r=i.length;for(let e=0;e<r;e++)t.array[e]=i[e];let o=NaN;this.getObject3d()instanceof s.LineSegments&&(o=0);for(let i=0;i<n.length;i++){const r=n[i],{start:s,end:a}=this._geometriesAttributes[r][e];for(let e=s;e<a;e++)t.array[e]=o}return this}_showGeometry(t,e){let n;if(t&&(n=t.getOptions().index),null!=n){const t=this._geometriesAttributes[n],{hide:i}=t;if(i===e)return this;t.hide=e;const r=this.getObject3d().geometry;this._updateAttribute(r.attributes.position,"position"),r.attributes.position.needsUpdate=!0,this.isHide=e}return this}getSelectMesh(){const t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}}_getIndex(t){return null==t&&(t=this.faceIndex||this.index),t}_init(){const t=this.getLayer().getPick();this.on("add",(()=>{t.add(this.pickObject3d)})),this.on("remove",(()=>{t.remove(this.pickObject3d)}))}_setPickObject3d(){if(!this._colorMap)return;const t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),{_geometriesAttributes:n}=this,i=n.length,r=oe(n);let o=0;for(let t=0;t<i;t++){const i=e.getColor(),s=i.getHex();this._colorMap[s]=t;const{count:a}=n[t].position;this._datas[t].colorIndex=s;for(let t=0;t<a;t++)r[o]=i.r,r[o+1]=i.g,r[o+2]=i.b,o+=3}a(t,"color",new s.BufferAttribute(r,3,!0));const h=e.getColor().getHex(),c=new s.Mesh(t,Dn);c.position.copy(this.getObject3d().position),c._colorIndex=h,this.setPickObject3d(c)}},Wn={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61",top:!0},qn=new r.Coordinate(0,0);class Nn extends(Hn(v)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const s=t.length;0===s&&console.error("polygons is empty");let o=1/0,a=1/0,h=-1/0,l=-1/0;for(let e=0;e<s;e++){const n=t[e],i=n.getCenter?n.getCenter():C(n,qn);let s,c;Array.isArray(i)?(s=i[0],c=i[1]):i instanceof r.Coordinate&&(s=i.x,c=i.y),o=Math.min(o,s),a=Math.min(a,c),h=Math.max(h,s),l=Math.max(l,c)}const u=new r.Coordinate((o+h)/2,(a+l)/2);e=r.Util.extend({},Wn,e,{layer:i,polygons:t,coordinate:u});const{topColor:d,bottomColor:f,altitude:p,asynchronous:g,top:y}=e;let x;const m=[],_=[];if(super(),g)x=fn(),Ne.push({id:r.Util.GUID(),layer:i,key:e.key,center:u,data:t,baseObject:this,option:e});else{const o=i.coordinateToVector3(u),a=[];let h=0;const l={};for(let n=0;n<s;n++){const s=t[n],c=r.Util.extend({},e,le(s)),d=c.height||1,f=c.bottomHeight||0,p=ge(s,d,y,i,u,o,l);a.push(p);const g=se(p,f,i,l),{position:x,normal:m,uv:v,indices:b}=p;b.length;const w=x.length/3;m.length,v.length,_[n]={position:{middleZ:g+l[d]/2,count:w,start:h,end:h+3*w},hide:!1},h+=3*w}x=an(a),d&&(ye(x,f,d,_),n.vertexColors=c())}this._initOptions(e),this._createMesh(x,n);const v=i.altitudeToVector3(p,p).x,b=i.coordinateToVector3(u,v);this.getObject3d().position.copy(b),this._baseObjects=m,this._datas=t,this._geometriesAttributes=_,this.faceIndex=null,this._geometryCache=un(x),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(m),g||(this._setPickObject3d(),this._init()),this.type="ExtrudePolygons"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,z(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new kn(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){return this.picked}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=ln(t);this._geometryCache=un(n);const{topColor:i,bottomColor:r}=this.getOptions(),s=this.getObject3d(),o=s.material;if(i&&(ye(n,r,i,e),o.vertexColors=c()),s.geometry=n,s.material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}function Xn(t,e,n){const i=t.project(n),r=e.width/2,s=e.height/2;return{x:Math.round(i.x*r+r),y:Math.round(-i.y*s+s)}}var Kn=Object.freeze({__proto__:null,vectors2Pixel:function(t,e,n,i=0,r){return t[0]instanceof s.Vector3||(t=function(t,e=0,n){const i=[],r={};for(let o=0,a=t.length;o<a;o+=3){let a=t[o],h=t[o+1],c=t[o+2];e>0&&(c+=ie(e,n,r)),i.push(new s.Vector3(a,h,c))}return i}(t,i,r)),t.map((t=>Xn(t,e,n)))},vector2Pixel:Xn});const Yn={altitude:0,height:0,color:null},Jn=new s.Vector3;class $n extends v{constructor(t,e,n,i){e=r.Util.extend({},Yn,e,{layer:i,coordinate:t}),super();let{height:o,altitude:h,color:c,size:l}=e;const u=[],d=[];c&&(c=c instanceof s.Color?c:new s.Color(c),d.push(c.r,c.g,c.b));const f=i.altitudeToVector3(o,o).x,p=i.coordinateToVector3(t,f);u.push(0,0,p.z);const g=new s.BufferGeometry;a(g,"position",new s.Float32BufferAttribute(u,3,!0)),d.length&&a(g,"color",new s.Float32BufferAttribute(d,3,!0)),void 0!==l&&a(g,"size",new s.Float32BufferAttribute([l],1,!0)),e.positions=p,this._initOptions(e),this._createPoints(g,n);const y=i.altitudeToVector3(h,h).x,x=new s.Vector3(p.x,p.y,y);this.getObject3d().position.copy(x),this.type="Point"}identify(t){const e=this.getLayer(),n=this.getMap().getSize(),i=this.getLayer().getCamera(),r=this.getOptions().positions,s=this.getOptions().altitude;let o=this.getObject3d().material.size;void 0===o&&(o=this.options.size||1);const a=this.getMap().coordToContainerPoint(t),h=e.altitudeToVector3(s,s).x;Jn.x=r.x,Jn.y=r.y,Jn.z=r.z+h;const c=Xn(Jn,n,i);return Math.sqrt(Math.pow(a.x-c.x,2)+Math.pow(a.y-c.y,2))<=o/2}}function ti(t,e){const{minx:n,miny:i,maxx:r,maxy:s}=t,[o,a]=e;return n<=o&&o<=r&&i<=a&&a<=s}class ei{constructor(t,e,n,i){this.minlng=t,this.minlat=e,this.maxlng=n,this.maxlat=i,this.minx=1/0,this.miny=1/0,this.maxx=-1/0,this.maxy=-1/0,this.coordinates=[],this.positions=[],this.indexs=[],this.key=null}updateBBoxPixel(t){let e=1/0,n=1/0,i=-1/0,s=-1/0;const{minlng:o,minlat:a,maxlng:h,maxlat:c}=this;return[[o,a],[o,c],[h,a],[h,c]].map((t=>new r.Coordinate(t))).map((e=>t.coordToContainerPoint(e))).forEach((t=>{e=Math.min(e,t.x),n=Math.min(n,t.y),i=Math.max(i,t.x),s=Math.max(s,t.y)})),this.minx=e,this.miny=n,this.maxx=i,this.maxy=s,this}containsCoordinate(t){let e,n;Array.isArray(t)?(e=t[0],n=t[1]):t instanceof r.Coordinate&&(e=t.x,n=t.y);const{minlng:i,minlat:s,maxlng:o,maxlat:a}=this;return i<=e&&e<=o&&s<=n&&n<=a}isRecCross(t,e){const{x:n,y:i}=t,r={minx:n-e/2,miny:i-e/2,maxx:n+e/2,maxy:i+e/2},{minx:s,miny:o,maxx:a,maxy:h}=r;return!!(ti(this,[s,o])||ti(this,[s,h])||ti(this,[a,o])||ti(this,[a,h])||ti(r,[this.minx,this.miny])||ti(r,[this.minx,this.maxy])||ti(r,[this.maxx,this.miny])||ti(r,[this.maxx,this.maxy]))}static initGrids(t,e,n,i){const r=[],s=(n-t)/30,o=(i-e)/30;let a=t,h=e;for(let n=0;n<30;n++){a=t+n*s;for(let t=0;t<30;t++){h=e+t*o;const i=new ei(a,h,a+s,h+o);i.key=t+"-"+n,r.push(i)}}return{grids:r,averageX:s,averageY:o,ROWS:30,COLS:30}}}const ni={altitude:0},ii=new s.Vector3;function ri(t,e){const n=Math.pow(10,e);return Math.round(t*n)/n}class si extends(Hn(v)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]),e=r.Util.extend({},ni,e,{layer:i,points:t});let o=1/0,h=1/0,c=-1/0,l=-1/0;for(let e=0,n=t.length;e<n;e++){const{coordinate:n}=t[e];let i,s;Array.isArray(n)?(i=n[0],s=n[1]):n instanceof r.Coordinate&&(i=n.x,s=n.y),t[e].coords=[i,s],o=Math.min(o,i),h=Math.min(h,s),c=Math.max(c,i),l=Math.max(l,s)}const u=i.coordinateToVector3([(o+c)/2,(h+l)/2]),{grids:d,averageX:f,averageY:p,ROWS:g,COLS:y}=ei.initGrids(o,h,c,l);d.length;const x=new Float32Array(3*t.length),m=[],_=new Float32Array(3*t.length),v=new Float32Array(t.length),b=[],w=[],M={};let z=0,O=!1,A=!1;const S=new s.Vector3(0,0,0);for(let e=0,n=t.length;e<n;e++){let{coordinate:n,height:r,color:a,size:c,coords:l}=t[e];const y=3*e;a&&(O=!0,a=a instanceof s.Color?a:new s.Color(a),_[y]=a.r,_[y+1]=a.g,_[y+2]=a.b),c&&(A=!0,v[e]=c,z=Math.max(z,c));const b=ie(r,i,M),j=i.coordinateToVector3(n,b);S.x=j.x,S.y=j.y,S.z=j.z,S.sub(u),x[y]=S.x,x[y+1]=S.y,x[y+2]=S.z,m.push(j),w[e]={position:{count:1,start:3*e,end:3*e+3},hide:!1};let C=ri((l[1]-h)/p,4),k=ri((l[0]-o)/f,4);C-=1,k-=1,C=Math.max(0,C),k=Math.max(0,k),C=Math.ceil(C),k=Math.ceil(k);const T=k*g+C;d[T]&&(d[T].positions.push(j),d[T].indexs.push(e))}const j=new s.BufferGeometry;a(j,"position",new s.BufferAttribute(x,3,!0)),O&&a(j,"color",new s.BufferAttribute(_,3,!0)),A&&a(j,"size",new s.BufferAttribute(v,1,!0)),e.positions=m,super(),this._initOptions(e),this._createPoints(j,n);const C=e.altitude,k=i.altitudeToVector3(C,C).x,T=u.clone();T.z=k,this.getObject3d().position.copy(T),this._baseObjects=b,this._datas=t,this.faceIndex=null,this._geometriesAttributes=w,this._geometryCache=j.clone(),this.isHide=!1,this._initBaseObjectsEvent(b),this._grids=d,this._bindMapEvents(),this.type="Points",this.maxSize=z}_bindMapEvents(){const t=this.getMap(),e="zoomstart zooming zoomend movestart moving moveend pitch rotate";this.on("add",(()=>{this._updateGrids(),t.on(e,this._updateGrids,this)})),this.on("remove",(()=>{t.off(e,this._updateGrids,this)}))}_updateGrids(){const t=this.getMap();this._grids.forEach((e=>{e.indexs.length&&e.updateBBoxPixel(t)}))}getSelectMesh(){const t=this.faceIndex;if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],{coordinate:n,height:i,color:r,size:s}=e;this._baseObjects[t]=new $n(n,{height:i,index:t,color:r,size:s},this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){const e=this.getLayer(),n=this.getMap().getSize(),i=this.getLayer().getCamera(),r=this.getOptions().altitude,s=this.getMap(),o=e.altitudeToVector3(r,r).x;let a=this.getObject3d().material.size;const h=void 0===a,c=s.coordToContainerPoint(t),l=[];if(this._grids.forEach((t=>{t.indexs.length&&t.isRecCross(c,h?this.maxSize:a)&&l.push(t)})),l.length<1)return!1;for(let t=0,e=l.length;t<e;t++)for(let e=l[t].positions.length-1;e>=0;e--){h&&(a=this._datas[l[t].indexs[e]].size||1);const r=l[t].positions[e];ii.x=r.x,ii.y=r.y,ii.z=r.z+o;const s=Xn(ii,n,i);if(Math.sqrt(Math.pow(c.x-s.x,2)+Math.pow(c.y-s.y,2))<=a/2)return this.faceIndex=l[t].indexs[e],!0}return!1}}const oi={coordinate:"",radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61"};class ai extends(Hn(v)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const o=t.length,a=re(t),h=i.coordinateToVector3(a),l=[],u=[],d=[];let f=0;const p={},g={};let y;super(),e=r.Util.extend({},{altitude:0,layer:i,points:t},oi,e),this._initOptions(e);const x=new s.Vector3;if(e.asynchronous){y=fn();const n=r.Util.GUID();this.getOptions().id=n;const s=[];for(let n=0;n<o;n++){const o=r.Util.extend({index:n},e,t[n]),{radius:a,radialSegments:c,altitude:l,height:u,coordinate:d}=o,f=ne(a,i,p);t[n]._radius=f;const y=ie(u,i,g),m=ie(l,i,g),_=i.coordinateToVector3(d,0,x).sub(h);s.push({radialSegments:c,radius:f,height:y,center:[_.x,_.y],altitude:m})}nn.push({id:n,data:s,layer:i,baseObject:this})}else{for(let s=0;s<o;s++){const o=r.Util.extend({index:s},e,t[s]),{radius:a,radialSegments:y,altitude:m,topColor:_,bottomColor:v,height:b,coordinate:w}=o,M=ne(a,i,p),z=ie(b,i,g),O=ie(m,i,g),A=i.coordinateToVector3(w,0,x).sub(h),S=mn({radius:M,height:z,radialSegments:y,center:[A.x,A.y]});_&&(_n(S,v,_,"z",z/2),n.vertexColors=c());const j=S.attributes.position.array;for(let t=0,e=j.length;t<e;t+=3)j[t+2]+=O;l.push(S);const C=new Mn(w,o,n,i);u.push(C),S.index.count;const k=S.attributes.position.count;S.attributes.normal.count,S.attributes.uv.count,d[s]={position:{count:k,start:f,end:f+3*k},hide:!1},f+=3*k}y=vn(l)}this._createMesh(y,n);const m=e.altitude,_=i.altitudeToVector3(m,m).x,v=h.clone();v.z=_,this.getObject3d().position.copy(v),this._baseObjects=u,this._datas=t,this._geometriesAttributes=d,this.faceIndex=null,this._geometryCache=un(y),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(u),e.asynchronous||(this._setPickObject3d(),this._init()),this.type="Bars"}identify(){return this.picked}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,e,{index:t,asynchronous:!1});this._baseObjects[t]=new Mn(e.coordinate,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=ln(t);this._geometryCache=un(n);const{topColor:i,bottomColor:r}=this.getOptions(),s=this.getObject3d(),o=s.material;if(i&&(_n(n,r,i,"z",e),o.vertexColors=c()),s.geometry=n,s.material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const hi={width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61",pathUV:!1};class ci extends(Hn(v)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const s=[],o=[],a=t.length;for(let e=0;e<a;e++){const n=Ce(t[e]);s.push(n.center),o.push(n.lineStrings)}const h=re(s);e=r.Util.extend({},hi,e,{layer:i,lineStrings:t,coordinate:h});const{altitude:l,topColor:u,bottomColor:d,asynchronous:f,pathUV:p}=e;let g;const y=[],x=[];if(super(),f)g=fn(),Ke.push({id:r.Util.GUID(),layer:i,key:e.key,center:h,data:o,lineStrings:t,baseObject:this,option:e});else{const s=[];let l=0;const f={},y={};for(let n=0;n<a;n++){const a=t[n],c=r.Util.extend({},e,ue(a),{index:n}),{height:u,width:d,bottomHeight:g}=c,m=ne(d,i,f),_=ie(u,i,y),v=o[n],b=[];let w=0;for(let t=0,e=v.length;t<e;t++){const e=Se(v[t],m,_,p,i,h);w=se(e,g,i,f),b.push(e)}const M=hn(b);s.push(M);const{position:z,normal:O,indices:A}=M;A.length;const S=z.length/3;O.length,x[n]={position:{middleZ:w+_/2,count:S,start:l,end:l+3*S},hide:!1},l+=3*S}g=an(s),u&&(ye(g,d,u,x),n.vertexColors=c())}this._initOptions(e),this._createMesh(g,n);const m=i.altitudeToVector3(l,l).x,_=i.coordinateToVector3(h,m);this.getObject3d().position.copy(_),this._baseObjects=y,this._datas=t,this._geometriesAttributes=x,this.faceIndex=null,this._geometryCache=un(g),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(y),f||(this._setPickObject3d(),this._init()),this.type="ExtrudeLines"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,O(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new jn(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){return this.picked}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=ln(t);this._geometryCache=un(n);const{topColor:i,bottomColor:r,bottomHeight:s,height:o}=this.getOptions(),a=this.getObject3d().material;if(i&&(ye(n,r,i,e),a.vertexColors=c()),this.getObject3d().geometry=n,this.getObject3d().material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const li={altitude:0,colors:null};class ui extends(Hn(v)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const o=[],h=[],c=t.length;for(let e=0;e<c;e++){const n=Ce(t[e]);o.push(n.center),h.push(n.lineStrings)}const l=re(o);e=r.Util.extend({},li,e,{layer:i,lineStrings:t,coordinate:l}),super(),this._initOptions(e);const{asynchronous:u}=e;let d;const f=[],p={};let g=[],y=0,x=[];if(u)d=Le(),Je.push({id:r.Util.GUID(),layer:i,key:e.key,center:l,data:h,lineStrings:t,baseObject:this,option:e});else{for(let t=0;t<c;t++){const n=h[t];let s=0;for(let t=0,o=n.length;t<o;t++){const o=ue(n[t]),a=r.Util.extend({},e,o),{positions:h}=ze(n[t],i,l,!1);se(h,a.bottomHeight,i,p),s+=h.length/3*2-2,x.push(ke(h))}g[t]={position:{count:s,start:y,end:y+3*s},hide:!1},y+=3*s}const t=Te(x);d=new s.BufferGeometry,a(d,"position",new s.BufferAttribute(t,3))}this._createLineSegments(d,n);const{altitude:m}=e,_=i.altitudeToVector3(m,m).x,v=i.coordinateToVector3(l,_);this.getObject3d().position.copy(v),this._baseObjects=f,this._datas=t,this._geometriesAttributes=g,this.faceIndex=null,this.index=null,this._geometryCache=d.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(f),u||(this._setPickObject3d(),this._init()),this.type="Lines"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=r.Util.extend({},this.getOptions(),{index:t},O(e)?e.properties:e.getProperties());this._baseObjects[t]=new An(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_setPickObject3d(){if(!this._colorMap)return;const t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),{_geometriesAttributes:n}=this,i=n.length,r=oe(n);let o=0;for(let t=0;t<i;t++){const i=e.getColor(),s=i.getHex();this._colorMap[s]=t;const{count:a}=n[t].position;this._datas[t].colorIndex=s;for(let t=0;t<a;t++)r[o]=i.r,r[o+1]=i.g,r[o+2]=i.b,o+=3}a(t,"color",new s.BufferAttribute(r,3,!0));const h=this.getObject3d().material.clone();h.color.set("#fff"),h.vertexColors=c();const l=e.getColor().getHex(),u=new s.LineSegments(t,h);u.position.copy(this.getObject3d().position),u._colorIndex=l,this.setPickObject3d(u)}identify(t){return this.picked}_workerLoad(t){const{position:e,geometriesAttributes:n}=t;this._geometriesAttributes=n;const i=new s.BufferGeometry;if(a(i,"position",new s.BufferAttribute(new Float32Array(e),3)),this._computeLineDistances(i),this._geometryCache=i.clone(),this.getObject3d().geometry=i,this.getObject3d().material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const di=[],fi=[];function pi(){return{waitingQueue:di,currentQueue:fi}}function gi(t,e){for(let n=0,i=t.length;n<i;n++){const i=t[n];if(i){const{key:r,callback:s}=i;if(e===r)return t.splice(n,1),s}}return null}const yi=document.createElement("canvas");let xi;function mi(t,e=!1){if(xi)return xi;const n=yi.getContext("2d");return n.clearRect(0,0,256,256),n.save(),xi=yi.toDataURL(),xi}function _i(t=1,e=1){let n;return"undefined"==typeof document||(n=document.createElement("canvas"),t&&(n.width=t),e&&(n.height=e)),n}yi.width=yi.height=256;class vi extends r.TileLayer{constructor(t,e={}){super(r.Util.GUID(),r.Util.extend({urlTemplate:t},e)),this._opts=null,this._layer=null,this.material=null,this.getMaterial=null,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._layerLaodTime=(new Date).getTime()}isAsynchronous(){return this._opts.worker}getBaseObjects(){const t=this._loadTiles,e=[];for(let n in t){const t=this._baseObjectKeys[n];if(t&&Array.isArray(t)&&t.length)for(let n=0,i=t.length;n<i;n++)e.push(t[n])}return e}onSelectMesh(t,e){}formatBaseObjects(t,e){return[]}loopMessage(t){}getTileData(t){const{key:e,url:n,callback:i,img:s}=t;r.Ajax.getJSON(n,{},(function(t,n){t?(console.error(t),i(e,null,s)):i(e,n,s)}))}_getCurentTileKeys(){const t=this.getTiles().tileGrids||[],e=[],n={};for(let i=0,r=t.length;i<r;i++){const r=t[i].tiles||[];for(let t=0,i=r.length;t<i;t++){const{id:i}=r[t];e.push(i),n[i]=!0}}return{keys:e,keysMap:n}}_isLoad(){const{keys:t}=this._getCurentTileKeys(),e=Object.keys(this._renderer.tilesInView);return t.length===e.length}_layerOnLoad(){const t=(new Date).getTime();if(t-this._layerLaodTime<20)return;this._layerLaodTime=t;const e=this._renderer.tilesInView,n=this._loadTiles,i=this._layer,r=this._baseObjectKeys,s=Object.keys(e).length,o=Object.keys(n).length,a=[];if(s&&o)for(let t in n)e[t]||r[t]&&(r[t]||[]).forEach((t=>{a.push(t)}));if(a.length&&i.removeMesh(a,!1),s&&o)for(let t in e)if(!n[t])if(r[t]){const e=r[t];i.addMesh(e)}else{const{x:e,y:n,z:i}=this._getXYZOfIndex(t);this.getTileUrl(e,n,i)}this._loadTiles=Object.assign({},e),this._diffCache()}_init(){}_workerLoad(t){const e=t.target._img;e.currentCount++,e.currentCount===e.needCount&&(e.src=mi(e._key,this._opts.debug))}_generateBaseObjects(t,e,n){if(e&&n){const{keysMap:i}=this._getCurentTileKeys();if(!i[t])return void(n.src=mi(0,this._opts.debug));const r=this.formatBaseObjects(t,e);if(r.length){n.needCount=r.length,n.currentCount=0;for(let e=0,i=r.length;e<i;e++){const i=r[e];i._img=n,i._vt=this,this.isVisible()||i.hide(),this._cachetile(t,i),i.isAsynchronous()||n.currentCount++}this._layer.addMesh(r,!1),n.needCount===n.currentCount&&(n.src=mi(0,this._opts.debug)),this.isAsynchronous()?r.filter((t=>t.isAsynchronous())).forEach((t=>{t.on("workerload",this._workerLoad,this)})):n.src=mi(0,this._opts.debug)}else n.src=mi(0,this._opts.debug);this._loadTiles[t]=!0}else n&&(n.src=mi(0,this._opts.debug))}_diffCache(){if(Object.keys(this._baseObjectKeys).length>this._renderer.tileCache.max){const t=this._renderer.tileCache.data,e=this._renderer.tilesInView,n=[];for(let i in this._baseObjectKeys)t[i]||e[i]||((this._baseObjectKeys[i]||[]).forEach((t=>{t.isAdd&&n.push(t)})),this._diposeBaseObject(i),delete this._baseObjectKeys[i]);n.length&&this._layer.removeMesh(n,!1)}}_diposeBaseObject(t){const e=this._baseObjectKeys[t];e&&e.length&&e.forEach((t=>{t.getObject3d().geometry.dispose(),t._geometryCache&&t._geometryCache.dispose();const e=t._baseObjects;e&&e.length&&e.forEach((t=>{t.getObject3d().geometry.dispose(),t=null})),t._datas=null,t._geometriesAttributes=null,t._faceMap=null,t._colorMap=null,t.pickObject3d&&t.pickObject3d.geometry.dispose(),t=null}))}_cachetile(t,e){this._baseObjectKeys[t]||(this._baseObjectKeys[t]=[]),this._baseObjectKeys[t].push(e)}_getXYZOfIndex(t){const e=t.indexOf("_")>-1?"_":"-";let[n,i,r]=t.split(e).slice(1,4);return{x:parseInt(i),y:parseInt(n),z:parseInt(r)}}_getTileExtent(t,e,n){const i=this.getMap()._getResolution(n);return this._getTileConfig().getTilePrjExtent(t,e,i)}_getTileLngLatExtent(t,e,n){const i=this._getTileExtent(t,e,n);let s=i.getMax(),o=i.getMin();const a=this.getMap().getProjection();return o=a.unproject(o),s=a.unproject(s),new r.Extent(o,s)}}const bi={worker:!1};class wi extends vi{constructor(t,e={},n,i){super(r.Util.GUID(),r.Util.extend({urlTemplate:t},bi,e)),this._opts=e,this._layer=i,this.getMaterial=n,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._layerLaodTime=(new Date).getTime(),this._init()}formatBaseObjects(t,e){const n=this._opts,i=[],o=this.isAsynchronous();for(let a in e){const h=e[a]||{};let c;if(Array.isArray(h)?c=h:"FeatureCollection"===h.type&&(c=h.features),c&&c.length){const e=[],l=[],u=[];for(let t=0,n=c.length;t<n;t++){const n=c[t];if(z(n))e.push(n);else if(O(n)){const t=k(n);for(let e=0,n=t.length;e<n;e++)l.push(t[e])}else if(A(n)){const t=k(n);for(let e=0,n=t.length;e<n;e++)u.push(r.Util.extend({},t[e].properties,t[e],{coordinate:j(t[e])}))}}if(e.length){const s=this._getMaterial(a,e,t,h);if(s){const h=this._layer.toExtrudePolygons(e,r.Util.extend({},{topColor:"#fff",layerName:a,asynchronous:o,key:t},n),s);i.push(h)}}if(l.length){const e=this._getMaterial(a,l,t,h);if(e&&(e instanceof s.LineBasicMaterial||e instanceof s.LineDashedMaterial)){const t=this._layer.toLines(l,r.Util.extend({},{layerName:a,asynchronous:o},n),e);i.push(t)}}if(u.length){const e=this._getMaterial(a,u,t,h);if(e&&e instanceof s.PointsMaterial){const t=this._layer.toPoints(u,r.Util.extend({},{layerName:a,asynchronous:o},n),e);i.push(t)}}}}return i}loopMessage(t){const{currentQueue:e}=pi();e.length>0&&this.getTileData(t)}_init(){this.on("layerload",this._layerOnLoad),this.on("add",(()=>{if(!1===this._add){const t=this.getBaseObjects();this._layer.addMesh(t)}this._add=!0,this.intervalId=setInterval((()=>{this._isLoad()&&!this._layer.getMap().isInteracting()&&this.fire("layerload")}),1e3)})),this.on("remove",(()=>{this._add=!1;const t=this.getBaseObjects();this._layer.removeMesh(t),clearInterval(this.intervalId)})),this.on("show",(()=>{this.getBaseObjects().forEach((t=>{t.show()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.show()}))}})),this.on("hide",(()=>{this.getBaseObjects().forEach((t=>{t.hide()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.hide()}))}})),this.on("renderercreate",(t=>{t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.id),n},t.renderer.deleteTile=function(t){if(!t||!t.image)return;t.image.onload=null,t.image.onerror=null;!function(t){const e=gi(di,t);e&&e(t)}((t.info||{}).id)},t.renderer.loadTileImage=(t,e,n)=>{t._key=n,function(t,e,n,i,r){const s={key:t,url:e,callback:n,img:i,vt:r};fi.length<10?(fi.push(s),r.loopMessage(s)):di.push(s)}(n,e,((t,e,n)=>{this._generateBaseObjects(t,e,n),function(t,e){if(gi(fi,t),di.length){fi.push(di[0]),di.splice(0,1);const t=fi[fi.length-1];e.loopMessage(t)}}(t,this)}),t,this)}}))}_getMaterial(t,e,n,i){return this.getMaterial&&r.Util.isFunction(this.getMaterial)?this.getMaterial(t,e,n,i):null}}function Mi(t,e,n,i){const{position:r,uv:o,normal:h,indexs:c}=function(t,e,n,i){const r=t/n,s=e/i,o=-t/2,a=e/2,h=-e/2,c=(n+1)*(i+1),l=new Float32Array(3*c),u=new Float32Array(2*c),d=new Float32Array(3*c),f=new Uint32Array(10*c);let p=0,g=0,y=0;for(let c=0;c<=i;c++)for(let x=0;x<=n;x++){const m=o+r*x,_=a-s*c;l[p]=m,l[p+1]=_,l[p+2]=0,d[p]=0,d[p+1]=0,d[p+2]=1;const v=(m-o)/t,b=(_-h)/e;if(u[g]=v,u[g+1]=b,p+=3,g+=2,x<n&&c<i){const t=c*(n+1)+x,e=t+1,i=(n+1)*(c+1)+x,r=i+1;f[y]=t,f[y+1]=i,f[y+2]=e,f[y+3]=i,f[y+4]=r,f[y+5]=e,y+=6}}const x=new Uint32Array(y);for(let t=0,e=x.length;t<e;t++)x[t]=f[t];return{position:l,uv:u,normal:d,indexs:x}}(t,e,n,i),l=new s.BufferGeometry;return a(l,"position",new s.BufferAttribute(r,3)),a(l,"normal",new s.BufferAttribute(h,3)),a(l,"uv",new s.BufferAttribute(o,2)),l.setIndex(new s.BufferAttribute(c,1)),l}const zi=new s.TextureLoader,Oi=document.createElement("canvas");function Ai(t){if(!t)return null;let e;return"string"==typeof t?(e=new Image,e.src=t):t instanceof HTMLCanvasElement?(e=new Image,e.src=t.toDataURL()):t instanceof Image&&(e=new Image,e.src=t.src,e.crossOrigin=t.crossOrigin),e&&!e.crossOrigin&&(e.crossOrigin="Anonymous"),e}const Si=new Map;function ji(t,e,n,i){if(!e||!n)return;const{imageWidth:r,imageHeight:o,flaserBoundary:a}=i;let h;if(h=t instanceof Uint32Array||t instanceof Uint8ClampedArray?t:function(t,e=256,n=256){Oi.width=e,Oi.height=n;const i=Oi.getContext("2d");return i.drawImage(t,0,0,e,n),i.getImageData(0,0,e,n).data}(t,r,o),!h)return void console.error("image is error type data",t);let c=0,l=0,u=0;const d=new s.Vector3,f=Si;for(let t=0,i=h.length;t<i;t+=4){const i=.1*(256*h[t]*256+256*h[t+1]+h[t+2])-1e4;let s=0;if(0!==l&&l+1!==o&&0!==u&&u+1!==r||!a){const t=f.get(i);void 0!==t?s=t:(s=n.altitudeToVector3(i,i,null,d).x,f.set(i,s))}e.attributes.position.array[3*c+2]=s,c++,u++,u===r&&(l++,u=0)}e.attributes.position.needsUpdate=!0}const Ci={interactive:!1,altitude:0,image:null,imageWidth:256,imageHeight:256,texture:null,flaserBoundary:!0,bufferPixel:1};class ki extends v{constructor(t,e,n,i){e=r.Util.extend({},Ci,e,{layer:i,extent:t});const{texture:s,image:o,altitude:a,imageHeight:h,imageWidth:c,flaserBoundary:l,bufferPixel:u}=e;t instanceof r.Extent||(t=new r.Extent(t));const{xmin:d,ymin:f,xmax:p,ymax:g}=t;let y=1/0,x=1/0,m=-1/0,_=-1/0;[[d,f],[d,g],[p,g],[p,f]].forEach((t=>{const e=i.coordinateToVector3(t),{x:n,y:r}=e;y=Math.min(n,y),x=Math.min(r,x),m=Math.max(n,m),_=Math.max(r,_)}));const v=(m-y)/c,b=(_-x)/h;y-=v*u,m+=v*u,x-=b*u,_+=b*u;const w=Math.abs(m-y),M=Math.abs(_-x),z=Ai(o),O=Ai(s),A=Mi(w,M,c-1,h-1);super(),this._initOptions(e),this._createMesh(A,n);const S=i.altitudeToVector3(a,a).x,j=i.coordinateToVector3(t.getCenter(),S);this.getObject3d().position.copy(j),n.transparent=!0,z&&(z.onload=()=>{ji(z,A,i,{imageWidth:c,imageHeight:h,flaserBoundary:l}),this.fire("dataload",{})},z.onerror=t=>{console.error(t),console.error(`can not  load terrain data: ${z.src}`),this.fire("dataerror",{image:z,error:t,url:z.src})}),O?(n.opacity=0,zi.load(O.src,(t=>{n.map=t,n.opacity=1,n.needsUpdate=!0,this.fire("textureload",{})}),(()=>{}),(t=>{console.error(t),console.error(`can not load terrain texture ${O.src}`,t),this.fire("textureerror",{image:O,error:t,url:O.src})}))):n.opacity=1,this.type="Terrain"}updateData(t){return ji(t,this.getObject3d().geometry,this.getLayer(),this.getOptions()),this.fire("updatedata",{}),this}}const Ti={scale:1,tileDivisor:4};class Pi extends vi{constructor(t,e={},n,i){super(r.Util.GUID(),r.Util.extend({urlTemplate:t},Ti,e)),this._opts=e,this._layer=i,this.material=n,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._imgQueue={},this._layerLaodTime=(new Date).getTime(),this._init()}isAsynchronous(){return!1}formatBaseObjects(t,e){const n=this.options,i=[],{scale:r,tileDivisor:s}=n,{x:o,y:a,z:h}=this._getXYZOfIndex(t),c=this.getMap().getZoom(),l=this.getTileUrl(o,a,h),[u,d]=this.options.tileSize,f=this._getTileLngLatExtent(o,a,h),p=this.material.clone();if(h+1>=Math.round(c)){const t=new ki(f,{image:e,imageWidth:u/s,imageHeight:d/s,texture:l},p,this._layer);t.getObject3d().scale.set(r,r,1),i.push(t)}return i}loopMessage(t){this.getTileData(t)}_init(){this.on("layerload",this._layerOnLoad),this.on("add",(()=>{if(!1===this._add){const t=this.getBaseObjects();this._layer.addMesh(t)}this._add=!0,this.intervalId=setInterval((()=>{this._isLoad()&&!this._layer.getMap().isInteracting()&&this.fire("layerload")}),1e3)})),this.on("remove",(()=>{this._add=!1;const t=this.getBaseObjects();this._layer.removeMesh(t),clearInterval(this.intervalId)})),this.on("show",(()=>{this.getBaseObjects().forEach((t=>{t.show()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.show()}))}})),this.on("hide",(()=>{this.getBaseObjects().forEach((t=>{t.hide()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.hide()}))}})),this.on("renderercreate",(t=>{t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.id),n},t.renderer.deleteTile=t=>{if(!t||!t.image)return;t.image.onload=null,t.image.onerror=null;const e=t.info||{},n=this._imgQueue[e.id];n&&(n.src="",n.onload=null,n.onerror=null,delete this._imgQueue[e.id])},t.renderer.loadTileImage=(t,e,n)=>{t._key=n;const i=new Image;this._imgQueue[n]=i;const r={key:n,url:e,rgbImage:i,callback:(t,e,n)=>{this._generateBaseObjects(t,e,n)},img:t,vt:this};this.loopMessage(r)}}))}}
/*!
     * Code from baidu mapv
     * License: BSD-3
     * https://github.com/huiyan-fe/mapv
     *
     */function Vi(t){t=t||{},this.gradient=t.gradient||{.25:"rgba(0, 0, 255, 1)",.55:"rgba(0, 255, 0, 1)",.85:"rgba(255, 255, 0, 1)",1:"rgba(255, 0, 0, 1)"},this.maxSize=t.maxSize||35,this.minSize=t.minSize||0,this.max=t.max||100,this.min=t.min||0,this.initPalette()}function Li(t,e,n){var i=Bi(n),r=function(t){return t.min||0}(n),s=i-r,o=n.range||null,a=0,h=1024;o&&2===o.length&&(a=(o[0]-r)/s*1024),o&&2===o.length&&(h=(o[1]-r)/s*1024);for(var c,l=n.maxOpacity||.8,u=n.minOpacity||0,d=3,f=t.length;d<f;d+=4)c=4*t[d],t[d]/256>l&&(t[d]=256*l),t[d]/256<u&&(t[d]=256*u),c&&c>=a&&c<=h?(t[d-3]=e[c],t[d-2]=e[c+1],t[d-1]=e[c+2]):t[d]=0}function Bi(t){return t.max||100}function Ui(t,e,n){var i=Bi(n),r=
/*!
     * Code from baidu mapv
     * License: BSD-3
     * https://github.com/huiyan-fe/mapv
     *
     */
function(t){var e=t/2,n=t+e,i=1e4,r=_i(2*n,2*n),s=r.getContext("2d");return s.shadowBlur=e,s.shadowColor="black",s.shadowOffsetX=s.shadowOffsetY=i,s.beginPath(),s.arc(n-i,n-i,t,0,2*Math.PI,!0),s.closePath(),s.fill(),r}(n._size||n.size||13),s=r.width/2,o=r.height/2,a=e,h={};for(var c in a.forEach((function(t){var e=void 0===t.count?1:t.count,n=Math.min(1,e/i).toFixed(2);h[n]=h[n]||[],h[n].push(t)})),h)if(!isNaN(c)){var l=h[c];t.beginPath(),n.withoutAlpha||(t.globalAlpha=c),l.forEach((function(e){var n=e.coordinate,a=void 0===e.count?1:e.count;t.globalAlpha=a/i,t.drawImage(r,n[0]-s,n[1]-o)}))}}Vi.prototype.setMax=function(t){this.max=t||100},Vi.prototype.setMin=function(t){this.min=t||0},Vi.prototype.setMaxSize=function(t){this.maxSize=t||35},Vi.prototype.setMinSize=function(t){this.minSize=t||0},Vi.prototype.initPalette=function(){var t=this.gradient,e=_i(256,1),n=this.paletteCtx=e.getContext("2d"),i=n.createLinearGradient(0,0,256,1);for(var r in t)i.addColorStop(parseFloat(r),t[r]);n.fillStyle=i,n.fillRect(0,0,256,1)},Vi.prototype.getColor=function(t){var e=this.getImageData(t);return"rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]/256+")"},Vi.prototype.getImageData=function(t){var e=this.paletteCtx.getImageData(0,0,256,1).data;if(void 0===t)return e;var n=this.max,i=this.min;t>n&&(t=n),t<i&&(t=i);var r=4*Math.floor((t-i)/(n-i)*255);return[e[r],e[r+1],e[r+2],e[r+3]]},Vi.prototype.getSize=function(t){var e=this.max,n=this.min,i=this.maxSize,r=this.minSize;return t>e&&(t=e),t<n&&(t=n),e>n?r+(t-n)/(e-n)*(i-r):i},Vi.prototype.getLegend=function(t){var e=this.gradient,n=t.width||20,i=t.height||180,r=_i(n,i),s=r.getContext("2d"),o=s.createLinearGradient(0,i,0,0);for(var a in e)o.addColorStop(parseFloat(a),e[a]);return s.fillStyle=o,s.fillRect(0,0,n,i),r};var Ei={draw:function(t,e,n){if(!(t.canvas.width<=0||t.canvas.height<=0)){var i=n.strength||.3;t.strokeStyle="rgba(0,0,0,"+i+")";var r=_i(t.canvas.width,t.canvas.height),s=r.getContext("2d");s.scale(devicePixelRatio,devicePixelRatio),n=n||{},t.save();var o=new Vi({gradient:n.gradient});if(Ui(s,e,n),!n.absolute){var a=s.getImageData(0,0,t.canvas.width,t.canvas.height);Li(a.data,o.getImageData(),n),t.putImageData(a,0,0),t.restore()}o=null,r=null}},drawGray:Ui,colorize:Li};const Ii={altitude:0,interactive:!1,min:0,max:100,size:13,gradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},gridScale:.5},Fi=2048;class Ri extends v{constructor(t,e,n,i){Array.isArray(t)||(t=[t]);let o=1/0,h=1/0,l=-1/0,u=-1/0;const d=[];for(let e=0,n=t.length;e<n;e++){const{coordinate:n,lnglat:r,xy:s}=t[e],a=n||r||s;if(!a){console.warn("not find coordinate");continue}const c=i.coordinateToVector3(a);d.push(c);const{x:f,y:p}=c;o=Math.min(o,f),h=Math.min(h,p),l=Math.max(l,f),u=Math.max(u,p)}e=r.Util.extend({},Ii,e,{layer:i,points:t});let{gridScale:f,altitude:p,size:g}=e;const y=Math.abs(l-o),x=Math.abs(u-h),m=Math.max(y*f,x*f);if(m>Fi){console.warn(`gridScale: ${f} it's too big. I hope it's a smaller value,canvas max size is 2048* 2048`);f=Fi/(m/f)}let _=Math.ceil(y*f),v=Math.ceil(x*f);const b=_/y,w=v/x,M=[],z=Math.ceil(2*g);for(let e=0,n=d.length;e<n;e++){const n=d[e];n.x-=o,n.y-=h,n.x*=b,n.y*=w,n.y=v-n.y,n.x+=z,n.y+=z,M.push({coordinate:[n.x,n.y],count:t[e].count})}_+=2*z,v+=2*z;let O=_i(_,v),A=O.getContext("2d");Ei.drawGray(A,M,e);const S=A.getImageData(0,0,A.canvas.width,A.canvas.height);let j=-1/0;const C=new Float32Array(S.data.length/4),k=new Float32Array(S.data.length/4);for(let t=3,e=S.data.length,n=0;t<e;t+=4){const e=S.data[t];j=Math.max(j,e),k[n]=e,e<=0&&(C[n]=1),n++}const T=new Vi({gradient:e.gradient});Ei.colorize(S.data,T.getImageData(),e),O=null,A=null;const P=Mi(y,x,_-1,v-1),V=P.getIndex().array,L=P.attributes.position.array,B=new Float32Array(L.length),U=new Uint32Array(6*L.length),E=new s.Color;let I=0;for(let t=0,e=L.length,n=0,i=V.length,r=0,s=S.data.length,o=0;t<Math.max(e,i,s);t+=3){if(t<e){const e=k[o];e>0&&(L[t+2]=e/j)}if(n<i){const t=V[n],e=V[n+1],i=V[n+2];C[t]&&C[e]&&C[i]||(U[I]=t,U[I+1]=e,U[I+2]=i,I+=3)}if(r<s){const t=`rgb(${S.data[r]},${S.data[r+1]},${S.data[r+2]})`;E.setStyle(t),B[n]=E.r,B[n+1]=E.g,B[n+2]=E.b}n+=3,r+=4,o++}const F=new Uint32Array(I);for(let t=0;t<I;t++)F[t]=U[t];P.setIndex(new s.BufferAttribute(F,1)),a(P,"color",new s.BufferAttribute(B,3,!0)),n.vertexColors=c(),super(),this._initOptions(e),this._createMesh(P,n);const R=i.altitudeToVector3(p,p).x;this.getObject3d().position.copy(new s.Vector3((o+l)/2,(h+u)/2,R)),this.type="HeatMap"}}const Gi=new s.Color;let Zi=1;class Qi{constructor(t){this.object3ds=[],this.layer=t,this.camera=t.getCamera(),this.renderer=t.getThreeRenderer(),this.pickingTexture=o>=152?new s.WebGLRenderTarget(1,1,{format:s.RGBAFormat,colorSpace:s.SRGBColorSpace}):new s.WebGLRenderTarget(1,1,{}),this.pickingScene=new s.Scene}getColor(){return Gi.setHex(Zi),Zi++,Gi}add(t){if(t){const e=t._colorIndex;e&&(this.object3ds[e]=t,this.pickingScene.add(t))}return this}remove(t){if(t){const e=t._colorIndex;e&&(this.object3ds[e]=null,this.pickingScene.remove(t))}return this}isEmpty(){if(0===this.pickingScene.children.length)return!0;for(let t=0,e=this.pickingScene.children.length;t<e;t++){const e=this.pickingScene.children[t];if(e){const t=e.__parent;if(t&&!0===t.getOptions().interactive)return!1}}return!0}pick(t){if(!t)return;if(this.isEmpty())return;const{camera:e,renderer:n,pickingTexture:i,pickingScene:r,object3ds:s,layer:o}=this,a=this.pickingScene.children.length;for(let t=0;t<a;t++){const e=this.pickingScene.children[t];e&&e.__parent&&(e.__parent.picked=!1)}const{width:h,height:c}=o._getRenderer().canvas,l=i.width,u=i.height;h===l&&c===u||i.setSize(h,c),n.setRenderTarget(i),n.clear(),e&&e.layers&&this.camera.layers.set(0),n.render(r,e);const d=new Uint8Array(4),{x:f,y:p}=t;let g=window.devicePixelRatio;const y=o.getMap();y&&(g=y.getDevicePixelRatio?y.getDevicePixelRatio():y.options.devicePixelRatio);const x=f*g,m=i.height-p*g;n.readRenderTargetPixels(i,Math.round(x),Math.round(m),1,1,d);const _=d[0]<<16|d[1]<<8|d[2],v=s[_];if(v)v.__parent&&(s[_].__parent.picked=!0);else for(let t=0;t<a;t++){const e=this.pickingScene.children[t];if(e&&e.__parent){const t=e.__parent;if(t._colorMap&&null!=t._colorMap[_]){t.picked=!0,t.index=t._colorMap[_];break}}}n.setRenderTarget(null)}}const Di={bottomHeight:0,altitude:0};class Hi extends v{constructor(t,e,n,i){e=r.Util.extend({},Di,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{asynchronous:s}=e,{lineStrings:o,center:a}=Ce(t),h=new y;let c;if(s){const e=r.Util.GUID();this.getOptions().id=e,this.getOptions().center=a,$e.push({id:e,data:o,lineString:t,center:a,layer:i,baseObject:this})}else{const t=[],n={};for(let r=0,s=o.length;r<s;r++){const s=ze(o[r],i,a,!1).positions;se(s,e.bottomHeight,i,n),t.push(ke(s))}c=Te(t),h.setPositions(c)}this._setMaterialRes(i,n),this._createLine2(h,n);const{altitude:l}=e,u=i.altitudeToVector3(l,l).x,d=i.coordinateToVector3(a,u);this.getObject3d().position.copy(d),s||(this._setPickObject3d(c,n.linewidth),this._init()),this.type="FatLine"}_init(){const t=this.getLayer().getPick();this.on("add",(()=>{t.add(this.pickObject3d)})),this.on("remove",(()=>{t.remove(this.pickObject3d)}))}_setMaterialRes(t,e){const n=t.getMap();if(!n)return this;const i=n.getSize(),r=i.width,s=i.height;e.resolution.set(r,s)}_setPickObject3d(t,e){const n=new y;n.setPositions(t);const i=this.getLayer().getPick().getColor(),r=[];for(let e=0,n=t.length/3;e<n;e++)r.push(i.r,i.g,i.b);n.setColors(r);const s=new p({color:"#fff",linewidth:e,vertexColors:c()});this._setMaterialRes(this.getLayer(),s);const o=i.getHex(),a=new x(n,s);a.position.copy(this.getObject3d().position),a._colorIndex=o,this.setPickObject3d(a)}identify(t){return this.picked}setSymbol(t){if(t&&t instanceof s.Material){t.needsUpdate=!0;const e=this.getMap().getSize(),n=e.width,i=e.height;t.resolution.set(n,i),this.getObject3d().material=t}return this}_workerLoad(t){const e=new Float32Array(t.position),n=this.getObject3d();if(n.geometry.setPositions(e),n.computeLineDistances(),this._setPickObject3d(e,n.material.linewidth),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}_animation(){const t=this.getLayer();if(!t)return this;[this.getObject3d(),this.getPickObject3d()].forEach((e=>{e&&this._setMaterialRes(t,e.material)}))}}const Wi={altitude:0,colors:null};class qi extends(Hn(v)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const s=[],o=[],a=t.length;for(let e=0;e<a;e++){const n=Ce(t[e]);s.push(n.center),o.push(n.lineStrings)}const h=re(s);e=r.Util.extend({},Wi,e,{layer:i,lineStrings:t,coordinate:h}),super(),this._initOptions(e);const{asynchronous:c}=e,l=new y,u=[],d={};let f,p,g=[],x=0,m=[];if(c)tn.push({id:r.Util.GUID(),data:o,key:e.key,center:h,layer:i,baseObject:this,lineStrings:t,option:e});else{for(let t=0;t<a;t++){const n=o[t];let s=0;for(let t=0,o=n.length;t<o;t++){const o=ue(n[t]),a=r.Util.extend({},e,o),{positions:c}=ze(n[t],i,h,!1);se(c,a.bottomHeight,i,d),s+=c.length/3*2-2,m.push(ke(c))}g[t]={position:{count:s,start:x,end:x+3*s},instanceStart:{count:s,start:x,end:x+3*s},instanceEnd:{count:s,start:x,end:x+3*s},hide:!1},x+=3*s}f=Te(m),l.setPositions(f)}this._setMaterialRes(i,n),this._createLine2(l,n);const{altitude:_}=e,v=i.altitudeToVector3(_,_).x,b=i.coordinateToVector3(h,v);this.getObject3d().position.copy(b),this._baseObjects=u,this._datas=t,this._geometriesAttributes=g,this.faceIndex=null,this.index=null,this._geometryCache=new y,c||(p=new Float32Array(f),this._geometryCache.setPositions(p)),this._colorMap={},this.isHide=!1,this._initBaseObjectsEvent(u),c||(this._setPickObject3d(p,n.linewidth),this._init()),this.type="FatLines"}_setMaterialRes(t,e){const n=t.getMap();if(!n)return this;const i=n.getSize(),r=i.width,s=i.height;e.resolution.set(r,s)}_setPickObject3d(t,e){if(!this._colorMap)return;const n=this._geometryCache||new y;n.setPositions(t);const i=this.getLayer().getPick(),{_geometriesAttributes:r}=this,s=oe(r);let o=0;for(let t=0,e=r.length;t<e;t++){const e=i.getColor(),n=e.getHex();this._colorMap[n]=t;const{count:a}=r[t].position;this._datas[t].colorIndex=n;for(let t=0;t<a;t++)s[o]=e.r,s[o+1]=e.g,s[o+2]=e.b,o+=3}n.setColors(s);const a=new p({color:"#fff",linewidth:e,vertexColors:c()});this._setMaterialRes(this.getLayer(),a);const h=i.getColor().getHex(),l=new x(n,a);l.position.copy(this.getObject3d().position),l._colorIndex=h,this.setPickObject3d(l)}identify(t){return this.picked}setSymbol(t){if(t&&t instanceof s.Material){t.needsUpdate=!0;const e=this.getMap().getSize(),n=e.width,i=e.height;t.resolution.set(n,i),this.getObject3d().material=t}return this}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=r.Util.extend({},this.getOptions(),{index:t},O(e)?e.properties:e.getProperties());this._baseObjects[t]=new Hi(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_updateAttribute(t,e){const{indexs:n}=this._getHideGeometryIndex(e),i=this._geometryCache.attributes[e].array,r=i.length;for(let e=0;e<r;e++)t.array[e]=i[e];for(let i=0;i<n.length;i++){const r=n[i],{start:s,end:o}=this._geometriesAttributes[r][e];for(let e=s;e<o;e++)t.array[e]=-1e5}return this}_showGeometry(t,e){let n;if(t&&(n=t.getOptions().index),null!=n){const t=this._geometriesAttributes[n],{hide:i}=t;if(i===e)return this;t.hide=e;const r=this.getObject3d().geometry;this._updateAttribute(r.attributes.instanceStart,"instanceStart"),this._updateAttribute(r.attributes.instanceEnd,"instanceEnd"),r.attributes.instanceStart.data.needsUpdate=!0,r.attributes.instanceEnd.data.needsUpdate=!0,this.isHide=e}return this}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=this.getObject3d(),i=new Float32Array(t.position),r=new Float32Array(i);if(n.geometry.setPositions(new Float32Array(i)),n.computeLineDistances(),this._geometryCache.setPositions(r),this._setPickObject3d(r,n.material.linewidth),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}_animation(){const t=this.getLayer();if(!t)return this;[this.getObject3d(),this.getPickObject3d()].forEach((e=>{e&&this._setMaterialRes(t,e.material)}))}}const Ni={radius:10,height:100,altitude:0,topColor:"",bottomColor:"#2d2f61",heightEnable:!0};class Xi extends v{constructor(t,e,n,i){e=r.Util.extend({},Ni,e,{layer:i,coordinate:t}),super(),this._initOptions(e);const{height:s,radius:o,topColor:a,bottomColor:h,altitude:l}=e,u=i.altitudeToVector3(s,s).x,d=i.distanceToVector3(o,o).x,f=bn().clone();f.scale(2*d,2*d,u),a&&(_n(f,h,a,"z",u/2),n.vertexColors=c()),this._createMesh(f,n);const p=i.altitudeToVector3(l,l).x,g=i.coordinateToVector3(t,p);this.getObject3d().position.copy(g),this.type="Box"}}const Ki={radius:10,height:100,altitude:0,topColor:null,bottomColor:"#2d2f61"};class Yi extends(Hn(v)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const s=t.length,o=re(t),a=i.coordinateToVector3(o),h=[],l=[],u=[];let d=0;e=r.Util.extend({},{altitude:0,layer:i,points:t},Ki,e);const f={},p={};for(let o=0;o<s;o++){const s=r.Util.extend({index:o},e,t[o]),{radius:g,altitude:y,topColor:x,bottomColor:m,height:_,coordinate:v}=s,b=ne(g,i,f),w=ie(_,i,p),M=ie(y,i,p),z=bn().clone();z.scale(2*b,2*b,w),x&&(_n(z,m,x,"z",w/2),n.vertexColors=c());const O=i.coordinateToVector3(v).sub(a),A=z.attributes.position.array;for(let t=0,e=A.length;t<e;t+=3)A[t+2]+=M,A[t]+=O.x,A[t+1]+=O.y,A[t+2]+=O.z;h.push(z);const S=new Xi(v,s,n,i);l.push(S),z.index.count;const j=z.attributes.position.count;z.attributes.normal.count,z.attributes.uv.count,u[o]={position:{count:j,start:d,end:d+3*j},hide:!1},d+=3*j}super(),this._initOptions(e);const g=vn(h);this._createMesh(g,n);const y=e.altitude,x=i.altitudeToVector3(y,y).x,m=a.clone();m.z=x,this.getObject3d().position.copy(m),this._baseObjects=l,this._datas=t,this._geometriesAttributes=u,this.faceIndex=null,this._geometryCache=un(g),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(l),this._setPickObject3d(),this._init(),this.type="Boxs"}identify(t){return this.picked}}var Ji={exports:{}};function $i(t,e,n){n=n||2;var i,r,s,o,a,h,c,l=e&&e.length,u=l?e[0]*n:t.length,d=tr(t,0,u,n,!0),f=[];if(!d||d.next===d.prev)return f;if(l&&(d=function(t,e,n,i){var r,s,o,a=[];for(r=0,s=e.length;r<s;r++)(o=tr(t,e[r]*i,r<s-1?e[r+1]*i:t.length,i,!1))===o.next&&(o.steiner=!0),a.push(ur(o));for(a.sort(ar),r=0;r<a.length;r++)n=er(n=hr(a[r],n),n.next);return n}(t,e,d,n)),t.length>80*n){i=s=t[0],r=o=t[1];for(var p=n;p<u;p+=n)(a=t[p])<i&&(i=a),(h=t[p+1])<r&&(r=h),a>s&&(s=a),h>o&&(o=h);c=0!==(c=Math.max(s-i,o-r))?1/c:0}return nr(d,f,n,i,r,c),f}function tr(t,e,n,i,r){var s,o;if(r===zr(t,e,n,i)>0)for(s=e;s<n;s+=i)o=br(s,t[s],t[s+1],o);else for(s=n-i;s>=e;s-=i)o=br(s,t[s],t[s+1],o);return o&&gr(o,o.next)&&(wr(o),o=o.next),o}function er(t,e){if(!t)return t;e||(e=t);var n,i=t;do{if(n=!1,i.steiner||!gr(i,i.next)&&0!==pr(i.prev,i,i.next))i=i.next;else{if(wr(i),(i=e=i.prev)===i.next)break;n=!0}}while(n||i!==e);return e}function nr(t,e,n,i,r,s,o){if(t){!o&&s&&function(t,e,n,i){var r=t;do{null===r.z&&(r.z=lr(r.x,r.y,e,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e,n,i,r,s,o,a,h,c=1;do{for(n=t,t=null,s=null,o=0;n;){for(o++,i=n,a=0,e=0;e<c&&(a++,i=i.nextZ);e++);for(h=c;a>0||h>0&&i;)0!==a&&(0===h||!i||n.z<=i.z)?(r=n,n=n.nextZ,a--):(r=i,i=i.nextZ,h--),s?s.nextZ=r:t=r,r.prevZ=s,s=r;n=i}s.nextZ=null,c*=2}while(o>1)}(r)}(t,i,r,s);for(var a,h,c=t;t.prev!==t.next;)if(a=t.prev,h=t.next,s?rr(t,i,r,s):ir(t))e.push(a.i/n),e.push(t.i/n),e.push(h.i/n),wr(t),t=h.next,c=h.next;else if((t=h)===c){o?1===o?nr(t=sr(er(t),e,n),e,n,i,r,s,2):2===o&&or(t,e,n,i,r,s):nr(er(t),e,n,i,r,s,1);break}}}function ir(t){var e=t.prev,n=t,i=t.next;if(pr(e,n,i)>=0)return!1;for(var r=t.next.next;r!==t.prev;){if(dr(e.x,e.y,n.x,n.y,i.x,i.y,r.x,r.y)&&pr(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function rr(t,e,n,i){var r=t.prev,s=t,o=t.next;if(pr(r,s,o)>=0)return!1;for(var a=r.x<s.x?r.x<o.x?r.x:o.x:s.x<o.x?s.x:o.x,h=r.y<s.y?r.y<o.y?r.y:o.y:s.y<o.y?s.y:o.y,c=r.x>s.x?r.x>o.x?r.x:o.x:s.x>o.x?s.x:o.x,l=r.y>s.y?r.y>o.y?r.y:o.y:s.y>o.y?s.y:o.y,u=lr(a,h,e,n,i),d=lr(c,l,e,n,i),f=t.prevZ,p=t.nextZ;f&&f.z>=u&&p&&p.z<=d;){if(f!==t.prev&&f!==t.next&&dr(r.x,r.y,s.x,s.y,o.x,o.y,f.x,f.y)&&pr(f.prev,f,f.next)>=0)return!1;if(f=f.prevZ,p!==t.prev&&p!==t.next&&dr(r.x,r.y,s.x,s.y,o.x,o.y,p.x,p.y)&&pr(p.prev,p,p.next)>=0)return!1;p=p.nextZ}for(;f&&f.z>=u;){if(f!==t.prev&&f!==t.next&&dr(r.x,r.y,s.x,s.y,o.x,o.y,f.x,f.y)&&pr(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;p&&p.z<=d;){if(p!==t.prev&&p!==t.next&&dr(r.x,r.y,s.x,s.y,o.x,o.y,p.x,p.y)&&pr(p.prev,p,p.next)>=0)return!1;p=p.nextZ}return!0}function sr(t,e,n){var i=t;do{var r=i.prev,s=i.next.next;!gr(r,s)&&yr(r,i,i.next,s)&&_r(r,s)&&_r(s,r)&&(e.push(r.i/n),e.push(i.i/n),e.push(s.i/n),wr(i),wr(i.next),i=t=s),i=i.next}while(i!==t);return er(i)}function or(t,e,n,i,r,s){var o=t;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&fr(o,a)){var h=vr(o,a);return o=er(o,o.next),h=er(h,h.next),nr(o,e,n,i,r,s),void nr(h,e,n,i,r,s)}a=a.next}o=o.next}while(o!==t)}function ar(t,e){return t.x-e.x}function hr(t,e){var n=function(t,e){var n,i=e,r=t.x,s=t.y,o=-1/0;do{if(s<=i.y&&s>=i.next.y&&i.next.y!==i.y){var a=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(a<=r&&a>o){if(o=a,a===r){if(s===i.y)return i;if(s===i.next.y)return i.next}n=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!n)return null;if(r===o)return n;var h,c=n,l=n.x,u=n.y,d=1/0;i=n;do{r>=i.x&&i.x>=l&&r!==i.x&&dr(s<u?r:o,s,l,u,s<u?o:r,s,i.x,i.y)&&(h=Math.abs(s-i.y)/(r-i.x),_r(i,t)&&(h<d||h===d&&(i.x>n.x||i.x===n.x&&cr(n,i)))&&(n=i,d=h)),i=i.next}while(i!==c);return n}(t,e);if(!n)return e;var i=vr(n,t),r=er(n,n.next);return er(i,i.next),e===n?r:e}function cr(t,e){return pr(t.prev,t,e.prev)<0&&pr(e.next,t,t.next)<0}function lr(t,e,n,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function ur(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function dr(t,e,n,i,r,s,o,a){return(r-o)*(e-a)-(t-o)*(s-a)>=0&&(t-o)*(i-a)-(n-o)*(e-a)>=0&&(n-o)*(s-a)-(r-o)*(i-a)>=0}function fr(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&yr(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(_r(t,e)&&_r(e,t)&&function(t,e){var n=t,i=!1,r=(t.x+e.x)/2,s=(t.y+e.y)/2;do{n.y>s!=n.next.y>s&&n.next.y!==n.y&&r<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)&&(pr(t.prev,t,e.prev)||pr(t,e.prev,e))||gr(t,e)&&pr(t.prev,t,t.next)>0&&pr(e.prev,e,e.next)>0)}function pr(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function gr(t,e){return t.x===e.x&&t.y===e.y}function yr(t,e,n,i){var r=mr(pr(t,e,n)),s=mr(pr(t,e,i)),o=mr(pr(n,i,t)),a=mr(pr(n,i,e));return r!==s&&o!==a||(!(0!==r||!xr(t,n,e))||(!(0!==s||!xr(t,i,e))||(!(0!==o||!xr(n,t,i))||!(0!==a||!xr(n,e,i)))))}function xr(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function mr(t){return t>0?1:t<0?-1:0}function _r(t,e){return pr(t.prev,t,t.next)<0?pr(t,e,t.next)>=0&&pr(t,t.prev,e)>=0:pr(t,e,t.prev)<0||pr(t,t.next,e)<0}function vr(t,e){var n=new Mr(t.i,t.x,t.y),i=new Mr(e.i,e.x,e.y),r=t.next,s=e.prev;return t.next=e,e.prev=t,n.next=r,r.prev=n,i.next=n,n.prev=i,s.next=i,i.prev=s,i}function br(t,e,n,i){var r=new Mr(t,e,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function wr(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Mr(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function zr(t,e,n,i){for(var r=0,s=e,o=n-i;s<n;s+=i)r+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return r}Ji.exports=$i,Ji.exports.default=$i,$i.deviation=function(t,e,n,i){var r=e&&e.length,s=r?e[0]*n:t.length,o=Math.abs(zr(t,0,s,n));if(r)for(var a=0,h=e.length;a<h;a++){var c=e[a]*n,l=a<h-1?e[a+1]*n:t.length;o-=Math.abs(zr(t,c,l,n))}var u=0;for(a=0;a<i.length;a+=3){var d=i[a]*n,f=i[a+1]*n,p=i[a+2]*n;u+=Math.abs((t[d]-t[p])*(t[f+1]-t[d+1])-(t[d]-t[f])*(t[p+1]-t[d+1]))}return 0===o&&0===u?0:Math.abs((u-o)/o)},$i.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},i=0,r=0;r<t.length;r++){for(var s=0;s<t[r].length;s++)for(var o=0;o<e;o++)n.vertices.push(t[r][s][o]);r>0&&(i+=t[r-1].length,n.holes.push(i))}return n};var Or=Ji.exports;function Ar(t,e,n){var i=e[0],r=e[1],s=n[0]-i,o=n[1]-r;if(0!==s||0!==o){var a=((t[0]-i)*s+(t[1]-r)*o)/(s*s+o*o);a>1?(i=n[0],r=n[1]):a>0&&(i+=s*a,r+=o*a)}return(s=t[0]-i)*s+(o=t[1]-r)*o}function Sr(t,e,n,i,r){for(var s,o=i,a=e+1;a<n;a++){var h=Ar(t[a],t[e],t[n]);h>o&&(s=a,o=h)}o>i&&(s-e>1&&Sr(t,e,s,i,r),r.push(t[s]),n-s>1&&Sr(t,s,n,i,r))}function jr(t,e){var n=t.length-1,i=[t[0]];return Sr(t,0,n,e,i),i.push(t[n]),i}function Cr(t,e,n){if(t.length<=2)return t;var i=void 0!==e?e*e:1;return t=n?t:function(t,e){for(var n,i,r,s,o,a=t[0],h=[a],c=1,l=t.length;c<l;c++)n=t[c],r=a,s=void 0,o=void 0,s=(i=n)[0]-r[0],o=i[1]-r[1],s*s+o*o>e&&(h.push(n),a=n);return a!==n&&h.push(n),h}(t,i),t=jr(t,i)}function kr(t,e){return t[0]*e[0]+t[1]*e[1]}function Tr(t,e){const n=e[0],i=e[1],r=Math.sqrt(n*n+i*i);return t[0]=n/r,t[1]=i/r,t}function Pr(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t}function Vr(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t}function Lr(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function Br(t,e){const n=e[0],i=e[1],r=e[2],s=Math.sqrt(n*n+i*i+r*r);return t[0]=n/s,t[1]=i/s,t[2]=r/s,t}function Ur(t,e,n){var i=e[0],r=e[1],s=e[2],o=n[0],a=n[1],h=n[2];return t[0]=r*h-s*a,t[1]=s*o-i*h,t[2]=i*a-r*o,t}const Er=[];function Ir(t,e,n,i){const r=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}(e,n),s=Math.acos(r)*i;return Pr(Er,n,e,-r),function(t,e){const n=e[0],i=e[1],r=e[2],s=Math.sqrt(n*n+i*i+r*r);t[0]=n/s,t[1]=i/s,t[2]=r/s}(Er,Er),function(t,e,n){t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n}(t,e,Math.cos(s)),Pr(t,t,Er,Math.sin(s)),t}function Fr(t,e,n,i,r,s,o,a,h,c){const l=o-r,u=a-s,d=(l*(e-s)-u*(t-r))/(u*(n-t)-l*(i-e));return h&&(h[c=c||0]=t+d*(n-t),h[c+1]=e+d*(i-e)),d}function Rr(t,e,n){if(n-e<3)return 0;let i=0;for(let r=2*(n-1),s=2*e;s<2*n;){const e=t[r],n=t[r+1],o=t[s],a=t[s+1];r=s,s+=2,i+=e*a-o*n}return i}function Gr(t,e,n=2){return Or(t,e,n)}const Zr=[],Qr=[],Dr=[];function Hr(t,e,n,i,r,s,o,a,h){const c=null!=o;let l,u,d,f=r,p=null;c&&(p=new Uint32Array(i-n));let g=[];for(let r=n;r<i;r++){const y=r===i-1?n:r+1,x=r===n?i-1:r-1,m=t[2*x],_=t[2*x+1],v=t[2*r],b=t[2*r+1],w=t[2*y],M=t[2*y+1];Zr[0]=v-m,Zr[1]=b-_,Qr[0]=w-v,Qr[1]=M-b,Tr(Zr,Zr),Tr(Qr,Qr),c&&(p[r]=f);let z,O,A=!1;if(a||r!==n)if(a||r!==i-1){Vr(Dr,Qr,Zr);const t=Dr[1];Dr[1]=-Dr[0],Dr[0]=t,Tr(Dr,Dr);const n=kr(Dr,Qr),i=Math.sqrt(1-n*n),r=s*Math.min(10,1/i),a=s*n<0;if(c&&1/i>o&&a){const t=v+Dr[0]*s,n=b+Dr[1]*s,r=Math.acos(i)/2,o=Math.tan(r)*Math.abs(s);e[2*f]=t+Dr[1]*o,e[2*f+1]=n-Dr[0]*o,f++,e[2*f]=t-Dr[1]*o,e[2*f+1]=n+Dr[0]*o,f++}else z=v+Dr[0]*r,O=b+Dr[1]*r,A=!0;if(A){if(h&&null!=l){const t=Fr(m,_,l,u,v,b,z,O,g,0);t>=-.01&&t<=1.01&&(e[2*d]=z=g[0],e[2*d+1]=O=g[1])}l=e[2*f]=z,u=e[2*f+1]=O,d=f,f++}}else Dr[0]=Zr[1],Dr[1]=-Zr[0],Tr(Dr,Dr),z=v+Dr[0]*s,O=b+Dr[1]*s,A=!0;else Dr[0]=Qr[1],Dr[1]=-Qr[0],Tr(Dr,Dr),l=e[2*f]=v+Dr[0]*s,u=e[2*f+1]=b+Dr[1]*s,d=f,f++}return p}function Wr(t,e,n,i,r,s,o,a){const h=null!=o;let c=r,l=null;h&&(l=new Uint32Array(i-n));for(let r=n;r<i;r++){const u=r===i-1?n:r+1,d=r===n?i-1:r-1,f=t[2*d],p=t[2*d+1],g=t[2*r],y=t[2*r+1],x=t[2*u],m=t[2*u+1];if(Zr[0]=g-f,Zr[1]=y-p,Qr[0]=x-g,Qr[1]=m-y,Tr(Zr,Zr),Tr(Qr,Qr),h&&(l[r]=c),a||r!==n)if(a||r!==i-1){Vr(Dr,Qr,Zr);const t=Dr[1];Dr[1]=-Dr[0],Dr[0]=t,Tr(Dr,Dr);const n=kr(Dr,Qr),i=Math.sqrt(1-n*n),r=s*Math.min(10,1/i),a=s*n<0;if(h&&1/i>o&&a){const t=g+Dr[0]*s,n=y+Dr[1]*s,r=Math.acos(i)/2,o=Math.tan(r)*Math.abs(s);e[2*c]=t+Dr[1]*o,e[2*c+1]=n-Dr[0]*o,c++,e[2*c]=t-Dr[1]*o,e[2*c+1]=n+Dr[0]*o,c++}else e[2*c]=g+Dr[0]*r,e[2*c+1]=y+Dr[1]*r,c++}else Dr[0]=Zr[1],Dr[1]=-Zr[0],Tr(Dr,Dr),e[2*c]=g+Dr[0]*s,e[2*c+1]=y+Dr[1]*s,c++;else Dr[0]=Qr[1],Dr[1]=-Qr[0],Tr(Dr,Dr),e[2*c]=g+Dr[0]*s,e[2*c+1]=y+Dr[1]*s,c++}return l}function qr(t,e,n,i,r){const s=null!=i?[]:new Float32Array(t.length);if(Hr(t,s,0,e&&e.length?e[0]:t.length/2,0,n,i,r,!0),e)for(let o=0;o<e.length;o++){const a=e[o];Hr(t,s,a,e[o+1]||t.length/2,null!=i?s.length/2:a,n,i,r,!1)}return s}function Nr(t,e,n,i){for(let r=0;r<Math.floor((i-n)/2);r++)for(let s=0;s<e;s++){const o=(r+n)*e+s,a=(i-r-1)*e+s,h=t[o];t[o]=t[a],t[a]=h}return t}function Xr(t,e){let n=t.length/2,i=0,r=e&&e.length?e[0]:n;Rr(t,i,r)>0&&Nr(t,2,i,r);for(let s=1;s<(e?e.length:0)+1;s++)i=e[s-1],r=e[s]||n,Rr(t,i,r)<0&&Nr(t,2,i,r)}function Kr(t){t.depth=t.depth||1,t.bevelSize=t.bevelSize||0,t.bevelSegments=null==t.bevelSegments?2:t.bevelSegments,t.smoothBevel=t.smoothBevel||!1,t.simplify=t.simplify||0,null==t.smoothSide&&(t.smoothSide="auto"),null==t.smoothSideThreshold&&(t.smoothSideThreshold=.9),"number"==typeof t.depth&&(t.bevelSize=Math.min(t.bevelSegments>0?t.bevelSize:0,t.depth/2)),t.bevelSize>0||(t.bevelSegments=0),t.bevelSegments=Math.round(t.bevelSegments);const e=t.boundingRect;if(t.translate=t.translate||[0,0],t.scale=t.scale||[1,1],t.fitRect){let n=null==t.fitRect.x?e.x||0:t.fitRect.x,i=null==t.fitRect.y?e.y||0:t.fitRect.y,r=t.fitRect.width,s=t.fitRect.height;null==r?null!=s?r=s/e.height*e.width:(r=e.width,s=e.height):null==s&&(s=r/e.width*e.height),t.scale=[r/e.width,s/e.height],t.translate=[(n-e.x)*t.scale[0],(i-e.y)*t.scale[1]]}}const Yr=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function Jr(t,e,n){let i=0,r=t[e],s=t[e+1];const o=r,a=s;for(let o=e+2;o<n;o+=2){const e=t[o],n=t[o+1];i+=Math.sqrt((e-r)*(e-r)+(n-s)*(n-s)),r=e,s=n}return i+=Math.sqrt((r-o)*(r-o)+(s-a)*(s-a)),i}function $r(t,{vertices:e,topVertices:n,splittedMap:i,depth:r,rect:s},o,a,h,c){const l=a-o,u=c.smoothBevel?1:2,d=Math.min(r/2,c.bevelSize),f=c.bevelSegments,p=h.vertex,g=h.ringPerimeter,y=Math.max(s.width,s.height,r,g);function x(t){const n=(t+1)%l,i=e[2*t],r=e[2*t+1],s=e[2*n],o=e[2*n+1];return i===s&&r===o}if(d>0){const s=[0,0,1],a=[],c=[0,0,-1],g=[];let m=0,_=new Float32Array(l);for(let v=0;v<2;v++){const b=0===v?r-d:d;for(let r=0;r<=f*u;r++){let w,M,z=0;for(let O=0;O<l;O++){const A=2*(O%l+o),S=i?2*i[A/2]:A;a[0]=e[A]-n[S],a[1]=e[A+1]-n[S+1],a[2]=0;const j=Math.sqrt(a[0]*a[0]+a[1]*a[1]);a[0]/=j,a[1]/=j;const C=(Math.floor(r/u)+r%u)/f;0===v?Ir(g,s,a,C):Ir(g,a,c,C);const k=0===v?C:1-C,T=d*Math.sin(k*Math.PI/2),P=j*Math.cos(k*Math.PI/2),V=d*j/Math.sqrt(T*T+P*P),L=g[0]*V+n[S],B=g[1]*V+n[S+1],U=g[2]*V+b;if(t.position[3*h.vertex]=L,t.position[3*h.vertex+1]=B,t.position[3*h.vertex+2]=U,O>0&&(z+=Math.sqrt((w-L)*(w-L)+(M-B)*(M-B))),r>0||v>0){let e=3*(h.vertex-l),n=t.position[e],i=t.position[e+1],r=t.position[e+2];_[O]+=Math.sqrt((n-L)*(n-L)+(i-B)*(i-B)+(r-U)*(r-U))}if(t.uv[2*h.vertex]=z/y,t.uv[2*h.vertex+1]=_[O]/y,w=L,M=B,h.vertex++,!x(O)&&(u>1&&r%u||1===u&&r>=1))for(let e=0;e<6;e++){const n=(Yr[e][0]+O)%l,i=Yr[e][1]+m;t.indices[h.index++]=(i-1)*l+n+p}}m++}}}else for(let n=0;n<2;n++){const i=0===n?r-d:d;let s,a,c=0;for(let n=0;n<l;n++){const r=2*(n%l+o),u=e[r],d=e[r+1];t.position[3*h.vertex]=u,t.position[3*h.vertex+1]=d,t.position[3*h.vertex+2]=i,n>0&&(c+=Math.sqrt((s-u)*(s-u)+(a-d)*(a-d))),t.uv[2*h.vertex]=c/y,t.uv[2*h.vertex+1]=i/y,s=u,a=d,h.vertex++}}const m=d>0?f*u+1:1;for(let e=0;e<l;e++)if(!x(e))for(let n=0;n<6;n++){const i=(Yr[n][0]+e)%l,r=Yr[n][1]+m;t.indices[h.index++]=(r-1)*l+i+p}}function ts({indices:t,topVertices:e,rect:n,depth:i},r,s,o){if(e.length<=4)return;const a=s.vertex,h=t.length;for(let e=0;e<h;e++)r.indices[s.index++]=a+t[e];const c=Math.max(n.width,n.height);for(let t=0;t<(o.excludeBottom?1:2);t++)for(let o=0;o<e.length;o+=2){const a=e[o],h=e[o+1];r.position[3*s.vertex]=a,r.position[3*s.vertex+1]=h,r.position[3*s.vertex+2]=(1-t)*i,r.uv[2*s.vertex]=(a-n.x)/c,r.uv[2*s.vertex+1]=(h-n.y)/c,s.vertex++}if(!o.excludeBottom){const n=e.length/2;for(let e=0;e<h;e+=3)for(let i=0;i<3;i++)r.indices[s.index++]=a+n+t[e+2-i]}}function es(t,e,n,i){const r=null==n||"auto"===n;if(!0===n)return{vertices:t,holes:e};const s=[],o=e&&[],a=t.length/2,h=[],c=[],l=[];let u=0,d=0;const f=(e?e.length:0)+1;for(let n=0;n<f;n++){0===n?d=e&&e.length?e[0]:a:(u=e[n-1],d=e[n]||a);for(let e=u;e<d;e++){const n=t[2*e],o=t[2*e+1],a=e===d-1?u:e+1,f=t[2*a],p=t[2*a+1];if(r){const r=e===u?d-1:e-1,a=t[2*r],g=t[2*r+1];h[0]=a-n,h[1]=g-o,c[0]=f-n,c[1]=p-o,Tr(h,h),Tr(c,c);1-(.5*kr(h,c)+.5)>i?(s.push(n,o),l.push(e)):(s.push(n,o,n,o),l.push(e,e))}else s.push(n,o,n,o),l.push(e,e)}n<f-1&&o&&o.push(s.length/2)}return{vertices:new Float32Array(s),splittedMap:l,holes:o}}function ns(t,e){let n=0,i=0;for(let r=0;r<t.length;r++){const{indices:s,vertices:o,splittedMap:a,topVertices:h,depth:c}=t[r],l=Math.min(c/2,e.bevelSize)>0?e.bevelSegments:0,u=t[r].holes||[];n+=s.length*(e.excludeBottom?1:2),i+=h.length/2*(e.excludeBottom?1:2);const d=2+2*l;let f=0,p=0;for(let t=0;t<u.length+1;t++){0===t?p=u.length?u[0]:o.length/2:(f=u[t-1],p=u[t]||o.length/2);n+=6*((a?a[p-1]+1:p)-(a?a[f]:f))*(d-1);const r=p-f;i+=r*d+(e.smoothBevel?0:l*r*2)}}const r={position:new Float32Array(3*i),indices:new(i>65535?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*i)},s={vertex:0,index:0,ringPerimeter:0};for(let n=0;n<t.length;n++)ts(t[n],r,s,e);for(let n=0;n<t.length;n++){const{holes:i,vertices:o}=t[n],a=o.length/2;let h=0,c=i&&i.length?i[0]:a;if(s.ringPerimeter=Jr(t[n].topVertices,h,c),$r(r,t[n],h,c,s,e),i)for(let o=0;o<i.length;o++)h=i[o],c=i[o+1]||a,s.ringPerimeter=Jr(t[n].topVertices,h,c),$r(r,t[n],h,c,s,e)}for(let t=0;t<r.uv.length;t++){const e=r.uv[t];e>0&&Math.round(e)===e?r.uv[t]=1:r.uv[t]=e%1}return r.normal=function(t,e){function n(t,e,n,i){t[0]=e,t[1]=n,t[2]=i}const i=[],r=[],s=[],o=[],a=[],h=[],c=t.length,l=new Float32Array(e.length);for(let u=0;u<c;){const c=3*t[u++],d=3*t[u++],f=3*t[u++];n(i,e[c],e[c+1],e[c+2]),n(r,e[d],e[d+1],e[d+2]),n(s,e[f],e[f+1],e[f+2]),Lr(o,i,r),Lr(a,r,s),Ur(h,o,a);for(let t=0;t<3;t++)l[c+t]=l[c+t]+h[t],l[d+t]=l[d+t]+h[t],l[f+t]=l[f+t]+h[t]}for(var u=0;u<l.length;)n(h,l[u],l[u+1],l[u+2]),Br(h,h),l[u++]=h[0],l[u++]=h[1],l[u++]=h[2];return l}(r.indices,r.position),r.boundingRect=t[0]&&t[0].rect,r}function is(t,e,n){const i=n.lineWidth,r=t.length,s=new Float32Array(2*r),o=n.translate||[0,0],a=n.scale||[1,1];for(let e=0,n=0;e<r;e++)s[n++]=t[e][0]*a[0]+o[0],s[n++]=t[e][1]*a[1]+o[1];Rr(s,0,r)<0&&Nr(s,2,0,r);const h=[],c=[],l=n.miterLimit,u=Wr(s,c,0,r,0,-i/2,l,!1);Nr(s,2,0,r);const d=Wr(s,h,0,r,0,-i/2,l,!1),f=(h.length+c.length)/2,p=new Float32Array(2*f);let g=0;const y=c.length/2;for(let t=0;t<c.length;t++)p[g++]=c[t];for(let t=0;t<h.length;t++)p[g++]=h[t];const x=new(f>65535?Uint32Array:Uint16Array)(3*(2*(r-1)+(f-2*r)));let m=0;for(let t=0;t<r-1;t++){const e=t+1;x[m++]=y-1-u[t],x[m++]=y-1-u[t]-1,x[m++]=d[t]+1+y,x[m++]=y-1-u[t],x[m++]=d[t]+1+y,x[m++]=d[t]+y,d[e]-d[t]==2?(x[m++]=d[t]+2+y,x[m++]=d[t]+1+y,x[m++]=y-u[e]-1):u[e]-u[t]==2&&(x[m++]=d[e]+y,x[m++]=y-1-(u[t]+1),x[m++]=y-1-(u[t]+2))}const _=n.bevelSize>0?qr(p,[],n.bevelSize,null,!0):p,v=n.boundingRect,b=es(p,null,n.smoothSide,n.smoothSideThreshold);return{vertices:b.vertices,rawVertices:_,splittedMap:b.splittedMap,indices:x,topVertices:_,rect:{x:v.x*a[0]+o[0],y:v.y*a[1]+o[1],width:v.width*a[0],height:v.height*a[1]},depth:"function"==typeof n.depth?n.depth(e):n.depth,holes:[]}}function rs(t,e){const n=[];for(let i=0;i<t.length;i++){const r=t[i],s=[],o=r.length;let a=r[o-1][0],h=r[o-1][1],c=0;for(let t=0;t<o;t++){let n=r[t][0],i=r[t][1];const o=n-a,l=i-h;c+=Math.sqrt(o*o+l*l),c>e&&(s.push(r[t]),c=0),a=n,h=i}s.length>=3&&n.push(s)}return n.length>0?n:null}function ss(t,e){const n=[];for(let i=0;i<t.length;i++){let r=t[i];r=Cr(r,e,!0),r.length>=3&&n.push(r)}return n.length>0?n:null}function os(t,e){e=Object.assign({},e);const n=[1/0,1/0],i=[-1/0,-1/0];for(let e=0;e<t.length;e++)hs(t[e][0],n,i);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:i[0]-n[0],height:i[1]-n[1]},Kr(e);const r=[],s=e.translate||[0,0],o=e.scale||[1,1],a=e.boundingRect,h={x:a.x*o[0]+s[0],y:a.y*o[1]+s[1],width:a.width*o[0],height:a.height*o[1]},c=Math.min(a.width,a.height)/1e5;for(let n=0;n<t.length;n++){let i=rs(t[n],c);if(!i)continue;const a=e.simplify/Math.max(o[0],o[1]);if(a>0&&(i=ss(i,a)),!i)continue;const{vertices:l,holes:u,dimensions:d}=Or.flatten(i);for(let t=0;t<l.length;)l[t]=l[t++]*o[0]+s[0],l[t]=l[t++]*o[1]+s[1];if(Xr(l,u),2!==d)throw new Error("Only 2D polygon points are supported");const f=e.bevelSize>0?qr(l,u,e.bevelSize,null,!0):l,p=Gr(f,u,d),g=es(l,u,e.smoothSide,e.smoothSideThreshold);r.push({indices:p,vertices:g.vertices,rawVertices:l,topVertices:f,holes:g.holes,splittedMap:g.splittedMap,rect:h,depth:"function"==typeof e.depth?e.depth(n):e.depth})}return ns(r,e)}function as(t,e){e=Object.assign({},e);const n=[1/0,1/0],i=[-1/0,-1/0];for(let e=0;e<t.length;e++)hs(t[e],n,i);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:i[0]-n[0],height:i[1]-n[1]},Kr(e);const r=e.scale||[1,1];null==e.lineWidth&&(e.lineWidth=1),null==e.miterLimit&&(e.miterLimit=2);const s=[];for(let n=0;n<t.length;n++){let i=t[n];const o=e.simplify/Math.max(r[0],r[1]);o>0&&(i=Cr(i,o,!0)),s.push(is(i,n,e))}return ns(s,e)}function hs(t,e,n){for(let i=0;i<t.length;i++)e[0]=Math.min(t[i][0],e[0]),e[1]=Math.min(t[i][1],e[1]),n[0]=Math.max(t[i][0],n[0]),n[1]=Math.max(t[i][1],n[1])}var cs=Object.freeze({__proto__:null,triangulate:Gr,flatten:function(t){return Or.flatten(t)},offsetPolygon:qr,extrudePolygon:os,extrudePolyline:as,extrudeGeoJSON:function(t,e){e=Object.assign({},e);const n=[],i=[],r=[],s=[],o=[1/0,1/0],a=[-1/0,-1/0];for(let e=0;e<t.features.length;e++){const h=t.features[e].geometry;if(h&&h.coordinates)switch(h.type){case"LineString":n.push(h.coordinates),r.push(e),hs(h.coordinates,o,a);break;case"MultiLineString":for(let t=0;t<h.coordinates.length;t++)n.push(h.coordinates[t]),r.push(e),hs(h.coordinates[t],o,a);break;case"Polygon":i.push(h.coordinates),s.push(e),hs(h.coordinates[0],o,a);break;case"MultiPolygon":for(let t=0;t<h.coordinates.length;t++)i.push(h.coordinates[t]),s.push(e),hs(h.coordinates[t][0],o,a)}}e.boundingRect=e.boundingRect||{x:o[0],y:o[1],width:a[0]-o[0],height:a[1]-o[1]};const h=e.depth;return{polyline:as(n,Object.assign(e,{depth:function(e){return"function"==typeof h?h(t.features[r[e]]):h}})),polygon:os(i,Object.assign(e,{depth:function(e){return"function"==typeof h?h(t.features[s[e]]):h}}))}}});const ls="__maptalks.three.fetchdata__";var us;const ds={bottomHeight:0,width:3,cornerRadius:0,altitude:0,topColor:null,bottomColor:"#2d2f61",heightEnable:!0};class fs extends v{constructor(t,e,n,i){e=r.Util.extend({},ds,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{width:s,cornerRadius:o,bottomHeight:a,altitude:h,asynchronous:c}=e,l=i.distanceToVector3(o,o).x,u=i.distanceToVector3(s,s).x,{lineStrings:d,center:f}=Ce(t);let p;if(c){p=fn();const e=r.Util.GUID();this.getOptions().id=e,this.getOptions().center=f,rn.push({id:e,data:d,layer:i,center:f,lineString:t,baseObject:this})}else{const t=[],e={};for(let n=0,r=d.length;n<r;n++){const r=je(d[n],u,l,i,f);se(r,a,i,e),t.push(r)}p=an(t)}this._createMesh(p,n);const g=i.altitudeToVector3(h,h).x,y=i.coordinateToVector3(f,g);this.getObject3d().position.copy(y),this.type="Path"}_workerLoad(t){const e=ln(t);this.getObject3d().geometry=e,this._fire("workerload",{target:this})}}const ps={width:3,cornerRadius:0,altitude:0,topColor:null,bottomColor:"#2d2f61"};class gs extends(Hn(v)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const s=[],o=[],a=t.length;for(let e=0;e<a;e++){const n=Ce(t[e]);s.push(n.center),o.push(n.lineStrings)}const h=re(s);e=r.Util.extend({},ps,e,{layer:i,lineStrings:t,coordinate:h});const{altitude:c,asynchronous:l}=e;let u;const d=[],f=[];if(super(),l)u=fn(),sn.push({id:r.Util.GUID(),layer:i,key:e.key,center:h,data:o,lineStrings:t,baseObject:this,option:e});else{const n=[];let s=0;const c={},l={};for(let u=0;u<a;u++){const a=t[u],d=r.Util.extend({},e,ue(a),{index:u}),{cornerRadius:p,width:g,bottomHeight:y}=d,x=ne(g,i,c),m=ne(p,i,l),_=o[u],v=[];let b=0;for(let t=0,e=_.length;t<e;t++){const e=je(_[t],x,m,i,h);b=se(e,y,i,c),v.push(e)}const w=hn(v);n.push(w);const{position:M,normal:z,indices:O}=w;O.length;const A=M.length/3;z.length,f[u]={position:{middleZ:b,count:A,start:s,end:s+3*A},hide:!1},s+=3*A}u=an(n)}this._initOptions(e),this._createMesh(u,n);const p=i.altitudeToVector3(c,c).x,g=i.coordinateToVector3(h,p);this.getObject3d().position.copy(g),this._baseObjects=d,this._datas=t,this._geometriesAttributes=f,this.faceIndex=null,this._geometryCache=un(u),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(d),l||(this._setPickObject3d(),this._init()),this.type="Paths"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,O(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new fs(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){return this.picked}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=ln(t);if(this._geometryCache=un(n),this.getObject3d().geometry=n,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const ys=Math.PI/180,xs=[[4e3,220],[2e3,100],[1e3,30],[500,15],[100,5],[50,2],[10,1],[5,.7],[2,.1],[1,.05],[.5,.02],[.4,.01],[.1,.005],[.05,.002],[.01,.001]],ms=["mouseout","mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"],_s=new r.Coordinate(0,0),vs=new r.Point(0,0),bs=new s.Vector3,ws=new Map,Ms="__webglFramebuffer",zs=new s.Vector4;class Os extends r.CanvasLayer{constructor(t,e){super(t,e),this._animationBaseObjectMap={},this._needsUpdate=!0,this._mousemoveTimeOut=0,this._mousedownTime=0,this._baseObjects=[],this._delayMeshes=[],this._meshes=[],this.type="ThreeLayer"}isMercator(){const t=this.getMap();if(!t)return!1;const e=t.getSpatialReference(),n=e._projection,i=e._resolutions;return!!(n&&"EPSG:3857"===n.code&&i&&i.length&&156543===Math.floor(i[0])&&t.getGLRes)}isRendering(){const t=this.getMap();return!!t&&(t.isInteracting()||t.isAnimating())}prepareToDraw(...t){}draw(t,e,n,i,r,s){this.renderScene(s,this)}drawOnInteracting(t,e,n,i,r,s,o){this.renderScene(o,this)}_transformHeight(t,e){if(!t)return 0;if(0===(e=e||0))return 0;return this.altitudeToVector3(e,e,null,bs).x}coordinateToVector3(t,e=0,n){const i=this.getMap();if(!i)return null;const o=Array.isArray(t);o?(_s.x=t[0],_s.y=t[1]):t instanceof r.Coordinate||(t=new r.Coordinate(t));const a=Cs(i),h=ks(i,o?_s:t,a,vs);return n&&(n.x=h.x,n.y=h.y,n.z=e),new s.Vector3(h.x,h.y,e)}coordinatiesToGLFloatArray(t,e,n){const i=this.getMap();if(!i)return null;const s=Cs(i),o=t.length,a=new Float32Array(2*o),h=new Float32Array(3*o);ws.clear();for(let c=0;c<o;c++){let o=t[c];const l=Array.isArray(o);l?(_s.x=o[0],_s.y=o[1]):o instanceof r.Coordinate||(o=new r.Coordinate(o));const u=ks(i,l?_s:o,s,vs);u.x-=e.x,u.y-=e.y;const d=2*c;a[d]=u.x,a[d+1]=u.y;const f=o;let p=f.z||f[2]||0;if(n&&!ws.has(p)){const t=this._transformHeight(n,p);ws.set(p,t)}let g=0;n&&(g=ws.get(p)||0);const y=3*c;h[y]=u.x,h[y+1]=u.y,h[y+2]=g}return{positions:h,positons2d:a}}coordinatiesToGLArray(t,e){const n=this.getMap();if(!n)return null;const i=Cs(n),s=t.length,o=new Array(s);for(let a=0;a<s;a++){let s=t[a];const h=Array.isArray(s);h?(_s.x=s[0],_s.y=s[1]):s instanceof r.Coordinate||(s=new r.Coordinate(s));const c=ks(n,h?_s:s,i,vs);c.x-=e.x,c.y-=e.y,o[a]=[c.x,c.y]}return o}distanceToVector3(t,e,n){if(0===t&&0===e||!r.Util.isNumber(t)||!r.Util.isNumber(e))return new s.Vector3(0,0,0);const i=this.getMap(),o=Cs(i);let a=n||i.getCenter();a instanceof r.Coordinate||(a=new r.Coordinate(a));const h=i.locate(a,t,e),c=ks(i,a,o),l=ks(i,h,o),u=Math.abs(l.x-c.x)*r.Util.sign(t),d=Math.abs(l.y-c.y)*r.Util.sign(e);return new s.Vector3(u,d,0)}altitudeToVector3(t,e,n,i){if(0===t||!r.Util.isNumber(t))return new s.Vector3(0,0,0);const o=this.getMap();if(o.altitudeToPoint){const e=Cs(o);let n=o.altitudeToPoint(t,e);return t<0&&n>0&&(n=-n),i?(i.x=n,i.y=n,i.z=0,i):new s.Vector3(n,n,0)}return this.distanceToVector3(t,t,n)}toShape(t){if(!t)return null;if(t instanceof r.MultiPolygon)return t.getGeometries().map((t=>this.toShape(t)));const e=t.getCenter(),n=this.coordinateToVector3(e),i=t.getShell().map((t=>{const e=this.coordinateToVector3(t).sub(n);return new s.Vector2(e.x,e.y)})),o=new s.Shape(i),a=t.getHoles();return a&&a.length>0&&(o.holes=a.map((t=>{const e=t.map((t=>{const e=this.coordinateToVector3(t).sub(n);return new s.Vector2(e.x,e.y)}));return new s.Shape(e)}))),o}toExtrudeMesh(t,e,n,i){if(!t)return null;if(t instanceof r.MultiPolygon)return t.getGeometries().map((t=>this.toExtrudeMesh(t,e,n,i)));const o=t.getCoordinates();o.forEach((t=>{for(let e=t.length-1;e>=1;e--)t[e].equals(t[e-1])&&t.splice(e,1)})),t.setCoordinates(o);const a=this.toShape(t),h=this.coordinateToVector3(t.getCenter());i=r.Util.isNumber(i)?i:e,i=this.altitudeToVector3(i,i).x;const c=this.altitudeToVector3(e,e).x,l={bevelEnabled:!1,bevelSize:1};l[parseInt(s.REVISION)>=93?"depth":"amount"]=i;const u=new s.ExtrudeGeometry(a,l);let d=u;s.BufferGeometry.prototype.fromGeometry&&(d=new s.BufferGeometry,d.fromGeometry(u));const f=new s.Mesh(d,n);return f.position.set(h.x,h.y,c-i),f}toExtrudePolygon(t,e,n){return new kn(t,e,n,this)}toBar(t,e,n){return new Mn(t,e,n,this)}toLine(t,e,n){return new An(t,e,n,this)}toExtrudeLine(t,e,n){return new jn(t,e,n,this)}toModel(t,e){return new Pn(t,e,this)}toExtrudeLineTrail(t,e,n){return new Zn(t,e,n,this)}toExtrudePolygons(t,e,n){return new Nn(t,e,n,this)}toPoint(t,e,n){return new $n(t,e,n,this)}toPoints(t,e,n){return new si(t,e,n,this)}toBars(t,e,n){return new ai(t,e,n,this)}toExtrudeLines(t,e,n){return new ci(t,e,n,this)}toLines(t,e,n){return new ui(t,e,n,this)}toThreeVectorTileLayer(t,e,n){return new wi(t,e,n,this)}toTerrain(t,e,n){return new ki(t,e,n,this)}toTerrainVectorTileLayer(t,e,n){return new Pi(t,e,n,this)}toHeatMap(t,e,n){return new Ri(t,e,n,this)}toFatLine(t,e,n){return new Hi(t,e,n,this)}toFatLines(t,e,n){return new qi(t,e,n,this)}toBox(t,e,n){return new Xi(t,e,n,this)}toBoxs(t,e,n){return new Yi(t,e,n,this)}toPath(t,e,n){return new fs(t,e,n,this)}toPaths(t,e,n){return new gs(t,e,n,this)}getBaseObjects(){return this.getMeshes().filter((t=>t instanceof v))}getMeshes(){const t=this.getScene();if(!t)return[];const e=[];for(let n=0,i=t.children.length;n<i;n++){const i=t.children[n];i instanceof s.Object3D&&!(i instanceof s.Camera)&&e.push(i.__parent||i)}return e}clear(){return this.clearMesh()}clearBaseObjects(){return this.removeMesh(this.getBaseObjects())}clearMesh(){const t=this.getScene();if(!t)return this;for(let e=t.children.length-1;e>=0;e--){const n=t.children[e];if(n instanceof s.Object3D&&!(n instanceof s.Camera)){t.remove(n);const e=n.__parent;e&&e instanceof v&&(e.isAdd=!1,e.options.layer=null,e._fire("remove",{target:e}),delete this._animationBaseObjectMap[n.uuid],e._hideUI())}}return this._meshes=[],this}lookAt(t){const e=this.getCamera();return e&&e.lookAt&&t&&e.lookAt(t),this}getCamera(){const t=this._getRenderer();return t?t.camera:null}getScene(){const t=this._getRenderer();return t?t.scene:null}renderScene(t,e){const n=this._getRenderer();return n&&(n.clearCanvas(),n.renderScene(t),e||n.setToRedraw()),this}loop(t=!1){const e=this._delayMeshes;if(!e.length)return;const n=this.getMap();if(!n||n.isAnimating()||n.isInteracting())return;const i=this.options.loopRenderCount||50,r=e.slice(0,i);r&&this.addMesh(r,t),e.splice(0,i)}renderPickScene(){const t=this._getRenderer();if(t){const e=t.pick;e&&e.pick(this._containerPoint)}return this}getThreeRenderer(){const t=this._getRenderer();return t?t.context:null}getPick(){const t=this._getRenderer();return t?t.pick:null}delayAddMesh(t){if(!t)return this;Array.isArray(t)||(t=[t]);for(let e=0,n=t.length;e<n;e++)this._delayMeshes.push(t[e]);return this}addMesh(t,e=!0){if(!t)return this;Array.isArray(t)||(t=[t]);const n=this.getScene();if(t.forEach((t=>{t instanceof v?(n.add(t.getObject3d()),t.isAdd||(t.isAdd=!0,t.options.layer=this,t._fire("add",{target:t})),t._animation&&r.Util.isFunction(t._animation)&&(this._animationBaseObjectMap[t.getObject3d().uuid]=t)):t instanceof s.Object3D&&n.add(t);-1===this._meshes.indexOf(t)&&this._meshes.push(t)})),this._zoomend(),e){const t=this._getRenderer();t&&t.setToRedraw()}return this}removeMesh(t,e=!0){if(!t)return this;Array.isArray(t)||(t=[t]);const n=this.getScene();if(t.forEach((t=>{if(t instanceof v){n.remove(t.getObject3d()),t.isAdd&&(t.isAdd=!1,t.options.layer=null,t._fire("remove",{target:t}),t._hideUI()),t._animation&&r.Util.isFunction(t._animation)&&delete this._animationBaseObjectMap[t.getObject3d().uuid];const e=this._delayMeshes;if(e.length)for(let n=0,i=e.length;n<i;n++)if(e[n]===t){e.splice(n,1);break}}else t instanceof s.Object3D&&n.remove(t);for(let e=0,n=this._meshes.length;e<n;e++){const n=this._meshes[e];n&&(n===t&&this._meshes.splice(e,1))}})),e){const t=this._getRenderer();t&&t.setToRedraw()}return this}_initRaycaster(){return this._raycaster||(this._raycaster=new s.Raycaster,this._mouse=new s.Vector2),this}getRaycaster(){return this._raycaster}identify(t,e){if(!t)return console.error("coordinate is null,it should be Coordinate"),[];if(Array.isArray(t)&&(t=new r.Coordinate(t)),!(t instanceof r.Coordinate))return console.error("coordinate type is error,it should be Coordinate"),[];const n=this.getMap().coordToContainerPoint(t);this._containerPoint=n;const{x:i,y:a}=n;this._initRaycaster(),this.fire("identify",{coordinate:t,options:e});const h=this._raycaster,c=this._mouse,l=this.getCamera(),u=this.getScene(),d=this.getMap().getSize();if(!u)return[];const f=d.width,p=d.height;c.x=i/f*2-1,c.y=-a/p*2+1,h.setFromCamera(c,l),h.layers&&h.layers.enableAll&&h.layers.enableAll(),function(t,e){o>113?t.params.Line.threshold=e:t.linePrecision=e}(h,this._getLinePrecision(this.getMap().getResolution()));const g=[],y=[];u.children.forEach((t=>{const e=t.__parent;if(e&&e.getOptions){const n=e;n.getOptions().interactive&&n.isVisible()&&(n.identify&&r.Util.isFunction(n.identify)?y.push(n):g.push(t))}else(t instanceof s.Mesh||t instanceof s.Group)&&g.push(t)}));let x=[];const m=h.intersectObjects(g,!0);m&&Array.isArray(m)&&m.length&&(x=m.map((t=>{let e=t.object;const n=t.instanceId;e=this._recursionMesh(e)||{};const i=e.__parent||e;return i.faceIndex=t.faceIndex,i.index=t.index,i.intersect=t,r.Util.isNumber(n)&&(i.instanceId=n),i}))),this.renderPickScene(),y.length&&y.forEach((e=>{e.identify(t)&&x.push(e)}));const _=x.length;for(let t=0;t<_;t++)if(x[t])for(let e=t+1;e<_;e++)x[t]===x[e]&&x.splice(e,1);let b=x.filter((t=>t instanceof v));b=b.sort(((t,e)=>t.options.pickWeight-e.options.pickWeight)),x.forEach((t=>{t instanceof v||b.push(t)}));const w=(e=r.Util.extend({},e)).count;return r.Util.isNumber(w)&&w>0?b.slice(0,w):x}identifyAtPoint(t,e={}){const n=this.getMap();if(!n)return[];const i=n.containerPointToCoordinate(t);return this.identify(i,e)}_recursionMesh(t){for(;t&&t.parent!==this.getScene();)t=t.parent;return t}_getLinePrecision(t=10){for(let e=0,n=xs.length;e<n;e++){const[n,i]=xs[e];if(t>n)return i}return.01}fireGeoEvent(t,e,n){if(!(t instanceof v))return this;n=n||e.type;const i=this._getEventParams(e),{coordinate:r}=i,s=this.getMap();function o(t,e){e=e||n;const i=t.getInfoWindow();i&&!i._owner&&i.addTo(t);((i?i.options:{}).autoOpenOn||"click")===e&&(s.options.supportPluginEvent||t.openInfoWindow(r),t.fire("showinfowindow",{infoWindow:i}))}if("mousemove"===n){t.fire(n,Object.assign({},i,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null}));const e=t.getToolTip();e&&!e._owner&&e.addTo(t),t.openToolTip(r),o(t)}else"mouseover"===n?t._mouseover||(t.fire("mouseover",Object.assign({},i,{target:t,type:"mouseover",selectMesh:t.getSelectMesh?t.getSelectMesh():null})),t._mouseover=!0,o(t,"mouseover")):"mouseout"===n?t.getSelectMesh?t.isHide||(t._mouseover=!1,t.fire("mouseout",Object.assign({},i,{target:t,type:"mouseout",selectMesh:null})),t.closeToolTip()):(t._mouseover=!1,t.fire("mouseout",Object.assign({},i,{target:t,type:"mouseout"})),t.closeToolTip()):(t.fire(n,Object.assign({},i,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),o(t))}_emptyIdentify(t={}){const e=t.domEvent,n=this.getScene();if(!n)return this;const i=this.map||this.getMap();if(!i)return this;const r=i._getEventParams?i._getEventParams(e):this._getEventParams(e);for(let t=0,e=n.children.length;t<e;t++){const e=(n.children[t]||{}).__parent;e&&e.fire("empty",Object.assign({},r,{target:e}))}}_identifyBaseObjectEvents(t){if(!this.options.geometryEvents)return this;const e=this.map||this.getMap();if(e.isInteracting()||!e.options.geometryEvents||e._ignoreEvent(t))return this;const n=t.type,i=e._getEventParams?e._getEventParams(t):this._getEventParams(t);i.type=n;const{type:s,coordinate:o}=i,a=r.Util.now();if(this._mousemoveTimeOut&&"mousemove"===s&&a-this._mousemoveTimeOut<64)return this;this._mousemoveTimeOut=a,"mousedown"!==s&&"touchstart"!==s||(this._mousedownTime=r.Util.now());let h=!1;if("click"===s||"touchend"===s){const t=e.options.clickTimeThreshold||280;h=r.Util.now()-this._mousedownTime<t}if("click"===s&&!h)return this;const c=this.options.identifyCountOnEvent;let l=Math.max(0,r.Util.isNumber(c)?c:0);0===l&&(l=1/0);const u=t=>{const e=[];this._baseObjects&&this._baseObjects.forEach((n=>{let i=!0;t.forEach((t=>{n===t&&(i=!1)})),i&&e.push(n)})),e.forEach((t=>{t&&t instanceof v&&(t.getSelectMesh?t.isHide||(t._mouseover=!1,t.fire("mouseout",Object.assign({},i,{target:t,type:"mouseout",selectMesh:null})),t.closeToolTip()):(t._mouseover=!1,t.fire("mouseout",Object.assign({},i,{target:t,type:"mouseout"})),t.closeToolTip()))}))};if("mouseout"===s)return u([]),this._baseObjects=[],this;const d=this.identify(o,{count:l}),f=this.getScene();if(0===d.length&&f)for(let t=0,e=f.children.length;t<e;t++){const e=(f.children[t]||{}).__parent;e&&e.fire("empty",Object.assign({},i,{target:e}))}function p(t,e){e=e||s;const n=t.getInfoWindow();n&&!n._owner&&n.addTo(t);((n?n.options:{}).autoOpenOn||"click")===e&&(t.openInfoWindow(o),t.fire("showinfowindow",{infoWindow:n}))}if("mousemove"===s?(u(d),d.forEach((t=>{if(t instanceof v){t._mouseover||(t.fire("mouseover",Object.assign({},i,{target:t,type:"mouseover",selectMesh:t.getSelectMesh?t.getSelectMesh():null})),t._mouseover=!0,p(t,"mouseover")),t.fire(s,Object.assign({},i,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null}));const e=t.getToolTip();e&&!e._owner&&e.addTo(t),t.openToolTip(o),p(t)}})),this._baseObjects=d):d.forEach((t=>{t instanceof v&&(t.fire(s,Object.assign({},i,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),p(t))})),"touchend"===s&&h){const e=r.Util.extend({},i,{domEvent:t});d.forEach((t=>{t instanceof v&&(t.fire("click",Object.assign({},e,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),p(t,"click"))}))}return this}_getEventParams(t){const e=this.getMap(),n={domEvent:t};if(!e)return n;const i=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(i){const t=(0,r.DomUtil.getEventContainerPoint)(i,e._containerDOM);n.coordinate=e.containerPointToCoordinate(t),n.containerPoint=t,n.viewPoint=e.containerPointToViewPoint(t),n.pont2d=e._containerPointToPoint(t)}return n}_zoomend(){const t=this.getScene();if(!t)return;const e=this.getMap().getZoom();t.children.forEach((t=>{const n=t.__parent;if(n&&n.getOptions){const t=n;t.zoomChange&&r.Util.isFunction(t.zoomChange)&&t.zoomChange(e);const i=t.getMinZoom(),s=t.getMaxZoom();e<i||e>s?(t.isVisible()&&(t.getObject3d().visible=!1),t._zoomVisible=!1):i<=e&&e<=s&&(t._visible&&(t.getObject3d().visible=!0),t._zoomVisible=!0)}}))}_getGeometryEventMapPanel(){const t=this.map||this.getMap();return t._panels.allLayers||t._containerDOM}onAdd(){super.onAdd();const t=this.map||this.getMap();if(!t)return this;const e=this._getGeometryEventMapPanel();return this._identifyBaseObjectEventsThis||(this._identifyBaseObjectEventsThis=this._identifyBaseObjectEvents.bind(this)),this._zoomendThis||(this._zoomendThis=this._zoomend.bind(this)),this._emptyIdentifyThis||(this._emptyIdentifyThis=this._emptyIdentify.bind(this)),t.options.supportPluginEvent?this.on("identifyempty",this._emptyIdentifyThis):r.DomUtil.on(e,ms.join(" "),this._identifyBaseObjectEventsThis,this),this._needsUpdate=!0,this._animationBaseObjectMap||(this._animationBaseObjectMap={}),t.on("zooming zoomend",this._zoomendThis,this),this}onRemove(){super.onRemove();const t=this.map||this.getMap();if(!t)return this;const e=this._getGeometryEventMapPanel();return t.options.supportPluginEvent?this.off("identifyempty",this._emptyIdentifyThis):r.DomUtil.off(e,ms.join(" "),this._identifyBaseObjectEventsThis,this),t.off("zooming zoomend",this._zoomendThis,this),this}_addBaseObjectsWhenInit(){return this.addMesh(this._meshes),this}_callbackBaseObjectAnimation(){const t=this;if(t._animationBaseObjectMap)for(const e in t._animationBaseObjectMap){t._animationBaseObjectMap[e]._animation()}return this}_getFovRatio(){const t=this.getMap().getFov();return Math.tan(t/2*ys)}}Os.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,geometryEvents:!0,identifyCountOnEvent:0,forceRenderOnZooming:!0,loopRenderCount:50});const As={bloom:!0};class Ss extends r.renderer.CanvasLayerRenderer{constructor(){super(...arguments),this._renderTime=0,this._renderTarget=null}getPrepareParams(){return[this.scene,this.camera]}getDrawParams(){return[this.scene,this.camera]}_drawLayer(){super._drawLayer.apply(this,arguments)}hitDetect(){return!1}createCanvas(){super.createCanvas(),this.createContext()}createContext(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap();else{const t=this.layer.options.glOptions||{alpha:!0,depth:!0,antialias:!0,stencil:!0,preserveDrawingBuffer:!1};t.preserveDrawingBuffer=!0,this.gl=this.gl||this._createGLContext(this.canvas,t)}this._initThreeRenderer(),this.layer.onCanvasCreate(this.context,this.scene,this.camera)}_initThreeRenderer(){this.matrix4=new s.Matrix4;const t=new s.WebGLRenderer({context:this.gl,alpha:!0});t.autoClear=!1,t.setClearColor(new s.Color(1,1,1),0),t.setSize(this.canvas.width,this.canvas.height),t.clear(),this.context=t;const e=this.scene=new s.Scene,n=this.layer.getMap(),i=n.getFov()*Math.PI/180,r=this.camera=new s.PerspectiveCamera(i,n.width/n.height,n.cameraNear,n.cameraFar);r.matrixAutoUpdate=!1,this._syncCamera(),e.add(r),this.pick=new Qi(this.layer),on.star(),this.layer._addBaseObjectsWhenInit()}onCanvasCreate(){super.onCanvasCreate()}resizeCanvas(t){if(!this.canvas)return;let e,n=this.getMap();e=t||n.getSize();const i=n.getDevicePixelRatio?n.getDevicePixelRatio():r.Browser.retina?2:1,s=this.canvas,{width:o,height:a,cssWidth:h,cssHeight:c}=r.Util.calCanvasSize(e,i);if(!this.layer._canvas||s.style.width===h&&s.style.height===c||(s.style.width=h,s.style.height=c),s.width===o&&s.height===a)return this;s.width=o,s.height=a,this.context.setSize(s.width,s.height)}clearCanvas(){this.canvas&&this.context.clear()}prepareCanvas(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null}renderScene(t){if(this.layer._callbackBaseObjectAnimation(),this._syncCamera(),t&&t.renderTarget){const{width:e,height:n}=t.renderTarget.fbo;this._renderTarget?(this._renderTarget.viewport.set(0,0,e,n),this._renderTarget.scissor.set(0,0,e,n)):(this._renderTarget=new s.WebGLRenderTarget(e,n,{depthBuffer:!1}),this.context.setRenderTarget(this._renderTarget),this.context.render(this.scene,this.camera));const i=this.context.properties.get(this._renderTarget),r=i[Ms];i[Ms]=t.renderTarget.getFramebuffer(t.renderTarget.fbo),this.context.setRenderTarget(this._renderTarget);const o=1===t.bloom&&t.sceneFilter,a=this.scene.children||[];let h=!1;if(o){const e=t.sceneFilter;h=e(As);for(let t=0,n=a.length;t<n;t++){if(!a[t]||!a[t].layers)continue;const n=a[t].__parent;a[t].bloom=!1,n&&(a[t].bloom=n.bloom);let i=0;(a[t]&&e(a[t])||!n)&&h&&(i=1),a[t].__layer!==i&&(js(a[t],i),a[t].__layer=i)}}else for(let t=0,e=a.length;t<e;t++)a[t]&&a[t].layers&&0!==a[t].__layer&&(js(a[t],0),a[t].__layer=0);this.camera.layers.set(h?1:0),this.context.render(this.scene,this.camera),i[Ms]=r}else{const{width:t,height:e}=this.canvas,n=this.context.getViewport(zs);n.width===t&&n.height===e||this.context.setViewport(0,0,t,e),this.context.render(this.scene,this.camera)}this.context.setRenderTarget(null),this.completeRender()}remove(){delete this._drawContext,this._renderTarget&&(this._renderTarget.dispose(),delete this._renderTarget),super.remove()}_syncCamera(){const t=this.getMap(),e=this.camera;e.matrix.elements=t.cameraWorldMatrix,e.projectionMatrix.elements=t.projMatrix,this.matrix4.invert?e.projectionMatrixInverse.elements=this.matrix4.copy(e.projectionMatrix).invert().elements:e.projectionMatrixInverse&&(e.projectionMatrixInverse.elements=this.matrix4.getInverse(e.projectionMatrix).elements)}_createGLContext(t,e){const n=["webgl2","webgl","experimental-webgl"];let i=null;for(let r=0;r<n.length;++r){try{i=t.getContext(n[r],e)}catch(t){}if(i)break}return i}}function js(t,e){if(!t)return;t.layers&&t.layers.set(e);const n=t.children;if(n&&n.length)for(let t=0,i=n.length;t<i;t++)js(n[t],e)}function Cs(t){return t.getGLRes?t.getGLRes():t.getGLZoom()}function ks(t,e,n,i){return t.coordToPointAtRes?t.coordToPointAtRes(e,n,i):t.coordinateToPoint(e,n,i)}Os.registerRenderer("gl",Ss),r.registerWorkerAdapter&&(r.registerWorkerAdapter("__maptalks.three__",'(function(t){"use strict";\n/*!\n   * poly-extrude v0.16.0\n    */function n(t,n){for(var i=0;i<n.length;i++){var e=n[i];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}function i(t,n){return i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,n){return t.__proto__=n,t},i(t,n)}function e(t,n,i){void 0===i&&(i=2);var e,s,h,a=n&&n.length,u=a?n[0]*i:t.length,c=r(t,0,u,i,!0),x=[];if(!c||c.next===c.prev)return x;if(a&&(c=function(t,n,i,e){for(var s=[],o=0,h=n.length;o<h;o++){var a=r(t,n[o]*e,o<h-1?n[o+1]*e:t.length,e,!1);a===a.next&&(a.steiner=!0),s.push(d(a))}s.sort(l);for(var u=0;u<s.length;u++)i=f(s[u],i);return i}(t,n,c,i)),t.length>80*i){e=1/0,s=1/0;for(var y=-1/0,p=-1/0,v=i;v<u;v+=i){var g=t[v],_=t[v+1];g<e&&(e=g),_<s&&(s=_),g>y&&(y=g),_>p&&(p=_)}h=0!==(h=Math.max(y-e,p-s))?32767/h:0}return o(c,x,i,e,s,h,0),x}function r(t,n,i,e,r){var s;if(r===function(t,n,i,e){for(var r=0,s=n,o=i-e;s<i;s+=e)r+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return r}(t,n,i,e)>0)for(var o=n;o<i;o+=e)s=P(o/e|0,t[o],t[o+1],s);else for(var h=i-e;h>=n;h-=e)s=P(h/e|0,t[h],t[h+1],s);return s&&m(s,s.next)&&(S(s),s=s.next),s}function s(t,n){if(!t)return t;n||(n=t);var i,e=t;do{if(i=!1,e.steiner||!m(e,e.next)&&0!==_(e.prev,e,e.next))e=e.next;else{if(S(e),(e=n=e.prev)===e.next)break;i=!0}}while(i||e!==n);return n}function o(t,n,i,e,r,l,f){if(t){!f&&l&&function(t,n,i,e){var r=t;do{0===r.z&&(r.z=y(r.x,r.y,n,i,e)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var n,i=1;do{var e=t,r=void 0;t=null;var s=null;for(n=0;e;){n++;for(var o=e,h=0,a=0;a<i&&(h++,o=o.nextZ);a++);for(var u=i;h>0||u>0&&o;)0!==h&&(0===u||!o||e.z<=o.z)?(r=e,e=e.nextZ,h--):(r=o,o=o.nextZ,u--),s?s.nextZ=r:t=r,r.prevZ=s,s=r;e=o}s.nextZ=null,i*=2}while(n>1)}(r)}(t,e,r,l);for(var x=t;t.prev!==t.next;){var d=t.prev,p=t.next;if(l?a(t,e,r,l):h(t))n.push(d.i,t.i,p.i),S(t),t=p.next,x=p.next;else if((t=p)===x){f?1===f?o(t=u(s(t),n),n,i,e,r,l,2):2===f&&c(t,n,i,e,r,l):o(s(t),n,i,e,r,l,1);break}}}}function h(t){var n=t.prev,i=t,e=t.next;if(_(n,i,e)>=0)return!1;for(var r=n.x,s=i.x,o=e.x,h=n.y,a=i.y,u=e.y,c=Math.min(r,s,o),l=Math.min(h,a,u),f=Math.max(r,s,o),x=Math.max(h,a,u),y=e.next;y!==n;){if(y.x>=c&&y.x<=f&&y.y>=l&&y.y<=x&&v(r,h,s,a,o,u,y.x,y.y)&&_(y.prev,y,y.next)>=0)return!1;y=y.next}return!0}function a(t,n,i,e){var r=t.prev,s=t,o=t.next;if(_(r,s,o)>=0)return!1;for(var h=r.x,a=s.x,u=o.x,c=r.y,l=s.y,f=o.y,x=Math.min(h,a,u),d=Math.min(c,l,f),p=Math.max(h,a,u),g=Math.max(c,l,f),m=y(x,d,n,i,e),z=y(p,g,n,i,e),w=t.prevZ,M=t.nextZ;w&&w.z>=m&&M&&M.z<=z;){if(w.x>=x&&w.x<=p&&w.y>=d&&w.y<=g&&w!==r&&w!==o&&v(h,c,a,l,u,f,w.x,w.y)&&_(w.prev,w,w.next)>=0)return!1;if(w=w.prevZ,M.x>=x&&M.x<=p&&M.y>=d&&M.y<=g&&M!==r&&M!==o&&v(h,c,a,l,u,f,M.x,M.y)&&_(M.prev,M,M.next)>=0)return!1;M=M.nextZ}for(;w&&w.z>=m;){if(w.x>=x&&w.x<=p&&w.y>=d&&w.y<=g&&w!==r&&w!==o&&v(h,c,a,l,u,f,w.x,w.y)&&_(w.prev,w,w.next)>=0)return!1;w=w.prevZ}for(;M&&M.z<=z;){if(M.x>=x&&M.x<=p&&M.y>=d&&M.y<=g&&M!==r&&M!==o&&v(h,c,a,l,u,f,M.x,M.y)&&_(M.prev,M,M.next)>=0)return!1;M=M.nextZ}return!0}function u(t,n){var i=t;do{var e=i.prev,r=i.next.next;!m(e,r)&&z(e,i,i.next,r)&&b(e,r)&&b(r,e)&&(n.push(e.i,i.i,r.i),S(i),S(i.next),i=t=r),i=i.next}while(i!==t);return s(i)}function c(t,n,i,e,r,h){var a=t;do{for(var u=a.next.next;u!==a.prev;){if(a.i!==u.i&&g(a,u)){var c=A(a,u);return a=s(a,a.next),c=s(c,c.next),o(a,n,i,e,r,h,0),void o(c,n,i,e,r,h,0)}u=u.next}a=a.next}while(a!==t)}function l(t,n){var i=t.x-n.x;0===i&&(0===(i=t.y-n.y)&&(i=(t.next.y-t.y)/(t.next.x-t.x)-(n.next.y-n.y)/(n.next.x-n.x)));return i}function f(t,n){var i=function(t,n){var i,e=n,r=t.x,s=t.y,o=-1/0;if(m(t,e))return e;do{if(m(t,e.next))return e.next;if(s<=e.y&&s>=e.next.y&&e.next.y!==e.y){var h=e.x+(s-e.y)*(e.next.x-e.x)/(e.next.y-e.y);if(h<=r&&h>o&&(o=h,i=e.x<e.next.x?e:e.next,h===r))return i}e=e.next}while(e!==n);if(!i)return null;var a=i,u=i.x,c=i.y,l=1/0;e=i;do{if(r>=e.x&&e.x>=u&&r!==e.x&&p(s<c?r:o,s,u,c,s<c?o:r,s,e.x,e.y)){var f=Math.abs(s-e.y)/(r-e.x);b(e,t)&&(f<l||f===l&&(e.x>i.x||e.x===i.x&&x(i,e)))&&(i=e,l=f)}e=e.next}while(e!==a);return i}(t,n);if(!i)return n;var e=A(i,t);return s(e,e.next),s(i,i.next)}function x(t,n){return _(t.prev,t,n.prev)<0&&_(n.next,t,t.next)<0}function y(t,n,i,e,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))|(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-e)*r|0)|n<<8))|n<<4))|n<<2))|n<<1))<<1}function d(t){var n=t,i=t;do{(n.x<i.x||n.x===i.x&&n.y<i.y)&&(i=n),n=n.next}while(n!==t);return i}function p(t,n,i,e,r,s,o,h){return(r-o)*(n-h)>=(t-o)*(s-h)&&(t-o)*(e-h)>=(i-o)*(n-h)&&(i-o)*(s-h)>=(r-o)*(e-h)}function v(t,n,i,e,r,s,o,h){return!(t===o&&n===h)&&p(t,n,i,e,r,s,o,h)}function g(t,n){return t.next.i!==n.i&&t.prev.i!==n.i&&!function(t,n){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==n.i&&i.next.i!==n.i&&z(i,i.next,t,n))return!0;i=i.next}while(i!==t);return!1}(t,n)&&(b(t,n)&&b(n,t)&&function(t,n){var i=t,e=!1,r=(t.x+n.x)/2,s=(t.y+n.y)/2;do{i.y>s!=i.next.y>s&&i.next.y!==i.y&&r<(i.next.x-i.x)*(s-i.y)/(i.next.y-i.y)+i.x&&(e=!e),i=i.next}while(i!==t);return e}(t,n)&&(_(t.prev,t,n.prev)||_(t,n.prev,n))||m(t,n)&&_(t.prev,t,t.next)>0&&_(n.prev,n,n.next)>0)}function _(t,n,i){return(n.y-t.y)*(i.x-n.x)-(n.x-t.x)*(i.y-n.y)}function m(t,n){return t.x===n.x&&t.y===n.y}function z(t,n,i,e){var r=M(_(t,n,i)),s=M(_(t,n,e)),o=M(_(i,e,t)),h=M(_(i,e,n));return r!==s&&o!==h||(!(0!==r||!w(t,i,n))||(!(0!==s||!w(t,e,n))||(!(0!==o||!w(i,t,e))||!(0!==h||!w(i,n,e)))))}function w(t,n,i){return n.x<=Math.max(t.x,i.x)&&n.x>=Math.min(t.x,i.x)&&n.y<=Math.max(t.y,i.y)&&n.y>=Math.min(t.y,i.y)}function M(t){return t>0?1:t<0?-1:0}function b(t,n){return _(t.prev,t,t.next)<0?_(t,n,t.next)>=0&&_(t,t.prev,n)>=0:_(t,n,t.prev)<0||_(t,t.next,n)<0}function A(t,n){var i=C(t.i,t.x,t.y),e=C(n.i,n.x,n.y),r=t.next,s=n.prev;return t.next=n,n.prev=t,i.next=r,r.prev=i,e.next=i,i.prev=e,s.next=e,e.prev=s,e}function P(t,n,i,e){var r=C(t,n,i);return e?(r.next=e.next,r.prev=e,e.next.prev=r,e.next=r):(r.prev=r,r.next=r),r}function S(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function C(t,n,i){return{i:t,x:n,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}var k=new(function(){function t(t,n,i,e){void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===e&&(e=1),this.isQuaternion=!0,this._x=t,this._y=n,this._z=i,this._w=e}t.slerpFlat=function(t,n,i,e,r,s,o){var h=i[e+0],a=i[e+1],u=i[e+2],c=i[e+3],l=r[s+0],f=r[s+1],x=r[s+2],y=r[s+3];if(0===o)return t[n+0]=h,t[n+1]=a,t[n+2]=u,void(t[n+3]=c);if(1===o)return t[n+0]=l,t[n+1]=f,t[n+2]=x,void(t[n+3]=y);if(c!==y||h!==l||a!==f||u!==x){var d=1-o,p=h*l+a*f+u*x+c*y,v=p>=0?1:-1,g=1-p*p;if(g>Number.EPSILON){var _=Math.sqrt(g),m=Math.atan2(_,p*v);d=Math.sin(d*m)/_,o=Math.sin(o*m)/_}var z=o*v;if(h=h*d+l*z,a=a*d+f*z,u=u*d+x*z,c=c*d+y*z,d===1-o){var w=1/Math.sqrt(h*h+a*a+u*u+c*c);h*=w,a*=w,u*=w,c*=w}}t[n]=h,t[n+1]=a,t[n+2]=u,t[n+3]=c},t.multiplyQuaternionsFlat=function(t,n,i,e,r,s){var o=i[e],h=i[e+1],a=i[e+2],u=i[e+3],c=r[s],l=r[s+1],f=r[s+2],x=r[s+3];return t[n]=o*x+u*c+h*f-a*l,t[n+1]=h*x+u*l+a*c-o*f,t[n+2]=a*x+u*f+o*l-h*c,t[n+3]=u*x-o*c-h*l-a*f,t};var i,e,r,s=t.prototype;return s.set=function(t,n,i,e){return this._x=t,this._y=n,this._z=i,this._w=e,this._onChangeCallback(),this},s.clone=function(){return new this.constructor(this._x,this._y,this._z,this._w)},s.copy=function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this},s.setFromEuler=function(t,n){void 0===n&&(n=!0);var i=t._x,e=t._y,r=t._z,s=t._order,o=Math.cos,h=Math.sin,a=o(i/2),u=o(e/2),c=o(r/2),l=h(i/2),f=h(e/2),x=h(r/2);switch(s){case"XYZ":this._x=l*u*c+a*f*x,this._y=a*f*c-l*u*x,this._z=a*u*x+l*f*c,this._w=a*u*c-l*f*x;break;case"YXZ":this._x=l*u*c+a*f*x,this._y=a*f*c-l*u*x,this._z=a*u*x-l*f*c,this._w=a*u*c+l*f*x;break;case"ZXY":this._x=l*u*c-a*f*x,this._y=a*f*c+l*u*x,this._z=a*u*x+l*f*c,this._w=a*u*c-l*f*x;break;case"ZYX":this._x=l*u*c-a*f*x,this._y=a*f*c+l*u*x,this._z=a*u*x-l*f*c,this._w=a*u*c+l*f*x;break;case"YZX":this._x=l*u*c+a*f*x,this._y=a*f*c+l*u*x,this._z=a*u*x-l*f*c,this._w=a*u*c-l*f*x;break;case"XZY":this._x=l*u*c-a*f*x,this._y=a*f*c-l*u*x,this._z=a*u*x+l*f*c,this._w=a*u*c+l*f*x;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+s)}return!0===n&&this._onChangeCallback(),this},s.setFromAxisAngle=function(t,n){var i=n/2,e=Math.sin(i);return this._x=t.x*e,this._y=t.y*e,this._z=t.z*e,this._w=Math.cos(i),this._onChangeCallback(),this},s.setFromRotationMatrix=function(t){var n=t.elements,i=n[0],e=n[4],r=n[8],s=n[1],o=n[5],h=n[9],a=n[2],u=n[6],c=n[10],l=i+o+c;if(l>0){var f=.5/Math.sqrt(l+1);this._w=.25/f,this._x=(u-h)*f,this._y=(r-a)*f,this._z=(s-e)*f}else if(i>o&&i>c){var x=2*Math.sqrt(1+i-o-c);this._w=(u-h)/x,this._x=.25*x,this._y=(e+s)/x,this._z=(r+a)/x}else if(o>c){var y=2*Math.sqrt(1+o-i-c);this._w=(r-a)/y,this._x=(e+s)/y,this._y=.25*y,this._z=(h+u)/y}else{var d=2*Math.sqrt(1+c-i-o);this._w=(s-e)/d,this._x=(r+a)/d,this._y=(h+u)/d,this._z=.25*d}return this._onChangeCallback(),this},s.setFromUnitVectors=function(t,n){var i=t.dot(n)+1;return i<Number.EPSILON?(i=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=i):(this._x=0,this._y=-t.z,this._z=t.y,this._w=i)):(this._x=t.y*n.z-t.z*n.y,this._y=t.z*n.x-t.x*n.z,this._z=t.x*n.y-t.y*n.x,this._w=i),this.normalize()},s.rotateTowards=function(t,n){var i=this.angleTo(t);if(0===i)return this;var e=Math.min(1,n/i);return this.slerp(t,e),this},s.identity=function(){return this.set(0,0,0,1)},s.invert=function(){return this.conjugate()},s.conjugate=function(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this},s.dot=function(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w},s.lengthSq=function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},s.length=function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},s.normalize=function(){var t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this},s.multiply=function(t){return this.multiplyQuaternions(this,t)},s.premultiply=function(t){return this.multiplyQuaternions(t,this)},s.multiplyQuaternions=function(t,n){var i=t._x,e=t._y,r=t._z,s=t._w,o=n._x,h=n._y,a=n._z,u=n._w;return this._x=i*u+s*o+e*a-r*h,this._y=e*u+s*h+r*o-i*a,this._z=r*u+s*a+i*h-e*o,this._w=s*u-i*o-e*h-r*a,this._onChangeCallback(),this},s.slerp=function(t,n){if(0===n)return this;if(1===n)return this.copy(t);var i=this._x,e=this._y,r=this._z,s=this._w,o=s*t._w+i*t._x+e*t._y+r*t._z;if(o<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,o=-o):this.copy(t),o>=1)return this._w=s,this._x=i,this._y=e,this._z=r,this;var h=1-o*o;if(h<=Number.EPSILON){var a=1-n;return this._w=a*s+n*this._w,this._x=a*i+n*this._x,this._y=a*e+n*this._y,this._z=a*r+n*this._z,this.normalize(),this}var u=Math.sqrt(h),c=Math.atan2(u,o),l=Math.sin((1-n)*c)/u,f=Math.sin(n*c)/u;return this._w=s*l+this._w*f,this._x=i*l+this._x*f,this._y=e*l+this._y*f,this._z=r*l+this._z*f,this._onChangeCallback(),this},s.slerpQuaternions=function(t,n,i){return this.copy(t).slerp(n,i)},s.random=function(){var t=2*Math.PI*Math.random(),n=2*Math.PI*Math.random(),i=Math.random(),e=Math.sqrt(1-i),r=Math.sqrt(i);return this.set(e*Math.sin(t),e*Math.cos(t),r*Math.sin(n),r*Math.cos(n))},s.equals=function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w},s.fromArray=function(t,n){return void 0===n&&(n=0),this._x=t[n],this._y=t[n+1],this._z=t[n+2],this._w=t[n+3],this._onChangeCallback(),this},s.toArray=function(t,n){return void 0===t&&(t=[]),void 0===n&&(n=0),t[n]=this._x,t[n+1]=this._y,t[n+2]=this._z,t[n+3]=this._w,t},s.fromBufferAttribute=function(t,n){return this._x=t.getX(n),this._y=t.getY(n),this._z=t.getZ(n),this._w=t.getW(n),this._onChangeCallback(),this},s.toJSON=function(){return this.toArray()},s._onChange=function(t){return this._onChangeCallback=t,this},s._onChangeCallback=function(){},i=t,(e=[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onChangeCallback()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onChangeCallback()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this._onChangeCallback()}},{key:"w",get:function(){return this._w},set:function(t){this._w=t,this._onChangeCallback()}}])&&n(i.prototype,e),r&&n(i,r),Object.defineProperty(i,"prototype",{writable:!1}),t}()),V=function(){function t(t,n,i){void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=t,this.y=n,this.z=i}var n=t.prototype;return n.set=function(t,n,i){return void 0===i&&(i=this.z),this.x=t,this.y=n,this.z=i,this},n.clone=function(){return new this.constructor(this.x,this.y,this.z)},n.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},n.addScalar=function(t){return this.x+=t,this.y+=t,this.z+=t,this},n.addVectors=function(t,n){return this.x=t.x+n.x,this.y=t.y+n.y,this.z=t.z+n.z,this},n.addScaledVector=function(t,n){return this.x+=t.x*n,this.y+=t.y*n,this.z+=t.z*n,this},n.sub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},n.subScalar=function(t){return this.x-=t,this.y-=t,this.z-=t,this},n.subVectors=function(t,n){return this.x=t.x-n.x,this.y=t.y-n.y,this.z=t.z-n.z,this},n.multiply=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},n.multiplyScalar=function(t){return this.x*=t,this.y*=t,this.z*=t,this},n.multiplyVectors=function(t,n){return this.x=t.x*n.x,this.y=t.y*n.y,this.z=t.z*n.z,this},n.applyAxisAngle=function(t,n){return this.applyQuaternion(k.setFromAxisAngle(t,n))},n.applyMatrix4=function(t){var n=this.x,i=this.y,e=this.z,r=t.elements,s=1/(r[3]*n+r[7]*i+r[11]*e+r[15]);return this.x=(r[0]*n+r[4]*i+r[8]*e+r[12])*s,this.y=(r[1]*n+r[5]*i+r[9]*e+r[13])*s,this.z=(r[2]*n+r[6]*i+r[10]*e+r[14])*s,this},n.applyQuaternion=function(t){var n=this.x,i=this.y,e=this.z,r=t.x,s=t.y,o=t.z,h=t.w,a=h*n+s*e-o*i,u=h*i+o*n-r*e,c=h*e+r*i-s*n,l=-r*n-s*i-o*e;return this.x=a*h+l*-r+u*-o-c*-s,this.y=u*h+l*-s+c*-r-a*-o,this.z=c*h+l*-o+a*-s-u*-r,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},n.divideScalar=function(t){return this.multiplyScalar(1/t)},n.min=function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this},n.max=function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this},n.clamp=function(t,n){return this.x=Math.max(t.x,Math.min(n.x,this.x)),this.y=Math.max(t.y,Math.min(n.y,this.y)),this.z=Math.max(t.z,Math.min(n.z,this.z)),this},n.clampScalar=function(t,n){return this.x=Math.max(t,Math.min(n,this.x)),this.y=Math.max(t,Math.min(n,this.y)),this.z=Math.max(t,Math.min(n,this.z)),this},n.clampLength=function(t,n){var i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(n,i)))},n.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},n.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.normalize=function(){return this.divideScalar(this.length()||1)},n.setLength=function(t){return this.normalize().multiplyScalar(t)},n.lerp=function(t,n){return this.x+=(t.x-this.x)*n,this.y+=(t.y-this.y)*n,this.z+=(t.z-this.z)*n,this},n.lerpVectors=function(t,n,i){return this.x=t.x+(n.x-t.x)*i,this.y=t.y+(n.y-t.y)*i,this.z=t.z+(n.z-t.z)*i,this},n.cross=function(t){return this.crossVectors(this,t)},n.crossVectors=function(t,n){var i=t.x,e=t.y,r=t.z,s=n.x,o=n.y,h=n.z;return this.x=e*h-r*o,this.y=r*s-i*h,this.z=i*o-e*s,this},n.distanceTo=function(t){return Math.sqrt(this.distanceToSquared(t))},n.equals=function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},n.fromArray=function(t,n){return void 0===n&&(n=0),this.x=t[n],this.y=t[n+1],this.z=t[n+2],this},n.random=function(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this},t}();function Z(t){let n,i,e=0,r=1;const s=t.length;for(;r<s;)n=i||t[0],i=t[r],e+=(i[0]-n[0])*(i[1]+n[1]),r++;return e>0}function F(t,n,i){return t[0]=n[0]-i[0],t[1]=n[1]-i[1],t[2]=n[2]-i[2],t}function L(t,n){const i=n[0],e=n[1],r=n[2],s=Math.sqrt(i*i+e*e+r*r)||1;return t[0]=i/s,t[1]=e/s,t[2]=r/s,t}function q(t,n,i){const e=n[0],r=n[1],s=n[2],o=i[0],h=i[1],a=i[2];return t[0]=r*a-s*h,t[1]=s*o-e*a,t[2]=e*h-r*o,t}function E(t,n){function i(t,n,i,e){t[0]=n,t[1]=i,t[2]=e}const e=[],r=[],s=[],o=[],h=[],a=[],u=t.length,c=new Float32Array(n.length);let l=0;for(;l<u;){const u=3*t[l],f=3*t[l+1],x=3*t[l+2];i(e,n[u],n[u+1],n[u+2]),i(r,n[f],n[f+1],n[f+2]),i(s,n[x],n[x+1],n[x+2]),F(h,s,r),F(o,e,r),q(a,h,o);for(let t=0;t<3;t++)c[u+t]+=a[t],c[f+t]+=a[t],c[x+t]+=a[t];l+=3}let f=0;const x=c.length;for(;f<x;)i(a,c[f],c[f+1],c[f+2]),L(a,a),c[f]=a[0]||0,c[f+1]=a[1]||0,c[f+2]=a[2]||0,f+=3;return c}function I(t){if(1===t.length){return{position:t[0].position,normal:t[0].normal,uv:t[0].uv,indices:t[0].indices,results:t}}let n=0,i=0;for(let e=0,r=t.length;e<r;e++){const{position:r,indices:s}=t[e];n+=r.length,i+=s.length}const e={position:new Float32Array(n),normal:new Float32Array(n),uv:new Float32Array(n/3*2),indices:new Uint32Array(i),results:t};let r=0,s=0,o=0,h=0;for(let n=0,i=t.length;n<i;n++){const{position:i,indices:a,normal:u,uv:c}=t[n];e.position.set(i,r),e.normal.set(u,r),e.uv.set(c,h);let l=0;const f=a.length;for(;l<f;){const t=a[l]+s;e.indices[o]=t,o++,l++}h+=c.length,r+=i.length,s+=i.length/3}return e}function O(t){return 180*t/Math.PI}function U(t){return t/180*Math.PI}function N(t,n,i,e,r,s){const o=3*i,h=3*e,a=3*r,u=3*s,c=n[o],l=n[o+1],f=n[o+2],x=n[h],y=n[h+1],d=n[h+2],p=n[a],v=n[a+1],g=n[a+2],_=n[u],m=n[u+1],z=n[u+2];let w=t.length-1;Math.abs(l-y)<Math.abs(c-x)?(t[++w]=c,t[++w]=1-f,t[++w]=x,t[++w]=1-d,t[++w]=p,t[++w]=1-g,t[++w]=_,t[++w]=1-z):(t[++w]=l,t[++w]=1-f,t[++w]=y,t[++w]=1-d,t[++w]=v,t[++w]=1-g,t[++w]=m,t[++w]=1-z)}function j(t,n){n=Object.assign({},{depth:2,top:!0},n);const i=t.map((t=>{for(let n=0,i=t.length;n<i;n++){const i=t[n];Q(i),0===n?Z(i)||(t[n]=i.reverse()):Z(i)&&(t[n]=i.reverse()),R(i)&&i.splice(i.length-1,1)}const i=function(t,n){const i=function(t){let n=0,i=0;const e=t.length;for(;i<e;)n+=t[i].length,i++;return n}(t),e=t.length,r=[],s=new Float32Array(2*i),o=[],h=[],a=3*i,u=2*i,c=n.depth;let l=0,f=0,x=0;for(let n=0;n<e;n++){const i=t[n];n>0&&r.push(l/2);let e=0;const y=i.length;for(;e<y;){const t=i[e],n=t[0],r=t[1],y=t[2]||0;s[l++]=n,s[l++]=r,o[f]=n,o[f+1]=r,o[f+2]=c+y,o[a+f]=n,o[a+f+1]=r,o[a+f+2]=y,h[x]=n,h[x+1]=r,h[u+x]=n,h[u+x+1]=r,f+=3,x+=2,e++}}return{flatVertices:s,holes:r,points:o,count:i,uv:h}}(t,n);i.polygon=t;return function(t,n,i){const e=[],{count:r}=t,s=i.top;for(let t=0,i=n.length;t<i;t+=3){const o=n[t],h=n[t+1],a=n[t+2];s&&(e[t]=o,e[t+1]=h,e[t+2]=a);let u=i+t;const c=r+o,l=r+h,f=r+a;s||(u=t),e[u]=c,e[u+1]=l,e[u+2]=f}t.indices=e}(i,e(i.flatVertices,i.holes,2),n),function(t,n){const{points:i,indices:e,polygon:r,uv:s}=t,o=n.depth;let h=i.length-1,a=e.length-1;for(let t=0,n=r.length;t<n;t++){const n=r[t];let u=0;const c=n.length;for(;u<c;){const t=n[u];let r=n[u+1];u===c-1&&(r=n[0]);const l=i.length/3,f=t[0],x=t[1],y=t[2]||0,d=r[0],p=r[1],v=r[2]||0;i[++h]=f,i[++h]=x,i[++h]=y+o,i[++h]=d,i[++h]=p,i[++h]=v+o,i[++h]=f,i[++h]=x,i[++h]=y,i[++h]=d,i[++h]=p,i[++h]=v;const g=l+2,_=l+3,m=l,z=l+1;e[++a]=g,e[++a]=m,e[++a]=_,e[++a]=m,e[++a]=z,e[++a]=_,N(s,i,g,_,m,z),u++}}}(i,n),i.position=new Float32Array(i.points),i.indices=new Uint32Array(i.indices),i.uv=new Float32Array(i.uv),i.normal=E(i.indices,i.position),i})),r=I(i);return r.polygons=t,r}function Q(t){R(t)||t.push(t[0])}function R(t){const n=t.length,[i,e]=t[0],[r,s]=t[n-1];return i===r&&e===s}function W(t,n){!function(t){t.lineWidth=Math.max(0,t.lineWidth),t.depth=Math.max(0,t.depth),t.sideDepth=Math.max(0,t.sideDepth)}(n=Object.assign({},{depth:2,lineWidth:1,bottomStickGround:!1,pathUV:!1},n));const i=t.map((t=>{const i=function(t,n){let i=n.lineWidth/2;n.isSlope&&(i*=2);const e=[],r=[],s=[],o=t.length;let h=0;for(;h<o;){let n=t[h],a=t[h+1];const u=t[h];h===o-1&&(n=t[o-2],a=t[o-1]);const c=a[1]-n[1],l=a[0]-n[0];let f=0;const x=O(Math.atan(c/l));if(0===h||h===o-1)f=x,f-=90;else{const i=t[h-1];B.x=i[0]-n[0],B.y=i[1]-n[1],T.x=a[0]-n[0],T.y=a[1]-n[1];f=x-H(B,T)/2}const y=U(f),d=u,p=[Math.cos(y)+d[0],Math.sin(y)+d[1]],[v,g]=Y(n,a,i);let _=D(v[0],v[1],d,p),m=D(g[0],g[1],d,p);if(!_||!m){const t=e.length,n=e[t-2],i=e[t-1];if(!n||!i)continue;_=[n[0],n[1]],m=[i[0],i[1]]}_[2]=u[2]||0,m[2]=u[2]||0,e.push(_,m),X(_,n,a)?(r.push(_),s.push(m)):(r.push(m),s.push(_)),h++}return{offsetPoints:e,leftPoints:r,rightPoints:s,line:t}}(t,n);return i.line=t,function(t,n){const i=n.bottomStickGround,e=n.depth,r=t.depths;let s=e,o=e;r&&(s=r[0],o=r[1]);const{leftPoints:h,rightPoints:a}=t,u=t.line,c=n.pathUV;if(c){!function(t){let n=0;for(let i=0,e=t.length;i<e;i++){const e=t[i],r=t[i+1];if(0===i&&(e.distance=0),e&&r){const[t,i,s]=e,[o,h,a]=r,u=t-o,c=i-h,l=(s||0)-(a||0);n+=Math.sqrt(u*u+c*c+l*l),r.distance=n}}}(u);for(let t=0,n=u.length;t<n;t++)h[t].distance=a[t].distance=u[t].distance}let l=0,f=h.length;const x=[],y=[],d=[];for(;l<f;){const t=3*l,[n,e,r]=h[l];x[t]=n,x[t+1]=e,x[t+2]=s+r;const[y,p,v]=a[l],g=3*f+t;x[g]=y,x[g+1]=p,x[g+2]=o+v;const _=2*f*3+t;x[_]=n,x[_+1]=e,x[_+2]=r,i&&(x[_+2]=0);const m=2*f*3+3*f+t;if(x[m]=y,x[m+1]=p,x[m+2]=v,i&&(x[m+2]=0),c){const t=u[l].distance,n=2*l;d[n]=t,d[n+1]=1;const i=2*f+n;d[i]=t,d[i+1]=0;const e=2*f*2+n;d[e]=t,d[e+1]=1;const r=2*f*2+2*f+n;d[r]=t,d[r+1]=0}l++}if(!c){l=0,f=x.length;let t=d.length-1;for(;l<f;){const n=x[l],i=x[l+1];d[++t]=n,d[++t]=i,l+=3}}l=0,f=h.length;let p=y.length-1;for(;l<f-1;){const t=l,n=l+1,i=t+f,e=n+f;y[++p]=t,y[++p]=i,y[++p]=n,y[++p]=i,y[++p]=e,y[++p]=n;const r=l+2*f,s=r+1,o=r+f,h=s+f;y[++p]=r,y[++p]=o,y[++p]=s,y[++p]=o,y[++p]=h,y[++p]=s,l++}if(t.indices=y,t.points=x,t.uv=d,r)for(f=h.length,l=0;l<f;)h[l].depth=s,a[l].depth=o,l++}(i,n),function(t,n){const{points:i,indices:e,leftPoints:r,rightPoints:s,uv:o}=t,h=n.depth,a=n.bottomStickGround,u=[r,s],c=t.depths,l=n.pathUV,f=n.lineWidth;let x=i.length-1,y=e.length-1,d=o.length-1;function p(t,n){const r=i.length/3,s=c?t.depth:h,u=c?n.depth:h;i[++x]=t[0],i[++x]=t[1],i[++x]=s+t[2],i[++x]=n[0],i[++x]=n[1],i[++x]=u+n[2],i[++x]=t[0],i[++x]=t[1],i[++x]=a?0:t[2],i[++x]=n[0],i[++x]=n[1],i[++x]=a?0:n[2];const p=r+2,v=r+3,g=r,_=r+1;e[++y]=p,e[++y]=g,e[++y]=v,e[++y]=g,e[++y]=_,e[++y]=v,l?(o[++d]=t.distance,o[++d]=s/f,o[++d]=n.distance,o[++d]=u/f,o[++d]=t.distance,o[++d]=0,o[++d]=n.distance,o[++d]=0):N(o,i,p,v,g,_)}for(let t=0,n=u.length;t<n;t++){let n=u[t];t>0&&(n=n.map((t=>t)),n=n.reverse());let i=0;const e=n.length-1;for(;i<e;){p(n[i],n[i+1]),i++}}const v=r.length,g=[s[0],r[0],r[v-1],s[v-1]];for(let t=0;t<g.length;t+=2){p(g[t],g[t+1])}}(i,n),i.position=new Float32Array(i.points),i.indices=new Uint32Array(i.indices),i.uv=new Float32Array(i.uv),i.normal=E(i.indices,i.position),i})),e=I(i);return e.lines=t,e}const B={x:0,y:0},T={x:0,y:0};const H=({x:t,y:n},{x:i,y:e})=>{const r=t*i+n*e,s=t*e-n*i;return(Math.atan2(s,r)/Math.PI*180+360)%360};function X(t,n,i){const[e,r]=n,[s,o]=i,[h,a]=t;return(r-o)*h+(s-e)*a+e*o-s*r>0}function Y(t,n,i){const e=n[1]-t[1],r=n[0]-t[0],s=Math.atan2(e,r),o=s+Math.PI/2;let h=Math.cos(o)*i,a=Math.sin(o)*i;const u=[t[0]+h,t[1]+a],c=[n[0]+h,n[1]+a],l=s-Math.PI/2;h=Math.cos(l)*i,a=Math.sin(l)*i;return[[u,c],[[t[0]+h,t[1]+a],[n[0]+h,n[1]+a]]]}function D(t,n,i,e){const r=n[0]-t[0],s=n[1]-t[1],o=e[0]-i[0],h=e[1]-i[1];if(0===r&&0===o)return null;if(0===s&&0===h)return null;const a=s/r,u=h/o,c=t[1]-a*t[0],l=i[1]-u*i[0];let f,x;return 0===r?(f=t[0],x=u*f+l):0===o?(f=i[0],x=a*f+c):0===s?(x=t[1],f=(x-l)/u):0===h?(x=i[1],f=(x-c)/a):(f=(l-c)/(a-u),x=a*f+c),[f,x]}function G(t,n){n=Object.assign({},{radius:1,height:2,radialSegments:6},n);const i=Math.round(Math.max(4,n.radialSegments));let{radius:e,height:r}=n;e=e,r=r;const s=360/i/360*Math.PI*2,o=i+1,h=new Float32Array(3*o*2),[a,u]=t;let c=0,l=0;const f=3*o,x=2*o,y=[],d=[];let p=y.length-1;for(let t=-1;t<i;t++){const n=s*t,i=Math.cos(n)*e+a,o=Math.sin(n)*e+u;h[c]=i,h[c+1]=o,h[c+2]=0,h[c+f]=i,h[c+1+f]=o,h[c+2+f]=r;let v=0,g=0;v=.5+i/e/2,g=.5+o/e/2,d[l]=v,d[l+1]=g,d[l+x]=v,d[l+1+x]=g,c+=3,l+=2,t>1&&(y[++p]=0,y[++p]=t-1,y[++p]=t)}c-=3,h[c]=h[0],h[c+1]=h[1],h[c+2]=h[2];const v=h.length;h[v-3]=h[0],h[v-2]=h[1],h[v-1]=r;const g=y.length;p=y.length-1;for(let t=0;t<g;t++){const n=y[t];y[++p]=n+o}const _=new Float32Array(2*(3*o*2-6));let m=-1;c=2*o,l=0,p=y.length-1;let z=d.length-1;for(let t=0,n=h.length/2;t<n-3;t+=3){const n=h[t],i=h[t+1],s=h[t+3],a=h[t+4];_[++m]=n,_[++m]=i,_[++m]=r,_[++m]=s,_[++m]=a,_[++m]=r,_[++m]=n,_[++m]=i,_[++m]=0,_[++m]=s,_[++m]=a,_[++m]=0;const u=c+2,f=c+3,x=c,v=c+1;y[++p]=x,y[++p]=u,y[++p]=v,y[++p]=u,y[++p]=f,y[++p]=v,c+=4;const g=l/o,w=(l+1)/o;d[++z]=g,d[++z]=r/e/2,d[++z]=w,d[++z]=r/e/2,d[++z]=g,d[++z]=0,d[++z]=w,d[++z]=0,l++}const w=new Float32Array(h.length+_.length);w.set(h,0),w.set(_,h.length);const M=E(y,w);return{points:h,indices:new Uint32Array(y),position:w,normal:M,uv:new Float32Array(d)}}var J=function(){function t(){this.pos=new V,this.dir=new V,this.right=new V,this.up=new V,this.dist=0,this.widthScale=1,this.sharp=!1}var n=t.prototype;return n.lerpPathPoints=function(t,n,i){this.pos.lerpVectors(t.pos,n.pos,i),this.dir.lerpVectors(t.dir,n.dir,i),this.up.lerpVectors(t.up,n.up,i),this.right.lerpVectors(t.right,n.right,i),this.dist=(n.dist-t.dist)*i+t.dist,this.widthScale=(n.widthScale-t.widthScale)*i+t.widthScale},n.copy=function(t){this.pos.copy(t.pos),this.dir.copy(t.dir),this.up.copy(t.up),this.right.copy(t.right),this.dist=t.dist,this.widthScale=t.widthScale},t}(),K=function(){function t(t,n,i,e,r,s,o,h,a,u,c,l,f,x,y,d){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,n,i,e,r,s,o,h,a,u,c,l,f,x,y,d)}var n=t.prototype;return n.set=function(t,n,i,e,r,s,o,h,a,u,c,l,f,x,y,d){var p=this.elements;return p[0]=t,p[4]=n,p[8]=i,p[12]=e,p[1]=r,p[5]=s,p[9]=o,p[13]=h,p[2]=a,p[6]=u,p[10]=c,p[14]=l,p[3]=f,p[7]=x,p[11]=y,p[15]=d,this},n.multiply=function(t){return this.multiplyMatrices(this,t)},n.makeRotationAxis=function(t,n){var i=Math.cos(n),e=Math.sin(n),r=1-i,s=t.x,o=t.y,h=t.z,a=r*s,u=r*o;return this.set(a*s+i,a*o-e*h,a*h+e*o,0,a*o+e*h,u*o+i,u*h-e*s,0,a*h-e*o,u*h+e*s,r*h*h+i,0,0,0,0,1),this},n.equals=function(t){for(var n=this.elements,i=t.elements,e=0;e<16;e++)if(n[e]!==i[e])return!1;return!0},t}();function $(t,n,i,e){return function(t,n){var i=1-t;return i*i*n}(t,n)+function(t,n){return 2*(1-t)*t*n}(t,i)+function(t,n){return t*t*n}(t,e)}var tt=function(t){var n,e;function r(n,i,e){var r;return void 0===n&&(n=new V),void 0===i&&(i=new V),void 0===e&&(e=new V),(r=t.call(this)||this).isQuadraticBezierCurve3=!0,r.type="QuadraticBezierCurve3",r.v0=n,r.v1=i,r.v2=e,r}return e=t,(n=r).prototype=Object.create(e.prototype),n.prototype.constructor=n,i(n,e),r.prototype.getPoint=function(t,n){void 0===n&&(n=new V);var i=n,e=this.v0,r=this.v1,s=this.v2;return i.set($(t,e.x,r.x,s.x),$(t,e.y,r.y,s.y),$(t,e.z,r.z,s.z)),i},r}(function(){function t(){this.type="Curve",this.arcLengthDivisions=200}var n=t.prototype;return n.getPoint=function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},n.getPointAt=function(t,n){var i=this.getUtoTmapping(t);return this.getPoint(i,n)},n.getPoints=function(t){void 0===t&&(t=5);for(var n=[],i=0;i<=t;i++)n.push(this.getPoint(i/t));return n},n.getLength=function(){var t=this.getLengths();return t[t.length-1]},n.getLengths=function(t){if(void 0===t&&(t=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var n,i=[],e=this.getPoint(0),r=0;i.push(0);for(var s=1;s<=t;s++)r+=(n=this.getPoint(s/t)).distanceTo(e),i.push(r),e=n;return this.cacheArcLengths=i,i},n.getUtoTmapping=function(t,n){var i,e=this.getLengths(),r=0,s=e.length;i=n||t*e[s-1];for(var o,h=0,a=s-1;h<=a;)if((o=e[r=Math.floor(h+(a-h)/2)]-i)<0)h=r+1;else{if(!(o>0)){a=r;break}a=r-1}if(e[r=a]===i)return r/(s-1);var u=e[r];return(r+(i-u)/(e[r+1]-u))/(s-1)},t}()),nt=new V,it=new V,et=new V,rt=new K,st=new tt;var ot=function(){function t(){this.array=[],this.count=0}var n=t.prototype;return n.set=function(t,n,i,e,r){if(void 0===n&&(n=.1),void 0===i&&(i=10),void 0===e&&(e=null),void 0===r&&(r=!1),(t=t.slice(0)).length<2)return console.warn("PathPointList: points length less than 2."),void(this.count=0);r&&!t[0].equals(t[t.length-1])&&t.push((new V).copy(t[0]));for(var s=0,o=t.length;s<o;s++)if(0===s)this._start(t[s],t[s+1],e);else if(s===o-1)if(r){this._corner(t[s],t[1],n,i,e);var h=this.array[0].dist;this.array[0].copy(this.array[this.count-1]),this.array[0].dist=h}else this._end(t[s]);else this._corner(t[s],t[s+1],n,i,e)},n.distance=function(){return this.count>0?this.array[this.count-1].dist:0},n._getByIndex=function(t){return this.array[t]||(this.array[t]=new J),this.array[t]},n._start=function(t,n,i){this.count=0;var e=this._getByIndex(this.count);if(e.pos.copy(t),e.dir.subVectors(n,t),i)e.up.copy(i);else{var r=Number.MAX_VALUE,s=Math.abs(e.dir.x),o=Math.abs(e.dir.y),h=Math.abs(e.dir.z);s<r&&(r=s,e.up.set(1,0,0)),o<r&&(r=o,e.up.set(0,1,0)),h<r&&e.up.set(0,0,1)}e.right.crossVectors(e.dir,e.up).normalize(),e.up.crossVectors(e.right,e.dir).normalize(),e.dist=0,e.widthScale=1,e.sharp=!1,e.dir.normalize(),this.count++},n._end=function(t){var n=this.array[this.count-1],i=this._getByIndex(this.count);i.pos.copy(t),i.dir.subVectors(t,n.pos);var e=i.dir.length();i.dir.normalize(),i.up.copy(n.up);var r=nt.crossVectors(n.dir,i.dir);if(r.length()>Number.EPSILON){r.normalize();var s=Math.acos(Math.min(Math.max(n.dir.dot(i.dir),-1),1));i.up.applyMatrix4(rt.makeRotationAxis(r,s))}i.right.crossVectors(i.dir,i.up).normalize(),i.dist=n.dist+e,i.widthScale=1,i.sharp=!1,this.count++},n._corner=function(t,n,i,e,r){if(i>0&&e>0){for(var s=function(t,n,i,e,r,s){var o=nt.subVectors(n,t),h=it.subVectors(i,n),a=o.length(),u=h.length();o.normalize(),h.normalize();var c=Math.min(.999999*(r?a/2:a),e);s.v0.copy(n).sub(o.multiplyScalar(c)),s.v1.copy(n);var l=Math.min(u/2*.999999,e);return s.v2.copy(n).add(h.multiplyScalar(l)),s}(this.array[this.count-1].pos,t,n,i,this.count-1==0,st),o=s.getPoints(e),h=0;h<e;h++)this._sharpCorner(o[h],o[h+1],r,0===h?1:0);o[e].equals(n)||this._sharpCorner(o[e],n,r,2)}else this._sharpCorner(t,n,r,0,!0)},n._sharpCorner=function(t,n,i,e,r){void 0===e&&(e=0),void 0===r&&(r=!1);var s=this.array[this.count-1],o=this._getByIndex(this.count),h=nt.subVectors(t,s.pos),a=it.subVectors(n,t),u=h.length();if(h.normalize(),a.normalize(),o.pos.copy(t),1===e?o.dir.copy(h):2===e?o.dir.copy(a):(o.dir.addVectors(h,a),o.dir.normalize()),i)1===o.dir.dot(i)?o.right.crossVectors(a,i).normalize():o.right.crossVectors(o.dir,i).normalize(),o.up.crossVectors(o.right,o.dir).normalize();else{o.up.copy(s.up);var c=et.crossVectors(s.dir,o.dir);if(c.length()>Number.EPSILON){c.normalize();var l=Math.acos(Math.min(Math.max(s.dir.dot(o.dir),-1),1));o.up.applyMatrix4(rt.makeRotationAxis(c,l))}o.right.crossVectors(o.dir,o.up).normalize()}o.dist=s.dist+u;var f=h.dot(a);o.widthScale=Math.min(1/Math.sqrt((1+f)/2),1.415)||1,o.sharp=Math.abs(f-1)>.05&&r,this.count++},t}();const ht=new V(0,0,1),at=new V,ut=new V,ct=new V,lt=new V,ft=new V,xt=new V;function yt(t,n){n=Object.assign({},{lineWidth:1,cornerRadius:0,cornerSplit:10},n);const i=t.map((t=>{const i=function(t){const n=[];for(let i=0,e=t.length;i<e;i++){const e=t[i],[r,s,o]=e,h=new V(r,s,o||0);n[i]=h}return n}(t),e=new ot;e.set(i,n.cornerRadius,n.cornerSplit,ht);const r=function(t,n){const i=n.lineWidth||.1,e=1,r=i/2,s=i,o=t.distance(),h=e*o;let a=0;const u=[],c=[],l=[],f=[];let x=0;if(0===o)return{position:u,normal:c,uv:l,indices:f,count:a};const y=r/s;let d,p=u.length-1,v=c.length-1,g=l.length-1,_=f.length-1;function m(t){const n=0===u.length,i=t.sharp&&!n,e=t.dist/s,o=t.dir,h=t.up,d=t.right;if(at.copy(d).multiplyScalar(r*t.widthScale),ut.copy(d).multiplyScalar(-r*t.widthScale),at.add(t.pos),ut.add(t.pos),i){ct.fromArray(u,u.length-6).sub(ut),lt.fromArray(u,u.length-3).sub(at);const t=ct.length()-lt.length();let n,i;t>0?(n=ct,i=ut):(n=lt,i=at),ft.copy(n).setLength(Math.abs(t)).add(i);let r=xt.copy(i).sub(ft).normalize().dot(o)*xt.copy(i).sub(ft).length()*2;xt.copy(o).setLength(r).add(ft),t>0?(u[++p]=ft.x,u[++p]=ft.y,u[++p]=ft.z,u[++p]=at.x,u[++p]=at.y,u[++p]=at.z,u[++p]=ut.x,u[++p]=ut.y,u[++p]=ut.z,u[++p]=at.x,u[++p]=at.y,u[++p]=at.z,u[++p]=xt.x,u[++p]=xt.y,u[++p]=xt.z,u[++p]=at.x,u[++p]=at.y,u[++p]=at.z,x+=6,f[++_]=x-6,f[++_]=x-8,f[++_]=x-7,f[++_]=x-6,f[++_]=x-7,f[++_]=x-5,f[++_]=x-4,f[++_]=x-6,f[++_]=x-5,f[++_]=x-2,f[++_]=x-4,f[++_]=x-1,a+=12):(u[++p]=ut.x,u[++p]=ut.y,u[++p]=ut.z,u[++p]=ft.x,u[++p]=ft.y,u[++p]=ft.z,u[++p]=ut.x,u[++p]=ut.y,u[++p]=ut.z,u[++p]=at.x,u[++p]=at.y,u[++p]=at.z,u[++p]=ut.x,u[++p]=ut.y,u[++p]=ut.z,u[++p]=xt.x,u[++p]=xt.y,u[++p]=xt.z,x+=6,f[++_]=x-6,f[++_]=x-8,f[++_]=x-7,f[++_]=x-6,f[++_]=x-7,f[++_]=x-5,f[++_]=x-6,f[++_]=x-5,f[++_]=x-3,f[++_]=x-2,f[++_]=x-3,f[++_]=x-1,a+=12);for(let t=0;t<6;t++)c[++v]=h.x,c[++v]=h.y,c[++v]=h.z;l[++g]=e-y,l[++g]=0,l[++g]=e-y,l[++g]=1,l[++g]=e,l[++g]=0,l[++g]=e,l[++g]=1,l[++g]=e+y,l[++g]=0,l[++g]=e+y,l[++g]=1}else u[++p]=ut.x,u[++p]=ut.y,u[++p]=ut.z,u[++p]=at.x,u[++p]=at.y,u[++p]=at.z,c[++v]=h.x,c[++v]=h.y,c[++v]=h.z,c[++v]=h.x,c[++v]=h.y,c[++v]=h.z,l[++g]=e,l[++g]=0,l[++g]=e,l[++g]=1,x+=2,n||(f[++_]=x-2,f[++_]=x-4,f[++_]=x-3,f[++_]=x-2,f[++_]=x-3,f[++_]=x-1,a+=6)}if(h>0)for(let n=0;n<t.count;n++){const i=t.array[n];if(i.dist>h){const e=t.array[n-1];d=new J;const r=(h-e.dist)/(i.dist-e.dist);d.lerpPathPoints(e,i,r),m(d);break}m(i)}else d=t.array[0];return{position:u,normal:c,uv:l,indices:f,count:a}}(e,n);return{position:new Float32Array(r.position),indices:new Uint32Array(r.indices),uv:new Float32Array(r.uv),normal:new Float32Array(r.normal),line:t,count:r.count}})),e=I(i);return e.lines=t,e}new V(0,0,1),new V;var dt={x:0,y:0},pt={x:0,y:0};function vt(t,n,i,e){for(var r=t.length,s=0;s<r;s++){var o=t[s].data;n=t[s].center||n;for(var h=0,a=o.length;h<a;h++)for(var u=o[h],c=0,l=u.length;c<l;c++)t[s].data[h][c]=gt(u[c],n,i,e)}}function gt(t,n,i,e,r){for(var s,o=[],h=r?3:2,a=0,u=(s=i?new Float64Array(t):new Float32Array(t)).length;a<u;a+=h){var c=s[a],l=s[a+1],f=s[a+2];if(n&&i&&e){dt.x=c,dt.y=l;var x=kt(dt,pt);dt.x=x.x,dt.y=x.y,c=(x=Vt(e,dt,i,pt)).x,l=x.y,c-=n[0],l-=n[1]}r?o.push([c,l,f]):o.push([c,l])}return o}function _t(t,n){void 0===n&&(n=1);for(var i=t.length,e=[],r=[],s=0,o=0;o<i;o++){var h=void 0;1===n?h=mt(t[o]):2===n?h=zt(t[o]):3===n&&(h=wt(t[o]));var a=t[o].bottomHeight||0,u=h.position;r.push(h);var c=u.length/3;e[o]={position:{middleZ:a+(t[o].height||0)/2,count:c,start:s,end:s+3*c},hide:!1},s+=3*c}var l=bt(r),f=l.position,x=l.normal,y=l.uv,d=l.indices;return{position:f.buffer,normal:x.buffer,uv:y.buffer,indices:d.buffer,geometriesAttributes:e}}function mt(t){var n=t.data,i=t.height,e=t.bottomHeight,r=j(n,{depth:i,top:t.top}),s=r.position,o=r.normal,h=r.uv,a=r.indices;return At(s,e),{position:s,normal:o,uv:h,indices:a}}function zt(t){var n=t.data,i=t.height,e=t.width,r=t.bottomHeight,s=W(n,{lineWidth:e,depth:i,pathUV:t.pathUV}),o=s.position,h=s.normal,a=s.uv,u=s.indices;return At(o,r),{position:o,normal:h,uv:a,indices:u}}function wt(t){var n=t.data,i=t.cornerRadius,e=t.width,r=t.bottomHeight,s=yt(n,{lineWidth:e,cornerRadius:i}),o=s.position,h=s.normal,a=s.uv,u=s.indices;return At(o,r),{position:o,normal:h,uv:a,indices:u}}function Mt(t,n){for(var i=new Float32Array(n),e=0,r=0;r<t.length;++r)i.set(t[r],e),e+=t[r].length;return i}function bt(t){for(var n={},i={},e=0;e<t.length;++e){var r=t[e];for(var s in r)void 0===n[s]&&(n[s]=[],i[s]=0),n[s].push(r[s]),i[s]+=r[s].length}var o={},h=0,a=[];for(var u in n)if("indices"===u)for(var c=n[u],l=0,f=c.length;l<f;l++){for(var x=c[l],y=0,d=x.length;y<d;y++)a.push(x[y]+h);h+=n.position[l].length/3}else{var p=Mt(n[u],i[u]);if(!p)return null;o[u]=p}return o.indices=new Uint32Array(a),o}function At(t,n){if(void 0!==n&&"number"==typeof n&&0!==n)for(var i=0,e=t.length;i<e;i+=3)t[i+2]+=n}function Pt(t){for(var n=[],i=0,e=t.length;i<e;i+=7){var r=t[i],s=t[i+1],o=t[i+2],h=t[i+3],a=t[i+4],u=t[i+5];n.push({radialSegments:o,radius:h,height:a,altitude:u,center:[r,s]})}for(var c=n.length,l=[],f=[],x=0,y=0;y<c;y++){var d=G(n[y].center||[0,0],n[y]),p=d.position;if(n[y].altitude)for(var v=n[y].altitude,g=0,_=p.length;g<_;g+=3)d[g+2]+=v;f.push(d);var m=p.length/3;l[y]={position:{middleZ:n[y].height/2,count:m,start:x,end:x+3*m},hide:!1},x+=3*m}var z=bt(f),w=z.position,M=z.normal,b=z.uv,A=z.indices;return{position:w.buffer,normal:M.buffer,uv:b.buffer,indices:A.buffer,geometriesAttributes:l}}var St=Math.PI/180,Ct=6378137*Math.PI/180;function kt(t,n){var i,e=85.0511287798,r=t.x,s=Math.max(Math.min(e,t.y),-e);i=0===s?0:Math.log(Math.tan((90+s)*St/2))/St;var o=r*Ct,h=i*Ct;return n?(n.x=o,n.y=h,n):{x:o,y:h}}function Vt(t,n,i,e){var r=t[0]*(n.x-t[2])/i,s=-t[1]*(n.y-t[3])/i;return e?(e.x=r,e.y=s,e):{x:r,y:s}}function Zt(t){void 0===t&&(t=[]);for(var n=t.length,i=new Float32Array(3*n),e=0;e<n;e++){var r=t[e],s=3*e;i[s]=r[0],i[s+1]=r[1],i[s+2]=r[2]||0}return i}function Ft(t){for(var n=new Float32Array(2*t.length-6),i=0,e=0,r=t.length/3;e<r;e++){var s=t[3*e],o=t[3*e+1],h=t[3*e+2];if(e>0&&e<r-1){var a=3*i;n[a]=s,n[a+1]=o,n[a+2]=h,i++}var u=3*i;n[u]=s,n[u+1]=o,n[u+2]=h,i++}return n}function Lt(t){var n=0,i=t.length;if(1===i)return t[0];for(var e=0;e<i;e++)n+=t[e].length;for(var r=new Float32Array(n),s=0,o=0;o<i;o++)r.set(t[o],s),s+=t[o].length;return r}t.initialize=function(){},t.onmessage=function(t,n){var i=t.data,e=i.type,r=i.datas,s=i.glRes,o=i.matrix,h=i.center;if("ExtrudePolygons"===e){vt(r,h,s,o);var a=_t(r);n(null,a,[a.position,a.normal,a.uv,a.indices])}else if("ExtrudeLines"===e||"Paths"===e){for(var u=0,c=r.length;u<c;u++)for(var l=0,f=r[u].data.length;l<f;l++)r[u].data[l]=gt(r[u].data[l],r[u].center||h,s,o,!0);var x=_t(r,"ExtrudeLines"===e?2:3);n(null,x,[x.position,x.normal,x.uv,x.indices])}else if("ExtrudePolygon"===e){var y=[],d=[];r.forEach((function(t){var n=[t];vt(n,h,s,o);var i=_t(n),e=i.position,r=i.normal,a=i.uv,u=i.indices;y.push({id:t.id,position:e,normal:r,uv:a,indices:u}),d.push(e,r,a,u)})),n(null,y,d)}else if("Line"===e||"FatLine"===e){for(var p=[],v=[],g=0,_=r.length;g<_;g++){for(var m=[],z=0,w=r[g].data.length;z<w;z++){r[g].data[z]=gt(r[g].data[z],r[g].center||h,s,o,!0);var M=Zt(r[g].data[z]);m.push(Ft(M))}var b=Lt(m);At(b,r[g].bottomHeight),p.push({id:r[g].id,position:b.buffer}),v.push(b.buffer)}n(null,p,v)}else if("Lines"===e||"FatLines"===e){for(var A=0,P=[],S=[],C=0,k=[],V=0,Z=r.length;V<Z;V++){for(var F=0,L=0,q=r[V].data.length;L<q;L++){r[V].data[L]=gt(r[V].data[L],r[V].center||h,s,o,!0);var E=Zt(r[V].data[L]);At(E,r[V].bottomHeight),F+=E.length/3*2-2,k.push(Ft(E))}var I=F;P[V]=[A,A+I],A+=I,S[V]={position:{count:F,start:C,end:C+3*F},hide:!1},"FatLines"===e&&(S[V].instanceStart={count:F,start:C,end:C+3*F},S[V].instanceEnd={count:F,start:C,end:C+3*F}),C+=3*F}var O=Lt(k);n(null,{id:r.id,position:O.buffer,geometriesAttributes:S,faceMap:P},[O.buffer])}else if("ExtrudeLine"===e||"Path"===e){for(var U=0,N=r.length;U<N;U++)for(var j=0,Q=r[U].data.length;j<Q;j++)r[U].data[j]=gt(r[U].data[j],r[U].center||h,s,o,!0);var R=[],W=[];r.forEach((function(t){var n=_t([t],"ExtrudeLine"===e?2:3),i=n.position,r=n.normal,s=n.uv,o=n.indices;R.push({id:t.id,position:i,normal:r,uv:s,indices:o}),W.push(i,r,s,o)})),n(null,R,W)}else if("Bar"===e){for(var B=[],T=[],H=(r=new Float32Array(r)).length/7,X=0;X<H;){var Y=r.slice(7*X,7*(X+1)),D=Pt(Y),G=D.position,J=D.normal,K=D.uv,$=D.indices;B.push({id:parseInt(Y[6]),position:G,normal:J,uv:K,indices:$}),T.push(G,J,K,$),X++}n(null,B,T)}else if("Bars"===e){var tt=Pt(r=new Float32Array(r));n(null,tt,[tt.position,tt.normal,tt.uv,tt.indices])}else console.error("No processing logic found for type:"+e)},Object.defineProperty(t,"__esModule",{value:!0})})'),r.registerWorkerAdapter(ls,(function(t){const e=[],n=[];function i(t){t.abort?(n.splice(n.indexOf(t),1),e.length&&(n.push(e[0]),e.splice(0,1),r(n[n.length-1]))):n.length<5?(n.push(t),r(t)):e.push(t)}function r(t){fetch(t.url).then((t=>t.text())).then((e=>{new Blob([e],{type:"application/json"}).arrayBuffer().then((e=>{t.postResponse(null,e,[e]),t.abort=!0,i(t)}))})).catch((e=>{console.error(e),t.abort=!0,i(t)}))}t.initialize=function(){},t.onmessage=function(t,e){i({url:t.data,postResponse:e,abort:!1})}}))),t.BaseObject=v,t.BaseObjectTask=We,t.BaseObjectTaskManager=on,t.ExtrudeUtil=be,t.GeoJSONUtil=T,t.GeoUtil=Fn,t.IdentifyUtil=Kn,t.LineMaterial=p,t.LineUtil=Be,t.MergeGeometryUtil=pn,t.MergedMixin=Hn,t.ThreeLayer=Os,t.ThreeRenderer=Ss,t.geometryExtrude=cs,t.getFetchDataActor=function(){return r.worker||console.error("maptalks.worker is not defined,You can't use"),us||(us=new r.worker.Actor(ls)),us},t.polyextrude=ee,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.three v0.41.2")}));
//# sourceMappingURL=maptalks.three.min.js.map
