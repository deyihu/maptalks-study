/*!
 * maptalks.three v0.39.0
 * LICENSE : MIT
 * (c) 2016-2024 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("three")):"function"==typeof define&&define.amd?define(["exports","maptalks","three"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).maptalks=t.maptalks||{},t.maptalks,t.THREE)}(this,(function(t,e,n){"use strict";function i(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,i.get?i:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}function r(t,e){return e.forEach((function(e){e&&"string"!=typeof e&&!Array.isArray(e)&&Object.keys(e).forEach((function(n){if("default"!==n&&!(n in t)){var i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return e[n]}})}}))})),Object.freeze(t)}var s=i(e),o=i(n);const a=parseInt(o.REVISION.replace("dev",""));function h(t,e,n){return a>109?t.setAttribute(e,n):t.addAttribute(e,n),t}function c(){return o}function l(){return(t=c()).VertexColors?t.VertexColors:2;var t}function u(t,e,n){const i=c();return i.BoxBufferGeometry?new i.BoxBufferGeometry(t,e,n):i.BoxGeometry?new i.BoxGeometry(t,e,n):void 0}console.log(`maptalks.three log: current three.js version is %c${a}`,"color:red;font-size: 16px;font-weight: bold;");class d extends o.InstancedBufferGeometry{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),h(this,"position",new o.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),h(this,"uv",new o.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}applyMatrix(t){var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==e&&(t.applyToBufferAttribute(e),t.applyToBufferAttribute(n),e.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}setPositions(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new o.InstancedInterleavedBuffer(e,6,1);return h(this,"instanceStart",new o.InterleavedBufferAttribute(n,3,0)),h(this,"instanceEnd",new o.InterleavedBufferAttribute(n,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new o.InstancedInterleavedBuffer(e,6,1);return h(this,"instanceColorStart",new o.InterleavedBufferAttribute(n,3,0)),h(this,"instanceColorEnd",new o.InterleavedBufferAttribute(n,3,3)),this}fromWireframeGeometry(t){return this.setPositions(t.attributes.position.array),this}fromEdgesGeometry(t){return this.setPositions(t.attributes.position.array),this}fromMesh(t){return this.fromWireframeGeometry(new o.WireframeGeometry(t.geometry)),this}fromLineSegements(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this}computeBoundingBox(){var t=new o.Box3;null===this.boundingBox&&(this.boundingBox=new o.Box3);var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;void 0!==e&&void 0!==n&&(this.boundingBox.setFromBufferAttribute(e),t.setFromBufferAttribute(n),this.boundingBox.union(t))}computeBoundingSphere(){var t=new o.Vector3;null===this.boundingSphere&&(this.boundingSphere=new o.Sphere),null===this.boundingBox&&this.computeBoundingBox();var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;if(void 0!==e&&void 0!==n){var i=this.boundingSphere.center;this.boundingBox.getCenter(i);for(var r=0,s=0,a=e.count;s<a;s++)t.fromBufferAttribute(e,s),r=Math.max(r,i.distanceToSquared(t)),t.fromBufferAttribute(n,s),r=Math.max(r,i.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}copy(t){return this}}const f={},p={};f.line={linewidth:{value:1},resolution:{value:new o.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},p.line={uniforms:o.UniformsUtils.merge([o.UniformsLib.common,o.UniformsLib.fog,f.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"};class g extends o.ShaderMaterial{constructor(t){super({uniforms:o.UniformsUtils.clone(p.line.uniforms),vertexShader:p.line.vertexShader,fragmentShader:p.line.fragmentShader}),this.dashed=!0,this.isLineMaterial=!0,this.type="LineMaterial",Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),this.setValues(t)}}class y extends o.Mesh{constructor(t,e){super(t,e),this.isLineSegments2=!0,this.type="LineSegments2",this.geometry=void 0!==t?t:new d,this.material=void 0!==e?e:new g({color:16777215*Math.random()})}computeLineDistances(){var t=new o.Vector3,e=new o.Vector3,n=this.geometry,i=n.attributes.instanceStart,r=n.attributes.instanceEnd;if(!i||!r)return this;for(var s=new Float32Array(2*i.data.count),a=0,c=0,l=i.data.count;a<l;a++,c+=2)t.fromBufferAttribute(i,a),e.fromBufferAttribute(r,a),s[c]=0===c?0:s[c-1],s[c+1]=s[c]+t.distanceTo(e);var u=new o.InstancedInterleavedBuffer(s,2,1);return h(n,"instanceDistanceStart",new o.InterleavedBufferAttribute(u,1,0)),h(n,"instanceDistanceEnd",new o.InterleavedBufferAttribute(u,1,1)),this}}class x extends d{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}fromLine(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this}}class m extends y{constructor(t,e){super(t,e),this.isLine2=!0,this.type="Line2",this.geometry=void 0!==t?t:new x,this.material=void 0!==e?e:new g({color:16777215*Math.random()})}copy(t){return this}}const v={interactive:!0,altitude:0,minZoom:0,maxZoom:30,asynchronous:!1,bloom:!1,pickWeight:-1};function b(){}class _ extends(s.Eventable(b)){constructor(t){super(),this.isAdd=!1,this._mouseover=!1,this._visible=!0,this._zoomVisible=!0,this.picked=!1,this.isBaseObject=!0,void 0===t&&(t=s.Util.GUID()),this.id=t}addTo(t){return t&&"ThreeLayer"===t.type?t.addMesh([this]):console.error("layer only support maptalks.ThreeLayer"),this}remove(){const t=this.getLayer();return t&&t.removeMesh([this]),this}getObject3d(){return this.object3d}getId(){return this.id}setId(t){const e=this.getId();return this.id=t,this._fire("idchange",{old:e,new:t,target:this}),this}getType(){return this.type}getOptions(){return this.options}getProperties(){return(this.options||{}).properties}setProperties(t){const e=Object.assign({},this.getProperties());return this.options.properties=t,this._fire("propertieschange",{old:e,new:t,target:this}),this}getLayer(){return this.options.layer}getMap(){const t=this.getLayer();if(t)return t.getMap()}getCenter(){const t=this.getOptions(),{coordinate:e,lineString:n,polygon:i}=t;if(e)return e instanceof s.Coordinate?e:new s.Coordinate(e);{const t=i||n;if(t&&t.getCenter)return t.getCenter()}}getAltitude(){return this.getOptions().altitude}setAltitude(t){if(s.Util.isNumber(t)){const e=this.getLayer().altitudeToVector3(t,t).x;if(this.getObject3d().position.z=e,this.options.altitude=t,this.pickObject3d&&(this.pickObject3d.position.z=e),this._baseObjects&&Array.isArray(this._baseObjects))for(let t=0,n=this._baseObjects.length;t<n;t++)this._baseObjects[t]&&(this._baseObjects[t].getObject3d().position.z=e)}return this}supportHeight(){return this.getOptions().heightEnable}getHeight(){const{height:t}=this.getOptions();return s.Util.isNumber(t)?t:0}setHeight(t){if(!s.Util.isNumber(t)||this._baseObjects||!this.supportHeight())return this;const e=this.getLayer();if(!e)return this;const{geometry:n}=this.getObject3d();if(n instanceof o.BufferGeometry){const{position:i}=n.attributes||{};if(!i)return this;const r=i.array;let s=1/0,o=-1/0;for(let t=0,e=r.length;t<e;t+=3){const e=r[t+2];s=Math.min(e,s),o=Math.max(e,o)}const a=(s+o)/2;let h=e.altitudeToVector3(t,t).x;h=Math.max(h,1e-6);for(let t=0,e=r.length;t<e;t+=3)r[t+2]>a&&(r[t+2]=h);n.attributes.position.needsUpdate=!0,n.computeBoundingBox(),n.computeBoundingSphere(),this.getOptions().height=t}return this}show(){return this._zoomVisible&&(this.getObject3d().visible=!0,this._fire("show")),this._visible=!0,this}hide(){return this.getObject3d().visible=!1,this._fire("hide"),this._visible=!1,this._hideUI(),this}isVisible(){return!!this.getObject3d().visible}getSymbol(){return this.getObject3d().material}setSymbol(t){if(t&&t instanceof o.Material){t.needsUpdate=!0,t.vertexColors=this.getObject3d().material.vertexColors;const e=this.getObject3d().material.clone();this.getObject3d().material=t,this._fire("symbolchange",{old:e,new:t,target:this})}return this}setInfoWindow(t){return this.removeInfoWindow(),this.infoWindow=new s.ui.InfoWindow(t),this.infoWindow.addTo(this),this}getInfoWindow(){return this.infoWindow}openInfoWindow(t){return(t=t||this.getCenter())instanceof s.Coordinate||(t=new s.Coordinate(t)),t&&this.infoWindow&&this.infoWindow.show(t),this}closeInfoWindow(){return this.infoWindow&&this.infoWindow.hide(),this}removeInfoWindow(){return this.infoWindow&&(this.infoWindow.remove(),delete this.infoWindow),this}setToolTip(t,e){return this.removeToolTip(),this.toolTip=new s.ui.ToolTip(t,e),this.toolTip.addTo(this),this}getToolTip(){return this.toolTip}openToolTip(t){return this}closeToolTip(){return this.toolTip&&this.toolTip.hide(),this}removeToolTip(){return this.toolTip&&(this.toolTip.remove(),delete this.toolTip),this}_hideUI(){return this.closeInfoWindow(),this.closeToolTip(),this}animateShow(t={},e){this._showPlayer&&this._showPlayer.cancel(),s.Util.isFunction(t)&&(e=t={});const n=t.duration||1e3,i=t.easing||"out",r=this._showPlayer=s.animation.Animation.animate({scale:1},{duration:n,easing:i},(t=>{const n=t.styles.scale;n>0&&(this.getObject3d().scale.z=n),e&&e(t,n)}));return r.play(),r}getMinZoom(){return this.getOptions().minZoom}getMaxZoom(){return this.getOptions().maxZoom}isAsynchronous(){return this.getOptions().asynchronous}get bloom(){return this.getOptions().bloom}fire(t,e){return this._fire(t,e),this._vt&&this._vt.onSelectMesh&&this._vt.onSelectMesh(t,e),this}config(){return this}setPickObject3d(t){return this.pickObject3d=t,this.pickObject3d.__parent=this,this}getPickObject3d(){return this.pickObject3d}_initOptions(t){return this.options=s.Util.extend({},v,t),this}_createMesh(t,e){return this.object3d=new o.Mesh(t,e),this.object3d.__parent=this,this}_createInstancedMesh(t,e,n){return this.object3d=new o.InstancedMesh(t,e,n),this.object3d.__parent=this,this}_createGroup(){return this.object3d=new o.Group,this.object3d.__parent=this,this}_createLine(t,e){return this.object3d=new o.Line(t,e),this._computeLineDistances(t),this.object3d.__parent=this,this}_createLine2(t,e){return this.object3d=new m(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this}_createPoints(t,e){return this.object3d=new o.Points(t,e),this.object3d.__parent=this,this}_createLineSegments(t,e){return this.object3d=new o.LineSegments(t,e),this._computeLineDistances(t),this.object3d.__parent=this,this}_computeLineDistances(t){const e=t.attributes.position.array,n=t.attributes.position.count,i=new Float32Array(n);i[0]=0;const r=new o.Vector3(0,0,0),s=new o.Vector3(0,0,0);for(let t=1;t<n;t++){const n=3*(t-1);r.x=e[n],r.y=e[n+1],r.z=e[n+2];const o=3*t;s.x=e[o],s.y=e[o+1],s.z=e[o+2];const a=s.distanceTo(r);i[t]=i[t-1]+a}h(t,"lineDistance",new o.BufferAttribute(i,1))}}const w=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"];function M(t){return t.geometry?t.geometry.type:null}function O(t){const e=M(t);if(e)for(let t=0,n=w.length;t<n;t++)if(w[t]===e)return!0;return!1}function z(t){const e=M(t);return!(!e||e!==w[4]&&e!==w[5])}function A(t){const e=M(t);return!(!e||e!==w[2]&&e!==w[3])}function S(t){const e=M(t);return!(!e||e!==w[0]&&e!==w[1])}function j(t){const e=M(t);return!!(e&&e.indexOf("Multi")>-1)}function P(t){return t.geometry?t.geometry.coordinates:[]}function T(t,e){const n=M(t);if(!n||!t.geometry)return null;const i=t.geometry.coordinates;if(!i)return null;let r=0,o=0,a=0;switch(n){case"Point":r=i[0],o=i[1],a++;break;case"MultiPoint":case"LineString":for(let t=0,e=i.length;t<e;t++)r+=i[t][0],o+=i[t][1],a++;break;case"MultiLineString":case"Polygon":for(let t=0,e=i.length;t<e;t++)for(let e=0,n=i[t].length;e<n;e++)r+=i[t][e][0],o+=i[t][e][1],a++;break;case"MultiPolygon":for(let t=0,e=i.length;t<e;t++)for(let e=0,n=i[t].length;e<n;e++)for(let n=0,s=i[t][e].length;n<s;n++)r+=i[t][e][n][0],o+=i[t][e][n][1],a++}const h=r/a,c=o/a;return e?(e.x=h,e.y=c,e):new s.Coordinate(h,c)}function C(t){const e=M(t);if(!e||!t.geometry)return null;const n=t.geometry,i=t.properties||{},r=n.coordinates;if(!r)return null;const s=[];let o;switch(e){case"MultiPoint":o="Point";break;case"MultiLineString":o="LineString";break;case"MultiPolygon":o="Polygon"}if(o)for(let t=0,e=r.length;t<e;t++)s.push({type:"Feature",geometry:{type:o,coordinates:r[t]},properties:i});else s.push(t);return s}var L=Object.freeze({__proto__:null,isGeoJSON:O,isGeoJSONPolygon:z,isGeoJSONLine:A,isGeoJSONPoint:S,isGeoJSONMulti:j,getGeoJSONCoordinates:P,getGeoJSONCenter:T,spliteGeoJSONMulti:C});"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function k(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var V={exports:{}};
/*!
     * poly-extrude v0.4.0
      */!function(t,e){!function(t){var e={exports:{}};function n(t,e,n){n=n||2;var r,o,a,h,c,u,d,f=e&&e.length,p=f?e[0]*n:t.length,g=i(t,0,p,n,!0),y=[];if(!g||g.next===g.prev)return y;if(f&&(g=l(t,e,g,n)),t.length>80*n){r=a=t[0],o=h=t[1];for(var x=n;x<p;x+=n)(c=t[x])<r&&(r=c),(u=t[x+1])<o&&(o=u),c>a&&(a=c),u>h&&(h=u);d=0!==(d=Math.max(a-r,h-o))?32767/d:0}return s(g,y,n,r,o,d,0),y}function i(t,e,n,i,r){var s,o;if(r===k(t,e,n,i)>0)for(s=e;s<n;s+=i)o=T(s,t[s],t[s+1],o);else for(s=n-i;s>=e;s-=i)o=T(s,t[s],t[s+1],o);return o&&w(o,o.next)&&(C(o),o=o.next),o}function r(t,e){if(!t)return t;e||(e=t);var n,i=t;do{if(n=!1,i.steiner||!w(i,i.next)&&0!==_(i.prev,i,i.next))i=i.next;else{if(C(i),(i=e=i.prev)===i.next)break;n=!0}}while(n||i!==e);return e}function s(t,e,n,i,l,u,d){if(t){!d&&u&&g(t,i,l,u);for(var f,p,y=t;t.prev!==t.next;)if(f=t.prev,p=t.next,u?a(t,i,l,u):o(t))e.push(f.i/n|0),e.push(t.i/n|0),e.push(p.i/n|0),C(t),t=p.next,y=p.next;else if((t=p)===y){d?1===d?s(t=h(r(t),e,n),e,n,i,l,u,2):2===d&&c(t,e,n,i,l,u):s(r(t),e,n,i,l,u,1);break}}}function o(t){var e=t.prev,n=t,i=t.next;if(_(e,n,i)>=0)return!1;for(var r=e.x,s=n.x,o=i.x,a=e.y,h=n.y,c=i.y,l=r<s?r<o?r:o:s<o?s:o,u=a<h?a<c?a:c:h<c?h:c,d=r>s?r>o?r:o:s>o?s:o,f=a>h?a>c?a:c:h>c?h:c,p=i.next;p!==e;){if(p.x>=l&&p.x<=d&&p.y>=u&&p.y<=f&&v(r,a,s,h,o,c,p.x,p.y)&&_(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function a(t,e,n,i){var r=t.prev,s=t,o=t.next;if(_(r,s,o)>=0)return!1;for(var a=r.x,h=s.x,c=o.x,l=r.y,u=s.y,d=o.y,f=a<h?a<c?a:c:h<c?h:c,p=l<u?l<d?l:d:u<d?u:d,g=a>h?a>c?a:c:h>c?h:c,y=l>u?l>d?l:d:u>d?u:d,m=x(f,p,e,n,i),b=x(g,y,e,n,i),w=t.prevZ,M=t.nextZ;w&&w.z>=m&&M&&M.z<=b;){if(w.x>=f&&w.x<=g&&w.y>=p&&w.y<=y&&w!==r&&w!==o&&v(a,l,h,u,c,d,w.x,w.y)&&_(w.prev,w,w.next)>=0)return!1;if(w=w.prevZ,M.x>=f&&M.x<=g&&M.y>=p&&M.y<=y&&M!==r&&M!==o&&v(a,l,h,u,c,d,M.x,M.y)&&_(M.prev,M,M.next)>=0)return!1;M=M.nextZ}for(;w&&w.z>=m;){if(w.x>=f&&w.x<=g&&w.y>=p&&w.y<=y&&w!==r&&w!==o&&v(a,l,h,u,c,d,w.x,w.y)&&_(w.prev,w,w.next)>=0)return!1;w=w.prevZ}for(;M&&M.z<=b;){if(M.x>=f&&M.x<=g&&M.y>=p&&M.y<=y&&M!==r&&M!==o&&v(a,l,h,u,c,d,M.x,M.y)&&_(M.prev,M,M.next)>=0)return!1;M=M.nextZ}return!0}function h(t,e,n){var i=t;do{var s=i.prev,o=i.next.next;!w(s,o)&&M(s,i,i.next,o)&&S(s,o)&&S(o,s)&&(e.push(s.i/n|0),e.push(i.i/n|0),e.push(o.i/n|0),C(i),C(i.next),i=t=o),i=i.next}while(i!==t);return r(i)}function c(t,e,n,i,o,a){var h=t;do{for(var c=h.next.next;c!==h.prev;){if(h.i!==c.i&&b(h,c)){var l=P(h,c);return h=r(h,h.next),l=r(l,l.next),s(h,e,n,i,o,a,0),void s(l,e,n,i,o,a,0)}c=c.next}h=h.next}while(h!==t)}function l(t,e,n,r){var s,o,a,h=[];for(s=0,o=e.length;s<o;s++)(a=i(t,e[s]*r,s<o-1?e[s+1]*r:t.length,r,!1))===a.next&&(a.steiner=!0),h.push(m(a));for(h.sort(u),s=0;s<h.length;s++)n=d(h[s],n);return n}function u(t,e){return t.x-e.x}function d(t,e){var n=f(t,e);if(!n)return e;var i=P(n,t);return r(i,i.next),r(n,n.next)}function f(t,e){var n,i=e,r=t.x,s=t.y,o=-1/0;do{if(s<=i.y&&s>=i.next.y&&i.next.y!==i.y){var a=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(a<=r&&a>o&&(o=a,n=i.x<i.next.x?i:i.next,a===r))return n}i=i.next}while(i!==e);if(!n)return null;var h,c=n,l=n.x,u=n.y,d=1/0;i=n;do{r>=i.x&&i.x>=l&&r!==i.x&&v(s<u?r:o,s,l,u,s<u?o:r,s,i.x,i.y)&&(h=Math.abs(s-i.y)/(r-i.x),S(i,t)&&(h<d||h===d&&(i.x>n.x||i.x===n.x&&p(n,i)))&&(n=i,d=h)),i=i.next}while(i!==c);return n}function p(t,e){return _(t.prev,t,e.prev)<0&&_(e.next,t,t.next)<0}function g(t,e,n,i){var r=t;do{0===r.z&&(r.z=x(r.x,r.y,e,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,y(r)}function y(t){var e,n,i,r,s,o,a,h,c=1;do{for(n=t,t=null,s=null,o=0;n;){for(o++,i=n,a=0,e=0;e<c&&(a++,i=i.nextZ);e++);for(h=c;a>0||h>0&&i;)0!==a&&(0===h||!i||n.z<=i.z)?(r=n,n=n.nextZ,a--):(r=i,i=i.nextZ,h--),s?s.nextZ=r:t=r,r.prevZ=s,s=r;n=i}s.nextZ=null,c*=2}while(o>1);return t}function x(t,e,n,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function m(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function v(t,e,n,i,r,s,o,a){return(r-o)*(e-a)>=(t-o)*(s-a)&&(t-o)*(i-a)>=(n-o)*(e-a)&&(n-o)*(s-a)>=(r-o)*(i-a)}function b(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!A(t,e)&&(S(t,e)&&S(e,t)&&j(t,e)&&(_(t.prev,t,e.prev)||_(t,e.prev,e))||w(t,e)&&_(t.prev,t,t.next)>0&&_(e.prev,e,e.next)>0)}function _(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function w(t,e){return t.x===e.x&&t.y===e.y}function M(t,e,n,i){var r=z(_(t,e,n)),s=z(_(t,e,i)),o=z(_(n,i,t)),a=z(_(n,i,e));return r!==s&&o!==a||!(0!==r||!O(t,n,e))||!(0!==s||!O(t,i,e))||!(0!==o||!O(n,t,i))||!(0!==a||!O(n,e,i))}function O(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function z(t){return t>0?1:t<0?-1:0}function A(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&M(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}function S(t,e){return _(t.prev,t,t.next)<0?_(t,e,t.next)>=0&&_(t,t.prev,e)>=0:_(t,e,t.prev)<0||_(t,t.next,e)<0}function j(t,e){var n=t,i=!1,r=(t.x+e.x)/2,s=(t.y+e.y)/2;do{n.y>s!=n.next.y>s&&n.next.y!==n.y&&r<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}function P(t,e){var n=new L(t.i,t.x,t.y),i=new L(e.i,e.x,e.y),r=t.next,s=e.prev;return t.next=e,e.prev=t,n.next=r,r.prev=n,i.next=n,n.prev=i,s.next=i,i.prev=s,i}function T(t,e,n,i){var r=new L(t,e,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function C(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function L(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function k(t,e,n,i){for(var r=0,s=e,o=n-i;s<n;s+=i)r+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return r}e.exports=n,e.exports.default=n,n.deviation=function(t,e,n,i){var r=e&&e.length,s=r?e[0]*n:t.length,o=Math.abs(k(t,0,s,n));if(r)for(var a=0,h=e.length;a<h;a++){var c=e[a]*n,l=a<h-1?e[a+1]*n:t.length;o-=Math.abs(k(t,c,l,n))}var u=0;for(a=0;a<i.length;a+=3){var d=i[a]*n,f=i[a+1]*n,p=i[a+2]*n;u+=Math.abs((t[d]-t[p])*(t[f+1]-t[d+1])-(t[d]-t[f])*(t[p+1]-t[d+1]))}return 0===o&&0===u?0:Math.abs((u-o)/o)},n.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},i=0,r=0;r<t.length;r++){for(var s=0;s<t[r].length;s++)for(var o=0;o<e;o++)n.vertices.push(t[r][s][o]);r>0&&(i+=t[r-1].length,n.holes.push(i))}return n};var V=e.exports;function B(t){for(var e,n,i=0,r=1,s=t.length;r<s;)e=n||t[0],i+=((n=t[r])[0]-e[0])*(n[1]+e[1]),r++;return i>0}function E(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function I(t,e){var n=e[0],i=e[1],r=e[2],s=Math.sqrt(n*n+i*i+r*r)||1;return t[0]=n/s,t[1]=i/s,t[2]=r/s,t}function U(t,e,n){var i=e[0],r=e[1],s=e[2],o=n[0],a=n[1],h=n[2];return t[0]=r*h-s*a,t[1]=s*o-i*h,t[2]=i*a-r*o,t}function F(t,e){function n(t,e,n,i){t[0]=e,t[1]=n,t[2]=i}for(var i=[],r=[],s=[],o=[],a=[],h=[],c=t.length,l=new Float32Array(e.length),u=0;u<c;){var d=3*t[u],f=3*t[u+1],p=3*t[u+2];n(i,e[d],e[d+1],e[d+2]),n(r,e[f],e[f+1],e[f+2]),n(s,e[p],e[p+1],e[p+2]),E(a,s,r),E(o,i,r),U(h,a,o);for(var g=0;g<3;g++)l[d+g]+=h[g],l[f+g]+=h[g],l[p+g]+=h[g];u+=3}for(var y=0,x=l.length;y<x;)n(h,l[y],l[y+1],l[y+2]),I(h,h),l[y]=h[0]||0,l[y+1]=h[1]||0,l[y+2]=h[2]||0,y+=3;return l}function R(t){if(1===t.length)return{position:t[0].position,normal:t[0].normal,uv:t[0].uv,indices:t[0].indices,results:t};for(var e=0,n=0,i=0,r=t.length;i<r;i++){var s=t[i],o=s.position,a=s.indices;e+=o.length,n+=a.length}for(var h={position:new Float32Array(e),normal:new Float32Array(e),uv:new Float32Array(e/3*2),indices:new Uint32Array(n),results:t},c=0,l=0,u=0,d=0,f=0,p=t.length;f<p;f++){var g=t[f],y=g.position,x=g.indices,m=g.normal,v=g.uv;h.position.set(y,c),h.normal.set(m,c),h.uv.set(v,d);for(var b=0,_=x.length;b<_;){var w=x[b]+l;h.indices[u]=w,u++,b++}d+=v.length,c+=y.length,l+=y.length/3}return h}function G(t){return 180*t/Math.PI}function Z(t){return t/180*Math.PI}function Q(t,e,n,i,r,s){var o=3*n,a=3*i,h=3*r,c=3*s,l=e[o],u=e[o+1],d=e[o+2],f=e[a],p=e[a+1],g=e[a+2],y=e[h],x=e[h+1],m=e[h+2],v=e[c],b=e[c+1],_=e[c+2];Math.abs(u-p)<Math.abs(l-f)?(t.push(l,1-d),t.push(f,1-g),t.push(y,1-m),t.push(v,1-_)):(t.push(u,1-d),t.push(p,1-g),t.push(x,1-m),t.push(b,1-_))}function D(t,e){e=Object.assign({},{depth:2},e);var n=t.map((function(t){for(var n=0,i=t.length;n<i;n++){var r=t[n];X(r),0===n?B(r)||(t[n]=r.reverse()):B(r)&&(t[n]=r.reverse()),K(r)&&r.splice(r.length-1,1)}var s=q(t,e);return s.polygon=t,H(s,V(s.flatVertices,s.holes,2)),W(s,e),s.position=new Float32Array(s.points),s.indices=new Uint32Array(s.index),s.uv=new Float32Array(s.uvs),s.normal=F(s.indices,s.position),s})),i=R(n);return i.polygons=t,i}function H(t,e){for(var n=[],i=t.count,r=0,s=e.length;r<s;r+=3){var o=e[r],a=e[r+1],h=e[r+2];n[r]=o,n[r+1]=a,n[r+2]=h;var c=s+r,l=i+o,u=i+a,d=i+h;n[c]=l,n[c+1]=u,n[c+2]=d}t.index=n}function W(t,e){for(var n=t.points,i=t.index,r=t.polygon,s=t.uvs,o=e.depth,a=0,h=r.length;a<h;a++)for(var c=r[a],l=0,u=c.length;l<u;){var d=c[l],f=c[l+1];l===u-1&&(f=c[0]);var p=n.length/3,g=d[0],y=d[1],x=f[0],m=f[1];n.push(g,y,o,x,m,o,g,y,0,x,m,0);var v=p+2,b=p+3,_=p,w=p+1;i.push(v,_,b,_,w,b),Q(s,n,v,b,_,w),l++}}function N(t){for(var e=0,n=0,i=t.length;n<i;)e+=t[n].length,n++;return e}function q(t,e){for(var n=N(t),i=t.length,r=[],s=new Float32Array(2*n),o=[],a=[],h=3*n,c=2*n,l=e.depth,u=0,d=0,f=0,p=0;p<i;p++){var g=t[p];p>0&&r.push(u/2);for(var y=0,x=g.length;y<x;){var m=g[y],v=m[0],b=m[1];s[u++]=v,s[u++]=b,o[d]=v,o[d+1]=b,o[d+2]=l,o[h+d]=v,o[h+d+1]=b,o[h+d+2]=0,a[f]=v,a[f+1]=b,a[c+f]=v,a[c+f+1]=b,d+=3,f+=2,y++}}return{flatVertices:s,holes:r,points:o,count:n,uvs:a}}function X(t){K(t)||t.push(t[0])}function K(t){var e=t.length,n=t[0],i=n[0],r=n[1],s=t[e-1],o=s[0],a=s[1];return i===o&&r===a}function J(t,e){e=Object.assign({},{depth:2,lineWidth:1},e);var n=t.map((function(t){var n=nt(t,e);return n.line=t,Y(n,e),$(n,e),n.position=new Float32Array(n.points),n.indices=new Uint32Array(n.index),n.uv=new Float32Array(n.uvs),n.normal=F(n.indices,n.position),n})),i=R(n);return i.lines=t,i}function Y(t,e){for(var n=e.depth,i=[],r=[],s=[],o=t.leftPoints,a=t.rightPoints,h=0,c=o.length;h<c;){var l=3*h,u=o[h],d=u[0],f=u[1],p=u[2];i[l]=d,i[l+1]=f,i[l+2]=n+p;var g=a[h],y=g[0],x=g[1],m=g[2],v=3*c+l;i[v]=y,i[v+1]=x,i[v+2]=n+m;var b=2*c*3+l;i[b]=d,i[b+1]=f,i[b+2]=p;var _=2*c*3+3*c+l;i[_]=y,i[_+1]=x,i[_+2]=m,h++}for(h=0,c=i.length;h<c;){var w=i[h],M=i[h+1];s.push(w,M),h+=3}for(h=0,c=o.length;h<c-1;){var O=h,z=h+1,A=O+c,S=z+c;r.push(O,A,z),r.push(A,S,z);var j=h+2*c,P=j+1,T=j+c,C=P+c;r.push(j,T,P),r.push(T,C,P),h++}t.index=r,t.points=i,t.uvs=s}function $(t,e){var n=t.points,i=t.index,r=t.leftPoints,s=t.rightPoints,o=t.uvs,a=e.depth,h=[r,s];function c(t,e){var r=n.length/3;n.push(t[0],t[1],a+t[2],e[0],e[1],a+e[2],t[0],t[1],t[2],e[0],e[1],e[2]);var s=r+2,h=r+3,c=r,l=r+1;i.push(s,c,h,c,l,h),Q(o,n,s,h,c,l)}for(var l=0,u=h.length;l<u;l++){var d=h[l];l>0&&(d=(d=d.map((function(t){return t}))).reverse());for(var f=0,p=d.length-1;f<p;)c(d[f],d[f+1]),f++}for(var g=r.length,y=[s[0],r[0],r[g-1],s[g-1]],x=0;x<y.length;x+=2)c(y[x],y[x+1])}var tt={x:0,y:0},et={x:0,y:0};function nt(t,e){for(var n=e.lineWidth/2,i=[],r=[],s=[],o=t.length,a=0;a<o;){var h=t[a],c=t[a+1],l=t[a];a===o-1&&(h=t[o-2],c=t[o-1]);var u=c[1]-h[1],d=c[0]-h[0],f=0,p=G(Math.atan(u/d));if(0===a||a===o-1)f=p,f-=90;else{var g=t[a-1];tt.x=g[0]-h[0],tt.y=g[1]-h[1],et.x=c[0]-h[0],et.y=c[1]-h[1],f=p-it(tt,et)/2}var y=Z(f),x=l,m=[Math.cos(y)+x[0],Math.sin(y)+x[1]],v=st(h,c,n),b=v[0],_=v[1],w=ot(b[0],b[1],x,m),M=ot(_[0],_[1],x,m);if(!w||!M){var O=i.length,z=i[O-2],A=i[O-1];if(!z||!A)continue;w=[z[0],z[1]],M=[A[0],A[1]]}w[2]=l[2]||0,M[2]=l[2]||0,i.push(w,M),rt(w,h,c)?(r.push(w),s.push(M)):(r.push(M),s.push(w)),a++}return{offsetPoints:i,leftPoints:r,rightPoints:s}}var it=function(t,e){var n=t.x,i=t.y,r=e.x,s=e.y,o=n*r+i*s,a=n*s-i*r;return(Math.atan2(a,o)/Math.PI*180+360)%360};function rt(t,e,n){var i=e[0],r=e[1],s=n[0],o=n[1];return(r-o)*t[0]+(s-i)*t[1]+i*o-s*r>0}function st(t,e,n){var i=e[1]-t[1],r=e[0]-t[0],s=Math.atan2(i,r),o=s+Math.PI/2,a=Math.cos(o)*n,h=Math.sin(o)*n,c=[t[0]+a,t[1]+h],l=[e[0]+a,e[1]+h],u=s-Math.PI/2;return a=Math.cos(u)*n,h=Math.sin(u)*n,[[c,l],[[t[0]+a,t[1]+h],[e[0]+a,e[1]+h]]]}function ot(t,e,n,i){var r=e[0]-t[0],s=e[1]-t[1],o=i[0]-n[0],a=i[1]-n[1];if(0===r&&0===o)return null;if(0===s&&0===a)return null;var h,c,l=s/r,u=a/o,d=t[1]-l*t[0],f=n[1]-u*n[0];return 0===r?c=u*(h=t[0])+f:0===o?c=l*(h=n[0])+d:0===s?h=((c=t[1])-f)/u:0===a?h=((c=n[1])-d)/l:c=l*(h=(f-d)/(l-u))+d,[h,c]}function at(t,e){void 0===e&&(e={}),e=Object.assign({},{radius:1,height:2,radialSegments:6},e);for(var n=Math.round(Math.max(4,e.radialSegments)),i=e,r=i.radius,s=i.height,o=360/n/360*Math.PI*2,a=n+1,h=new Float32Array(3*a*2),c=t[0],l=t[1],u=0,d=0,f=3*a,p=2*a,g=[],y=[],x=-1;x<n;x++){var m=o*x,v=Math.cos(m)*r+c,b=Math.sin(m)*r+l;h[u]=v,h[u+1]=b,h[u+2]=0,h[u+f]=v,h[u+1+f]=b,h[u+2+f]=s;var _=0,w=0;_=.5+v/r/2,w=.5+b/r/2,y[d]=_,y[d+1]=w,y[d+p]=_,y[d+1+p]=w,u+=3,d+=2,x>1&&g.push(0,x-1,x)}h[u-=3]=h[0],h[u+1]=h[1],h[u+2]=h[2];var M=h.length;h[M-3]=h[0],h[M-2]=h[1],h[M-1]=s;for(var O=g.length,z=0;z<O;z++){var A=g[z];g.push(A+a)}var S=new Float32Array(2*(3*a*2-6)),j=-1;u=2*a,d=0;for(var P=0,T=h.length/2;P<T-3;P+=3){var C=h[P],L=h[P+1],k=h[P+3],V=h[P+4];S[++j]=C,S[++j]=L,S[++j]=s,S[++j]=k,S[++j]=V,S[++j]=s,S[++j]=C,S[++j]=L,S[++j]=0,S[++j]=k,S[++j]=V,S[++j]=0;var B=u+2,E=u+3,I=u,U=u+1;g.push(I,B,U,B,E,U),u+=4;var R=d/a,G=(d+1)/a;y.push(R,s/r/2,G,s/r/2,R,0,G,0),d++}var Z=new Float32Array(h.length+S.length);Z.set(h,0),Z.set(S,h.length);var Q=F(g,Z);return{points:h,indices:new Uint32Array(g),position:Z,normal:Q,uv:new Float32Array(y)}}var ht=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=n}var e=t.prototype;return e.set=function(t,e,n){return void 0===n&&(n=this.z),this.x=t,this.y=e,this.z=n,this},e.clone=function(){return new this.constructor(this.x,this.y,this.z)},e.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},e.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},e.addScalar=function(t){return this.x+=t,this.y+=t,this.z+=t,this},e.addVectors=function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},e.addScaledVector=function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this},e.sub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},e.subScalar=function(t){return this.x-=t,this.y-=t,this.z-=t,this},e.subVectors=function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},e.multiply=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},e.multiplyScalar=function(t){return this.x*=t,this.y*=t,this.z*=t,this},e.multiplyVectors=function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this},e.applyMatrix4=function(t){var e=this.x,n=this.y,i=this.z,r=t.elements,s=1/(r[3]*e+r[7]*n+r[11]*i+r[15]);return this.x=(r[0]*e+r[4]*n+r[8]*i+r[12])*s,this.y=(r[1]*e+r[5]*n+r[9]*i+r[13])*s,this.z=(r[2]*e+r[6]*n+r[10]*i+r[14])*s,this},e.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},e.divideScalar=function(t){return this.multiplyScalar(1/t)},e.min=function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this},e.max=function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this},e.clamp=function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this},e.clampScalar=function(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this},e.clampLength=function(t,e){var n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(t,Math.min(e,n)))},e.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},e.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z},e.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},e.normalize=function(){return this.divideScalar(this.length()||1)},e.setLength=function(t){return this.normalize().multiplyScalar(t)},e.lerp=function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this},e.lerpVectors=function(t,e,n){return this.x=t.x+(e.x-t.x)*n,this.y=t.y+(e.y-t.y)*n,this.z=t.z+(e.z-t.z)*n,this},e.cross=function(t){return this.crossVectors(this,t)},e.crossVectors=function(t,e){var n=t.x,i=t.y,r=t.z,s=e.x,o=e.y,a=e.z;return this.x=i*a-r*o,this.y=r*s-n*a,this.z=n*o-i*s,this},e.distanceTo=function(t){return Math.sqrt(this.distanceToSquared(t))},e.equals=function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},e.fromArray=function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this},e.random=function(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this},t}(),ct=function(){function t(){this.pos=new ht,this.dir=new ht,this.right=new ht,this.up=new ht,this.dist=0,this.widthScale=1,this.sharp=!1}var e=t.prototype;return e.lerpPathPoints=function(t,e,n){this.pos.lerpVectors(t.pos,e.pos,n),this.dir.lerpVectors(t.dir,e.dir,n),this.up.lerpVectors(t.up,e.up,n),this.right.lerpVectors(t.right,e.right,n),this.dist=(e.dist-t.dist)*n+t.dist,this.widthScale=(e.widthScale-t.widthScale)*n+t.widthScale},e.copy=function(t){this.pos.copy(t.pos),this.dir.copy(t.dir),this.up.copy(t.up),this.right.copy(t.right),this.dist=t.dist,this.widthScale=t.widthScale},t}(),lt=function(){function t(t,e,n,i,r,s,o,a,h,c,l,u,d,f,p,g){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,e,n,i,r,s,o,a,h,c,l,u,d,f,p,g)}var e=t.prototype;return e.set=function(t,e,n,i,r,s,o,a,h,c,l,u,d,f,p,g){var y=this.elements;return y[0]=t,y[4]=e,y[8]=n,y[12]=i,y[1]=r,y[5]=s,y[9]=o,y[13]=a,y[2]=h,y[6]=c,y[10]=l,y[14]=u,y[3]=d,y[7]=f,y[11]=p,y[15]=g,this},e.multiply=function(t){return this.multiplyMatrices(this,t)},e.makeRotationAxis=function(t,e){var n=Math.cos(e),i=Math.sin(e),r=1-n,s=t.x,o=t.y,a=t.z,h=r*s,c=r*o;return this.set(h*s+n,h*o-i*a,h*a+i*o,0,h*o+i*a,c*o+n,c*a-i*s,0,h*a-i*o,c*a+i*s,r*a*a+n,0,0,0,0,1),this},e.equals=function(t){for(var e=this.elements,n=t.elements,i=0;i<16;i++)if(e[i]!==n[i])return!1;return!0},t}();function ut(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,dt(t,e)}function dt(t,e){return dt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},dt(t,e)}var ft=function(){function t(){this.type="Curve",this.arcLengthDivisions=200}var e=t.prototype;return e.getPoint=function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},e.getPointAt=function(t,e){var n=this.getUtoTmapping(t);return this.getPoint(n,e)},e.getPoints=function(t){void 0===t&&(t=5);for(var e=[],n=0;n<=t;n++)e.push(this.getPoint(n/t));return e},e.getLength=function(){var t=this.getLengths();return t[t.length-1]},e.getLengths=function(t){if(void 0===t&&(t=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var e,n=[],i=this.getPoint(0),r=0;n.push(0);for(var s=1;s<=t;s++)r+=(e=this.getPoint(s/t)).distanceTo(i),n.push(r),i=e;return this.cacheArcLengths=n,n},e.getUtoTmapping=function(t,e){var n,i=this.getLengths(),r=0,s=i.length;n=e||t*i[s-1];for(var o,a=0,h=s-1;a<=h;)if((o=i[r=Math.floor(a+(h-a)/2)]-n)<0)a=r+1;else{if(!(o>0)){h=r;break}h=r-1}if(i[r=h]===n)return r/(s-1);var c=i[r];return(r+(n-c)/(i[r+1]-c))/(s-1)},t}();function pt(t,e){var n=1-t;return n*n*e}function gt(t,e){return 2*(1-t)*t*e}function yt(t,e){return t*t*e}function xt(t,e,n,i){return pt(t,e)+gt(t,n)+yt(t,i)}var mt=function(t){function e(e,n,i){var r;return void 0===e&&(e=new ht),void 0===n&&(n=new ht),void 0===i&&(i=new ht),(r=t.call(this)||this).isQuadraticBezierCurve3=!0,r.type="QuadraticBezierCurve3",r.v0=e,r.v1=n,r.v2=i,r}return ut(e,t),e.prototype.getPoint=function(t,e){void 0===e&&(e=new ht);var n=e,i=this.v0,r=this.v1,s=this.v2;return n.set(xt(t,i.x,r.x,s.x),xt(t,i.y,r.y,s.y),xt(t,i.z,r.z,s.z)),n},e}(ft),vt=new ht,bt=new ht,_t=new ht,wt=new lt,Mt=new mt;function Ot(t,e,n,i,r,s){var o=vt.subVectors(e,t),a=bt.subVectors(n,e),h=o.length(),c=a.length();o.normalize(),a.normalize();var l=Math.min(.999999*(r?h/2:h),i);s.v0.copy(e).sub(o.multiplyScalar(l)),s.v1.copy(e);var u=Math.min(c/2*.999999,i);return s.v2.copy(e).add(a.multiplyScalar(u)),s}var zt=function(){function t(){this.array=[],this.count=0}var e=t.prototype;return e.set=function(t,e,n,i,r){if(void 0===e&&(e=.1),void 0===n&&(n=10),void 0===i&&(i=null),void 0===r&&(r=!1),(t=t.slice(0)).length<2)return console.warn("PathPointList: points length less than 2."),void(this.count=0);r&&!t[0].equals(t[t.length-1])&&t.push((new ht).copy(t[0]));for(var s=0,o=t.length;s<o;s++)if(0===s)this._start(t[s],t[s+1],i);else if(s===o-1)if(r){this._corner(t[s],t[1],e,n,i);var a=this.array[0].dist;this.array[0].copy(this.array[this.count-1]),this.array[0].dist=a}else this._end(t[s]);else this._corner(t[s],t[s+1],e,n,i)},e.distance=function(){return this.count>0?this.array[this.count-1].dist:0},e._getByIndex=function(t){return this.array[t]||(this.array[t]=new ct),this.array[t]},e._start=function(t,e,n){this.count=0;var i=this._getByIndex(this.count);if(i.pos.copy(t),i.dir.subVectors(e,t),n)i.up.copy(n);else{var r=Number.MAX_VALUE,s=Math.abs(i.dir.x),o=Math.abs(i.dir.y),a=Math.abs(i.dir.z);s<r&&(r=s,i.up.set(1,0,0)),o<r&&(r=o,i.up.set(0,1,0)),a<r&&i.up.set(0,0,1)}i.right.crossVectors(i.dir,i.up).normalize(),i.up.crossVectors(i.right,i.dir).normalize(),i.dist=0,i.widthScale=1,i.sharp=!1,i.dir.normalize(),this.count++},e._end=function(t){var e=this.array[this.count-1],n=this._getByIndex(this.count);n.pos.copy(t),n.dir.subVectors(t,e.pos);var i=n.dir.length();n.dir.normalize(),n.up.copy(e.up);var r=vt.crossVectors(e.dir,n.dir);if(r.length()>Number.EPSILON){r.normalize();var s=Math.acos(Math.min(Math.max(e.dir.dot(n.dir),-1),1));n.up.applyMatrix4(wt.makeRotationAxis(r,s))}n.right.crossVectors(n.dir,n.up).normalize(),n.dist=e.dist+i,n.widthScale=1,n.sharp=!1,this.count++},e._corner=function(t,e,n,i,r){if(n>0&&i>0){for(var s=Ot(this.array[this.count-1].pos,t,e,n,this.count-1==0,Mt).getPoints(i),o=0;o<i;o++)this._sharpCorner(s[o],s[o+1],r,0===o?1:0);s[i].equals(e)||this._sharpCorner(s[i],e,r,2)}else this._sharpCorner(t,e,r,0,!0)},e._sharpCorner=function(t,e,n,i,r){void 0===i&&(i=0),void 0===r&&(r=!1);var s=this.array[this.count-1],o=this._getByIndex(this.count),a=vt.subVectors(t,s.pos),h=bt.subVectors(e,t),c=a.length();if(a.normalize(),h.normalize(),o.pos.copy(t),1===i?o.dir.copy(a):2===i?o.dir.copy(h):(o.dir.addVectors(a,h),o.dir.normalize()),n)1===o.dir.dot(n)?o.right.crossVectors(h,n).normalize():o.right.crossVectors(o.dir,n).normalize(),o.up.crossVectors(o.right,o.dir).normalize();else{o.up.copy(s.up);var l=_t.crossVectors(s.dir,o.dir);if(l.length()>Number.EPSILON){l.normalize();var u=Math.acos(Math.min(Math.max(s.dir.dot(o.dir),-1),1));o.up.applyMatrix4(wt.makeRotationAxis(l,u))}o.right.crossVectors(o.dir,o.up).normalize()}o.dist=s.dist+c;var d=a.dot(h);o.widthScale=Math.min(1/Math.sqrt((1+d)/2),1.415)||1,o.sharp=Math.abs(d-1)>.05&&r,this.count++},t}(),At=new ht(0,0,1);function St(t,e){e=Object.assign({},{lineWidth:1,cornerRadius:0,cornerSplit:10},e);var n=t.map((function(t){var n=t.map((function(t){var e=t[0],n=t[1],i=t[2];return new ht(e,n,i||0)})),i=new zt;i.set(n,e.cornerRadius,e.cornerSplit,At);var r=jt(i,e);return r.line=t,r.position=new Float32Array(r.points),r.indices=new Uint32Array(r.index),r.uv=new Float32Array(r.uvs),r.normal=new Float32Array(r.normal),r})),i=R(n);return i.lines=t,i}function jt(t,e){var n=e.lineWidth||.1,i=1,r=n/2,s=n,o=t.distance(),a=i*o;if(0===o)return null;var h,c=r/s,l=0,u=[],d=[],f=[],p=[],g=0,y=new ht,x=new ht,m=new ht,v=new ht,b=new ht,_=new ht;function w(t){var e=0===u.length,n=t.sharp&&!e,i=t.dist/s,o=t.dir,a=t.up,h=t.right;if(y.copy(h).multiplyScalar(r*t.widthScale),x.copy(h).multiplyScalar(-r*t.widthScale),y.add(t.pos),x.add(t.pos),n){m.fromArray(u,u.length-6).sub(x),v.fromArray(u,u.length-3).sub(y);var w,M,O=m.length()-v.length();O>0?(w=m,M=x):(w=v,M=y),b.copy(w).setLength(Math.abs(O)).add(M);var z=_.copy(M).sub(b).normalize().dot(o)*_.copy(M).sub(b).length()*2;_.copy(o).setLength(z).add(b),O>0?(u.push(b.x,b.y,b.z,y.x,y.y,y.z,x.x,x.y,x.z,y.x,y.y,y.z,_.x,_.y,_.z,y.x,y.y,y.z),g+=6,p.push(g-6,g-8,g-7,g-6,g-7,g-5,g-4,g-6,g-5,g-2,g-4,g-1),l+=12):(u.push(x.x,x.y,x.z,b.x,b.y,b.z,x.x,x.y,x.z,y.x,y.y,y.z,x.x,x.y,x.z,_.x,_.y,_.z),g+=6,p.push(g-6,g-8,g-7,g-6,g-7,g-5,g-6,g-5,g-3,g-2,g-3,g-1),l+=12),d.push(a.x,a.y,a.z,a.x,a.y,a.z,a.x,a.y,a.z,a.x,a.y,a.z,a.x,a.y,a.z,a.x,a.y,a.z),f.push(i-c,0,i-c,1,i,0,i,1,i+c,0,i+c,1)}else u.push(x.x,x.y,x.z,y.x,y.y,y.z),d.push(a.x,a.y,a.z,a.x,a.y,a.z),f.push(i,0,i,1),g+=2,e||(p.push(g-2,g-4,g-3,g-2,g-3,g-1),l+=6)}if(a>0)for(var M=0;M<t.count;M++){var O=t.array[M];if(O.dist>a){var z=t.array[M-1];h=new ct;var A=(a-z.dist)/(O.dist-z.dist);h.lerpPathPoints(z,O,A),w(h);break}w(O)}else h=t.array[0];return{points:u,normal:d,uvs:f,index:p,count:l}}t.cylinder=at,t.expandLine=nt,t.expandPaths=St,t.extrudePolygons=D,t.extrudePolylines=J,Object.defineProperty(t,"__esModule",{value:!0})}(e)}(0,V.exports);var B=r({__proto__:null,default:k(V.exports)},[V.exports]);function E(t,e,n={}){return void 0===n[t]&&(n[t]=e.distanceToVector3(t,t).x),n[t]}function I(t,e,n={}){return void 0===n[t]&&(n[t]=e.altitudeToVector3(t,t).x),n[t]}function U(t=[]){let e=0,n=0;const i=t.length;for(let r=0;r<i;r++){const{coordinate:i,lnglat:o,lnglats:a,xy:h,xys:c}=t[r],l=i||o||a||h||c||t[r];let u,d;Array.isArray(l)?(u=l[0],d=l[1]):l instanceof s.Coordinate&&(u=l.x,d=l.y),e+=u,n+=d}return new s.Coordinate(e/i,n/i)}function F(t,e,n,i){if(void 0===e||"number"!=typeof e||0===e)return 0;let r;r=t instanceof o.BufferGeometry?t.attributes.position.array:Array.isArray(t)||t instanceof Float32Array?t:t.position;let s=0;if(r){i?(void 0===i[e]&&(i[e]=n.altitudeToVector3(e,e).x),s=i[e]):s=n.altitudeToVector3(e,e).x;const t=r.length;if(r[0]instanceof o.Vector3)for(let e=0;e<t;e++)r[e].z+=s;else for(let e=0;e<t;e+=3)r[e+2]+=s}return s}function R(t){const e=t.length;let n=0;for(let i=0;i<e;i++){const{count:e}=t[i].position;n+=e}return new Float32Array(3*n)}const G=new o.Vector3,Z=new Map;function Q(t=[],e){const n=t.length,i=!!e,r=i?3:2,s=new Float64Array(n*r);Z.clear();for(let o=0;o<n;o++){let n,a;const h=t[o];let c;if(h.x?(n=h.x,a=h.y,c=h.z):(n=h[0],a=h[1],c=h[2]),s[o*r]=n,s[o*r+1]=a,c=c||0,i&&0!==c){if(!Z.has(c)){const t=e.altitudeToVector3(c,c,null,G).x;Z.set(c,t)}s[o*r+2]=Z.get(c)}}return s.buffer}function D(t){return(z(t)?t.properties:t.getProperties())||{}}function H(t){return(A(t)?t.properties:t.getProperties())||{}}const W=new o.Color("#fff"),N=new o.Color("#fff");function q(t,e,n,i){const{position:r,normal:s,uv:a,indices:c}=X(t,e,n,i),l=new Float32Array(r.length);l.fill(1,0,r.length);const u=new o.BufferGeometry;return h(u,"color",new o.BufferAttribute(l,3)),h(u,"normal",new o.BufferAttribute(s,3)),h(u,"position",new o.BufferAttribute(r,3)),h(u,"uv",new o.BufferAttribute(a,2)),u.setIndex(new o.BufferAttribute(c,1)),u}function X(t,e,n,i,r,s){const o=J(t,n,i,r,!1);if(!o)return null;s?(null==s[e]&&(s[e]=n.altitudeToVector3(e,e).x),e=s[e]):e=n.altitudeToVector3(e,e).x;const{position:a,normal:h,uv:c,indices:l}=V.exports.extrudePolygons(o,{depth:e});return{position:a,normal:h,uv:c,indices:l}}function K(t,e,n,i){void 0===i&&(i=0);const r=t.attributes.position.array,s=r.length;let a;if(N.setStyle(e),W.setStyle(n),Array.isArray(i)){let t=0;for(let e=0,n=i.length;e<n;e++){const{count:n}=i[e].position;t+=3*n}a=new Float32Array(t)}else a=new Float32Array(r.length);if(Array.isArray(i))for(let t=0,e=i.length;t<e;t++){const{middleZ:e,start:n,end:s}=i[t].position;for(let t=n;t<s;t+=3){r[t+2]>e?(a[t]=W.r,a[t+1]=W.g,a[t+2]=W.b):(a[t]=N.r,a[t+1]=N.g,a[t+2]=N.b)}}else for(let t=0;t<s;t+=3){r[t+2]>i?(a[t]=W.r,a[t+1]=W.g,a[t+2]=W.b):(a[t]=N.r,a[t+1]=N.g,a[t+2]=N.b)}return h(t,"color",new o.BufferAttribute(a,3,!0)),a}function J(t,e,n,i,r=!1){if(!t)return null;let o=[];if(t instanceof s.MultiPolygon)o=t.getGeometries().map((s=>Y(s,e,n||t.getCenter(),i,r)));else if(t instanceof s.Polygon){const s=Y(t,e,n||t.getCenter(),i,r);o.push(s)}else if(z(t))if(j(t)){const s=C(t);for(let a=0,h=s.length;a<h;a++)o.push(Y(s[a],e,n||T(t),i,r))}else{const s=Y(t,e,n||T(t),i,r);o.push(s)}return o}function Y(t,e,n,i,r=!1){let o,a,h;if(z(t)){const e=P(t);o=e[0],a=e.slice(1,e.length),n=n||T(t)}else t instanceof s.Polygon&&(o=t.getShell(),a=t.getHoles(),n=n||t.getCenter());i=i||e.coordinateToVector3(n),h=r?e.coordinatiesToGLFloatArray(o,i).positons2d:e.coordinatiesToGLArray(o,i);const c=[r?h.buffer:h];if(a&&a.length>0)for(let t=0,n=a.length;t<n;t++){let n;n=r?e.coordinatiesToGLFloatArray(a[t],i).positons2d:e.coordinatiesToGLArray(a[t],i),c.push(r?n.buffer:n)}return c}function $(t){if(!t)return null;let e=[];if(t instanceof s.MultiPolygon)e=t.getGeometries().map((t=>tt(t,!1)));else if(t instanceof s.Polygon){const n=tt(t,!1);e.push(n)}else if(z(t))if(j(t)){const n=C(t);for(let t=0,i=n.length;t<i;t++)e.push(tt(n[t],!0))}else{const n=tt(t,!0);e.push(n)}return e}function tt(t,e){let n,i;if(e){const e=P(t);n=e[0],i=e.slice(1,e.length)}else t instanceof s.Polygon&&(n=t.getShell(),i=t.getHoles());const r=[Q(n)];if(i&&i.length>0)for(let t=0,e=i.length;t<e;t++){const e=Q(i[t]);r.push(e)}return r}var et=Object.freeze({__proto__:null,getExtrudeGeometry:q,getExtrudeGeometryParams:X,initVertexColors:K,getPolygonPositions:J,getSinglePolygonPositions:Y,getPolygonArrayBuffer:$,getSinglePolygonArrayBuffer:tt});const nt=new Map,it=new o.Vector3;function rt(t,e,n,i=!0){let r,a,h=[];if(Array.isArray(t)&&t[0]instanceof o.Vector3)h=t;else{Array.isArray(t)&&(t=new s.LineString(t));const o=0;let c,l;O(t)?(c=P(t),n||(l=T(t))):t instanceof s.LineString&&(c=t.getCoordinates(),n||(l=t.getCenter()));const u=e.coordinateToVector3(n||l);if(i){nt.clear();for(let t=0,n=c.length;t<n;t++){const n=c[t],i=n.z||n[2]||0;if(!nt.has(i)){const t=e.altitudeToVector3(i,i,null,it).x;nt.set(i,t)}const r=e.coordinateToVector3(n,o).sub(u);r.z+=nt.get(i)||0,h.push(r)}}else{const t=e.coordinatiesToGLFloatArray(c,u,!0);r=t.positions,a=t.positons2d}}if(!i)return{positions:r,positionsV:h,positions2d:a,arrayBuffer:r.buffer};a=new Float32Array(2*h.length),r=new Float32Array(3*h.length);for(let t=0,e=h.length;t<e;t++){const e=3*t,n=h[t];r[e]=n.x,r[e+1]=n.y,r[e+2]=n.z;const i=2*t;a[i]=n.x,a[i+1]=n.y}return{positions:r,positionsV:h,positions2d:a,arrayBuffer:r.buffer}}function st(t,e,n,i){const r=[],s=[],o=[];let a,h;for(let n=0,c=t.length;n<c;n++){const c=t[n];for(let t=0,n=c.length;t<n;t++){const n=c[t],l=n.join(",").toString();a?(l!==a&&(h=e.coordinateToVector3(n,0).sub(i),r.push(h.x,h.y,h.z),s.push(h),o.push(n)),a=l):(o.push(n),a=l,h=e.coordinateToVector3(n,0).sub(i),r.push(h.x,h.y,h.z),s.push(h))}}return{positions:r,positionsV:s,lnglats:o}}function ot(t){let e;const n=[];for(let i=0,r=t.length;i<r;i++){const r=t[i];for(let t=0,i=r.length;t<i;t++){const i=r[t],s=i.join(",").toString();e?(s!==e&&n.push(i),e=s):(n.push(i),e=s)}}return n}function at(t,e=1,n=1,i,r){const s=rt(t,i,r).positionsV,o=[];for(let t=0,e=s.length;t<e;t++){const e=s[t];o.push([e.x,e.y,e.z])}const{indices:a,position:h,normal:c,uv:l}=V.exports.extrudePolylines([o],{lineWidth:e,depth:n});return{position:h,normal:c,indices:a,uv:l}}function ht(t,e=1,n=1,i,r){const s=rt(t,i,r).positionsV,o=[];for(let t=0,e=s.length;t<e;t++){const e=s[t];o.push([e.x,e.y,e.z])}const{indices:a,position:h,normal:c,uv:l}=V.exports.expandPaths([o],{lineWidth:e,cornerRadius:n});return{position:h,normal:c,indices:a,uv:l}}function ct(t){let e,n=[];return t instanceof s.MultiLineString?(n=t.getGeometries(),e=t.getCenter()):t instanceof s.LineString?(n.push(t),e=t.getCenter()):O(t)&&(e=T(t),j(t)?n=C(t):n.push(t)),{lineStrings:n,center:e}}function lt(t){const e=new Float32Array(2*t.length-6);let n=0;for(let i=0,r=t.length/3;i<r;i++){const s=t[3*i],o=t[3*i+1],a=t[3*i+2];if(i>0&&i<r-1){const t=3*n;e[t]=s,e[t+1]=o,e[t+2]=a,n++}const h=3*n;e[h]=s,e[h+1]=o,e[h+2]=a,n++}return e}function ut(t){let e=0;const n=t.length;if(1===n)return t[0];for(let i=0;i<n;i++)e+=t[i].length;const i=new Float32Array(e);let r=0;for(let e=0;e<n;e++)i.set(t[e],r),r+=t[e].length;return i}function dt(t,e){return t instanceof s.LineString?Q(t.getCoordinates(),e):A(t)?Q(t.geometry.coordinates,e):void 0}let ft;function pt(){return ft||(ft=new o.BufferGeometry,h(ft,"position",new o.BufferAttribute(new Float32Array(3),3))),ft}var gt=Object.freeze({__proto__:null,getLinePosition:rt,getExtrudeLineGeometry:function(t,e=1,n=1,i,r){const{indices:s,position:a,normal:c,uv:l}=at(t,e,n,i,r),u=new o.BufferGeometry;return h(u,"position",new o.BufferAttribute(a,3)),h(u,"normal",new o.BufferAttribute(c,3)),h(u,"uv",new o.BufferAttribute(l,2)),u.setIndex(new o.BufferAttribute(s,1)),u},getChunkLinesPosition:st,mergeChunkLineCoordinates:ot,getExtrudeLineParams:at,getPathParams:ht,LineStringSplit:ct,setLineSegmentPosition:function(t,e){for(let n=0,i=e.length;n<i;n++){const r=e[n];n>0&&n<i-1&&t.push(r.x,r.y,r.z),t.push(r.x,r.y,r.z)}},getLineSegmentPosition:lt,mergeLinePositions:ut,getLineArrayBuffer:dt,getDefaultLineGeometry:pt});let yt;var xt;function mt(){return s.worker||console.error("maptalks.worker is not defined,You can't use ThreeVectorTileLayer"),!xt&&yt&&(xt=new yt("__maptalks.three__")),xt}function vt(t,e,n={}){return void 0!==t&&"number"==typeof t&&0!==t?(void 0===n[t]&&(n[t]=e.distanceToVector3(t,t).x),n[t]):0}function bt(t,e,n={}){return void 0!==t&&"number"==typeof t&&0!==t?(void 0===n[t]&&(n[t]=e.altitudeToVector3(t,t).x),n[t]):0}function _t(t,e){return e?Object.assign({},e,t):t||{}}function wt(t,e,n,i,r=[],s){const o=n.isMercator();let a,h,c;if(o){const t=n.getMap();a=t.getGLRes(),h=t.getSpatialReference().getTransformation().matrix}e&&(c=n.coordinateToVector3(e));const l=[],u=[],d={},f={},p=t.length;for(let a=0;a<p;a++){const h=t[a];let p=r[a]?r[a]:H(i[a]);p=_t(p,s),e||(c=n.coordinateToVector3(p.center));let g=p.width||1,y=p.height||1,x=p.cornerRadius||0,m=p.bottomHeight||0;const v=p.parentCenter;g=vt(g,n,d),x=vt(x,n,d),y=bt(y,n,f),m=bt(m,n,f);const b=[];for(let t=0,i=h.length;t<i;t++){const i=h[t];let r;r=o?dt(i,n):rt(i,n,v||e,!1).arrayBuffer,u.push(r),b.push(r)}const _={id:p.id,data:b,height:y,width:g,cornerRadius:x,bottomHeight:m};o&&(_.center=[c.x,c.y]),l.push(_)}return{datas:l,transfer:u,glRes:a,matrix:h,center:o?[c.x,c.y]:null}}function Mt(t,e,n,i,r=[],s){const o=n.isMercator();let a,h,c;if(o){const t=n.getMap();a=t.getGLRes(),h=t.getSpatialReference().getTransformation().matrix}e&&(c=n.coordinateToVector3(e));const l=[],u=[],d={},f=t.length;for(let a=0;a<f;a++){const h=t[a];let f=r[a]?r[a]:H(i[a]);f=_t(f,s),e||(c=n.coordinateToVector3(f.center));let p=f.bottomHeight||0;p=bt(p,n,d);const g=[];for(let t=0,i=h.length;t<i;t++){const i=h[t];if(o){const t=dt(i,n);u.push(t),g.push(t)}else{const t=rt(i,n,e,!1).arrayBuffer;u.push(t),g.push(t)}}const y={id:f.id,data:g,bottomHeight:p};o&&(y.center=[c.x,c.y]),l.push(y)}return{datas:l,transfer:u,glRes:a,matrix:h,center:o?[c.x,c.y]:null}}function Ot(t){return t.map((t=>t.data))}function zt(t){return t.map((t=>t.option||t.baseObject.getOptions()))}s.worker&&(yt=class extends s.worker.Actor{test(t,e){this.send(t,null,e)}pushQueue(t={}){const{type:e,data:n,callback:i,layer:r,key:s,center:o,lineStrings:a,options:h,id:c,baseOptions:l}=t;let u;e.indexOf("ExtrudePolygon")>-1?u=function(t=[],e,n,i=[],r){const s=n.isMercator();let o,a,h;if(s){const t=n.getMap();o=t.getGLRes(),a=t.getSpatialReference().getTransformation().matrix}e&&(h=n.coordinateToVector3(e));const c=t.length,l=[],u=[],d={};for(let o=0;o<c;o++){const a=t[o],c=a;let f,p=i[o]?i[o]:D(c);p=_t(p,r),e||(h=n.coordinateToVector3(p.center)),f=s?$(a):J(a,n,p.center||e,h,!0);for(let t=0,e=f.length;t<e;t++){const e=f[t];for(let t=0,n=e.length;t<n;t++)u.push(e[t])}let g=p.height||1,y=p.bottomHeight||0;g=bt(g,n,d),y=bt(y,n,d);const x={id:p.id,data:f,height:g,bottomHeight:y};s&&(x.center=[h.x,h.y]),l.push(x),c._properties&&delete c._properties}return{datas:l,transfer:u,glRes:o,matrix:a,center:s?[h.x,h.y]:null}}(n,o,r,h,l):"ExtrudeLines"===e||"Paths"===e?u=wt(n,o,r,a,h,l):"Point"===e||("Line"===e||"FatLine"===e||"Lines"===e||"FatLines"===e?u=Mt(n,o,r,a,h,l):"ExtrudeLine"===e||"Path"===e?u=wt(n,o,r,a,h,l):"Bar"!==e&&"Bars"!==e||(u=function(t){const e=t.length,n=new Float32Array(7*e);let i=0;for(let r=0;r<e;r++){let{center:e,radialSegments:s,radius:o,height:a,altitude:h,id:c}=t[r];e=e||[0,0],n[i]=e[0],n[i+1]=e[1],n[i+2]=s||6,n[i+3]=o||1,n[i+4]=a,n[i+5]=h||0,n[i+6]=c,i+=7}const r=n.buffer;return{datas:r,transfer:[r]}}(n))),u?this.send({type:e,datas:u.datas,glRes:u.glRes,matrix:u.matrix,center:u.center},u.transfer,(function(t,e){t&&console.error(t),e.key=s,e.id=c,i(e)})):console.error(`No processing logic found for type:${e}`)}});class At{constructor(){this.queueMap={},this.tempQueue=[],this.time=this.getCurrentTime(),this.deQueueCount=5,this.resultQueue=[]}getActor(){return mt()}getCurrentTime(){return s.Util.now()}loop(){this.deQueue()}push(t){return this.tempQueue.push(t),t.id&&(this.queueMap[t.id]=t),this}reset(){return this.time=this.getCurrentTime(),this.tempQueue=[],this}pushResult(t){if(t)return Array.isArray(t)||(t=[t]),t.forEach((t=>{this.resultQueue.push(t)})),this}deQueue(){if(!this.resultQueue.length)return this;const t=this.deQueueCount;return(this.resultQueue.slice(0,t)||[]).forEach((t=>{const{id:e}=t;if(this.queueMap[e]){const{baseObject:n}=this.queueMap[e];if(n&&n._workerLoad){n.getLayer()?n._workerLoad(t):console.warn(n," worker Processing completed but removed from the layer")}delete this.queueMap[e]}})),this.resultQueue.splice(0,t),this}}const St=new class extends At{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){mt().pushQueue({type:"ExtrudePolygon",layer:this.tempQueue[0].layer,data:Ot(this.tempQueue),options:zt(this.tempQueue),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},jt=new class extends At{loop(){if(this.tempQueue.length){const t=mt();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"ExtrudePolygons",layer:e.layer,data:e.data,key:e.key,center:e.center,baseOptions:e.option,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},Pt=new class extends At{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){mt().pushQueue({type:"ExtrudeLine",layer:this.tempQueue[0].layer,data:Ot(this.tempQueue),options:zt(this.tempQueue),lineStrings:this.tempQueue.map((t=>t.lineString)),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},Tt=new class extends At{loop(){if(this.tempQueue.length){const t=mt();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"ExtrudeLines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,baseOptions:e.option,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},Ct=new class extends At{constructor(){super(),this.deQueueCount=200}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){mt().pushQueue({type:"Line",layer:this.tempQueue[0].layer,data:Ot(this.tempQueue),options:zt(this.tempQueue),lineStrings:this.tempQueue.map((t=>t.lineString)),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},Lt=new class extends At{loop(){if(this.tempQueue.length){const t=mt();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"Lines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,baseOptions:e.option,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},kt=new class extends At{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){mt().pushQueue({type:"FatLine",layer:this.tempQueue[0].layer,data:Ot(this.tempQueue),options:zt(this.tempQueue),lineStrings:this.tempQueue.map((t=>t.lineString)),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},Vt=new class extends At{loop(){if(this.tempQueue.length){const t=mt();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"FatLines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,baseOptions:e.option,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},Bt=new class extends At{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){mt().pushQueue({type:"Bar",layer:this.tempQueue[0].layer,data:Ot(this.tempQueue),options:zt(this.tempQueue),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},Et=new class extends At{constructor(){super(),this.deQueueCount=1}loop(){if(this.tempQueue.length){const t=mt();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"Bars",layer:e.layer,data:e.data,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},It=new class extends At{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){mt().pushQueue({type:"Path",layer:this.tempQueue[0].layer,data:Ot(this.tempQueue),options:zt(this.tempQueue),lineStrings:this.tempQueue.map((t=>t.lineString)),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},Ut=new class extends At{loop(){if(this.tempQueue.length){const t=mt();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"Paths",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,baseOptions:e.option,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},Ft={isRunning:!1,tasks:[],addTask:t=>{t&&Ft.tasks.push(t)},removeTask:t=>{Ft.tasks.splice(Ft.tasks.indexOf(t),1)},loop(){St.loop(),jt.loop(),Pt.loop(),Tt.loop(),Ct.loop(),Lt.loop(),kt.loop(),Vt.loop(),Bt.loop(),Et.loop(),It.loop(),Ut.loop(),Ft.tasks.forEach((t=>{t&&t.loop&&t.loop()})),s.Util.requestAnimFrame(Ft.loop)},star(){Ft.isRunning||(Ft.isRunning=!0,Ft.loop())}};function Rt(t){const{position:e,normal:n,uv:i,indices:r}=Gt(t),s=new o.BufferGeometry,a=new Float32Array(e.length);return a.fill(1,0,e.length),h(s,"color",new o.BufferAttribute(a,3)),h(s,"normal",new o.BufferAttribute(n,3)),h(s,"position",new o.BufferAttribute(e,3)),i&&i.length&&h(s,"uv",new o.BufferAttribute(i,2)),s.setIndex(new o.BufferAttribute(r,1)),s}function Gt(t){const e={},n={};for(let i=0;i<t.length;++i){const r=t[i];for(const t in r)void 0===e[t]&&(e[t]=[],n[t]=0),e[t].push(r[t]),n[t]+=r[t].length}const i={};let r=0;const s=new Uint32Array(n.indices);for(const t in e)if("indices"===t){const n=e[t];let i=0;for(let t=0,o=n.length;t<o;t++){const o=n[t];for(let t=0,e=o.length;t<e;t++)s[i]=o[t]+r,i++;r+=e.position[t].length/3}}else{const r=Zt(e[t],n[t]);if(!r)return null;i[t]=r}return i.indices=s,i}function Zt(t,e){const n=new Float32Array(e);let i=0;for(let e=0;e<t.length;++e)n.set(t[e],i),i+=t[e].length;return n}function Qt(t){const{position:e,normal:n,uv:i,indices:r}=t,s=new o.BufferGeometry;return h(s,"normal",new o.BufferAttribute(new Float32Array(n),3)),h(s,"position",new o.BufferAttribute(new Float32Array(e),3)),h(s,"uv",new o.BufferAttribute(new Float32Array(i),2)),s.setIndex(new o.BufferAttribute(new Uint32Array(r),1)),s}function Dt(t){const e=new o.BufferGeometry;return h(e,"normal",t.getAttribute("normal")),h(e,"position",t.getAttribute("position").clone()),e.setIndex(t.getIndex()),e}let Ht;function Wt(){if(!Ht){const t=1e-6;Ht=u(t,t,t)}return Ht}Wt();var Nt=Object.freeze({__proto__:null,mergeBufferGeometries:Rt,mergeBufferGeometriesAttribute:Gt,generateBufferGeometry:Qt,generatePickBufferGeometry:Dt,getDefaultBufferGeometry:Wt});const qt=u(1,1,1);qt.translate(0,0,.5);const Xt=new o.Color("#fff"),Kt=new o.Color("#fff");function Jt(t){const e=Object.assign({},t);return e._radius&&(e.radius=e._radius),function(t){const{position:e,normal:n,uv:i,indices:r}=V.exports.cylinder(t.center||[0,0],t),s=new o.BufferGeometry;return h(s,"normal",new o.BufferAttribute(n,3)),h(s,"position",new o.BufferAttribute(e,3)),h(s,"uv",new o.BufferAttribute(i,2)),s.setIndex(new o.BufferAttribute(r,1)),s}(e)}function Yt(t,e,n,i="y",r=0){let s=0;"y"===i?s=1:"z"===i&&(s=2);const a=t.attributes.position.array,c=a.length;Kt.setStyle(e),Xt.setStyle(n);const l=new Float32Array(c);if(Array.isArray(r))for(let t=0,e=r.length;t<e;t++){const{middleZ:e,start:n,end:i}=r[t].position;for(let t=n;t<i;t+=3){a[t+2]>e?(l[t]=Xt.r,l[t+1]=Xt.g,l[t+2]=Xt.b):(l[t]=Kt.r,l[t+1]=Kt.g,l[t+2]=Kt.b)}}else for(let t=0;t<c;t+=3){a[t+s]>r?(l[t]=Xt.r,l[t+1]=Xt.g,l[t+2]=Xt.b):(l[t]=Kt.r,l[t+1]=Kt.g,l[t+2]=Kt.b)}return h(t,"color",new o.BufferAttribute(l,3,!0)),l}function $t(t){const e=[],n=t.length;let i=0;for(let e=0;e<n;e++){const{color:n}=t[e].attributes;n&&(i+=n.array.length)}const r=new Float32Array(i);let s=0;for(let n=0,i=t.length;n<i;n++){const{color:i,normal:o,position:a,uv:h}=t[n].attributes,c=t[n].index;i&&(r.set(i.array,s),s+=i.array.length),e.push({normal:o.array,uv:h.array,position:a.array,indices:c.array})}const a=Rt(e);r.length&&h(a,"color",new o.BufferAttribute(r,3,!0));for(let e=0,n=t.length;e<n;e++)t[e].dispose();return a}function te(){return qt}const ee={radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61",heightEnable:!0};class ne extends _{constructor(t,e,n,i){e=s.Util.extend({},ee,e,{layer:i,coordinate:t}),super(),this._initOptions(e);const{height:r,radius:o,topColor:a,bottomColor:h,altitude:c,asynchronous:u}=e;let d;if(e.height=i.altitudeToVector3(r,r).x,e.radius=i.distanceToVector3(o,o).x,u){d=Wt();const t=s.Util.GUID();this.getOptions().id=t,Bt.push({data:{radius:e.radius,height:e.height,radialSegments:e.radialSegments,id:t},layer:i,id:t,baseObject:this})}else d=Jt(e),a&&(Yt(d,h,a,"z",e.height/2),n.vertexColors=l());this._createMesh(d,n);const f=i.altitudeToVector3(c,c).x,p=i.coordinateToVector3(t,f);this.getObject3d().position.copy(p),this.type="Bar"}_workerLoad(t){const e=Qt(t),{topColor:n,bottomColor:i,height:r}=this.getOptions(),s=this.getObject3d(),o=s.material;if(n){Yt(e,i,n,"z",this.getLayer().altitudeToVector3(r,r).x/2),o.vertexColors=l()}s.geometry=e,s.material.needsUpdate=!0,this._fire("workerload",{target:this})}}function ie(t){const e=[];return t&&t.length&&t.forEach((t=>{t=t instanceof o.Color?t:new o.Color(t),e.push(t.r,t.g,t.b)})),e}const re={altitude:0,bottomHeight:0,colors:null};class se extends _{constructor(t,e,n,i){e=s.Util.extend({},re,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{lineStrings:r,center:a}=ct(t),{asynchronous:c}=e;let u;if(c){u=pt();const n=s.Util.GUID();this.getOptions().id=n,this.getOptions().center=a,Ct.push({id:n,data:r,layer:i,key:e.key,lineString:t,baseObject:this})}else{const t=[];for(let e=0,n=r.length;e<n;e++){const n=r[e],{positions:s}=rt(n,i,a,!1);t.push(lt(s))}const s=ut(t);u=new o.BufferGeometry,h(u,"position",new o.BufferAttribute(s,3)),F(u,e.bottomHeight,i);const c=ie(e.colors);c&&c.length&&(h(u,"color",new o.Float32BufferAttribute(c,3)),n.vertexColors=l())}this._createLineSegments(u,n);const{altitude:d}=e,f=i.altitudeToVector3(d,d).x,p=i.coordinateToVector3(a,f);this.getObject3d().position.copy(p),this.type="Line"}_workerLoad(t){const e=new o.BufferGeometry;h(e,"position",new o.BufferAttribute(new Float32Array(t.position),3));const n=ie(this.getOptions().colors),i=this.getObject3d(),r=i.material;n&&n.length&&(h(e,"color",new o.Float32BufferAttribute(n,3)),r.vertexColors=l()),this._computeLineDistances(e),i.geometry=e,i.material.needsUpdate=!0,this._fire("workerload",{target:this})}}const oe={bottomHeight:0,width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61",heightEnable:!0};class ae extends _{constructor(t,e,n,i){e=s.Util.extend({},oe,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{height:r,width:o,bottomColor:a,topColor:h,bottomHeight:c,altitude:u,asynchronous:d}=e,f=i.altitudeToVector3(r,r).x,p=i.distanceToVector3(o,o).x,{lineStrings:g,center:y}=ct(t);let x;if(d){x=Wt();const e=s.Util.GUID();this.getOptions().id=e,this.getOptions().center=y,Pt.push({id:e,data:g,layer:i,center:y,lineString:t,baseObject:this})}else{const t=[];let e=0;const r={};for(let n=0,s=g.length;n<s;n++){const s=at(g[n],p,f,i,y);e=F(s,c,i,r),t.push(s)}x=Rt(t),h&&(K(x,a,h,e+f/2),n.vertexColors=l())}this._createMesh(x,n);const m=i.altitudeToVector3(u,u).x,v=i.coordinateToVector3(y,m);this.getObject3d().position.copy(v),this.type="ExtrudeLine"}_workerLoad(t){const e=Qt(t),{topColor:n,bottomColor:i,bottomHeight:r,height:s}=this.getOptions(),o=this.getObject3d(),a=o.material;if(n){const t=this.getLayer();K(e,i,n,t.altitudeToVector3(r,r).x+t.altitudeToVector3(s,s).x/2),a.vertexColors=l()}o.geometry=e,o.material.needsUpdate=!0,this._fire("workerload",{target:this})}}const he={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61",heightEnable:!0};class ce extends _{constructor(t,e,n,i){e=s.Util.extend({},he,e,{layer:i,polygon:t}),super(),this._initOptions(e);const{height:r,topColor:o,bottomColor:a,altitude:h,bottomHeight:c,asynchronous:u}=e;let d;const f=z(t)?T(t):t.getCenter();if(u){d=Wt();const e=s.Util.GUID();this.getOptions().id=e,this.getOptions().center=f,St.push({data:t,layer:i,id:e,baseObject:this})}else{d=q(t,r,i);const e=F(d,c,i);if(o){K(d,a,o,e+i.altitudeToVector3(r,r).x/2),n.vertexColors=l()}}this._createMesh(d,n);const p=i.altitudeToVector3(h,h).x,g=i.coordinateToVector3(f,p);this.getObject3d().position.copy(g),this.type="ExtrudePolygon"}_workerLoad(t){const e=Qt(t),{topColor:n,bottomColor:i,bottomHeight:r,height:s}=this.getOptions(),o=this.getObject3d(),a=o.material;if(n){const t=this.getLayer();K(e,i,n,t.altitudeToVector3(r,r).x+t.altitudeToVector3(s,s).x/2),a.vertexColors=l()}o.geometry=e,o.material.needsUpdate=!0,this._fire("workerload",{target:this})}}const le={altitude:0,coordinate:null};class ue extends _{constructor(t,e={},n){e.coordinate||(console.warn("coordinate is null,it is important to locate the model"),e.coordinate=n.getMap().getCenter()),e=s.Util.extend({},le,e,{layer:n,model:t}),super(),this._initOptions(e),this._createGroup(),this.getObject3d().add(t);const{altitude:i,coordinate:r}=e,o=n.altitudeToVector3(i,i).x,a=n.coordinateToVector3(r,o);this.getObject3d().position.copy(a),this.type="Model"}getCoordinates(){const t=this.options.coordinate,e=this.options.altitude,n=new s.Coordinate(t);return n.z=e,n}}const de=Math.PI/180;function fe(t){return t.getCoordinates().map((t=>t.toArray()))}function pe(t){return t*de}function ge(t,e){if(!t||!e)return 0;Array.isArray(t)||(t=t.toArray()),Array.isArray(e)||(e=e.toArray());let n=pe(t[1]);const i=pe(e[1]),r=n-i,s=pe(t[0])-pe(e[0]);return n=2*Math.asin(Math.sqrt(Math.pow(Math.sin(r/2),2)+Math.cos(n)*Math.cos(i)*Math.pow(Math.sin(s/2),2))),n*=6378137,Math.round(1e5*n)/1e5}function ye(t,e){const{len:n,c1:i,c2:r}=t,s=r[0]-i[0],o=r[1]-i[1],a=e/n;return[i[0]+a*s,i[1]+a*o]}function xe(t,e=10){e=Math.max(e,.1),Array.isArray(t)||(t=fe(t));const n=t.length;let i=[],r=0;for(let e=0;e<n-1;e++){const n=ge(t[e],t[e+1]),s=Math.floor(n);i.push({c1:t[e],len:s,c2:t[e+1]}),r+=s}if(r<=e){return i.map((t=>[t.c1,t.c2]))}if(1===i.length&&i[0].len<=e)return[[i[0].c1,i[0].c2]];const s=i.length;let o,a=0,h=0;const c=[];let l=[i[0].c1];for(;a<s;){const{len:t,c2:n}=i[a];if(h+=t,h<e&&(l.push(n),a===s-1&&c.push(l),a++),h===e&&(l.push(n),h=0,c.push(l),l=[n],a++),h>e){const n=t-h+e;o=ye(i[a],n),l.push(o),c.push(l),h=0,i[a].c1=o,i[a].len=t-n,l=[],l.push(o)}}return c}var me=Object.freeze({__proto__:null,distance:ge,lineLength:function(t){let e=t;Array.isArray(t)||(e=fe(t));let n=0;for(let t=0,i=e.length;t<i-1;t++)n+=ge(e[t],e[t+1]);return n},lineSlice:xe});const ve=1e3;const be={trail:5,chunkLength:50,width:2,height:1,speed:1,altitude:0,interactive:!1,heightEnable:!0};class _e extends _{constructor(t,e,n,i){e=s.Util.extend({},be,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{width:r,height:a,altitude:c,speed:l,chunkLength:u,trail:d}=e;let f,p;O(t)?(f=T(t),p=P(t)):(f=t.getCenter(),p=t);const g=xe(p,u),y=i.coordinateToVector3(f),x=new o.BufferGeometry,m=new Float32Array(3e3),v=new Float32Array(3e3),b=new Uint16Array(ve);h(x,"position",new o.BufferAttribute(m,3)),h(x,"normal",new o.BufferAttribute(v,3)),x.setIndex(new o.BufferAttribute(b,1));const _=i.distanceToVector3(r,r).x,w=i.altitudeToVector3(a,a).x;this._createMesh(x,n);const M=i.altitudeToVector3(c,c).x,z=i.coordinateToVector3(f,M);this.getObject3d().position.copy(z),this._params={index:0,chunkLines:g,geometries:[],layer:i,trail:Math.max(1,d),lineWidth:_,depth:w,speed:Math.min(1,l),idx:0,loaded:!0,center:f,centerPt:y,workerInitCount:0},this._init(this._params),this.type="ExtrudeLineTrail"}_init(t){const{layer:e,trail:n,lineWidth:i,depth:r,chunkLines:o,positionMap:a,centerPt:h,center:c}=t,l=o.length,u=[];if(this.options.asynchronous){t.loaded=!1;const i=s.Util.GUID();for(let t=0;t<l;t++){const r={type:"Feature",geometry:{type:"LineString",coordinates:ot(o.slice(t,t+n))}},a=`${i}-${t}`,h=s.Util.extend({},this.options);h.parentCenter=c,h.id=a,h.center=c,Pt.push({id:a,data:[r],layer:e,center:c,lineString:r,baseObject:this,option:h})}}else for(let t=0;t<l;t++){const s=st(o.slice(t,t+n),e,0,h).positionsV;u.push(at(s,i,r,e))}}_animation(){const{index:t,geometries:e,speed:n,idx:i,chunkLines:r,trail:s,lineWidth:o,depth:a,loaded:h,layer:c,positionMap:l,centerPt:u}=this._params;if(!h)return;const d=Math.round(t);if(d>i&&d<=r.length-1){this._params.idx++;let t=e[d];if(!t){t=at(st(r.slice(d,d+s),c,0,u).positionsV,o,a,c),e[d]=t}const n=this.getObject3d();!function(t,e,n,i){const r=e.length;t.attributes.normal.count=r,t.attributes.position.count=r;const s=t.attributes.position.array,o=t.attributes.normal.array;for(let t=0;t<r;t++)s[t]=e[t],o[t]=n[t];t.index.count=i.length;for(let e=0,n=i.length;e<n;e++)t.index.array[e]=i[e]}(n.geometry,t.position,t.normal,t.indices),n.geometry.attributes.position.needsUpdate=!0,n.geometry.attributes.normal.needsUpdate=!0,n.geometry.index.needsUpdate=!0}t>=r.length-1&&(this._params.index=-1,this._params.idx=-1),this._params.index+=n}_workerLoad(t){if(!t)return this;const{id:e,indices:n,position:i,normal:r,uv:o}=t;if(!(e&&n&&i&&r&&o))return;let a=e.split("-")[1];if(a=parseInt(a),s.Util.isNumber(a)){this._params.geometries[a]={indices:new Uint32Array(n),position:new Float32Array(i),uv:new Float32Array(o),normal:new Float32Array(r)},this._params.workerInitCount++}this._params.workerInitCount===this._params.chunkLines.length&&(this._params.loaded=!0,this._fire("workerload",{target:this}))}}const we=["click","mousemove","mousedown","mouseup","dblclick","contextmenu"].join(" ").toString(),Me=new o.MeshBasicMaterial;Me.vertexColors=l();const Oe=t=>class extends t{_initBaseObjectsEvent(t){if(t&&Array.isArray(t)&&t.length)for(let e=0,n=t.length;e<n;e++){const n=t[e];this._proxyEvent(n)}return this}_proxyEvent(t){t.on("add",(t=>{this._showGeometry(t.target,!0)})),t.on("remove",(t=>{this._showGeometry(t.target,!1)})),t.on("mouseout",(t=>{this._mouseover=!1,this.fire("mouseout",Object.assign({},t,{target:this,selectMesh:this.getSelectMesh?this.getSelectMesh():null}))})),t.on(we,(t=>{this.fire(t.type,Object.assign({},t,{target:this,selectMesh:this.getSelectMesh?this.getSelectMesh():null}))}))}_getHideGeometryIndex(t){const e=[];let n=0;for(let i=0,r=this._geometriesAttributes.length;i<r;i++)!0===this._geometriesAttributes[i].hide&&(e.push(i),n+=this._geometriesAttributes[i][t].count);return{indexs:e,count:n}}_updateAttribute(t,e){const{indexs:n}=this._getHideGeometryIndex(e),i=this._geometryCache.attributes[e].array,r=i.length;for(let e=0;e<r;e++)t.array[e]=i[e];let s=NaN;this.getObject3d()instanceof o.LineSegments&&(s=0);for(let i=0;i<n.length;i++){const r=n[i],{start:o,end:a}=this._geometriesAttributes[r][e];for(let e=o;e<a;e++)t.array[e]=s}return this}_showGeometry(t,e){let n;if(t&&(n=t.getOptions().index),null!=n){const t=this._geometriesAttributes[n],{hide:i}=t;if(i===e)return this;t.hide=e;const r=this.getObject3d().geometry;this._updateAttribute(r.attributes.position,"position"),r.attributes.position.needsUpdate=!0,this.isHide=e}return this}getSelectMesh(){const t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}}_getIndex(t){return null==t&&(t=this.faceIndex||this.index),t}_init(){const t=this.getLayer().getPick();this.on("add",(()=>{t.add(this.pickObject3d)})),this.on("remove",(()=>{t.remove(this.pickObject3d)}))}_setPickObject3d(){if(!this._colorMap)return;const t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),{_geometriesAttributes:n}=this,i=n.length,r=R(n);let s=0;for(let t=0;t<i;t++){const i=e.getColor(),o=i.getHex();this._colorMap[o]=t;const{count:a}=n[t].position;this._datas[t].colorIndex=o;for(let t=0;t<a;t++)r[s]=i.r,r[s+1]=i.g,r[s+2]=i.b,s+=3}h(t,"color",new o.BufferAttribute(r,3,!0));const a=e.getColor().getHex(),c=new o.Mesh(t,Me);c.position.copy(this.getObject3d().position),c._colorIndex=a,this.setPickObject3d(c)}},ze={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61"},Ae=new s.Coordinate(0,0);class Se extends(Oe(_)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const r=t.length;0===r&&console.error("polygons is empty");let o=1/0,a=1/0,h=-1/0,c=-1/0;for(let e=0;e<r;e++){const n=t[e],i=n.getCenter?n.getCenter():T(n,Ae);let r,l;Array.isArray(i)?(r=i[0],l=i[1]):i instanceof s.Coordinate&&(r=i.x,l=i.y),o=Math.min(o,r),a=Math.min(a,l),h=Math.max(h,r),c=Math.max(c,l)}const u=new s.Coordinate((o+h)/2,(a+c)/2);e=s.Util.extend({},ze,e,{layer:i,polygons:t,coordinate:u});const{topColor:d,bottomColor:f,altitude:p,asynchronous:g}=e;let y;const x=[],m=[];if(super(),g)y=Wt(),jt.push({id:s.Util.GUID(),layer:i,key:e.key,center:u,data:t,baseObject:this,option:e});else{const o=i.coordinateToVector3(u),a=[];let h=0;const c={};for(let n=0;n<r;n++){const r=t[n],l=s.Util.extend({},e,D(r)),d=l.height||1,f=l.bottomHeight||0,p=X(r,d,i,u,o,c);a.push(p);const g=F(p,f,i,c),{position:y,normal:x,uv:v,indices:b}=p;b.length;const _=y.length/3;x.length,v.length,m[n]={position:{middleZ:g+c[d]/2,count:_,start:h,end:h+3*_},hide:!1},h+=3*_}y=Rt(a),d&&(K(y,f,d,m),n.vertexColors=l())}this._initOptions(e),this._createMesh(y,n);const v=i.altitudeToVector3(p,p).x,b=i.coordinateToVector3(u,v);this.getObject3d().position.copy(b),this._baseObjects=x,this._datas=t,this._geometriesAttributes=m,this.faceIndex=null,this._geometryCache=Dt(y),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(x),g||(this._setPickObject3d(),this._init()),this.type="ExtrudePolygons"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,z(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new ce(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){return this.picked}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=Qt(t);this._geometryCache=Dt(n);const{topColor:i,bottomColor:r}=this.getOptions(),s=this.getObject3d(),o=s.material;if(i&&(K(n,r,i,e),o.vertexColors=l()),s.geometry=n,s.material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}function je(t,e,n){const i=t.project(n),r=e.width/2,s=e.height/2;return{x:Math.round(i.x*r+r),y:Math.round(-i.y*s+s)}}var Pe=Object.freeze({__proto__:null,vectors2Pixel:function(t,e,n,i=0,r){return t[0]instanceof o.Vector3||(t=function(t,e=0,n){const i=[],r={};for(let s=0,a=t.length;s<a;s+=3){let a=t[s],h=t[s+1],c=t[s+2];e>0&&(c+=I(e,n,r)),i.push(new o.Vector3(a,h,c))}return i}(t,i,r)),t.map((t=>je(t,e,n)))},vector2Pixel:je});const Te={altitude:0,height:0,color:null},Ce=new o.Vector3;class Le extends _{constructor(t,e,n,i){e=s.Util.extend({},Te,e,{layer:i,coordinate:t}),super();let{height:r,altitude:a,color:c,size:l}=e;const u=[],d=[];c&&(c=c instanceof o.Color?c:new o.Color(c),d.push(c.r,c.g,c.b));const f=i.altitudeToVector3(r,r).x,p=i.coordinateToVector3(t,f);u.push(0,0,p.z);const g=new o.BufferGeometry;h(g,"position",new o.Float32BufferAttribute(u,3,!0)),d.length&&h(g,"color",new o.Float32BufferAttribute(d,3,!0)),void 0!==l&&h(g,"size",new o.Float32BufferAttribute([l],1,!0)),e.positions=p,this._initOptions(e),this._createPoints(g,n);const y=i.altitudeToVector3(a,a).x,x=new o.Vector3(p.x,p.y,y);this.getObject3d().position.copy(x),this.type="Point"}identify(t){const e=this.getLayer(),n=this.getMap().getSize(),i=this.getLayer().getCamera(),r=this.getOptions().positions,s=this.getOptions().altitude;let o=this.getObject3d().material.size;void 0===o&&(o=this.options.size||1);const a=this.getMap().coordToContainerPoint(t),h=e.altitudeToVector3(s,s).x;Ce.x=r.x,Ce.y=r.y,Ce.z=r.z+h;const c=je(Ce,n,i);return Math.sqrt(Math.pow(a.x-c.x,2)+Math.pow(a.y-c.y,2))<=o/2}}function ke(t,e){const{minx:n,miny:i,maxx:r,maxy:s}=t,[o,a]=e;return n<=o&&o<=r&&i<=a&&a<=s}class Ve{constructor(t,e,n,i){this.minlng=t,this.minlat=e,this.maxlng=n,this.maxlat=i,this.minx=1/0,this.miny=1/0,this.maxx=-1/0,this.maxy=-1/0,this.coordinates=[],this.positions=[],this.indexs=[],this.key=null}updateBBoxPixel(t){let e=1/0,n=1/0,i=-1/0,r=-1/0;const{minlng:o,minlat:a,maxlng:h,maxlat:c}=this;return[[o,a],[o,c],[h,a],[h,c]].map((t=>new s.Coordinate(t))).map((e=>t.coordToContainerPoint(e))).forEach((t=>{e=Math.min(e,t.x),n=Math.min(n,t.y),i=Math.max(i,t.x),r=Math.max(r,t.y)})),this.minx=e,this.miny=n,this.maxx=i,this.maxy=r,this}containsCoordinate(t){let e,n;Array.isArray(t)?(e=t[0],n=t[1]):t instanceof s.Coordinate&&(e=t.x,n=t.y);const{minlng:i,minlat:r,maxlng:o,maxlat:a}=this;return i<=e&&e<=o&&r<=n&&n<=a}isRecCross(t,e){const{x:n,y:i}=t,r={minx:n-e/2,miny:i-e/2,maxx:n+e/2,maxy:i+e/2},{minx:s,miny:o,maxx:a,maxy:h}=r;return!!(ke(this,[s,o])||ke(this,[s,h])||ke(this,[a,o])||ke(this,[a,h])||ke(r,[this.minx,this.miny])||ke(r,[this.minx,this.maxy])||ke(r,[this.maxx,this.miny])||ke(r,[this.maxx,this.maxy]))}static initGrids(t,e,n,i){const r=[],s=(n-t)/30,o=(i-e)/30;let a=t,h=e;for(let n=0;n<30;n++){a=t+n*s;for(let t=0;t<30;t++){h=e+t*o;const i=new Ve(a,h,a+s,h+o);i.key=t+"-"+n,r.push(i)}}return{grids:r,averageX:s,averageY:o,ROWS:30,COLS:30}}}const Be={altitude:0},Ee=new o.Vector3;function Ie(t,e){const n=Math.pow(10,e);return Math.round(t*n)/n}class Ue extends(Oe(_)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]),e=s.Util.extend({},Be,e,{layer:i,points:t});let r=1/0,a=1/0,c=-1/0,l=-1/0;for(let e=0,n=t.length;e<n;e++){const{coordinate:n}=t[e];let i,o;Array.isArray(n)?(i=n[0],o=n[1]):n instanceof s.Coordinate&&(i=n.x,o=n.y),t[e].coords=[i,o],r=Math.min(r,i),a=Math.min(a,o),c=Math.max(c,i),l=Math.max(l,o)}const u=i.coordinateToVector3([(r+c)/2,(a+l)/2]),{grids:d,averageX:f,averageY:p,ROWS:g,COLS:y}=Ve.initGrids(r,a,c,l);d.length;const x=new Float32Array(3*t.length),m=[],v=new Float32Array(3*t.length),b=new Float32Array(t.length),_=[],w=[],M={};let O=0,z=!1,A=!1;const S=new o.Vector3(0,0,0);for(let e=0,n=t.length;e<n;e++){let{coordinate:n,height:s,color:h,size:c,coords:l}=t[e];const y=3*e;h&&(z=!0,h=h instanceof o.Color?h:new o.Color(h),v[y]=h.r,v[y+1]=h.g,v[y+2]=h.b),c&&(A=!0,b[e]=c,O=Math.max(O,c));const _=I(s,i,M),j=i.coordinateToVector3(n,_);S.x=j.x,S.y=j.y,S.z=j.z,S.sub(u),x[y]=S.x,x[y+1]=S.y,x[y+2]=S.z,m.push(j),w[e]={position:{count:1,start:3*e,end:3*e+3},hide:!1};let P=Ie((l[1]-a)/p,4),T=Ie((l[0]-r)/f,4);P-=1,T-=1,P=Math.max(0,P),T=Math.max(0,T),P=Math.ceil(P),T=Math.ceil(T);const C=T*g+P;d[C]&&(d[C].positions.push(j),d[C].indexs.push(e))}const j=new o.BufferGeometry;h(j,"position",new o.BufferAttribute(x,3,!0)),z&&h(j,"color",new o.BufferAttribute(v,3,!0)),A&&h(j,"size",new o.BufferAttribute(b,1,!0)),e.positions=m,super(),this._initOptions(e),this._createPoints(j,n);const P=e.altitude,T=i.altitudeToVector3(P,P).x,C=u.clone();C.z=T,this.getObject3d().position.copy(C),this._baseObjects=_,this._datas=t,this.faceIndex=null,this._geometriesAttributes=w,this._geometryCache=j.clone(),this.isHide=!1,this._initBaseObjectsEvent(_),this._grids=d,this._bindMapEvents(),this.type="Points",this.maxSize=O}_bindMapEvents(){const t=this.getMap(),e="zoomstart zooming zoomend movestart moving moveend pitch rotate";this.on("add",(()=>{this._updateGrids(),t.on(e,this._updateGrids,this)})),this.on("remove",(()=>{t.off(e,this._updateGrids,this)}))}_updateGrids(){const t=this.getMap();this._grids.forEach((e=>{e.indexs.length&&e.updateBBoxPixel(t)}))}getSelectMesh(){const t=this.faceIndex;if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],{coordinate:n,height:i,color:r,size:s}=e;this._baseObjects[t]=new Le(n,{height:i,index:t,color:r,size:s},this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){const e=this.getLayer(),n=this.getMap().getSize(),i=this.getLayer().getCamera(),r=this.getOptions().altitude,s=this.getMap(),o=e.altitudeToVector3(r,r).x;let a=this.getObject3d().material.size;const h=void 0===a,c=s.coordToContainerPoint(t),l=[];if(this._grids.forEach((t=>{t.indexs.length&&t.isRecCross(c,h?this.maxSize:a)&&l.push(t)})),l.length<1)return!1;for(let t=0,e=l.length;t<e;t++)for(let e=l[t].positions.length-1;e>=0;e--){h&&(a=this._datas[l[t].indexs[e]].size||1);const r=l[t].positions[e];Ee.x=r.x,Ee.y=r.y,Ee.z=r.z+o;const s=je(Ee,n,i);if(Math.sqrt(Math.pow(c.x-s.x,2)+Math.pow(c.y-s.y,2))<=a/2)return this.faceIndex=l[t].indexs[e],!0}return!1}}const Fe={coordinate:"",radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61"};class Re extends(Oe(_)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const r=t.length,a=U(t),h=i.coordinateToVector3(a),c=[],u=[],d=[];let f=0;const p={},g={};let y;super(),e=s.Util.extend({},{altitude:0,layer:i,points:t},Fe,e),this._initOptions(e);const x=new o.Vector3;if(e.asynchronous){y=Wt();const n=s.Util.GUID();this.getOptions().id=n;const o=[];for(let n=0;n<r;n++){const r=s.Util.extend({index:n},e,t[n]),{radius:a,radialSegments:c,altitude:l,height:u,coordinate:d}=r,f=E(a,i,p);t[n]._radius=f;const y=I(u,i,g),m=I(l,i,g),v=i.coordinateToVector3(d,0,x).sub(h);o.push({radialSegments:c,radius:f,height:y,center:[v.x,v.y],altitude:m})}Et.push({id:n,data:o,layer:i,baseObject:this})}else{for(let o=0;o<r;o++){const r=s.Util.extend({index:o},e,t[o]),{radius:a,radialSegments:y,altitude:m,topColor:v,bottomColor:b,height:_,coordinate:w}=r,M=E(a,i,p),O=I(_,i,g),z=I(m,i,g),A=i.coordinateToVector3(w,0,x).sub(h),S=Jt({radius:M,height:O,radialSegments:y,center:[A.x,A.y]});v&&(Yt(S,b,v,"z",O/2),n.vertexColors=l());const j=S.attributes.position.array;for(let t=0,e=j.length;t<e;t+=3)j[t+2]+=z;c.push(S);const P=new ne(w,r,n,i);u.push(P),S.index.count;const T=S.attributes.position.count;S.attributes.normal.count,S.attributes.uv.count,d[o]={position:{count:T,start:f,end:f+3*T},hide:!1},f+=3*T}y=$t(c)}this._createMesh(y,n);const m=e.altitude,v=i.altitudeToVector3(m,m).x,b=h.clone();b.z=v,this.getObject3d().position.copy(b),this._baseObjects=u,this._datas=t,this._geometriesAttributes=d,this.faceIndex=null,this._geometryCache=Dt(y),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(u),e.asynchronous||(this._setPickObject3d(),this._init()),this.type="Bars"}identify(){return this.picked}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,e,{index:t,asynchronous:!1});this._baseObjects[t]=new ne(e.coordinate,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=Qt(t);this._geometryCache=Dt(n);const{topColor:i,bottomColor:r}=this.getOptions(),s=this.getObject3d(),o=s.material;if(i&&(Yt(n,r,i,"z",e),o.vertexColors=l()),s.geometry=n,s.material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const Ge={width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61"};class Ze extends(Oe(_)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const r=[],o=[],a=t.length;for(let e=0;e<a;e++){const n=ct(t[e]);r.push(n.center),o.push(n.lineStrings)}const h=U(r);e=s.Util.extend({},Ge,e,{layer:i,lineStrings:t,coordinate:h});const{altitude:c,topColor:u,bottomColor:d,asynchronous:f}=e;let p;const g=[],y=[];if(super(),f)p=Wt(),Tt.push({id:s.Util.GUID(),layer:i,key:e.key,center:h,data:o,lineStrings:t,baseObject:this,option:e});else{const r=[];let c=0;const f={},g={};for(let n=0;n<a;n++){const a=t[n],l=s.Util.extend({},e,H(a),{index:n}),{height:u,width:d,bottomHeight:p}=l,x=E(d,i,f),m=I(u,i,g),v=o[n],b=[];let _=0;for(let t=0,e=v.length;t<e;t++){const e=at(v[t],x,m,i,h);_=F(e,p,i,f),b.push(e)}const w=Gt(b);r.push(w);const{position:M,normal:O,indices:z}=w;z.length;const A=M.length/3;O.length,y[n]={position:{middleZ:_+m/2,count:A,start:c,end:c+3*A},hide:!1},c+=3*A}p=Rt(r),u&&(K(p,d,u,y),n.vertexColors=l())}this._initOptions(e),this._createMesh(p,n);const x=i.altitudeToVector3(c,c).x,m=i.coordinateToVector3(h,x);this.getObject3d().position.copy(m),this._baseObjects=g,this._datas=t,this._geometriesAttributes=y,this.faceIndex=null,this._geometryCache=Dt(p),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(g),f||(this._setPickObject3d(),this._init()),this.type="ExtrudeLines"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,A(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new ae(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){return this.picked}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=Qt(t);this._geometryCache=Dt(n);const{topColor:i,bottomColor:r,bottomHeight:s,height:o}=this.getOptions(),a=this.getObject3d().material;if(i&&(K(n,r,i,e),a.vertexColors=l()),this.getObject3d().geometry=n,this.getObject3d().material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const Qe={altitude:0,colors:null};class De extends(Oe(_)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const r=[],a=[],c=t.length;for(let e=0;e<c;e++){const n=ct(t[e]);r.push(n.center),a.push(n.lineStrings)}const l=U(r);e=s.Util.extend({},Qe,e,{layer:i,lineStrings:t,coordinate:l}),super(),this._initOptions(e);const{asynchronous:u}=e;let d;const f=[],p={};let g=[],y=0,x=[];if(u)d=pt(),Lt.push({id:s.Util.GUID(),layer:i,key:e.key,center:l,data:a,lineStrings:t,baseObject:this,option:e});else{for(let t=0;t<c;t++){const n=a[t];let r=0;for(let t=0,o=n.length;t<o;t++){const o=H(n[t]),a=s.Util.extend({},e,o),{positions:h}=rt(n[t],i,l,!1);F(h,a.bottomHeight,i,p),r+=h.length/3*2-2,x.push(lt(h))}g[t]={position:{count:r,start:y,end:y+3*r},hide:!1},y+=3*r}const t=ut(x);d=new o.BufferGeometry,h(d,"position",new o.BufferAttribute(t,3))}this._createLineSegments(d,n);const{altitude:m}=e,v=i.altitudeToVector3(m,m).x,b=i.coordinateToVector3(l,v);this.getObject3d().position.copy(b),this._baseObjects=f,this._datas=t,this._geometriesAttributes=g,this.faceIndex=null,this.index=null,this._geometryCache=d.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(f),u||(this._setPickObject3d(),this._init()),this.type="Lines"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=s.Util.extend({},this.getOptions(),{index:t},A(e)?e.properties:e.getProperties());this._baseObjects[t]=new se(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_setPickObject3d(){if(!this._colorMap)return;const t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),{_geometriesAttributes:n}=this,i=n.length,r=R(n);let s=0;for(let t=0;t<i;t++){const i=e.getColor(),o=i.getHex();this._colorMap[o]=t;const{count:a}=n[t].position;this._datas[t].colorIndex=o;for(let t=0;t<a;t++)r[s]=i.r,r[s+1]=i.g,r[s+2]=i.b,s+=3}h(t,"color",new o.BufferAttribute(r,3,!0));const a=this.getObject3d().material.clone();a.color.set("#fff"),a.vertexColors=l();const c=e.getColor().getHex(),u=new o.LineSegments(t,a);u.position.copy(this.getObject3d().position),u._colorIndex=c,this.setPickObject3d(u)}identify(t){return this.picked}_workerLoad(t){const{position:e,geometriesAttributes:n}=t;this._geometriesAttributes=n;const i=new o.BufferGeometry;if(h(i,"position",new o.BufferAttribute(new Float32Array(e),3)),this._computeLineDistances(i),this._geometryCache=i.clone(),this.getObject3d().geometry=i,this.getObject3d().material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const He=[],We=[];function Ne(){return{waitingQueue:He,currentQueue:We}}function qe(t,e){for(let n=0,i=t.length;n<i;n++){const i=t[n];if(i){const{key:r,callback:s}=i;if(e===r)return t.splice(n,1),s}}return null}const Xe=document.createElement("canvas");let Ke;function Je(t,e=!1){if(Ke)return Ke;const n=Xe.getContext("2d");return n.clearRect(0,0,256,256),n.save(),Ke=Xe.toDataURL(),Ke}function Ye(t=1,e=1){let n;return"undefined"==typeof document||(n=document.createElement("canvas"),t&&(n.width=t),e&&(n.height=e)),n}Xe.width=Xe.height=256;class $e extends s.TileLayer{constructor(t,e={}){super(s.Util.GUID(),s.Util.extend({urlTemplate:t},e)),this._opts=null,this._layer=null,this.material=null,this.getMaterial=null,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._layerLaodTime=(new Date).getTime()}isAsynchronous(){return this._opts.worker}getBaseObjects(){const t=this._loadTiles,e=[];for(let n in t){const t=this._baseObjectKeys[n];if(t&&Array.isArray(t)&&t.length)for(let n=0,i=t.length;n<i;n++)e.push(t[n])}return e}onSelectMesh(t,e){}formatBaseObjects(t,e){return[]}loopMessage(t){}getTileData(t){const{key:e,url:n,callback:i,img:r}=t;s.Ajax.getJSON(n,{},(function(t,n){t?(console.error(t),i(e,null,r)):i(e,n,r)}))}_getCurentTileKeys(){const t=this.getTiles().tileGrids||[],e=[],n={};for(let i=0,r=t.length;i<r;i++){const r=t[i].tiles||[];for(let t=0,i=r.length;t<i;t++){const{id:i}=r[t];e.push(i),n[i]=!0}}return{keys:e,keysMap:n}}_isLoad(){const{keys:t}=this._getCurentTileKeys(),e=Object.keys(this._renderer.tilesInView);return t.length===e.length}_layerOnLoad(){const t=(new Date).getTime();if(t-this._layerLaodTime<20)return;this._layerLaodTime=t;const e=this._renderer.tilesInView,n=this._loadTiles,i=this._layer,r=this._baseObjectKeys,s=Object.keys(e).length,o=Object.keys(n).length,a=[];if(s&&o)for(let t in n)e[t]||r[t]&&(r[t]||[]).forEach((t=>{a.push(t)}));if(a.length&&i.removeMesh(a,!1),s&&o)for(let t in e)if(!n[t])if(r[t]){const e=r[t];i.addMesh(e)}else{const{x:e,y:n,z:i}=this._getXYZOfIndex(t);this.getTileUrl(e,n,i)}this._loadTiles=Object.assign({},e),this._diffCache()}_init(){}_workerLoad(t){const e=t.target._img;e.currentCount++,e.currentCount===e.needCount&&(e.src=Je(e._key,this._opts.debug))}_generateBaseObjects(t,e,n){if(e&&n){const{keysMap:i}=this._getCurentTileKeys();if(!i[t])return void(n.src=Je(0,this._opts.debug));const r=this.formatBaseObjects(t,e);if(r.length){n.needCount=r.length,n.currentCount=0;for(let e=0,i=r.length;e<i;e++){const i=r[e];i._img=n,i._vt=this,this.isVisible()||i.hide(),this._cachetile(t,i),i.isAsynchronous()||n.currentCount++}this._layer.addMesh(r,!1),n.needCount===n.currentCount&&(n.src=Je(0,this._opts.debug)),this.isAsynchronous()?r.filter((t=>t.isAsynchronous())).forEach((t=>{t.on("workerload",this._workerLoad,this)})):n.src=Je(0,this._opts.debug)}else n.src=Je(0,this._opts.debug);this._loadTiles[t]=!0}else n&&(n.src=Je(0,this._opts.debug))}_diffCache(){if(Object.keys(this._baseObjectKeys).length>this._renderer.tileCache.max){const t=this._renderer.tileCache.data,e=this._renderer.tilesInView,n=[];for(let i in this._baseObjectKeys)t[i]||e[i]||((this._baseObjectKeys[i]||[]).forEach((t=>{t.isAdd&&n.push(t)})),this._diposeBaseObject(i),delete this._baseObjectKeys[i]);n.length&&this._layer.removeMesh(n,!1)}}_diposeBaseObject(t){const e=this._baseObjectKeys[t];e&&e.length&&e.forEach((t=>{t.getObject3d().geometry.dispose(),t._geometryCache&&t._geometryCache.dispose();const e=t._baseObjects;e&&e.length&&e.forEach((t=>{t.getObject3d().geometry.dispose(),t=null})),t._datas=null,t._geometriesAttributes=null,t._faceMap=null,t._colorMap=null,t.pickObject3d&&t.pickObject3d.geometry.dispose(),t=null}))}_cachetile(t,e){this._baseObjectKeys[t]||(this._baseObjectKeys[t]=[]),this._baseObjectKeys[t].push(e)}_getXYZOfIndex(t){const e=t.indexOf("_")>-1?"_":"-";let[n,i,r]=t.split(e).slice(1,4);return{x:parseInt(i),y:parseInt(n),z:parseInt(r)}}_getTileExtent(t,e,n){const i=this.getMap()._getResolution(n);return this._getTileConfig().getTilePrjExtent(t,e,i)}_getTileLngLatExtent(t,e,n){const i=this._getTileExtent(t,e,n);let r=i.getMax(),o=i.getMin();const a=this.getMap().getProjection();return o=a.unproject(o),r=a.unproject(r),new s.Extent(o,r)}}const tn={worker:!1};class en extends $e{constructor(t,e={},n,i){super(s.Util.GUID(),s.Util.extend({urlTemplate:t},tn,e)),this._opts=e,this._layer=i,this.getMaterial=n,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._layerLaodTime=(new Date).getTime(),this._init()}formatBaseObjects(t,e){const n=this._opts,i=[],r=this.isAsynchronous();for(let a in e){const h=e[a]||{};let c;if(Array.isArray(h)?c=h:"FeatureCollection"===h.type&&(c=h.features),c&&c.length){const e=[],l=[],u=[];for(let t=0,n=c.length;t<n;t++){const n=c[t];if(z(n))e.push(n);else if(A(n)){const t=C(n);for(let e=0,n=t.length;e<n;e++)l.push(t[e])}else if(S(n)){const t=C(n);for(let e=0,n=t.length;e<n;e++)u.push(s.Util.extend({},t[e].properties,t[e],{coordinate:P(t[e])}))}}if(e.length){const o=this._getMaterial(a,e,t,h);if(o){const h=this._layer.toExtrudePolygons(e,s.Util.extend({},{topColor:"#fff",layerName:a,asynchronous:r,key:t},n),o);i.push(h)}}if(l.length){const e=this._getMaterial(a,l,t,h);if(e&&(e instanceof o.LineBasicMaterial||e instanceof o.LineDashedMaterial)){const t=this._layer.toLines(l,s.Util.extend({},{layerName:a,asynchronous:r},n),e);i.push(t)}}if(u.length){const e=this._getMaterial(a,u,t,h);if(e&&e instanceof o.PointsMaterial){const t=this._layer.toPoints(u,s.Util.extend({},{layerName:a,asynchronous:r},n),e);i.push(t)}}}}return i}loopMessage(t){const{currentQueue:e}=Ne();e.length>0&&this.getTileData(t)}_init(){this.on("layerload",this._layerOnLoad),this.on("add",(()=>{if(!1===this._add){const t=this.getBaseObjects();this._layer.addMesh(t)}this._add=!0,this.intervalId=setInterval((()=>{this._isLoad()&&!this._layer.getMap().isInteracting()&&this.fire("layerload")}),1e3)})),this.on("remove",(()=>{this._add=!1;const t=this.getBaseObjects();this._layer.removeMesh(t),clearInterval(this.intervalId)})),this.on("show",(()=>{this.getBaseObjects().forEach((t=>{t.show()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.show()}))}})),this.on("hide",(()=>{this.getBaseObjects().forEach((t=>{t.hide()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.hide()}))}})),this.on("renderercreate",(t=>{t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.id),n},t.renderer.deleteTile=function(t){if(!t||!t.image)return;t.image.onload=null,t.image.onerror=null;!function(t){const e=qe(He,t);e&&e(t)}((t.info||{}).id)},t.renderer.loadTileImage=(t,e,n)=>{t._key=n,function(t,e,n,i,r){const s={key:t,url:e,callback:n,img:i,vt:r};We.length<10?(We.push(s),r.loopMessage(s)):He.push(s)}(n,e,((t,e,n)=>{this._generateBaseObjects(t,e,n),function(t,e){if(qe(We,t),He.length){We.push(He[0]),He.splice(0,1);const t=We[We.length-1];e.loopMessage(t)}}(t,this)}),t,this)}}))}_getMaterial(t,e,n,i){return this.getMaterial&&s.Util.isFunction(this.getMaterial)?this.getMaterial(t,e,n,i):null}}function nn(t,e,n,i){const{position:r,uv:s,normal:a,indexs:c}=function(t,e,n,i){const r=t/n,s=e/i,o=-t/2,a=e/2,h=-e/2,c=(n+1)*(i+1),l=new Float32Array(3*c),u=new Float32Array(2*c),d=new Float32Array(3*c),f=new Uint32Array(10*c);let p=0,g=0,y=0;for(let c=0;c<=i;c++)for(let x=0;x<=n;x++){const m=o+r*x,v=a-s*c;l[p]=m,l[p+1]=v,l[p+2]=0,d[p]=0,d[p+1]=0,d[p+2]=1;const b=(m-o)/t,_=(v-h)/e;if(u[g]=b,u[g+1]=_,p+=3,g+=2,x<n&&c<i){const t=c*(n+1)+x,e=t+1,i=(n+1)*(c+1)+x,r=i+1;f[y]=t,f[y+1]=i,f[y+2]=e,f[y+3]=i,f[y+4]=r,f[y+5]=e,y+=6}}const x=new Uint32Array(y);for(let t=0,e=x.length;t<e;t++)x[t]=f[t];return{position:l,uv:u,normal:d,indexs:x}}(t,e,n,i),l=new o.BufferGeometry;return h(l,"position",new o.BufferAttribute(r,3)),h(l,"normal",new o.BufferAttribute(a,3)),h(l,"uv",new o.BufferAttribute(s,2)),l.setIndex(new o.BufferAttribute(c,1)),l}const rn=new o.TextureLoader,sn=document.createElement("canvas");function on(t){if(!t)return null;let e;return"string"==typeof t?(e=new Image,e.src=t):t instanceof HTMLCanvasElement?(e=new Image,e.src=t.toDataURL()):t instanceof Image&&(e=new Image,e.src=t.src,e.crossOrigin=t.crossOrigin),e&&!e.crossOrigin&&(e.crossOrigin="Anonymous"),e}const an=new Map;function hn(t,e,n,i){if(!e||!n)return;const{imageWidth:r,imageHeight:s,flaserBoundary:a}=i;let h;if(h=t instanceof Uint32Array||t instanceof Uint8ClampedArray?t:function(t,e=256,n=256){sn.width=e,sn.height=n;const i=sn.getContext("2d");return i.drawImage(t,0,0,e,n),i.getImageData(0,0,e,n).data}(t,r,s),!h)return void console.error("image is error type data",t);let c=0,l=0,u=0;const d=new o.Vector3,f=an;for(let t=0,i=h.length;t<i;t+=4){const i=.1*(256*h[t]*256+256*h[t+1]+h[t+2])-1e4;let o=0;if(0!==l&&l+1!==s&&0!==u&&u+1!==r||!a){const t=f.get(i);void 0!==t?o=t:(o=n.altitudeToVector3(i,i,null,d).x,f.set(i,o))}e.attributes.position.array[3*c+2]=o,c++,u++,u===r&&(l++,u=0)}e.attributes.position.needsUpdate=!0}const cn={interactive:!1,altitude:0,image:null,imageWidth:256,imageHeight:256,texture:null,flaserBoundary:!0,bufferPixel:1};class ln extends _{constructor(t,e,n,i){e=s.Util.extend({},cn,e,{layer:i,extent:t});const{texture:r,image:o,altitude:a,imageHeight:h,imageWidth:c,flaserBoundary:l,bufferPixel:u}=e;t instanceof s.Extent||(t=new s.Extent(t));const{xmin:d,ymin:f,xmax:p,ymax:g}=t;let y=1/0,x=1/0,m=-1/0,v=-1/0;[[d,f],[d,g],[p,g],[p,f]].forEach((t=>{const e=i.coordinateToVector3(t),{x:n,y:r}=e;y=Math.min(n,y),x=Math.min(r,x),m=Math.max(n,m),v=Math.max(r,v)}));const b=(m-y)/c,_=(v-x)/h;y-=b*u,m+=b*u,x-=_*u,v+=_*u;const w=Math.abs(m-y),M=Math.abs(v-x),O=on(o),z=on(r),A=nn(w,M,c-1,h-1);super(),this._initOptions(e),this._createMesh(A,n);const S=i.altitudeToVector3(a,a).x,j=i.coordinateToVector3(t.getCenter(),S);this.getObject3d().position.copy(j),n.transparent=!0,O&&(O.onload=()=>{hn(O,A,i,{imageWidth:c,imageHeight:h,flaserBoundary:l}),this.fire("dataload",{})},O.onerror=function(){console.error(`not load ${O.src}`),this.fire("dataerror",{})}),z?(n.opacity=0,rn.load(z.src,(t=>{n.map=t,n.opacity=1,n.needsUpdate=!0,this.fire("textureload",{})}))):n.opacity=1,this.type="Terrain"}updateData(t){return hn(t,this.getObject3d().geometry,this.getLayer(),this.getOptions()),this.fire("updatedata",{}),this}}const un={scale:1,tileDivisor:4};class dn extends $e{constructor(t,e={},n,i){super(s.Util.GUID(),s.Util.extend({urlTemplate:t},un,e)),this._opts=e,this._layer=i,this.material=n,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._imgQueue={},this._layerLaodTime=(new Date).getTime(),this._init()}isAsynchronous(){return!1}formatBaseObjects(t,e){const n=this.options,i=[],{scale:r,tileDivisor:s}=n,{x:o,y:a,z:h}=this._getXYZOfIndex(t),c=this.getMap().getZoom(),l=this.getTileUrl(o,a,h),[u,d]=this.options.tileSize,f=this._getTileLngLatExtent(o,a,h),p=this.material.clone();if(h+1>=Math.round(c)){const t=new ln(f,{image:e,imageWidth:u/s,imageHeight:d/s,texture:l},p,this._layer);t.getObject3d().scale.set(r,r,1),i.push(t)}return i}loopMessage(t){this.getTileData(t)}_init(){this.on("layerload",this._layerOnLoad),this.on("add",(()=>{if(!1===this._add){const t=this.getBaseObjects();this._layer.addMesh(t)}this._add=!0,this.intervalId=setInterval((()=>{this._isLoad()&&!this._layer.getMap().isInteracting()&&this.fire("layerload")}),1e3)})),this.on("remove",(()=>{this._add=!1;const t=this.getBaseObjects();this._layer.removeMesh(t),clearInterval(this.intervalId)})),this.on("show",(()=>{this.getBaseObjects().forEach((t=>{t.show()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.show()}))}})),this.on("hide",(()=>{this.getBaseObjects().forEach((t=>{t.hide()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.hide()}))}})),this.on("renderercreate",(t=>{t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.id),n},t.renderer.deleteTile=t=>{if(!t||!t.image)return;t.image.onload=null,t.image.onerror=null;const e=t.info||{},n=this._imgQueue[e.id];n&&(n.src="",n.onload=null,n.onerror=null,delete this._imgQueue[e.id])},t.renderer.loadTileImage=(t,e,n)=>{t._key=n;const i=new Image;this._imgQueue[n]=i;const r={key:n,url:e,rgbImage:i,callback:(t,e,n)=>{this._generateBaseObjects(t,e,n)},img:t,vt:this};this.loopMessage(r)}}))}}
/*!
     * Code from baidu mapv
     * License: BSD-3
     * https://github.com/huiyan-fe/mapv
     *
     */function fn(t){t=t||{},this.gradient=t.gradient||{.25:"rgba(0, 0, 255, 1)",.55:"rgba(0, 255, 0, 1)",.85:"rgba(255, 255, 0, 1)",1:"rgba(255, 0, 0, 1)"},this.maxSize=t.maxSize||35,this.minSize=t.minSize||0,this.max=t.max||100,this.min=t.min||0,this.initPalette()}function pn(t,e,n){var i=gn(n),r=function(t){return t.min||0}(n),s=i-r,o=n.range||null,a=0,h=1024;o&&2===o.length&&(a=(o[0]-r)/s*1024),o&&2===o.length&&(h=(o[1]-r)/s*1024);for(var c,l=n.maxOpacity||.8,u=n.minOpacity||0,d=3,f=t.length;d<f;d+=4)c=4*t[d],t[d]/256>l&&(t[d]=256*l),t[d]/256<u&&(t[d]=256*u),c&&c>=a&&c<=h?(t[d-3]=e[c],t[d-2]=e[c+1],t[d-1]=e[c+2]):t[d]=0}function gn(t){return t.max||100}function yn(t,e,n){var i=gn(n),r=
/*!
     * Code from baidu mapv
     * License: BSD-3
     * https://github.com/huiyan-fe/mapv
     *
     */
function(t){var e=t/2,n=t+e,i=1e4,r=Ye(2*n,2*n),s=r.getContext("2d");return s.shadowBlur=e,s.shadowColor="black",s.shadowOffsetX=s.shadowOffsetY=i,s.beginPath(),s.arc(n-i,n-i,t,0,2*Math.PI,!0),s.closePath(),s.fill(),r}(n._size||n.size||13),s=r.width/2,o=r.height/2,a=e,h={};for(var c in a.forEach((function(t){var e=void 0===t.count?1:t.count,n=Math.min(1,e/i).toFixed(2);h[n]=h[n]||[],h[n].push(t)})),h)if(!isNaN(c)){var l=h[c];t.beginPath(),n.withoutAlpha||(t.globalAlpha=c),l.forEach((function(e){var n=e.coordinate,a=void 0===e.count?1:e.count;t.globalAlpha=a/i,t.drawImage(r,n[0]-s,n[1]-o)}))}}fn.prototype.setMax=function(t){this.max=t||100},fn.prototype.setMin=function(t){this.min=t||0},fn.prototype.setMaxSize=function(t){this.maxSize=t||35},fn.prototype.setMinSize=function(t){this.minSize=t||0},fn.prototype.initPalette=function(){var t=this.gradient,e=Ye(256,1),n=this.paletteCtx=e.getContext("2d"),i=n.createLinearGradient(0,0,256,1);for(var r in t)i.addColorStop(parseFloat(r),t[r]);n.fillStyle=i,n.fillRect(0,0,256,1)},fn.prototype.getColor=function(t){var e=this.getImageData(t);return"rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]/256+")"},fn.prototype.getImageData=function(t){var e=this.paletteCtx.getImageData(0,0,256,1).data;if(void 0===t)return e;var n=this.max,i=this.min;t>n&&(t=n),t<i&&(t=i);var r=4*Math.floor((t-i)/(n-i)*255);return[e[r],e[r+1],e[r+2],e[r+3]]},fn.prototype.getSize=function(t){var e=this.max,n=this.min,i=this.maxSize,r=this.minSize;return t>e&&(t=e),t<n&&(t=n),e>n?r+(t-n)/(e-n)*(i-r):i},fn.prototype.getLegend=function(t){var e=this.gradient,n=t.width||20,i=t.height||180,r=Ye(n,i),s=r.getContext("2d"),o=s.createLinearGradient(0,i,0,0);for(var a in e)o.addColorStop(parseFloat(a),e[a]);return s.fillStyle=o,s.fillRect(0,0,n,i),r};var xn={draw:function(t,e,n){if(!(t.canvas.width<=0||t.canvas.height<=0)){var i=n.strength||.3;t.strokeStyle="rgba(0,0,0,"+i+")";var r=Ye(t.canvas.width,t.canvas.height),s=r.getContext("2d");s.scale(devicePixelRatio,devicePixelRatio),n=n||{},t.save();var o=new fn({gradient:n.gradient});if(yn(s,e,n),!n.absolute){var a=s.getImageData(0,0,t.canvas.width,t.canvas.height);pn(a.data,o.getImageData(),n),t.putImageData(a,0,0),t.restore()}o=null,r=null}},drawGray:yn,colorize:pn};const mn={altitude:0,interactive:!1,min:0,max:100,size:13,gradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},gridScale:.5},vn=2048;class bn extends _{constructor(t,e,n,i){Array.isArray(t)||(t=[t]);let r=1/0,a=1/0,c=-1/0,u=-1/0;const d=[];for(let e=0,n=t.length;e<n;e++){const{coordinate:n,lnglat:s,xy:o}=t[e],h=n||s||o;if(!h){console.warn("not find coordinate");continue}const l=i.coordinateToVector3(h);d.push(l);const{x:f,y:p}=l;r=Math.min(r,f),a=Math.min(a,p),c=Math.max(c,f),u=Math.max(u,p)}e=s.Util.extend({},mn,e,{layer:i,points:t});let{gridScale:f,altitude:p,size:g}=e;const y=Math.abs(c-r),x=Math.abs(u-a),m=Math.max(y*f,x*f);if(m>vn){console.warn(`gridScale: ${f} it's too big. I hope it's a smaller value,canvas max size is 2048* 2048`);f=vn/(m/f)}let v=Math.ceil(y*f),b=Math.ceil(x*f);const _=v/y,w=b/x,M=[],O=Math.ceil(2*g);for(let e=0,n=d.length;e<n;e++){const n=d[e];n.x-=r,n.y-=a,n.x*=_,n.y*=w,n.y=b-n.y,n.x+=O,n.y+=O,M.push({coordinate:[n.x,n.y],count:t[e].count})}v+=2*O,b+=2*O;let z=Ye(v,b),A=z.getContext("2d");xn.drawGray(A,M,e);const S=A.getImageData(0,0,A.canvas.width,A.canvas.height);let j=-1/0;const P=new Float32Array(S.data.length/4),T=new Float32Array(S.data.length/4);for(let t=3,e=S.data.length,n=0;t<e;t+=4){const e=S.data[t];j=Math.max(j,e),T[n]=e,e<=0&&(P[n]=1),n++}const C=new fn({gradient:e.gradient});xn.colorize(S.data,C.getImageData(),e),z=null,A=null;const L=nn(y,x,v-1,b-1),k=L.getIndex().array,V=L.attributes.position.array,B=new Float32Array(V.length),E=new Uint32Array(6*V.length),I=new o.Color;let U=0;for(let t=0,e=V.length,n=0,i=k.length,r=0,s=S.data.length,o=0;t<Math.max(e,i,s);t+=3){if(t<e){const e=T[o];e>0&&(V[t+2]=e/j)}if(n<i){const t=k[n],e=k[n+1],i=k[n+2];P[t]&&P[e]&&P[i]||(E[U]=t,E[U+1]=e,E[U+2]=i,U+=3)}if(r<s){const t=`rgb(${S.data[r]},${S.data[r+1]},${S.data[r+2]})`;I.setStyle(t),B[n]=I.r,B[n+1]=I.g,B[n+2]=I.b}n+=3,r+=4,o++}const F=new Uint32Array(U);for(let t=0;t<U;t++)F[t]=E[t];L.setIndex(new o.BufferAttribute(F,1)),h(L,"color",new o.BufferAttribute(B,3,!0)),n.vertexColors=l(),super(),this._initOptions(e),this._createMesh(L,n);const R=i.altitudeToVector3(p,p).x;this.getObject3d().position.copy(new o.Vector3((r+c)/2,(a+u)/2,R)),this.type="HeatMap"}}const _n=new o.Color;let wn=1;class Mn{constructor(t){this.object3ds=[],this.layer=t,this.camera=t.getCamera(),this.renderer=t.getThreeRenderer(),this.pickingTexture=new o.WebGLRenderTarget(1,1),this.pickingScene=new o.Scene}getColor(){return _n.setHex(wn),wn++,_n}add(t){if(t){const e=t._colorIndex;e&&(this.object3ds[e]=t,this.pickingScene.add(t))}return this}remove(t){if(t){const e=t._colorIndex;e&&(this.object3ds[e]=null,this.pickingScene.remove(t))}return this}isEmpty(){if(0===this.pickingScene.children.length)return!0;for(let t=0,e=this.pickingScene.children.length;t<e;t++){const e=this.pickingScene.children[t];if(e){const t=e.__parent;if(t&&!0===t.getOptions().interactive)return!1}}return!0}pick(t){if(!t)return;if(this.isEmpty())return;const{camera:e,renderer:n,pickingTexture:i,pickingScene:r,object3ds:s,layer:o}=this,a=this.pickingScene.children.length;for(let t=0;t<a;t++){const e=this.pickingScene.children[t];e&&e.__parent&&(e.__parent.picked=!1)}const{width:h,height:c}=o._getRenderer().canvas,l=i.width,u=i.height;h===l&&c===u||i.setSize(h,c),n.setRenderTarget(i),n.clear(),e&&e.layers&&this.camera.layers.set(0),n.render(r,e);const d=new Uint8Array(4),{x:f,y:p}=t;let g=window.devicePixelRatio;const y=o.getMap();y&&(g=y.getDevicePixelRatio?y.getDevicePixelRatio():y.options.devicePixelRatio);const x=f*g,m=i.height-p*g;n.readRenderTargetPixels(i,Math.round(x),Math.round(m),1,1,d);const v=d[0]<<16|d[1]<<8|d[2],b=s[v];if(b)b.__parent&&(s[v].__parent.picked=!0);else for(let t=0;t<a;t++){const e=this.pickingScene.children[t];if(e&&e.__parent){const t=e.__parent;if(t._colorMap&&null!=t._colorMap[v]){t.picked=!0,t.index=t._colorMap[v];break}}}n.setRenderTarget(null)}}const On={bottomHeight:0,altitude:0};class zn extends _{constructor(t,e,n,i){e=s.Util.extend({},On,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{asynchronous:r}=e,{lineStrings:o,center:a}=ct(t),h=new x;let c;if(r){const e=s.Util.GUID();this.getOptions().id=e,this.getOptions().center=a,kt.push({id:e,data:o,lineString:t,center:a,layer:i,baseObject:this})}else{const t=[],n={};for(let r=0,s=o.length;r<s;r++){const s=rt(o[r],i,a,!1).positions;F(s,e.bottomHeight,i,n),t.push(lt(s))}c=ut(t),h.setPositions(c)}this._setMaterialRes(i,n),this._createLine2(h,n);const{altitude:l}=e,u=i.altitudeToVector3(l,l).x,d=i.coordinateToVector3(a,u);this.getObject3d().position.copy(d),r||(this._setPickObject3d(c,n.linewidth),this._init()),this.type="FatLine"}_init(){const t=this.getLayer().getPick();this.on("add",(()=>{t.add(this.pickObject3d)})),this.on("remove",(()=>{t.remove(this.pickObject3d)}))}_setMaterialRes(t,e){const n=t.getMap();if(!n)return this;const i=n.getSize(),r=i.width,s=i.height;e.resolution.set(r,s)}_setPickObject3d(t,e){const n=new x;n.setPositions(t);const i=this.getLayer().getPick().getColor(),r=[];for(let e=0,n=t.length/3;e<n;e++)r.push(i.r,i.g,i.b);n.setColors(r);const s=new g({color:"#fff",linewidth:e,vertexColors:l()});this._setMaterialRes(this.getLayer(),s);const o=i.getHex(),a=new m(n,s);a.position.copy(this.getObject3d().position),a._colorIndex=o,this.setPickObject3d(a)}identify(t){return this.picked}setSymbol(t){if(t&&t instanceof o.Material){t.needsUpdate=!0;const e=this.getMap().getSize(),n=e.width,i=e.height;t.resolution.set(n,i),this.getObject3d().material=t}return this}_workerLoad(t){const e=new Float32Array(t.position),n=this.getObject3d();if(n.geometry.setPositions(e),n.computeLineDistances(),this._setPickObject3d(e,n.material.linewidth),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}_animation(){const t=this.getLayer();if(!t)return this;[this.getObject3d(),this.getPickObject3d()].forEach((e=>{e&&this._setMaterialRes(t,e.material)}))}}const An={altitude:0,colors:null};class Sn extends(Oe(_)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const r=[],o=[],a=t.length;for(let e=0;e<a;e++){const n=ct(t[e]);r.push(n.center),o.push(n.lineStrings)}const h=U(r);e=s.Util.extend({},An,e,{layer:i,lineStrings:t,coordinate:h}),super(),this._initOptions(e);const{asynchronous:c}=e,l=new x,u=[],d={};let f,p,g=[],y=0,m=[];if(c)Vt.push({id:s.Util.GUID(),data:o,key:e.key,center:h,layer:i,baseObject:this,lineStrings:t,option:e});else{for(let t=0;t<a;t++){const n=o[t];let r=0;for(let t=0,o=n.length;t<o;t++){const o=H(n[t]),a=s.Util.extend({},e,o),{positions:c}=rt(n[t],i,h,!1);F(c,a.bottomHeight,i,d),r+=c.length/3*2-2,m.push(lt(c))}g[t]={position:{count:r,start:y,end:y+3*r},instanceStart:{count:r,start:y,end:y+3*r},instanceEnd:{count:r,start:y,end:y+3*r},hide:!1},y+=3*r}f=ut(m),l.setPositions(f)}this._setMaterialRes(i,n),this._createLine2(l,n);const{altitude:v}=e,b=i.altitudeToVector3(v,v).x,_=i.coordinateToVector3(h,b);this.getObject3d().position.copy(_),this._baseObjects=u,this._datas=t,this._geometriesAttributes=g,this.faceIndex=null,this.index=null,this._geometryCache=new x,c||(p=new Float32Array(f),this._geometryCache.setPositions(p)),this._colorMap={},this.isHide=!1,this._initBaseObjectsEvent(u),c||(this._setPickObject3d(p,n.linewidth),this._init()),this.type="FatLines"}_setMaterialRes(t,e){const n=t.getMap();if(!n)return this;const i=n.getSize(),r=i.width,s=i.height;e.resolution.set(r,s)}_setPickObject3d(t,e){if(!this._colorMap)return;const n=this._geometryCache||new x;n.setPositions(t);const i=this.getLayer().getPick(),{_geometriesAttributes:r}=this,s=R(r);let o=0;for(let t=0,e=r.length;t<e;t++){const e=i.getColor(),n=e.getHex();this._colorMap[n]=t;const{count:a}=r[t].position;this._datas[t].colorIndex=n;for(let t=0;t<a;t++)s[o]=e.r,s[o+1]=e.g,s[o+2]=e.b,o+=3}n.setColors(s);const a=new g({color:"#fff",linewidth:e,vertexColors:l()});this._setMaterialRes(this.getLayer(),a);const h=i.getColor().getHex(),c=new m(n,a);c.position.copy(this.getObject3d().position),c._colorIndex=h,this.setPickObject3d(c)}identify(t){return this.picked}setSymbol(t){if(t&&t instanceof o.Material){t.needsUpdate=!0;const e=this.getMap().getSize(),n=e.width,i=e.height;t.resolution.set(n,i),this.getObject3d().material=t}return this}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=s.Util.extend({},this.getOptions(),{index:t},A(e)?e.properties:e.getProperties());this._baseObjects[t]=new zn(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_updateAttribute(t,e){const{indexs:n}=this._getHideGeometryIndex(e),i=this._geometryCache.attributes[e].array,r=i.length;for(let e=0;e<r;e++)t.array[e]=i[e];for(let i=0;i<n.length;i++){const r=n[i],{start:s,end:o}=this._geometriesAttributes[r][e];for(let e=s;e<o;e++)t.array[e]=-1e5}return this}_showGeometry(t,e){let n;if(t&&(n=t.getOptions().index),null!=n){const t=this._geometriesAttributes[n],{hide:i}=t;if(i===e)return this;t.hide=e;const r=this.getObject3d().geometry;this._updateAttribute(r.attributes.instanceStart,"instanceStart"),this._updateAttribute(r.attributes.instanceEnd,"instanceEnd"),r.attributes.instanceStart.data.needsUpdate=!0,r.attributes.instanceEnd.data.needsUpdate=!0,this.isHide=e}return this}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=this.getObject3d(),i=new Float32Array(t.position),r=new Float32Array(i);if(n.geometry.setPositions(new Float32Array(i)),this._geometryCache.setPositions(r),this._setPickObject3d(r,n.material.linewidth),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}_animation(){const t=this.getLayer();if(!t)return this;[this.getObject3d(),this.getPickObject3d()].forEach((e=>{e&&this._setMaterialRes(t,e.material)}))}}const jn={radius:10,height:100,altitude:0,topColor:"",bottomColor:"#2d2f61",heightEnable:!0};class Pn extends _{constructor(t,e,n,i){e=s.Util.extend({},jn,e,{layer:i,coordinate:t}),super(),this._initOptions(e);const{height:r,radius:o,topColor:a,bottomColor:h,altitude:c}=e,u=i.altitudeToVector3(r,r).x,d=i.distanceToVector3(o,o).x,f=te().clone();f.scale(2*d,2*d,u),a&&(Yt(f,h,a,"z",u/2),n.vertexColors=l()),this._createMesh(f,n);const p=i.altitudeToVector3(c,c).x,g=i.coordinateToVector3(t,p);this.getObject3d().position.copy(g),this.type="Box"}}class Tn extends(Oe(_)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const r=t.length,o=U(t),a=i.coordinateToVector3(o),h=[],c=[],u=[];let d=0;e=s.Util.extend({},{altitude:0,layer:i,points:t},e);const f={},p={};for(let o=0;o<r;o++){const r=s.Util.extend({index:o},e,t[o]),{radius:g,altitude:y,topColor:x,bottomColor:m,height:v,coordinate:b}=r,_=E(g,i,f),w=I(v,i,p),M=I(y,i,p),O=te().clone();O.scale(2*_,2*_,w),x&&(Yt(O,m,x,"z",w/2),n.vertexColors=l());const z=i.coordinateToVector3(b).sub(a),A=O.attributes.position.array;for(let t=0,e=A.length;t<e;t+=3)A[t+2]+=M,A[t]+=z.x,A[t+1]+=z.y,A[t+2]+=z.z;h.push(O);const S=new Pn(b,r,n,i);c.push(S),O.index.count;const j=O.attributes.position.count;O.attributes.normal.count,O.attributes.uv.count,u[o]={position:{count:j,start:d,end:d+3*j},hide:!1},d+=3*j}super(),this._initOptions(e);const g=$t(h);this._createMesh(g,n);const y=e.altitude,x=i.altitudeToVector3(y,y).x,m=a.clone();m.z=x,this.getObject3d().position.copy(m),this._baseObjects=c,this._datas=t,this._geometriesAttributes=u,this.faceIndex=null,this._geometryCache=Dt(g),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(c),this._setPickObject3d(),this._init(),this.type="Boxs"}identify(t){return this.picked}}var Cn={exports:{}};function Ln(t,e,n){n=n||2;var i,r,s,o,a,h,c,l=e&&e.length,u=l?e[0]*n:t.length,d=kn(t,0,u,n,!0),f=[];if(!d||d.next===d.prev)return f;if(l&&(d=function(t,e,n,i){var r,s,o,a=[];for(r=0,s=e.length;r<s;r++)(o=kn(t,e[r]*i,r<s-1?e[r+1]*i:t.length,i,!1))===o.next&&(o.steiner=!0),a.push(Dn(o));for(a.sort(Rn),r=0;r<a.length;r++)n=Vn(n=Gn(a[r],n),n.next);return n}(t,e,d,n)),t.length>80*n){i=s=t[0],r=o=t[1];for(var p=n;p<u;p+=n)(a=t[p])<i&&(i=a),(h=t[p+1])<r&&(r=h),a>s&&(s=a),h>o&&(o=h);c=0!==(c=Math.max(s-i,o-r))?1/c:0}return Bn(d,f,n,i,r,c),f}function kn(t,e,n,i,r){var s,o;if(r===ii(t,e,n,i)>0)for(s=e;s<n;s+=i)o=ti(s,t[s],t[s+1],o);else for(s=n-i;s>=e;s-=i)o=ti(s,t[s],t[s+1],o);return o&&qn(o,o.next)&&(ei(o),o=o.next),o}function Vn(t,e){if(!t)return t;e||(e=t);var n,i=t;do{if(n=!1,i.steiner||!qn(i,i.next)&&0!==Nn(i.prev,i,i.next))i=i.next;else{if(ei(i),(i=e=i.prev)===i.next)break;n=!0}}while(n||i!==e);return e}function Bn(t,e,n,i,r,s,o){if(t){!o&&s&&function(t,e,n,i){var r=t;do{null===r.z&&(r.z=Qn(r.x,r.y,e,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e,n,i,r,s,o,a,h,c=1;do{for(n=t,t=null,s=null,o=0;n;){for(o++,i=n,a=0,e=0;e<c&&(a++,i=i.nextZ);e++);for(h=c;a>0||h>0&&i;)0!==a&&(0===h||!i||n.z<=i.z)?(r=n,n=n.nextZ,a--):(r=i,i=i.nextZ,h--),s?s.nextZ=r:t=r,r.prevZ=s,s=r;n=i}s.nextZ=null,c*=2}while(o>1)}(r)}(t,i,r,s);for(var a,h,c=t;t.prev!==t.next;)if(a=t.prev,h=t.next,s?In(t,i,r,s):En(t))e.push(a.i/n),e.push(t.i/n),e.push(h.i/n),ei(t),t=h.next,c=h.next;else if((t=h)===c){o?1===o?Bn(t=Un(Vn(t),e,n),e,n,i,r,s,2):2===o&&Fn(t,e,n,i,r,s):Bn(Vn(t),e,n,i,r,s,1);break}}}function En(t){var e=t.prev,n=t,i=t.next;if(Nn(e,n,i)>=0)return!1;for(var r=t.next.next;r!==t.prev;){if(Hn(e.x,e.y,n.x,n.y,i.x,i.y,r.x,r.y)&&Nn(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function In(t,e,n,i){var r=t.prev,s=t,o=t.next;if(Nn(r,s,o)>=0)return!1;for(var a=r.x<s.x?r.x<o.x?r.x:o.x:s.x<o.x?s.x:o.x,h=r.y<s.y?r.y<o.y?r.y:o.y:s.y<o.y?s.y:o.y,c=r.x>s.x?r.x>o.x?r.x:o.x:s.x>o.x?s.x:o.x,l=r.y>s.y?r.y>o.y?r.y:o.y:s.y>o.y?s.y:o.y,u=Qn(a,h,e,n,i),d=Qn(c,l,e,n,i),f=t.prevZ,p=t.nextZ;f&&f.z>=u&&p&&p.z<=d;){if(f!==t.prev&&f!==t.next&&Hn(r.x,r.y,s.x,s.y,o.x,o.y,f.x,f.y)&&Nn(f.prev,f,f.next)>=0)return!1;if(f=f.prevZ,p!==t.prev&&p!==t.next&&Hn(r.x,r.y,s.x,s.y,o.x,o.y,p.x,p.y)&&Nn(p.prev,p,p.next)>=0)return!1;p=p.nextZ}for(;f&&f.z>=u;){if(f!==t.prev&&f!==t.next&&Hn(r.x,r.y,s.x,s.y,o.x,o.y,f.x,f.y)&&Nn(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;p&&p.z<=d;){if(p!==t.prev&&p!==t.next&&Hn(r.x,r.y,s.x,s.y,o.x,o.y,p.x,p.y)&&Nn(p.prev,p,p.next)>=0)return!1;p=p.nextZ}return!0}function Un(t,e,n){var i=t;do{var r=i.prev,s=i.next.next;!qn(r,s)&&Xn(r,i,i.next,s)&&Yn(r,s)&&Yn(s,r)&&(e.push(r.i/n),e.push(i.i/n),e.push(s.i/n),ei(i),ei(i.next),i=t=s),i=i.next}while(i!==t);return Vn(i)}function Fn(t,e,n,i,r,s){var o=t;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&Wn(o,a)){var h=$n(o,a);return o=Vn(o,o.next),h=Vn(h,h.next),Bn(o,e,n,i,r,s),void Bn(h,e,n,i,r,s)}a=a.next}o=o.next}while(o!==t)}function Rn(t,e){return t.x-e.x}function Gn(t,e){var n=function(t,e){var n,i=e,r=t.x,s=t.y,o=-1/0;do{if(s<=i.y&&s>=i.next.y&&i.next.y!==i.y){var a=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(a<=r&&a>o){if(o=a,a===r){if(s===i.y)return i;if(s===i.next.y)return i.next}n=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!n)return null;if(r===o)return n;var h,c=n,l=n.x,u=n.y,d=1/0;i=n;do{r>=i.x&&i.x>=l&&r!==i.x&&Hn(s<u?r:o,s,l,u,s<u?o:r,s,i.x,i.y)&&(h=Math.abs(s-i.y)/(r-i.x),Yn(i,t)&&(h<d||h===d&&(i.x>n.x||i.x===n.x&&Zn(n,i)))&&(n=i,d=h)),i=i.next}while(i!==c);return n}(t,e);if(!n)return e;var i=$n(n,t),r=Vn(n,n.next);return Vn(i,i.next),e===n?r:e}function Zn(t,e){return Nn(t.prev,t,e.prev)<0&&Nn(e.next,t,t.next)<0}function Qn(t,e,n,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Dn(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function Hn(t,e,n,i,r,s,o,a){return(r-o)*(e-a)-(t-o)*(s-a)>=0&&(t-o)*(i-a)-(n-o)*(e-a)>=0&&(n-o)*(s-a)-(r-o)*(i-a)>=0}function Wn(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&Xn(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(Yn(t,e)&&Yn(e,t)&&function(t,e){var n=t,i=!1,r=(t.x+e.x)/2,s=(t.y+e.y)/2;do{n.y>s!=n.next.y>s&&n.next.y!==n.y&&r<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)&&(Nn(t.prev,t,e.prev)||Nn(t,e.prev,e))||qn(t,e)&&Nn(t.prev,t,t.next)>0&&Nn(e.prev,e,e.next)>0)}function Nn(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function qn(t,e){return t.x===e.x&&t.y===e.y}function Xn(t,e,n,i){var r=Jn(Nn(t,e,n)),s=Jn(Nn(t,e,i)),o=Jn(Nn(n,i,t)),a=Jn(Nn(n,i,e));return r!==s&&o!==a||(!(0!==r||!Kn(t,n,e))||(!(0!==s||!Kn(t,i,e))||(!(0!==o||!Kn(n,t,i))||!(0!==a||!Kn(n,e,i)))))}function Kn(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function Jn(t){return t>0?1:t<0?-1:0}function Yn(t,e){return Nn(t.prev,t,t.next)<0?Nn(t,e,t.next)>=0&&Nn(t,t.prev,e)>=0:Nn(t,e,t.prev)<0||Nn(t,t.next,e)<0}function $n(t,e){var n=new ni(t.i,t.x,t.y),i=new ni(e.i,e.x,e.y),r=t.next,s=e.prev;return t.next=e,e.prev=t,n.next=r,r.prev=n,i.next=n,n.prev=i,s.next=i,i.prev=s,i}function ti(t,e,n,i){var r=new ni(t,e,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function ei(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function ni(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function ii(t,e,n,i){for(var r=0,s=e,o=n-i;s<n;s+=i)r+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return r}Cn.exports=Ln,Cn.exports.default=Ln,Ln.deviation=function(t,e,n,i){var r=e&&e.length,s=r?e[0]*n:t.length,o=Math.abs(ii(t,0,s,n));if(r)for(var a=0,h=e.length;a<h;a++){var c=e[a]*n,l=a<h-1?e[a+1]*n:t.length;o-=Math.abs(ii(t,c,l,n))}var u=0;for(a=0;a<i.length;a+=3){var d=i[a]*n,f=i[a+1]*n,p=i[a+2]*n;u+=Math.abs((t[d]-t[p])*(t[f+1]-t[d+1])-(t[d]-t[f])*(t[p+1]-t[d+1]))}return 0===o&&0===u?0:Math.abs((u-o)/o)},Ln.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},i=0,r=0;r<t.length;r++){for(var s=0;s<t[r].length;s++)for(var o=0;o<e;o++)n.vertices.push(t[r][s][o]);r>0&&(i+=t[r-1].length,n.holes.push(i))}return n};var ri=Cn.exports;function si(t,e,n){var i=e[0],r=e[1],s=n[0]-i,o=n[1]-r;if(0!==s||0!==o){var a=((t[0]-i)*s+(t[1]-r)*o)/(s*s+o*o);a>1?(i=n[0],r=n[1]):a>0&&(i+=s*a,r+=o*a)}return(s=t[0]-i)*s+(o=t[1]-r)*o}function oi(t,e,n,i,r){for(var s,o=i,a=e+1;a<n;a++){var h=si(t[a],t[e],t[n]);h>o&&(s=a,o=h)}o>i&&(s-e>1&&oi(t,e,s,i,r),r.push(t[s]),n-s>1&&oi(t,s,n,i,r))}function ai(t,e){var n=t.length-1,i=[t[0]];return oi(t,0,n,e,i),i.push(t[n]),i}function hi(t,e,n){if(t.length<=2)return t;var i=void 0!==e?e*e:1;return t=n?t:function(t,e){for(var n,i,r,s,o,a=t[0],h=[a],c=1,l=t.length;c<l;c++)n=t[c],r=a,s=void 0,o=void 0,s=(i=n)[0]-r[0],o=i[1]-r[1],s*s+o*o>e&&(h.push(n),a=n);return a!==n&&h.push(n),h}(t,i),t=ai(t,i)}function ci(t,e){return t[0]*e[0]+t[1]*e[1]}function li(t,e){const n=e[0],i=e[1],r=Math.sqrt(n*n+i*i);return t[0]=n/r,t[1]=i/r,t}function ui(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t}function di(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t}function fi(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function pi(t,e){const n=e[0],i=e[1],r=e[2],s=Math.sqrt(n*n+i*i+r*r);return t[0]=n/s,t[1]=i/s,t[2]=r/s,t}function gi(t,e,n){var i=e[0],r=e[1],s=e[2],o=n[0],a=n[1],h=n[2];return t[0]=r*h-s*a,t[1]=s*o-i*h,t[2]=i*a-r*o,t}const yi=[];function xi(t,e,n,i){const r=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}(e,n),s=Math.acos(r)*i;return ui(yi,n,e,-r),function(t,e){const n=e[0],i=e[1],r=e[2],s=Math.sqrt(n*n+i*i+r*r);t[0]=n/s,t[1]=i/s,t[2]=r/s}(yi,yi),function(t,e,n){t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n}(t,e,Math.cos(s)),ui(t,t,yi,Math.sin(s)),t}function mi(t,e,n,i,r,s,o,a,h,c){const l=o-r,u=a-s,d=(l*(e-s)-u*(t-r))/(u*(n-t)-l*(i-e));return h&&(h[c=c||0]=t+d*(n-t),h[c+1]=e+d*(i-e)),d}function vi(t,e,n){if(n-e<3)return 0;let i=0;for(let r=2*(n-1),s=2*e;s<2*n;){const e=t[r],n=t[r+1],o=t[s],a=t[s+1];r=s,s+=2,i+=e*a-o*n}return i}function bi(t,e,n=2){return ri(t,e,n)}const _i=[],wi=[],Mi=[];function Oi(t,e,n,i,r,s,o,a,h){const c=null!=o;let l,u,d,f=r,p=null;c&&(p=new Uint32Array(i-n));let g=[];for(let r=n;r<i;r++){const y=r===i-1?n:r+1,x=r===n?i-1:r-1,m=t[2*x],v=t[2*x+1],b=t[2*r],_=t[2*r+1],w=t[2*y],M=t[2*y+1];_i[0]=b-m,_i[1]=_-v,wi[0]=w-b,wi[1]=M-_,li(_i,_i),li(wi,wi),c&&(p[r]=f);let O,z,A=!1;if(a||r!==n)if(a||r!==i-1){di(Mi,wi,_i);const t=Mi[1];Mi[1]=-Mi[0],Mi[0]=t,li(Mi,Mi);const n=ci(Mi,wi),i=Math.sqrt(1-n*n),r=s*Math.min(10,1/i),a=s*n<0;if(c&&1/i>o&&a){const t=b+Mi[0]*s,n=_+Mi[1]*s,r=Math.acos(i)/2,o=Math.tan(r)*Math.abs(s);e[2*f]=t+Mi[1]*o,e[2*f+1]=n-Mi[0]*o,f++,e[2*f]=t-Mi[1]*o,e[2*f+1]=n+Mi[0]*o,f++}else O=b+Mi[0]*r,z=_+Mi[1]*r,A=!0;if(A){if(h&&null!=l){const t=mi(m,v,l,u,b,_,O,z,g,0);t>=-.01&&t<=1.01&&(e[2*d]=O=g[0],e[2*d+1]=z=g[1])}l=e[2*f]=O,u=e[2*f+1]=z,d=f,f++}}else Mi[0]=_i[1],Mi[1]=-_i[0],li(Mi,Mi),O=b+Mi[0]*s,z=_+Mi[1]*s,A=!0;else Mi[0]=wi[1],Mi[1]=-wi[0],li(Mi,Mi),l=e[2*f]=b+Mi[0]*s,u=e[2*f+1]=_+Mi[1]*s,d=f,f++}return p}function zi(t,e,n,i,r,s,o,a){const h=null!=o;let c=r,l=null;h&&(l=new Uint32Array(i-n));for(let r=n;r<i;r++){const u=r===i-1?n:r+1,d=r===n?i-1:r-1,f=t[2*d],p=t[2*d+1],g=t[2*r],y=t[2*r+1],x=t[2*u],m=t[2*u+1];if(_i[0]=g-f,_i[1]=y-p,wi[0]=x-g,wi[1]=m-y,li(_i,_i),li(wi,wi),h&&(l[r]=c),a||r!==n)if(a||r!==i-1){di(Mi,wi,_i);const t=Mi[1];Mi[1]=-Mi[0],Mi[0]=t,li(Mi,Mi);const n=ci(Mi,wi),i=Math.sqrt(1-n*n),r=s*Math.min(10,1/i),a=s*n<0;if(h&&1/i>o&&a){const t=g+Mi[0]*s,n=y+Mi[1]*s,r=Math.acos(i)/2,o=Math.tan(r)*Math.abs(s);e[2*c]=t+Mi[1]*o,e[2*c+1]=n-Mi[0]*o,c++,e[2*c]=t-Mi[1]*o,e[2*c+1]=n+Mi[0]*o,c++}else e[2*c]=g+Mi[0]*r,e[2*c+1]=y+Mi[1]*r,c++}else Mi[0]=_i[1],Mi[1]=-_i[0],li(Mi,Mi),e[2*c]=g+Mi[0]*s,e[2*c+1]=y+Mi[1]*s,c++;else Mi[0]=wi[1],Mi[1]=-wi[0],li(Mi,Mi),e[2*c]=g+Mi[0]*s,e[2*c+1]=y+Mi[1]*s,c++}return l}function Ai(t,e,n,i,r){const s=null!=i?[]:new Float32Array(t.length);if(Oi(t,s,0,e&&e.length?e[0]:t.length/2,0,n,i,r,!0),e)for(let o=0;o<e.length;o++){const a=e[o];Oi(t,s,a,e[o+1]||t.length/2,null!=i?s.length/2:a,n,i,r,!1)}return s}function Si(t,e,n,i){for(let r=0;r<Math.floor((i-n)/2);r++)for(let s=0;s<e;s++){const o=(r+n)*e+s,a=(i-r-1)*e+s,h=t[o];t[o]=t[a],t[a]=h}return t}function ji(t,e){let n=t.length/2,i=0,r=e&&e.length?e[0]:n;vi(t,i,r)>0&&Si(t,2,i,r);for(let s=1;s<(e?e.length:0)+1;s++)i=e[s-1],r=e[s]||n,vi(t,i,r)<0&&Si(t,2,i,r)}function Pi(t){t.depth=t.depth||1,t.bevelSize=t.bevelSize||0,t.bevelSegments=null==t.bevelSegments?2:t.bevelSegments,t.smoothBevel=t.smoothBevel||!1,t.simplify=t.simplify||0,null==t.smoothSide&&(t.smoothSide="auto"),null==t.smoothSideThreshold&&(t.smoothSideThreshold=.9),"number"==typeof t.depth&&(t.bevelSize=Math.min(t.bevelSegments>0?t.bevelSize:0,t.depth/2)),t.bevelSize>0||(t.bevelSegments=0),t.bevelSegments=Math.round(t.bevelSegments);const e=t.boundingRect;if(t.translate=t.translate||[0,0],t.scale=t.scale||[1,1],t.fitRect){let n=null==t.fitRect.x?e.x||0:t.fitRect.x,i=null==t.fitRect.y?e.y||0:t.fitRect.y,r=t.fitRect.width,s=t.fitRect.height;null==r?null!=s?r=s/e.height*e.width:(r=e.width,s=e.height):null==s&&(s=r/e.width*e.height),t.scale=[r/e.width,s/e.height],t.translate=[(n-e.x)*t.scale[0],(i-e.y)*t.scale[1]]}}const Ti=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function Ci(t,e,n){let i=0,r=t[e],s=t[e+1];const o=r,a=s;for(let o=e+2;o<n;o+=2){const e=t[o],n=t[o+1];i+=Math.sqrt((e-r)*(e-r)+(n-s)*(n-s)),r=e,s=n}return i+=Math.sqrt((r-o)*(r-o)+(s-a)*(s-a)),i}function Li(t,{vertices:e,topVertices:n,splittedMap:i,depth:r,rect:s},o,a,h,c){const l=a-o,u=c.smoothBevel?1:2,d=Math.min(r/2,c.bevelSize),f=c.bevelSegments,p=h.vertex,g=h.ringPerimeter,y=Math.max(s.width,s.height,r,g);function x(t){const n=(t+1)%l,i=e[2*t],r=e[2*t+1],s=e[2*n],o=e[2*n+1];return i===s&&r===o}if(d>0){const s=[0,0,1],a=[],c=[0,0,-1],g=[];let m=0,v=new Float32Array(l);for(let b=0;b<2;b++){const _=0===b?r-d:d;for(let r=0;r<=f*u;r++){let w,M,O=0;for(let z=0;z<l;z++){const A=2*(z%l+o),S=i?2*i[A/2]:A;a[0]=e[A]-n[S],a[1]=e[A+1]-n[S+1],a[2]=0;const j=Math.sqrt(a[0]*a[0]+a[1]*a[1]);a[0]/=j,a[1]/=j;const P=(Math.floor(r/u)+r%u)/f;0===b?xi(g,s,a,P):xi(g,a,c,P);const T=0===b?P:1-P,C=d*Math.sin(T*Math.PI/2),L=j*Math.cos(T*Math.PI/2),k=d*j/Math.sqrt(C*C+L*L),V=g[0]*k+n[S],B=g[1]*k+n[S+1],E=g[2]*k+_;if(t.position[3*h.vertex]=V,t.position[3*h.vertex+1]=B,t.position[3*h.vertex+2]=E,z>0&&(O+=Math.sqrt((w-V)*(w-V)+(M-B)*(M-B))),r>0||b>0){let e=3*(h.vertex-l),n=t.position[e],i=t.position[e+1],r=t.position[e+2];v[z]+=Math.sqrt((n-V)*(n-V)+(i-B)*(i-B)+(r-E)*(r-E))}if(t.uv[2*h.vertex]=O/y,t.uv[2*h.vertex+1]=v[z]/y,w=V,M=B,h.vertex++,!x(z)&&(u>1&&r%u||1===u&&r>=1))for(let e=0;e<6;e++){const n=(Ti[e][0]+z)%l,i=Ti[e][1]+m;t.indices[h.index++]=(i-1)*l+n+p}}m++}}}else for(let n=0;n<2;n++){const i=0===n?r-d:d;let s,a,c=0;for(let n=0;n<l;n++){const r=2*(n%l+o),u=e[r],d=e[r+1];t.position[3*h.vertex]=u,t.position[3*h.vertex+1]=d,t.position[3*h.vertex+2]=i,n>0&&(c+=Math.sqrt((s-u)*(s-u)+(a-d)*(a-d))),t.uv[2*h.vertex]=c/y,t.uv[2*h.vertex+1]=i/y,s=u,a=d,h.vertex++}}const m=d>0?f*u+1:1;for(let e=0;e<l;e++)if(!x(e))for(let n=0;n<6;n++){const i=(Ti[n][0]+e)%l,r=Ti[n][1]+m;t.indices[h.index++]=(r-1)*l+i+p}}function ki({indices:t,topVertices:e,rect:n,depth:i},r,s,o){if(e.length<=4)return;const a=s.vertex,h=t.length;for(let e=0;e<h;e++)r.indices[s.index++]=a+t[e];const c=Math.max(n.width,n.height);for(let t=0;t<(o.excludeBottom?1:2);t++)for(let o=0;o<e.length;o+=2){const a=e[o],h=e[o+1];r.position[3*s.vertex]=a,r.position[3*s.vertex+1]=h,r.position[3*s.vertex+2]=(1-t)*i,r.uv[2*s.vertex]=(a-n.x)/c,r.uv[2*s.vertex+1]=(h-n.y)/c,s.vertex++}if(!o.excludeBottom){const n=e.length/2;for(let e=0;e<h;e+=3)for(let i=0;i<3;i++)r.indices[s.index++]=a+n+t[e+2-i]}}function Vi(t,e,n,i){const r=null==n||"auto"===n;if(!0===n)return{vertices:t,holes:e};const s=[],o=e&&[],a=t.length/2,h=[],c=[],l=[];let u=0,d=0;const f=(e?e.length:0)+1;for(let n=0;n<f;n++){0===n?d=e&&e.length?e[0]:a:(u=e[n-1],d=e[n]||a);for(let e=u;e<d;e++){const n=t[2*e],o=t[2*e+1],a=e===d-1?u:e+1,f=t[2*a],p=t[2*a+1];if(r){const r=e===u?d-1:e-1,a=t[2*r],g=t[2*r+1];h[0]=a-n,h[1]=g-o,c[0]=f-n,c[1]=p-o,li(h,h),li(c,c);1-(.5*ci(h,c)+.5)>i?(s.push(n,o),l.push(e)):(s.push(n,o,n,o),l.push(e,e))}else s.push(n,o,n,o),l.push(e,e)}n<f-1&&o&&o.push(s.length/2)}return{vertices:new Float32Array(s),splittedMap:l,holes:o}}function Bi(t,e){let n=0,i=0;for(let r=0;r<t.length;r++){const{indices:s,vertices:o,splittedMap:a,topVertices:h,depth:c}=t[r],l=Math.min(c/2,e.bevelSize)>0?e.bevelSegments:0,u=t[r].holes||[];n+=s.length*(e.excludeBottom?1:2),i+=h.length/2*(e.excludeBottom?1:2);const d=2+2*l;let f=0,p=0;for(let t=0;t<u.length+1;t++){0===t?p=u.length?u[0]:o.length/2:(f=u[t-1],p=u[t]||o.length/2);n+=6*((a?a[p-1]+1:p)-(a?a[f]:f))*(d-1);const r=p-f;i+=r*d+(e.smoothBevel?0:l*r*2)}}const r={position:new Float32Array(3*i),indices:new(i>65535?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*i)},s={vertex:0,index:0,ringPerimeter:0};for(let n=0;n<t.length;n++)ki(t[n],r,s,e);for(let n=0;n<t.length;n++){const{holes:i,vertices:o}=t[n],a=o.length/2;let h=0,c=i&&i.length?i[0]:a;if(s.ringPerimeter=Ci(t[n].topVertices,h,c),Li(r,t[n],h,c,s,e),i)for(let o=0;o<i.length;o++)h=i[o],c=i[o+1]||a,s.ringPerimeter=Ci(t[n].topVertices,h,c),Li(r,t[n],h,c,s,e)}for(let t=0;t<r.uv.length;t++){const e=r.uv[t];e>0&&Math.round(e)===e?r.uv[t]=1:r.uv[t]=e%1}return r.normal=function(t,e){function n(t,e,n,i){t[0]=e,t[1]=n,t[2]=i}const i=[],r=[],s=[],o=[],a=[],h=[],c=t.length,l=new Float32Array(e.length);for(let u=0;u<c;){const c=3*t[u++],d=3*t[u++],f=3*t[u++];n(i,e[c],e[c+1],e[c+2]),n(r,e[d],e[d+1],e[d+2]),n(s,e[f],e[f+1],e[f+2]),fi(o,i,r),fi(a,r,s),gi(h,o,a);for(let t=0;t<3;t++)l[c+t]=l[c+t]+h[t],l[d+t]=l[d+t]+h[t],l[f+t]=l[f+t]+h[t]}for(var u=0;u<l.length;)n(h,l[u],l[u+1],l[u+2]),pi(h,h),l[u++]=h[0],l[u++]=h[1],l[u++]=h[2];return l}(r.indices,r.position),r.boundingRect=t[0]&&t[0].rect,r}function Ei(t,e,n){const i=n.lineWidth,r=t.length,s=new Float32Array(2*r),o=n.translate||[0,0],a=n.scale||[1,1];for(let e=0,n=0;e<r;e++)s[n++]=t[e][0]*a[0]+o[0],s[n++]=t[e][1]*a[1]+o[1];vi(s,0,r)<0&&Si(s,2,0,r);const h=[],c=[],l=n.miterLimit,u=zi(s,c,0,r,0,-i/2,l,!1);Si(s,2,0,r);const d=zi(s,h,0,r,0,-i/2,l,!1),f=(h.length+c.length)/2,p=new Float32Array(2*f);let g=0;const y=c.length/2;for(let t=0;t<c.length;t++)p[g++]=c[t];for(let t=0;t<h.length;t++)p[g++]=h[t];const x=new(f>65535?Uint32Array:Uint16Array)(3*(2*(r-1)+(f-2*r)));let m=0;for(let t=0;t<r-1;t++){const e=t+1;x[m++]=y-1-u[t],x[m++]=y-1-u[t]-1,x[m++]=d[t]+1+y,x[m++]=y-1-u[t],x[m++]=d[t]+1+y,x[m++]=d[t]+y,d[e]-d[t]==2?(x[m++]=d[t]+2+y,x[m++]=d[t]+1+y,x[m++]=y-u[e]-1):u[e]-u[t]==2&&(x[m++]=d[e]+y,x[m++]=y-1-(u[t]+1),x[m++]=y-1-(u[t]+2))}const v=n.bevelSize>0?Ai(p,[],n.bevelSize,null,!0):p,b=n.boundingRect,_=Vi(p,null,n.smoothSide,n.smoothSideThreshold);return{vertices:_.vertices,rawVertices:v,splittedMap:_.splittedMap,indices:x,topVertices:v,rect:{x:b.x*a[0]+o[0],y:b.y*a[1]+o[1],width:b.width*a[0],height:b.height*a[1]},depth:"function"==typeof n.depth?n.depth(e):n.depth,holes:[]}}function Ii(t,e){const n=[];for(let i=0;i<t.length;i++){const r=t[i],s=[],o=r.length;let a=r[o-1][0],h=r[o-1][1],c=0;for(let t=0;t<o;t++){let n=r[t][0],i=r[t][1];const o=n-a,l=i-h;c+=Math.sqrt(o*o+l*l),c>e&&(s.push(r[t]),c=0),a=n,h=i}s.length>=3&&n.push(s)}return n.length>0?n:null}function Ui(t,e){const n=[];for(let i=0;i<t.length;i++){let r=t[i];r=hi(r,e,!0),r.length>=3&&n.push(r)}return n.length>0?n:null}function Fi(t,e){e=Object.assign({},e);const n=[1/0,1/0],i=[-1/0,-1/0];for(let e=0;e<t.length;e++)Gi(t[e][0],n,i);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:i[0]-n[0],height:i[1]-n[1]},Pi(e);const r=[],s=e.translate||[0,0],o=e.scale||[1,1],a=e.boundingRect,h={x:a.x*o[0]+s[0],y:a.y*o[1]+s[1],width:a.width*o[0],height:a.height*o[1]},c=Math.min(a.width,a.height)/1e5;for(let n=0;n<t.length;n++){let i=Ii(t[n],c);if(!i)continue;const a=e.simplify/Math.max(o[0],o[1]);if(a>0&&(i=Ui(i,a)),!i)continue;const{vertices:l,holes:u,dimensions:d}=ri.flatten(i);for(let t=0;t<l.length;)l[t]=l[t++]*o[0]+s[0],l[t]=l[t++]*o[1]+s[1];if(ji(l,u),2!==d)throw new Error("Only 2D polygon points are supported");const f=e.bevelSize>0?Ai(l,u,e.bevelSize,null,!0):l,p=bi(f,u,d),g=Vi(l,u,e.smoothSide,e.smoothSideThreshold);r.push({indices:p,vertices:g.vertices,rawVertices:l,topVertices:f,holes:g.holes,splittedMap:g.splittedMap,rect:h,depth:"function"==typeof e.depth?e.depth(n):e.depth})}return Bi(r,e)}function Ri(t,e){e=Object.assign({},e);const n=[1/0,1/0],i=[-1/0,-1/0];for(let e=0;e<t.length;e++)Gi(t[e],n,i);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:i[0]-n[0],height:i[1]-n[1]},Pi(e);const r=e.scale||[1,1];null==e.lineWidth&&(e.lineWidth=1),null==e.miterLimit&&(e.miterLimit=2);const s=[];for(let n=0;n<t.length;n++){let i=t[n];const o=e.simplify/Math.max(r[0],r[1]);o>0&&(i=hi(i,o,!0)),s.push(Ei(i,n,e))}return Bi(s,e)}function Gi(t,e,n){for(let i=0;i<t.length;i++)e[0]=Math.min(t[i][0],e[0]),e[1]=Math.min(t[i][1],e[1]),n[0]=Math.max(t[i][0],n[0]),n[1]=Math.max(t[i][1],n[1])}var Zi=Object.freeze({__proto__:null,triangulate:bi,flatten:function(t){return ri.flatten(t)},offsetPolygon:Ai,extrudePolygon:Fi,extrudePolyline:Ri,extrudeGeoJSON:function(t,e){e=Object.assign({},e);const n=[],i=[],r=[],s=[],o=[1/0,1/0],a=[-1/0,-1/0];for(let e=0;e<t.features.length;e++){const h=t.features[e].geometry;if(h&&h.coordinates)switch(h.type){case"LineString":n.push(h.coordinates),r.push(e),Gi(h.coordinates,o,a);break;case"MultiLineString":for(let t=0;t<h.coordinates.length;t++)n.push(h.coordinates[t]),r.push(e),Gi(h.coordinates[t],o,a);break;case"Polygon":i.push(h.coordinates),s.push(e),Gi(h.coordinates[0],o,a);break;case"MultiPolygon":for(let t=0;t<h.coordinates.length;t++)i.push(h.coordinates[t]),s.push(e),Gi(h.coordinates[t][0],o,a)}}e.boundingRect=e.boundingRect||{x:o[0],y:o[1],width:a[0]-o[0],height:a[1]-o[1]};const h=e.depth;return{polyline:Ri(n,Object.assign(e,{depth:function(e){return"function"==typeof h?h(t.features[r[e]]):h}})),polygon:Fi(i,Object.assign(e,{depth:function(e){return"function"==typeof h?h(t.features[s[e]]):h}}))}}});const Qi="__maptalks.three.fetchdata__";var Di;const Hi={bottomHeight:0,width:3,cornerRadius:0,altitude:0,topColor:null,bottomColor:"#2d2f61",heightEnable:!0};class Wi extends _{constructor(t,e,n,i){e=s.Util.extend({},Hi,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{width:r,cornerRadius:o,bottomHeight:a,altitude:h,asynchronous:c}=e,l=i.distanceToVector3(o,o).x,u=i.distanceToVector3(r,r).x,{lineStrings:d,center:f}=ct(t);let p;if(c){p=Wt();const e=s.Util.GUID();this.getOptions().id=e,this.getOptions().center=f,It.push({id:e,data:d,layer:i,center:f,lineString:t,baseObject:this})}else{const t=[],e={};for(let n=0,r=d.length;n<r;n++){const r=ht(d[n],u,l,i,f);F(r,a,i,e),t.push(r)}p=Rt(t)}this._createMesh(p,n);const g=i.altitudeToVector3(h,h).x,y=i.coordinateToVector3(f,g);this.getObject3d().position.copy(y),this.type="Path"}_workerLoad(t){const e=Qt(t);this.getObject3d().geometry=e,this._fire("workerload",{target:this})}}const Ni={width:3,cornerRadius:0,altitude:0,topColor:null,bottomColor:"#2d2f61"};class qi extends(Oe(_)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const r=[],o=[],a=t.length;for(let e=0;e<a;e++){const n=ct(t[e]);r.push(n.center),o.push(n.lineStrings)}const h=U(r);e=s.Util.extend({},Ni,e,{layer:i,lineStrings:t,coordinate:h});const{altitude:c,asynchronous:l}=e;let u;const d=[],f=[];if(super(),l)u=Wt(),Ut.push({id:s.Util.GUID(),layer:i,key:e.key,center:h,data:o,lineStrings:t,baseObject:this,option:e});else{const n=[];let r=0;const c={},l={};for(let u=0;u<a;u++){const a=t[u],d=s.Util.extend({},e,H(a),{index:u}),{cornerRadius:p,width:g,bottomHeight:y}=d,x=E(g,i,c),m=E(p,i,l),v=o[u],b=[];let _=0;for(let t=0,e=v.length;t<e;t++){const e=ht(v[t],x,m,i,h);_=F(e,y,i,c),b.push(e)}const w=Gt(b);n.push(w);const{position:M,normal:O,indices:z}=w;z.length;const A=M.length/3;O.length,f[u]={position:{middleZ:_,count:A,start:r,end:r+3*A},hide:!1},r+=3*A}u=Rt(n)}this._initOptions(e),this._createMesh(u,n);const p=i.altitudeToVector3(c,c).x,g=i.coordinateToVector3(h,p);this.getObject3d().position.copy(g),this._baseObjects=d,this._datas=t,this._geometriesAttributes=f,this.faceIndex=null,this._geometryCache=Dt(u),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(d),l||(this._setPickObject3d(),this._init()),this.type="Paths"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,A(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new Wi(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){return this.picked}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=Qt(t);if(this._geometryCache=Dt(n),this.getObject3d().geometry=n,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const Xi=Math.PI/180,Ki=[[4e3,220],[2e3,100],[1e3,30],[500,15],[100,5],[50,2],[10,1],[5,.7],[2,.1],[1,.05],[.5,.02],[.4,.01],[.1,.005],[.05,.002],[.01,.001]],Ji=["mouseout","mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"],Yi=new s.Coordinate(0,0),$i=new s.Point(0,0),tr=new o.Vector3,er=new Map,nr="__webglFramebuffer",ir=new o.Vector4;class rr extends s.CanvasLayer{constructor(t,e){super(t,e),this._animationBaseObjectMap={},this._needsUpdate=!0,this._mousemoveTimeOut=0,this._mousedownTime=0,this._baseObjects=[],this._delayMeshes=[],this._meshes=[],this.type="ThreeLayer"}isMercator(){const t=this.getMap();if(!t)return!1;const e=t.getSpatialReference(),n=e._projection,i=e._resolutions;return!!(n&&"EPSG:3857"===n.code&&i&&i.length&&156543===Math.floor(i[0])&&t.getGLRes)}isRendering(){const t=this.getMap();return!!t&&(t.isInteracting()||t.isAnimating())}prepareToDraw(...t){}draw(t,e,n,i,r,s){this.renderScene(s,this)}drawOnInteracting(t,e,n,i,r,s,o){this.renderScene(o,this)}_transformHeight(t,e){if(!t)return 0;if(0===(e=e||0))return 0;return this.altitudeToVector3(e,e,null,tr).x}coordinateToVector3(t,e=0,n){const i=this.getMap();if(!i)return null;const r=Array.isArray(t);r?(Yi.x=t[0],Yi.y=t[1]):t instanceof s.Coordinate||(t=new s.Coordinate(t));const a=hr(i),h=cr(i,r?Yi:t,a,$i);return n&&(n.x=h.x,n.y=h.y,n.z=e),new o.Vector3(h.x,h.y,e)}coordinatiesToGLFloatArray(t,e,n){const i=this.getMap();if(!i)return null;const r=hr(i),o=t.length,a=new Float32Array(2*o),h=new Float32Array(3*o);er.clear();for(let c=0;c<o;c++){let o=t[c];const l=Array.isArray(o);l?(Yi.x=o[0],Yi.y=o[1]):o instanceof s.Coordinate||(o=new s.Coordinate(o));const u=cr(i,l?Yi:o,r,$i);u.x-=e.x,u.y-=e.y;const d=2*c;a[d]=u.x,a[d+1]=u.y;const f=o;let p=f.z||f[2]||0;if(n&&!er.has(p)){const t=this._transformHeight(n,p);er.set(p,t)}let g=0;n&&(g=er.get(p)||0);const y=3*c;h[y]=u.x,h[y+1]=u.y,h[y+2]=g}return{positions:h,positons2d:a}}coordinatiesToGLArray(t,e){const n=this.getMap();if(!n)return null;const i=hr(n),r=t.length,o=new Array(r);for(let a=0;a<r;a++){let r=t[a];const h=Array.isArray(r);h?(Yi.x=r[0],Yi.y=r[1]):r instanceof s.Coordinate||(r=new s.Coordinate(r));const c=cr(n,h?Yi:r,i,$i);c.x-=e.x,c.y-=e.y,o[a]=[c.x,c.y]}return o}distanceToVector3(t,e,n){if(0===t&&0===e||!s.Util.isNumber(t)||!s.Util.isNumber(e))return new o.Vector3(0,0,0);const i=this.getMap(),r=hr(i);let a=n||i.getCenter();a instanceof s.Coordinate||(a=new s.Coordinate(a));const h=i.locate(a,t,e),c=cr(i,a,r),l=cr(i,h,r),u=Math.abs(l.x-c.x)*s.Util.sign(t),d=Math.abs(l.y-c.y)*s.Util.sign(e);return new o.Vector3(u,d,0)}altitudeToVector3(t,e,n,i){if(0===t||!s.Util.isNumber(t))return new o.Vector3(0,0,0);const r=this.getMap();if(r.altitudeToPoint){const e=hr(r);let n=r.altitudeToPoint(t,e);return t<0&&n>0&&(n=-n),i?(i.x=n,i.y=n,i.z=0,i):new o.Vector3(n,n,0)}return this.distanceToVector3(t,t,n)}toShape(t){if(!t)return null;if(t instanceof s.MultiPolygon)return t.getGeometries().map((t=>this.toShape(t)));const e=t.getCenter(),n=this.coordinateToVector3(e),i=t.getShell().map((t=>{const e=this.coordinateToVector3(t).sub(n);return new o.Vector2(e.x,e.y)})),r=new o.Shape(i),a=t.getHoles();return a&&a.length>0&&(r.holes=a.map((t=>{const e=t.map((t=>{const e=this.coordinateToVector3(t).sub(n);return new o.Vector2(e.x,e.y)}));return new o.Shape(e)}))),r}toExtrudeMesh(t,e,n,i){if(!t)return null;if(t instanceof s.MultiPolygon)return t.getGeometries().map((t=>this.toExtrudeMesh(t,e,n,i)));const r=t.getCoordinates();r.forEach((t=>{for(let e=t.length-1;e>=1;e--)t[e].equals(t[e-1])&&t.splice(e,1)})),t.setCoordinates(r);const a=this.toShape(t),h=this.coordinateToVector3(t.getCenter());i=s.Util.isNumber(i)?i:e,i=this.altitudeToVector3(i,i).x;const c=this.altitudeToVector3(e,e).x,l={bevelEnabled:!1,bevelSize:1};l[parseInt(o.REVISION)>=93?"depth":"amount"]=i;const u=new o.ExtrudeGeometry(a,l);let d=u;o.BufferGeometry.prototype.fromGeometry&&(d=new o.BufferGeometry,d.fromGeometry(u));const f=new o.Mesh(d,n);return f.position.set(h.x,h.y,c-i),f}toExtrudePolygon(t,e,n){return new ce(t,e,n,this)}toBar(t,e,n){return new ne(t,e,n,this)}toLine(t,e,n){return new se(t,e,n,this)}toExtrudeLine(t,e,n){return new ae(t,e,n,this)}toModel(t,e){return new ue(t,e,this)}toExtrudeLineTrail(t,e,n){return new _e(t,e,n,this)}toExtrudePolygons(t,e,n){return new Se(t,e,n,this)}toPoint(t,e,n){return new Le(t,e,n,this)}toPoints(t,e,n){return new Ue(t,e,n,this)}toBars(t,e,n){return new Re(t,e,n,this)}toExtrudeLines(t,e,n){return new Ze(t,e,n,this)}toLines(t,e,n){return new De(t,e,n,this)}toThreeVectorTileLayer(t,e,n){return new en(t,e,n,this)}toTerrain(t,e,n){return new ln(t,e,n,this)}toTerrainVectorTileLayer(t,e,n){return new dn(t,e,n,this)}toHeatMap(t,e,n){return new bn(t,e,n,this)}toFatLine(t,e,n){return new zn(t,e,n,this)}toFatLines(t,e,n){return new Sn(t,e,n,this)}toBox(t,e,n){return new Pn(t,e,n,this)}toBoxs(t,e,n){return new Tn(t,e,n,this)}toPath(t,e,n){return new Wi(t,e,n,this)}toPaths(t,e,n){return new qi(t,e,n,this)}getBaseObjects(){return this.getMeshes().filter((t=>t instanceof _))}getMeshes(){const t=this.getScene();if(!t)return[];const e=[];for(let n=0,i=t.children.length;n<i;n++){const i=t.children[n];i instanceof o.Object3D&&!(i instanceof o.Camera)&&e.push(i.__parent||i)}return e}clear(){return this.clearMesh()}clearBaseObjects(){return this.removeMesh(this.getBaseObjects())}clearMesh(){const t=this.getScene();if(!t)return this;for(let e=t.children.length-1;e>=0;e--){const n=t.children[e];if(n instanceof o.Object3D&&!(n instanceof o.Camera)){t.remove(n);const e=n.__parent;e&&e instanceof _&&(e.isAdd=!1,e.options.layer=null,e._fire("remove",{target:e}),delete this._animationBaseObjectMap[n.uuid],e._hideUI())}}return this._meshes=[],this}lookAt(t){const e=this._getRenderer();return e&&e.context.lookAt(t),this}getCamera(){const t=this._getRenderer();return t?t.camera:null}getScene(){const t=this._getRenderer();return t?t.scene:null}renderScene(t,e){const n=this._getRenderer();return n&&(n.clearCanvas(),n.renderScene(t),e||n.setToRedraw()),this}loop(t=!1){const e=this._delayMeshes;if(!e.length)return;const n=this.getMap();if(!n||n.isAnimating()||n.isInteracting())return;const i=this.options.loopRenderCount||50,r=e.slice(0,i);r&&this.addMesh(r,t),e.splice(0,i)}renderPickScene(){const t=this._getRenderer();if(t){const e=t.pick;e&&e.pick(this._containerPoint)}return this}getThreeRenderer(){const t=this._getRenderer();return t?t.context:null}getPick(){const t=this._getRenderer();return t?t.pick:null}delayAddMesh(t){if(!t)return this;Array.isArray(t)||(t=[t]);for(let e=0,n=t.length;e<n;e++)this._delayMeshes.push(t[e]);return this}addMesh(t,e=!0){if(!t)return this;Array.isArray(t)||(t=[t]);const n=this.getScene();if(t.forEach((t=>{t instanceof _?(n.add(t.getObject3d()),t.isAdd||(t.isAdd=!0,t.options.layer=this,t._fire("add",{target:t})),t._animation&&s.Util.isFunction(t._animation)&&(this._animationBaseObjectMap[t.getObject3d().uuid]=t)):t instanceof o.Object3D&&n.add(t);-1===this._meshes.indexOf(t)&&this._meshes.push(t)})),this._zoomend(),e){const t=this._getRenderer();t&&t.setToRedraw()}return this}removeMesh(t,e=!0){if(!t)return this;Array.isArray(t)||(t=[t]);const n=this.getScene();if(t.forEach((t=>{if(t instanceof _){n.remove(t.getObject3d()),t.isAdd&&(t.isAdd=!1,t.options.layer=null,t._fire("remove",{target:t}),t._hideUI()),t._animation&&s.Util.isFunction(t._animation)&&delete this._animationBaseObjectMap[t.getObject3d().uuid];const e=this._delayMeshes;if(e.length)for(let n=0,i=e.length;n<i;n++)if(e[n]===t){e.splice(n,1);break}}else t instanceof o.Object3D&&n.remove(t);for(let e=0,n=this._meshes.length;e<n;e++){const n=this._meshes[e];n&&(n===t&&this._meshes.splice(e,1))}})),e){const t=this._getRenderer();t&&t.setToRedraw()}return this}_initRaycaster(){return this._raycaster||(this._raycaster=new o.Raycaster,this._mouse=new o.Vector2),this}getRaycaster(){return this._raycaster}identify(t,e){if(!t)return console.error("coordinate is null,it should be Coordinate"),[];if(Array.isArray(t)&&(t=new s.Coordinate(t)),!(t instanceof s.Coordinate))return console.error("coordinate type is error,it should be Coordinate"),[];const n=this.getMap().coordToContainerPoint(t);this._containerPoint=n;const{x:i,y:r}=n;this._initRaycaster(),this.fire("identify",{coordinate:t,options:e});const h=this._raycaster,c=this._mouse,l=this.getCamera(),u=this.getScene(),d=this.getMap().getSize();if(!u)return[];const f=d.width,p=d.height;c.x=i/f*2-1,c.y=-r/p*2+1,h.setFromCamera(c,l),h.layers&&h.layers.enableAll&&h.layers.enableAll(),function(t,e){a>113?t.params.Line.threshold=e:t.linePrecision=e}(h,this._getLinePrecision(this.getMap().getResolution()));const g=[],y=[];u.children.forEach((t=>{const e=t.__parent;if(e&&e.getOptions){const n=e;n.getOptions().interactive&&n.isVisible()&&(n.identify&&s.Util.isFunction(n.identify)?y.push(n):g.push(t))}else(t instanceof o.Mesh||t instanceof o.Group)&&g.push(t)}));let x=[];const m=h.intersectObjects(g,!0);m&&Array.isArray(m)&&m.length&&(x=m.map((t=>{let e=t.object;const n=t.instanceId;e=this._recursionMesh(e)||{};const i=e.__parent||e;return i.faceIndex=t.faceIndex,i.index=t.index,i.intersect=t,s.Util.isNumber(n)&&(i.instanceId=n),i}))),this.renderPickScene(),y.length&&y.forEach((e=>{e.identify(t)&&x.push(e)}));const v=x.length;for(let t=0;t<v;t++)if(x[t])for(let e=t+1;e<v;e++)x[t]===x[e]&&x.splice(e,1);let b=x.filter((t=>t instanceof _));b=b.sort(((t,e)=>t.options.pickWeight-e.options.pickWeight)),x.forEach((t=>{t instanceof _||b.push(t)}));const w=(e=s.Util.extend({},e)).count;return s.Util.isNumber(w)&&w>0?b.slice(0,w):x}identifyAtPoint(t,e={}){const n=this.getMap();if(!n)return[];const i=n.containerPointToCoordinate(t);return this.identify(i,e)}_recursionMesh(t){for(;t&&t.parent!==this.getScene();)t=t.parent;return t}_getLinePrecision(t=10){for(let e=0,n=Ki.length;e<n;e++){const[n,i]=Ki[e];if(t>n)return i}return.01}fireGeoEvent(t,e,n){if(!(t instanceof _))return this;n=n||e.type;const i=this._getEventParams(e),{coordinate:r}=i,s=this.getMap();function o(t,e){e=e||n;const i=t.getInfoWindow();i&&!i._owner&&i.addTo(t);((i?i.options:{}).autoOpenOn||"click")===e&&(s.options.supportPluginEvent||t.openInfoWindow(r),t.fire("showinfowindow",{infoWindow:i}))}if("mousemove"===n){t.fire(n,Object.assign({},i,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null}));const e=t.getToolTip();e&&!e._owner&&e.addTo(t),t.openToolTip(r),o(t)}else"mouseover"===n?t._mouseover||(t.fire("mouseover",Object.assign({},i,{target:t,type:"mouseover",selectMesh:t.getSelectMesh?t.getSelectMesh():null})),t._mouseover=!0,o(t,"mouseover")):"mouseout"===n?t.getSelectMesh?t.isHide||(t._mouseover=!1,t.fire("mouseout",Object.assign({},i,{target:t,type:"mouseout",selectMesh:null})),t.closeToolTip()):(t._mouseover=!1,t.fire("mouseout",Object.assign({},i,{target:t,type:"mouseout"})),t.closeToolTip()):(t.fire(n,Object.assign({},i,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),o(t))}_emptyIdentify(t={}){const e=t.domEvent,n=this.getScene();if(!n)return this;const i=this.map||this.getMap();if(!i)return this;const r=i._getEventParams?i._getEventParams(e):this._getEventParams(e);for(let t=0,e=n.children.length;t<e;t++){const e=(n.children[t]||{}).__parent;e&&e.fire("empty",Object.assign({},r,{target:e}))}}_identifyBaseObjectEvents(t){if(!this.options.geometryEvents)return this;const e=this.map||this.getMap();if(e.isInteracting()||!e.options.geometryEvents||e._ignoreEvent(t))return this;const n=t.type,i=e._getEventParams?e._getEventParams(t):this._getEventParams(t);i.type=n;const{type:r,coordinate:o}=i,a=s.Util.now();if(this._mousemoveTimeOut&&"mousemove"===r&&a-this._mousemoveTimeOut<64)return this;this._mousemoveTimeOut=a,"mousedown"!==r&&"touchstart"!==r||(this._mousedownTime=s.Util.now());let h=!1;if("click"===r||"touchend"===r){const t=e.options.clickTimeThreshold||280;h=s.Util.now()-this._mousedownTime<t}if("click"===r&&!h)return this;const c=this.options.identifyCountOnEvent;let l=Math.max(0,s.Util.isNumber(c)?c:0);0===l&&(l=1/0);const u=t=>{const e=[];this._baseObjects&&this._baseObjects.forEach((n=>{let i=!0;t.forEach((t=>{n===t&&(i=!1)})),i&&e.push(n)})),e.forEach((t=>{t&&t instanceof _&&(t.getSelectMesh?t.isHide||(t._mouseover=!1,t.fire("mouseout",Object.assign({},i,{target:t,type:"mouseout",selectMesh:null})),t.closeToolTip()):(t._mouseover=!1,t.fire("mouseout",Object.assign({},i,{target:t,type:"mouseout"})),t.closeToolTip()))}))};if("mouseout"===r)return u([]),this._baseObjects=[],this;const d=this.identify(o,{count:l}),f=this.getScene();if(0===d.length&&f)for(let t=0,e=f.children.length;t<e;t++){const e=(f.children[t]||{}).__parent;e&&e.fire("empty",Object.assign({},i,{target:e}))}function p(t,e){e=e||r;const n=t.getInfoWindow();n&&!n._owner&&n.addTo(t);((n?n.options:{}).autoOpenOn||"click")===e&&(t.openInfoWindow(o),t.fire("showinfowindow",{infoWindow:n}))}if("mousemove"===r?(u(d),d.forEach((t=>{if(t instanceof _){t._mouseover||(t.fire("mouseover",Object.assign({},i,{target:t,type:"mouseover",selectMesh:t.getSelectMesh?t.getSelectMesh():null})),t._mouseover=!0,p(t,"mouseover")),t.fire(r,Object.assign({},i,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null}));const e=t.getToolTip();e&&!e._owner&&e.addTo(t),t.openToolTip(o),p(t)}})),this._baseObjects=d):d.forEach((t=>{t instanceof _&&(t.fire(r,Object.assign({},i,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),p(t))})),"touchend"===r&&h){const e=s.Util.extend({},i,{domEvent:t});d.forEach((t=>{t instanceof _&&(t.fire("click",Object.assign({},e,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),p(t,"click"))}))}return this}_getEventParams(t){const e=this.getMap(),n={domEvent:t};if(!e)return n;const i=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(i){const t=(0,s.DomUtil.getEventContainerPoint)(i,e._containerDOM);n.coordinate=e.containerPointToCoordinate(t),n.containerPoint=t,n.viewPoint=e.containerPointToViewPoint(t),n.pont2d=e._containerPointToPoint(t)}return n}_zoomend(){const t=this.getScene();if(!t)return;const e=this.getMap().getZoom();t.children.forEach((t=>{const n=t.__parent;if(n&&n.getOptions){const t=n;t.zoomChange&&s.Util.isFunction(t.zoomChange)&&t.zoomChange(e);const i=t.getMinZoom(),r=t.getMaxZoom();e<i||e>r?(t.isVisible()&&(t.getObject3d().visible=!1),t._zoomVisible=!1):i<=e&&e<=r&&(t._visible&&(t.getObject3d().visible=!0),t._zoomVisible=!0)}}))}_getGeometryEventMapPanel(){const t=this.map||this.getMap();return t._panels.allLayers||t._containerDOM}onAdd(){super.onAdd();const t=this.map||this.getMap();if(!t)return this;const e=this._getGeometryEventMapPanel();return this._identifyBaseObjectEventsThis||(this._identifyBaseObjectEventsThis=this._identifyBaseObjectEvents.bind(this)),this._zoomendThis||(this._zoomendThis=this._zoomend.bind(this)),this._emptyIdentifyThis||(this._emptyIdentifyThis=this._emptyIdentify.bind(this)),t.options.supportPluginEvent?this.on("identifyempty",this._emptyIdentifyThis):s.DomUtil.on(e,Ji.join(" "),this._identifyBaseObjectEventsThis,this),this._needsUpdate=!0,this._animationBaseObjectMap||(this._animationBaseObjectMap={}),t.on("zooming zoomend",this._zoomendThis,this),this}onRemove(){super.onRemove();const t=this.map||this.getMap();if(!t)return this;const e=this._getGeometryEventMapPanel();return t.options.supportPluginEvent?this.off("identifyempty",this._emptyIdentifyThis):s.DomUtil.off(e,Ji.join(" "),this._identifyBaseObjectEventsThis,this),t.off("zooming zoomend",this._zoomendThis,this),this}_addBaseObjectsWhenInit(){return this.addMesh(this._meshes),this}_callbackBaseObjectAnimation(){const t=this;if(t._animationBaseObjectMap)for(const e in t._animationBaseObjectMap){t._animationBaseObjectMap[e]._animation()}return this}_getFovRatio(){const t=this.getMap().getFov();return Math.tan(t/2*Xi)}}rr.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,geometryEvents:!0,identifyCountOnEvent:0,forceRenderOnZooming:!0,loopRenderCount:50});const sr={bloom:!0};class or extends s.renderer.CanvasLayerRenderer{constructor(){super(...arguments),this._renderTime=0,this._renderTarget=null}getPrepareParams(){return[this.scene,this.camera]}getDrawParams(){return[this.scene,this.camera]}_drawLayer(){super._drawLayer.apply(this,arguments)}hitDetect(){return!1}createCanvas(){super.createCanvas(),this.createContext()}createContext(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap();else{const t=this.layer.options.glOptions||{alpha:!0,depth:!0,antialias:!0,stencil:!0,preserveDrawingBuffer:!1};t.preserveDrawingBuffer=!0,this.gl=this.gl||this._createGLContext(this.canvas,t)}this._initThreeRenderer(),this.layer.onCanvasCreate(this.context,this.scene,this.camera)}_initThreeRenderer(){this.matrix4=new o.Matrix4;const t=new o.WebGLRenderer({context:this.gl,alpha:!0});t.autoClear=!1,t.setClearColor(new o.Color(1,1,1),0),t.setSize(this.canvas.width,this.canvas.height),t.clear(),this.context=t;const e=this.scene=new o.Scene,n=this.layer.getMap(),i=n.getFov()*Math.PI/180,r=this.camera=new o.PerspectiveCamera(i,n.width/n.height,n.cameraNear,n.cameraFar);r.matrixAutoUpdate=!1,this._syncCamera(),e.add(r),this.pick=new Mn(this.layer),Ft.star(),this.layer._addBaseObjectsWhenInit()}onCanvasCreate(){super.onCanvasCreate()}resizeCanvas(t){if(!this.canvas)return;let e,n=this.getMap();e=t||n.getSize();const i=n.getDevicePixelRatio?n.getDevicePixelRatio():s.Browser.retina?2:1,r=this.canvas,{width:o,height:a,cssWidth:h,cssHeight:c}=s.Util.calCanvasSize(e,i);if(!this.layer._canvas||r.style.width===h&&r.style.height===c||(r.style.width=h,r.style.height=c),r.width===o&&r.height===a)return this;r.width=o,r.height=a,this.context.setSize(r.width,r.height)}clearCanvas(){this.canvas&&this.context.clear()}prepareCanvas(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null}renderScene(t){if(this.layer._callbackBaseObjectAnimation(),this._syncCamera(),t&&t.renderTarget){const{width:e,height:n}=t.renderTarget.fbo;this._renderTarget?(this._renderTarget.viewport.set(0,0,e,n),this._renderTarget.scissor.set(0,0,e,n)):(this._renderTarget=new o.WebGLRenderTarget(e,n,{depthBuffer:!1}),this.context.setRenderTarget(this._renderTarget),this.context.render(this.scene,this.camera));const i=this.context.properties.get(this._renderTarget),r=i[nr];i[nr]=t.renderTarget.getFramebuffer(t.renderTarget.fbo),this.context.setRenderTarget(this._renderTarget);const s=1===t.bloom&&t.sceneFilter,a=this.scene.children||[];let h=!1;if(s){const e=t.sceneFilter;h=e(sr);for(let t=0,n=a.length;t<n;t++){if(!a[t]||!a[t].layers)continue;const n=a[t].__parent;a[t].bloom=!1,n&&(a[t].bloom=n.bloom);let i=0;(a[t]&&e(a[t])||!n)&&h&&(i=1),a[t].__layer!==i&&(ar(a[t],i),a[t].__layer=i)}}else for(let t=0,e=a.length;t<e;t++)a[t]&&a[t].layers&&0!==a[t].__layer&&(ar(a[t],0),a[t].__layer=0);this.camera.layers.set(h?1:0),this.context.render(this.scene,this.camera),i[nr]=r}else{const{width:t,height:e}=this.canvas,n=this.context.getViewport(ir);n.width===t&&n.height===e||this.context.setViewport(0,0,t,e),this.context.render(this.scene,this.camera)}this.context.setRenderTarget(null),this.completeRender()}remove(){delete this._drawContext,this._renderTarget&&(this._renderTarget.dispose(),delete this._renderTarget),super.remove()}_syncCamera(){const t=this.getMap(),e=this.camera;e.matrix.elements=t.cameraWorldMatrix,e.projectionMatrix.elements=t.projMatrix,this.matrix4.invert?e.projectionMatrixInverse.elements=this.matrix4.copy(e.projectionMatrix).invert().elements:e.projectionMatrixInverse&&(e.projectionMatrixInverse.elements=this.matrix4.getInverse(e.projectionMatrix).elements)}_createGLContext(t,e){const n=["webgl2","webgl","experimental-webgl"];let i=null;for(let r=0;r<n.length;++r){try{i=t.getContext(n[r],e)}catch(t){}if(i)break}return i}}function ar(t,e){if(!t)return;t.layers&&t.layers.set(e);const n=t.children;if(n&&n.length)for(let t=0,i=n.length;t<i;t++)ar(n[t],e)}function hr(t){return t.getGLRes?t.getGLRes():t.getGLZoom()}function cr(t,e,n,i){return t.coordToPointAtRes?t.coordToPointAtRes(e,n,i):t.coordinateToPoint(e,n,i)}rr.registerRenderer("gl",or),s.registerWorkerAdapter&&(s.registerWorkerAdapter("__maptalks.three__",'(function(t){"use strict";\n/*!\n   * poly-extrude v0.4.0\n    */var n={exports:{}};function r(t,n,r){r=r||2;var e,a,o,h,u,v,f,x=n&&n.length,d=x?n[0]*r:t.length,y=i(t,0,d,r,!0),g=[];if(!y||y.next===y.prev)return g;if(x&&(y=function(t,n,r,e){var s,a,o,h=[];for(s=0,a=n.length;s<a;s++)(o=i(t,n[s]*e,s<a-1?n[s+1]*e:t.length,e,!1))===o.next&&(o.steiner=!0),h.push(p(o));for(h.sort(l),s=0;s<h.length;s++)r=c(h[s],r);return r}(t,n,y,r)),t.length>80*r){e=o=t[0],a=h=t[1];for(var m=r;m<d;m+=r)(u=t[m])<e&&(e=u),(v=t[m+1])<a&&(a=v),u>o&&(o=u),v>h&&(h=v);f=0!==(f=Math.max(o-e,h-a))?32767/f:0}return s(y,g,r,e,a,f,0),g}function i(t,n,r,i,e){var s,a;if(e===V(t,n,r,i)>0)for(s=n;s<r;s+=i)a=A(s,t[s],t[s+1],a);else for(s=r-i;s>=n;s-=i)a=A(s,t[s],t[s+1],a);return a&&g(a,a.next)&&(P(a),a=a.next),a}function e(t,n){if(!t)return t;n||(n=t);var r,i=t;do{if(r=!1,i.steiner||!g(i,i.next)&&0!==y(i.prev,i,i.next))i=i.next;else{if(P(i),(i=n=i.prev)===i.next)break;r=!0}}while(r||i!==n);return n}function s(t,n,r,i,l,c,v){if(t){!v&&c&&function(t,n,r,i){var e=t;do{0===e.z&&(e.z=f(e.x,e.y,n,r,i)),e.prevZ=e.prev,e.nextZ=e.next,e=e.next}while(e!==t);e.prevZ.nextZ=null,e.prevZ=null,function(t){var n,r,i,e,s,a,o,h,u=1;do{for(r=t,t=null,s=null,a=0;r;){for(a++,i=r,o=0,n=0;n<u&&(o++,i=i.nextZ);n++);for(h=u;o>0||h>0&&i;)0!==o&&(0===h||!i||r.z<=i.z)?(e=r,r=r.nextZ,o--):(e=i,i=i.nextZ,h--),s?s.nextZ=e:t=e,e.prevZ=s,s=e;r=i}s.nextZ=null,u*=2}while(a>1)}(e)}(t,i,l,c);for(var p,x,d=t;t.prev!==t.next;)if(p=t.prev,x=t.next,c?o(t,i,l,c):a(t))n.push(p.i/r|0),n.push(t.i/r|0),n.push(x.i/r|0),P(t),t=x.next,d=x.next;else if((t=x)===d){v?1===v?s(t=h(e(t),n,r),n,r,i,l,c,2):2===v&&u(t,n,r,i,l,c):s(e(t),n,r,i,l,c,1);break}}}function a(t){var n=t.prev,r=t,i=t.next;if(y(n,r,i)>=0)return!1;for(var e=n.x,s=r.x,a=i.x,o=n.y,h=r.y,u=i.y,l=e<s?e<a?e:a:s<a?s:a,c=o<h?o<u?o:u:h<u?h:u,v=e>s?e>a?e:a:s>a?s:a,f=o>h?o>u?o:u:h>u?h:u,p=i.next;p!==n;){if(p.x>=l&&p.x<=v&&p.y>=c&&p.y<=f&&x(e,o,s,h,a,u,p.x,p.y)&&y(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function o(t,n,r,i){var e=t.prev,s=t,a=t.next;if(y(e,s,a)>=0)return!1;for(var o=e.x,h=s.x,u=a.x,l=e.y,c=s.y,v=a.y,p=o<h?o<u?o:u:h<u?h:u,d=l<c?l<v?l:v:c<v?c:v,g=o>h?o>u?o:u:h>u?h:u,m=l>c?l>v?l:v:c>v?c:v,z=f(p,d,n,r,i),M=f(g,m,n,r,i),w=t.prevZ,b=t.nextZ;w&&w.z>=z&&b&&b.z<=M;){if(w.x>=p&&w.x<=g&&w.y>=d&&w.y<=m&&w!==e&&w!==a&&x(o,l,h,c,u,v,w.x,w.y)&&y(w.prev,w,w.next)>=0)return!1;if(w=w.prevZ,b.x>=p&&b.x<=g&&b.y>=d&&b.y<=m&&b!==e&&b!==a&&x(o,l,h,c,u,v,b.x,b.y)&&y(b.prev,b,b.next)>=0)return!1;b=b.nextZ}for(;w&&w.z>=z;){if(w.x>=p&&w.x<=g&&w.y>=d&&w.y<=m&&w!==e&&w!==a&&x(o,l,h,c,u,v,w.x,w.y)&&y(w.prev,w,w.next)>=0)return!1;w=w.prevZ}for(;b&&b.z<=M;){if(b.x>=p&&b.x<=g&&b.y>=d&&b.y<=m&&b!==e&&b!==a&&x(o,l,h,c,u,v,b.x,b.y)&&y(b.prev,b,b.next)>=0)return!1;b=b.nextZ}return!0}function h(t,n,r){var i=t;do{var s=i.prev,a=i.next.next;!g(s,a)&&m(s,i,i.next,a)&&w(s,a)&&w(a,s)&&(n.push(s.i/r|0),n.push(i.i/r|0),n.push(a.i/r|0),P(i),P(i.next),i=t=a),i=i.next}while(i!==t);return e(i)}function u(t,n,r,i,a,o){var h=t;do{for(var u=h.next.next;u!==h.prev;){if(h.i!==u.i&&d(h,u)){var l=b(h,u);return h=e(h,h.next),l=e(l,l.next),s(h,n,r,i,a,o,0),void s(l,n,r,i,a,o,0)}u=u.next}h=h.next}while(h!==t)}function l(t,n){return t.x-n.x}function c(t,n){var r=function(t,n){var r,i=n,e=t.x,s=t.y,a=-1/0;do{if(s<=i.y&&s>=i.next.y&&i.next.y!==i.y){var o=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(o<=e&&o>a&&(a=o,r=i.x<i.next.x?i:i.next,o===e))return r}i=i.next}while(i!==n);if(!r)return null;var h,u=r,l=r.x,c=r.y,f=1/0;i=r;do{e>=i.x&&i.x>=l&&e!==i.x&&x(s<c?e:a,s,l,c,s<c?a:e,s,i.x,i.y)&&(h=Math.abs(s-i.y)/(e-i.x),w(i,t)&&(h<f||h===f&&(i.x>r.x||i.x===r.x&&v(r,i)))&&(r=i,f=h)),i=i.next}while(i!==u);return r}(t,n);if(!r)return n;var i=b(r,t);return e(i,i.next),e(r,r.next)}function v(t,n){return y(t.prev,t,n.prev)<0&&y(n.next,t,t.next)<0}function f(t,n,r,i,e){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-r)*e|0)|t<<8))|t<<4))|t<<2))|t<<1))|(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-i)*e|0)|n<<8))|n<<4))|n<<2))|n<<1))<<1}function p(t){var n=t,r=t;do{(n.x<r.x||n.x===r.x&&n.y<r.y)&&(r=n),n=n.next}while(n!==t);return r}function x(t,n,r,i,e,s,a,o){return(e-a)*(n-o)>=(t-a)*(s-o)&&(t-a)*(i-o)>=(r-a)*(n-o)&&(r-a)*(s-o)>=(e-a)*(i-o)}function d(t,n){return t.next.i!==n.i&&t.prev.i!==n.i&&!function(t,n){var r=t;do{if(r.i!==t.i&&r.next.i!==t.i&&r.i!==n.i&&r.next.i!==n.i&&m(r,r.next,t,n))return!0;r=r.next}while(r!==t);return!1}(t,n)&&(w(t,n)&&w(n,t)&&function(t,n){var r=t,i=!1,e=(t.x+n.x)/2,s=(t.y+n.y)/2;do{r.y>s!=r.next.y>s&&r.next.y!==r.y&&e<(r.next.x-r.x)*(s-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==t);return i}(t,n)&&(y(t.prev,t,n.prev)||y(t,n.prev,n))||g(t,n)&&y(t.prev,t,t.next)>0&&y(n.prev,n,n.next)>0)}function y(t,n,r){return(n.y-t.y)*(r.x-n.x)-(n.x-t.x)*(r.y-n.y)}function g(t,n){return t.x===n.x&&t.y===n.y}function m(t,n,r,i){var e=M(y(t,n,r)),s=M(y(t,n,i)),a=M(y(r,i,t)),o=M(y(r,i,n));return e!==s&&a!==o||(!(0!==e||!z(t,r,n))||(!(0!==s||!z(t,i,n))||(!(0!==a||!z(r,t,i))||!(0!==o||!z(r,n,i)))))}function z(t,n,r){return n.x<=Math.max(t.x,r.x)&&n.x>=Math.min(t.x,r.x)&&n.y<=Math.max(t.y,r.y)&&n.y>=Math.min(t.y,r.y)}function M(t){return t>0?1:t<0?-1:0}function w(t,n){return y(t.prev,t,t.next)<0?y(t,n,t.next)>=0&&y(t,t.prev,n)>=0:y(t,n,t.prev)<0||y(t,t.next,n)<0}function b(t,n){var r=new S(t.i,t.x,t.y),i=new S(n.i,n.x,n.y),e=t.next,s=n.prev;return t.next=n,n.prev=t,r.next=e,e.prev=r,i.next=r,r.prev=i,s.next=i,i.prev=s,i}function A(t,n,r,i){var e=new S(t,n,r);return i?(e.next=i.next,e.prev=i,i.next.prev=e,i.next=e):(e.prev=e,e.next=e),e}function P(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function S(t,n,r){this.i=t,this.x=n,this.y=r,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function V(t,n,r,i){for(var e=0,s=n,a=r-i;s<r;s+=i)e+=(t[a]-t[s])*(t[s+1]+t[a+1]),a=s;return e}n.exports=r,n.exports.default=r,r.deviation=function(t,n,r,i){var e=n&&n.length,s=e?n[0]*r:t.length,a=Math.abs(V(t,0,s,r));if(e)for(var o=0,h=n.length;o<h;o++){var u=n[o]*r,l=o<h-1?n[o+1]*r:t.length;a-=Math.abs(V(t,u,l,r))}var c=0;for(o=0;o<i.length;o+=3){var v=i[o]*r,f=i[o+1]*r,p=i[o+2]*r;c+=Math.abs((t[v]-t[p])*(t[f+1]-t[v+1])-(t[v]-t[f])*(t[p+1]-t[v+1]))}return 0===a&&0===c?0:Math.abs((c-a)/a)},r.flatten=function(t){for(var n=t[0][0].length,r={vertices:[],holes:[],dimensions:n},i=0,e=0;e<t.length;e++){for(var s=0;s<t[e].length;s++)for(var a=0;a<n;a++)r.vertices.push(t[e][s][a]);e>0&&(i+=t[e-1].length,r.holes.push(i))}return r};var Z=n.exports;function F(t){for(var n,r,i=0,e=1,s=t.length;e<s;)n=r||t[0],i+=((r=t[e])[0]-n[0])*(r[1]+n[1]),e++;return i>0}function L(t,n,r){return t[0]=n[0]-r[0],t[1]=n[1]-r[1],t[2]=n[2]-r[2],t}function _(t,n){var r=n[0],i=n[1],e=n[2],s=Math.sqrt(r*r+i*i+e*e)||1;return t[0]=r/s,t[1]=i/s,t[2]=e/s,t}function I(t,n){function r(t,n,r,i){t[0]=n,t[1]=r,t[2]=i}for(var i,e,s,a,o,h,u,l,c,v=[],f=[],p=[],x=[],d=[],y=[],g=t.length,m=new Float32Array(n.length),z=0;z<g;){var M=3*t[z],w=3*t[z+1],b=3*t[z+2];r(v,n[M],n[M+1],n[M+2]),r(f,n[w],n[w+1],n[w+2]),r(p,n[b],n[b+1],n[b+2]),L(d,p,f),L(x,v,f),i=y,s=x,a=void 0,o=void 0,h=void 0,u=void 0,l=void 0,c=void 0,a=(e=d)[0],o=e[1],h=e[2],u=s[0],l=s[1],c=s[2],i[0]=o*c-h*l,i[1]=h*u-a*c,i[2]=a*l-o*u;for(var A=0;A<3;A++)m[M+A]+=y[A],m[w+A]+=y[A],m[b+A]+=y[A];z+=3}for(var P=0,S=m.length;P<S;)r(y,m[P],m[P+1],m[P+2]),_(y,y),m[P]=y[0]||0,m[P+1]=y[1]||0,m[P+2]=y[2]||0,P+=3;return m}function E(t){if(1===t.length)return{position:t[0].position,normal:t[0].normal,uv:t[0].uv,indices:t[0].indices,results:t};for(var n=0,r=0,i=0,e=t.length;i<e;i++){var s=t[i],a=s.position,o=s.indices;n+=a.length,r+=o.length}for(var h={position:new Float32Array(n),normal:new Float32Array(n),uv:new Float32Array(n/3*2),indices:new Uint32Array(r),results:t},u=0,l=0,c=0,v=0,f=0,p=t.length;f<p;f++){var x=t[f],d=x.position,y=x.indices,g=x.normal,m=x.uv;h.position.set(d,u),h.normal.set(g,u),h.uv.set(m,v);for(var z=0,M=y.length;z<M;){var w=y[z]+l;h.indices[c]=w,c++,z++}v+=m.length,u+=d.length,l+=d.length/3}return h}function O(t){return 180*t/Math.PI}function U(t){return t/180*Math.PI}function q(t,n,r,i,e,s){var a=3*r,o=3*i,h=3*e,u=3*s,l=n[a],c=n[a+1],v=n[a+2],f=n[o],p=n[o+1],x=n[o+2],d=n[h],y=n[h+1],g=n[h+2],m=n[u],z=n[u+1],M=n[u+2];Math.abs(c-p)<Math.abs(l-f)?(t.push(l,1-v),t.push(f,1-x),t.push(d,1-g),t.push(m,1-M)):(t.push(c,1-v),t.push(p,1-x),t.push(y,1-g),t.push(z,1-M))}function R(t,n){n=Object.assign({},{depth:2},n);var r=t.map((function(t){for(var r=0,i=t.length;r<i;r++){var e=t[r];j(e),0===r?F(e)||(t[r]=e.reverse()):F(e)&&(t[r]=e.reverse()),B(e)&&e.splice(e.length-1,1)}var s=function(t,n){for(var r=function(t){var n=0,r=0,i=t.length;for(;r<i;)n+=t[r].length,r++;return n}(t),i=t.length,e=[],s=new Float32Array(2*r),a=[],o=[],h=3*r,u=2*r,l=n.depth,c=0,v=0,f=0,p=0;p<i;p++){var x=t[p];p>0&&e.push(c/2);for(var d=0,y=x.length;d<y;){var g=x[d],m=g[0],z=g[1];s[c++]=m,s[c++]=z,a[v]=m,a[v+1]=z,a[v+2]=l,a[h+v]=m,a[h+v+1]=z,a[h+v+2]=0,o[f]=m,o[f+1]=z,o[u+f]=m,o[u+f+1]=z,v+=3,f+=2,d++}}return{flatVertices:s,holes:e,points:a,count:r,uvs:o}}(t,n);return s.polygon=t,function(t,n){for(var r=[],i=t.count,e=0,s=n.length;e<s;e+=3){var a=n[e],o=n[e+1],h=n[e+2];r[e]=a,r[e+1]=o,r[e+2]=h;var u=s+e,l=i+a,c=i+o,v=i+h;r[u]=l,r[u+1]=c,r[u+2]=v}t.index=r}(s,Z(s.flatVertices,s.holes,2)),function(t,n){for(var r=t.points,i=t.index,e=t.polygon,s=t.uvs,a=n.depth,o=0,h=e.length;o<h;o++)for(var u=e[o],l=0,c=u.length;l<c;){var v=u[l],f=u[l+1];l===c-1&&(f=u[0]);var p=r.length/3,x=v[0],d=v[1],y=f[0],g=f[1];r.push(x,d,a,y,g,a,x,d,0,y,g,0);var m=p+2,z=p+3,M=p,w=p+1;i.push(m,M,z,M,w,z),q(s,r,m,z,M,w),l++}}(s,n),s.position=new Float32Array(s.points),s.indices=new Uint32Array(s.index),s.uv=new Float32Array(s.uvs),s.normal=I(s.indices,s.position),s})),i=E(r);return i.polygons=t,i}function j(t){B(t)||t.push(t[0])}function B(t){var n=t.length,r=t[0],i=r[0],e=r[1],s=t[n-1],a=s[0],o=s[1];return i===a&&e===o}function C(t,n){n=Object.assign({},{depth:2,lineWidth:1},n);var r=t.map((function(t){var r=function(t,n){var r=n.lineWidth/2,i=[],e=[],s=[],a=t.length,o=0;for(;o<a;){var h=t[o],u=t[o+1],l=t[o];o===a-1&&(h=t[a-2],u=t[a-1]);var c=u[1]-h[1],v=u[0]-h[0],f=0,p=O(Math.atan(c/v));if(0===o||o===a-1)f=p,f-=90;else{var x=t[o-1];k.x=x[0]-h[0],k.y=x[1]-h[1],H.x=u[0]-h[0],H.y=u[1]-h[1],f=p-N(k,H)/2}var d=U(f),y=l,g=[Math.cos(d)+y[0],Math.sin(d)+y[1]],m=W(h,u,r),z=m[0],M=m[1],w=D(z[0],z[1],y,g),b=D(M[0],M[1],y,g);if(!w||!b){var A=i.length,P=i[A-2],S=i[A-1];if(!P||!S)continue;w=[P[0],P[1]],b=[S[0],S[1]]}w[2]=l[2]||0,b[2]=l[2]||0,i.push(w,b),T(w,h,u)?(e.push(w),s.push(b)):(e.push(b),s.push(w)),o++}return{offsetPoints:i,leftPoints:e,rightPoints:s}}(t,n);return r.line=t,function(t,n){var r=n.depth,i=[],e=[],s=[],a=t.leftPoints,o=t.rightPoints,h=0,u=a.length;for(;h<u;){var l=3*h,c=a[h],v=c[0],f=c[1],p=c[2];i[l]=v,i[l+1]=f,i[l+2]=r+p;var x=o[h],d=x[0],y=x[1],g=x[2],m=3*u+l;i[m]=d,i[m+1]=y,i[m+2]=r+g;var z=2*u*3+l;i[z]=v,i[z+1]=f,i[z+2]=p;var M=2*u*3+3*u+l;i[M]=d,i[M+1]=y,i[M+2]=g,h++}h=0,u=i.length;for(;h<u;){var w=i[h],b=i[h+1];s.push(w,b),h+=3}h=0,u=a.length;for(;h<u-1;){var A=h,P=h+1,S=A+u,V=P+u;e.push(A,S,P),e.push(S,V,P);var Z=h+2*u,F=Z+1,L=Z+u,_=F+u;e.push(Z,L,F),e.push(L,_,F),h++}t.index=e,t.points=i,t.uvs=s}(r,n),function(t,n){var r=t.points,i=t.index,e=t.leftPoints,s=t.rightPoints,a=t.uvs,o=n.depth,h=[e,s];function u(t,n){var e=r.length/3;r.push(t[0],t[1],o+t[2],n[0],n[1],o+n[2],t[0],t[1],t[2],n[0],n[1],n[2]);var s=e+2,h=e+3,u=e,l=e+1;i.push(s,u,h,u,l,h),q(a,r,s,h,u,l)}for(var l=0,c=h.length;l<c;l++){var v=h[l];l>0&&(v=(v=v.map((function(t){return t}))).reverse());for(var f=0,p=v.length-1;f<p;){u(v[f],v[f+1]),f++}}for(var x=e.length,d=[s[0],e[0],e[x-1],s[x-1]],y=0;y<d.length;y+=2){u(d[y],d[y+1])}}(r,n),r.position=new Float32Array(r.points),r.indices=new Uint32Array(r.index),r.uv=new Float32Array(r.uvs),r.normal=I(r.indices,r.position),r})),i=E(r);return i.lines=t,i}var k={x:0,y:0},H={x:0,y:0};var N=function(t,n){var r=t.x,i=t.y,e=n.x,s=n.y,a=r*e+i*s,o=r*s-i*e;return(Math.atan2(o,a)/Math.PI*180+360)%360};function T(t,n,r){var i=n[0],e=n[1],s=r[0],a=r[1];return(e-a)*t[0]+(s-i)*t[1]+i*a-s*e>0}function W(t,n,r){var i=n[1]-t[1],e=n[0]-t[0],s=Math.atan2(i,e),a=s+Math.PI/2,o=Math.cos(a)*r,h=Math.sin(a)*r,u=[t[0]+o,t[1]+h],l=[n[0]+o,n[1]+h],c=s-Math.PI/2;return o=Math.cos(c)*r,h=Math.sin(c)*r,[[u,l],[[t[0]+o,t[1]+h],[n[0]+o,n[1]+h]]]}function D(t,n,r,i){var e=n[0]-t[0],s=n[1]-t[1],a=i[0]-r[0],o=i[1]-r[1];if(0===e&&0===a)return null;if(0===s&&0===o)return null;var h,u,l=s/e,c=o/a,v=t[1]-l*t[0],f=r[1]-c*r[0];return 0===e?u=c*(h=t[0])+f:0===a?u=l*(h=r[0])+v:0===s?h=((u=t[1])-f)/c:0===o?h=((u=r[1])-v)/l:u=l*(h=(f-v)/(l-c))+v,[h,u]}function Q(t,n){void 0===n&&(n={}),n=Object.assign({},{radius:1,height:2,radialSegments:6},n);for(var r=Math.round(Math.max(4,n.radialSegments)),i=n,e=i.radius,s=i.height,a=360/r/360*Math.PI*2,o=r+1,h=new Float32Array(3*o*2),u=t[0],l=t[1],c=0,v=0,f=3*o,p=2*o,x=[],d=[],y=-1;y<r;y++){var g=a*y,m=Math.cos(g)*e+u,z=Math.sin(g)*e+l;h[c]=m,h[c+1]=z,h[c+2]=0,h[c+f]=m,h[c+1+f]=z,h[c+2+f]=s;var M,w;M=.5+m/e/2,w=.5+z/e/2,d[v]=M,d[v+1]=w,d[v+p]=M,d[v+1+p]=w,c+=3,v+=2,y>1&&x.push(0,y-1,y)}h[c-=3]=h[0],h[c+1]=h[1],h[c+2]=h[2];var b=h.length;h[b-3]=h[0],h[b-2]=h[1],h[b-1]=s;for(var A=x.length,P=0;P<A;P++){var S=x[P];x.push(S+o)}var V=new Float32Array(2*(3*o*2-6)),Z=-1;c=2*o,v=0;for(var F=0,L=h.length/2;F<L-3;F+=3){var _=h[F],E=h[F+1],O=h[F+3],U=h[F+4];V[++Z]=_,V[++Z]=E,V[++Z]=s,V[++Z]=O,V[++Z]=U,V[++Z]=s,V[++Z]=_,V[++Z]=E,V[++Z]=0,V[++Z]=O,V[++Z]=U,V[++Z]=0;var q=c+2,R=c+3,j=c,B=c+1;x.push(j,q,B,q,R,B),c+=4;var C=v/o,k=(v+1)/o;d.push(C,s/e/2,k,s/e/2,C,0,k,0),v++}var H=new Float32Array(h.length+V.length);H.set(h,0),H.set(V,h.length);var N=I(x,H);return{points:h,indices:new Uint32Array(x),position:H,normal:N,uv:new Float32Array(d)}}var X=function(){function t(t,n,r){void 0===t&&(t=0),void 0===n&&(n=0),void 0===r&&(r=0),this.x=t,this.y=n,this.z=r}var n=t.prototype;return n.set=function(t,n,r){return void 0===r&&(r=this.z),this.x=t,this.y=n,this.z=r,this},n.clone=function(){return new this.constructor(this.x,this.y,this.z)},n.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},n.addScalar=function(t){return this.x+=t,this.y+=t,this.z+=t,this},n.addVectors=function(t,n){return this.x=t.x+n.x,this.y=t.y+n.y,this.z=t.z+n.z,this},n.addScaledVector=function(t,n){return this.x+=t.x*n,this.y+=t.y*n,this.z+=t.z*n,this},n.sub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},n.subScalar=function(t){return this.x-=t,this.y-=t,this.z-=t,this},n.subVectors=function(t,n){return this.x=t.x-n.x,this.y=t.y-n.y,this.z=t.z-n.z,this},n.multiply=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},n.multiplyScalar=function(t){return this.x*=t,this.y*=t,this.z*=t,this},n.multiplyVectors=function(t,n){return this.x=t.x*n.x,this.y=t.y*n.y,this.z=t.z*n.z,this},n.applyMatrix4=function(t){var n=this.x,r=this.y,i=this.z,e=t.elements,s=1/(e[3]*n+e[7]*r+e[11]*i+e[15]);return this.x=(e[0]*n+e[4]*r+e[8]*i+e[12])*s,this.y=(e[1]*n+e[5]*r+e[9]*i+e[13])*s,this.z=(e[2]*n+e[6]*r+e[10]*i+e[14])*s,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},n.divideScalar=function(t){return this.multiplyScalar(1/t)},n.min=function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this},n.max=function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this},n.clamp=function(t,n){return this.x=Math.max(t.x,Math.min(n.x,this.x)),this.y=Math.max(t.y,Math.min(n.y,this.y)),this.z=Math.max(t.z,Math.min(n.z,this.z)),this},n.clampScalar=function(t,n){return this.x=Math.max(t,Math.min(n,this.x)),this.y=Math.max(t,Math.min(n,this.y)),this.z=Math.max(t,Math.min(n,this.z)),this},n.clampLength=function(t,n){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(t,Math.min(n,r)))},n.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},n.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.normalize=function(){return this.divideScalar(this.length()||1)},n.setLength=function(t){return this.normalize().multiplyScalar(t)},n.lerp=function(t,n){return this.x+=(t.x-this.x)*n,this.y+=(t.y-this.y)*n,this.z+=(t.z-this.z)*n,this},n.lerpVectors=function(t,n,r){return this.x=t.x+(n.x-t.x)*r,this.y=t.y+(n.y-t.y)*r,this.z=t.z+(n.z-t.z)*r,this},n.cross=function(t){return this.crossVectors(this,t)},n.crossVectors=function(t,n){var r=t.x,i=t.y,e=t.z,s=n.x,a=n.y,o=n.z;return this.x=i*o-e*a,this.y=e*s-r*o,this.z=r*a-i*s,this},n.distanceTo=function(t){return Math.sqrt(this.distanceToSquared(t))},n.equals=function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},n.fromArray=function(t,n){return void 0===n&&(n=0),this.x=t[n],this.y=t[n+1],this.z=t[n+2],this},n.random=function(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this},t}(),G=function(){function t(){this.pos=new X,this.dir=new X,this.right=new X,this.up=new X,this.dist=0,this.widthScale=1,this.sharp=!1}var n=t.prototype;return n.lerpPathPoints=function(t,n,r){this.pos.lerpVectors(t.pos,n.pos,r),this.dir.lerpVectors(t.dir,n.dir,r),this.up.lerpVectors(t.up,n.up,r),this.right.lerpVectors(t.right,n.right,r),this.dist=(n.dist-t.dist)*r+t.dist,this.widthScale=(n.widthScale-t.widthScale)*r+t.widthScale},n.copy=function(t){this.pos.copy(t.pos),this.dir.copy(t.dir),this.up.copy(t.up),this.right.copy(t.right),this.dist=t.dist,this.widthScale=t.widthScale},t}(),J=function(){function t(t,n,r,i,e,s,a,o,h,u,l,c,v,f,p,x){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,n,r,i,e,s,a,o,h,u,l,c,v,f,p,x)}var n=t.prototype;return n.set=function(t,n,r,i,e,s,a,o,h,u,l,c,v,f,p,x){var d=this.elements;return d[0]=t,d[4]=n,d[8]=r,d[12]=i,d[1]=e,d[5]=s,d[9]=a,d[13]=o,d[2]=h,d[6]=u,d[10]=l,d[14]=c,d[3]=v,d[7]=f,d[11]=p,d[15]=x,this},n.multiply=function(t){return this.multiplyMatrices(this,t)},n.makeRotationAxis=function(t,n){var r=Math.cos(n),i=Math.sin(n),e=1-r,s=t.x,a=t.y,o=t.z,h=e*s,u=e*a;return this.set(h*s+r,h*a-i*o,h*o+i*a,0,h*a+i*o,u*a+r,u*o-i*s,0,h*o-i*a,u*o+i*s,e*o*o+r,0,0,0,0,1),this},n.equals=function(t){for(var n=this.elements,r=t.elements,i=0;i<16;i++)if(n[i]!==r[i])return!1;return!0},t}();function K(t,n){return K=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,n){return t.__proto__=n,t},K(t,n)}function Y(t,n,r,i){return function(t,n){var r=1-t;return r*r*n}(t,n)+function(t,n){return 2*(1-t)*t*n}(t,r)+function(t,n){return t*t*n}(t,i)}var $=function(t){var n,r;function i(n,r,i){var e;return void 0===n&&(n=new X),void 0===r&&(r=new X),void 0===i&&(i=new X),(e=t.call(this)||this).isQuadraticBezierCurve3=!0,e.type="QuadraticBezierCurve3",e.v0=n,e.v1=r,e.v2=i,e}return r=t,(n=i).prototype=Object.create(r.prototype),n.prototype.constructor=n,K(n,r),i.prototype.getPoint=function(t,n){void 0===n&&(n=new X);var r=n,i=this.v0,e=this.v1,s=this.v2;return r.set(Y(t,i.x,e.x,s.x),Y(t,i.y,e.y,s.y),Y(t,i.z,e.z,s.z)),r},i}(function(){function t(){this.type="Curve",this.arcLengthDivisions=200}var n=t.prototype;return n.getPoint=function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},n.getPointAt=function(t,n){var r=this.getUtoTmapping(t);return this.getPoint(r,n)},n.getPoints=function(t){void 0===t&&(t=5);for(var n=[],r=0;r<=t;r++)n.push(this.getPoint(r/t));return n},n.getLength=function(){var t=this.getLengths();return t[t.length-1]},n.getLengths=function(t){if(void 0===t&&(t=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var n,r=[],i=this.getPoint(0),e=0;r.push(0);for(var s=1;s<=t;s++)e+=(n=this.getPoint(s/t)).distanceTo(i),r.push(e),i=n;return this.cacheArcLengths=r,r},n.getUtoTmapping=function(t,n){var r,i=this.getLengths(),e=0,s=i.length;r=n||t*i[s-1];for(var a,o=0,h=s-1;o<=h;)if((a=i[e=Math.floor(o+(h-o)/2)]-r)<0)o=e+1;else{if(!(a>0)){h=e;break}h=e-1}if(i[e=h]===r)return e/(s-1);var u=i[e];return(e+(r-u)/(i[e+1]-u))/(s-1)},t}()),tt=new X,nt=new X,rt=new X,it=new J,et=new $;var st=function(){function t(){this.array=[],this.count=0}var n=t.prototype;return n.set=function(t,n,r,i,e){if(void 0===n&&(n=.1),void 0===r&&(r=10),void 0===i&&(i=null),void 0===e&&(e=!1),(t=t.slice(0)).length<2)return console.warn("PathPointList: points length less than 2."),void(this.count=0);e&&!t[0].equals(t[t.length-1])&&t.push((new X).copy(t[0]));for(var s=0,a=t.length;s<a;s++)if(0===s)this._start(t[s],t[s+1],i);else if(s===a-1)if(e){this._corner(t[s],t[1],n,r,i);var o=this.array[0].dist;this.array[0].copy(this.array[this.count-1]),this.array[0].dist=o}else this._end(t[s]);else this._corner(t[s],t[s+1],n,r,i)},n.distance=function(){return this.count>0?this.array[this.count-1].dist:0},n._getByIndex=function(t){return this.array[t]||(this.array[t]=new G),this.array[t]},n._start=function(t,n,r){this.count=0;var i=this._getByIndex(this.count);if(i.pos.copy(t),i.dir.subVectors(n,t),r)i.up.copy(r);else{var e=Number.MAX_VALUE,s=Math.abs(i.dir.x),a=Math.abs(i.dir.y),o=Math.abs(i.dir.z);s<e&&(e=s,i.up.set(1,0,0)),a<e&&(e=a,i.up.set(0,1,0)),o<e&&i.up.set(0,0,1)}i.right.crossVectors(i.dir,i.up).normalize(),i.up.crossVectors(i.right,i.dir).normalize(),i.dist=0,i.widthScale=1,i.sharp=!1,i.dir.normalize(),this.count++},n._end=function(t){var n=this.array[this.count-1],r=this._getByIndex(this.count);r.pos.copy(t),r.dir.subVectors(t,n.pos);var i=r.dir.length();r.dir.normalize(),r.up.copy(n.up);var e=tt.crossVectors(n.dir,r.dir);if(e.length()>Number.EPSILON){e.normalize();var s=Math.acos(Math.min(Math.max(n.dir.dot(r.dir),-1),1));r.up.applyMatrix4(it.makeRotationAxis(e,s))}r.right.crossVectors(r.dir,r.up).normalize(),r.dist=n.dist+i,r.widthScale=1,r.sharp=!1,this.count++},n._corner=function(t,n,r,i,e){if(r>0&&i>0){for(var s=function(t,n,r,i,e,s){var a=tt.subVectors(n,t),o=nt.subVectors(r,n),h=a.length(),u=o.length();a.normalize(),o.normalize();var l=Math.min(.999999*(e?h/2:h),i);s.v0.copy(n).sub(a.multiplyScalar(l)),s.v1.copy(n);var c=Math.min(u/2*.999999,i);return s.v2.copy(n).add(o.multiplyScalar(c)),s}(this.array[this.count-1].pos,t,n,r,this.count-1==0,et),a=s.getPoints(i),o=0;o<i;o++)this._sharpCorner(a[o],a[o+1],e,0===o?1:0);a[i].equals(n)||this._sharpCorner(a[i],n,e,2)}else this._sharpCorner(t,n,e,0,!0)},n._sharpCorner=function(t,n,r,i,e){void 0===i&&(i=0),void 0===e&&(e=!1);var s=this.array[this.count-1],a=this._getByIndex(this.count),o=tt.subVectors(t,s.pos),h=nt.subVectors(n,t),u=o.length();if(o.normalize(),h.normalize(),a.pos.copy(t),1===i?a.dir.copy(o):2===i?a.dir.copy(h):(a.dir.addVectors(o,h),a.dir.normalize()),r)1===a.dir.dot(r)?a.right.crossVectors(h,r).normalize():a.right.crossVectors(a.dir,r).normalize(),a.up.crossVectors(a.right,a.dir).normalize();else{a.up.copy(s.up);var l=rt.crossVectors(s.dir,a.dir);if(l.length()>Number.EPSILON){l.normalize();var c=Math.acos(Math.min(Math.max(s.dir.dot(a.dir),-1),1));a.up.applyMatrix4(it.makeRotationAxis(l,c))}a.right.crossVectors(a.dir,a.up).normalize()}a.dist=s.dist+u;var v=o.dot(h);a.widthScale=Math.min(1/Math.sqrt((1+v)/2),1.415)||1,a.sharp=Math.abs(v-1)>.05&&e,this.count++},t}(),at=new X(0,0,1);function ot(t,n){n=Object.assign({},{lineWidth:1,cornerRadius:0,cornerSplit:10},n);var r=t.map((function(t){var r=t.map((function(t){var n=t[0],r=t[1],i=t[2];return new X(n,r,i||0)})),i=new st;i.set(r,n.cornerRadius,n.cornerSplit,at);var e=function(t,n){var r=n.lineWidth||.1,i=1,e=r/2,s=r,a=t.distance(),o=i*a;if(0===a)return null;var h,u=e/s,l=0,c=[],v=[],f=[],p=[],x=0,d=new X,y=new X,g=new X,m=new X,z=new X,M=new X;function w(t){var n=0===c.length,r=t.sharp&&!n,i=t.dist/s,a=t.dir,o=t.up,h=t.right;if(d.copy(h).multiplyScalar(e*t.widthScale),y.copy(h).multiplyScalar(-e*t.widthScale),d.add(t.pos),y.add(t.pos),r){g.fromArray(c,c.length-6).sub(y),m.fromArray(c,c.length-3).sub(d);var w,b,A=g.length()-m.length();A>0?(w=g,b=y):(w=m,b=d),z.copy(w).setLength(Math.abs(A)).add(b);var P=M.copy(b).sub(z).normalize().dot(a)*M.copy(b).sub(z).length()*2;M.copy(a).setLength(P).add(z),A>0?(c.push(z.x,z.y,z.z,d.x,d.y,d.z,y.x,y.y,y.z,d.x,d.y,d.z,M.x,M.y,M.z,d.x,d.y,d.z),x+=6,p.push(x-6,x-8,x-7,x-6,x-7,x-5,x-4,x-6,x-5,x-2,x-4,x-1),l+=12):(c.push(y.x,y.y,y.z,z.x,z.y,z.z,y.x,y.y,y.z,d.x,d.y,d.z,y.x,y.y,y.z,M.x,M.y,M.z),x+=6,p.push(x-6,x-8,x-7,x-6,x-7,x-5,x-6,x-5,x-3,x-2,x-3,x-1),l+=12),v.push(o.x,o.y,o.z,o.x,o.y,o.z,o.x,o.y,o.z,o.x,o.y,o.z,o.x,o.y,o.z,o.x,o.y,o.z),f.push(i-u,0,i-u,1,i,0,i,1,i+u,0,i+u,1)}else c.push(y.x,y.y,y.z,d.x,d.y,d.z),v.push(o.x,o.y,o.z,o.x,o.y,o.z),f.push(i,0,i,1),x+=2,n||(p.push(x-2,x-4,x-3,x-2,x-3,x-1),l+=6)}if(o>0)for(var b=0;b<t.count;b++){var A=t.array[b];if(A.dist>o){var P=t.array[b-1];h=new G;var S=(o-P.dist)/(A.dist-P.dist);h.lerpPathPoints(P,A,S),w(h);break}w(A)}else h=t.array[0];return{points:c,normal:v,uvs:f,index:p,count:l}}(i,n);return e.line=t,e.position=new Float32Array(e.points),e.indices=new Uint32Array(e.index),e.uv=new Float32Array(e.uvs),e.normal=new Float32Array(e.normal),e})),i=E(r);return i.lines=t,i}var ht={x:0,y:0},ut={x:0,y:0};function lt(t,n,r,i){for(var e=t.length,s=0;s<e;s++){var a=t[s].data;n=t[s].center||n;for(var o=0,h=a.length;o<h;o++)for(var u=a[o],l=0,c=u.length;l<c;l++)t[s].data[o][l]=ct(u[l],n,r,i)}}function ct(t,n,r,i,e){for(var s,a=[],o=e?3:2,h=0,u=(s=r?new Float64Array(t):new Float32Array(t)).length;h<u;h+=o){var l=s[h],c=s[h+1],v=s[h+2];if(n&&r&&i){ht.x=l,ht.y=c;var f=wt(ht,ut);ht.x=f.x,ht.y=f.y,l=(f=bt(i,ht,r,ut)).x,c=f.y,l-=n[0],c-=n[1]}e?a.push([l,c,v]):a.push([l,c])}return a}function vt(t,n){void 0===n&&(n=1);for(var r=t.length,i=[],e=[],s=0,a=0;a<r;a++){var o=void 0;1===n?o=ft(t[a]):2===n?o=pt(t[a]):3===n&&(o=xt(t[a]));var h=t[a].bottomHeight||0,u=o.position;e.push(o);var l=u.length/3;i[a]={position:{middleZ:h+(t[a].height||0)/2,count:l,start:s,end:s+3*l},hide:!1},s+=3*l}var c=yt(e),v=c.position,f=c.normal,p=c.uv,x=c.indices;return{position:v.buffer,normal:f.buffer,uv:p.buffer,indices:x.buffer,geometriesAttributes:i}}function ft(t){var n=t.data,r=t.height,i=t.bottomHeight,e=R(n,{depth:r}),s=e.position,a=e.normal,o=e.uv,h=e.indices;return gt(s,i),{position:s,normal:a,uv:o,indices:h}}function pt(t){var n=t.data,r=t.height,i=t.width,e=t.bottomHeight,s=C(n,{lineWidth:i,depth:r}),a=s.position,o=s.normal,h=s.uv,u=s.indices;return gt(a,e),{position:a,normal:o,uv:h,indices:u}}function xt(t){var n=t.data,r=t.cornerRadius,i=t.width,e=t.bottomHeight,s=ot(n,{lineWidth:i,cornerRadius:r}),a=s.position,o=s.normal,h=s.uv,u=s.indices;return gt(a,e),{position:a,normal:o,uv:h,indices:u}}function dt(t,n){for(var r=new Float32Array(n),i=0,e=0;e<t.length;++e)r.set(t[e],i),i+=t[e].length;return r}function yt(t){for(var n={},r={},i=0;i<t.length;++i){var e=t[i];for(var s in e)void 0===n[s]&&(n[s]=[],r[s]=0),n[s].push(e[s]),r[s]+=e[s].length}var a={},o=0,h=[];for(var u in n)if("indices"===u)for(var l=n[u],c=0,v=l.length;c<v;c++){for(var f=l[c],p=0,x=f.length;p<x;p++)h.push(f[p]+o);o+=n.position[c].length/3}else{var d=dt(n[u],r[u]);if(!d)return null;a[u]=d}return a.indices=new Uint32Array(h),a}function gt(t,n){if(void 0!==n&&"number"==typeof n&&0!==n)for(var r=0,i=t.length;r<i;r+=3)t[r+2]+=n}function mt(t){for(var n=[],r=0,i=t.length;r<i;r+=7){var e=t[r],s=t[r+1],a=t[r+2],o=t[r+3],h=t[r+4],u=t[r+5];n.push({radialSegments:a,radius:o,height:h,altitude:u,center:[e,s]})}for(var l=n.length,c=[],v=[],f=0,p=0;p<l;p++){var x=Q(n[p].center||[0,0],n[p]),d=x.position;if(n[p].altitude)for(var y=n[p].altitude,g=0,m=d.length;g<m;g+=3)x[g+2]+=y;v.push(x);var z=d.length/3;c[p]={position:{middleZ:n[p].height/2,count:z,start:f,end:f+3*z},hide:!1},f+=3*z}var M=yt(v),w=M.position,b=M.normal,A=M.uv,P=M.indices;return{position:w.buffer,normal:b.buffer,uv:A.buffer,indices:P.buffer,geometriesAttributes:c}}var zt=Math.PI/180,Mt=6378137*Math.PI/180;function wt(t,n){var r,i=85.0511287798,e=t.x,s=Math.max(Math.min(i,t.y),-i);r=0===s?0:Math.log(Math.tan((90+s)*zt/2))/zt;var a=e*Mt,o=r*Mt;return n?(n.x=a,n.y=o,n):{x:a,y:o}}function bt(t,n,r,i){var e=t[0]*(n.x-t[2])/r,s=-t[1]*(n.y-t[3])/r;return i?(i.x=e,i.y=s,i):{x:e,y:s}}function At(t){void 0===t&&(t=[]);for(var n=t.length,r=new Float32Array(3*n),i=0;i<n;i++){var e=t[i],s=3*i;r[s]=e[0],r[s+1]=e[1],r[s+2]=e[2]||0}return r}function Pt(t){for(var n=new Float32Array(2*t.length-6),r=0,i=0,e=t.length/3;i<e;i++){var s=t[3*i],a=t[3*i+1],o=t[3*i+2];if(i>0&&i<e-1){var h=3*r;n[h]=s,n[h+1]=a,n[h+2]=o,r++}var u=3*r;n[u]=s,n[u+1]=a,n[u+2]=o,r++}return n}function St(t){var n=0,r=t.length;if(1===r)return t[0];for(var i=0;i<r;i++)n+=t[i].length;for(var e=new Float32Array(n),s=0,a=0;a<r;a++)e.set(t[a],s),s+=t[a].length;return e}t.initialize=function(){},t.onmessage=function(t,n){var r=t.data,i=r.type,e=r.datas,s=r.glRes,a=r.matrix,o=r.center;if("ExtrudePolygons"===i){lt(e,o,s,a);var h=vt(e);n(null,h,[h.position,h.normal,h.uv,h.indices])}else if("ExtrudeLines"===i||"Paths"===i){for(var u=0,l=e.length;u<l;u++)for(var c=0,v=e[u].data.length;c<v;c++)e[u].data[c]=ct(e[u].data[c],e[u].center||o,s,a,!0);var f=vt(e,"ExtrudeLines"===i?2:3);n(null,f,[f.position,f.normal,f.uv,f.indices])}else if("ExtrudePolygon"===i){var p=[],x=[];e.forEach((function(t){var n=[t];lt(n,o,s,a);var r=vt(n),i=r.position,e=r.normal,h=r.uv,u=r.indices;p.push({id:t.id,position:i,normal:e,uv:h,indices:u}),x.push(i,e,h,u)})),n(null,p,x)}else if("Line"===i||"FatLine"===i){for(var d=[],y=[],g=0,m=e.length;g<m;g++){for(var z=[],M=0,w=e[g].data.length;M<w;M++){e[g].data[M]=ct(e[g].data[M],e[g].center||o,s,a,!0);var b=At(e[g].data[M]);z.push(Pt(b))}var A=St(z);gt(A,e[g].bottomHeight),d.push({id:e[g].id,position:A.buffer}),y.push(A.buffer)}n(null,d,y)}else if("Lines"===i||"FatLines"===i){for(var P=0,S=[],V=[],Z=0,F=[],L=0,_=e.length;L<_;L++){for(var I=0,E=0,O=e[L].data.length;E<O;E++){e[L].data[E]=ct(e[L].data[E],e[L].center||o,s,a,!0);var U=At(e[L].data[E]);gt(U,e[L].bottomHeight),I+=U.length/3*2-2,F.push(Pt(U))}var q=I;S[L]=[P,P+q],P+=q,V[L]={position:{count:I,start:Z,end:Z+3*I},hide:!1},"FatLines"===i&&(V[L].instanceStart={count:I,start:Z,end:Z+3*I},V[L].instanceEnd={count:I,start:Z,end:Z+3*I}),Z+=3*I}var R=St(F);n(null,{id:e.id,position:R.buffer,geometriesAttributes:V,faceMap:S},[R.buffer])}else if("ExtrudeLine"===i||"Path"===i){for(var j=0,B=e.length;j<B;j++)for(var C=0,k=e[j].data.length;C<k;C++)e[j].data[C]=ct(e[j].data[C],e[j].center||o,s,a,!0);var H=[],N=[];e.forEach((function(t){var n=vt([t],"ExtrudeLine"===i?2:3),r=n.position,e=n.normal,s=n.uv,a=n.indices;H.push({id:t.id,position:r,normal:e,uv:s,indices:a}),N.push(r,e,s,a)})),n(null,H,N)}else if("Bar"===i){for(var T=[],W=[],D=(e=new Float32Array(e)).length/7,Q=0;Q<D;){var X=e.slice(7*Q,7*(Q+1)),G=mt(X),J=G.position,K=G.normal,Y=G.uv,$=G.indices;T.push({id:parseInt(X[6]),position:J,normal:K,uv:Y,indices:$}),W.push(J,K,Y,$),Q++}n(null,T,W)}else if("Bars"===i){var tt=mt(e=new Float32Array(e));n(null,tt,[tt.position,tt.normal,tt.uv,tt.indices])}else console.error("No processing logic found for type:"+i)},Object.defineProperty(t,"__esModule",{value:!0})})'),s.registerWorkerAdapter(Qi,(function(t){const e=[],n=[];function i(t){t.abort?(n.splice(n.indexOf(t),1),e.length&&(n.push(e[0]),e.splice(0,1),r(n[n.length-1]))):n.length<5?(n.push(t),r(t)):e.push(t)}function r(t){fetch(t.url).then((t=>t.text())).then((e=>{new Blob([e],{type:"application/json"}).arrayBuffer().then((e=>{t.postResponse(null,e,[e]),t.abort=!0,i(t)}))})).catch((e=>{console.error(e),t.abort=!0,i(t)}))}t.initialize=function(){},t.onmessage=function(t,e){i({url:t.data,postResponse:e,abort:!1})}}))),t.BaseObject=_,t.BaseObjectTask=At,t.BaseObjectTaskManager=Ft,t.ExtrudeUtil=et,t.GeoJSONUtil=L,t.GeoUtil=me,t.IdentifyUtil=Pe,t.LineMaterial=g,t.LineUtil=gt,t.MergeGeometryUtil=Nt,t.MergedMixin=Oe,t.ThreeLayer=rr,t.ThreeRenderer=or,t.geometryExtrude=Zi,t.getFetchDataActor=function(){return s.worker||console.error("maptalks.worker is not defined,You can't use"),Di||(Di=new s.worker.Actor(Qi)),Di},t.polyextrude=B,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.three v0.39.0")}));
//# sourceMappingURL=maptalks.three.min.js.map
