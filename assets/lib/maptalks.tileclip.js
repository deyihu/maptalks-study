/*!
 * maptalks.tileclip v0.54.0
  */
(function (global, factory) {
  typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('maptalks')) :
  typeof define === 'function' && define.amd ? define(['exports', 'maptalks'], factory) :
  (global = typeof globalThis !== 'undefined' ? globalThis : global || self, factory(global.maptalks = global.maptalks || {}, global.maptalks));
})(this, (function (exports, maptalks) { 'use strict';

  var WORKERCODE = `/*!
 * maptalks.tileclip v0.54.0
  */
function(exports){"use strict";class CustomError extends Error{constructor(message,code){super(message),this.code=code}}var HEADERS={accept:"image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 Edg/107.0.1418.26"};function isNumber$1(value){return"number"==typeof value}function createError(message,code){return new CustomError(message,code)}createError("not find canvas.The current environment does not support OffscreenCanvas",-4);var FetchCancelError=createError("fetch tile data cancel",499),FetchTimeoutError=createError("fetch tile data timeout",408);function createNetWorkError(url){return createError("fetch NetWork error, the url is "+url,-5)}function createParamsValidateError(message){return createError(message,-1)}function createDataError(message){return createError(message,-2)}function createInnerError(message){return createError(message,-3)}function checkTileUrl(url){return Array.isArray(url)?url:[url]}function lnglat2Mercator(coordinates){var[lng,lat]=coordinates,x=lng*Math.PI/180*6378137,a=lat*Math.PI/180;return[x,3189068.5*Math.log((1+Math.sin(a))/(1-Math.sin(a)))]}function isEPSG3857(projection){return"EPSG:3857"===projection}createError("the task is cancel",-6);var globalId=0;function uuid(){return++globalId}function isImageBitmap(image){return image&&image instanceof ImageBitmap}function disposeImage(images){Array.isArray(images)||(images=[images]),images.forEach(function(image){image&&image.close&&image.close()})}function encodeMapBox(height,out){var value=Math.floor(10*(height+1e4)),r=value>>16,g=value>>8&255,b=255&value;return out?(out[0]=r,out[1]=g,out[2]=b,out):[r,g,b]}function rgb2Height(R,G,B){return.1*(256*R*256+256*G+B)-1e4}function replaceAll(template,key,value){for(;template.indexOf(key)>-1;)template=template.replace(key,value);return template}function checkBuffers(image){var images=checkTileUrl(image),buffers=[];return images.forEach(function(item){(isImageBitmap(item)||item&&item instanceof ArrayBuffer)&&buffers.push(item)}),buffers}function getTileUrl(urlTemplate,x,y,z,subdomains){var key="{x}",url=replaceAll(urlTemplate,key,x);return url=replaceAll(url,key="{y}",y),function(url,subdomains){if(!subdomains||!subdomains.length)return url;var len=subdomains.length,index=Math.floor(Math.random()*len);return replaceAll(url,"{s}",subdomains[index=Math.min(index,len-1)])}(url=replaceAll(url,key="{z}",z),subdomains)}function validateSubdomains(urlTemplate,subdomains){return!(urlTemplate&&urlTemplate.indexOf("{s}")>-1&&(!subdomains||0===subdomains.length))}var a0,a1,a2,a3,b1,b2,commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function commonjsRequire(path){throw new Error('Could not dynamically require "'+path+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}function convolveRGBA(src,out,line,coeff,width,height){var rgba,prev_src_r,prev_src_g,prev_src_b,prev_src_a,curr_src_r,curr_src_g,curr_src_b,curr_src_a,curr_out_r,curr_out_g,curr_out_b,curr_out_a,prev_out_r,prev_out_g,prev_out_b,prev_out_a,prev_prev_out_r,prev_prev_out_g,prev_prev_out_b,prev_prev_out_a,src_index,out_index,line_index,i,j,coeff_a0,coeff_a1,coeff_b1,coeff_b2;for(i=0;i<height;i++){for(out_index=i,line_index=0,prev_src_g=(rgba=src[src_index=i*width])>>8&255,prev_src_b=rgba>>16&255,prev_src_a=rgba>>24&255,prev_out_r=prev_prev_out_r=(prev_src_r=255&rgba)*coeff[6],prev_out_g=prev_prev_out_g=prev_src_g*coeff[6],prev_out_b=prev_prev_out_b=prev_src_b*coeff[6],prev_out_a=prev_prev_out_a=prev_src_a*coeff[6],coeff_a0=coeff[0],coeff_a1=coeff[1],coeff_b1=coeff[4],coeff_b2=coeff[5],j=0;j<width;j++)curr_out_r=(curr_src_r=255&(rgba=src[src_index]))*coeff_a0+prev_src_r*coeff_a1+prev_out_r*coeff_b1+prev_prev_out_r*coeff_b2,curr_out_g=(curr_src_g=rgba>>8&255)*coeff_a0+prev_src_g*coeff_a1+prev_out_g*coeff_b1+prev_prev_out_g*coeff_b2,curr_out_b=(curr_src_b=rgba>>16&255)*coeff_a0+prev_src_b*coeff_a1+prev_out_b*coeff_b1+prev_prev_out_b*coeff_b2,curr_out_a=(curr_src_a=rgba>>24&255)*coeff_a0+prev_src_a*coeff_a1+prev_out_a*coeff_b1+prev_prev_out_a*coeff_b2,prev_prev_out_r=prev_out_r,prev_prev_out_g=prev_out_g,prev_prev_out_b=prev_out_b,prev_prev_out_a=prev_out_a,prev_out_r=curr_out_r,prev_out_g=curr_out_g,prev_out_b=curr_out_b,prev_out_a=curr_out_a,prev_src_r=curr_src_r,prev_src_g=curr_src_g,prev_src_b=curr_src_b,prev_src_a=curr_src_a,line[line_index]=prev_out_r,line[line_index+1]=prev_out_g,line[line_index+2]=prev_out_b,line[line_index+3]=prev_out_a,line_index+=4,src_index++;for(line_index-=4,out_index+=height*(width-1),prev_src_g=(rgba=src[--src_index])>>8&255,prev_src_b=rgba>>16&255,prev_src_a=rgba>>24&255,prev_out_r=prev_prev_out_r=(prev_src_r=255&rgba)*coeff[7],prev_out_g=prev_prev_out_g=prev_src_g*coeff[7],prev_out_b=prev_prev_out_b=prev_src_b*coeff[7],prev_out_a=prev_prev_out_a=prev_src_a*coeff[7],curr_src_r=prev_src_r,curr_src_g=prev_src_g,curr_src_b=prev_src_b,curr_src_a=prev_src_a,coeff_a0=coeff[2],coeff_a1=coeff[3],j=width-1;j>=0;j--)curr_out_r=curr_src_r*coeff_a0+prev_src_r*coeff_a1+prev_out_r*coeff_b1+prev_prev_out_r*coeff_b2,curr_out_g=curr_src_g*coeff_a0+prev_src_g*coeff_a1+prev_out_g*coeff_b1+prev_prev_out_g*coeff_b2,curr_out_b=curr_src_b*coeff_a0+prev_src_b*coeff_a1+prev_out_b*coeff_b1+prev_prev_out_b*coeff_b2,curr_out_a=curr_src_a*coeff_a0+prev_src_a*coeff_a1+prev_out_a*coeff_b1+prev_prev_out_a*coeff_b2,prev_prev_out_r=prev_out_r,prev_prev_out_g=prev_out_g,prev_prev_out_b=prev_out_b,prev_prev_out_a=prev_out_a,prev_out_r=curr_out_r,prev_out_g=curr_out_g,prev_out_b=curr_out_b,prev_out_a=curr_out_a,prev_src_r=curr_src_r,prev_src_g=curr_src_g,prev_src_b=curr_src_b,prev_src_a=curr_src_a,curr_src_r=255&(rgba=src[src_index]),curr_src_g=rgba>>8&255,curr_src_b=rgba>>16&255,curr_src_a=rgba>>24&255,rgba=(line[line_index]+prev_out_r|0)+(line[line_index+1]+prev_out_g<<8)+(line[line_index+2]+prev_out_b<<16)+(line[line_index+3]+prev_out_a<<24),out[out_index]=rgba,src_index--,line_index-=4,out_index-=height}}var canvas,globalCanvas,glur=function(src,width,height,radius){if(radius){var src32=new Uint32Array(src.buffer),out=new Uint32Array(src32.length),tmp_line=new Float32Array(4*Math.max(width,height)),coeff=function(sigma){sigma<.5&&(sigma=.5);var a=Math.exp(.527076)/sigma,g1=Math.exp(-a),g2=Math.exp(-2*a),k=(1-g1)*(1-g1)/(1+2*a*g1-g2);return a0=k,a1=k*(a-1)*g1,a2=k*(a+1)*g1,a3=-k*g2,b1=2*g1,b2=-g2,new Float32Array([a0,a1,a2,a3,b1,b2,(a0+a1)/(1-b1-b2),(a2+a3)/(1-b1-b2)])}(radius);convolveRGBA(src32,out,tmp_line,coeff,width,height),convolveRGBA(out,src32,tmp_line,coeff,height,width)}},OPTIONS={width:100,height:10},offscreenCanvas=!1;try{new OffscreenCanvas(1,1).getContext("2d").fillText("hello",0,0),offscreenCanvas=!0}catch(err){offscreenCanvas=!1}function getCanvas$1(){if(!canvas){var{width:width,height:height}=OPTIONS;offscreenCanvas?canvas=new OffscreenCanvas(width,height):((canvas=document.createElement("canvas")).width=width,canvas.height=height)}return canvas}class ColorIn{constructor(colors,options={}){if(Array.isArray(colors))if(colors.length<2)console.error("colors.length should >1");else{this.colors=colors;for(var min=1/0,max=-1/0,i=0,len=colors.length;i<len;i++){var value=colors[i][0];min=Math.min(value,min),max=Math.max(value,max)}this.min=min,this.max=max,this.valueOffset=this.max-this.min,this.options=Object.assign({},OPTIONS,options),this._initImgData()}else console.error("colors is not array")}getImageData(){return this.imgData}_initImgData(){var canvas=getCanvas$1(),{width:width,height:height}=this.options;canvas.width=width,canvas.height=height;var ctx=canvas.getContext("2d",{willReadFrequently:!0});ctx.clearRect(0,0,canvas.width,canvas.height);for(var gradient=ctx.createLinearGradient(0,0,canvas.width,0),{colors:colors,valueOffset:valueOffset}=this,i=0,len=colors.length;i<len;i++){var[stop,color]=colors[i],s=(stop-this.min)/valueOffset;gradient.addColorStop(s,color)}ctx.fillStyle=gradient,ctx.fillRect(0,0,canvas.width,canvas.height),this.imgData=ctx.getImageData(0,0,canvas.width,canvas.height)}getColor(stop){stop=Math.max(this.min,stop);var s=((stop=Math.min(stop,this.max))-this.min)/this.valueOffset,x=Math.round(s*this.imgData.width),idx=4*(x=Math.min(x,this.imgData.width-1));return[this.imgData.data[idx],this.imgData.data[idx+1],this.imgData.data[idx+2],this.imgData.data[idx+3]]}}function getCanvas(tileSize=256){return!globalCanvas&&OffscreenCanvas&&(globalCanvas=new OffscreenCanvas(1,1)),globalCanvas&&resizeCanvas(globalCanvas,tileSize,tileSize),globalCanvas}function resizeCanvas(canvas,width,height){canvas&&(canvas.width=width,canvas.height=height)}function clearCanvas(ctx){var canvas=ctx.canvas;ctx.clearRect(0,0,canvas.width,canvas.height)}function getCanvasContext(canvas){var ctx=canvas.getContext("2d",{willReadFrequently:!0});return clearCanvas(ctx),ctx}function getBlankTile(tileSize){var canvas=getCanvas(tileSize);return getCanvasContext(canvas),canvas.transferToImageBitmap()}function mergeTiles(images,globalCompositeOperation){if(1===images.length)return images[0];if(0===images.length)return createDataError("merge tiles error,not find imagebitmaps");for(var i=0,len=images.length;i<len;i++){if(!isImageBitmap(images[i]))return createDataError("merge tiles error,images not imagebitmap")}var tileSize=images[0].width,canvas=getCanvas(tileSize),ctx=getCanvasContext(canvas);return globalCompositeOperation&&(ctx.save(),ctx.globalCompositeOperation=globalCompositeOperation),images.forEach(function(image){ctx.drawImage(image,0,0,tileSize,tileSize)}),globalCompositeOperation&&ctx.restore(),disposeImage(images),canvas.transferToImageBitmap()}function drawPolygons(ctx,polygons){polygons.forEach(function(polygon){!function(polygon){for(var i=0,len=polygon.length;i<len;i++){var ring=polygon[i],first=ring[0],last=ring[ring.length-1],[x1,y1]=first,[x2,y2]=last;x1===x2&&y1===y2||ring.push(first);for(var j=0,len1=ring.length;j<len1;j++){var[x,y]=ring[j];0===j?ctx.moveTo(x,y):ctx.lineTo(x,y)}}}(polygon)})}function imageClip(tileSize,polygons,image,reverse,clipBufferOpts){var canvas=getCanvas(tileSize),ctx=getCanvasContext(canvas),bufferPixels=[],{width:width,height:height}=canvas,imageWidth=image.width,imageHeight=image.height;if(clipBufferOpts){var{polygons:_polygons,bufferSize:bufferSize}=clipBufferOpts;ctx.save(),ctx.beginPath(),ctx.lineWidth=2*bufferSize,ctx.lineJoin="round",ctx.strokeStyle="black",drawPolygons(ctx,_polygons),ctx.stroke(),ctx.restore();var imageData=ctx.getImageData(0,0,width,height);clearCanvas(ctx),ctx.drawImage(image,0,0);for(var idx=-1,data=ctx.getImageData(0,0,width,height).data,i=0,len=imageData.data.length;i<len;i+=4){if(imageData.data[i+3]>0){var R=data[i],G=data[i+1],B=data[i+2],A=data[i+3];bufferPixels[++idx]=[i,R,G,B,A]}}}if(clearCanvas(ctx),ctx.save(),ctx.beginPath(),reverse&&ctx.rect(0,0,width,height),drawPolygons(ctx,polygons),ctx.clip("evenodd"),ctx.drawImage(image,0,0,width,height),bufferPixels.length){for(var _imageData=ctx.getImageData(0,0,width,height),_data=_imageData.data,_i=0,_len=bufferPixels.length;_i<_len;_i++){var[_idx,_R,_G,_B,_A]=bufferPixels[_i];_data[_idx]=_R,_data[_idx+1]=_G,_data[_idx+2]=_B,_data[_idx+3]=_A}ctx.putImageData(_imageData,0,0)}var bitImage=canvas.transferToImageBitmap();return ctx.restore(),disposeImage(image),canvas.width===imageWidth&&canvas.height===imageHeight?bitImage:(resizeCanvas(canvas,imageWidth,imageHeight),getCanvasContext(canvas).drawImage(bitImage,0,0,imageWidth,imageHeight),disposeImage(bitImage),canvas.transferToImageBitmap())}function layoutTiles(tiles,debug){var minx=1/0,miny=1/0,maxx=-1/0,maxy=-1/0,tileSize=256;tiles.forEach(function(tile){var[x,y]=tile;minx=Math.min(x,minx),miny=Math.min(y,miny),maxx=Math.max(x,maxx),maxy=Math.max(y,maxy),tileSize=tile.tileImage.width});var width=(maxx-minx+1)*tileSize,height=(maxy-miny+1)*tileSize,canvas=getCanvas();resizeCanvas(canvas,width,height);var ctx=getCanvasContext(canvas);return debug&&(ctx.font="bold 28px serif",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillStyle="red",ctx.strokeStyle="red"),tiles.forEach(function(tile){var[x,y,z]=tile,dx=(x-minx)*tileSize,dy=(y-miny)*tileSize,tileImage=tile.tileImage;ctx.drawImage(tileImage,dx,dy,tileSize,tileSize),debug&&(ctx.rect(dx,dy,tileSize,tileSize),ctx.stroke(),ctx.fillText([x,y,z].join("_").toString(),dx+100,dy+100))}),disposeImage(tiles.map(function(tile){return tile.tileImage})),canvas.transferToImageBitmap()}function postProcessingImage(image,options){var filterImage=function(image,filter){if(!filter)return image;var canvas=getCanvas(image.width);resizeCanvas(canvas,image.width,image.height);var ctx=getCanvasContext(canvas);ctx.save(),ctx.filter=filter,ctx.drawImage(image,0,0),ctx.restore();var bitImage=canvas.transferToImageBitmap();return disposeImage(image),bitImage}(image,options.filter),blurImage=function(image,radius){if(!isNumber$1(radius)||radius<=0)return image;var canvas=getCanvas(image.width);resizeCanvas(canvas,image.width,image.height);var ctx=getCanvasContext(canvas);ctx.drawImage(image,0,0);var imageData=ctx.getImageData(0,0,canvas.width,canvas.height);glur(imageData.data,canvas.width,canvas.height,radius),ctx.putImageData(imageData,0,0);var bitImage=canvas.transferToImageBitmap();return disposeImage(image),bitImage}(filterImage,options.gaussianBlurRadius),opImage=function(image,opacity=1){if(!isNumber$1(opacity)||1===opacity||opacity<0||opacity>1)return image;var canvas=getCanvas();resizeCanvas(canvas,image.width,image.height);var ctx=getCanvasContext(canvas);ctx.globalAlpha=opacity,ctx.drawImage(image,0,0);var bitImage=canvas.transferToImageBitmap();return ctx.globalAlpha=1,disposeImage(image),bitImage}(blurImage,options.opacity),oldImage=function(image,oldPhoto){if(!oldPhoto)return image;var{width:width,height:height}=image,canvas=getCanvas();resizeCanvas(canvas,width,height);var ctx=getCanvasContext(canvas);ctx.drawImage(image,0,0);for(var imageData=ctx.getImageData(0,0,width,height),data=imageData.data,i=0;i<data.length;i+=4){var r=data[i+0],g=data[i+1],b=data[i+2];data[i+0]=.28*r+.72*g+.22*b,data[i+1]=.25*r+.63*g+.13*b,data[i+2]=.17*r+.66*g+.13*b}ctx.putImageData(imageData,0,0);var bitImage=canvas.transferToImageBitmap();return disposeImage(image),bitImage}(opImage,options.oldPhoto),mosaicImage=function(image,mosaicSize){if(!isNumber$1(mosaicSize))return image;if((mosaicSize=Math.ceil(mosaicSize))<2)return image;var{width:width,height:height}=image,canvas=getCanvas(width),ctx=getCanvasContext(canvas);ctx.drawImage(image,0,0);for(var imgData=ctx.getImageData(0,0,width,height),data=imgData.data,blur=Math.min(mosaicSize,width,height),cols=Math.ceil(width/blur),rows=Math.ceil(height/blur),col=1,row=1,rects=[],idx=-1;col<=cols;){for(;row<=rows;){var x1=(col-1)*blur+1,y1=(row-1)*blur+1,x2=Math.min(x1+blur-1,width),y2=Math.min(y1+blur-1,height);rects[++idx]=[x1,y1,x2,y2],row++}row=1,col++}for(var i=0,len=rects.length;i<len;i++){for(var rect=rects[i],[_x,_y,_x2,_y2]=rect,idxList=[],index=-1,r=0,g=0,b=0,a=0,y=_y;y<=_y2;y++)for(var x=_x;x<=_x2;x++){var _idx2=(y-1)*width*4+4*(x-1);idxList[++index]=_idx2,r+=data[_idx2],g+=data[_idx2+1],b+=data[_idx2+2],a+=data[_idx2+3]}for(var len1=idxList.length,ra=Math.round(r/len1),ga=Math.round(g/len1),ba=Math.round(b/len1),aa=Math.round(a/len1),j=0;j<len1;j++){var _idx3=idxList[j];data[_idx3]=ra,data[_idx3+1]=ga,data[_idx3+2]=ba,data[_idx3+3]=aa}}return ctx.putImageData(imgData,0,0),disposeImage(image),canvas.transferToImageBitmap()}(oldImage,options.mosaicSize);return mosaicImage}function createImageBlobURL(canvas,image,options){return new Promise(function(resolve,reject){var{returnBlobURL:returnBlobURL,returnUint32Buffer:returnUint32Buffer,returnBase64:returnBase64}=options||{};if(returnBlobURL||returnUint32Buffer||returnBase64){resizeCanvas(canvas,image.width,image.height);var ctx=getCanvasContext(canvas);if(ctx.drawImage(image,0,0),disposeImage(image),returnUint32Buffer){var imageData=ctx.getImageData(0,0,image.width,image.height),array=new Uint32Array(imageData.data);resolve(array.buffer)}else returnBlobURL?canvas.convertToBlob().then(function(blob){var url=URL.createObjectURL(blob);resolve(url)}).catch(function(error){reject(error)}):canvas.convertToBlob().then(function(blob){var fileReader=new FileReader;fileReader.onload=function(){resolve(fileReader.result)},fileReader.readAsDataURL(blob)}).catch(function(error){reject(error)})}else resolve(image)})}var colorInCache=new Map;function colorsTerrainTile(colors,image){if(!colors||!Array.isArray(colors)||colors.length<2)return image;var key=JSON.stringify(colors),ci=colorInCache.get(key);ci||(ci=new ColorIn(colors),colorInCache.set(key,ci));var{width:width,height:height}=image,canvas=getCanvas();resizeCanvas(canvas,width,height);var ctx=getCanvasContext(canvas);ctx.drawImage(image,0,0);for(var imageData=ctx.getImageData(0,0,width,height),data=imageData.data,i=0;i<data.length;i+=4){var R=data[i],G=data[i+1],B=data[i+2];if(0===data[i+3])data[i]=0,data[i+1]=0,data[i+2]=0;else{var _height=rgb2Height(R,G,B),[r,g,b,a]=ci.getColor(_height);data[i]=r,data[i+1]=g,data[i+2]=b,data[i+3]=a}}return ctx.putImageData(imageData,0,0),disposeImage(image),canvas.transferToImageBitmap()}var nullOnRemove=function(){};class LRUCache{constructor(max,onRemove){this.max=max,this.onRemove=onRemove||nullOnRemove,this.reset()}reset(){if(this.data){var values=this.data.values();for(var p of values)this.onRemove(p)}return this.data=new Map,this}clear(){this.reset(),delete this.onRemove}add(key,data){return data?(this.has(key)?(this.data.delete(key),this.data.set(key,data),this.data.size>this.max&&this.shrink()):(this.data.set(key,data),this.data.size>this.max&&this.shrink()),this):this}keys(){var keys=new Array(this.data.size),i=0,iterator=this.data.keys();for(var k of iterator)keys[i++]=k;return keys}shrink(){for(var iterator=this.data.keys(),item=iterator.next();this.data.size>this.max;){var removedData=this.getAndRemove(item.value);removedData&&this.onRemove(removedData),item=iterator.next()}}has(key){return this.data.has(key)}getAndRemove(key){if(!this.has(key))return null;var data=this.data.get(key);return this.data.delete(key),data}get(key){return this.has(key)?this.data.get(key):null}remove(key){if(!this.has(key))return this;var data=this.data.get(key);return this.data.delete(key),this.onRemove(data),this}setMaxSize(max){return this.max=max,this.data.size>this.max&&this.shrink(),this}}
/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */(function(){function m(d){throw d}var w=void 0,z=!0,aa=this;function A(d,a){var b,c=d.split("."),e=aa;!(c[0]in e)&&e.execScript&&e.execScript("var "+c[0]);for(;c.length&&(b=c.shift());)c.length||a===w?e=e[b]?e[b]:e[b]={}:e[b]=a}var G="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array&&"undefined"!=typeof DataView;function I(d,a){this.index="number"==typeof a?a:0,this.i=0,this.buffer=d instanceof(G?Uint8Array:Array)?d:new(G?Uint8Array:Array)(32768),2*this.buffer.length<=this.index&&m(Error("invalid index")),this.buffer.length<=this.index&&this.f()}I.prototype.f=function(){var a,d=this.buffer,c=d.length,e=new(G?Uint8Array:Array)(c<<1);if(G)e.set(d);else for(a=0;a<c;++a)e[a]=d[a];return this.buffer=e},I.prototype.d=function(d,a,c){var h,e=this.buffer,b=this.index,f=this.i,g=e[b];if(c&&1<a&&(d=8<a?(Q[255&d]<<24|Q[d>>>8&255]<<16|Q[d>>>16&255]<<8|Q[d>>>24&255])>>32-a:Q[d]>>8-a),8>a+f)g=g<<a|d,f+=a;else for(h=0;h<a;++h)g=g<<1|d>>a-h-1&1,8===++f&&(f=0,e[b++]=Q[g],g=0,b===e.length&&(e=this.f()));e[b]=g,this.buffer=e,this.i=f,this.index=b},I.prototype.finish=function(){var c,d=this.buffer,a=this.index;return 0<this.i&&(d[a]<<=8-this.i,d[a]=Q[d[a]],a++),G?c=d.subarray(0,a):(d.length=a,c=d),c};var ca,ba=new(G?Uint8Array:Array)(256);for(ca=0;256>ca;++ca){for(var ha=R=ca,ia=7,R=R>>>1;R;R>>>=1)ha<<=1,ha|=1&R,--ia;ba[ca]=(ha<<ia&255)>>>0}var Q=ba;function ja(d){this.buffer=new(G?Uint16Array:Array)(2*d),this.length=0}function S(d){var b,f,g,h,k,p,q,r,n,l,a=d.length,c=0,e=Number.POSITIVE_INFINITY;for(r=0;r<a;++r)d[r]>c&&(c=d[r]),d[r]<e&&(e=d[r]);for(b=1<<c,f=new(G?Uint32Array:Array)(b),g=1,h=0,k=2;g<=c;){for(r=0;r<a;++r)if(d[r]===g){for(p=0,q=h,n=0;n<g;++n)p=p<<1|1&q,q>>=1;for(l=g<<16|r,n=p;n<b;n+=k)f[n]=l;++h}++g,h<<=1,k<<=1}return[f,c,e]}function ka(d,a){this.h=na,this.w=0,this.input=G&&d instanceof Array?new Uint8Array(d):d,this.b=0,a&&(a.lazy&&(this.w=a.lazy),"number"==typeof a.compressionType&&(this.h=a.compressionType),a.outputBuffer&&(this.a=G&&a.outputBuffer instanceof Array?new Uint8Array(a.outputBuffer):a.outputBuffer),"number"==typeof a.outputIndex&&(this.b=a.outputIndex)),this.a||(this.a=new(G?Uint8Array:Array)(32768))}ja.prototype.getParent=function(d){return 2*((d-2)/4|0)},ja.prototype.push=function(d,a){var c,e,f,b=this.buffer;for(c=this.length,b[this.length++]=a,b[this.length++]=d;0<c&&(e=this.getParent(c),b[c]>b[e]);)f=b[c],b[c]=b[e],b[e]=f,f=b[c+1],b[c+1]=b[e+1],b[e+1]=f,c=e;return this.length},ja.prototype.pop=function(){var d,a,e,b,f,c=this.buffer;for(a=c[0],d=c[1],this.length-=2,c[0]=c[this.length],c[1]=c[this.length+1],f=0;!((b=2*f+2)>=this.length)&&(b+2<this.length&&c[b+2]>c[b]&&(b+=2),c[b]>c[f]);)e=c[f],c[f]=c[b],c[b]=e,e=c[f+1],c[f+1]=c[b+1],c[b+1]=e,f=b;return{index:d,value:a,length:this.length}};var T,na=2,oa={NONE:0,r:1,k:na,N:3},pa=[];for(T=0;288>T;T++)switch(z){case 143>=T:pa.push([T+48,8]);break;case 255>=T:pa.push([T-144+400,9]);break;case 279>=T:pa.push([T-256+0,7]);break;case 287>=T:pa.push([T-280+192,8]);break;default:m("invalid literal: "+T)}function ua(d,a){this.length=d,this.G=a}ka.prototype.j=function(){var d,a,c,e,b=this.input;switch(this.h){case 0:for(c=0,e=b.length;c<e;){var h,k,p,f=a=G?b.subarray(c,c+65535):b.slice(c,c+65535),g=(c+=a.length)===e,q=w,r=w,n=this.a,l=this.b;if(G){for(n=new Uint8Array(this.a.buffer);n.length<=l+f.length+5;)n=new Uint8Array(n.length<<1);n.set(this.a)}if(h=g?1:0,n[l++]=0|h,p=65536+~(k=f.length)&65535,n[l++]=255&k,n[l++]=k>>>8&255,n[l++]=255&p,n[l++]=p>>>8&255,G)n.set(f,l),l+=f.length,n=n.subarray(0,l);else{for(q=0,r=f.length;q<r;++q)n[l++]=f[q];n.length=l}this.b=l,this.a=n}break;case 1:var s=new I(G?new Uint8Array(this.a.buffer):this.a,this.b);s.d(1,1,z),s.d(1,2,z);var x,E,B,t=qa(this,b);for(x=0,E=t.length;x<E;x++)if(B=t[x],I.prototype.d.apply(s,pa[B]),256<B)s.d(t[++x],t[++x],z),s.d(t[++x],5),s.d(t[++x],t[++x],z);else if(256===B)break;this.a=s.finish(),this.b=this.a.length;break;case na:var L,v,M,Y,Z,da,Fa,ea,Ga,la,Ha,$,ma,D,Ia,C=new I(G?new Uint8Array(this.a.buffer):this.a,this.b),gb=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],sa=Array(19);for(L=na,C.d(1,1,z),C.d(L,2,z),v=qa(this,b),Fa=ta(da=ra(this.L,15)),Ga=ta(ea=ra(this.K,7)),M=286;257<M&&0===da[M-1];M--);for(Y=30;1<Y&&0===ea[Y-1];Y--);var u,N,y,fa,H,F,Ja=M,Ka=Y,K=new(G?Uint32Array:Array)(Ja+Ka),J=new(G?Uint32Array:Array)(316),O=new(G?Uint8Array:Array)(19);for(u=N=0;u<Ja;u++)K[N++]=da[u];for(u=0;u<Ka;u++)K[N++]=ea[u];if(!G)for(u=0,fa=O.length;u<fa;++u)O[u]=0;for(u=H=0,fa=K.length;u<fa;u+=N){for(N=1;u+N<fa&&K[u+N]===K[u];++N);if(y=N,0===K[u])if(3>y)for(;0<y--;)J[H++]=0,O[0]++;else for(;0<y;)(F=138>y?y:138)>y-3&&F<y&&(F=y-3),10>=F?(J[H++]=17,J[H++]=F-3,O[17]++):(J[H++]=18,J[H++]=F-11,O[18]++),y-=F;else if(J[H++]=K[u],O[K[u]]++,3>--y)for(;0<y--;)J[H++]=K[u],O[K[u]]++;else for(;0<y;)(F=6>y?y:6)>y-3&&F<y&&(F=y-3),J[H++]=16,J[H++]=F-3,O[16]++,y-=F}for(d=G?J.subarray(0,H):J.slice(0,H),la=ra(O,7),D=0;19>D;D++)sa[D]=la[gb[D]];for(Z=19;4<Z&&0===sa[Z-1];Z--);for(Ha=ta(la),C.d(M-257,5,z),C.d(Y-1,5,z),C.d(Z-4,4,z),D=0;D<Z;D++)C.d(sa[D],3,z);for(D=0,Ia=d.length;D<Ia;D++)if($=d[D],C.d(Ha[$],la[$],z),16<=$){switch(D++,$){case 16:ma=2;break;case 17:ma=3;break;case 18:ma=7;break;default:m("invalid code: "+$)}C.d(d[D],ma,z)}var P,Na,ga,va,Oa,Pa,Qa,Ra,La=[Fa,da],Ma=[Ga,ea];for(Oa=La[0],Pa=La[1],Qa=Ma[0],Ra=Ma[1],P=0,Na=v.length;P<Na;++P)if(ga=v[P],C.d(Oa[ga],Pa[ga],z),256<ga)C.d(v[++P],v[++P],z),va=v[++P],C.d(Qa[va],Ra[va],z),C.d(v[++P],v[++P],z);else if(256===ga)break;this.a=C.finish(),this.b=this.a.length;break;default:m("invalid compression type")}return this.a};var wa=function(){function d(b){switch(z){case 3===b:return[257,b-3,0];case 4===b:return[258,b-4,0];case 5===b:return[259,b-5,0];case 6===b:return[260,b-6,0];case 7===b:return[261,b-7,0];case 8===b:return[262,b-8,0];case 9===b:return[263,b-9,0];case 10===b:return[264,b-10,0];case 12>=b:return[265,b-11,1];case 14>=b:return[266,b-13,1];case 16>=b:return[267,b-15,1];case 18>=b:return[268,b-17,1];case 22>=b:return[269,b-19,2];case 26>=b:return[270,b-23,2];case 30>=b:return[271,b-27,2];case 34>=b:return[272,b-31,2];case 42>=b:return[273,b-35,3];case 50>=b:return[274,b-43,3];case 58>=b:return[275,b-51,3];case 66>=b:return[276,b-59,3];case 82>=b:return[277,b-67,4];case 98>=b:return[278,b-83,4];case 114>=b:return[279,b-99,4];case 130>=b:return[280,b-115,4];case 162>=b:return[281,b-131,5];case 194>=b:return[282,b-163,5];case 226>=b:return[283,b-195,5];case 257>=b:return[284,b-227,5];case 258===b:return[285,b-258,0];default:m("invalid length: "+b)}}var c,e,a=[];for(c=3;258>=c;c++)e=d(c),a[c]=e[2]<<24|e[1]<<16|e[0];return a}(),xa=G?new Uint32Array(wa):wa;function qa(d,a){function c(b,c){var f,g,h,k,a=b.G,d=[],e=0;switch(f=xa[b.length],d[e++]=65535&f,d[e++]=f>>16&255,d[e++]=f>>24,z){case 1===a:g=[0,a-1,0];break;case 2===a:g=[1,a-2,0];break;case 3===a:g=[2,a-3,0];break;case 4===a:g=[3,a-4,0];break;case 6>=a:g=[4,a-5,1];break;case 8>=a:g=[5,a-7,1];break;case 12>=a:g=[6,a-9,2];break;case 16>=a:g=[7,a-13,2];break;case 24>=a:g=[8,a-17,3];break;case 32>=a:g=[9,a-25,3];break;case 48>=a:g=[10,a-33,4];break;case 64>=a:g=[11,a-49,4];break;case 96>=a:g=[12,a-65,5];break;case 128>=a:g=[13,a-97,5];break;case 192>=a:g=[14,a-129,6];break;case 256>=a:g=[15,a-193,6];break;case 384>=a:g=[16,a-257,7];break;case 512>=a:g=[17,a-385,7];break;case 768>=a:g=[18,a-513,8];break;case 1024>=a:g=[19,a-769,8];break;case 1536>=a:g=[20,a-1025,9];break;case 2048>=a:g=[21,a-1537,9];break;case 3072>=a:g=[22,a-2049,10];break;case 4096>=a:g=[23,a-3073,10];break;case 6144>=a:g=[24,a-4097,11];break;case 8192>=a:g=[25,a-6145,11];break;case 12288>=a:g=[26,a-8193,12];break;case 16384>=a:g=[27,a-12289,12];break;case 24576>=a:g=[28,a-16385,13];break;case 32768>=a:g=[29,a-24577,13];break;default:m("invalid distance")}for(f=g,d[e++]=f[0],d[e++]=f[1],d[e++]=f[2],h=0,k=d.length;h<k;++h)n[l++]=d[h];t[d[0]]++,x[d[3]]++,s=b.length+c-1,r=null}var e,b,f,g,h,p,q,r,B,k={},n=G?new Uint16Array(2*a.length):[],l=0,s=0,t=new(G?Uint32Array:Array)(286),x=new(G?Uint32Array:Array)(30),E=d.w;if(!G){for(f=0;285>=f;)t[f++]=0;for(f=0;29>=f;)x[f++]=0}for(t[256]=1,e=0,b=a.length;e<b;++e){for(f=h=0,g=3;f<g&&e+f!==b;++f)h=h<<8|a[e+f];if(k[h]===w&&(k[h]=[]),p=k[h],!(0<s--)){for(;0<p.length&&32768<e-p[0];)p.shift();if(e+3>=b){for(r&&c(r,-1),f=0,g=b-e;f<g;++f)B=a[e+f],n[l++]=B,++t[B];break}0<p.length?(q=ya(a,e,p),r?r.length<q.length?(B=a[e-1],n[l++]=B,++t[B],c(q,0)):c(r,-1):q.length<E?r=q:c(q,0)):r?c(r,-1):(B=a[e],n[l++]=B,++t[B])}p.push(e)}return n[l++]=256,t[256]++,d.L=t,d.K=x,G?n.subarray(0,l):n}function ya(d,a,c){var e,b,g,h,k,p,f=0,q=d.length;h=0,p=c.length;a:for(;h<p;h++){if(e=c[p-h-1],g=3,3<f){for(k=f;3<k;k--)if(d[e+k-1]!==d[a+k-1])continue a;g=f}for(;258>g&&a+g<q&&d[e+g]===d[a+g];)++g;if(g>f&&(b=e,f=g),258===g)break}return new ua(f,a-b)}function ra(d,a){var f,g,h,k,p,c=d.length,e=new ja(572),b=new(G?Uint8Array:Array)(c);if(!G)for(k=0;k<c;k++)b[k]=0;for(k=0;k<c;++k)0<d[k]&&e.push(k,d[k]);if(f=Array(e.length/2),g=new(G?Uint32Array:Array)(e.length/2),1===f.length)return b[e.pop().index]=1,b;for(k=0,p=e.length/2;k<p;++k)f[k]=e.pop(),g[k]=f[k].value;for(h=function(d,a,c){function e(b){var c=k[b][p[b]];c===a?(e(b+1),e(b+1)):--g[c],++p[b]}var n,l,s,t,x,b=new(G?Uint16Array:Array)(c),f=new(G?Uint8Array:Array)(c),g=new(G?Uint8Array:Array)(a),h=Array(c),k=Array(c),p=Array(c),q=(1<<c)-a,r=1<<c-1;for(b[c-1]=a,l=0;l<c;++l)q<r?f[l]=0:(f[l]=1,q-=r),q<<=1,b[c-2-l]=(b[c-1-l]/2|0)+a;for(b[0]=f[0],h[0]=Array(b[0]),k[0]=Array(b[0]),l=1;l<c;++l)b[l]>2*b[l-1]+f[l]&&(b[l]=2*b[l-1]+f[l]),h[l]=Array(b[l]),k[l]=Array(b[l]);for(n=0;n<a;++n)g[n]=c;for(s=0;s<b[c-1];++s)h[c-1][s]=d[s],k[c-1][s]=s;for(n=0;n<c;++n)p[n]=0;for(1===f[c-1]&&(--g[0],++p[c-1]),l=c-2;0<=l;--l){for(t=n=0,x=p[l+1],s=0;s<b[l];s++)(t=h[l+1][x]+h[l+1][x+1])>d[n]?(h[l][s]=t,k[l][s]=a,x+=2):(h[l][s]=d[n],k[l][s]=n,++n);p[l]=0,1===f[l]&&e(l)}return g}(g,g.length,a),k=0,p=f.length;k<p;++k)b[f[k].index]=h[k];return b}function ta(d){var f,g,h,k,a=new(G?Uint16Array:Array)(d.length),c=[],e=[],b=0;for(f=0,g=d.length;f<g;f++)c[d[f]]=1+(0|c[d[f]]);for(f=1,g=16;f<=g;f++)e[f]=b,b+=0|c[f],b<<=1;for(f=0,g=d.length;f<g;f++)for(b=e[d[f]],e[d[f]]+=1,h=a[f]=0,k=d[f];h<k;h++)a[f]=a[f]<<1|1&b,b>>>=1;return a}function U(d,a){switch(this.l=[],this.m=32768,this.e=this.g=this.c=this.q=0,this.input=G?new Uint8Array(d):d,this.s=!1,this.n=Aa,this.B=!1,!a&&(a={})||(a.index&&(this.c=a.index),a.bufferSize&&(this.m=a.bufferSize),a.bufferType&&(this.n=a.bufferType),a.resize&&(this.B=a.resize)),this.n){case Ba:this.b=32768,this.a=new(G?Uint8Array:Array)(32768+this.m+258);break;case Aa:this.b=0,this.a=new(G?Uint8Array:Array)(this.m),this.f=this.J,this.t=this.H,this.o=this.I;break;default:m(Error("invalid inflate mode"))}}var Ba=0,Aa=1,Ca={D:Ba,C:Aa};U.prototype.p=function(){for(;!this.s;){var d=V(this,3);switch(1&d&&(this.s=z),d>>>=1){case 0:var a=this.input,c=this.c,e=this.a,b=this.b,f=a.length,g=w,k=e.length,p=w;switch(this.e=this.g=0,c+1>=f&&m(Error("invalid uncompressed block header: LEN")),g=a[c++]|a[c++]<<8,c+1>=f&&m(Error("invalid uncompressed block header: NLEN")),g===~(a[c++]|a[c++]<<8)&&m(Error("invalid uncompressed block header: length verify")),c+g>a.length&&m(Error("input buffer is broken")),this.n){case Ba:for(;b+g>e.length;){if(g-=p=k-b,G)e.set(a.subarray(c,c+p),b),b+=p,c+=p;else for(;p--;)e[b++]=a[c++];this.b=b,e=this.f(),b=this.b}break;case Aa:for(;b+g>e.length;)e=this.f({v:2});break;default:m(Error("invalid inflate mode"))}if(G)e.set(a.subarray(c,c+g),b),b+=g,c+=g;else for(;g--;)e[b++]=a[c++];this.c=c,this.b=b,this.a=e;break;case 1:this.o(Da,Ea);break;case 2:var s,t,x,M,q=V(this,5)+257,r=V(this,5)+1,n=V(this,4)+4,l=new(G?Uint8Array:Array)(Sa.length),E=w,B=w,C=w,L=w,v=w;for(v=0;v<n;++v)l[Sa[v]]=V(this,3);if(!G)for(v=n,n=l.length;v<n;++v)l[Sa[v]]=0;for(s=S(l),E=new(G?Uint8Array:Array)(q+r),v=0,M=q+r;v<M;)switch(B=Ta(this,s),B){case 16:for(L=3+V(this,2);L--;)E[v++]=C;break;case 17:for(L=3+V(this,3);L--;)E[v++]=0;C=0;break;case 18:for(L=11+V(this,7);L--;)E[v++]=0;C=0;break;default:C=E[v++]=B}t=S(G?E.subarray(0,q):E.slice(0,q)),x=S(G?E.subarray(q):E.slice(q)),this.o(t,x);break;default:m(Error("unknown BTYPE: "+d))}}return this.t()};var W,db,Ua=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Sa=G?new Uint16Array(Ua):Ua,Va=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],Wa=G?new Uint16Array(Va):Va,Xa=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],Ya=G?new Uint8Array(Xa):Xa,Za=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],$a=G?new Uint16Array(Za):Za,ab=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],bb=G?new Uint8Array(ab):ab,cb=new(G?Uint8Array:Array)(288);for(W=0,db=cb.length;W<db;++W)cb[W]=143>=W?8:255>=W?9:279>=W?7:8;var fb,hb,Da=S(cb),eb=new(G?Uint8Array:Array)(30);for(fb=0,hb=eb.length;fb<hb;++fb)eb[fb]=5;var Ea=S(eb);function V(d,a){for(var h,c=d.g,e=d.e,b=d.input,f=d.c,g=b.length;e<a;)f>=g&&m(Error("input buffer is broken")),c|=b[f++]<<e,e+=8;return h=c&(1<<a)-1,d.g=c>>>a,d.e=e-a,d.c=f,h}function Ta(d,a){for(var p,q,c=d.g,e=d.e,b=d.input,f=d.c,g=b.length,h=a[0],k=a[1];e<k&&!(f>=g);)c|=b[f++]<<e,e+=8;return(q=(p=h[c&(1<<k)-1])>>>16)>e&&m(Error("invalid code length: "+q)),d.g=c>>q,d.e=e-q,d.c=f,65535&p}function ib(d){if("string"==typeof d){var c,e,a=d.split("");for(c=0,e=a.length;c<e;c++)a[c]=(255&a[c].charCodeAt(0))>>>0;d=a}for(var h,b=1,f=0,g=d.length,k=0;0<g;){g-=h=1024<g?1024:g;do{f+=b+=d[k++]}while(--h);b%=65521,f%=65521}return(f<<16|b)>>>0}function jb(d,a){var c,e;if(this.input=d,this.c=0,!a&&(a={})||(a.index&&(this.c=a.index),a.verify&&(this.M=a.verify)),c=d[this.c++],e=d[this.c++],(15&c)===kb)this.method=kb;else m(Error("unsupported compression method"));0!=((c<<8)+e)%31&&m(Error("invalid fcheck flag:"+((c<<8)+e)%31)),32&e&&m(Error("fdict flag is not supported")),this.A=new U(d,{index:this.c,bufferSize:a.bufferSize,bufferType:a.bufferType,resize:a.resize})}U.prototype.o=function(d,a){var c=this.a,e=this.b;this.u=d;for(var f,g,h,k,b=c.length-258;256!==(f=Ta(this,d));)if(256>f)e>=b&&(this.b=e,c=this.f(),e=this.b),c[e++]=f;else for(k=Wa[g=f-257],0<Ya[g]&&(k+=V(this,Ya[g])),f=Ta(this,a),h=$a[f],0<bb[f]&&(h+=V(this,bb[f])),e>=b&&(this.b=e,c=this.f(),e=this.b);k--;)c[e]=c[e++-h];for(;8<=this.e;)this.e-=8,this.c--;this.b=e},U.prototype.I=function(d,a){var c=this.a,e=this.b;this.u=d;for(var f,g,h,k,b=c.length;256!==(f=Ta(this,d));)if(256>f)e>=b&&(b=(c=this.f()).length),c[e++]=f;else for(k=Wa[g=f-257],0<Ya[g]&&(k+=V(this,Ya[g])),f=Ta(this,a),h=$a[f],0<bb[f]&&(h+=V(this,bb[f])),e+k>b&&(b=(c=this.f()).length);k--;)c[e]=c[e++-h];for(;8<=this.e;)this.e-=8,this.c--;this.b=e},U.prototype.f=function(){var c,e,d=new(G?Uint8Array:Array)(this.b-32768),a=this.b-32768,b=this.a;if(G)d.set(b.subarray(32768,d.length));else for(c=0,e=d.length;c<e;++c)d[c]=b[c+32768];if(this.l.push(d),this.q+=d.length,G)b.set(b.subarray(a,a+32768));else for(c=0;32768>c;++c)b[c]=b[a+c];return this.b=32768,b},U.prototype.J=function(d){var a,b,f,c=this.input.length/this.c+1|0,g=this.input,h=this.a;return d&&("number"==typeof d.v&&(c=d.v),"number"==typeof d.F&&(c+=d.F)),2>c?b=(f=(g.length-this.c)/this.u[2]/2*258|0)<h.length?h.length+f:h.length<<1:b=h.length*c,G?(a=new Uint8Array(b)).set(h):a=h,this.a=a},U.prototype.t=function(){var e,f,g,h,k,d=0,a=this.a,c=this.l,b=new(G?Uint8Array:Array)(this.q+(this.b-32768));if(0===c.length)return G?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);for(f=0,g=c.length;f<g;++f)for(h=0,k=(e=c[f]).length;h<k;++h)b[d++]=e[h];for(f=32768,g=this.b;f<g;++f)b[d++]=a[f];return this.l=[],this.buffer=b},U.prototype.H=function(){var d,a=this.b;return G?this.B?(d=new Uint8Array(a)).set(this.a.subarray(0,a)):d=this.a.subarray(0,a):(this.a.length>a&&(this.a.length=a),d=this.a),this.buffer=d},jb.prototype.p=function(){var a,d=this.input;return a=this.A.p(),this.c=this.A.c,this.M&&((d[this.c++]<<24|d[this.c++]<<16|d[this.c++]<<8|d[this.c++])>>>0!==ib(a)&&m(Error("invalid adler-32 checksum"))),a};var kb=8;function lb(d,a){this.input=d,this.a=new(G?Uint8Array:Array)(32768),this.h=X.k;var e,c={};for(e in!a&&(a={})||"number"!=typeof a.compressionType||(this.h=a.compressionType),a)c[e]=a[e];c.outputBuffer=this.a,this.z=new ka(this.input,c)}var X=oa;function mb(d,a){var c,e,b,f;if(Object.keys)c=Object.keys(a);else for(e in c=[],b=0,a)c[b++]=e;for(b=0,f=c.length;b<f;++b)A(d+"."+(e=c[b]),a[e])}lb.prototype.j=function(){var d,a,c,e,b,f,g,h=0;if(g=this.a,(d=kb)===kb)a=Math.LOG2E*Math.log(32768)-8;else m(Error("invalid compression method"));if(c=a<<4|d,g[h++]=c,d===kb)switch(this.h){case X.NONE:b=0;break;case X.r:b=1;break;case X.k:b=2;break;default:m(Error("unsupported compression type"))}else m(Error("invalid compression method"));return e=b<<6,g[h++]=e|31-(256*c+e)%31,f=ib(this.input),this.z.b=h,h=(g=this.z.j()).length,G&&((g=new Uint8Array(g.buffer)).length<=h+4&&(this.a=new Uint8Array(g.length+4),this.a.set(g),g=this.a),g=g.subarray(0,h+4)),g[h++]=f>>24&255,g[h++]=f>>16&255,g[h++]=f>>8&255,g[h++]=255&f,g},A("Zlib.Inflate",jb),A("Zlib.Inflate.prototype.decompress",jb.prototype.p),mb("Zlib.Inflate.BufferType",{ADAPTIVE:Ca.C,BLOCK:Ca.D}),A("Zlib.Deflate",lb),A("Zlib.Deflate.compress",function(d,a){return new lb(d,a).j()}),A("Zlib.Deflate.prototype.compress",lb.prototype.j),mb("Zlib.Deflate.CompressionType",{NONE:X.NONE,FIXED:X.r,DYNAMIC:X.k})}).call(self);var ARRAY_TYPE="undefined"!=typeof Float32Array?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var y=0,i=arguments.length;i--;)y+=arguments[i]*arguments[i];return Math.sqrt(y)});var out,sub=function(out,a,b){return out[0]=a[0]-b[0],out[1]=a[1]-b[1],out[2]=a[2]-b[2],out};function set(out,x,y){return out[0]=x,out[1]=y,out}out=new ARRAY_TYPE(3),ARRAY_TYPE!=Float32Array&&(out[0]=0,out[1]=0,out[2]=0),function(){var vec=function(){var out=new ARRAY_TYPE(2);return ARRAY_TYPE!=Float32Array&&(out[0]=0,out[1]=0),out}()}();var P0P1=[],P1P2=[],A$2=[],B=[],C=[],POSITIONS=[],terrainStructure_width=64,terrainStructure_height=64,terrainStructure_elementsPerHeight=3,terrainStructure_heightOffset=-1e3,terrainStructure_heightScale=.001,terrainStructure_elementMultiplier=256,terrainStructure_stride=4,terrainStructure_skirtHeight=.002;function lerp(p,q,time){return(1-time)*p+time*q}var textDecoder=new TextDecoder("utf-8");function zigZagDecode(value){return value>>1^-(1&value)}function generateTiandituTerrain(buffer,terrainWidth,tileSize){var fileData,dZlib=function(zBuffer){if(zBuffer.length<1e3)return null;var inflate=new self.Zlib.Inflate(zBuffer);return inflate?inflate.decompress():null}(new Uint8Array(buffer));if(!dZlib)throw new Error((fileData=new Uint8Array(buffer),textDecoder.decode(fileData)));var heightBuffer=function(zlibData){for(var i_height,NN,NN_R,dZlib=zlibData,myW=terrainStructure_width,myH=terrainStructure_height,myBuffer=new Uint8Array(myW*myH*terrainStructure_stride),jj=0;jj<myH;jj++)for(var ii=0;ii<myW;ii++){((i_height=dZlib[NN=2*(150*parseInt(149*jj/(myH-1))+parseInt(149*ii/(myW-1)))]+256*dZlib[NN+1])>1e4||i_height<-2e3)&&(i_height=0);var i_height_new=(i_height+1e3)/terrainStructure_heightScale,elementMultiplier=terrainStructure_elementMultiplier;myBuffer[NN_R=4*(jj*myW+ii)]=i_height_new/(elementMultiplier*elementMultiplier),myBuffer[NN_R+1]=(i_height_new-myBuffer[NN_R]*elementMultiplier*elementMultiplier)/elementMultiplier,myBuffer[NN_R+2]=i_height_new-myBuffer[NN_R]*elementMultiplier*elementMultiplier-myBuffer[NN_R+1]*elementMultiplier,myBuffer[NN_R+3]=255}return myBuffer}(dZlib),result=function(heightmap,terrainWidth){for(var width=terrainWidth,height=terrainWidth,endRow=width+1,endColum=height+1,elementsPerHeight=terrainStructure_elementsPerHeight,heightOffset=terrainStructure_heightOffset,heightScale=terrainStructure_heightScale,elementMultiplier=terrainStructure_elementMultiplier,skirtHeight=terrainStructure_skirtHeight,heights=new Float32Array(endRow*endColum),index=0,min=1/0,max=-1/0,i=0;i<endRow;i++)for(var row=i>=height?height-1:i,j=0;j<endColum;j++){for(var heightSample=0,terrainOffset=row*(4*width)+4*(j>=width?width-1:j),elementOffset=0;elementOffset<elementsPerHeight;elementOffset++)heightSample=heightSample*elementMultiplier+heightmap[terrainOffset+elementOffset];heightSample=1*(heightSample*heightScale+heightOffset),heightSample-=skirtHeight,heights[index]=heightSample,heightSample<min&&(min=heightSample),heightSample>max&&(max=heightSample),index++}return{data:heights,min:min,max:max,width:0,height:0,tileSize:0,image:null}}(heightBuffer,terrainWidth-1);return result.width=result.height=terrainWidth,result.tileSize=tileSize,createTerrainImage(result),result}class Triangle{constructor(positions,a,b,c,radius){this.p0=[],this.p1=[],this.p2=[],this.normal=[],this.min=[],this.max=[],this.set(positions,a,b,c,radius)}set(positions,a,b,c,radius){this.radius=radius;var x=3*a,y=3*a+1,z=3*a+2;this.p0[0]=positions[x]*radius,this.p0[1]=positions[y]*radius,this.p0[2]=positions[z],x=3*b,y=3*b+1,z=3*b+2,this.p1[0]=positions[x]*radius,this.p1[1]=positions[y]*radius,this.p1[2]=positions[z],x=3*c,y=3*c+1,z=3*c+2,this.p2[0]=positions[x]*radius,this.p2[1]=positions[y]*radius,this.p2[2]=positions[z],this.min[0]=Math.min(this.p0[0],this.p1[0],this.p2[0]),this.min[1]=Math.min(this.p0[1],this.p1[1],this.p2[1]),this.max[0]=Math.max(this.p0[0],this.p1[0],this.p2[0]),this.max[1]=Math.max(this.p0[1],this.p1[1],this.p2[1]);var p0p1=sub(P0P1,this.p1,this.p0),p1p2=sub(P1P2,this.p2,this.p1);this.normal=function(out,a){var x=a[0],y=a[1],z=a[2],len=x*x+y*y+z*z;return len>0&&(len=1/Math.sqrt(len)),out[0]=a[0]*len,out[1]=a[1]*len,out[2]=a[2]*len,out}(this.normal,function(out,a,b){var ax=a[0],ay=a[1],az=a[2],bx=b[0],by=b[1],bz=b[2];return out[0]=ay*bz-az*by,out[1]=az*bx-ax*bz,out[2]=ax*by-ay*bx,out}(this.normal,p0p1,p1p2))}contains(x,y){if(x<this.min[0]||x>this.max[0]||y<this.min[1]||y>this.max[1])return!1;set(A$2,this.p0[0],this.p0[1]),set(B,this.p1[0],this.p1[1]),set(C,this.p2[0],this.p2[1]);var SABC=calTriangleArae(A$2[0],A$2[1],B[0],B[1],C[0],C[1]);return calTriangleArae(x,y,A$2[0],A$2[1],C[0],C[1])+calTriangleArae(x,y,A$2[0],A$2[1],B[0],B[1])+calTriangleArae(x,y,B[0],B[1],C[0],C[1])-SABC<=1e-4}getHeight(x,y){var N=this.normal;return this.p0[2]-((x-this.p0[0])*N[0]+(y-this.p0[1])*N[1])/N[2]}}function calTriangleArae(x1,y1,x2,y2,x3,y3){return.5*Math.abs(x1*y2+x2*y3+x3*y1-x1*y3-x2*y1-x3*y2)}var preTriangle=null;function findInTriangle(triangles,x,y){if(preTriangle&&preTriangle.contains(x,y))return preTriangle.getHeight(x,y);for(var i=0;i<triangles.length;i++)if(triangles[i].contains(x,y))return preTriangle=triangles[i],triangles[i].getHeight(x,y);return 0}var TRIANGLES=[];function cesiumTerrainToHeights(buffer,terrainWidth,tileSize){for(var terrainData=function(buffer){var pos=0,cartesian3Elements=3,cartesian3Length=Float64Array.BYTES_PER_ELEMENT*cartesian3Elements,encodedVertexElements=3,encodedVertexLength=Uint16Array.BYTES_PER_ELEMENT*encodedVertexElements,triangleElements=3,bytesPerIndex=Uint16Array.BYTES_PER_ELEMENT,view=new DataView(buffer);pos+=cartesian3Length;var minimumHeight=view.getFloat32(pos,!0);pos+=Float32Array.BYTES_PER_ELEMENT;var maximumHeight=view.getFloat32(pos,!0);pos+=Float32Array.BYTES_PER_ELEMENT,pos+=cartesian3Length;var radius=view.getFloat64(pos,!0);pos+=Float64Array.BYTES_PER_ELEMENT,pos+=cartesian3Length;var vertexCount=view.getUint32(pos,!0);pos+=Uint32Array.BYTES_PER_ELEMENT;var encodedVertexBuffer=new Uint16Array(buffer,pos,3*vertexCount);pos+=vertexCount*encodedVertexLength,vertexCount>65536&&(bytesPerIndex=Uint32Array.BYTES_PER_ELEMENT);var uBuffer=encodedVertexBuffer.subarray(0,vertexCount),vBuffer=encodedVertexBuffer.subarray(vertexCount,2*vertexCount),heightBuffer=encodedVertexBuffer.subarray(2*vertexCount,3*vertexCount);(function(uBuffer,vBuffer,heightBuffer){for(var count=uBuffer.length,u=0,v=0,height=0,i=0;i<count;++i)u+=zigZagDecode(uBuffer[i]),v+=zigZagDecode(vBuffer[i]),uBuffer[i]=u,vBuffer[i]=v,heightBuffer&&(height+=zigZagDecode(heightBuffer[i]),heightBuffer[i]=height)})(uBuffer,vBuffer,heightBuffer),pos%bytesPerIndex!==0&&(pos+=bytesPerIndex-pos%bytesPerIndex);var triangleCount=view.getUint32(pos,!0);pos+=Uint32Array.BYTES_PER_ELEMENT;for(var indices=vertexCount>65536?new Uint32Array(buffer,pos,triangleCount*triangleElements):new Uint16Array(buffer,pos,triangleCount*triangleElements),highest=0,length=indices.length,i=0;i<length;++i){var code=indices[i];indices[i]=highest-code,0===code&&++highest}for(var quantizedVertices={minimumHeight:minimumHeight,maximumHeight:maximumHeight,quantizedVertices:encodedVertexBuffer,indices:indices}.quantizedVertices,quantizedVertexCount=quantizedVertices.length/3,uBuffer_1=quantizedVertices.subarray(0,quantizedVertexCount),vBuffer_1=quantizedVertices.subarray(quantizedVertexCount,2*quantizedVertexCount),heightBuffer_1=quantizedVertices.subarray(2*quantizedVertexCount,3*quantizedVertexCount),positions=POSITIONS,_i2=0;_i2<quantizedVertexCount;++_i2){var u=uBuffer_1[_i2]/32767,v=vBuffer_1[_i2]/32767,height=lerp(minimumHeight,maximumHeight,heightBuffer_1[_i2]/32767);positions[3*_i2]=u,positions[3*_i2+1]=1-v,positions[3*_i2+2]=height}return{positions:positions,radius:radius,min:minimumHeight,max:maximumHeight,indices:indices}}(buffer),{positions:positions,min:min,max:max,indices:indices,radius:radius}=terrainData,triangles=[],index=0,i=0;i<indices.length;i+=3){var triangle=TRIANGLES[index];triangle?triangle.set(positions,indices[i],indices[i+1],indices[i+2],2*radius):triangle=TRIANGLES[index]=new Triangle(positions,indices[i],indices[i+1],indices[i+2],2*radius),index++,triangles.push(triangle)}var heights=new Float32Array(terrainWidth*terrainWidth);index=0;for(var _i=0;_i<terrainWidth;_i++)for(var j=0;j<terrainWidth;j++)heights[index++]=findInTriangle(triangles,j/terrainWidth*radius*2,_i/terrainWidth*radius*2);var result={data:heights,min:min,max:max,width:terrainWidth,height:terrainWidth,tileSize:tileSize};return createTerrainImage(result),result}function createTerrainImage(terrainData){var canvas=getCanvas(),{width:width,height:height,data:data,tileSize:tileSize}=terrainData;if(width&&height&&data)try{resizeCanvas(canvas,width,height);for(var ctx=getCanvasContext(canvas),imageData=ctx.createImageData(width,height),out=[0,0,0],i=0,len=data.length;i<len;i++){var _height=data[i],[r,g,b]=encodeMapBox(_height,out),idx=4*i;imageData.data[idx]=r,imageData.data[idx+1]=g,imageData.data[idx+2]=b,imageData.data[idx+3]=255}ctx.putImageData(imageData,0,0);var image=canvas.transferToImageBitmap();resizeCanvas(canvas,tileSize,tileSize),(ctx=getCanvasContext(canvas)).drawImage(image,0,0,width,height,0,0,tileSize,tileSize),terrainData.image=canvas.transferToImageBitmap()}catch(error){console.log(error)}}var module,lerc={exports:{}};module=lerc,
/* Copyright 2015 Esri. Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0 @preserve */
function(){var CntZImage,uncompressPixelValues,formatFileInfo,computeUsedBitDepths,parse,unstuff,BitStuffer_unstuff,BitStuffer_unstuffLUT,BitStuffer_unstuff2,BitStuffer_unstuffLUT2,BitStuffer_originalUnstuff,BitStuffer_originalUnstuff2,Lerc2Helpers,TreeNode,LercDecode=(CntZImage={defaultNoDataValue:-34027999387901484e22,decode:function(input,options){var skipMask=(options=options||{}).encodedMaskData||null===options.encodedMaskData,parsedData=parse(input,options.inputOffset||0,skipMask),noDataValue=null!==options.noDataValue?options.noDataValue:CntZImage.defaultNoDataValue,uncompressedData=uncompressPixelValues(parsedData,options.pixelType||Float32Array,options.encodedMaskData,noDataValue,options.returnMask),result={width:parsedData.width,height:parsedData.height,pixelData:uncompressedData.resultPixels,minValue:uncompressedData.minValue,maxValue:parsedData.pixels.maxValue,noDataValue:noDataValue};return uncompressedData.resultMask&&(result.maskData=uncompressedData.resultMask),options.returnEncodedMask&&parsedData.mask&&(result.encodedMaskData=parsedData.mask.bitset?parsedData.mask.bitset:null),options.returnFileInfo&&(result.fileInfo=formatFileInfo(parsedData),options.computeUsedBitDepths&&(result.fileInfo.bitDepths=computeUsedBitDepths(parsedData))),result}},uncompressPixelValues=function(data,TypedArrayClass,maskBitset,noDataValue,storeDecodedMask){var currentValue,resultPixels,resultMask,blockIdx=0,numX=data.pixels.numBlocksX,numY=data.pixels.numBlocksY,blockWidth=Math.floor(data.width/numX),blockHeight=Math.floor(data.height/numY),scale=2*data.maxZError,minValue=Number.MAX_VALUE;maskBitset=maskBitset||(data.mask?data.mask.bitset:null),resultPixels=new TypedArrayClass(data.width*data.height),storeDecodedMask&&maskBitset&&(resultMask=new Uint8Array(data.width*data.height));for(var xx,yy,blockDataBuffer=new Float32Array(blockWidth*blockHeight),y=0;y<=numY;y++){var thisBlockHeight=y!==numY?blockHeight:data.height%numY;if(0!==thisBlockHeight)for(var x=0;x<=numX;x++){var thisBlockWidth=x!==numX?blockWidth:data.width%numX;if(0!==thisBlockWidth){var blockData,blockPtr,constValue,maskByte,outPtr=y*data.width*blockHeight+x*blockWidth,outStride=data.width-thisBlockWidth,block=data.pixels.blocks[blockIdx];if(block.encoding<2?(0===block.encoding?blockData=block.rawData:(unstuff(block.stuffedData,block.bitsPerPixel,block.numValidPixels,block.offset,scale,blockDataBuffer,data.pixels.maxValue),blockData=blockDataBuffer),blockPtr=0):constValue=2===block.encoding?0:block.offset,maskBitset)for(yy=0;yy<thisBlockHeight;yy++){for(7&outPtr&&(maskByte=maskBitset[outPtr>>3],maskByte<<=7&outPtr),xx=0;xx<thisBlockWidth;xx++)7&outPtr||(maskByte=maskBitset[outPtr>>3]),128&maskByte?(resultMask&&(resultMask[outPtr]=1),minValue=minValue>(currentValue=block.encoding<2?blockData[blockPtr++]:constValue)?currentValue:minValue,resultPixels[outPtr++]=currentValue):(resultMask&&(resultMask[outPtr]=0),resultPixels[outPtr++]=noDataValue),maskByte<<=1;outPtr+=outStride}else if(block.encoding<2)for(yy=0;yy<thisBlockHeight;yy++){for(xx=0;xx<thisBlockWidth;xx++)minValue=minValue>(currentValue=blockData[blockPtr++])?currentValue:minValue,resultPixels[outPtr++]=currentValue;outPtr+=outStride}else for(minValue=minValue>constValue?constValue:minValue,yy=0;yy<thisBlockHeight;yy++){for(xx=0;xx<thisBlockWidth;xx++)resultPixels[outPtr++]=constValue;outPtr+=outStride}if(1===block.encoding&&blockPtr!==block.numValidPixels)throw"Block and Mask do not match";blockIdx++}}}return{resultPixels:resultPixels,resultMask:resultMask,minValue:minValue}},formatFileInfo=function(data){return{fileIdentifierString:data.fileIdentifierString,fileVersion:data.fileVersion,imageType:data.imageType,height:data.height,width:data.width,maxZError:data.maxZError,eofOffset:data.eofOffset,mask:data.mask?{numBlocksX:data.mask.numBlocksX,numBlocksY:data.mask.numBlocksY,numBytes:data.mask.numBytes,maxValue:data.mask.maxValue}:null,pixels:{numBlocksX:data.pixels.numBlocksX,numBlocksY:data.pixels.numBlocksY,numBytes:data.pixels.numBytes,maxValue:data.pixels.maxValue,noDataValue:data.noDataValue}}},computeUsedBitDepths=function(data){for(var numBlocks=data.pixels.numBlocksX*data.pixels.numBlocksY,bitDepths={},i=0;i<numBlocks;i++){var block=data.pixels.blocks[i];0===block.encoding?bitDepths.float32=!0:1===block.encoding?bitDepths[block.bitsPerPixel]=!0:bitDepths[0]=!0}return Object.keys(bitDepths)},parse=function(input,fp,skipMask){var data={},fileIdView=new Uint8Array(input,fp,10);if(data.fileIdentifierString=String.fromCharCode.apply(null,fileIdView),"CntZImage"!==data.fileIdentifierString.trim())throw"Unexpected file identifier string: "+data.fileIdentifierString;fp+=10;var view=new DataView(input,fp,24);if(data.fileVersion=view.getInt32(0,!0),data.imageType=view.getInt32(4,!0),data.height=view.getUint32(8,!0),data.width=view.getUint32(12,!0),data.maxZError=view.getFloat64(16,!0),fp+=24,!skipMask)if(view=new DataView(input,fp,16),data.mask={},data.mask.numBlocksY=view.getUint32(0,!0),data.mask.numBlocksX=view.getUint32(4,!0),data.mask.numBytes=view.getUint32(8,!0),data.mask.maxValue=view.getFloat32(12,!0),fp+=16,data.mask.numBytes>0){var bitset=new Uint8Array(Math.ceil(data.width*data.height/8)),cnt=(view=new DataView(input,fp,data.mask.numBytes)).getInt16(0,!0),ip=2,op=0;do{if(cnt>0)for(;cnt--;)bitset[op++]=view.getUint8(ip++);else{var val=view.getUint8(ip++);for(cnt=-cnt;cnt--;)bitset[op++]=val}cnt=view.getInt16(ip,!0),ip+=2}while(ip<data.mask.numBytes);if(-32768!==cnt||op<bitset.length)throw"Unexpected end of mask RLE encoding";data.mask.bitset=bitset,fp+=data.mask.numBytes}else 0===(data.mask.numBytes|data.mask.numBlocksY|data.mask.maxValue)&&(data.mask.bitset=new Uint8Array(Math.ceil(data.width*data.height/8)));view=new DataView(input,fp,16),data.pixels={},data.pixels.numBlocksY=view.getUint32(0,!0),data.pixels.numBlocksX=view.getUint32(4,!0),data.pixels.numBytes=view.getUint32(8,!0),data.pixels.maxValue=view.getFloat32(12,!0),fp+=16;var numBlocksX=data.pixels.numBlocksX,numBlocksY=data.pixels.numBlocksY,actualNumBlocksX=numBlocksX+(data.width%numBlocksX>0?1:0),actualNumBlocksY=numBlocksY+(data.height%numBlocksY>0?1:0);data.pixels.blocks=new Array(actualNumBlocksX*actualNumBlocksY);for(var blockI=0,blockY=0;blockY<actualNumBlocksY;blockY++)for(var blockX=0;blockX<actualNumBlocksX;blockX++){var size=0,bytesLeft=input.byteLength-fp;view=new DataView(input,fp,Math.min(10,bytesLeft));var block={};data.pixels.blocks[blockI++]=block;var headerByte=view.getUint8(0);if(size++,block.encoding=63&headerByte,block.encoding>3)throw"Invalid block encoding ("+block.encoding+")";if(2!==block.encoding){if(0!==headerByte&&2!==headerByte){if(headerByte>>=6,block.offsetType=headerByte,2===headerByte)block.offset=view.getInt8(1),size++;else if(1===headerByte)block.offset=view.getInt16(1,!0),size+=2;else{if(0!==headerByte)throw"Invalid block offset type";block.offset=view.getFloat32(1,!0),size+=4}if(1===block.encoding)if(headerByte=view.getUint8(size),size++,block.bitsPerPixel=63&headerByte,headerByte>>=6,block.numValidPixelsType=headerByte,2===headerByte)block.numValidPixels=view.getUint8(size),size++;else if(1===headerByte)block.numValidPixels=view.getUint16(size,!0),size+=2;else{if(0!==headerByte)throw"Invalid valid pixel count type";block.numValidPixels=view.getUint32(size,!0),size+=4}}var arrayBuf;if(fp+=size,3!==block.encoding)if(0===block.encoding){var numPixels=(data.pixels.numBytes-1)/4;if(numPixels!==Math.floor(numPixels))throw"uncompressed block has invalid length";arrayBuf=new ArrayBuffer(4*numPixels),new Uint8Array(arrayBuf).set(new Uint8Array(input,fp,4*numPixels));var rawData=new Float32Array(arrayBuf);block.rawData=rawData,fp+=4*numPixels}else if(1===block.encoding){var dataBytes=Math.ceil(block.numValidPixels*block.bitsPerPixel/8),dataWords=Math.ceil(dataBytes/4);arrayBuf=new ArrayBuffer(4*dataWords),new Uint8Array(arrayBuf).set(new Uint8Array(input,fp,dataBytes)),block.stuffedData=new Uint32Array(arrayBuf),fp+=dataBytes}}else fp++}return data.eofOffset=fp,data},unstuff=function(src,bitsPerPixel,numPixels,offset,scale,dest,maxValue){var o,n,buffer,bitMask=(1<<bitsPerPixel)-1,i=0,bitsLeft=0,nmax=Math.ceil((maxValue-offset)/scale),numInvalidTailBytes=4*src.length-Math.ceil(bitsPerPixel*numPixels/8);for(src[src.length-1]<<=8*numInvalidTailBytes,o=0;o<numPixels;o++){if(0===bitsLeft&&(buffer=src[i++],bitsLeft=32),bitsLeft>=bitsPerPixel)n=buffer>>>bitsLeft-bitsPerPixel&bitMask,bitsLeft-=bitsPerPixel;else{var missingBits=bitsPerPixel-bitsLeft;n=(buffer&bitMask)<<missingBits&bitMask,n+=(buffer=src[i++])>>>(bitsLeft=32-missingBits)}dest[o]=n<nmax?offset+n*scale:maxValue}return dest},CntZImage),Lerc2Decode=(BitStuffer_unstuff=function(src,dest,bitsPerPixel,numPixels,lutArr,offset,scale,maxValue){var o,n,buffer,missingBits,nmax,bitMask=(1<<bitsPerPixel)-1,i=0,bitsLeft=0,numInvalidTailBytes=4*src.length-Math.ceil(bitsPerPixel*numPixels/8);if(src[src.length-1]<<=8*numInvalidTailBytes,lutArr)for(o=0;o<numPixels;o++)0===bitsLeft&&(buffer=src[i++],bitsLeft=32),bitsLeft>=bitsPerPixel?(n=buffer>>>bitsLeft-bitsPerPixel&bitMask,bitsLeft-=bitsPerPixel):(n=(buffer&bitMask)<<(missingBits=bitsPerPixel-bitsLeft)&bitMask,n+=(buffer=src[i++])>>>(bitsLeft=32-missingBits)),dest[o]=lutArr[n];else for(nmax=Math.ceil((maxValue-offset)/scale),o=0;o<numPixels;o++)0===bitsLeft&&(buffer=src[i++],bitsLeft=32),bitsLeft>=bitsPerPixel?(n=buffer>>>bitsLeft-bitsPerPixel&bitMask,bitsLeft-=bitsPerPixel):(n=(buffer&bitMask)<<(missingBits=bitsPerPixel-bitsLeft)&bitMask,n+=(buffer=src[i++])>>>(bitsLeft=32-missingBits)),dest[o]=n<nmax?offset+n*scale:maxValue},BitStuffer_unstuffLUT=function(src,bitsPerPixel,numPixels,offset,scale,maxValue){var buffer,bitMask=(1<<bitsPerPixel)-1,i=0,o=0,missingBits=0,bitsLeft=0,n=0,dest=[],numInvalidTailBytes=4*src.length-Math.ceil(bitsPerPixel*numPixels/8);src[src.length-1]<<=8*numInvalidTailBytes;var nmax=Math.ceil((maxValue-offset)/scale);for(o=0;o<numPixels;o++)0===bitsLeft&&(buffer=src[i++],bitsLeft=32),bitsLeft>=bitsPerPixel?(n=buffer>>>bitsLeft-bitsPerPixel&bitMask,bitsLeft-=bitsPerPixel):(n=(buffer&bitMask)<<(missingBits=bitsPerPixel-bitsLeft)&bitMask,n+=(buffer=src[i++])>>>(bitsLeft=32-missingBits)),dest[o]=n<nmax?offset+n*scale:maxValue;return dest.unshift(offset),dest},BitStuffer_unstuff2=function(src,dest,bitsPerPixel,numPixels,lutArr,offset,scale,maxValue){var o,n,buffer,missingBits,bitMask=(1<<bitsPerPixel)-1,i=0,bitsLeft=0,bitPos=0;if(lutArr)for(o=0;o<numPixels;o++)0===bitsLeft&&(buffer=src[i++],bitsLeft=32,bitPos=0),bitsLeft>=bitsPerPixel?(n=buffer>>>bitPos&bitMask,bitsLeft-=bitsPerPixel,bitPos+=bitsPerPixel):(n=buffer>>>bitPos&bitMask,bitsLeft=32-(missingBits=bitsPerPixel-bitsLeft),n|=((buffer=src[i++])&(1<<missingBits)-1)<<bitsPerPixel-missingBits,bitPos=missingBits),dest[o]=lutArr[n];else{var nmax=Math.ceil((maxValue-offset)/scale);for(o=0;o<numPixels;o++)0===bitsLeft&&(buffer=src[i++],bitsLeft=32,bitPos=0),bitsLeft>=bitsPerPixel?(n=buffer>>>bitPos&bitMask,bitsLeft-=bitsPerPixel,bitPos+=bitsPerPixel):(n=buffer>>>bitPos&bitMask,bitsLeft=32-(missingBits=bitsPerPixel-bitsLeft),n|=((buffer=src[i++])&(1<<missingBits)-1)<<bitsPerPixel-missingBits,bitPos=missingBits),dest[o]=n<nmax?offset+n*scale:maxValue}return dest},BitStuffer_unstuffLUT2=function(src,bitsPerPixel,numPixels,offset,scale,maxValue){var buffer,bitMask=(1<<bitsPerPixel)-1,i=0,o=0,missingBits=0,bitsLeft=0,n=0,bitPos=0,dest=[],nmax=Math.ceil((maxValue-offset)/scale);for(o=0;o<numPixels;o++)0===bitsLeft&&(buffer=src[i++],bitsLeft=32,bitPos=0),bitsLeft>=bitsPerPixel?(n=buffer>>>bitPos&bitMask,bitsLeft-=bitsPerPixel,bitPos+=bitsPerPixel):(n=buffer>>>bitPos&bitMask,bitsLeft=32-(missingBits=bitsPerPixel-bitsLeft),n|=((buffer=src[i++])&(1<<missingBits)-1)<<bitsPerPixel-missingBits,bitPos=missingBits),dest[o]=n<nmax?offset+n*scale:maxValue;return dest.unshift(offset),dest},BitStuffer_originalUnstuff=function(src,dest,bitsPerPixel,numPixels){var o,n,buffer,missingBits,bitMask=(1<<bitsPerPixel)-1,i=0,bitsLeft=0,numInvalidTailBytes=4*src.length-Math.ceil(bitsPerPixel*numPixels/8);for(src[src.length-1]<<=8*numInvalidTailBytes,o=0;o<numPixels;o++)0===bitsLeft&&(buffer=src[i++],bitsLeft=32),bitsLeft>=bitsPerPixel?(n=buffer>>>bitsLeft-bitsPerPixel&bitMask,bitsLeft-=bitsPerPixel):(n=(buffer&bitMask)<<(missingBits=bitsPerPixel-bitsLeft)&bitMask,n+=(buffer=src[i++])>>>(bitsLeft=32-missingBits)),dest[o]=n;return dest},BitStuffer_originalUnstuff2=function(src,dest,bitsPerPixel,numPixels){var o,n,buffer,missingBits,bitMask=(1<<bitsPerPixel)-1,i=0,bitsLeft=0,bitPos=0;for(o=0;o<numPixels;o++)0===bitsLeft&&(buffer=src[i++],bitsLeft=32,bitPos=0),bitsLeft>=bitsPerPixel?(n=buffer>>>bitPos&bitMask,bitsLeft-=bitsPerPixel,bitPos+=bitsPerPixel):(n=buffer>>>bitPos&bitMask,bitsLeft=32-(missingBits=bitsPerPixel-bitsLeft),n|=((buffer=src[i++])&(1<<missingBits)-1)<<bitsPerPixel-missingBits,bitPos=missingBits),dest[o]=n;return dest},Lerc2Helpers={HUFFMAN_LUT_BITS_MAX:12,computeChecksumFletcher32:function(input){for(var sum1=65535,sum2=65535,len=input.length,words=Math.floor(len/2),i=0;words;){var tlen=words>=359?359:words;words-=tlen;do{sum1+=input[i++]<<8,sum2+=sum1+=input[i++]}while(--tlen);sum1=(65535&sum1)+(sum1>>>16),sum2=(65535&sum2)+(sum2>>>16)}return 1&len&&(sum2+=sum1+=input[i]<<8),((sum2=(65535&sum2)+(sum2>>>16))<<16|(sum1=(65535&sum1)+(sum1>>>16)))>>>0},readHeaderInfo:function(input,data){var ptr=data.ptr,fileIdView=new Uint8Array(input,ptr,6),headerInfo={};if(headerInfo.fileIdentifierString=String.fromCharCode.apply(null,fileIdView),0!==headerInfo.fileIdentifierString.lastIndexOf("Lerc2",0))throw"Unexpected file identifier string (expect Lerc2 ): "+headerInfo.fileIdentifierString;ptr+=6;var view=new DataView(input,ptr,52);if(headerInfo.fileVersion=view.getInt32(0,!0),ptr+=4,headerInfo.fileVersion>=3&&(headerInfo.checksum=view.getUint32(4,!0),ptr+=4),view=new DataView(input,ptr,48),headerInfo.height=view.getUint32(0,!0),headerInfo.width=view.getUint32(4,!0),headerInfo.numValidPixel=view.getUint32(8,!0),headerInfo.microBlockSize=view.getInt32(12,!0),headerInfo.blobSize=view.getInt32(16,!0),headerInfo.imageType=view.getInt32(20,!0),headerInfo.maxZError=view.getFloat64(24,!0),headerInfo.zMin=view.getFloat64(32,!0),headerInfo.zMax=view.getFloat64(40,!0),ptr+=48,data.headerInfo=headerInfo,data.ptr=ptr,headerInfo.fileVersion>=3&&this.computeChecksumFletcher32(new Uint8Array(input,ptr-48,headerInfo.blobSize-14))!==headerInfo.checksum)throw"Checksum failed.";return!0},readMask:function(input,data){var bitset,resultMask,ptr=data.ptr,headerInfo=data.headerInfo,numPixels=headerInfo.width*headerInfo.height,numValidPixel=headerInfo.numValidPixel,view=new DataView(input,ptr,4),mask={};if(mask.numBytes=view.getUint32(0,!0),ptr+=4,(0===numValidPixel||numPixels===numValidPixel)&&0!==mask.numBytes)throw"invalid mask";if(0===numValidPixel)bitset=new Uint8Array(Math.ceil(numPixels/8)),mask.bitset=bitset,resultMask=new Uint8Array(numPixels),data.pixels.resultMask=resultMask,ptr+=mask.numBytes;else if(mask.numBytes>0){bitset=new Uint8Array(Math.ceil(numPixels/8));var cnt=(view=new DataView(input,ptr,mask.numBytes)).getInt16(0,!0),ip=2,op=0,val=0;do{if(cnt>0)for(;cnt--;)bitset[op++]=view.getUint8(ip++);else for(val=view.getUint8(ip++),cnt=-cnt;cnt--;)bitset[op++]=val;cnt=view.getInt16(ip,!0),ip+=2}while(ip<mask.numBytes);if(-32768!==cnt||op<bitset.length)throw"Unexpected end of mask RLE encoding";resultMask=new Uint8Array(numPixels);var mb=0,k=0;for(k=0;k<numPixels;k++)7&k?(mb=bitset[k>>3],mb<<=7&k):mb=bitset[k>>3],128&mb&&(resultMask[k]=1);data.pixels.resultMask=resultMask,mask.bitset=bitset,ptr+=mask.numBytes}return data.ptr=ptr,data.mask=mask,!0},readDataOneSweep:function(input,data,OutPixelTypeArray){var rawData,ptr=data.ptr,headerInfo=data.headerInfo,numPixels=headerInfo.width*headerInfo.height,imageType=headerInfo.imageType,numBytes=headerInfo.numValidPixel*Lerc2Helpers.getDateTypeSize(imageType);if(OutPixelTypeArray===Uint8Array)rawData=new Uint8Array(input,ptr,numBytes);else{var arrayBuf=new ArrayBuffer(numBytes);new Uint8Array(arrayBuf).set(new Uint8Array(input,ptr,numBytes)),rawData=new OutPixelTypeArray(arrayBuf)}if(rawData.length===numPixels)data.pixels.resultPixels=rawData;else{data.pixels.resultPixels=new OutPixelTypeArray(numPixels);var z=0,k=0;for(k=0;k<numPixels;k++)data.pixels.resultMask[k]&&(data.pixels.resultPixels[k]=rawData[z++])}return ptr+=numBytes,data.ptr=ptr,!0},readHuffman:function(input,data,OutPixelTypeArray){var headerInfo=data.headerInfo,numPixels=headerInfo.width*headerInfo.height,BITS_MAX=this.HUFFMAN_LUT_BITS_MAX,view=new DataView(input,data.ptr,16);if(data.ptr+=16,view.getInt32(0,!0)<2)throw"unsupported Huffman version";var size=view.getInt32(4,!0),i0=view.getInt32(8,!0),i1=view.getInt32(12,!0);if(i0>=i1)return!1;var blockDataBuffer=new Uint32Array(i1-i0);Lerc2Helpers.decodeBits(input,data,blockDataBuffer);var i,j,k,len,codeTable=[];for(i=i0;i<i1;i++)codeTable[j=i-(i<size?0:size)]={first:blockDataBuffer[i-i0],second:null};var dataBytes=input.byteLength-data.ptr,dataWords=Math.ceil(dataBytes/4),arrayBuf=new ArrayBuffer(4*dataWords);new Uint8Array(arrayBuf).set(new Uint8Array(input,data.ptr,dataBytes));var word,stuffedData=new Uint32Array(arrayBuf),bitPos=0,srcPtr=0;for(word=stuffedData[0],i=i0;i<i1;i++)(len=codeTable[j=i-(i<size?0:size)].first)>0&&(codeTable[j].second=word<<bitPos>>>32-len,32-bitPos>=len?32===(bitPos+=len)&&(bitPos=0,word=stuffedData[++srcPtr]):(bitPos+=len-32,word=stuffedData[++srcPtr],codeTable[j].second|=word>>>32-bitPos));var offset=0===data.headerInfo.imageType?128:0,height=data.headerInfo.height,width=data.headerInfo.width,numBitsLUT=0,numBitsLUTQick=0,tree=new TreeNode;for(i=0;i<codeTable.length;i++)void 0!==codeTable[i]&&(numBitsLUT=Math.max(numBitsLUT,codeTable[i].first));numBitsLUTQick=numBitsLUT>=BITS_MAX?BITS_MAX:numBitsLUT,numBitsLUT>=30&&console.log("WARning, large NUM LUT BITS IS "+numBitsLUT);var entry,code,numEntries,jj,node,decodeLut=[];for(i=i0;i<i1;i++)if((len=codeTable[j=i-(i<size?0:size)].first)>0)if(entry=[len,j],len<=numBitsLUTQick)for(code=codeTable[j].second<<numBitsLUTQick-len,numEntries=1<<numBitsLUTQick-len,k=0;k<numEntries;k++)decodeLut[code|k]=entry;else for(code=codeTable[j].second,node=tree,jj=len-1;jj>=0;jj--)code>>>jj&1?(node.right||(node.right=new TreeNode),node=node.right):(node.left||(node.left=new TreeNode),node=node.left),0!==jj||node.val||(node.val=entry[1]);var val,delta,valTmp,valTmpQuick,mask=data.pixels.resultMask,prevVal=0,ii=0;bitPos>0&&(srcPtr++,bitPos=0),word=stuffedData[srcPtr];var resultPixels=new OutPixelTypeArray(numPixels);if(data.headerInfo.numValidPixel===width*height)for(k=0,i=0;i<height;i++)for(j=0;j<width;j++,k++){if(val=0,valTmpQuick=valTmp=word<<bitPos>>>32-numBitsLUTQick,32-bitPos<numBitsLUTQick&&(valTmpQuick=valTmp|=stuffedData[srcPtr+1]>>>64-bitPos-numBitsLUTQick),decodeLut[valTmpQuick])val=decodeLut[valTmpQuick][1],bitPos+=decodeLut[valTmpQuick][0];else for(valTmpQuick=valTmp=word<<bitPos>>>32-numBitsLUT,32-bitPos<numBitsLUT&&(valTmpQuick=valTmp|=stuffedData[srcPtr+1]>>>64-bitPos-numBitsLUT),node=tree,ii=0;ii<numBitsLUT;ii++)if(!(node=valTmp>>>numBitsLUT-ii-1&1?node.right:node.left).left&&!node.right){val=node.val,bitPos=bitPos+ii+1;break}bitPos>=32&&(bitPos-=32,word=stuffedData[++srcPtr]),delta=val-offset,delta+=j>0?prevVal:i>0?resultPixels[k-width]:prevVal,delta&=255,resultPixels[k]=delta,prevVal=delta}else for(k=0,i=0;i<height;i++)for(j=0;j<width;j++,k++)if(mask[k]){if(val=0,valTmpQuick=valTmp=word<<bitPos>>>32-numBitsLUTQick,32-bitPos<numBitsLUTQick&&(valTmpQuick=valTmp|=stuffedData[srcPtr+1]>>>64-bitPos-numBitsLUTQick),decodeLut[valTmpQuick])val=decodeLut[valTmpQuick][1],bitPos+=decodeLut[valTmpQuick][0];else for(valTmpQuick=valTmp=word<<bitPos>>>32-numBitsLUT,32-bitPos<numBitsLUT&&(valTmpQuick=valTmp|=stuffedData[srcPtr+1]>>>64-bitPos-numBitsLUT),node=tree,ii=0;ii<numBitsLUT;ii++)if(!(node=valTmp>>>numBitsLUT-ii-1&1?node.right:node.left).left&&!node.right){val=node.val,bitPos=bitPos+ii+1;break}bitPos>=32&&(bitPos-=32,word=stuffedData[++srcPtr]),delta=val-offset,j>0&&mask[k-1]?delta+=prevVal:i>0&&mask[k-width]?delta+=resultPixels[k-width]:delta+=prevVal,delta&=255,resultPixels[k]=delta,prevVal=delta}data.pixels.resultPixels=resultPixels,data.ptr=data.ptr+4*(srcPtr+1)+(bitPos>0?4:0)},decodeBits:function(input,data,blockDataBuffer,offset){var fileVersion=data.headerInfo.fileVersion,blockPtr=0,view=new DataView(input,data.ptr,5),headerByte=view.getUint8(0);blockPtr++;var bits67=headerByte>>6,n=0===bits67?4:3-bits67,doLut=(32&headerByte)>0,numBits=31&headerByte,numElements=0;if(1===n)numElements=view.getUint8(blockPtr),blockPtr++;else if(2===n)numElements=view.getUint16(blockPtr,!0),blockPtr+=2;else{if(4!==n)throw"Invalid valid pixel count type";numElements=view.getUint32(blockPtr,!0),blockPtr+=4}var stuffedData,arrayBuf,store8,dataBytes,dataWords,lutArr,lutData,lutBytes,bitsPerPixel,scale=2*data.headerInfo.maxZError;if(doLut){for(data.counter.lut++,lutBytes=view.getUint8(blockPtr),blockPtr++,dataBytes=Math.ceil((lutBytes-1)*numBits/8),dataWords=Math.ceil(dataBytes/4),arrayBuf=new ArrayBuffer(4*dataWords),store8=new Uint8Array(arrayBuf),data.ptr+=blockPtr,store8.set(new Uint8Array(input,data.ptr,dataBytes)),lutData=new Uint32Array(arrayBuf),data.ptr+=dataBytes,bitsPerPixel=0;lutBytes-1>>>bitsPerPixel;)bitsPerPixel++;dataBytes=Math.ceil(numElements*bitsPerPixel/8),dataWords=Math.ceil(dataBytes/4),arrayBuf=new ArrayBuffer(4*dataWords),(store8=new Uint8Array(arrayBuf)).set(new Uint8Array(input,data.ptr,dataBytes)),stuffedData=new Uint32Array(arrayBuf),data.ptr+=dataBytes,lutArr=fileVersion>=3?BitStuffer_unstuffLUT2(lutData,numBits,lutBytes-1,offset,scale,data.headerInfo.zMax):BitStuffer_unstuffLUT(lutData,numBits,lutBytes-1,offset,scale,data.headerInfo.zMax),fileVersion>=3?BitStuffer_unstuff2(stuffedData,blockDataBuffer,bitsPerPixel,numElements,lutArr):BitStuffer_unstuff(stuffedData,blockDataBuffer,bitsPerPixel,numElements,lutArr)}else data.counter.bitstuffer++,bitsPerPixel=numBits,data.ptr+=blockPtr,bitsPerPixel>0&&(dataBytes=Math.ceil(numElements*bitsPerPixel/8),dataWords=Math.ceil(dataBytes/4),arrayBuf=new ArrayBuffer(4*dataWords),(store8=new Uint8Array(arrayBuf)).set(new Uint8Array(input,data.ptr,dataBytes)),stuffedData=new Uint32Array(arrayBuf),data.ptr+=dataBytes,fileVersion>=3?null==offset?BitStuffer_originalUnstuff2(stuffedData,blockDataBuffer,bitsPerPixel,numElements):BitStuffer_unstuff2(stuffedData,blockDataBuffer,bitsPerPixel,numElements,!1,offset,scale,data.headerInfo.zMax):null==offset?BitStuffer_originalUnstuff(stuffedData,blockDataBuffer,bitsPerPixel,numElements):BitStuffer_unstuff(stuffedData,blockDataBuffer,bitsPerPixel,numElements,!1,offset,scale,data.headerInfo.zMax))},readTiles:function(input,data,OutPixelTypeArray){var headerInfo=data.headerInfo,width=headerInfo.width,height=headerInfo.height,microBlockSize=headerInfo.microBlockSize,imageType=headerInfo.imageType,numBlocksX=Math.ceil(width/microBlockSize),numBlocksY=Math.ceil(height/microBlockSize);data.pixels.numBlocksY=numBlocksY,data.pixels.numBlocksX=numBlocksX,data.pixels.ptr=0;var view,block,arrayBuf,rawData,blockEncoding,offsetType,offset,row=0,col=0,blockY=0,blockX=0,thisBlockHeight=0,thisBlockWidth=0,bytesLeft=0,headerByte=0,bits67=0,outPtr=0,outStride=0,numBytes=0,bytesleft=0,z=0,blockPtr=0,blockDataBuffer=new OutPixelTypeArray(microBlockSize*microBlockSize),lastBlockHeight=height%microBlockSize||microBlockSize,lastBlockWidth=width%microBlockSize||microBlockSize;for(blockY=0;blockY<numBlocksY;blockY++)for(thisBlockHeight=blockY!==numBlocksY-1?microBlockSize:lastBlockHeight,blockX=0;blockX<numBlocksX;blockX++){if(outPtr=blockY*width*microBlockSize+blockX*microBlockSize,outStride=width-(thisBlockWidth=blockX!==numBlocksX-1?microBlockSize:lastBlockWidth),bytesLeft=input.byteLength-data.ptr,block={},blockPtr=0,blockPtr++,bits67=(headerByte=(view=new DataView(input,data.ptr,Math.min(10,bytesLeft))).getUint8(0))>>6&255,(headerByte>>2&15)!=(blockX*microBlockSize>>3&15))throw"integrity issue";if((blockEncoding=3&headerByte)>3)throw data.ptr+=blockPtr,"Invalid block encoding ("+blockEncoding+")";if(2!==blockEncoding)if(0===blockEncoding){if(data.counter.uncompressed++,data.ptr+=blockPtr,numBytes=(numBytes=thisBlockHeight*thisBlockWidth*Lerc2Helpers.getDateTypeSize(imageType))<(bytesleft=input.byteLength-data.ptr)?numBytes:bytesleft,arrayBuf=new ArrayBuffer(numBytes),new Uint8Array(arrayBuf).set(new Uint8Array(input,data.ptr,numBytes)),rawData=new OutPixelTypeArray(arrayBuf),z=0,data.pixels.resultMask)for(row=0;row<thisBlockHeight;row++){for(col=0;col<thisBlockWidth;col++)data.pixels.resultMask[outPtr]&&(data.pixels.resultPixels[outPtr]=rawData[z++]),outPtr++;outPtr+=outStride}else for(row=0;row<thisBlockHeight;row++){for(col=0;col<thisBlockWidth;col++)data.pixels.resultPixels[outPtr++]=rawData[z++];outPtr+=outStride}data.ptr+=z*Lerc2Helpers.getDateTypeSize(imageType)}else if(offsetType=Lerc2Helpers.getDataTypeUsed(imageType,bits67),offset=Lerc2Helpers.getOnePixel(block,blockPtr,offsetType,view),blockPtr+=Lerc2Helpers.getDateTypeSize(offsetType),3===blockEncoding)if(data.ptr+=blockPtr,data.counter.constantoffset++,data.pixels.resultMask)for(row=0;row<thisBlockHeight;row++){for(col=0;col<thisBlockWidth;col++)data.pixels.resultMask[outPtr]&&(data.pixels.resultPixels[outPtr]=offset),outPtr++;outPtr+=outStride}else for(row=0;row<thisBlockHeight;row++){for(col=0;col<thisBlockWidth;col++)data.pixels.resultPixels[outPtr++]=offset;outPtr+=outStride}else if(data.ptr+=blockPtr,Lerc2Helpers.decodeBits(input,data,blockDataBuffer,offset),blockPtr=0,data.pixels.resultMask)for(row=0;row<thisBlockHeight;row++){for(col=0;col<thisBlockWidth;col++)data.pixels.resultMask[outPtr]&&(data.pixels.resultPixels[outPtr]=blockDataBuffer[blockPtr++]),outPtr++;outPtr+=outStride}else for(row=0;row<thisBlockHeight;row++){for(col=0;col<thisBlockWidth;col++)data.pixels.resultPixels[outPtr++]=blockDataBuffer[blockPtr++];outPtr+=outStride}else data.counter.constant++,data.ptr+=blockPtr}},formatFileInfo:function(data){return{fileIdentifierString:data.headerInfo.fileIdentifierString,fileVersion:data.headerInfo.fileVersion,imageType:data.headerInfo.imageType,height:data.headerInfo.height,width:data.headerInfo.width,numValidPixel:data.headerInfo.numValidPixel,microBlockSize:data.headerInfo.microBlockSize,blobSize:data.headerInfo.blobSize,maxZError:data.headerInfo.maxZError,pixelType:Lerc2Helpers.getPixelType(data.headerInfo.imageType),eofOffset:data.eofOffset,mask:data.mask?{numBytes:data.mask.numBytes}:null,pixels:{numBlocksX:data.pixels.numBlocksX,numBlocksY:data.pixels.numBlocksY,maxValue:data.headerInfo.zMax,minValue:data.headerInfo.zMin,noDataValue:data.noDataValue}}},constructConstantSurface:function(data){var val=data.headerInfo.zMax,numPixels=data.headerInfo.height*data.headerInfo.width,k=0;if(data.pixels.resultMask)for(k=0;k<numPixels;k++)data.pixels.resultMask[k]&&(data.pixels.resultPixels[k]=val);else for(k=0;k<numPixels;k++)data.pixels.resultPixels[k]=val},getDataTypeArray:function(t){var tp;switch(t){case 0:tp=Int8Array;break;case 1:tp=Uint8Array;break;case 2:tp=Int16Array;break;case 3:tp=Uint16Array;break;case 4:tp=Int32Array;break;case 5:tp=Uint32Array;break;case 6:default:tp=Float32Array;break;case 7:tp=Float64Array}return tp},getPixelType:function(t){var tp;switch(t){case 0:tp="S8";break;case 1:tp="U8";break;case 2:tp="S16";break;case 3:tp="U16";break;case 4:tp="S32";break;case 5:tp="U32";break;case 6:default:tp="F32";break;case 7:tp="F64"}return tp},isValidPixelValue:function(t,val){if(null==val)return!1;var isValid;switch(t){case 0:isValid=val>=-128&&val<=127;break;case 1:isValid=val>=0&&val<=255;break;case 2:isValid=val>=-32768&&val<=32767;break;case 3:isValid=val>=0&&val<=65536;break;case 4:isValid=val>=-2147483648&&val<=2147483647;break;case 5:isValid=val>=0&&val<=4294967296;break;case 6:isValid=val>=-34027999387901484e22&&val<=34027999387901484e22;break;case 7:isValid=val>=5e-324&&val<=17976931348623157e292;break;default:isValid=!1}return isValid},getDateTypeSize:function(t){var s=0;switch(t){case 0:case 1:s=1;break;case 2:case 3:s=2;break;case 4:case 5:case 6:s=4;break;case 7:s=8;break;default:s=t}return s},getDataTypeUsed:function(dt,tc){var t=dt;switch(dt){case 2:case 4:t=dt-tc;break;case 3:case 5:t=dt-2*tc;break;case 6:t=0===tc?dt:1===tc?2:1;break;case 7:t=0===tc?dt:dt-2*tc+1;break;default:t=dt}return t},getOnePixel:function(block,blockPtr,offsetType,view){var temp=0;switch(offsetType){case 0:temp=view.getInt8(blockPtr);break;case 1:temp=view.getUint8(blockPtr);break;case 2:temp=view.getInt16(blockPtr,!0);break;case 3:temp=view.getUint16(blockPtr,!0);break;case 4:temp=view.getInt32(blockPtr,!0);break;case 5:temp=view.getUInt32(blockPtr,!0);break;case 6:temp=view.getFloat32(blockPtr,!0);break;case 7:temp=view.getFloat64(blockPtr,!0);break;default:throw"the decoder does not understand this pixel type"}return temp}},TreeNode=function(val,left,right){this.val=val,this.left=left,this.right=right},{decode:function(input,options){var skipMask=(options=options||{}).maskData||null===options.maskData,noDataValue=options.noDataValue,i=0,data={};data.ptr=options.inputOffset||0,data.pixels={},Lerc2Helpers.readHeaderInfo(input,data);var headerInfo=data.headerInfo,OutPixelTypeArray=Lerc2Helpers.getDataTypeArray(headerInfo.imageType);skipMask?(data.pixels.resultMask=options.maskData,data.ptr+=4):Lerc2Helpers.readMask(input,data);var diff,numPixels=headerInfo.width*headerInfo.height;if(data.pixels.resultPixels=new OutPixelTypeArray(numPixels),data.counter={onesweep:0,uncompressed:0,lut:0,bitstuffer:0,constant:0,constantoffset:0},0!==headerInfo.numValidPixel)if(headerInfo.zMax===headerInfo.zMin)Lerc2Helpers.constructConstantSurface(data);else{var view=new DataView(input,data.ptr,2),bReadDataOneSweep=view.getUint8(0,!0);if(data.ptr++,bReadDataOneSweep)Lerc2Helpers.readDataOneSweep(input,data,OutPixelTypeArray);else if(headerInfo.fileVersion>1&&headerInfo.imageType<=1&&Math.abs(headerInfo.maxZError-.5)<1e-5){var bReadHuffman=view.getUint8(1,!0);data.ptr++,bReadHuffman?Lerc2Helpers.readHuffman(input,data,OutPixelTypeArray):Lerc2Helpers.readTiles(input,data,OutPixelTypeArray)}else Lerc2Helpers.readTiles(input,data,OutPixelTypeArray)}data.eofOffset=data.ptr,options.inputOffset?(diff=data.headerInfo.blobSize+options.inputOffset-data.ptr,Math.abs(diff)>=1&&(data.eofOffset=options.inputOffset+data.headerInfo.blobSize)):(diff=data.headerInfo.blobSize-data.ptr,Math.abs(diff)>=1&&(data.eofOffset=data.headerInfo.blobSize));var result={width:headerInfo.width,height:headerInfo.height,pixelData:data.pixels.resultPixels,minValue:headerInfo.zMin,maxValue:headerInfo.zMax,maskData:data.pixels.resultMask};if(data.pixels.resultMask&&Lerc2Helpers.isValidPixelValue(headerInfo.imageType,noDataValue)){var mask=data.pixels.resultMask;for(i=0;i<numPixels;i++)mask[i]||(result.pixelData[i]=noDataValue);result.noDataValue=noDataValue}return data.noDataValue=noDataValue,options.returnFileInfo&&(result.fileInfo=Lerc2Helpers.formatFileInfo(data)),result},getBandCount:function(input){for(var count=0,i=0,temp={ptr:0,pixels:{}};i<input.byteLength-58;)Lerc2Helpers.readHeaderInfo(input,temp),i+=temp.headerInfo.blobSize,count++,temp.ptr=i;return count}}),Lerc={decode:function(encodedData,options){var lerc,inputOffset=(options=options||{}).inputOffset||0,fileIdView=new Uint8Array(encodedData,inputOffset,10),fileIdentifierString=String.fromCharCode.apply(null,fileIdView);if("CntZImage"===fileIdentifierString.trim())lerc=LercDecode;else{if("Lerc2"!==fileIdentifierString.substring(0,5))throw"Unexpected file identifier string: "+fileIdentifierString;lerc=Lerc2Decode}for(var encodedMaskData,maskData,iPlane=0,eof=encodedData.byteLength-10,decodedPixelBlock={width:0,height:0,pixels:[],pixelType:options.pixelType,mask:null,statistics:[]};inputOffset<eof;){var result=lerc.decode(encodedData,{inputOffset:inputOffset,encodedMaskData:encodedMaskData,maskData:maskData,returnMask:0===iPlane,returnEncodedMask:0===iPlane,returnFileInfo:!0,pixelType:options.pixelType||null,noDataValue:options.noDataValue||null});inputOffset=result.fileInfo.eofOffset,0===iPlane&&(encodedMaskData=result.encodedMaskData,maskData=result.maskData,decodedPixelBlock.width=result.width,decodedPixelBlock.height=result.height,decodedPixelBlock.pixelType=result.pixelType||result.fileInfo.pixelType,decodedPixelBlock.mask=result.maskData),iPlane++,decodedPixelBlock.pixels.push(result.pixelData),decodedPixelBlock.statistics.push({minValue:result.minValue,maxValue:result.maxValue,noDataValue:result.noDataValue})}return decodedPixelBlock}};module.exports?module.exports=Lerc:this.Lerc=Lerc}();var localforage$1={exports:{}};!function(module){module.exports=function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){if(!u&&commonjsRequire)return commonjsRequire(o);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n||e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i=commonjsRequire,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(_dereq_,module,exports){(function(global){var scheduleDrain,draining,Mutation=global.MutationObserver||global.WebKitMutationObserver;if(Mutation){var called=0,observer=new Mutation(nextTick),element=global.document.createTextNode("");observer.observe(element,{characterData:!0}),scheduleDrain=function(){element.data=called=++called%2}}else if(global.setImmediate||void 0===global.MessageChannel)scheduleDrain="document"in global&&"onreadystatechange"in global.document.createElement("script")?function(){var scriptEl=global.document.createElement("script");scriptEl.onreadystatechange=function(){nextTick(),scriptEl.onreadystatechange=null,scriptEl.parentNode.removeChild(scriptEl),scriptEl=null},global.document.documentElement.appendChild(scriptEl)}:function(){setTimeout(nextTick,0)};else{var channel=new global.MessageChannel;channel.port1.onmessage=nextTick,scheduleDrain=function(){channel.port2.postMessage(0)}}var queue=[];function nextTick(){var i,oldQueue;draining=!0;for(var len=queue.length;len;){for(oldQueue=queue,queue=[],i=-1;++i<len;)oldQueue[i]();len=queue.length}draining=!1}function immediate(task){1!==queue.push(task)||draining||scheduleDrain()}module.exports=immediate}).call(this,void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(_dereq_,module,exports){var immediate=_dereq_(1);function INTERNAL(){}var handlers={},REJECTED=["REJECTED"],FULFILLED=["FULFILLED"],PENDING=["PENDING"];function Promise(resolver){if("function"!=typeof resolver)throw new TypeError("resolver must be a function");this.state=PENDING,this.queue=[],this.outcome=void 0,resolver!==INTERNAL&&safelyResolveThenable(this,resolver)}function QueueItem(promise,onFulfilled,onRejected){this.promise=promise,"function"==typeof onFulfilled&&(this.onFulfilled=onFulfilled,this.callFulfilled=this.otherCallFulfilled),"function"==typeof onRejected&&(this.onRejected=onRejected,this.callRejected=this.otherCallRejected)}function unwrap(promise,func,value){immediate(function(){var returnValue;try{returnValue=func(value)}catch(e){return handlers.reject(promise,e)}returnValue===promise?handlers.reject(promise,new TypeError("Cannot resolve promise with itself")):handlers.resolve(promise,returnValue)})}function getThen(obj){var then=obj&&obj.then;if(obj&&("object"==typeof obj||"function"==typeof obj)&&"function"==typeof then)return function(){then.apply(obj,arguments)}}function safelyResolveThenable(self,thenable){var called=!1;function onError(value){called||(called=!0,handlers.reject(self,value))}function onSuccess(value){called||(called=!0,handlers.resolve(self,value))}function tryToUnwrap(){thenable(onSuccess,onError)}var result=tryCatch(tryToUnwrap);"error"===result.status&&onError(result.value)}function tryCatch(func,value){var out={};try{out.value=func(value),out.status="success"}catch(e){out.status="error",out.value=e}return out}function resolve(value){return value instanceof this?value:handlers.resolve(new this(INTERNAL),value)}function reject(reason){var promise=new this(INTERNAL);return handlers.reject(promise,reason)}function all(iterable){var self=this;if("[object Array]"!==Object.prototype.toString.call(iterable))return this.reject(new TypeError("must be an array"));var len=iterable.length,called=!1;if(!len)return this.resolve([]);for(var values=new Array(len),resolved=0,i=-1,promise=new this(INTERNAL);++i<len;)allResolver(iterable[i],i);return promise;function allResolver(value,i){function resolveFromAll(outValue){values[i]=outValue,++resolved!==len||called||(called=!0,handlers.resolve(promise,values))}self.resolve(value).then(resolveFromAll,function(error){called||(called=!0,handlers.reject(promise,error))})}}function race(iterable){var self=this;if("[object Array]"!==Object.prototype.toString.call(iterable))return this.reject(new TypeError("must be an array"));var len=iterable.length,called=!1;if(!len)return this.resolve([]);for(var i=-1,promise=new this(INTERNAL);++i<len;)resolver(iterable[i]);return promise;function resolver(value){self.resolve(value).then(function(response){called||(called=!0,handlers.resolve(promise,response))},function(error){called||(called=!0,handlers.reject(promise,error))})}}module.exports=Promise,Promise.prototype.catch=function(onRejected){return this.then(null,onRejected)},Promise.prototype.then=function(onFulfilled,onRejected){if("function"!=typeof onFulfilled&&this.state===FULFILLED||"function"!=typeof onRejected&&this.state===REJECTED)return this;var promise=new this.constructor(INTERNAL);return this.state!==PENDING?unwrap(promise,this.state===FULFILLED?onFulfilled:onRejected,this.outcome):this.queue.push(new QueueItem(promise,onFulfilled,onRejected)),promise},QueueItem.prototype.callFulfilled=function(value){handlers.resolve(this.promise,value)},QueueItem.prototype.otherCallFulfilled=function(value){unwrap(this.promise,this.onFulfilled,value)},QueueItem.prototype.callRejected=function(value){handlers.reject(this.promise,value)},QueueItem.prototype.otherCallRejected=function(value){unwrap(this.promise,this.onRejected,value)},handlers.resolve=function(self,value){var result=tryCatch(getThen,value);if("error"===result.status)return handlers.reject(self,result.value);var thenable=result.value;if(thenable)safelyResolveThenable(self,thenable);else{self.state=FULFILLED,self.outcome=value;for(var i=-1,len=self.queue.length;++i<len;)self.queue[i].callFulfilled(value)}return self},handlers.reject=function(self,error){self.state=REJECTED,self.outcome=error;for(var i=-1,len=self.queue.length;++i<len;)self.queue[i].callRejected(error);return self},Promise.resolve=resolve,Promise.reject=reject,Promise.all=all,Promise.race=race},{1:1}],3:[function(_dereq_,module,exports){(function(global){"function"!=typeof global.Promise&&(global.Promise=_dereq_(2))}).call(this,void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{2:2}],4:[function(_dereq_,module,exports){var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function getIDB(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(e){return}}var idb=getIDB();function isIndexedDBValid(){try{if(!idb||!idb.open)return!1;var isSafari="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),hasFetch="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return(!isSafari||hasFetch)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(e){return!1}}function createBlob(parts,properties){parts=parts||[],properties=properties||{};try{return new Blob(parts,properties)}catch(e){if("TypeError"!==e.name)throw e;for(var builder=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),i=0;i<parts.length;i+=1)builder.append(parts[i]);return builder.getBlob(properties.type)}}"undefined"==typeof Promise&&_dereq_(3);var Promise$1=Promise;function executeCallback(promise,callback){callback&&promise.then(function(result){callback(null,result)},function(error){callback(error)})}function executeTwoCallbacks(promise,callback,errorCallback){"function"==typeof callback&&promise.then(callback),"function"==typeof errorCallback&&promise.catch(errorCallback)}function normalizeKey(key){return"string"!=typeof key&&(console.warn(key+" used as a key, but it is not a string."),key=String(key)),key}function getCallback(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1]}var DETECT_BLOB_SUPPORT_STORE="local-forage-detect-blob-support",supportsBlobs=void 0,dbContexts={},toString=Object.prototype.toString,READ_ONLY="readonly",READ_WRITE="readwrite";function _binStringToArrayBuffer(bin){for(var length=bin.length,buf=new ArrayBuffer(length),arr=new Uint8Array(buf),i=0;i<length;i++)arr[i]=bin.charCodeAt(i);return buf}function _checkBlobSupportWithoutCaching(idb){return new Promise$1(function(resolve){var txn=idb.transaction(DETECT_BLOB_SUPPORT_STORE,READ_WRITE),blob=createBlob([""]);txn.objectStore(DETECT_BLOB_SUPPORT_STORE).put(blob,"key"),txn.onabort=function(e){e.preventDefault(),e.stopPropagation(),resolve(!1)},txn.oncomplete=function(){var matchedChrome=navigator.userAgent.match(/Chrome/),matchedEdge=navigator.userAgent.match(/Edge/);resolve(matchedEdge||!matchedChrome||parseInt(matchedChrome[1],10)>=43)}}).catch(function(){return!1})}function _checkBlobSupport(idb){return"boolean"==typeof supportsBlobs?Promise$1.resolve(supportsBlobs):_checkBlobSupportWithoutCaching(idb).then(function(value){return supportsBlobs=value})}function _deferReadiness(dbInfo){var dbContext=dbContexts[dbInfo.name],deferredOperation={};deferredOperation.promise=new Promise$1(function(resolve,reject){deferredOperation.resolve=resolve,deferredOperation.reject=reject}),dbContext.deferredOperations.push(deferredOperation),dbContext.dbReady?dbContext.dbReady=dbContext.dbReady.then(function(){return deferredOperation.promise}):dbContext.dbReady=deferredOperation.promise}function _advanceReadiness(dbInfo){var deferredOperation=dbContexts[dbInfo.name].deferredOperations.pop();if(deferredOperation)return deferredOperation.resolve(),deferredOperation.promise}function _rejectReadiness(dbInfo,err){var deferredOperation=dbContexts[dbInfo.name].deferredOperations.pop();if(deferredOperation)return deferredOperation.reject(err),deferredOperation.promise}function _getConnection(dbInfo,upgradeNeeded){return new Promise$1(function(resolve,reject){if(dbContexts[dbInfo.name]=dbContexts[dbInfo.name]||createDbContext(),dbInfo.db){if(!upgradeNeeded)return resolve(dbInfo.db);_deferReadiness(dbInfo),dbInfo.db.close()}var dbArgs=[dbInfo.name];upgradeNeeded&&dbArgs.push(dbInfo.version);var openreq=idb.open.apply(idb,dbArgs);upgradeNeeded&&(openreq.onupgradeneeded=function(e){var db=openreq.result;try{db.createObjectStore(dbInfo.storeName),e.oldVersion<=1&&db.createObjectStore(DETECT_BLOB_SUPPORT_STORE)}catch(ex){if("ConstraintError"!==ex.name)throw ex}}),openreq.onerror=function(e){e.preventDefault(),reject(openreq.error)},openreq.onsuccess=function(){var db=openreq.result;db.onversionchange=function(e){e.target.close()},resolve(db),_advanceReadiness(dbInfo)}})}function _getOriginalConnection(dbInfo){return _getConnection(dbInfo,!1)}function _getUpgradedConnection(dbInfo){return _getConnection(dbInfo,!0)}function _isUpgradeNeeded(dbInfo,defaultVersion){if(!dbInfo.db)return!0;var isNewStore=!dbInfo.db.objectStoreNames.contains(dbInfo.storeName),isDowngrade=dbInfo.version<dbInfo.db.version,isUpgrade=dbInfo.version>dbInfo.db.version;if(isDowngrade&&(dbInfo.version,dbInfo.version=dbInfo.db.version),isUpgrade||isNewStore){if(isNewStore){var incVersion=dbInfo.db.version+1;incVersion>dbInfo.version&&(dbInfo.version=incVersion)}return!0}return!1}function _encodeBlob(blob){return new Promise$1(function(resolve,reject){var reader=new FileReader;reader.onerror=reject,reader.onloadend=function(e){var base64=btoa(e.target.result||"");resolve({__local_forage_encoded_blob:!0,data:base64,type:blob.type})},reader.readAsBinaryString(blob)})}function _decodeBlob(encodedBlob){return createBlob([_binStringToArrayBuffer(atob(encodedBlob.data))],{type:encodedBlob.type})}function _isEncodedBlob(value){return value&&value.__local_forage_encoded_blob}function _fullyReady(callback){var self=this,promise=self._initReady().then(function(){var dbContext=dbContexts[self._dbInfo.name];if(dbContext&&dbContext.dbReady)return dbContext.dbReady});return executeTwoCallbacks(promise,callback,callback),promise}function _tryReconnect(dbInfo){_deferReadiness(dbInfo);for(var dbContext=dbContexts[dbInfo.name],forages=dbContext.forages,i=0;i<forages.length;i++){var forage=forages[i];forage._dbInfo.db&&(forage._dbInfo.db.close(),forage._dbInfo.db=null)}return dbInfo.db=null,_getOriginalConnection(dbInfo).then(function(db){return dbInfo.db=db,_isUpgradeNeeded(dbInfo)?_getUpgradedConnection(dbInfo):db}).then(function(db){dbInfo.db=dbContext.db=db;for(var i=0;i<forages.length;i++)forages[i]._dbInfo.db=db}).catch(function(err){throw _rejectReadiness(dbInfo,err),err})}function createTransaction(dbInfo,mode,callback,retries){void 0===retries&&(retries=1);try{var tx=dbInfo.db.transaction(dbInfo.storeName,mode);callback(null,tx)}catch(err){if(retries>0&&(!dbInfo.db||"InvalidStateError"===err.name||"NotFoundError"===err.name))return Promise$1.resolve().then(function(){if(!dbInfo.db||"NotFoundError"===err.name&&!dbInfo.db.objectStoreNames.contains(dbInfo.storeName)&&dbInfo.version<=dbInfo.db.version)return dbInfo.db&&(dbInfo.version=dbInfo.db.version+1),_getUpgradedConnection(dbInfo)}).then(function(){return _tryReconnect(dbInfo).then(function(){createTransaction(dbInfo,mode,callback,retries-1)})}).catch(callback);callback(err)}}function createDbContext(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function _initStorage(options){var self=this,dbInfo={db:null};if(options)for(var i in options)dbInfo[i]=options[i];var dbContext=dbContexts[dbInfo.name];dbContext||(dbContext=createDbContext(),dbContexts[dbInfo.name]=dbContext),dbContext.forages.push(self),self._initReady||(self._initReady=self.ready,self.ready=_fullyReady);var initPromises=[];function ignoreErrors(){return Promise$1.resolve()}for(var j=0;j<dbContext.forages.length;j++){var forage=dbContext.forages[j];forage!==self&&initPromises.push(forage._initReady().catch(ignoreErrors))}var forages=dbContext.forages.slice(0);return Promise$1.all(initPromises).then(function(){return dbInfo.db=dbContext.db,_getOriginalConnection(dbInfo)}).then(function(db){return dbInfo.db=db,_isUpgradeNeeded(dbInfo,self._defaultConfig.version)?_getUpgradedConnection(dbInfo):db}).then(function(db){dbInfo.db=dbContext.db=db,self._dbInfo=dbInfo;for(var k=0;k<forages.length;k++){var forage=forages[k];forage!==self&&(forage._dbInfo.db=dbInfo.db,forage._dbInfo.version=dbInfo.version)}})}function getItem(key,callback){var self=this;key=normalizeKey(key);var promise=new Promise$1(function(resolve,reject){self.ready().then(function(){createTransaction(self._dbInfo,READ_ONLY,function(err,transaction){if(err)return reject(err);try{var req=transaction.objectStore(self._dbInfo.storeName).get(key);req.onsuccess=function(){var value=req.result;void 0===value&&(value=null),_isEncodedBlob(value)&&(value=_decodeBlob(value)),resolve(value)},req.onerror=function(){reject(req.error)}}catch(e){reject(e)}})}).catch(reject)});return executeCallback(promise,callback),promise}function iterate(iterator,callback){var self=this,promise=new Promise$1(function(resolve,reject){self.ready().then(function(){createTransaction(self._dbInfo,READ_ONLY,function(err,transaction){if(err)return reject(err);try{var req=transaction.objectStore(self._dbInfo.storeName).openCursor(),iterationNumber=1;req.onsuccess=function(){var cursor=req.result;if(cursor){var value=cursor.value;_isEncodedBlob(value)&&(value=_decodeBlob(value));var result=iterator(value,cursor.key,iterationNumber++);void 0!==result?resolve(result):cursor.continue()}else resolve()},req.onerror=function(){reject(req.error)}}catch(e){reject(e)}})}).catch(reject)});return executeCallback(promise,callback),promise}function setItem(key,value,callback){var self=this;key=normalizeKey(key);var promise=new Promise$1(function(resolve,reject){var dbInfo;self.ready().then(function(){return dbInfo=self._dbInfo,"[object Blob]"===toString.call(value)?_checkBlobSupport(dbInfo.db).then(function(blobSupport){return blobSupport?value:_encodeBlob(value)}):value}).then(function(value){createTransaction(self._dbInfo,READ_WRITE,function(err,transaction){if(err)return reject(err);try{var store=transaction.objectStore(self._dbInfo.storeName);null===value&&(value=void 0);var req=store.put(value,key);transaction.oncomplete=function(){void 0===value&&(value=null),resolve(value)},transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;reject(err)}}catch(e){reject(e)}})}).catch(reject)});return executeCallback(promise,callback),promise}function removeItem(key,callback){var self=this;key=normalizeKey(key);var promise=new Promise$1(function(resolve,reject){self.ready().then(function(){createTransaction(self._dbInfo,READ_WRITE,function(err,transaction){if(err)return reject(err);try{var req=transaction.objectStore(self._dbInfo.storeName).delete(key);transaction.oncomplete=function(){resolve()},transaction.onerror=function(){reject(req.error)},transaction.onabort=function(){var err=req.error?req.error:req.transaction.error;reject(err)}}catch(e){reject(e)}})}).catch(reject)});return executeCallback(promise,callback),promise}function clear(callback){var self=this,promise=new Promise$1(function(resolve,reject){self.ready().then(function(){createTransaction(self._dbInfo,READ_WRITE,function(err,transaction){if(err)return reject(err);try{var req=transaction.objectStore(self._dbInfo.storeName).clear();transaction.oncomplete=function(){resolve()},transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;reject(err)}}catch(e){reject(e)}})}).catch(reject)});return executeCallback(promise,callback),promise}function length(callback){var self=this,promise=new Promise$1(function(resolve,reject){self.ready().then(function(){createTransaction(self._dbInfo,READ_ONLY,function(err,transaction){if(err)return reject(err);try{var req=transaction.objectStore(self._dbInfo.storeName).count();req.onsuccess=function(){resolve(req.result)},req.onerror=function(){reject(req.error)}}catch(e){reject(e)}})}).catch(reject)});return executeCallback(promise,callback),promise}function key(n,callback){var self=this,promise=new Promise$1(function(resolve,reject){n<0?resolve(null):self.ready().then(function(){createTransaction(self._dbInfo,READ_ONLY,function(err,transaction){if(err)return reject(err);try{var store=transaction.objectStore(self._dbInfo.storeName),advanced=!1,req=store.openKeyCursor();req.onsuccess=function(){var cursor=req.result;cursor?0===n||advanced?resolve(cursor.key):(advanced=!0,cursor.advance(n)):resolve(null)},req.onerror=function(){reject(req.error)}}catch(e){reject(e)}})}).catch(reject)});return executeCallback(promise,callback),promise}function keys(callback){var self=this,promise=new Promise$1(function(resolve,reject){self.ready().then(function(){createTransaction(self._dbInfo,READ_ONLY,function(err,transaction){if(err)return reject(err);try{var req=transaction.objectStore(self._dbInfo.storeName).openKeyCursor(),keys=[];req.onsuccess=function(){var cursor=req.result;cursor?(keys.push(cursor.key),cursor.continue()):resolve(keys)},req.onerror=function(){reject(req.error)}}catch(e){reject(e)}})}).catch(reject)});return executeCallback(promise,callback),promise}function dropInstance(options,callback){callback=getCallback.apply(this,arguments);var currentConfig=this.config();(options="function"!=typeof options&&options||{}).name||(options.name=options.name||currentConfig.name,options.storeName=options.storeName||currentConfig.storeName);var promise,self=this;if(options.name){var dbPromise=options.name===currentConfig.name&&self._dbInfo.db?Promise$1.resolve(self._dbInfo.db):_getOriginalConnection(options).then(function(db){var dbContext=dbContexts[options.name],forages=dbContext.forages;dbContext.db=db;for(var i=0;i<forages.length;i++)forages[i]._dbInfo.db=db;return db});promise=options.storeName?dbPromise.then(function(db){if(db.objectStoreNames.contains(options.storeName)){var newVersion=db.version+1;_deferReadiness(options);var dbContext=dbContexts[options.name],forages=dbContext.forages;db.close();for(var i=0;i<forages.length;i++){var forage=forages[i];forage._dbInfo.db=null,forage._dbInfo.version=newVersion}var dropObjectPromise=new Promise$1(function(resolve,reject){var req=idb.open(options.name,newVersion);req.onerror=function(err){req.result.close(),reject(err)},req.onupgradeneeded=function(){req.result.deleteObjectStore(options.storeName)},req.onsuccess=function(){var db=req.result;db.close(),resolve(db)}});return dropObjectPromise.then(function(db){dbContext.db=db;for(var j=0;j<forages.length;j++){var _forage2=forages[j];_forage2._dbInfo.db=db,_advanceReadiness(_forage2._dbInfo)}}).catch(function(err){throw(_rejectReadiness(options,err)||Promise$1.resolve()).catch(function(){}),err})}}):dbPromise.then(function(db){_deferReadiness(options);var dbContext=dbContexts[options.name],forages=dbContext.forages;db.close();for(var i=0;i<forages.length;i++)forages[i]._dbInfo.db=null;var dropDBPromise=new Promise$1(function(resolve,reject){var req=idb.deleteDatabase(options.name);req.onerror=function(){var db=req.result;db&&db.close(),reject(req.error)},req.onblocked=function(){console.warn('dropInstance blocked for database "'+options.name+'" until all open connections are closed')},req.onsuccess=function(){var db=req.result;db&&db.close(),resolve(db)}});return dropDBPromise.then(function(db){dbContext.db=db;for(var i=0;i<forages.length;i++)_advanceReadiness(forages[i]._dbInfo)}).catch(function(err){throw(_rejectReadiness(options,err)||Promise$1.resolve()).catch(function(){}),err})})}else promise=Promise$1.reject("Invalid arguments");return executeCallback(promise,callback),promise}var asyncStorage={_driver:"asyncStorage",_initStorage:_initStorage,_support:isIndexedDBValid(),iterate:iterate,getItem:getItem,setItem:setItem,removeItem:removeItem,clear:clear,length:length,key:key,keys:keys,dropInstance:dropInstance};function isWebSQLValid(){return"function"==typeof openDatabase}var BASE_CHARS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",BLOB_TYPE_PREFIX="~~local_forage_type~",BLOB_TYPE_PREFIX_REGEX=/^~~local_forage_type~([^~]+)~/,SERIALIZED_MARKER="__lfsc__:",SERIALIZED_MARKER_LENGTH=SERIALIZED_MARKER.length,TYPE_ARRAYBUFFER="arbf",TYPE_BLOB="blob",TYPE_INT8ARRAY="si08",TYPE_UINT8ARRAY="ui08",TYPE_UINT8CLAMPEDARRAY="uic8",TYPE_INT16ARRAY="si16",TYPE_INT32ARRAY="si32",TYPE_UINT16ARRAY="ur16",TYPE_UINT32ARRAY="ui32",TYPE_FLOAT32ARRAY="fl32",TYPE_FLOAT64ARRAY="fl64",TYPE_SERIALIZED_MARKER_LENGTH=SERIALIZED_MARKER_LENGTH+TYPE_ARRAYBUFFER.length,toString$1=Object.prototype.toString;function stringToBuffer(serializedString){var i,encoded1,encoded2,encoded3,encoded4,bufferLength=.75*serializedString.length,len=serializedString.length,p=0;"="===serializedString[serializedString.length-1]&&(bufferLength--,"="===serializedString[serializedString.length-2]&&bufferLength--);var buffer=new ArrayBuffer(bufferLength),bytes=new Uint8Array(buffer);for(i=0;i<len;i+=4)encoded1=BASE_CHARS.indexOf(serializedString[i]),encoded2=BASE_CHARS.indexOf(serializedString[i+1]),encoded3=BASE_CHARS.indexOf(serializedString[i+2]),encoded4=BASE_CHARS.indexOf(serializedString[i+3]),bytes[p++]=encoded1<<2|encoded2>>4,bytes[p++]=(15&encoded2)<<4|encoded3>>2,bytes[p++]=(3&encoded3)<<6|63&encoded4;return buffer}function bufferToString(buffer){var i,bytes=new Uint8Array(buffer),base64String="";for(i=0;i<bytes.length;i+=3)base64String+=BASE_CHARS[bytes[i]>>2],base64String+=BASE_CHARS[(3&bytes[i])<<4|bytes[i+1]>>4],base64String+=BASE_CHARS[(15&bytes[i+1])<<2|bytes[i+2]>>6],base64String+=BASE_CHARS[63&bytes[i+2]];return bytes.length%3==2?base64String=base64String.substring(0,base64String.length-1)+"=":bytes.length%3==1&&(base64String=base64String.substring(0,base64String.length-2)+"=="),base64String}function serialize(value,callback){var valueType="";if(value&&(valueType=toString$1.call(value)),value&&("[object ArrayBuffer]"===valueType||value.buffer&&"[object ArrayBuffer]"===toString$1.call(value.buffer))){var buffer,marker=SERIALIZED_MARKER;value instanceof ArrayBuffer?(buffer=value,marker+=TYPE_ARRAYBUFFER):(buffer=value.buffer,"[object Int8Array]"===valueType?marker+=TYPE_INT8ARRAY:"[object Uint8Array]"===valueType?marker+=TYPE_UINT8ARRAY:"[object Uint8ClampedArray]"===valueType?marker+=TYPE_UINT8CLAMPEDARRAY:"[object Int16Array]"===valueType?marker+=TYPE_INT16ARRAY:"[object Uint16Array]"===valueType?marker+=TYPE_UINT16ARRAY:"[object Int32Array]"===valueType?marker+=TYPE_INT32ARRAY:"[object Uint32Array]"===valueType?marker+=TYPE_UINT32ARRAY:"[object Float32Array]"===valueType?marker+=TYPE_FLOAT32ARRAY:"[object Float64Array]"===valueType?marker+=TYPE_FLOAT64ARRAY:callback(new Error("Failed to get type for BinaryArray"))),callback(marker+bufferToString(buffer))}else if("[object Blob]"===valueType){var fileReader=new FileReader;fileReader.onload=function(){var str=BLOB_TYPE_PREFIX+value.type+"~"+bufferToString(this.result);callback(SERIALIZED_MARKER+TYPE_BLOB+str)},fileReader.readAsArrayBuffer(value)}else try{callback(JSON.stringify(value))}catch(e){console.error("Couldn't convert value into a JSON string: ",value),callback(null,e)}}function deserialize(value){if(value.substring(0,SERIALIZED_MARKER_LENGTH)!==SERIALIZED_MARKER)return JSON.parse(value);var blobType,serializedString=value.substring(TYPE_SERIALIZED_MARKER_LENGTH),type=value.substring(SERIALIZED_MARKER_LENGTH,TYPE_SERIALIZED_MARKER_LENGTH);if(type===TYPE_BLOB&&BLOB_TYPE_PREFIX_REGEX.test(serializedString)){var matcher=serializedString.match(BLOB_TYPE_PREFIX_REGEX);blobType=matcher[1],serializedString=serializedString.substring(matcher[0].length)}var buffer=stringToBuffer(serializedString);switch(type){case TYPE_ARRAYBUFFER:return buffer;case TYPE_BLOB:return createBlob([buffer],{type:blobType});case TYPE_INT8ARRAY:return new Int8Array(buffer);case TYPE_UINT8ARRAY:return new Uint8Array(buffer);case TYPE_UINT8CLAMPEDARRAY:return new Uint8ClampedArray(buffer);case TYPE_INT16ARRAY:return new Int16Array(buffer);case TYPE_UINT16ARRAY:return new Uint16Array(buffer);case TYPE_INT32ARRAY:return new Int32Array(buffer);case TYPE_UINT32ARRAY:return new Uint32Array(buffer);case TYPE_FLOAT32ARRAY:return new Float32Array(buffer);case TYPE_FLOAT64ARRAY:return new Float64Array(buffer);default:throw new Error("Unkown type: "+type)}}var localforageSerializer={serialize:serialize,deserialize:deserialize,stringToBuffer:stringToBuffer,bufferToString:bufferToString};function createDbTable(t,dbInfo,callback,errorCallback){t.executeSql("CREATE TABLE IF NOT EXISTS "+dbInfo.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],callback,errorCallback)}function _initStorage$1(options){var self=this,dbInfo={db:null};if(options)for(var i in options)dbInfo[i]="string"!=typeof options[i]?options[i].toString():options[i];var dbInfoPromise=new Promise$1(function(resolve,reject){try{dbInfo.db=openDatabase(dbInfo.name,String(dbInfo.version),dbInfo.description,dbInfo.size)}catch(e){return reject(e)}dbInfo.db.transaction(function(t){createDbTable(t,dbInfo,function(){self._dbInfo=dbInfo,resolve()},function(t,error){reject(error)})},reject)});return dbInfo.serializer=localforageSerializer,dbInfoPromise}function tryExecuteSql(t,dbInfo,sqlStatement,args,callback,errorCallback){t.executeSql(sqlStatement,args,callback,function(t,error){error.code===error.SYNTAX_ERR?t.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[dbInfo.storeName],function(t,results){results.rows.length?errorCallback(t,error):createDbTable(t,dbInfo,function(){t.executeSql(sqlStatement,args,callback,errorCallback)},errorCallback)},errorCallback):errorCallback(t,error)},errorCallback)}function getItem$1(key,callback){var self=this;key=normalizeKey(key);var promise=new Promise$1(function(resolve,reject){self.ready().then(function(){var dbInfo=self._dbInfo;dbInfo.db.transaction(function(t){tryExecuteSql(t,dbInfo,"SELECT * FROM "+dbInfo.storeName+" WHERE key = ? LIMIT 1",[key],function(t,results){var result=results.rows.length?results.rows.item(0).value:null;result&&(result=dbInfo.serializer.deserialize(result)),resolve(result)},function(t,error){reject(error)})})}).catch(reject)});return executeCallback(promise,callback),promise}function iterate$1(iterator,callback){var self=this,promise=new Promise$1(function(resolve,reject){self.ready().then(function(){var dbInfo=self._dbInfo;dbInfo.db.transaction(function(t){tryExecuteSql(t,dbInfo,"SELECT * FROM "+dbInfo.storeName,[],function(t,results){for(var rows=results.rows,length=rows.length,i=0;i<length;i++){var item=rows.item(i),result=item.value;if(result&&(result=dbInfo.serializer.deserialize(result)),void 0!==(result=iterator(result,item.key,i+1)))return void resolve(result)}resolve()},function(t,error){reject(error)})})}).catch(reject)});return executeCallback(promise,callback),promise}function _setItem(key,value,callback,retriesLeft){var self=this;key=normalizeKey(key);var promise=new Promise$1(function(resolve,reject){self.ready().then(function(){void 0===value&&(value=null);var originalValue=value,dbInfo=self._dbInfo;dbInfo.serializer.serialize(value,function(value,error){error?reject(error):dbInfo.db.transaction(function(t){tryExecuteSql(t,dbInfo,"INSERT OR REPLACE INTO "+dbInfo.storeName+" (key, value) VALUES (?, ?)",[key,value],function(){resolve(originalValue)},function(t,error){reject(error)})},function(sqlError){if(sqlError.code===sqlError.QUOTA_ERR){if(retriesLeft>0)return void resolve(_setItem.apply(self,[key,originalValue,callback,retriesLeft-1]));reject(sqlError)}})})}).catch(reject)});return executeCallback(promise,callback),promise}function setItem$1(key,value,callback){return _setItem.apply(this,[key,value,callback,1])}function removeItem$1(key,callback){var self=this;key=normalizeKey(key);var promise=new Promise$1(function(resolve,reject){self.ready().then(function(){var dbInfo=self._dbInfo;dbInfo.db.transaction(function(t){tryExecuteSql(t,dbInfo,"DELETE FROM "+dbInfo.storeName+" WHERE key = ?",[key],function(){resolve()},function(t,error){reject(error)})})}).catch(reject)});return executeCallback(promise,callback),promise}function clear$1(callback){var self=this,promise=new Promise$1(function(resolve,reject){self.ready().then(function(){var dbInfo=self._dbInfo;dbInfo.db.transaction(function(t){tryExecuteSql(t,dbInfo,"DELETE FROM "+dbInfo.storeName,[],function(){resolve()},function(t,error){reject(error)})})}).catch(reject)});return executeCallback(promise,callback),promise}function length$1(callback){var self=this,promise=new Promise$1(function(resolve,reject){self.ready().then(function(){var dbInfo=self._dbInfo;dbInfo.db.transaction(function(t){tryExecuteSql(t,dbInfo,"SELECT COUNT(key) as c FROM "+dbInfo.storeName,[],function(t,results){var result=results.rows.item(0).c;resolve(result)},function(t,error){reject(error)})})}).catch(reject)});return executeCallback(promise,callback),promise}function key$1(n,callback){var self=this,promise=new Promise$1(function(resolve,reject){self.ready().then(function(){var dbInfo=self._dbInfo;dbInfo.db.transaction(function(t){tryExecuteSql(t,dbInfo,"SELECT key FROM "+dbInfo.storeName+" WHERE id = ? LIMIT 1",[n+1],function(t,results){var result=results.rows.length?results.rows.item(0).key:null;resolve(result)},function(t,error){reject(error)})})}).catch(reject)});return executeCallback(promise,callback),promise}function keys$1(callback){var self=this,promise=new Promise$1(function(resolve,reject){self.ready().then(function(){var dbInfo=self._dbInfo;dbInfo.db.transaction(function(t){tryExecuteSql(t,dbInfo,"SELECT key FROM "+dbInfo.storeName,[],function(t,results){for(var keys=[],i=0;i<results.rows.length;i++)keys.push(results.rows.item(i).key);resolve(keys)},function(t,error){reject(error)})})}).catch(reject)});return executeCallback(promise,callback),promise}function getAllStoreNames(db){return new Promise$1(function(resolve,reject){db.transaction(function(t){t.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(t,results){for(var storeNames=[],i=0;i<results.rows.length;i++)storeNames.push(results.rows.item(i).name);resolve({db:db,storeNames:storeNames})},function(t,error){reject(error)})},function(sqlError){reject(sqlError)})})}function dropInstance$1(options,callback){callback=getCallback.apply(this,arguments);var currentConfig=this.config();(options="function"!=typeof options&&options||{}).name||(options.name=options.name||currentConfig.name,options.storeName=options.storeName||currentConfig.storeName);var promise,self=this;return executeCallback(promise=options.name?new Promise$1(function(resolve){var db;db=options.name===currentConfig.name?self._dbInfo.db:openDatabase(options.name,"","",0),options.storeName?resolve({db:db,storeNames:[options.storeName]}):resolve(getAllStoreNames(db))}).then(function(operationInfo){return new Promise$1(function(resolve,reject){operationInfo.db.transaction(function(t){function dropTable(storeName){return new Promise$1(function(resolve,reject){t.executeSql("DROP TABLE IF EXISTS "+storeName,[],function(){resolve()},function(t,error){reject(error)})})}for(var operations=[],i=0,len=operationInfo.storeNames.length;i<len;i++)operations.push(dropTable(operationInfo.storeNames[i]));Promise$1.all(operations).then(function(){resolve()}).catch(function(e){reject(e)})},function(sqlError){reject(sqlError)})})}):Promise$1.reject("Invalid arguments"),callback),promise}var webSQLStorage={_driver:"webSQLStorage",_initStorage:_initStorage$1,_support:isWebSQLValid(),iterate:iterate$1,getItem:getItem$1,setItem:setItem$1,removeItem:removeItem$1,clear:clear$1,length:length$1,key:key$1,keys:keys$1,dropInstance:dropInstance$1};function isLocalStorageValid(){try{return"undefined"!=typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem}catch(e){return!1}}function _getKeyPrefix(options,defaultConfig){var keyPrefix=options.name+"/";return options.storeName!==defaultConfig.storeName&&(keyPrefix+=options.storeName+"/"),keyPrefix}function checkIfLocalStorageThrows(){var localStorageTestKey="_localforage_support_test";try{return localStorage.setItem(localStorageTestKey,!0),localStorage.removeItem(localStorageTestKey),!1}catch(e){return!0}}function _isLocalStorageUsable(){return!checkIfLocalStorageThrows()||localStorage.length>0}function _initStorage$2(options){var self=this,dbInfo={};if(options)for(var i in options)dbInfo[i]=options[i];return dbInfo.keyPrefix=_getKeyPrefix(options,self._defaultConfig),_isLocalStorageUsable()?(self._dbInfo=dbInfo,dbInfo.serializer=localforageSerializer,Promise$1.resolve()):Promise$1.reject()}function clear$2(callback){var self=this,promise=self.ready().then(function(){for(var keyPrefix=self._dbInfo.keyPrefix,i=localStorage.length-1;i>=0;i--){var key=localStorage.key(i);0===key.indexOf(keyPrefix)&&localStorage.removeItem(key)}});return executeCallback(promise,callback),promise}function getItem$2(key,callback){var self=this;key=normalizeKey(key);var promise=self.ready().then(function(){var dbInfo=self._dbInfo,result=localStorage.getItem(dbInfo.keyPrefix+key);return result&&(result=dbInfo.serializer.deserialize(result)),result});return executeCallback(promise,callback),promise}function iterate$2(iterator,callback){var self=this,promise=self.ready().then(function(){for(var dbInfo=self._dbInfo,keyPrefix=dbInfo.keyPrefix,keyPrefixLength=keyPrefix.length,length=localStorage.length,iterationNumber=1,i=0;i<length;i++){var key=localStorage.key(i);if(0===key.indexOf(keyPrefix)){var value=localStorage.getItem(key);if(value&&(value=dbInfo.serializer.deserialize(value)),void 0!==(value=iterator(value,key.substring(keyPrefixLength),iterationNumber++)))return value}}});return executeCallback(promise,callback),promise}function key$2(n,callback){var self=this,promise=self.ready().then(function(){var result,dbInfo=self._dbInfo;try{result=localStorage.key(n)}catch(error){result=null}return result&&(result=result.substring(dbInfo.keyPrefix.length)),result});return executeCallback(promise,callback),promise}function keys$2(callback){var self=this,promise=self.ready().then(function(){for(var dbInfo=self._dbInfo,length=localStorage.length,keys=[],i=0;i<length;i++){var itemKey=localStorage.key(i);0===itemKey.indexOf(dbInfo.keyPrefix)&&keys.push(itemKey.substring(dbInfo.keyPrefix.length))}return keys});return executeCallback(promise,callback),promise}function length$2(callback){var promise=this.keys().then(function(keys){return keys.length});return executeCallback(promise,callback),promise}function removeItem$2(key,callback){var self=this;key=normalizeKey(key);var promise=self.ready().then(function(){var dbInfo=self._dbInfo;localStorage.removeItem(dbInfo.keyPrefix+key)});return executeCallback(promise,callback),promise}function setItem$2(key,value,callback){var self=this;key=normalizeKey(key);var promise=self.ready().then(function(){void 0===value&&(value=null);var originalValue=value;return new Promise$1(function(resolve,reject){var dbInfo=self._dbInfo;dbInfo.serializer.serialize(value,function(value,error){if(error)reject(error);else try{localStorage.setItem(dbInfo.keyPrefix+key,value),resolve(originalValue)}catch(e){"QuotaExceededError"!==e.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==e.name||reject(e),reject(e)}})})});return executeCallback(promise,callback),promise}function dropInstance$2(options,callback){if(callback=getCallback.apply(this,arguments),!(options="function"!=typeof options&&options||{}).name){var currentConfig=this.config();options.name=options.name||currentConfig.name,options.storeName=options.storeName||currentConfig.storeName}var promise,self=this;return promise=options.name?new Promise$1(function(resolve){options.storeName?resolve(_getKeyPrefix(options,self._defaultConfig)):resolve(options.name+"/")}).then(function(keyPrefix){for(var i=localStorage.length-1;i>=0;i--){var key=localStorage.key(i);0===key.indexOf(keyPrefix)&&localStorage.removeItem(key)}}):Promise$1.reject("Invalid arguments"),executeCallback(promise,callback),promise}var localStorageWrapper={_driver:"localStorageWrapper",_initStorage:_initStorage$2,_support:isLocalStorageValid(),iterate:iterate$2,getItem:getItem$2,setItem:setItem$2,removeItem:removeItem$2,clear:clear$2,length:length$2,key:key$2,keys:keys$2,dropInstance:dropInstance$2},sameValue=function(x,y){return x===y||"number"==typeof x&&"number"==typeof y&&isNaN(x)&&isNaN(y)},includes=function(array,searchElement){for(var len=array.length,i=0;i<len;){if(sameValue(array[i],searchElement))return!0;i++}return!1},isArray=Array.isArray||function(arg){return"[object Array]"===Object.prototype.toString.call(arg)},DefinedDrivers={},DriverSupport={},DefaultDrivers={INDEXEDDB:asyncStorage,WEBSQL:webSQLStorage,LOCALSTORAGE:localStorageWrapper},DefaultDriverOrder=[DefaultDrivers.INDEXEDDB._driver,DefaultDrivers.WEBSQL._driver,DefaultDrivers.LOCALSTORAGE._driver],OptionalDriverMethods=["dropInstance"],LibraryMethods=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(OptionalDriverMethods),DefaultConfig={description:"",driver:DefaultDriverOrder.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function callWhenReady(localForageInstance,libraryMethod){localForageInstance[libraryMethod]=function(){var _args=arguments;return localForageInstance.ready().then(function(){return localForageInstance[libraryMethod].apply(localForageInstance,_args)})}}function extend(){for(var i=1;i<arguments.length;i++){var arg=arguments[i];if(arg)for(var _key in arg)arg.hasOwnProperty(_key)&&(isArray(arg[_key])?arguments[0][_key]=arg[_key].slice():arguments[0][_key]=arg[_key])}return arguments[0]}var LocalForage=function(){function LocalForage(options){for(var driverTypeKey in _classCallCheck(this,LocalForage),DefaultDrivers)if(DefaultDrivers.hasOwnProperty(driverTypeKey)){var driver=DefaultDrivers[driverTypeKey],driverName=driver._driver;this[driverTypeKey]=driverName,DefinedDrivers[driverName]||this.defineDriver(driver)}this._defaultConfig=extend({},DefaultConfig),this._config=extend({},this._defaultConfig,options),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return LocalForage.prototype.config=function(options){if("object"===(void 0===options?"undefined":_typeof(options))){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var i in options){if("storeName"===i&&(options[i]=options[i].replace(/\W/g,"_")),"version"===i&&"number"!=typeof options[i])return new Error("Database version must be a number.");this._config[i]=options[i]}return!("driver"in options)||!options.driver||this.setDriver(this._config.driver)}return"string"==typeof options?this._config[options]:this._config},LocalForage.prototype.defineDriver=function(driverObject,callback,errorCallback){var promise=new Promise$1(function(resolve,reject){try{var driverName=driverObject._driver,complianceError=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!driverObject._driver)return void reject(complianceError);for(var driverMethods=LibraryMethods.concat("_initStorage"),i=0,len=driverMethods.length;i<len;i++){var driverMethodName=driverMethods[i];if((!includes(OptionalDriverMethods,driverMethodName)||driverObject[driverMethodName])&&"function"!=typeof driverObject[driverMethodName])return void reject(complianceError)}var configureMissingMethods=function(){for(var methodNotImplementedFactory=function(methodName){return function(){var error=new Error("Method "+methodName+" is not implemented by the current driver"),promise=Promise$1.reject(error);return executeCallback(promise,arguments[arguments.length-1]),promise}},_i=0,_len=OptionalDriverMethods.length;_i<_len;_i++){var optionalDriverMethod=OptionalDriverMethods[_i];driverObject[optionalDriverMethod]||(driverObject[optionalDriverMethod]=methodNotImplementedFactory(optionalDriverMethod))}};configureMissingMethods();var setDriverSupport=function(support){DefinedDrivers[driverName]&&console.info("Redefining LocalForage driver: "+driverName),DefinedDrivers[driverName]=driverObject,DriverSupport[driverName]=support,resolve()};"_support"in driverObject?driverObject._support&&"function"==typeof driverObject._support?driverObject._support().then(setDriverSupport,reject):setDriverSupport(!!driverObject._support):setDriverSupport(!0)}catch(e){reject(e)}});return executeTwoCallbacks(promise,callback,errorCallback),promise},LocalForage.prototype.driver=function(){return this._driver||null},LocalForage.prototype.getDriver=function(driverName,callback,errorCallback){var getDriverPromise=DefinedDrivers[driverName]?Promise$1.resolve(DefinedDrivers[driverName]):Promise$1.reject(new Error("Driver not found."));return executeTwoCallbacks(getDriverPromise,callback,errorCallback),getDriverPromise},LocalForage.prototype.getSerializer=function(callback){var serializerPromise=Promise$1.resolve(localforageSerializer);return executeTwoCallbacks(serializerPromise,callback),serializerPromise},LocalForage.prototype.ready=function(callback){var self=this,promise=self._driverSet.then(function(){return null===self._ready&&(self._ready=self._initDriver()),self._ready});return executeTwoCallbacks(promise,callback,callback),promise},LocalForage.prototype.setDriver=function(drivers,callback,errorCallback){var self=this;isArray(drivers)||(drivers=[drivers]);var supportedDrivers=this._getSupportedDrivers(drivers);function setDriverToConfig(){self._config.driver=self.driver()}function extendSelfWithDriver(driver){return self._extend(driver),setDriverToConfig(),self._ready=self._initStorage(self._config),self._ready}function initDriver(supportedDrivers){return function(){var currentDriverIndex=0;function driverPromiseLoop(){for(;currentDriverIndex<supportedDrivers.length;){var driverName=supportedDrivers[currentDriverIndex];return currentDriverIndex++,self._dbInfo=null,self._ready=null,self.getDriver(driverName).then(extendSelfWithDriver).catch(driverPromiseLoop)}setDriverToConfig();var error=new Error("No available storage method found.");return self._driverSet=Promise$1.reject(error),self._driverSet}return driverPromiseLoop()}}var oldDriverSetDone=null!==this._driverSet?this._driverSet.catch(function(){return Promise$1.resolve()}):Promise$1.resolve();return this._driverSet=oldDriverSetDone.then(function(){var driverName=supportedDrivers[0];return self._dbInfo=null,self._ready=null,self.getDriver(driverName).then(function(driver){self._driver=driver._driver,setDriverToConfig(),self._wrapLibraryMethodsWithReady(),self._initDriver=initDriver(supportedDrivers)})}).catch(function(){setDriverToConfig();var error=new Error("No available storage method found.");return self._driverSet=Promise$1.reject(error),self._driverSet}),executeTwoCallbacks(this._driverSet,callback,errorCallback),this._driverSet},LocalForage.prototype.supports=function(driverName){return!!DriverSupport[driverName]},LocalForage.prototype._extend=function(libraryMethodsAndProperties){extend(this,libraryMethodsAndProperties)},LocalForage.prototype._getSupportedDrivers=function(drivers){for(var supportedDrivers=[],i=0,len=drivers.length;i<len;i++){var driverName=drivers[i];this.supports(driverName)&&supportedDrivers.push(driverName)}return supportedDrivers},LocalForage.prototype._wrapLibraryMethodsWithReady=function(){for(var i=0,len=LibraryMethods.length;i<len;i++)callWhenReady(this,LibraryMethods[i])},LocalForage.prototype.createInstance=function(options){return new LocalForage(options)},LocalForage}(),localforage_js=new LocalForage;module.exports=localforage_js},{3:3}]},{},[4])(4)}(localforage$1);var tempStore,localforage=localforage$1.exports;function getStore(){return tempStore||(tempStore=localforage.createInstance({name:"maptalks.tileclip",storeName:"tiles",description:"Tile storage for maptalks.tileclip"})),tempStore}function storeTile(url,data){getStore().setItem(url,data).then(function(){}).catch(function(error){console.error("Error saving tile: "+url,error)})}function getStoreTile(url){return getStore().getItem(url)}function Point$3(x,y){this.x=x,this.y=y}Point$3.prototype={clone:function(){return new Point$3(this.x,this.y)},add:function(p){return this.clone()._add(p)},sub:function(p){return this.clone()._sub(p)},multByPoint:function(p){return this.clone()._multByPoint(p)},divByPoint:function(p){return this.clone()._divByPoint(p)},mult:function(k){return this.clone()._mult(k)},div:function(k){return this.clone()._div(k)},rotate:function(a){return this.clone()._rotate(a)},rotateAround:function(a,p){return this.clone()._rotateAround(a,p)},matMult:function(m){return this.clone()._matMult(m)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(other){return this.x===other.x&&this.y===other.y},dist:function(p){return Math.sqrt(this.distSqr(p))},distSqr:function(p){var dx=p.x-this.x,dy=p.y-this.y;return dx*dx+dy*dy},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(b){return Math.atan2(this.y-b.y,this.x-b.x)},angleWith:function(b){return this.angleWithSep(b.x,b.y)},angleWithSep:function(x,y){return Math.atan2(this.x*y-this.y*x,this.x*x+this.y*y)},_matMult:function(m){var x=m[0]*this.x+m[1]*this.y,y=m[2]*this.x+m[3]*this.y;return this.x=x,this.y=y,this},_add:function(p){return this.x+=p.x,this.y+=p.y,this},_sub:function(p){return this.x-=p.x,this.y-=p.y,this},_mult:function(k){return this.x*=k,this.y*=k,this},_div:function(k){return this.x/=k,this.y/=k,this},_multByPoint:function(p){return this.x*=p.x,this.y*=p.y,this},_divByPoint:function(p){return this.x/=p.x,this.y/=p.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var y=this.y;return this.y=this.x,this.x=-y,this},_rotate:function(angle){var cos=Math.cos(angle),sin=Math.sin(angle),x=cos*this.x-sin*this.y,y=sin*this.x+cos*this.y;return this.x=x,this.y=y,this},_rotateAround:function(angle,p){var cos=Math.cos(angle),sin=Math.sin(angle),x=p.x+cos*(this.x-p.x)-sin*(this.y-p.y),y=p.y+sin*(this.x-p.x)+cos*(this.y-p.y);return this.x=x,this.y=y,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Point$3},Point$3.convert=function(p){if(p instanceof Point$3)return p;if(Array.isArray(p))return new Point$3(+p[0],+p[1]);if(void 0!==p.x&&void 0!==p.y)return new Point$3(+p.x,+p.y);throw new Error("Expected [x, y] or {x, y} point format")};class VectorTileFeature$3{constructor(pbf,end,extent,keys,values){this.properties={},this.extent=extent,this.type=0,this.id=void 0,this._pbf=pbf,this._geometry=-1,this._keys=keys,this._values=values,pbf.readFields(readFeature$1,this,end)}loadGeometry(){var pbf=this._pbf;pbf.pos=this._geometry;for(var line,end=pbf.readVarint()+pbf.pos,lines=[],cmd=1,length=0,x=0,y=0;pbf.pos<end;){if(length<=0){var cmdLen=pbf.readVarint();cmd=7&cmdLen,length=cmdLen>>3}if(length--,1===cmd||2===cmd)x+=pbf.readSVarint(),y+=pbf.readSVarint(),1===cmd&&(line&&lines.push(line),line=[]),line&&line.push(new Point$3(x,y));else{if(7!==cmd)throw new Error("unknown command "+cmd);line&&line.push(line[0].clone())}}return line&&lines.push(line),lines}bbox(){var pbf=this._pbf;pbf.pos=this._geometry;for(var end=pbf.readVarint()+pbf.pos,cmd=1,length=0,x=0,y=0,x1=1/0,x2=-1/0,y1=1/0,y2=-1/0;pbf.pos<end;){if(length<=0){var cmdLen=pbf.readVarint();cmd=7&cmdLen,length=cmdLen>>3}if(length--,1===cmd||2===cmd)(x+=pbf.readSVarint())<x1&&(x1=x),x>x2&&(x2=x),(y+=pbf.readSVarint())<y1&&(y1=y),y>y2&&(y2=y);else if(7!==cmd)throw new Error("unknown command "+cmd)}return[x1,y1,x2,y2]}toGeoJSON(x,y,z){var geometry,size=this.extent*Math.pow(2,z),x0=this.extent*x,y0=this.extent*y,vtCoords=this.loadGeometry();function projectPoint(p){return[360*(p.x+x0)/size-180,360/Math.PI*Math.atan(Math.exp((1-2*(p.y+y0)/size)*Math.PI))-90]}function projectLine(line){return line.map(projectPoint)}if(1===this.type){var points=[];for(var line of vtCoords)points.push(line[0]);var coordinates=projectLine(points);geometry=1===points.length?{type:"Point",coordinates:coordinates[0]}:{type:"MultiPoint",coordinates:coordinates}}else if(2===this.type){var _coordinates=vtCoords.map(projectLine);geometry=1===_coordinates.length?{type:"LineString",coordinates:_coordinates[0]}:{type:"MultiLineString",coordinates:_coordinates}}else{if(3!==this.type)throw new Error("unknown feature type");var polygons=function(rings){var len=rings.length;if(len<=1)return[rings];for(var polygon,ccw,polygons=[],i=0;i<len;i++){var area=signedArea$1(rings[i]);0!==area&&(void 0===ccw&&(ccw=area<0),ccw===area<0?(polygon&&polygons.push(polygon),polygon=[rings[i]]):polygon&&polygon.push(rings[i]))}polygon&&polygons.push(polygon);return polygons}(vtCoords),_coordinates2=[];for(var polygon of polygons)_coordinates2.push(polygon.map(projectLine));geometry=1===_coordinates2.length?{type:"Polygon",coordinates:_coordinates2[0]}:{type:"MultiPolygon",coordinates:_coordinates2}}var result={type:"Feature",geometry:geometry,properties:this.properties};return null!=this.id&&(result.id=this.id),result}}function readFeature$1(tag,feature,pbf){1===tag?feature.id=pbf.readVarint():2===tag?function(pbf,feature){var end=pbf.readVarint()+pbf.pos;for(;pbf.pos<end;){var key=feature._keys[pbf.readVarint()],value=feature._values[pbf.readVarint()];feature.properties[key]=value}}(pbf,feature):3===tag?feature.type=pbf.readVarint():4===tag&&(feature._geometry=pbf.pos)}function signedArea$1(ring){for(var p1,p2,sum=0,i=0,len=ring.length,j=len-1;i<len;j=i++)p1=ring[i],sum+=((p2=ring[j]).x-p1.x)*(p1.y+p2.y);return sum}VectorTileFeature$3.types=["Unknown","Point","LineString","Polygon"];class VectorTileLayer$2{constructor(pbf,end){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=pbf,this._keys=[],this._values=[],this._features=[],pbf.readFields(readLayer$1,this,end),this.length=this._features.length}feature(i){if(i<0||i>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[i];var end=this._pbf.readVarint()+this._pbf.pos;return new VectorTileFeature$3(this._pbf,end,this.extent,this._keys,this._values)}}function readLayer$1(tag,layer,pbf){15===tag?layer.version=pbf.readVarint():1===tag?layer.name=pbf.readString():5===tag?layer.extent=pbf.readVarint():2===tag?layer._features.push(pbf.pos):3===tag?layer._keys.push(pbf.readString()):4===tag&&layer._values.push(function(pbf){var value=null,end=pbf.readVarint()+pbf.pos;for(;pbf.pos<end;){var tag=pbf.readVarint()>>3;value=1===tag?pbf.readString():2===tag?pbf.readFloat():3===tag?pbf.readDouble():4===tag?pbf.readVarint64():5===tag?pbf.readVarint():6===tag?pbf.readSVarint():7===tag?pbf.readBoolean():null}if(null==value)throw new Error("unknown feature value");return value}(pbf))}class VectorTile$1{constructor(pbf,end){this.layers=pbf.readFields(readTile$1,{},end)}}function readTile$1(tag,layers,pbf){if(3===tag){var layer=new VectorTileLayer$2(pbf,pbf.readVarint()+pbf.pos);layer.length&&(layers[layer.name]=layer)}}var utf8TextDecoder$1="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8");class Pbf$2{constructor(buf=new Uint8Array(16)){this.buf=ArrayBuffer.isView(buf)?buf:new Uint8Array(buf),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(readField,result,end=this.length){for(;this.pos<end;){var val=this.readVarint(),tag=val>>3,startPos=this.pos;this.type=7&val,readField(tag,result,this),this.pos===startPos&&this.skip(val)}return result}readMessage(readField,result){return this.readFields(readField,result,this.readVarint()+this.pos)}readFixed32(){var val=this.dataView.getUint32(this.pos,!0);return this.pos+=4,val}readSFixed32(){var val=this.dataView.getInt32(this.pos,!0);return this.pos+=4,val}readFixed64(){var val=this.dataView.getUint32(this.pos,!0)+4294967296*this.dataView.getUint32(this.pos+4,!0);return this.pos+=8,val}readSFixed64(){var val=this.dataView.getUint32(this.pos,!0)+4294967296*this.dataView.getInt32(this.pos+4,!0);return this.pos+=8,val}readFloat(){var val=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,val}readDouble(){var val=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,val}readVarint(isSigned){var val,b,buf=this.buf;return val=127&(b=buf[this.pos++]),b<128?val:(val|=(127&(b=buf[this.pos++]))<<7,b<128?val:(val|=(127&(b=buf[this.pos++]))<<14,b<128?val:(val|=(127&(b=buf[this.pos++]))<<21,b<128?val:function(l,s,p){var h,b,buf=p.buf;if(b=buf[p.pos++],h=(112&b)>>4,b<128)return toNum$1(l,h,s);if(b=buf[p.pos++],h|=(127&b)<<3,b<128)return toNum$1(l,h,s);if(b=buf[p.pos++],h|=(127&b)<<10,b<128)return toNum$1(l,h,s);if(b=buf[p.pos++],h|=(127&b)<<17,b<128)return toNum$1(l,h,s);if(b=buf[p.pos++],h|=(127&b)<<24,b<128)return toNum$1(l,h,s);if(b=buf[p.pos++],h|=(1&b)<<31,b<128)return toNum$1(l,h,s);throw new Error("Expected varint not more than 10 bytes")}(val|=(15&(b=buf[this.pos]))<<28,isSigned,this))))}readVarint64(){return this.readVarint(!0)}readSVarint(){var num=this.readVarint();return num%2==1?(num+1)/-2:num/2}readBoolean(){return Boolean(this.readVarint())}readString(){var end=this.readVarint()+this.pos,pos=this.pos;return this.pos=end,end-pos>=12&&utf8TextDecoder$1?utf8TextDecoder$1.decode(this.buf.subarray(pos,end)):function(buf,pos,end){var str="",i=pos;for(;i<end;){var b0=buf[i],c=null,bytesPerSequence=b0>239?4:b0>223?3:b0>191?2:1;if(i+bytesPerSequence>end)break;var b1=void 0,b2=void 0,b3=void 0;1===bytesPerSequence?b0<128&&(c=b0):2===bytesPerSequence?128==(192&(b1=buf[i+1]))&&(c=(31&b0)<<6|63&b1)<=127&&(c=null):3===bytesPerSequence?(b1=buf[i+1],b2=buf[i+2],128==(192&b1)&&128==(192&b2)&&((c=(15&b0)<<12|(63&b1)<<6|63&b2)<=2047||c>=55296&&c<=57343)&&(c=null)):4===bytesPerSequence&&(b1=buf[i+1],b2=buf[i+2],b3=buf[i+3],128==(192&b1)&&128==(192&b2)&&128==(192&b3)&&((c=(15&b0)<<18|(63&b1)<<12|(63&b2)<<6|63&b3)<=65535||c>=1114112)&&(c=null)),null===c?(c=65533,bytesPerSequence=1):c>65535&&(c-=65536,str+=String.fromCharCode(c>>>10&1023|55296),c=56320|1023&c),str+=String.fromCharCode(c),i+=bytesPerSequence}return str}(this.buf,pos,end)}readBytes(){var end=this.readVarint()+this.pos,buffer=this.buf.subarray(this.pos,end);return this.pos=end,buffer}readPackedVarint(arr=[],isSigned){for(var end=this.readPackedEnd();this.pos<end;)arr.push(this.readVarint(isSigned));return arr}readPackedSVarint(arr=[]){for(var end=this.readPackedEnd();this.pos<end;)arr.push(this.readSVarint());return arr}readPackedBoolean(arr=[]){for(var end=this.readPackedEnd();this.pos<end;)arr.push(this.readBoolean());return arr}readPackedFloat(arr=[]){for(var end=this.readPackedEnd();this.pos<end;)arr.push(this.readFloat());return arr}readPackedDouble(arr=[]){for(var end=this.readPackedEnd();this.pos<end;)arr.push(this.readDouble());return arr}readPackedFixed32(arr=[]){for(var end=this.readPackedEnd();this.pos<end;)arr.push(this.readFixed32());return arr}readPackedSFixed32(arr=[]){for(var end=this.readPackedEnd();this.pos<end;)arr.push(this.readSFixed32());return arr}readPackedFixed64(arr=[]){for(var end=this.readPackedEnd();this.pos<end;)arr.push(this.readFixed64());return arr}readPackedSFixed64(arr=[]){for(var end=this.readPackedEnd();this.pos<end;)arr.push(this.readSFixed64());return arr}readPackedEnd(){return 2===this.type?this.readVarint()+this.pos:this.pos+1}skip(val){var type=7&val;if(0===type)for(;this.buf[this.pos++]>127;);else if(2===type)this.pos=this.readVarint()+this.pos;else if(5===type)this.pos+=4;else{if(1!==type)throw new Error("Unimplemented type: "+type);this.pos+=8}}writeTag(tag,type){this.writeVarint(tag<<3|type)}realloc(min){for(var length=this.length||16;length<this.pos+min;)length*=2;if(length!==this.length){var buf=new Uint8Array(length);buf.set(this.buf),this.buf=buf,this.dataView=new DataView(buf.buffer),this.length=length}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(val){this.realloc(4),this.dataView.setInt32(this.pos,val,!0),this.pos+=4}writeSFixed32(val){this.realloc(4),this.dataView.setInt32(this.pos,val,!0),this.pos+=4}writeFixed64(val){this.realloc(8),this.dataView.setInt32(this.pos,-1&val,!0),this.dataView.setInt32(this.pos+4,Math.floor(2.3283064365386963e-10*val),!0),this.pos+=8}writeSFixed64(val){this.realloc(8),this.dataView.setInt32(this.pos,-1&val,!0),this.dataView.setInt32(this.pos+4,Math.floor(2.3283064365386963e-10*val),!0),this.pos+=8}writeVarint(val){(val=+val||0)>268435455||val<0?function(val,pbf){var low,high;val>=0?(low=val%4294967296|0,high=val/4294967296|0):(high=~(-val/4294967296),4294967295^(low=~(-val%4294967296))?low=low+1|0:(low=0,high=high+1|0));if(val>=0x10000000000000000||val<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");pbf.realloc(10),function(low,high,pbf){pbf.buf[pbf.pos++]=127&low|128,low>>>=7,pbf.buf[pbf.pos++]=127&low|128,low>>>=7,pbf.buf[pbf.pos++]=127&low|128,low>>>=7,pbf.buf[pbf.pos++]=127&low|128,low>>>=7,pbf.buf[pbf.pos]=127&low}(low,0,pbf),function(high,pbf){var lsb=(7&high)<<4;if(pbf.buf[pbf.pos++]|=lsb|((high>>>=3)?128:0),!high)return;if(pbf.buf[pbf.pos++]=127&high|((high>>>=7)?128:0),!high)return;if(pbf.buf[pbf.pos++]=127&high|((high>>>=7)?128:0),!high)return;if(pbf.buf[pbf.pos++]=127&high|((high>>>=7)?128:0),!high)return;if(pbf.buf[pbf.pos++]=127&high|((high>>>=7)?128:0),!high)return;pbf.buf[pbf.pos++]=127&high}(high,pbf)}(val,this):(this.realloc(4),this.buf[this.pos++]=127&val|(val>127?128:0),val<=127||(this.buf[this.pos++]=127&(val>>>=7)|(val>127?128:0),val<=127||(this.buf[this.pos++]=127&(val>>>=7)|(val>127?128:0),val<=127||(this.buf[this.pos++]=val>>>7&127))))}writeSVarint(val){this.writeVarint(val<0?2*-val-1:2*val)}writeBoolean(val){this.writeVarint(+val)}writeString(str){str=String(str),this.realloc(4*str.length),this.pos++;var startPos=this.pos;this.pos=function(buf,str,pos){for(var c,lead,i=0;i<str.length;i++){if((c=str.charCodeAt(i))>55295&&c<57344){if(!lead){c>56319||i+1===str.length?(buf[pos++]=239,buf[pos++]=191,buf[pos++]=189):lead=c;continue}if(c<56320){buf[pos++]=239,buf[pos++]=191,buf[pos++]=189,lead=c;continue}c=lead-55296<<10|c-56320|65536,lead=null}else lead&&(buf[pos++]=239,buf[pos++]=191,buf[pos++]=189,lead=null);c<128?buf[pos++]=c:(c<2048?buf[pos++]=c>>6|192:(c<65536?buf[pos++]=c>>12|224:(buf[pos++]=c>>18|240,buf[pos++]=c>>12&63|128),buf[pos++]=c>>6&63|128),buf[pos++]=63&c|128)}return pos}(this.buf,str,this.pos);var len=this.pos-startPos;len>=128&&makeRoomForExtraLength$1(startPos,len,this),this.pos=startPos-1,this.writeVarint(len),this.pos+=len}writeFloat(val){this.realloc(4),this.dataView.setFloat32(this.pos,val,!0),this.pos+=4}writeDouble(val){this.realloc(8),this.dataView.setFloat64(this.pos,val,!0),this.pos+=8}writeBytes(buffer){var len=buffer.length;this.writeVarint(len),this.realloc(len);for(var i=0;i<len;i++)this.buf[this.pos++]=buffer[i]}writeRawMessage(fn,obj){this.pos++;var startPos=this.pos;fn(obj,this);var len=this.pos-startPos;len>=128&&makeRoomForExtraLength$1(startPos,len,this),this.pos=startPos-1,this.writeVarint(len),this.pos+=len}writeMessage(tag,fn,obj){this.writeTag(tag,2),this.writeRawMessage(fn,obj)}writePackedVarint(tag,arr){arr.length&&this.writeMessage(tag,writePackedVarint,arr)}writePackedSVarint(tag,arr){arr.length&&this.writeMessage(tag,writePackedSVarint,arr)}writePackedBoolean(tag,arr){arr.length&&this.writeMessage(tag,writePackedBoolean,arr)}writePackedFloat(tag,arr){arr.length&&this.writeMessage(tag,writePackedFloat,arr)}writePackedDouble(tag,arr){arr.length&&this.writeMessage(tag,writePackedDouble,arr)}writePackedFixed32(tag,arr){arr.length&&this.writeMessage(tag,writePackedFixed32,arr)}writePackedSFixed32(tag,arr){arr.length&&this.writeMessage(tag,writePackedSFixed32,arr)}writePackedFixed64(tag,arr){arr.length&&this.writeMessage(tag,writePackedFixed64,arr)}writePackedSFixed64(tag,arr){arr.length&&this.writeMessage(tag,writePackedSFixed64,arr)}writeBytesField(tag,buffer){this.writeTag(tag,2),this.writeBytes(buffer)}writeFixed32Field(tag,val){this.writeTag(tag,5),this.writeFixed32(val)}writeSFixed32Field(tag,val){this.writeTag(tag,5),this.writeSFixed32(val)}writeFixed64Field(tag,val){this.writeTag(tag,1),this.writeFixed64(val)}writeSFixed64Field(tag,val){this.writeTag(tag,1),this.writeSFixed64(val)}writeVarintField(tag,val){this.writeTag(tag,0),this.writeVarint(val)}writeSVarintField(tag,val){this.writeTag(tag,0),this.writeSVarint(val)}writeStringField(tag,str){this.writeTag(tag,2),this.writeString(str)}writeFloatField(tag,val){this.writeTag(tag,5),this.writeFloat(val)}writeDoubleField(tag,val){this.writeTag(tag,1),this.writeDouble(val)}writeBooleanField(tag,val){this.writeVarintField(tag,+val)}}function toNum$1(low,high,isSigned){return isSigned?4294967296*high+(low>>>0):4294967296*(high>>>0)+(low>>>0)}function makeRoomForExtraLength$1(startPos,len,pbf){var extraLen=len<=16383?1:len<=2097151?2:len<=268435455?3:Math.floor(Math.log(len)/(7*Math.LN2));pbf.realloc(extraLen);for(var i=pbf.pos-1;i>=startPos;i--)pbf.buf[i+extraLen]=pbf.buf[i]}function writePackedVarint(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeVarint(arr[i])}function writePackedSVarint(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeSVarint(arr[i])}function writePackedFloat(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeFloat(arr[i])}function writePackedDouble(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeDouble(arr[i])}function writePackedBoolean(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeBoolean(arr[i])}function writePackedFixed32(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeFixed32(arr[i])}function writePackedSFixed32(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeSFixed32(arr[i])}function writePackedFixed64(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeFixed64(arr[i])}function writePackedSFixed64(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeSFixed64(arr[i])}var vtPbf={exports:{}},ieee754$1={read:function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;nBits>0;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;nBits>0;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?NaN:1/0*(s?-1:1);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},write:function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=value<0||0===value&&1/value<0?1:0;for(value=Math.abs(value),isNaN(value)||value===1/0?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),(value+=e+eBias>=1?rt/c:rt*Math.pow(2,1-eBias))*c>=2&&(e++,c/=2),e+eBias>=eMax?(m=0,e=eMax):e+eBias>=1?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));mLen>=8;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;eLen>0;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s}},pbf=Pbf$1,ieee754=ieee754$1;function Pbf$1(buf){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(buf)?buf:new Uint8Array(buf||0),this.pos=0,this.type=0,this.length=this.buf.length}Pbf$1.Varint=0,Pbf$1.Fixed64=1,Pbf$1.Bytes=2,Pbf$1.Fixed32=5;var utf8TextDecoder="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8");function readPackedEnd(pbf){return pbf.type===Pbf$1.Bytes?pbf.readVarint()+pbf.pos:pbf.pos+1}function toNum(low,high,isSigned){return isSigned?4294967296*high+(low>>>0):4294967296*(high>>>0)+(low>>>0)}function makeRoomForExtraLength(startPos,len,pbf){var extraLen=len<=16383?1:len<=2097151?2:len<=268435455?3:Math.floor(Math.log(len)/(7*Math.LN2));pbf.realloc(extraLen);for(var i=pbf.pos-1;i>=startPos;i--)pbf.buf[i+extraLen]=pbf.buf[i]}function _writePackedVarint(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeVarint(arr[i])}function _writePackedSVarint(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeSVarint(arr[i])}function _writePackedFloat(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeFloat(arr[i])}function _writePackedDouble(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeDouble(arr[i])}function _writePackedBoolean(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeBoolean(arr[i])}function _writePackedFixed(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeFixed32(arr[i])}function _writePackedSFixed(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeSFixed32(arr[i])}function _writePackedFixed2(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeFixed64(arr[i])}function _writePackedSFixed2(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeSFixed64(arr[i])}function readUInt32(buf,pos){return(buf[pos]|buf[pos+1]<<8|buf[pos+2]<<16)+16777216*buf[pos+3]}function writeInt32(buf,val,pos){buf[pos]=val,buf[pos+1]=val>>>8,buf[pos+2]=val>>>16,buf[pos+3]=val>>>24}function readInt32(buf,pos){return(buf[pos]|buf[pos+1]<<8|buf[pos+2]<<16)+(buf[pos+3]<<24)}Pbf$1.prototype={destroy:function(){this.buf=null},readFields:function(readField,result,end){for(end=end||this.length;this.pos<end;){var val=this.readVarint(),tag=val>>3,startPos=this.pos;this.type=7&val,readField(tag,result,this),this.pos===startPos&&this.skip(val)}return result},readMessage:function(readField,result){return this.readFields(readField,result,this.readVarint()+this.pos)},readFixed32:function(){var val=readUInt32(this.buf,this.pos);return this.pos+=4,val},readSFixed32:function(){var val=readInt32(this.buf,this.pos);return this.pos+=4,val},readFixed64:function(){var val=readUInt32(this.buf,this.pos)+4294967296*readUInt32(this.buf,this.pos+4);return this.pos+=8,val},readSFixed64:function(){var val=readUInt32(this.buf,this.pos)+4294967296*readInt32(this.buf,this.pos+4);return this.pos+=8,val},readFloat:function(){var val=ieee754.read(this.buf,this.pos,!0,23,4);return this.pos+=4,val},readDouble:function(){var val=ieee754.read(this.buf,this.pos,!0,52,8);return this.pos+=8,val},readVarint:function(isSigned){var val,b,buf=this.buf;return val=127&(b=buf[this.pos++]),b<128?val:(val|=(127&(b=buf[this.pos++]))<<7,b<128?val:(val|=(127&(b=buf[this.pos++]))<<14,b<128?val:(val|=(127&(b=buf[this.pos++]))<<21,b<128?val:function(l,s,p){var h,b,buf=p.buf;if(b=buf[p.pos++],h=(112&b)>>4,b<128)return toNum(l,h,s);if(b=buf[p.pos++],h|=(127&b)<<3,b<128)return toNum(l,h,s);if(b=buf[p.pos++],h|=(127&b)<<10,b<128)return toNum(l,h,s);if(b=buf[p.pos++],h|=(127&b)<<17,b<128)return toNum(l,h,s);if(b=buf[p.pos++],h|=(127&b)<<24,b<128)return toNum(l,h,s);if(b=buf[p.pos++],h|=(1&b)<<31,b<128)return toNum(l,h,s);throw new Error("Expected varint not more than 10 bytes")}(val|=(15&(b=buf[this.pos]))<<28,isSigned,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var num=this.readVarint();return num%2==1?(num+1)/-2:num/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var end=this.readVarint()+this.pos,pos=this.pos;return this.pos=end,end-pos>=12&&utf8TextDecoder?function(buf,pos,end){return utf8TextDecoder.decode(buf.subarray(pos,end))}(this.buf,pos,end):function(buf,pos,end){var str="",i=pos;for(;i<end;){var b1,b2,b3,b0=buf[i],c=null,bytesPerSequence=b0>239?4:b0>223?3:b0>191?2:1;if(i+bytesPerSequence>end)break;1===bytesPerSequence?b0<128&&(c=b0):2===bytesPerSequence?128==(192&(b1=buf[i+1]))&&(c=(31&b0)<<6|63&b1)<=127&&(c=null):3===bytesPerSequence?(b1=buf[i+1],b2=buf[i+2],128==(192&b1)&&128==(192&b2)&&((c=(15&b0)<<12|(63&b1)<<6|63&b2)<=2047||c>=55296&&c<=57343)&&(c=null)):4===bytesPerSequence&&(b1=buf[i+1],b2=buf[i+2],b3=buf[i+3],128==(192&b1)&&128==(192&b2)&&128==(192&b3)&&((c=(15&b0)<<18|(63&b1)<<12|(63&b2)<<6|63&b3)<=65535||c>=1114112)&&(c=null)),null===c?(c=65533,bytesPerSequence=1):c>65535&&(c-=65536,str+=String.fromCharCode(c>>>10&1023|55296),c=56320|1023&c),str+=String.fromCharCode(c),i+=bytesPerSequence}return str}(this.buf,pos,end)},readBytes:function(){var end=this.readVarint()+this.pos,buffer=this.buf.subarray(this.pos,end);return this.pos=end,buffer},readPackedVarint:function(arr,isSigned){if(this.type!==Pbf$1.Bytes)return arr.push(this.readVarint(isSigned));var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readVarint(isSigned));return arr},readPackedSVarint:function(arr){if(this.type!==Pbf$1.Bytes)return arr.push(this.readSVarint());var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readSVarint());return arr},readPackedBoolean:function(arr){if(this.type!==Pbf$1.Bytes)return arr.push(this.readBoolean());var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readBoolean());return arr},readPackedFloat:function(arr){if(this.type!==Pbf$1.Bytes)return arr.push(this.readFloat());var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readFloat());return arr},readPackedDouble:function(arr){if(this.type!==Pbf$1.Bytes)return arr.push(this.readDouble());var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readDouble());return arr},readPackedFixed32:function(arr){if(this.type!==Pbf$1.Bytes)return arr.push(this.readFixed32());var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readFixed32());return arr},readPackedSFixed32:function(arr){if(this.type!==Pbf$1.Bytes)return arr.push(this.readSFixed32());var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readSFixed32());return arr},readPackedFixed64:function(arr){if(this.type!==Pbf$1.Bytes)return arr.push(this.readFixed64());var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readFixed64());return arr},readPackedSFixed64:function(arr){if(this.type!==Pbf$1.Bytes)return arr.push(this.readSFixed64());var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readSFixed64());return arr},skip:function(val){var type=7&val;if(type===Pbf$1.Varint)for(;this.buf[this.pos++]>127;);else if(type===Pbf$1.Bytes)this.pos=this.readVarint()+this.pos;else if(type===Pbf$1.Fixed32)this.pos+=4;else{if(type!==Pbf$1.Fixed64)throw new Error("Unimplemented type: "+type);this.pos+=8}},writeTag:function(tag,type){this.writeVarint(tag<<3|type)},realloc:function(min){for(var length=this.length||16;length<this.pos+min;)length*=2;if(length!==this.length){var buf=new Uint8Array(length);buf.set(this.buf),this.buf=buf,this.length=length}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(val){this.realloc(4),writeInt32(this.buf,val,this.pos),this.pos+=4},writeSFixed32:function(val){this.realloc(4),writeInt32(this.buf,val,this.pos),this.pos+=4},writeFixed64:function(val){this.realloc(8),writeInt32(this.buf,-1&val,this.pos),writeInt32(this.buf,Math.floor(2.3283064365386963e-10*val),this.pos+4),this.pos+=8},writeSFixed64:function(val){this.realloc(8),writeInt32(this.buf,-1&val,this.pos),writeInt32(this.buf,Math.floor(2.3283064365386963e-10*val),this.pos+4),this.pos+=8},writeVarint:function(val){(val=+val||0)>268435455||val<0?function(val,pbf){var low,high;val>=0?(low=val%4294967296|0,high=val/4294967296|0):(high=~(-val/4294967296),4294967295^(low=~(-val%4294967296))?low=low+1|0:(low=0,high=high+1|0));if(val>=0x10000000000000000||val<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");pbf.realloc(10),function(low,high,pbf){pbf.buf[pbf.pos++]=127&low|128,low>>>=7,pbf.buf[pbf.pos++]=127&low|128,low>>>=7,pbf.buf[pbf.pos++]=127&low|128,low>>>=7,pbf.buf[pbf.pos++]=127&low|128,low>>>=7,pbf.buf[pbf.pos]=127&low}(low,0,pbf),function(high,pbf){var lsb=(7&high)<<4;if(pbf.buf[pbf.pos++]|=lsb|((high>>>=3)?128:0),!high)return;if(pbf.buf[pbf.pos++]=127&high|((high>>>=7)?128:0),!high)return;if(pbf.buf[pbf.pos++]=127&high|((high>>>=7)?128:0),!high)return;if(pbf.buf[pbf.pos++]=127&high|((high>>>=7)?128:0),!high)return;if(pbf.buf[pbf.pos++]=127&high|((high>>>=7)?128:0),!high)return;pbf.buf[pbf.pos++]=127&high}(high,pbf)}(val,this):(this.realloc(4),this.buf[this.pos++]=127&val|(val>127?128:0),val<=127||(this.buf[this.pos++]=127&(val>>>=7)|(val>127?128:0),val<=127||(this.buf[this.pos++]=127&(val>>>=7)|(val>127?128:0),val<=127||(this.buf[this.pos++]=val>>>7&127))))},writeSVarint:function(val){this.writeVarint(val<0?2*-val-1:2*val)},writeBoolean:function(val){this.writeVarint(Boolean(val))},writeString:function(str){str=String(str),this.realloc(4*str.length),this.pos++;var startPos=this.pos;this.pos=function(buf,str,pos){for(var c,lead,i=0;i<str.length;i++){if((c=str.charCodeAt(i))>55295&&c<57344){if(!lead){c>56319||i+1===str.length?(buf[pos++]=239,buf[pos++]=191,buf[pos++]=189):lead=c;continue}if(c<56320){buf[pos++]=239,buf[pos++]=191,buf[pos++]=189,lead=c;continue}c=lead-55296<<10|c-56320|65536,lead=null}else lead&&(buf[pos++]=239,buf[pos++]=191,buf[pos++]=189,lead=null);c<128?buf[pos++]=c:(c<2048?buf[pos++]=c>>6|192:(c<65536?buf[pos++]=c>>12|224:(buf[pos++]=c>>18|240,buf[pos++]=c>>12&63|128),buf[pos++]=c>>6&63|128),buf[pos++]=63&c|128)}return pos}(this.buf,str,this.pos);var len=this.pos-startPos;len>=128&&makeRoomForExtraLength(startPos,len,this),this.pos=startPos-1,this.writeVarint(len),this.pos+=len},writeFloat:function(val){this.realloc(4),ieee754.write(this.buf,val,this.pos,!0,23,4),this.pos+=4},writeDouble:function(val){this.realloc(8),ieee754.write(this.buf,val,this.pos,!0,52,8),this.pos+=8},writeBytes:function(buffer){var len=buffer.length;this.writeVarint(len),this.realloc(len);for(var i=0;i<len;i++)this.buf[this.pos++]=buffer[i]},writeRawMessage:function(fn,obj){this.pos++;var startPos=this.pos;fn(obj,this);var len=this.pos-startPos;len>=128&&makeRoomForExtraLength(startPos,len,this),this.pos=startPos-1,this.writeVarint(len),this.pos+=len},writeMessage:function(tag,fn,obj){this.writeTag(tag,Pbf$1.Bytes),this.writeRawMessage(fn,obj)},writePackedVarint:function(tag,arr){arr.length&&this.writeMessage(tag,_writePackedVarint,arr)},writePackedSVarint:function(tag,arr){arr.length&&this.writeMessage(tag,_writePackedSVarint,arr)},writePackedBoolean:function(tag,arr){arr.length&&this.writeMessage(tag,_writePackedBoolean,arr)},writePackedFloat:function(tag,arr){arr.length&&this.writeMessage(tag,_writePackedFloat,arr)},writePackedDouble:function(tag,arr){arr.length&&this.writeMessage(tag,_writePackedDouble,arr)},writePackedFixed32:function(tag,arr){arr.length&&this.writeMessage(tag,_writePackedFixed,arr)},writePackedSFixed32:function(tag,arr){arr.length&&this.writeMessage(tag,_writePackedSFixed,arr)},writePackedFixed64:function(tag,arr){arr.length&&this.writeMessage(tag,_writePackedFixed2,arr)},writePackedSFixed64:function(tag,arr){arr.length&&this.writeMessage(tag,_writePackedSFixed2,arr)},writeBytesField:function(tag,buffer){this.writeTag(tag,Pbf$1.Bytes),this.writeBytes(buffer)},writeFixed32Field:function(tag,val){this.writeTag(tag,Pbf$1.Fixed32),this.writeFixed32(val)},writeSFixed32Field:function(tag,val){this.writeTag(tag,Pbf$1.Fixed32),this.writeSFixed32(val)},writeFixed64Field:function(tag,val){this.writeTag(tag,Pbf$1.Fixed64),this.writeFixed64(val)},writeSFixed64Field:function(tag,val){this.writeTag(tag,Pbf$1.Fixed64),this.writeSFixed64(val)},writeVarintField:function(tag,val){this.writeTag(tag,Pbf$1.Varint),this.writeVarint(val)},writeSVarintField:function(tag,val){this.writeTag(tag,Pbf$1.Varint),this.writeSVarint(val)},writeStringField:function(tag,str){this.writeTag(tag,Pbf$1.Bytes),this.writeString(str)},writeFloatField:function(tag,val){this.writeTag(tag,Pbf$1.Fixed32),this.writeFloat(val)},writeDoubleField:function(tag,val){this.writeTag(tag,Pbf$1.Fixed64),this.writeDouble(val)},writeBooleanField:function(tag,val){this.writeVarintField(tag,Boolean(val))}};var pointGeometry=Point$2;function Point$2(x,y){this.x=x,this.y=y}Point$2.prototype={clone:function(){return new Point$2(this.x,this.y)},add:function(p){return this.clone()._add(p)},sub:function(p){return this.clone()._sub(p)},multByPoint:function(p){return this.clone()._multByPoint(p)},divByPoint:function(p){return this.clone()._divByPoint(p)},mult:function(k){return this.clone()._mult(k)},div:function(k){return this.clone()._div(k)},rotate:function(a){return this.clone()._rotate(a)},rotateAround:function(a,p){return this.clone()._rotateAround(a,p)},matMult:function(m){return this.clone()._matMult(m)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(other){return this.x===other.x&&this.y===other.y},dist:function(p){return Math.sqrt(this.distSqr(p))},distSqr:function(p){var dx=p.x-this.x,dy=p.y-this.y;return dx*dx+dy*dy},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(b){return Math.atan2(this.y-b.y,this.x-b.x)},angleWith:function(b){return this.angleWithSep(b.x,b.y)},angleWithSep:function(x,y){return Math.atan2(this.x*y-this.y*x,this.x*x+this.y*y)},_matMult:function(m){var x=m[0]*this.x+m[1]*this.y,y=m[2]*this.x+m[3]*this.y;return this.x=x,this.y=y,this},_add:function(p){return this.x+=p.x,this.y+=p.y,this},_sub:function(p){return this.x-=p.x,this.y-=p.y,this},_mult:function(k){return this.x*=k,this.y*=k,this},_div:function(k){return this.x/=k,this.y/=k,this},_multByPoint:function(p){return this.x*=p.x,this.y*=p.y,this},_divByPoint:function(p){return this.x/=p.x,this.y/=p.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var y=this.y;return this.y=this.x,this.x=-y,this},_rotate:function(angle){var cos=Math.cos(angle),sin=Math.sin(angle),x=cos*this.x-sin*this.y,y=sin*this.x+cos*this.y;return this.x=x,this.y=y,this},_rotateAround:function(angle,p){var cos=Math.cos(angle),sin=Math.sin(angle),x=p.x+cos*(this.x-p.x)-sin*(this.y-p.y),y=p.y+sin*(this.x-p.x)+cos*(this.y-p.y);return this.x=x,this.y=y,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},Point$2.convert=function(a){return a instanceof Point$2?a:Array.isArray(a)?new Point$2(a[0],a[1]):a};var vectorTile={},Point$1=pointGeometry,vectortilefeature=VectorTileFeature$2;function VectorTileFeature$2(pbf,end,extent,keys,values){this.properties={},this.extent=extent,this.type=0,this._pbf=pbf,this._geometry=-1,this._keys=keys,this._values=values,pbf.readFields(readFeature,this,end)}function readFeature(tag,feature,pbf){1==tag?feature.id=pbf.readVarint():2==tag?function(pbf,feature){var end=pbf.readVarint()+pbf.pos;for(;pbf.pos<end;){var key=feature._keys[pbf.readVarint()],value=feature._values[pbf.readVarint()];feature.properties[key]=value}}(pbf,feature):3==tag?feature.type=pbf.readVarint():4==tag&&(feature._geometry=pbf.pos)}function signedArea(ring){for(var p1,p2,sum=0,i=0,len=ring.length,j=len-1;i<len;j=i++)p1=ring[i],sum+=((p2=ring[j]).x-p1.x)*(p1.y+p2.y);return sum}VectorTileFeature$2.types=["Unknown","Point","LineString","Polygon"],VectorTileFeature$2.prototype.loadGeometry=function(){var pbf=this._pbf;pbf.pos=this._geometry;for(var line,end=pbf.readVarint()+pbf.pos,cmd=1,length=0,x=0,y=0,lines=[];pbf.pos<end;){if(length<=0){var cmdLen=pbf.readVarint();cmd=7&cmdLen,length=cmdLen>>3}if(length--,1===cmd||2===cmd)x+=pbf.readSVarint(),y+=pbf.readSVarint(),1===cmd&&(line&&lines.push(line),line=[]),line.push(new Point$1(x,y));else{if(7!==cmd)throw new Error("unknown command "+cmd);line&&line.push(line[0].clone())}}return line&&lines.push(line),lines},VectorTileFeature$2.prototype.bbox=function(){var pbf=this._pbf;pbf.pos=this._geometry;for(var end=pbf.readVarint()+pbf.pos,cmd=1,length=0,x=0,y=0,x1=1/0,x2=-1/0,y1=1/0,y2=-1/0;pbf.pos<end;){if(length<=0){var cmdLen=pbf.readVarint();cmd=7&cmdLen,length=cmdLen>>3}if(length--,1===cmd||2===cmd)(x+=pbf.readSVarint())<x1&&(x1=x),x>x2&&(x2=x),(y+=pbf.readSVarint())<y1&&(y1=y),y>y2&&(y2=y);else if(7!==cmd)throw new Error("unknown command "+cmd)}return[x1,y1,x2,y2]},VectorTileFeature$2.prototype.toGeoJSON=function(x,y,z){var i,j,size=this.extent*Math.pow(2,z),x0=this.extent*x,y0=this.extent*y,coords=this.loadGeometry(),type=VectorTileFeature$2.types[this.type];function project(line){for(var j=0;j<line.length;j++){var p=line[j],y2=180-360*(p.y+y0)/size;line[j]=[360*(p.x+x0)/size-180,360/Math.PI*Math.atan(Math.exp(y2*Math.PI/180))-90]}}switch(this.type){case 1:var points=[];for(i=0;i<coords.length;i++)points[i]=coords[i][0];project(coords=points);break;case 2:for(i=0;i<coords.length;i++)project(coords[i]);break;case 3:for(coords=function(rings){var len=rings.length;if(len<=1)return[rings];for(var polygon,ccw,polygons=[],i=0;i<len;i++){var area=signedArea(rings[i]);0!==area&&(void 0===ccw&&(ccw=area<0),ccw===area<0?(polygon&&polygons.push(polygon),polygon=[rings[i]]):polygon.push(rings[i]))}polygon&&polygons.push(polygon);return polygons}(coords),i=0;i<coords.length;i++)for(j=0;j<coords[i].length;j++)project(coords[i][j])}1===coords.length?coords=coords[0]:type="Multi"+type;var result={type:"Feature",geometry:{type:type,coordinates:coords},properties:this.properties};return"id"in this&&(result.id=this.id),result};var VectorTileFeature$1=vectortilefeature,vectortilelayer=VectorTileLayer$1;function VectorTileLayer$1(pbf,end){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=pbf,this._keys=[],this._values=[],this._features=[],pbf.readFields(readLayer,this,end),this.length=this._features.length}function readLayer(tag,layer,pbf){15===tag?layer.version=pbf.readVarint():1===tag?layer.name=pbf.readString():5===tag?layer.extent=pbf.readVarint():2===tag?layer._features.push(pbf.pos):3===tag?layer._keys.push(pbf.readString()):4===tag&&layer._values.push(function(pbf){var value=null,end=pbf.readVarint()+pbf.pos;for(;pbf.pos<end;){var tag=pbf.readVarint()>>3;value=1===tag?pbf.readString():2===tag?pbf.readFloat():3===tag?pbf.readDouble():4===tag?pbf.readVarint64():5===tag?pbf.readVarint():6===tag?pbf.readSVarint():7===tag?pbf.readBoolean():null}return value}(pbf))}VectorTileLayer$1.prototype.feature=function(i){if(i<0||i>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[i];var end=this._pbf.readVarint()+this._pbf.pos;return new VectorTileFeature$1(this._pbf,end,this.extent,this._keys,this._values)};var VectorTileLayer=vectortilelayer,vectortile=function(pbf,end){this.layers=pbf.readFields(readTile,{},end)};function readTile(tag,layers,pbf){if(3===tag){var layer=new VectorTileLayer(pbf,pbf.readVarint()+pbf.pos);layer.length&&(layers[layer.name]=layer)}}vectorTile.VectorTile=vectortile,vectorTile.VectorTileFeature=vectortilefeature,vectorTile.VectorTileLayer=vectortilelayer;var Point=pointGeometry,VectorTileFeature=vectorTile.VectorTileFeature,geojson_wrapper=GeoJSONWrapper$1;function GeoJSONWrapper$1(features,options){this.options=options||{},this.features=features,this.length=features.length}function FeatureWrapper(feature,extent){this.id="number"==typeof feature.id?feature.id:void 0,this.type=feature.type,this.rawGeometry=1===feature.type?[feature.geometry]:feature.geometry,this.properties=feature.tags,this.extent=extent||4096}GeoJSONWrapper$1.prototype.feature=function(i){return new FeatureWrapper(this.features[i],this.options.extent)},FeatureWrapper.prototype.loadGeometry=function(){var rings=this.rawGeometry;this.geometry=[];for(var i=0;i<rings.length;i++){for(var ring=rings[i],newRing=[],j=0;j<ring.length;j++)newRing.push(new Point(ring[j][0],ring[j][1]));this.geometry.push(newRing)}return this.geometry},FeatureWrapper.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var rings=this.geometry,x1=1/0,x2=-1/0,y1=1/0,y2=-1/0,i=0;i<rings.length;i++)for(var ring=rings[i],j=0;j<ring.length;j++){var coord=ring[j];x1=Math.min(x1,coord.x),x2=Math.max(x2,coord.x),y1=Math.min(y1,coord.y),y2=Math.max(y2,coord.y)}return[x1,y1,x2,y2]},FeatureWrapper.prototype.toGeoJSON=VectorTileFeature.prototype.toGeoJSON;var Pbf=pbf,GeoJSONWrapper=geojson_wrapper;function fromVectorTileJs(tile){var out=new Pbf;return function(tile,pbf){for(var key in tile.layers)pbf.writeMessage(3,writeLayer,tile.layers[key])}(tile,out),out.finish()}function writeLayer(layer,pbf){var i;pbf.writeVarintField(15,layer.version||1),pbf.writeStringField(1,layer.name||""),pbf.writeVarintField(5,layer.extent||4096);var context={keys:[],values:[],keycache:{},valuecache:{}};for(i=0;i<layer.length;i++)context.feature=layer.feature(i),pbf.writeMessage(2,writeFeature,context);var keys=context.keys;for(i=0;i<keys.length;i++)pbf.writeStringField(3,keys[i]);var values=context.values;for(i=0;i<values.length;i++)pbf.writeMessage(4,writeValue,values[i])}function writeFeature(context,pbf){var feature=context.feature;void 0!==feature.id&&pbf.writeVarintField(1,feature.id),pbf.writeMessage(2,writeProperties,context),pbf.writeVarintField(3,feature.type),pbf.writeMessage(4,writeGeometry,feature)}function writeProperties(context,pbf){var feature=context.feature,keys=context.keys,values=context.values,keycache=context.keycache,valuecache=context.valuecache;for(var key in feature.properties){var value=feature.properties[key],keyIndex=keycache[key];if(null!==value){void 0===keyIndex&&(keys.push(key),keyIndex=keys.length-1,keycache[key]=keyIndex),pbf.writeVarint(keyIndex);var type=typeof value;"string"!==type&&"boolean"!==type&&"number"!==type&&(value=JSON.stringify(value));var valueKey=type+":"+value,valueIndex=valuecache[valueKey];void 0===valueIndex&&(values.push(value),valueIndex=values.length-1,valuecache[valueKey]=valueIndex),pbf.writeVarint(valueIndex)}}}function command(cmd,length){return(length<<3)+(7&cmd)}function zigzag(num){return num<<1^num>>31}function writeGeometry(feature,pbf){for(var geometry=feature.loadGeometry(),type=feature.type,x=0,y=0,rings=geometry.length,r=0;r<rings;r++){var ring=geometry[r],count=1;1===type&&(count=ring.length),pbf.writeVarint(command(1,count));for(var lineCount=3===type?ring.length-1:ring.length,i=0;i<lineCount;i++){1===i&&1!==type&&pbf.writeVarint(command(2,lineCount-1));var dx=ring[i].x-x,dy=ring[i].y-y;pbf.writeVarint(zigzag(dx)),pbf.writeVarint(zigzag(dy)),x+=dx,y+=dy}3===type&&pbf.writeVarint(command(7,1))}}function writeValue(value,pbf){var type=typeof value;"string"===type?pbf.writeStringField(1,value):"boolean"===type?pbf.writeBooleanField(7,value):"number"===type&&(value%1!=0?pbf.writeDoubleField(3,value):value<0?pbf.writeSVarintField(6,value):pbf.writeVarintField(5,value))}vtPbf.exports=fromVectorTileJs,vtPbf.exports.fromVectorTileJs=fromVectorTileJs,vtPbf.exports.fromGeojsonVt=function(layers,options){options=options||{};var l={};for(var k in layers)l[k]=new GeoJSONWrapper(layers[k].features,options),l[k].name=k,l[k].version=options.version,l[k].extent=options.extent;return fromVectorTileJs({layers:l})},vtPbf.exports.GeoJSONWrapper=GeoJSONWrapper;var vtpbf=vtPbf.exports,tileImageCache=new LRUCache(200,function(image){disposeImage(image)}),tileBufferCache=new LRUCache(200,function(buffer){}),CONTROLCACHE={};function cacheFetch(taskId,control){CONTROLCACHE[taskId]=CONTROLCACHE[taskId]||[],CONTROLCACHE[taskId].push(control)}function finishFetch(control){var deletekeys=[];for(var key in CONTROLCACHE){var controlList=CONTROLCACHE[key]||[];if(controlList.length){var index=controlList.indexOf(control);index>-1&&controlList.splice(index,1)}0===controlList.length&&deletekeys.push(key)}deletekeys.forEach(function(key){delete CONTROLCACHE[key]})}function generateFetchOptions(headers,options){var fetchOptions=options.fetchOptions||{headers:headers,referrer:options.referrer},timeout=options.timeout||0,control=new AbortController,signal=control.signal;return timeout&&isNumber$1(timeout)&&timeout>0&&setTimeout(function(){control.abort(FetchTimeoutError)},timeout),fetchOptions.signal=signal,delete fetchOptions.timeout,{fetchOptions:fetchOptions,control:control}}function fetchTile(url,headers={},options){return new Promise(function(resolve,reject){var copyImageBitMap=function(image){createImageBitmap(image).then(function(imagebit){resolve(imagebit)}).catch(function(error){reject(error)})};if(isImageBitmap(url))copyImageBitMap(url);else{var{indexedDBCache:indexedDBCache}=options,fetchTileData=function(){var taskId=options.__taskId;if(taskId){var image=tileImageCache.get(url);if(image)copyImageBitMap(image);else{var{fetchOptions:fetchOptions,control:control}=generateFetchOptions(headers,options);cacheFetch(taskId,control),fetch(url,fetchOptions).then(function(res){return res.ok||reject(createNetWorkError(url)),res.blob()}).then(function(blob){return createImageBitmap(blob)}).then(function(image){!0!==options.disableCache&&tileImageCache.add(url,image),indexedDBCache&&storeTile(url,image),finishFetch(control),copyImageBitMap(image)}).catch(function(error){finishFetch(control),reject(error)})}}else reject(createInnerError("taskId is null"))};indexedDBCache?getStoreTile(url).then(function(image){image&&indexedDBCache?copyImageBitMap(image):fetchTileData()}).catch(function(){}):fetchTileData()}})}function fetchTileBuffer(url,headers={},options){return new Promise(function(resolve,reject){var copyBuffer=function(buffer){resolve(buffer)},taskId=options.__taskId;if(taskId){var buffer=tileBufferCache.get(url);if(buffer)copyBuffer(buffer);else{var{indexedDBCache:indexedDBCache}=options,fetchTileData=function(){var{fetchOptions:fetchOptions,control:control}=generateFetchOptions(headers,options);cacheFetch(taskId,control),fetch(url,fetchOptions).then(function(res){return res.ok||reject(createNetWorkError(url)),res.arrayBuffer()}).then(function(buffer){!0!==options.disableCache&&tileBufferCache.add(url,buffer),finishFetch(control),indexedDBCache&&storeTile(url,buffer),copyBuffer(buffer)}).catch(function(error){finishFetch(control),reject(error)})};if(!indexedDBCache)return void fetchTileData();getStoreTile(url).then(function(buffer){buffer&&indexedDBCache?copyBuffer(buffer):fetchTileData()}).catch(function(){})}}else reject(createInnerError("taskId is null"))})}function getTileWithMaxZoom(options){var{urlTemplate:urlTemplate,x:x,y:y,z:z,maxAvailableZoom:maxAvailableZoom,subdomains:subdomains,globalCompositeOperation:globalCompositeOperation}=options;return new Promise(function(resolve,reject){for(var dxScale,dyScale,wScale,hScale,urlTemplates=checkTileUrl(urlTemplate),i=0,len=urlTemplates.length;i<len;i++){if(!validateSubdomains(urlTemplates[i],subdomains))return void reject(createParamsValidateError("not find subdomains"))}var tileX=x,tileY=y,tileZ=z,zoomOffset=z-maxAvailableZoom;if(zoomOffset>0){for(var px=x,py=y,zoom=z;zoom>maxAvailableZoom;)px=Math.floor(px/2),py=Math.floor(py/2),zoom--;var scale=Math.pow(2,zoomOffset),startX=Math.floor(px*scale),endX=startX+scale,startY=Math.floor(py*scale),endY=startY+scale;startX>x&&(startX--,endX--),startY>y&&(startY--,endY--),dxScale=(x-startX)/(endX-startX),dyScale=(y-startY)/(endY-startY),wScale=1/(endX-startX),hScale=1/(endY-startY),tileX=px,tileY=py,tileZ=maxAvailableZoom}var urls=urlTemplates.map(function(urlTemplate){return getTileUrl(urlTemplate,tileX,tileY,tileZ,subdomains)}),headers=Object.assign({},HEADERS,options.headers||{}),fetchTiles=urls.map(function(url){return fetchTile(url,headers,options)});Promise.all(fetchTiles).then(function(imagebits){var image=mergeTiles(imagebits,globalCompositeOperation);if(image instanceof Error)reject(image);else{var sliceImage,postImage=postProcessingImage(image,options);if(zoomOffset<=0)sliceImage=postImage;else{var{width:width,height:height}=postImage;sliceImage=function(image,dx,dy,w,h){var canvas=getCanvas(image.width);resizeCanvas(canvas,image.width,image.height);var ctx=getCanvasContext(canvas);ctx.save(),ctx.drawImage(image,dx,dy,w,h,0,0,canvas.width,canvas.height),ctx.restore();var bitImage=canvas.transferToImageBitmap();return disposeImage(image),bitImage}(postImage,width*dxScale,height*dyScale,width*wScale,height*hScale)}createImageBlobURL(getCanvas(),sliceImage,options).then(function(url){resolve(url)}).catch(function(error){reject(error)})}}).catch(function(error){reject(error)})})}function encodeTerrainTile(url,options){return new Promise(function(resolve,reject){var urls=checkTileUrl(url),headers=Object.assign({},HEADERS,options.headers||{}),{terrainWidth:terrainWidth,tileSize:tileSize,terrainType:terrainType,minHeight:minHeight,maxHeight:maxHeight,terrainColors:terrainColors}=options,returnImage=function(terrainImage){createImageBlobURL(getCanvas(),terrainImage,options).then(function(url){resolve(url)}).catch(function(error){reject(error)})},isMapZen="mapzen"===terrainType,isTianditu="tianditu"===terrainType,isCesium="cesium"===terrainType,isArcgis="arcgis"===terrainType;if(isMapZen||"qgis-gray"===terrainType){var fetchTiles=urls.map(function(tileUrl){return fetchTile(tileUrl,headers,options)});Promise.all(fetchTiles).then(function(imagebits){var canvas=getCanvas(),image=mergeTiles(imagebits);if(image instanceof Error)reject(image);else{resizeCanvas(canvas,image.width,image.height);var ctx=getCanvasContext(canvas);ctx.drawImage(image,0,0);var imageData=ctx.getImageData(0,0,canvas.width,canvas.height);isMapZen?function(imageData){for(var data=imageData.data,out=[0,0,0],i=0,len=data.length;i<len;i+=4){var r=data[i],g=data[i+1],b=data[i+2];if(0!==data[i+3]){var height=256*r+g+b/256-32768,[r1,g1,b1]=encodeMapBox(height,out);data[i]=r1,data[i+1]=g1,data[i+2]=b1}}}(imageData):function(imageData,minHeight,maxHeight){for(var data=imageData.data,ah=(maxHeight-minHeight)/16777216,i=0,len=data.length;i<len;i+=4){var r=data[i],g=data[i+1],b=data[i+2];if(0!==data[i+3]){var height=b*ah+256*g*ah+256*r*256*ah+minHeight,[r1,g1,b1]=encodeMapBox(height);data[i]=r1,data[i+1]=g1,data[i+2]=b1}}}(imageData,minHeight,maxHeight),ctx.putImageData(imageData,0,0);var terrainImage=canvas.transferToImageBitmap();returnImage(colorsTerrainTile(terrainColors,terrainImage))}}).catch(function(error){reject(error)})}else if(isTianditu||isCesium||isArcgis){var _fetchTiles=urls.map(function(tileUrl){return fetchTileBuffer(tileUrl,headers,options)});Promise.all(_fetchTiles).then(function(buffers){if(buffers&&0!==buffers.length){var result,buffer=buffers[0];if(0!==buffer.byteLength)isTianditu?result=generateTiandituTerrain(buffer,terrainWidth,tileSize):isCesium?result=cesiumTerrainToHeights(buffer,terrainWidth,tileSize):isArcgis&&((result=lerc.exports.decode(buffer)).image=function(result){var{width:width,height:height,pixels:pixels}=result,canvas=getCanvas();resizeCanvas(canvas,width,height);var ctx=getCanvasContext(canvas);if(!pixels||0===pixels.length)return null;for(var heights=pixels[0],imageData=ctx.createImageData(width,height),i=0,len=imageData.data.length;i<len;i+=4){var _height2=heights[i/4],[r,g,b]=encodeMapBox(_height2);imageData.data[i]=r,imageData.data[i+1]=g,imageData.data[i+2]=b,imageData.data[i+3]=255}return ctx.putImageData(imageData,0,0),canvas.transferToImageBitmap()}(result)),result&&result.image?returnImage(colorsTerrainTile(terrainColors,result.image)):reject(createInnerError("generate terrain data error,not find image data"));else reject(createDataError("buffer is empty"))}else reject(createDataError("buffers is null"))}).catch(function(error){reject(error)})}else reject(createParamsValidateError("not support terrainType:"+terrainType))})}function getVTTile(url,options){return new Promise(function(resolve,reject){var urls=checkTileUrl(url),headers=Object.assign({},HEADERS,options.headers||{}),fetchTiles=urls.map(function(tileUrl){return fetchTileBuffer(tileUrl,headers,options)});Promise.all(fetchTiles).then(function(buffers){var buffer,array;if(buffers=buffers.filter(function(buffer){return!!buffer}),buffers&&0!==buffers.length)if(1===buffers.length)resolve((buffer=buffers[0],array=new Uint8Array(buffer),new Uint8Array(array).buffer));else{var mergeTile=new VectorTile$1(new Pbf$2(buffers[0]));buffers.slice(1,1/0).forEach(function(buffer){var tile=new VectorTile$1(new Pbf$2(buffer));Object.assign(mergeTile.layers,tile.layers)});var data=vtpbf(mergeTile);resolve(data.buffer)}else reject(createDataError("buffers is null"))}).catch(function(error){reject(error)})})}function imageToBlobURL(options){return new Promise(function(resolve,reject){var debug=options.debug,items=options.items,workerId=options._workerId,temp=[];items.forEach(function(item,index){var canvas=new OffscreenCanvas(item.width,item.height);debug&&console.log("workerId:"+workerId+",image to blob url :"+(index+1)+"/"+items.length),createImageBlobURL(canvas,item.image,options).then(function(url){item.url=url,temp.push(1),delete item.image,temp.length===items.length&&resolve(items)}).catch(function(error){console.error(error),reject(error)})})})}function bboxIntersect(bbox1,bbox2){return!(bbox1[2]<bbox2[0])&&(!(bbox1[1]>bbox2[3])&&(!(bbox1[0]>bbox2[2])&&!(bbox1[3]<bbox2[1])))}function bboxInBBOX(bbox1,bbox2){var[x1,y1,x2,y2]=bbox1;return x1>=bbox2[0]&&x2<=bbox2[2]&&y1>=bbox2[1]&&y2<=bbox2[3]}function bboxToPoints(bbox){var[minx,miny,maxx,maxy]=bbox;return[[minx,miny],[maxx,miny],[maxx,maxy],[minx,maxy]]}function pointsToBBOX(points){var xmin=1/0,ymin=1/0,xmax=-1/0,ymax=-1/0;return points.forEach(function(point){xmin=Math.min(xmin,point[0]),xmax=Math.max(xmax,point[0]),ymin=Math.min(ymin,point[1]),ymax=Math.max(ymax,point[1])}),[xmin,ymin,xmax,ymax]}function feature(f,b){geometry(f.geometry,b)}function geometry(g,b){if(g)switch(g.type){case"Point":point(g.coordinates,b);break;case"MultiPoint":case"LineString":line(g.coordinates,b);break;case"MultiLineString":!function(ml,b){for(var i=0,len=ml.length;i<len;i++)line(ml[i],b)}(g.coordinates,b);break;case"Polygon":polygon(g.coordinates,b);break;case"MultiPolygon":!function(mp,b){for(var i=0,len=mp.length;i<len;i++)polygon(mp[i],b)}(g.coordinates,b);break;case"GeometryCollection":for(var len=g.geometries.length,i=0;i<len;i++)geometry(g.geometries[i],b)}}function point(p,b){b[0]=Math.min(b[0],p[0]),b[1]=Math.min(b[1],p[1]),b[2]=Math.max(b[2],p[0]),b[3]=Math.max(b[3],p[1])}function line(l,b){for(var i=0,len=l.length;i<len;i++)point(l[i],b)}function polygon(p,b){p.length&&line(p[0],b)}var bbox_cjs=function(geojson){var b=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];switch(geojson.type){case"FeatureCollection":for(var len=geojson.features.length,i=0;i<len;i++)feature(geojson.features[i],b);break;case"Feature":feature(geojson,b);break;default:geometry(geojson,b)}return b},lineclip_1=lineclip;function lineclip(points,bbox,result){var i,a,b,codeB,lastCode,len=points.length,codeA=bitCode(points[0],bbox),part=[];for(result||(result=[]),i=1;i<len;i++){for(a=points[i-1],codeB=lastCode=bitCode(b=points[i],bbox);;){if(!(codeA|codeB)){part.push(a),codeB!==lastCode?(part.push(b),i<len-1&&(result.push(part),part=[])):i===len-1&&part.push(b);break}if(codeA&codeB)break;codeA?codeA=bitCode(a=intersect(a,b,codeA,bbox),bbox):codeB=bitCode(b=intersect(a,b,codeB,bbox),bbox)}codeA=lastCode}return part.length&&result.push(part),result}function intersect(a,b,edge,bbox){return 8&edge?[a[0]+(b[0]-a[0])*(bbox[3]-a[1])/(b[1]-a[1]),bbox[3]]:4&edge?[a[0]+(b[0]-a[0])*(bbox[1]-a[1])/(b[1]-a[1]),bbox[1]]:2&edge?[bbox[2],a[1]+(b[1]-a[1])*(bbox[2]-a[0])/(b[0]-a[0])]:1&edge?[bbox[0],a[1]+(b[1]-a[1])*(bbox[0]-a[0])/(b[0]-a[0])]:null}function bitCode(p,bbox){var code=0;return p[0]<bbox[0]?code|=1:p[0]>bbox[2]&&(code|=2),p[1]<bbox[1]?code|=4:p[1]>bbox[3]&&(code|=8),code}lineclip.polyline=lineclip,lineclip.polygon=function(points,bbox){var result,edge,prev,prevInside,i,p,inside;for(edge=1;edge<=8;edge*=2){for(result=[],prevInside=!(bitCode(prev=points[points.length-1],bbox)&edge),i=0;i<points.length;i++)(inside=!(bitCode(p=points[i],bbox)&edge))!==prevInside&&result.push(intersect(prev,p,edge,bbox)),inside&&result.push(p),prev=p,prevInside=inside;if(!(points=result).length)break}return result};var GeoJSONCache={};function injectMask(maskId,geojson){return function(feature){if(!feature)return!1;var type=(feature.geometry||{type:null}).type;return"Polygon"===type||"MultiPolygon"===type}(geojson)?(GeoJSONCache[maskId]=geojson,function(feature){feature.bbox=feature.bbox||bbox_cjs(feature)}(geojson),geojson):createParamsValidateError("geojson.feature is not Polygon")}function transformCoordinates(projection,coordinates){if(isEPSG3857(projection)){var _transformRing=function(coord){for(var result=[],i=0,len=coord.length;i<len;i++){var c=coord[i];Array.isArray(c[0])?result.push(_transformRing(c)):result[i]=lnglat2Mercator(c)}return result};return _transformRing(coordinates)}return coordinates}function coordinate2Pixel(tileBBOX,tileSize,coordinate){var[minx,miny,maxx,maxy]=tileBBOX,ax=(maxx-minx)/tileSize,ay=(maxy-miny)/tileSize,[x,y]=coordinate;return[(x-minx)/ax,tileSize-(y-miny)/ay]}function transformPixels(projection,tileBBOX,tileSize,coordinates){var[minx,miny,maxx,maxy]=tileBBOX,_transformRing2=function(coord,bbox){for(var result=[],i=0,len=coord.length;i<len;i++){var c=coord[i];Array.isArray(c[0])?result.push(_transformRing2(c,bbox)):result[i]=coordinate2Pixel(bbox,tileSize,c)}return result};if(isEPSG3857(projection)){var[mminx,mminy]=lnglat2Mercator([minx,miny]),[mmaxx,mmaxy]=lnglat2Mercator([maxx,maxy]);return _transformRing2(coordinates,[mminx,mminy,mmaxx,mmaxy])}return _transformRing2(coordinates,tileBBOX)}var validateClipRing=function(result){if(result.length>0){for(var minx=1/0,maxx=-1/0,miny=1/0,maxy=-1/0,j=0,len1=result.length;j<len1;j++){var[x,y]=result[j];minx=Math.min(x,minx),miny=Math.min(y,miny),maxx=Math.max(x,maxx),maxy=Math.max(y,maxy)}if(minx!==maxx&&miny!==maxy)return!0}return!1};function clipPolygons(polygons,tileBBOX){for(var clipRings=[],i=0,len=polygons.length;i<len;i++)for(var polygon=polygons[i],j=0,len1=polygon.length;j<len1;j++){var ring=polygon[j],result=lineclip_1.polygon(ring,tileBBOX);validateClipRing(result)&&clipRings.push([result])}return clipRings}function _classPrivateFieldLooseBase(e,t){if(!{}.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var id=0;function _classPrivateFieldLooseKey(e){return"__private_"+id+++"_"+e}var D2R$1=Math.PI/180,R2D$1=180/Math.PI,A$1=6378137,MAXEXTENT$1=20037508.342789244,cache={};function isFloat(n){return Number(n)===n&&n%1!=0}var _to,_to2,_to3,_to4,_to5,_size=_classPrivateFieldLooseKey("size"),_expansion=_classPrivateFieldLooseKey("expansion"),_Bc=_classPrivateFieldLooseKey("Bc"),_Cc=_classPrivateFieldLooseKey("Cc"),_zc=_classPrivateFieldLooseKey("zc"),_Ac=_classPrivateFieldLooseKey("Ac");
/**
     * @preserve
     * gcoord 1.0.7, geographic coordinate library
     * Copyright (c) 2025 Jiulong Hu <me@hujiulong.com>
     */
var{sin:sin$1,cos:cos$1,sqrt:sqrt$1,abs:abs$1,PI:PI$1}=Math,a=6378245,ee=.006693421622965823;function isInChinaBbox(lon,lat){return lon>=72.004&&lon<=137.8347&&lat>=.8293&&lat<=55.8271}function delta(lon,lat){var x,y,ret,dLon=(ret=300+(x=lon-105)+2*(y=lat-35)+.1*x*x+.1*x*y+.1*sqrt$1(abs$1(x)),ret+=2*(20*sin$1(6*x*PI$1)+20*sin$1(2*x*PI$1))/3,(ret+=2*(20*sin$1(x*PI$1)+40*sin$1(x/3*PI$1))/3)+2*(150*sin$1(x/12*PI$1)+300*sin$1(x/30*PI$1))/3),dLat=function(x,y){var ret=2*x-100+3*y+.2*y*y+.1*x*y+.2*sqrt$1(abs$1(x));return ret+=2*(20*sin$1(6*x*PI$1)+20*sin$1(2*x*PI$1))/3,ret+=2*(20*sin$1(y*PI$1)+40*sin$1(y/3*PI$1))/3,ret+2*(160*sin$1(y/12*PI$1)+320*sin$1(y*PI$1/30))/3}(lon-105,lat-35),radLat=lat/180*PI$1,magic=sin$1(radLat),sqrtMagic=sqrt$1(magic=1-ee*magic*magic);return[dLon=180*dLon/(a/sqrtMagic*cos$1(radLat)*PI$1),dLat=180*dLat/(a*(1-ee)/(magic*sqrtMagic)*PI$1)]}function WGS84ToGCJ02(coord){var[lon,lat]=coord;if(!isInChinaBbox(lon,lat))return[lon,lat];var d=delta(lon,lat);return[lon+d[0],lat+d[1]]}function GCJ02ToWGS84(coord){var[lon,lat]=coord;if(!isInChinaBbox(lon,lat))return[lon,lat];for(var[wgsLon,wgsLat]=[lon,lat],tempPoint=WGS84ToGCJ02([wgsLon,wgsLat]),dx=tempPoint[0]-lon,dy=tempPoint[1]-lat;abs$1(dx)>1e-6||abs$1(dy)>1e-6;)dx=(tempPoint=WGS84ToGCJ02([wgsLon-=dx,wgsLat-=dy]))[0]-lon,dy=tempPoint[1]-lat;return[wgsLon,wgsLat]}var{sin:sin,cos:cos,atan2:atan2,sqrt:sqrt,PI:PI}=Math,baiduFactor=3e3*PI/180;function BD09ToGCJ02(coord){var[lon,lat]=coord,x=lon-.0065,y=lat-.006,z=sqrt(x*x+y*y)-2e-5*sin(y*baiduFactor),theta=atan2(y,x)-3e-6*cos(x*baiduFactor);return[z*cos(theta),z*sin(theta)]}function GCJ02ToBD09(coord){var[lon,lat]=coord,x=lon,y=lat,z=sqrt(x*x+y*y)+2e-5*sin(y*baiduFactor),theta=atan2(y,x)+3e-6*cos(x*baiduFactor);return[z*cos(theta)+.0065,z*sin(theta)+.006]}var R2D=180/Math.PI,D2R=Math.PI/180,A=6378137,MAXEXTENT=20037508.342789244;function EPSG3857ToWGS84(xy){return[xy[0]*R2D/A,(.5*Math.PI-2*Math.atan(Math.exp(-xy[1]/A)))*R2D]}function WGS84ToEPSG3857(lonLat){var adjusted=Math.abs(lonLat[0])<=180?lonLat[0]:lonLat[0]-360*(lonLat[0]<0?-1:1),xy=[A*adjusted*D2R,A*Math.log(Math.tan(.25*Math.PI+.5*lonLat[1]*D2R))];return xy[0]>MAXEXTENT&&(xy[0]=MAXEXTENT),xy[0]<-MAXEXTENT&&(xy[0]=-MAXEXTENT),xy[1]>MAXEXTENT&&(xy[1]=MAXEXTENT),xy[1]<-MAXEXTENT&&(xy[1]=-MAXEXTENT),xy}var CRSTypes,{abs:abs}=Math,MCBAND=[12890594.86,8362377.87,5591021,3481989.83,1678043.12,0],LLBAND=[75,60,45,30,15,0],MC2LL=[[1.410526172116255e-8,898305509648872e-20,-1.9939833816331,200.9824383106796,-187.2403703815547,91.6087516669843,-23.38765649603339,2.57121317296198,-.03801003308653,17337981.2],[-7.435856389565537e-9,8983055097726239e-21,-.78625201886289,96.32687599759846,-1.85204757529826,-59.36935905485877,47.40033549296737,-16.50741931063887,2.28786674699375,10260144.86],[-3.030883460898826e-8,898305509983578e-20,.30071316287616,59.74293618442277,7.357984074871,-25.38371002664745,13.45380521110908,-3.29883767235584,.32710905363475,6856817.37],[-1.981981304930552e-8,8983055099779535e-21,.03278182852591,40.31678527705744,.65659298677277,-4.44255534477492,.85341911805263,.12923347998204,-.04625736007561,4482777.06],[3.09191371068437e-9,8983055096812155e-21,6995724062e-14,23.10934304144901,-.00023663490511,-.6321817810242,-.00663494467273,.03430082397953,-.00466043876332,2555164.4],[2.890871144776878e-9,8983055095805407e-21,-3.068298e-8,7.47137025468032,-353937994e-14,-.02145144861037,-1234426596e-14,.00010322952773,-323890364e-14,826088.5]],LL2MC=[[-.0015702102444,111320.7020616939,0x60e374c3105a3,-0x24bb4115e2e164,0x5cc55543bb0ae8,-0x7ce070193f3784,0x5e7ca61ddf8150,-0x261a578d8b24d0,0x665d60f3742ca,82.5],[.0008277824516172526,111320.7020463578,647795574.6671607,-4082003173.641316,10774905663.51142,-15171875531.51559,12053065338.62167,-5124939663.577472,913311935.9512032,67.5],[.00337398766765,111320.7020202162,4481351.045890365,-23393751.19931662,79682215.47186455,-115964993.2797253,97236711.15602145,-43661946.33752821,8477230.501135234,52.5],[.00220636496208,111320.7020209128,51751.86112841131,3796837.749470245,992013.7397791013,-1221952.21711287,1340652.697009075,-620943.6990984312,144416.9293806241,37.5],[-.0003441963504368392,111320.7020576856,278.2353980772752,2485758.690035394,6070.750963243378,54821.18345352118,9540.606633304236,-2710.55326746645,1405.483844121726,22.5],[-.0003218135878613132,111320.7020701615,.00369383431289,823725.6402795718,.46104986909093,2351.343141331292,1.58060784298199,8.77738589078284,.37238884252424,7.45]];function transform$1(x,y,factors){var cc=abs(y)/factors[9],xt=factors[0]+factors[1]*abs(x),yt=factors[2]+factors[3]*cc+factors[4]*Math.pow(cc,2)+factors[5]*Math.pow(cc,3)+factors[6]*Math.pow(cc,4)+factors[7]*Math.pow(cc,5)+factors[8]*Math.pow(cc,6);return[xt*=x<0?-1:1,yt*=y<0?-1:1]}function BD09toBD09MC(coord){for(var[lng,lat]=coord,factors=[],i=0;i<LLBAND.length;i++)if(abs(lat)>LLBAND[i]){factors=LL2MC[i];break}return transform$1(lng,lat,factors)}function BD09MCtoBD09(coord){for(var[x,y]=coord,factors=[],i=0;i<MCBAND.length;i++)if(abs(y)>=MCBAND[i]){factors=MC2LL[i];break}return transform$1(x,y,factors)}function assert(condition,msg){if(!condition)throw new Error(msg)}function isArray(input){return!!input&&"[object Array]"===Object.prototype.toString.call(input)}function isNumber(input){return!isNaN(Number(input))&&null!==input&&!isArray(input)}function compose(...funcs){var start=funcs.length-1;return function(...args){for(var i=start,result=funcs[start].apply(null,args);i--;)result=funcs[i].call(null,result);return result}}function coordEach(geojson,callback,excludeWrapCoord=!1){if(null!==geojson)for(var j,k,l,geometry,coords,stopG,geometryMaybeCollection,isGeometryCollection,wrapShrink=0,coordIndex=0,{type:type}=geojson,isFeatureCollection="FeatureCollection"===type,isFeature="Feature"===type,stop=isFeatureCollection?geojson.features.length:1,featureIndex=0;featureIndex<stop;featureIndex++){stopG=(isGeometryCollection=!!(geometryMaybeCollection=isFeatureCollection?geojson.features[featureIndex].geometry:isFeature?geojson.geometry:geojson)&&"GeometryCollection"===geometryMaybeCollection.type)?geometryMaybeCollection.geometries.length:1;for(var geomIndex=0;geomIndex<stopG;geomIndex++){var multiFeatureIndex=0,geometryIndex=0;if(null!==(geometry=isGeometryCollection?geometryMaybeCollection.geometries[geomIndex]:geometryMaybeCollection)){var geomType=geometry.type;switch(wrapShrink=!excludeWrapCoord||"Polygon"!==geomType&&"MultiPolygon"!==geomType?0:1,geomType){case null:break;case"Point":if(!1===callback(coords=geometry.coordinates,coordIndex,featureIndex,multiFeatureIndex,geometryIndex))return!1;coordIndex++,multiFeatureIndex++;break;case"LineString":case"MultiPoint":for(coords=geometry.coordinates,j=0;j<coords.length;j++){if(!1===callback(coords[j],coordIndex,featureIndex,multiFeatureIndex,geometryIndex))return!1;coordIndex++,"MultiPoint"===geomType&&multiFeatureIndex++}"LineString"===geomType&&multiFeatureIndex++;break;case"Polygon":case"MultiLineString":for(coords=geometry.coordinates,j=0;j<coords.length;j++){for(k=0;k<coords[j].length-wrapShrink;k++){if(!1===callback(coords[j][k],coordIndex,featureIndex,multiFeatureIndex,geometryIndex))return!1;coordIndex++}"MultiLineString"===geomType&&multiFeatureIndex++,"Polygon"===geomType&&geometryIndex++}"Polygon"===geomType&&multiFeatureIndex++;break;case"MultiPolygon":for(coords=geometry.coordinates,j=0;j<coords.length;j++){for(geometryIndex=0,k=0;k<coords[j].length;k++){for(l=0;l<coords[j][k].length-wrapShrink;l++){if(!1===callback(coords[j][k][l],coordIndex,featureIndex,multiFeatureIndex,geometryIndex))return!1;coordIndex++}geometryIndex++}multiFeatureIndex++}break;case"GeometryCollection":for(j=0;j<geometry.geometries.length;j++)if(!1===coordEach(geometry.geometries[j],callback,excludeWrapCoord))return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}!function(CRSTypes){CRSTypes.WGS84="WGS84",CRSTypes.WGS1984="WGS84",CRSTypes.EPSG4326="WGS84",CRSTypes.GCJ02="GCJ02",CRSTypes.AMap="GCJ02",CRSTypes.BD09="BD09",CRSTypes.BD09LL="BD09",CRSTypes.Baidu="BD09",CRSTypes.BMap="BD09",CRSTypes.BD09MC="BD09MC",CRSTypes.BD09Meter="BD09MC",CRSTypes.EPSG3857="EPSG3857",CRSTypes.EPSG900913="EPSG3857",CRSTypes.EPSG102100="EPSG3857",CRSTypes.WebMercator="EPSG3857",CRSTypes.WM="EPSG3857"}(CRSTypes||(CRSTypes={}));var crsMap$1={WGS84:{to:(_to={},_to[CRSTypes.GCJ02]=WGS84ToGCJ02,_to[CRSTypes.BD09]=compose(GCJ02ToBD09,WGS84ToGCJ02),_to[CRSTypes.BD09MC]=compose(BD09toBD09MC,GCJ02ToBD09,WGS84ToGCJ02),_to[CRSTypes.EPSG3857]=WGS84ToEPSG3857,_to)},GCJ02:{to:(_to2={},_to2[CRSTypes.WGS84]=GCJ02ToWGS84,_to2[CRSTypes.BD09]=GCJ02ToBD09,_to2[CRSTypes.BD09MC]=compose(BD09toBD09MC,GCJ02ToBD09),_to2[CRSTypes.EPSG3857]=compose(WGS84ToEPSG3857,GCJ02ToWGS84),_to2)},BD09:{to:(_to3={},_to3[CRSTypes.WGS84]=compose(GCJ02ToWGS84,BD09ToGCJ02),_to3[CRSTypes.GCJ02]=BD09ToGCJ02,_to3[CRSTypes.EPSG3857]=compose(WGS84ToEPSG3857,GCJ02ToWGS84,BD09ToGCJ02),_to3[CRSTypes.BD09MC]=BD09toBD09MC,_to3)},EPSG3857:{to:(_to4={},_to4[CRSTypes.WGS84]=EPSG3857ToWGS84,_to4[CRSTypes.GCJ02]=compose(WGS84ToGCJ02,EPSG3857ToWGS84),_to4[CRSTypes.BD09]=compose(GCJ02ToBD09,WGS84ToGCJ02,EPSG3857ToWGS84),_to4[CRSTypes.BD09MC]=compose(BD09toBD09MC,GCJ02ToBD09,WGS84ToGCJ02,EPSG3857ToWGS84),_to4)},BD09MC:{to:(_to5={},_to5[CRSTypes.WGS84]=compose(GCJ02ToWGS84,BD09ToGCJ02,BD09MCtoBD09),_to5[CRSTypes.GCJ02]=compose(BD09ToGCJ02,BD09MCtoBD09),_to5[CRSTypes.EPSG3857]=compose(WGS84ToEPSG3857,GCJ02ToWGS84,BD09ToGCJ02,BD09MCtoBD09),_to5[CRSTypes.BD09]=BD09MCtoBD09,_to5)}};var exported=Object.assign(Object.assign({},CRSTypes),{CRSTypes:CRSTypes,transform:function(input,crsFrom,crsTo){if(assert(!!input,"The args[0] input coordinate is required"),assert(!!crsFrom,"The args[1] original coordinate system is required"),assert(!!crsTo,"The args[2] target coordinate system is required"),crsFrom===crsTo)return input;var from=crsMap$1[crsFrom];assert(!!from,"Invalid original coordinate system: "+crsFrom);var to=from.to[crsTo];assert(!!to,"Invalid target coordinate system: "+crsTo);var type=typeof input;if(assert("string"===type||"object"===type,"Invalid input coordinate type: "+type),"string"===type)try{input=JSON.parse(input)}catch(e){throw new Error("Invalid input coordinate: "+input)}var isPosition=!1;isArray(input)&&(assert(input.length>=2,"Invalid input coordinate: "+input),assert(isNumber(input[0])&&isNumber(input[1]),"Invalid input coordinate: "+input),input=input.map(Number),isPosition=!0);var convert=to;return isPosition?convert(input):(coordEach(input,function(coord){[coord[0],coord[1]]=convert(coord)}),input)}}),ORIGIN=[-180,90],MORIGIN=[-20037508.342787,20037508.342787],merc=new class{constructor(options={}){if(Object.defineProperty(this,_size,{writable:!0,value:void 0}),Object.defineProperty(this,_expansion,{writable:!0,value:void 0}),Object.defineProperty(this,_Bc,{writable:!0,value:void 0}),Object.defineProperty(this,_Cc,{writable:!0,value:void 0}),Object.defineProperty(this,_zc,{writable:!0,value:void 0}),Object.defineProperty(this,_Ac,{writable:!0,value:void 0}),_classPrivateFieldLooseBase(this,_size)[_size]=options.size||256,_classPrivateFieldLooseBase(this,_expansion)[_expansion]=options.antimeridian?2:1,!cache[_classPrivateFieldLooseBase(this,_size)[_size]]){var size=_classPrivateFieldLooseBase(this,_size)[_size],c=cache[_classPrivateFieldLooseBase(this,_size)[_size]]={};c.Bc=[],c.Cc=[],c.zc=[],c.Ac=[];for(var d=0;d<30;d++)c.Bc.push(size/360),c.Cc.push(size/(2*Math.PI)),c.zc.push(size/2),c.Ac.push(size),size*=2}_classPrivateFieldLooseBase(this,_Bc)[_Bc]=cache[_classPrivateFieldLooseBase(this,_size)[_size]].Bc,_classPrivateFieldLooseBase(this,_Cc)[_Cc]=cache[_classPrivateFieldLooseBase(this,_size)[_size]].Cc,_classPrivateFieldLooseBase(this,_zc)[_zc]=cache[_classPrivateFieldLooseBase(this,_size)[_size]].zc,_classPrivateFieldLooseBase(this,_Ac)[_Ac]=cache[_classPrivateFieldLooseBase(this,_size)[_size]].Ac}px(ll,zoom){if(isFloat(zoom)){var size=_classPrivateFieldLooseBase(this,_size)[_size]*Math.pow(2,zoom),d=size/2,bc=size/360,cc=size/(2*Math.PI),ac=size,f=Math.min(Math.max(Math.sin(D2R$1*ll[1]),-.9999),.9999),x=d+ll[0]*bc,y=d+.5*Math.log((1+f)/(1-f))*-cc;return x>ac*_classPrivateFieldLooseBase(this,_expansion)[_expansion]&&(x=ac*_classPrivateFieldLooseBase(this,_expansion)[_expansion]),y>ac&&(y=ac),[x,y]}var _d=_classPrivateFieldLooseBase(this,_zc)[_zc][zoom],_f=Math.min(Math.max(Math.sin(D2R$1*ll[1]),-.9999),.9999),_x=Math.round(_d+ll[0]*_classPrivateFieldLooseBase(this,_Bc)[_Bc][zoom]),_y=Math.round(_d+.5*Math.log((1+_f)/(1-_f))*-_classPrivateFieldLooseBase(this,_Cc)[_Cc][zoom]);return _x>_classPrivateFieldLooseBase(this,_Ac)[_Ac][zoom]*_classPrivateFieldLooseBase(this,_expansion)[_expansion]&&(_x=_classPrivateFieldLooseBase(this,_Ac)[_Ac][zoom]*_classPrivateFieldLooseBase(this,_expansion)[_expansion]),_y>_classPrivateFieldLooseBase(this,_Ac)[_Ac][zoom]&&(_y=_classPrivateFieldLooseBase(this,_Ac)[_Ac][zoom]),[_x,_y]}ll(px,zoom){if(isFloat(zoom)){var size=_classPrivateFieldLooseBase(this,_size)[_size]*Math.pow(2,zoom),bc=size/360,cc=size/(2*Math.PI),zc=size/2,g=(px[1]-zc)/-cc;return[(px[0]-zc)/bc,R2D$1*(2*Math.atan(Math.exp(g))-.5*Math.PI)]}var _g=(px[1]-_classPrivateFieldLooseBase(this,_zc)[_zc][zoom])/-_classPrivateFieldLooseBase(this,_Cc)[_Cc][zoom];return[(px[0]-_classPrivateFieldLooseBase(this,_zc)[_zc][zoom])/_classPrivateFieldLooseBase(this,_Bc)[_Bc][zoom],R2D$1*(2*Math.atan(Math.exp(_g))-.5*Math.PI)]}convert(bbox,to){return"900913"===to?[...this.forward(bbox.slice(0,2)),...this.forward(bbox.slice(2,4))]:[...this.inverse(bbox.slice(0,2)),...this.inverse(bbox.slice(2,4))]}inverse(xy){return[xy[0]*R2D$1/A$1,(.5*Math.PI-2*Math.atan(Math.exp(-xy[1]/A$1)))*R2D$1]}forward(ll){var xy=[A$1*ll[0]*D2R$1,A$1*Math.log(Math.tan(.25*Math.PI+.5*ll[1]*D2R$1))];return xy[0]>MAXEXTENT$1&&(xy[0]=MAXEXTENT$1),xy[0]<-MAXEXTENT$1&&(xy[0]=-MAXEXTENT$1),xy[1]>MAXEXTENT$1&&(xy[1]=MAXEXTENT$1),xy[1]<-MAXEXTENT$1&&(xy[1]=-MAXEXTENT$1),xy}bbox(x,y,zoom,tmsStyle,srs){tmsStyle&&(y=Math.pow(2,zoom)-1-y);var ll=[x*_classPrivateFieldLooseBase(this,_size)[_size],(+y+1)*_classPrivateFieldLooseBase(this,_size)[_size]],ur=[(+x+1)*_classPrivateFieldLooseBase(this,_size)[_size],y*_classPrivateFieldLooseBase(this,_size)[_size]],bbox=[...this.ll(ll,zoom),...this.ll(ur,zoom)];return"900913"===srs?this.convert(bbox,"900913"):bbox}xyz(bbox,zoom,tmsStyle,srs){var box="900913"===srs?this.convert(bbox,"WGS84"):bbox,ll=[box[0],box[1]],ur=[box[2],box[3]],px_ll=this.px(ll,zoom),px_ur=this.px(ur,zoom),x=[Math.floor(px_ll[0]/_classPrivateFieldLooseBase(this,_size)[_size]),Math.floor((px_ur[0]-1)/_classPrivateFieldLooseBase(this,_size)[_size])],y=[Math.floor(px_ur[1]/_classPrivateFieldLooseBase(this,_size)[_size]),Math.floor((px_ll[1]-1)/_classPrivateFieldLooseBase(this,_size)[_size])],bounds={minX:Math.min.apply(Math,x)<0?0:Math.min.apply(Math,x),minY:Math.min.apply(Math,y)<0?0:Math.min.apply(Math,y),maxX:Math.max.apply(Math,x),maxY:Math.max.apply(Math,y)};if(tmsStyle){var tms={minY:Math.pow(2,zoom)-1-bounds.maxY,maxY:Math.pow(2,zoom)-1-bounds.minY};bounds.minY=tms.minY,bounds.maxY=tms.maxY}return bounds}}({size:256});function get4326Res(zoom){return 1.40625/Math.pow(2,zoom)}function offsetTileBBOX(bbox,projection,isGCJ02){if(isGCJ02){var transformPoints=bboxToPoints(bbox).map(function(p){return"EPSG:3857"===projection?exported.transform(p,exported.WebMercator,exported.WGS84):p}).map(function(p){return exported.transform(p,exported.WGS84,exported.AMap)}),minx=1/0,miny=1/0,maxx=-1/0,maxy=-1/0;if(transformPoints.forEach(function(p){var[x,y]=p;minx=Math.min(minx,x),miny=Math.min(miny,y),maxx=Math.max(maxx,x),maxy=Math.max(maxy,y)}),"EPSG:4326"===projection)bbox[0]=minx,bbox[1]=miny,bbox[2]=maxx,bbox[3]=maxy;else{var _points=bboxToPoints([minx,miny,maxx,maxx]).map(function(p){return lnglat2Mercator(p)}),x1=1/0,y1=1/0,x2=-1/0,y2=-1/0;_points.forEach(function(p){var[x,y]=p;x1=Math.min(x1,x),y1=Math.min(y1,y),x2=Math.max(x2,x),y2=Math.max(y2,y)}),bbox[0]=x1,bbox[1]=y1,bbox[2]=x2,bbox[3]=y2}}}function cal3857Tiles(x,y,z,zoomOffset=0,isGCJ02){zoomOffset=zoomOffset||0;var zoom,[orginX,orginY]=MORIGIN,res=256*(zoom=z,156543.03392804097/Math.pow(2,zoom)),tileBBOX=function(x,y,z){var[orginX,orginY]=ORIGIN,res=256*get4326Res(z),mincol=x,minrow=y;return[orginX+(mincol=Math.floor(mincol))*res,(minrow=Math.floor(minrow))*res-orginY,orginX+(mincol+1)*res,(minrow+1)*res-orginY]}(x,y,z);offsetTileBBOX(tileBBOX,"EPSG:4326",isGCJ02);var mbbox=pointsToBBOX(bboxToPoints(tileBBOX).map(function(c){return merc.forward(c)})),[minx,miny,maxx,maxy]=mbbox,mincol=(minx-orginX)/res,maxcol=(maxx-orginX)/res,minrow=(orginY-maxy)/res,maxrow=(orginY-miny)/res;if(mincol=Math.floor(mincol),maxcol=Math.floor(maxcol),minrow=Math.floor(minrow),maxrow=Math.floor(maxrow),!(maxcol<mincol||maxrow<minrow)){for(var tiles=[],row=minrow;row<=maxrow;row++)for(var col=mincol;col<=maxcol;col++)tiles.push([col,row,z+zoomOffset]);var bboxList=tiles.map(function(tile){var[x,y,z]=tile;return merc.bbox(x,y,z,!1,"900913")}),[xmin,ymin,xmax,ymax]=function(bboxList){var xmin=1/0,ymin=1/0,xmax=-1/0,ymax=-1/0;return bboxList.forEach(function(bbox){var[minx,miny,maxx,maxy]=bbox;xmin=Math.min(xmin,minx),xmax=Math.max(xmax,maxx),ymin=Math.min(ymin,miny),ymax=Math.max(ymax,maxy)}),[xmin,ymin,xmax,ymax]}(bboxList);return{tiles:tiles,tilesbbox:[xmin,ymin,xmax,ymax],bbox:tileBBOX,mbbox:mbbox,x:x,y:y,z:z}}}function tilesImageData(image,tilesbbox,tilebbox,projection){var{width:width,height:height}=image,[minx,miny,maxx,maxy]=tilesbbox,ax=(maxx-minx)/width,ay=(maxy-miny)/height,[tminx,tminy,tmaxx,tmaxy]=tilebbox,x1=((tminx-=ax)-minx)/ax,y1=(maxy-(tmaxy+=ay))/ay,x2=((tmaxx+=ax)-minx)/ax,y2=(maxy-(tminy-=ay))/ay;x1=Math.floor(x1),y1=Math.floor(y1);var w=(x2=Math.ceil(x2))-x1,h=(y2=Math.ceil(y2))-y1,tileCanvas=getCanvas();resizeCanvas(tileCanvas,w,h);var ctx=getCanvasContext(tileCanvas);ctx.drawImage(image,x1,y1,w,h,0,0,w,h),disposeImage(image);for(var imageData=ctx.getImageData(0,0,w,h).data,pixels=[],xmin=1/0,ymin=1/0,xmax=-1/0,ymax=-1/0,index=-1,method="EPSG:4326"===projection?merc.forward:merc.inverse,row=1;row<=h;row++)for(var y=tmaxy-(row-1)*ay,_y=y-ay,col=1;col<=w;col++){var idx=(row-1)*w*4+4*(col-1),r=imageData[idx],g=imageData[idx+1],b=imageData[idx+2],a=imageData[idx+3],x=tminx+(col-1)*ax,point=method([x,y]);xmin=Math.min(xmin,point[0]),xmax=Math.max(xmax,point[0]),ymin=Math.min(ymin,point[1]),ymax=Math.max(ymax,point[1]);var coordinates1=[x,_y];pixels[++index]={point:point,point1:method(coordinates1),r:r,g:g,b:b,a:a}}return{pixels:pixels,bbox:[xmin,ymin,xmax,ymax],width:w,height:h,image:tileCanvas.transferToImageBitmap()}}function transformTiles(pixelsresult,mbbox,debug){var[xmin,ymin,xmax,ymax]=mbbox,ax=(xmax-xmin)/256,ay=(ymax-ymin)/256,{pixels:pixels,bbox:bbox}=pixelsresult,[minx,miny,maxx,maxy]=bbox,width=(maxx-minx)/ax,height=(maxy-miny)/ay;if(width=Math.round(width),height=Math.round(height),!isNaN(width)&&!isNaN(height)&&0!==Math.min(width,height)&&Math.abs(width)!==1/0&&Math.abs(height)!==1/0){var canvas=getCanvas();resizeCanvas(canvas,width,height);for(var ctx=getCanvasContext(canvas),imageData=ctx.createImageData(width,height),data=imageData.data,i=0,len=pixels.length;i<len;i++)for(var{point:point,point1:point1,r:r,g:g,b:b,a:a}=pixels[i],[x1,y1]=point,[x2,y2]=point1,[col1,row1]=transformPixel(x1,y1),[col2,row2]=transformPixel(x2,y2),j=row1;j<=row2;j++){var idx=(j-1)*width*4+4*(col1-1);data[idx]=r,data[idx+1]=g,data[idx+2]=b,data[idx+3]=a}ctx.putImageData(imageData,0,0);var image=canvas.transferToImageBitmap(),px=Math.round((xmin-minx)/ax),py=Math.round((maxy-ymax)/ay),canvas1=getCanvas();resizeCanvas(canvas1,256,256);var ctx1=getCanvasContext(canvas);return ctx1.drawImage(image,px-1,py,256,256,0,0,256,256),function(ctx){var canvas=ctx.canvas,{width:width,height:height}=canvas,imageData=ctx.getImageData(0,0,width,height),data=imageData.data,leftIsBlank=function(){for(var row=1;row<=height;row++){if(data[4*width*(row-1)+0+3]>0)return!1}return!0},colIsBlank=function(col){for(var row=1;row<=height;row++){if(data[4*width*(row-1)+4*(col-1)+3]>0)return!1}return!0},bottomIsBlank=function(){for(var col=1;col<=width;col++){if(data[4*(col-1)+(height-1)*width*4+3]>0)return!1}return!0};if(leftIsBlank())for(var row=1;row<=height;row++){var idx1=4*width*(row-1)+0,idx2=idx1+4,r=data[idx2],g=data[idx2+1],b=data[idx2+2],a=data[idx2+3];data[idx1]=r,data[idx1+1]=g,data[idx1+2]=b,data[idx1+3]=a}if(bottomIsBlank())for(var col=1;col<=width;col++){var _idx=4*(col-1)+(height-1)*width*4,_idx2=4*(col-1)+(height-2)*width*4,_r=data[_idx2],_g=data[_idx2+1],_b=data[_idx2+2],_a=data[_idx2+3];data[_idx]=_r,data[_idx+1]=_g,data[_idx+2]=_b,data[_idx+3]=_a}for(var colBlanks=[],_col=1,len=width;_col<=len;_col++)colBlanks.push(colIsBlank(_col));if(colBlanks.indexOf(!0)>-1)for(var fixCol=function(col1,col2){for(var _row=1;_row<=height;_row++){var _idx3=4*width*(_row-1)+4*(col1-1),_idx4=4*width*(_row-1)+4*(col2-1),_r2=data[_idx4],_g2=data[_idx4+1],_b2=data[_idx4+2],_a2=data[_idx4+3];data[_idx3]=_r2,data[_idx3+1]=_g2,data[_idx3+2]=_b2,data[_idx3+3]=_a2}},_col2=1;_col2<=width;_col2++){if(colBlanks[_col2-1]){var next=colBlanks[_col2],pre=colBlanks[_col2-1];next?pre||fixCol(_col2,_col2-1):fixCol(_col2,_col2+1)}}ctx.putImageData(imageData,0,0)}(ctx1),debug&&(ctx1.lineWidth=.4,ctx1.strokeStyle="red",ctx1.rect(0,0,256,256),ctx1.stroke()),canvas1.transferToImageBitmap()}function transformPixel(x,y){var col=Math.round((x-minx)/ax+1);col=Math.min(col,width);var row=Math.round((maxy-y)/ay+1);return[col,row=Math.min(row,height)]}}function tileTransform(options){return new Promise(function(resolve,reject){var{x:x,y:y,z:z,projection:projection,zoomOffset:zoomOffset,errorLog:errorLog,debug:debug,returnBlobURL:returnBlobURL,returnUint32Buffer:returnUint32Buffer,isGCJ02:isGCJ02}=options,returnImage=function(opImage){createImageBlobURL(getCanvas(),opImage,options).then(function(url){resolve(url)}).catch(function(error){reject(error)})};!function(){var result;"EPSG:4326"===projection?result=function(x,y,z,zoomOffset=0,isGCJ02){zoomOffset=zoomOffset||0;var[orginX,orginY]=ORIGIN,res=256*get4326Res(z),tileBBOX=merc.bbox(x,y,z);offsetTileBBOX(tileBBOX,"EPSG:4326",isGCJ02);var[minx,miny,maxx,maxy]=tileBBOX,mincol=(minx-orginX)/res,maxcol=(maxx-orginX)/res,minrow=(orginY-maxy)/res,maxrow=(orginY-miny)/res;if(mincol=Math.floor(mincol),maxcol=Math.floor(maxcol),minrow=Math.floor(minrow),maxrow=Math.floor(maxrow),!(maxcol<mincol||maxrow<minrow)){for(var tiles=[],row=minrow;row<=maxrow;row++)for(var col=mincol;col<=maxcol;col++)tiles.push([col-1,row,z+zoomOffset]);return{tiles:tiles,tilesbbox:[orginX+(mincol-1)*res,orginY-(maxrow+1)*res,orginX+maxcol*res,orginY-minrow*res],bbox:tileBBOX,mbbox:pointsToBBOX(bboxToPoints(tileBBOX).map(function(c){return lnglat2Mercator(c)})),x:x,y:y,z:z}}}(x,y,z,zoomOffset||0,isGCJ02):"EPSG:3857"===projection&&(result=cal3857Tiles(x,y,z,zoomOffset||0,isGCJ02));var{tiles:tiles}=result||{};if(tiles&&0!==tiles.length){result.loadCount=0;var _loadTile=function(){if(result.loadCount>=tiles.length){var image1,image=layoutTiles(tiles,debug);if("EPSG:4326"===projection)image1=transformTiles(tilesImageData(image,result.tilesbbox,result.bbox,projection),result.mbbox,debug),returnImage(image1||getBlankTile());else image1=transformTiles(tilesImageData(image,result.tilesbbox,result.mbbox,projection),result.bbox,debug),returnImage(image1||getBlankTile())}else{var tile=tiles[result.loadCount],[_x,_y2,_z]=tile;getTileWithMaxZoom(Object.assign({},options,{x:_x,y:_y2,z:_z,returnBlobURL:!1})).then(function(image){tile.tileImage=image,result.loadCount++,_loadTile()}).catch(function(error){errorLog&&console.error(error),tile.tileImage=getBlankTile(),result.loadCount++,_loadTile()})}};_loadTile()}else returnImage(getBlankTile())}()})}exports.initialize=function(){},exports.onmessage=function(message,postResponse){var data=message.data||{},type=data.__type;if("getTile"!==type){var options;if("layoutTiles"!==type)if("getTileWithMaxZoom"!==type)if("clipTile"!==type)if("tileIntersectMask"!==type)if("transformTile"!==type){if("injectMask"===type){var geojson=injectMask(data.maskId,data.geojsonFeature);return geojson instanceof Error?void postResponse(geojson):void postResponse()}if("removeMask"===type)return function(maskId){delete GeoJSONCache[maskId]}(data.maskId),void postResponse();if("cancelFetch"===type){var taskId=data.taskId||data.__taskId;return taskId?(function(taskId){var controlList=CONTROLCACHE[taskId]||[];controlList.length&&controlList.forEach(function(control){control.abort(FetchCancelError)}),delete CONTROLCACHE[taskId]}(taskId),void postResponse()):void postResponse(createInnerError("cancelFetch need taskId"))}if("imageSlicing"!==type)if("imageToBlobURL"!==type)if("encodeTerrainTile"!==type)if("colorTerrainTile"!==type)if("imagetTileFetch"!==type)if("tilePostAndToBlobURL"!==type)if("getVTTile"!==type){var errorMessage="worker message:not support message type:"+type;console.error(errorMessage),postResponse(createInnerError(errorMessage))}else{var{url:_url2}=data;getVTTile(_url2,data).then(function(buffer){postResponse(null,buffer,checkBuffers(buffer))}).catch(function(error){postResponse(error)})}else{var{image:_image}=data,_postImage=postProcessingImage(_image,data);createImageBlobURL(getCanvas(),_postImage,data).then(function(image){postResponse(null,image,checkBuffers(image))}).catch(function(error){postResponse(error)})}else(function(options){return new Promise(function(resolve,reject){var{url:url,headers:headers}=options,fetchOptions=options.fetchOptions||{headers:headers,referrer:options.referrer};fetch(url,fetchOptions).then(function(res){return res.ok||reject(createNetWorkError(url)),res.blob()}).then(function(blob){return createImageBitmap(blob)}).then(function(image){resolve(image)}).catch(function(error){reject(error)})})})(data).then(function(image){postResponse(null,image,checkBuffers(image))}).catch(function(error){postResponse(error)});else{var{tile:tile,colors:colors}=data,postImage=postProcessingImage(colorsTerrainTile(colors,tile),data);createImageBlobURL(getCanvas(),postImage,data).then(function(url){postResponse(null,url,checkBuffers(url))}).catch(function(error){postResponse(error)})}else{var{url:_url}=data;encodeTerrainTile(_url,data).then(function(image){postResponse(null,image,checkBuffers(image))}).catch(function(error){postResponse(error)})}else imageToBlobURL(data).then(function(result){postResponse(null,result,[])}).catch(function(error){postResponse(error)});else(function(options){return options.disableCache=!0,new Promise(function(resolve,reject){var urls=checkTileUrl(options.url),headers=Object.assign({},HEADERS,options.headers||{}),fetchTiles=urls.map(function(tileUrl){return fetchTile(tileUrl,headers,options)});Promise.all(fetchTiles).then(function(imagebits){var canvas=getCanvas(512),image=mergeTiles(imagebits);if(image instanceof Error)reject(image);else{for(var{width:width,height:height}=image,rows=Math.ceil(height/512),cols=Math.ceil(width/512),items=[],row=1;row<=rows;row++)for(var y1=512*(row-1),y2=Math.min(height,512*row),col=1;col<=cols;col++){var x1=512*(col-1),w=Math.min(width,512*col)-x1,h=y2-y1;resizeCanvas(canvas,w,h),getCanvasContext(canvas).drawImage(image,x1,y1,w,h,0,0,canvas.width,canvas.height);var postImage=postProcessingImage(canvas.transferToImageBitmap(),options);items.push({id:uuid(),x:x1,y:y1,width:w,height:h,row:row,col:col,image:postImage})}var result={rows:rows,cols:cols,rowWidth:512,colHeight:512,width:width,height:height,items:items};disposeImage(image),resolve(result)}}).catch(function(error){reject(error)})})})(data).then(function(result){var buffers=[];(result.items||[]).forEach(function(item){isImageBitmap(item.image)&&buffers.push(item.image)}),postResponse(null,result,buffers)}).catch(function(error){postResponse(error)})}else tileTransform(data).then(function(image){postResponse(null,image,checkBuffers(image))}).catch(function(error){postResponse(error)});else{var{tileBBOX:tileBBOX,maskId:maskId}=data;(function(tileBBOX,maskId){return new Promise(function(resolve,reject){var feature=GeoJSONCache[maskId];if(feature){var notIntersect=function(){resolve({intersect:!1})},beIntersect=function(){resolve({intersect:!0})},bbox=feature.bbox;if(bbox){var{coordinates:coordinates,type:type}=feature.geometry;if(coordinates.length)if(bboxIntersect(bbox,tileBBOX))if(bboxInBBOX(bbox,tileBBOX))beIntersect();else{var polygons=coordinates;"Polygon"===type&&(polygons=[polygons]),0!==clipPolygons(polygons,tileBBOX).length?beIntersect():notIntersect()}else notIntersect();else notIntersect()}else notIntersect()}else reject(createParamsValidateError("not find mask ,the maskId:"+maskId))})})(tileBBOX,maskId).then(function(result){postResponse(null,result,checkBuffers(result))}).catch(function(error){postResponse(error)})}else(options=data,new Promise(function(resolve,reject){var{tile:tile,tileBBOX:tileBBOX,projection:projection,tileSize:tileSize,maskId:maskId,reverse:reverse,bufferSize:bufferSize}=options,feature=GeoJSONCache[maskId],returnImage=function(image){createImageBlobURL(getCanvas(),image,options).then(function(url){resolve(url)}).catch(function(error){reject(error)})},bbox=feature.bbox;if(bbox){var{coordinates:coordinates,type:type}=feature.geometry;if(coordinates.length){var judgeReverse=function(){returnImage(reverse?tile:getBlankTile(tileSize))};if(bboxIntersect(bbox,tileBBOX)){var prjCoordinates,clipBufferOpts,polygons=coordinates;"Polygon"===type&&(polygons=[polygons]);var transform=function(){if(isNumber$1(bufferSize)&&bufferSize>0){var _prjCoordinates=transformCoordinates(projection,polygons),bufferPixels=transformPixels(projection,tileBBOX,tileSize,_prjCoordinates);clipBufferOpts={bufferSize:bufferSize,polygons:bufferPixels}}};if(bboxInBBOX(bbox,tileBBOX)){prjCoordinates=transformCoordinates(projection,polygons);var _pixels=transformPixels(projection,tileBBOX,tileSize,prjCoordinates);transform();var _image=imageClip(tileSize,_pixels,tile,reverse,clipBufferOpts);returnImage(_image)}else{var clipRings=clipPolygons(polygons,tileBBOX);if(0!==clipRings.length){prjCoordinates=transformCoordinates(projection,clipRings);var pixels=transformPixels(projection,tileBBOX,tileSize,prjCoordinates);transform();var image=imageClip(tileSize,pixels,tile,reverse,clipBufferOpts);returnImage(image)}else judgeReverse()}}else judgeReverse()}else returnImage(tile)}else returnImage(tile)})).then(function(image){postResponse(null,image,checkBuffers(image))}).catch(function(error){postResponse(error)});else getTileWithMaxZoom(data).then(function(image){postResponse(null,image,checkBuffers(image))}).catch(function(error){postResponse(error)});else(function(options){var{urlTemplate:urlTemplate,tiles:tiles,subdomains:subdomains,debug:debug}=options;return new Promise(function(resolve,reject){if(validateSubdomains(urlTemplate,subdomains)){var urls=tiles.map(function(tile){var[tileX,tileY,tileZ]=tile;return getTileUrl(urlTemplate,tileX,tileY,tileZ,subdomains)}),headers=Object.assign({},HEADERS,options.headers||{}),fetchTiles=urls.map(function(url){return fetchTile(url,headers,options)});Promise.all(fetchTiles).then(function(imagebits){imagebits.forEach(function(image,index){tiles[index].tileImage=image});var postImage=postProcessingImage(layoutTiles(tiles,debug),options);createImageBlobURL(getCanvas(),postImage,options).then(function(url){resolve(url)}).catch(function(error){reject(error)})}).catch(function(error){reject(error)})}else reject(createParamsValidateError("not find subdomains"))})})(data).then(function(image){postResponse(null,image,checkBuffers(image))}).catch(function(error){postResponse(error)})}else{var{url:url}=data;(function(url,options){return new Promise(function(resolve,reject){var urls=checkTileUrl(url),headers=Object.assign({},HEADERS,options.headers||{}),fetchTiles=urls.map(function(tileUrl){return fetchTile(tileUrl,headers,options)}),{globalCompositeOperation:globalCompositeOperation}=options;Promise.all(fetchTiles).then(function(imagebits){var canvas=getCanvas(),image=mergeTiles(imagebits,globalCompositeOperation);image instanceof Error?reject(image):createImageBlobURL(canvas,postProcessingImage(image,options),options).then(function(url){resolve(url)}).catch(function(error){reject(error)})}).catch(function(error){reject(error)})})})(url,data).then(function(image){postResponse(null,image,checkBuffers(image))}).catch(function(error){postResponse(error)})}},Object.defineProperty(exports,"__esModule",{value:!0})}`;

  class CustomError extends Error {
      constructor(message, code) {
          super(message);
          this.code = code;
      }
  }
  function isNumber(value) {
      return typeof value === 'number';
  }
  function createError(message, code) {
      return new CustomError(message, code);
  }
  const CANVAS_ERROR_MESSAGE = createError('not find canvas.The current environment does not support OffscreenCanvas', -4);
  const FetchCancelError = createError('fetch tile data cancel', 499);
  createError('fetch tile data timeout', 408);
  const TaskCancelError = createError('the task is cancel', -6);
  function createParamsValidateError(message) {
      return createError(message, -1);
  }
  function checkTileUrl(url) {
      if (Array.isArray(url)) {
          return url;
      }
      return [url];
  }
  function lnglat2Mercator(coordinates) {
      const [lng, lat] = coordinates;
      const earthRad = 6378137.0;
      const x = lng * Math.PI / 180 * earthRad;
      const a = lat * Math.PI / 180;
      const y = earthRad / 2 * Math.log((1.0 + Math.sin(a)) / (1.0 - Math.sin(a)));
      return [x, y];
  }
  function isPolygon(feature) {
      if (!feature) {
          return false;
      }
      const geometry = feature.geometry || { type: null };
      const type = geometry.type;
      return type === 'Polygon' || type === 'MultiPolygon';
  }
  function isEPSG3857(projection) {
      return projection === 'EPSG:3857';
  }
  let globalId = 0;
  function uuid() {
      globalId++;
      return globalId;
  }
  function isImageBitmap(image) {
      return image && image instanceof ImageBitmap;
  }
  function disposeImage(images) {
      if (!Array.isArray(images)) {
          images = [images];
      }
      images.forEach(image => {
          if (image && image.close) {
              image.close();
          }
      });
  }
  function checkBuffers(image) {
      const images = checkTileUrl(image);
      const buffers = [];
      images.forEach(item => {
          if (isImageBitmap(item) || (item && (item instanceof ArrayBuffer))) {
              buffers.push(item);
          }
      });
      return buffers;
  }

  // const ISNODE = typeof global === 'object';

  let offscreenCanvas = false;
  try {
      const canvas = new OffscreenCanvas(1, 1);
      const ctx = canvas.getContext('2d');
      ctx.fillText('hello', 0, 0);
      offscreenCanvas = true;
  } catch (err) {
      offscreenCanvas = false;
  }

  let globalCanvas;
  function getCanvas(tileSize = 256) {
      if (!globalCanvas && OffscreenCanvas) {
          globalCanvas = new OffscreenCanvas(1, 1);
      }
      if (globalCanvas) {
          resizeCanvas(globalCanvas, tileSize, tileSize);
      }
      return globalCanvas;
  }
  function resizeCanvas(canvas, width, height) {
      if (canvas) {
          canvas.width = width;
          canvas.height = height;
      }
  }
  function clearCanvas(ctx) {
      const canvas = ctx.canvas;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  function getCanvasContext(canvas) {
      const ctx = canvas.getContext('2d', {
          willReadFrequently: true
      });
      clearCanvas(ctx);
      return ctx;
  }
  function getBlankTile(tileSize) {
      const canvas = getCanvas(tileSize);
      getCanvasContext(canvas);
      return canvas.transferToImageBitmap();
  }
  function get404Tile(tileSize) {
      const canvas = getCanvas(tileSize);
      const ctx = getCanvasContext(canvas);
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = 'gray';
      ctx.font = "bold 24px serif";
      ctx.fillText('404', canvas.width / 2, canvas.height / 2);
      return canvas.transferToImageBitmap();
  }

  function bboxIntersect(bbox1, bbox2) {
      if (bbox1[2] < bbox2[0]) {
          return false;
      }
      if (bbox1[1] > bbox2[3]) {
          return false;
      }
      if (bbox1[0] > bbox2[2]) {
          return false;
      }
      if (bbox1[3] < bbox2[1]) {
          return false;
      }
      return true;
  }
  function bboxToPoints(bbox) {
      const [minx, miny, maxx, maxy] = bbox;
      return [
          [minx, miny],
          [maxx, miny],
          [maxx, maxy],
          [minx, maxy]
      ];
  }

  function imageTile(imageInfo, options) {
      const imageBBOX = imageInfo.imageBBOX;
      const image = imageInfo.image;
      const { width, height } = image;
      let { tileBBOX, projection, tileSize } = options;
      const [x1, y1, x2, y2] = imageBBOX;
      const ax = width / (x2 - x1);
      const ay = height / (y2 - y1);
      let [minx, miny, maxx, maxy] = tileBBOX;
      if (isEPSG3857(projection)) {
          minx = Infinity;
          miny = Infinity;
          maxx = -Infinity;
          maxy = -Infinity;
          const points = bboxToPoints(tileBBOX);
          points.forEach(p => {
              const m = lnglat2Mercator(p);
              const [x, y] = m;
              minx = Math.min(x, minx);
              miny = Math.min(y, miny);
              maxx = Math.max(x, maxx);
              maxy = Math.max(y, maxy);
          });
      }
      if (!bboxIntersect(imageBBOX, [minx, miny, maxx, maxy])) {
          return getBlankTile();
      }
      let left = (minx - x1) * ax;
      let right = (maxx - x1) * ax;
      let bottom = height - (miny - y1) * ay;
      let top = height - (maxy - y1) * ay;
      left = Math.floor(left);
      bottom = Math.floor(bottom);
      top = Math.floor(top);
      right = Math.floor(right);
      if (right < 0 || left > width || top > height || bottom < 0) {
          return getBlankTile();
      }
      if (left === right) {
          right++;
      }
      if (bottom === top) {
          bottom--;
      }
      tileSize = tileSize || 256;
      const canvas = getCanvas(tileSize);
      const ctx = getCanvasContext(canvas);
      ctx.drawImage(image, left, top, right - left, bottom - top, 0, 0, tileSize, tileSize);
      return canvas.transferToImageBitmap();
  }

  const WORKERNAME = '__maptalks.tileclip__';
  maptalks.registerWorkerAdapter(WORKERNAME, WORKERCODE);
  const maskMap = {};
  const imageMap = {};
  const SUPPORTPROJECTION = ['EPSG:4326', 'EPSG:3857'];
  const TerrainTypes = ['mapzen', 'tianditu', 'cesium', 'arcgis', 'qgis-gray'];
  function checkOptions(options, type) {
      return Object.assign({
          referrer: document.location.href,
          tileSize: 256
      }, options, {
          __type: type,
          __taskId: uuid(),
          __workerId: getWorkerId()
      });
  }
  function getTaskId(options) {
      const workerId = options.__workerId;
      const taskId = options.__taskId;
      return {
          workerId,
          taskId
      };
  }
  function isErrorOrCancel(error, promise) {
      return (error || (promise && promise.canceled));
  }
  function removeTimeOut(id) {
      clearTimeout(id);
  }
  class TileActor extends maptalks.worker.Actor {
      _cancelTask(options) {
          const { workerId, taskId } = getTaskId(options);
          if (!isNumber(workerId) || !isNumber(taskId)) {
              return;
          }
          if (taskId) {
              this.send({ __type: 'cancelFetch', __taskId: taskId }, [], (error, image) => {
                  // if (error) {
                  //     reject(error);
                  // } else {
                  //     resolve(image);
                  // }
              }, workerId);
          }
      }
      getTile(options) {
          options = checkOptions(options, 'getTile');
          const { workerId } = getTaskId(options);
          const promise = new Promise((resolve, reject) => {
              const { url } = options;
              if (!url) {
                  reject(createParamsValidateError('getTile error:url is null'));
                  return;
              }
              const buffers = checkBuffers(url);
              this.send(options, buffers, (error, image) => {
                  if (isErrorOrCancel(error, promise)) {
                      reject(error || FetchCancelError);
                  }
                  else {
                      resolve(image);
                  }
              }, workerId);
          });
          wrapPromise(promise, options);
          return promise;
      }
      layoutTiles(options) {
          options = checkOptions(options, 'layoutTiles');
          const { workerId } = getTaskId(options);
          const promise = new Promise((resolve, reject) => {
              const { urlTemplate, tiles } = options;
              if (!urlTemplate) {
                  reject(createParamsValidateError('layoutTiles error:urlTemplate is null'));
                  return;
              }
              if (!tiles || tiles.length === 0) {
                  reject(createParamsValidateError('layoutTiles error:tiles is null'));
                  return;
              }
              const buffers = [];
              this.send(options, buffers, (error, image) => {
                  if (isErrorOrCancel(error, promise)) {
                      reject(error || FetchCancelError);
                  }
                  else {
                      resolve(image);
                  }
              }, workerId);
          });
          wrapPromise(promise, options);
          return promise;
      }
      getTileWithMaxZoom(options) {
          options = checkOptions(options, 'getTileWithMaxZoom');
          const { workerId } = getTaskId(options);
          const promise = new Promise((resolve, reject) => {
              const { urlTemplate, maxAvailableZoom, x, y, z } = options;
              const maxZoomEnable = maxAvailableZoom && isNumber(maxAvailableZoom) && maxAvailableZoom >= 1;
              if (!maxZoomEnable) {
                  reject(createParamsValidateError('getTileWithMaxZoom error:maxAvailableZoom is error'));
                  return;
              }
              if (!urlTemplate) {
                  reject(createParamsValidateError('getTileWithMaxZoom error:urlTemplate is error'));
                  return;
              }
              if (!isNumber(x) || !isNumber(y) || !isNumber(z)) {
                  reject(createParamsValidateError('getTileWithMaxZoom error:x/y/z is error'));
                  return;
              }
              this.send(options, [], (error, image) => {
                  if (isErrorOrCancel(error, promise)) {
                      reject(error || FetchCancelError);
                  }
                  else {
                      resolve(image);
                  }
              }, workerId);
          });
          wrapPromise(promise, options);
          return promise;
      }
      transformTile(options) {
          options = checkOptions(options, 'transformTile');
          const { workerId } = getTaskId(options);
          const promise = new Promise((resolve, reject) => {
              const { urlTemplate, x, y, z, maxAvailableZoom, projection } = options;
              const maxZoomEnable = maxAvailableZoom && isNumber(maxAvailableZoom) && maxAvailableZoom >= 1;
              if (!projection) {
                  reject(createParamsValidateError('transformTile error:not find projection'));
                  return;
              }
              if (SUPPORTPROJECTION.indexOf(projection) === -1) {
                  reject(createParamsValidateError('transformTile error:not support projection:' + projection + '.the support:' + SUPPORTPROJECTION.join(',').toString()));
                  return;
              }
              if (!maxZoomEnable) {
                  reject(createParamsValidateError('transformTile error:maxAvailableZoom is error'));
                  return;
              }
              if (!urlTemplate) {
                  reject(createParamsValidateError('transformTile error:urlTemplate is error'));
                  return;
              }
              if (!isNumber(x) || !isNumber(y) || !isNumber(z)) {
                  reject(createParamsValidateError('transformTile error:x/y/z is error'));
                  return;
              }
              this.send(options, [], (error, image) => {
                  if (isErrorOrCancel(error, promise)) {
                      reject(error || FetchCancelError);
                  }
                  else {
                      resolve(image);
                  }
              }, workerId);
          });
          wrapPromise(promise, options);
          return promise;
      }
      clipTile(options) {
          options = checkOptions(options, 'clipTile');
          delete options.__taskId;
          delete options.__workerId;
          const promise = new Promise((resolve, reject) => {
              const { tile, tileBBOX, projection, tileSize, maskId } = options;
              if (!tile) {
                  reject(createParamsValidateError('clipTile error:tile is null.It should be a ImageBitmap'));
                  return;
              }
              if (!tileBBOX) {
                  reject(createParamsValidateError('clipTile error:tileBBOX is null'));
                  return;
              }
              if (!projection) {
                  reject(createParamsValidateError('clipTile error:projection is null'));
                  return;
              }
              if (!tileSize) {
                  reject(createParamsValidateError('clipTile error:tileSize is null'));
                  return;
              }
              if (!maskId) {
                  reject(createParamsValidateError('clipTile error:maskId is null'));
                  return;
              }
              if (!this.maskHasInjected(maskId)) {
                  reject(createParamsValidateError('not find mask by maskId:' + maskId));
                  return;
              }
              const buffers = [];
              if (isImageBitmap(options.tile)) {
                  buffers.push(options.tile);
              }
              this.send(options, buffers, (error, image) => {
                  if (isErrorOrCancel(error, promise)) {
                      reject(error || TaskCancelError);
                  }
                  else {
                      resolve(image);
                  }
              });
          });
          wrapPromise(promise, options);
          return promise;
      }
      tileIntersectMask(options) {
          options = checkOptions(options, 'tileIntersectMask');
          delete options.__taskId;
          delete options.__workerId;
          const promise = new Promise((resolve, reject) => {
              const { tileBBOX, maskId } = options;
              if (!tileBBOX) {
                  reject(createParamsValidateError('tileIntersectMask error:tileBBOX is null'));
                  return;
              }
              if (!maskId) {
                  reject(createParamsValidateError('tileIntersectMask error:maskId is null'));
                  return;
              }
              if (!this.maskHasInjected(maskId)) {
                  reject(createParamsValidateError('not find mask by maskId:' + maskId));
                  return;
              }
              const buffers = [];
              this.send(options, buffers, (error, result) => {
                  if (isErrorOrCancel(error, promise)) {
                      reject(error || TaskCancelError);
                  }
                  else {
                      resolve(result);
                  }
              });
          });
          wrapPromise(promise, options);
          return promise;
      }
      injectMask(maskId, geojsonFeature) {
          const promise = new Promise((resolve, reject) => {
              if (!maskId) {
                  reject(createParamsValidateError('injectMask error:maskId is null'));
                  return;
              }
              if (maskMap[maskId]) {
                  reject(createParamsValidateError(`injectMask error:${maskId} has injected`));
                  return;
              }
              if (!isPolygon(geojsonFeature)) {
                  reject(createParamsValidateError('injectMask error:geojsonFeature is not Polygon,It should be GeoJSON Polygon/MultiPolygon'));
                  return;
              }
              this.broadcast({
                  maskId,
                  geojsonFeature,
                  __type: 'injectMask'
              }, [], (error, data) => {
                  if (isErrorOrCancel(error, promise)) {
                      reject(error || TaskCancelError);
                      return;
                  }
                  resolve(null);
                  maskMap[maskId] = true;
              });
          });
          wrapPromise(promise, {});
          return promise;
      }
      removeMask(maskId) {
          const promise = new Promise((resolve, reject) => {
              if (!maskId) {
                  reject(createParamsValidateError('removeMask error:maskId is null'));
                  return;
              }
              this.broadcast({
                  maskId,
                  __type: 'removeMask'
              }, [], (error, data) => {
                  if (isErrorOrCancel(error, promise)) {
                      reject(error || TaskCancelError);
                      return;
                  }
                  resolve(null);
                  delete maskMap[maskId];
              });
          });
          wrapPromise(promise, {});
          return promise;
      }
      maskHasInjected(maskId) {
          if (!maskId) {
              console.error('maskHasInjected error:maskId is null');
              return false;
          }
          return !!maskMap[maskId];
      }
      imageSlicing(options) {
          options = checkOptions(options, 'imageSlicing');
          const { workerId } = getTaskId(options);
          const promise = new Promise((resolve, reject) => {
              const { url } = options;
              if (!url) {
                  reject(createParamsValidateError('url is null'));
                  return;
              }
              const buffers = checkBuffers(url);
              this.send(options, buffers, (error, result) => {
                  if (isErrorOrCancel(error, promise)) {
                      reject(error || FetchCancelError);
                  }
                  else {
                      const { returnBlobURL, returnUint32Buffer, returnBase64 } = options;
                      if (!returnBlobURL && !returnUint32Buffer && !returnBase64) {
                          resolve(result);
                      }
                      else {
                          const items = result.items || [];
                          const workerIds = [];
                          while (1) {
                              const workerId = getWorkerId();
                              if (workerIds.indexOf(workerId) === -1) {
                                  workerIds.push(workerId);
                              }
                              else {
                                  break;
                              }
                          }
                          const pageSize = Math.ceil(items.length / workerIds.length);
                          let temp = [];
                          const isEnd = () => {
                              return temp.length === items.length;
                          };
                          const mergeResult = () => {
                              temp.forEach(d => {
                                  for (let i = 0, len = items.length; i < len; i++) {
                                      const item = items[i];
                                      if (item.id === d.id) {
                                          item.image = d.url;
                                          break;
                                      }
                                  }
                              });
                              resolve(result);
                          };
                          for (let i = 0, len = workerIds.length; i < len; i++) {
                              const workerId = workerIds[i];
                              const start = i * pageSize;
                              const end = start + pageSize;
                              const subItems = items.slice(start, end);
                              if (subItems.length === 0) {
                                  if (isEnd()) {
                                      mergeResult();
                                  }
                                  continue;
                              }
                              const opts = Object.assign({}, options);
                              opts.__type = 'imageToBlobURL';
                              opts.items = subItems;
                              opts._workerId = workerId;
                              const buffers = subItems.map(item => item.image);
                              this.send(opts, buffers, (error, resultItems) => {
                                  if (isErrorOrCancel(error, promise)) {
                                      reject(error || FetchCancelError);
                                      return;
                                  }
                                  else {
                                      temp = temp.concat(resultItems);
                                      if (isEnd()) {
                                          mergeResult();
                                      }
                                  }
                              }, workerId);
                          }
                      }
                  }
              }, workerId);
          });
          wrapPromise(promise, options);
          return promise;
      }
      encodeTerrainTile(options) {
          options = checkOptions(options, 'encodeTerrainTile');
          const { workerId } = getTaskId(options);
          const promise = new Promise((resolve, reject) => {
              const { url, terrainType, minHeight, maxHeight } = options;
              if (!url) {
                  reject(createParamsValidateError('encodeTerrainTile error:url is null'));
                  return;
              }
              if (!terrainType) {
                  reject(createParamsValidateError('encodeTerrainTile error:terrainType is null'));
                  return;
              }
              if (TerrainTypes.indexOf(terrainType) === -1) {
                  reject(createParamsValidateError('encodeTerrainTile error:terrainType:not support the terrainType:' + terrainType));
                  return;
              }
              if (terrainType === 'qgis-gray') {
                  if (!isNumber(minHeight) || !isNumber(maxHeight) || minHeight > maxHeight) {
                      reject(createParamsValidateError('encodeTerrainTile error:terrainType:qgis-gray,require minHeight/maxHeight should number'));
                      return;
                  }
              }
              this.send(Object.assign({ terrainWidth: 65, tileSize: 256 }, options), [], (error, image) => {
                  if (isErrorOrCancel(error, promise)) {
                      reject(error || FetchCancelError);
                  }
                  else {
                      resolve(image);
                  }
              }, workerId);
          });
          wrapPromise(promise, options);
          return promise;
      }
      terrainTileFixBoundary(options) {
          options = checkOptions(options, 'terrainTileFixBoundary');
          const { workerId } = getTaskId(options);
          const promise = new Promise((resolve, reject) => {
              const { tiles, returnBlobURL, returnUint32Buffer } = options;
              if (!tiles || tiles.length === 0) {
                  reject(createParamsValidateError('terrainTileFixBoundary error:tiles is null'));
                  return;
              }
              const z = tiles[0].z;
              let tileSize = 256;
              for (let i = 0, len = tiles.length; i < len; i++) {
                  const zoom = tiles[i].z;
                  const image = tiles[i].image;
                  if (!image) {
                      reject(createParamsValidateError('terrainTileFixBoundary error:not find tile.image'));
                      console.error(tiles);
                      return;
                  }
                  tileSize = image.width;
                  if (zoom !== z) {
                      reject(createParamsValidateError('terrainTileFixBoundary error:All tiles should be on the same level'));
                      console.error(tiles);
                      return;
                  }
              }
              let minX = Infinity, minY = Infinity;
              for (let i = 0, len = tiles.length; i < len; i++) {
                  const { x, y } = tiles[i];
                  minX = Math.min(x, minX);
                  minY = Math.min(y, minY);
              }
              const findTile = (tileX, tileY) => {
                  for (let i = 0, len = tiles.length; i < len; i++) {
                      const { x, y } = tiles[i];
                      if (x === tileX && y === tileY) {
                          return tiles[i];
                      }
                  }
              };
              const currentTile = findTile(minX, minY);
              const rightTile = findTile(minX + 1, minY);
              const bottomTile = findTile(minX, minY + 1);
              const canvas = getCanvas(tileSize);
              resizeCanvas(canvas, tileSize, tileSize);
              const ctx = getCanvasContext(canvas);
              ctx.drawImage(currentTile.image, 0, 0, tileSize, tileSize);
              if (rightTile) {
                  ctx.drawImage(rightTile.image, 0, 0, 1, tileSize, tileSize - 1, 0, 1, tileSize);
              }
              if (bottomTile) {
                  ctx.drawImage(bottomTile.image, 0, 0, tileSize, 1, 0, tileSize - 1, tileSize, 1);
              }
              const image = canvas.transferToImageBitmap();
              if (returnBlobURL || returnUint32Buffer) {
                  this.send(Object.assign({ __type: 'tilePostAndToBlobURL' }, { returnBlobURL, returnUint32Buffer, image }), [], (error, url) => {
                      if (isErrorOrCancel(error, promise)) {
                          reject(error || FetchCancelError);
                      }
                      else {
                          resolve(url);
                      }
                  }, workerId);
              }
              else {
                  const tid = setTimeout(() => {
                      if (isErrorOrCancel(null, promise)) {
                          reject(TaskCancelError);
                          return;
                      }
                      removeTimeOut(tid);
                      resolve(image);
                  }, 1);
              }
          });
          wrapPromise(promise, options);
          return promise;
      }
      colorTerrainTile(options) {
          options = checkOptions(options, 'colorTerrainTile');
          const promise = new Promise((resolve, reject) => {
              const { tile, colors } = options;
              if (!tile || !isImageBitmap(tile)) {
                  reject(createParamsValidateError('colorTerrainTile error:tile is not ImageBitMap'));
                  return;
              }
              if (!colors || !Array.isArray(colors) || colors.length === 0) {
                  reject(createParamsValidateError('colorTerrainTile error:colors is null'));
                  return;
              }
              const buffers = checkBuffers(tile);
              this.send(Object.assign({}, options), buffers, (error, image) => {
                  if (isErrorOrCancel(error, promise)) {
                      reject(error || TaskCancelError);
                  }
                  else {
                      resolve(image);
                  }
              });
          });
          wrapPromise(promise, options);
          return promise;
      }
      injectImage(options) {
          options = checkOptions(options, 'injectImage');
          const promise = new Promise((resolve, reject) => {
              const { imageId, url, imageBBOX } = options;
              if (!imageId) {
                  reject(createParamsValidateError('injectImage error:imageId is null'));
                  return;
              }
              if (!url) {
                  reject(createParamsValidateError('injectImage error:url is null'));
                  return;
              }
              if (this.imageHasInjected(imageId)) {
                  reject(createParamsValidateError(`injectImage error:${imageId} has injected`));
                  return;
              }
              if (!imageBBOX) {
                  reject(createParamsValidateError('injectImage error:imageBBOX is null'));
                  return;
              }
              options.url = maptalks.Util.getAbsoluteURL(url);
              this.send(Object.assign({}, options, { __type: 'imagetTileFetch' }), [], (error, image) => {
                  if (isErrorOrCancel(error, promise)) {
                      reject(error || FetchCancelError);
                  }
                  else {
                      imageMap[imageId] = {
                          imageBBOX,
                          url,
                          image
                      };
                      resolve(null);
                  }
              });
          });
          wrapPromise(promise, {});
          return promise;
      }
      removeImage(imageId) {
          const promise = new Promise((resolve, reject) => {
              if (!imageId) {
                  reject(createParamsValidateError('removeImage error:imageId is null'));
                  return;
              }
              const tid = setTimeout(() => {
                  if (isErrorOrCancel(null, promise)) {
                      reject(TaskCancelError);
                      return;
                  }
                  const imageInfo = imageMap[imageId] || {};
                  delete imageMap[imageId];
                  const image = imageInfo.image;
                  disposeImage(image);
                  removeTimeOut(tid);
                  resolve(null);
              }, 1);
          });
          wrapPromise(promise, {});
          return promise;
      }
      imageHasInjected(imageId) {
          if (!imageId) {
              console.error('imageHasInjected error:imageId is null');
              return false;
          }
          return !!imageMap[imageId];
      }
      getImageTile(options) {
          options = checkOptions(options, 'getImageTile');
          const promise = new Promise((resolve, reject) => {
              const { tileBBOX, projection, imageId, filter, opacity, gaussianBlurRadius, returnBlobURL, returnUint32Buffer, returnBase64, mosaicSize, oldPhoto } = options;
              if (!tileBBOX) {
                  reject(createParamsValidateError('getImageTile error:tileBBOX is null'));
                  return;
              }
              if (!imageId) {
                  reject(createParamsValidateError('getImageTile error:imageId is null'));
                  return;
              }
              if (!projection) {
                  reject(createParamsValidateError('getImageTile error:projection is null'));
                  return;
              }
              if (!this.imageHasInjected(imageId)) {
                  reject(createParamsValidateError('not find image by imageId:' + imageId));
                  return;
              }
              const imageInfo = imageMap[imageId];
              const image = imageTile(imageInfo, options);
              if (filter || opacity || gaussianBlurRadius || returnBlobURL || returnUint32Buffer || returnBase64 || mosaicSize || oldPhoto) {
                  options.image = image;
                  const buffers = checkBuffers(image);
                  this.send(Object.assign({}, options, { __type: 'tilePostAndToBlobURL' }), buffers, (error, url) => {
                      if (isErrorOrCancel(error, promise)) {
                          reject(error || TaskCancelError);
                      }
                      else {
                          resolve(url);
                      }
                  });
              }
              else {
                  const tid = setTimeout(() => {
                      if (isErrorOrCancel(null, promise)) {
                          reject(TaskCancelError);
                          return;
                      }
                      removeTimeOut(tid);
                      resolve(image);
                  }, 1);
              }
          });
          wrapPromise(promise, options);
          return promise;
      }
      getVTTile(options) {
          options = checkOptions(options, 'getVTTile');
          const { workerId } = getTaskId(options);
          const promise = new Promise((resolve, reject) => {
              const { url } = options;
              if (!url) {
                  reject(createParamsValidateError('getVTTile error:url is null'));
                  return;
              }
              const buffers = checkBuffers(url);
              this.send(options, buffers, (error, buffer) => {
                  if (isErrorOrCancel(error, promise)) {
                      reject(error || FetchCancelError);
                  }
                  else {
                      resolve(buffer);
                  }
              }, workerId);
          });
          wrapPromise(promise, options);
          return promise;
      }
  }
  let actor;
  let logger = false;
  function getTileActor() {
      if (!getCanvas()) {
          if (!logger) {
              console.error(CANVAS_ERROR_MESSAGE);
              logger = true;
          }
          return null;
      }
      if (!actor) {
          actor = new TileActor(WORKERNAME);
      }
      return actor;
  }
  let globalWorkerId = 0;
  function getWorkerId() {
      const actor = getTileActor();
      const workers = actor.workers || [];
      const id = globalWorkerId % workers.length;
      globalWorkerId++;
      return id;
  }
  function wrapPromise(promise, options) {
      promise.cancel = () => {
          getTileActor()._cancelTask(options);
          promise.canceled = true;
      };
  }

  exports.get404Tile = get404Tile;
  exports.getBlankTile = getBlankTile;
  exports.getTileActor = getTileActor;

  Object.defineProperty(exports, '__esModule', { value: true });

}));
//# sourceMappingURL=maptalks.tileclip.js.map
