/*!
 * maptalks.routeplayer v0.3.0
 * LICENSE : MIT
 * (c) 2016-2023 maptalks.org
 */
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("maptalks"),require("@maptalks/gl-layers")):"function"==typeof define&&define.amd?define(["exports","maptalks","@maptalks/gl-layers"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).maptalks=t.maptalks||{},t.maptalks,t.maptalks)}(this,(function(t,i,s){"use strict";function e(t){if(t&&t.i)return t;var i=Object.create(null);return t&&Object.keys(t).forEach((function(s){if("default"!==s){var e=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(i,s,e.get?e:{enumerable:!0,get:function(){return t[s]}})}})),i.default=t,Object.freeze(i)}var h=e(i);const n=new h.Coordinate([0,0,0]),r=new h.Point(0,0),l=new h.Point(0,0),o=[],a=[];class u{constructor(t){this.route=t,this.path=t.path}getCoordinates(t,i){if(t<this.getStart()||t>this.getEnd())return null;var s=null;let e=null;for(let i=0,h=this.path.length;i<h;i++)if(t<this.path[i][3]){s=i,e=this.path[i][4];break}null===s&&(s=this.path.length-1);const r=this.path[s-1],l=this.path[s],o=(t-r[3])/(l[3]-r[3]),a=r[0]+(l[0]-r[0])*o,u=r[1]+(l[1]-r[1])*o,c=r[2]+(l[2]-r[2])*o,y=i.getGLRes();n.set(a,u,c);const f=i.coordinateToPointAtRes(n,y);n.set(r[0],r[1],r[2]);const p=i.coordinateToPointAtRes(n,y),m=h.Util.computeDegree(p.x,p.y,f.x,f.y);return{coordinate:new h.Coordinate(a,u,c),viewPoint:f,degree:m,index:s,payload:e}}getStart(){return this.path[0][3]}getEnd(){return this.path[this.getCount()-1][3]}getCount(){return this.path.length}get markerSymbol(){return this.route.markerSymbol}set markerSymbol(t){this.route.markerSymbol=t,this.s&&this.s.marker&&this.s.marker.setSymbol(t)}get lineSymbol(){return this.route.lineSymbol}set lineSymbol(t){this.route.lineSymbol=t,this.s&&this.s.marker&&this.s.line.setSymbol(t)}get trailLineSymbol(){return this.route.trailLineSymbol}set trailLineSymbol(t){this.route.trailLineSymbol=t,this.s&&this.s.marker&&this.s.trailLine.setSymbol(t)}}class c extends(h.Eventable(h.Class)){constructor(t,i,s){super(s),Array.isArray(t)||(t=[t]),this.id=h.Util.UID(),this.container=i,this.h(t)}get map(){return this.container.getMap?this.container.getMap():this.container}remove(){return this.markerLayer?(this.player.playState="finished",this.markerLayer.remove(),this.lineLayer.remove(),this.trailLineLayer.remove(),delete this.markerLayer,delete this.lineLayer,delete this.trailLineLayer,delete this.container,this):this}play(){return"running"===this.player.playState||(this.player.play(),this.fire("playstart")),this}pause(){return"paused"===this.player.playState||(this.player.pause(),this.fire("playpause")),this}cancel(){this.player.cancel(),this.played=0,this.trailLinePoints=[];let t=this.trailLineLayer.getGeometries()[0];void 0!==t&&this.options.showTrail&&t.setCoordinates(this.trailLinePoints),this.l(),this.o({styles:{t:0}});const i=this.u("playcancel");return this.fire("playcancel",i),this}finish(){return"finished"===this.player.playState||(this.player.finish(),this.o({styles:{t:1}})),this}u(t){const i=this.lineLayer.getGeometries()[0],s={};if(i){const e=i.getCoordinates();let h=0;"playfinish"===t&&(h=e.length-2);const n=this.p(e[h+1],e[h]);s.bearing=n.bearing,s.pitch=n.pitch,s.coordinate="playfinish"===t?e[h+1]:e[h]}return s}getStartTime(){return this.startTime||0}getEndTime(){return this.endTime||0}getCurrentTime(){return this.played?this.startTime+this.played:this.startTime}getRoutes(){return this.routes}setTime(t){return this.played=t-this.startTime,this.played<0&&(this.played=0),this.m(),this}getUnitTime(){return this.options.unitTime}setUnitTime(t){this.options.unitTime=+t,this.m()}getCurrentProperties(t){return t||(t=0),this.routes[t]&&this.routes[t].s?this.routes[t].s.marker.getProperties():null}getCurrentCoordinates(t){return t||(t=0),this.routes[t]&&this.routes[t].s?this.routes[t].s.marker.getCoordinates():null}getMarkerSymbol(t){return this.routes&&this.routes[t]?this.routes[t].markerSymbol:null}getMarker(t){return t||(t=0),this.routes[t]&&this.routes[t].s?this.routes[t].s.marker:null}setMarkerSymbol(t,i){return this.routes&&this.routes[t]&&(this.routes[t].markerSymbol=i),this}getLineSymbol(t){return this.routes&&this.routes[t]?this.routes[t].lineSymbol:null}setLineSymbol(t,i){return this.routes&&this.routes[t]&&(this.routes[t].lineSymbol=i),this}showRoute(){this.lineLayer.show()}showTrail(){this.trailLineLayer.show()}hideRoute(){this.lineLayer.hide()}hideTrail(){this.trailLineLayer.hide()}m(){const t=this.player&&"running"===this.player.playState;t&&this.player.finish(),this.l(),t&&this.player.play()}o(t){if(t.state&&"running"!==t.state.playState){if("finished"===t.state.playState){const t=this.u("playfinish");this.fire("playfinish",t)}}else{this.played=this.duration*t.styles.t;for(let t=0,i=this.routes.length;t<i;t++)this.g(this.routes[t],this.startTime+this.played);if(this.trailLinePoints&&this.trailLinePoints.length>2){const t=this.trailLinePoints.length,i=this.trailLinePoints[t-1],s=this.trailLinePoints[t-3],e=this.p(i,s),{pitch:h,bearing:n,coordinate:r}=e;this.fire("playing",{pitch:h,bearing:n,coordinate:r,time:this.played})}}}g(t,i){if(!this.map)return;const s=t.getCoordinates(i,this.map);if(s){if(t.s||(t.s={}),t.s.marker)t.s.marker.setProperties(s.payload),t.s.marker.setCoordinates(s.coordinate);else{const i=new h.Marker(s.coordinate,{symbol:t.markerSymbol||this.options.markerSymbol}).addTo(this.markerLayer);t.s.marker=i}if(!t.s.line){const i=new h.LineString(t.path,{symbol:t.lineSymbol||this.options.lineSymbol}).addTo(this.lineLayer);t.s.line=i}if(t.s.trailLine){this.trailLinePoints.push(s.coordinate);const i=this.options.maxTrailLine;0!==i&&this.trailLinePoints.length>i&&this.trailLinePoints.shift(),this.trailLinePoints.length>1&&this.options.showTrail&&t.s.trailLine.setCoordinates(this.trailLinePoints)}else{this.trailLinePoints=[s.coordinate];const i=new h.LineString([],{symbol:t.trailLineSymbol||this.options.trailLineSymbol}).addTo(this.trailLineLayer);t.s.trailLine=i}}else t.s&&t.s.marker&&(t.s.marker.remove(),delete t.s.marker)}p(t,i){const s=this.map.getGLRes(),e=this.map.coordinateToPointAtRes(t,s,r),n=this.map.coordinateToPointAtRes(i,s,l);let u=h.Util.computeDegree(e.x,e.y,n.x,n.y);const c=this.map.altitudeToPoint(t.z,s),f=this.map.altitudeToPoint(i.z,s),p=y(o,e.x-n.x,e.y-n.y,0),m=y(a,e.x-n.x,e.y-n.y,c-f);let d=function(t,i){let s=t[0],e=t[1],h=t[2],n=i[0],r=i[1],l=i[2],o=Math.sqrt(s*s+e*e+h*h),a=Math.sqrt(n*n+r*r+l*l),u=o*a,c=u&&function(t,i){return t[0]*i[0]+t[1]*i[1]+t[2]*i[2]}(t,i)/u;return Math.acos(Math.min(Math.max(c,-1),1))}(p,m);return m[2]<0&&(d=2*Math.PI-d),u=u/Math.PI*180,d=d/Math.PI*180,{bearing:u,pitch:d,coordinate:t}}h(t){const i=t.map(t=>new u(t));var s=i[0].getStart(),e=i[0].getEnd();for(let t=1;t<i.length;t++){let h=i[t];h.getStart()<s&&(s=h.getStart()),h.getEnd()>e&&(e=h.getEnd())}this.trailLinePoints=[],this.routes=i,this.startTime=s,this.endTime=e,this.played=0,this.duration=e-s,this._(),this.l()}l(){const t=(this.duration-this.played)/this.options.unitTime;let i;const s=this.map.getRenderer();s.callInFrameLoop&&(i=function(t){s.callInFrameLoop(t)}),this.player=h.animation.Animation.animate({t:[this.played/this.duration,1]},{framer:i,speed:t,easing:"linear"},this.o.bind(this))}_(){this.lineLayer=new h.VectorLayer(h.INTERNAL_LAYER_PREFIX+"_routeplay_r_"+this.id,[],{visible:this.options.showRoutes,enableSimplify:!1}).addTo(this.container),this.trailLineLayer=new h.VectorLayer(h.INTERNAL_LAYER_PREFIX+"_routeplay_t_"+this.id,[],{visible:this.options.showTrail,enableSimplify:!1}).addTo(this.container),this.markerLayer=new h.VectorLayer(h.INTERNAL_LAYER_PREFIX+"_routeplay_m_"+this.id,[],{visible:this.options.showMarker}).addTo(this.container)}}function y(t,i,s,e){return t[0]=i,t[1]=s,t[2]=e,t}c.mergeOptions({unitTime:1e3,showRoutes:!0,showTrail:!0,showMarker:!0,maxTrailLine:0,markerSymbol:null,lineSymbol:{lineWidth:2,lineColor:"#004A8D"},trailLineSymbol:{lineColor:"rgba(250,0,0,1)",lineWidth:4,lineJoin:"round",lineCap:"round",lineDasharray:null,"lineOpacity ":1}}),t.Route=u,t.Route3DPlayer=class extends c{_(){this.lineLayer=new s.LineStringLayer(h.INTERNAL_LAYER_PREFIX+"_routeplay_r_"+this.id,[],{visible:this.options.showRoutes,enableSimplify:!1}).addTo(this.container),this.trailLineLayer=new s.LineStringLayer(h.INTERNAL_LAYER_PREFIX+"_routeplay_t_"+this.id,[],{visible:this.options.showTrail,enableSimplify:!1}).addTo(this.container),this.markerLayer=new s.PointLayer(h.INTERNAL_LAYER_PREFIX+"_routeplay_m_"+this.id,[],{visible:this.options.showMarker}).addTo(this.container)}},t.RoutePlayer=c,Object.defineProperty(t,"i",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.routeplayer v0.3.0")}));
