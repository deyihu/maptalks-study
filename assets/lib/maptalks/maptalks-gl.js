/*!
 * maptalks-gl v0.114.0
 * LICENSE : MIT
 * (c) 2016-2025 maptalks.com
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).maptalks=e.maptalks||{})}(this,(function(e){"use strict";
/*!
   * maptalks v1.4.6
   * LICENSE : BSD-3-Clause
   * (c) 2016-2025 maptalks.org
   */var t="1.4.6",n="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0)&&!process.versions.electron&&!process.versions.nw&&!process.versions["node-webkit"];function i(){return"undefined"!=typeof globalThis?globalThis:global||self}function s(e){var t=i().maptalksversion;if(t)throw new Error("Disallow duplicate imports of maptalks version "+e+" and "+t);i().maptalksversion=e}var o={isTest:!1,idleLog:!1,idleForceTimeThreshold:48,workerCount:i().MAPTALKS_WORKER_COUNT||0,messagePostRatioPerWorker:.3,maxFPS:0,crsMaxNativeZoom:22};function a(){return Date.now()}function l(e,...t){for(var n=0;n<t.length;n++){var i=t[n];for(var s in i)e[s]=i[s]}return e}function h(e){return null==e}function c(e){return"number"==typeof e&&!isNaN(e)}function u(e){return(0|e)===e}function f(e){return"object"==typeof e&&!!e}function g(e){return!h(e)&&("string"==typeof e||null!==e.constructor&&e.constructor===String)}function m(e){return!h(e)&&("function"==typeof e||null!==e.constructor&&e.constructor===Function)}var A=Object.prototype.hasOwnProperty;function w(e,t){return A.call(e,t)}var T=Math.PI/180;function S(e){return e*T}function M(e){return e/T}var C={};function I(){return window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI}if(!n){var E=navigator.userAgent.toLowerCase(),D=document.documentElement||{style:{}},H="ActiveXObject"in window,N=-1!==E.indexOf("webkit"),B=-1!==E.indexOf("phantom"),z=-1!==E.search("android [23]"),U=-1!==E.indexOf("chrome"),j=-1!==E.indexOf("gecko")&&!N&&!window.opera&&!H,W=/iphone/i.test(E)&&/micromessenger/i.test(E),q="undefined"!=typeof orientation||-1!==E.indexOf("mobile"),Z=!window.PointerEvent&&window.MSPointerEvent,X=window.PointerEvent&&navigator.pointerEnabled||Z,Y=H&&"transition"in D.style,J="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!z,Q="MozPerspective"in D.style,$="OTransition"in D.style,K=(Y||J||Q)&&!$&&!B,ee="undefined"!=typeof window&&m(window.createImageBitmap),te="undefined"!=typeof window&&m(window.ResizeObserver),re="undefined"!=typeof window&&m(window.btoa),se="undefined"!=typeof window&&m(window.Proxy),oe="undefined"!=typeof window&&m(window.requestIdleCallback),le="undefined"!=typeof CanvasRenderingContext2D&&m(CanvasRenderingContext2D.prototype.roundRect),he=0;U&&(he=E.match(/chrome\/([\d.]+)/)[1]);var ue=!B&&(X||"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch),fe="undefined"!=typeof window&&"WebGLRenderingContext"in window,de=I(),pe=!1;try{new OffscreenCanvas(2,2).getContext("2d"),pe=!0}catch(e){pe=!1}var me=!1;try{var Ae=Object.defineProperty({},"passive",{get:function(){me=!0}});window.addEventListener("testPassive",null,Ae),window.removeEventListener("testPassive",null,Ae)}catch(mO){}(C={IS_NODE:n,isTest:!1,ie:H,ielt9:H&&!document.addEventListener,edge:"msLaunchUri"in navigator&&!("documentMode"in document),webkit:N,gecko:j,android:-1!==E.indexOf("android"),android23:z,chrome:U,chromeVersion:he,safari:!U&&-1!==E.indexOf("safari"),phantomjs:B,ie3d:Y,webkit3d:J,gecko3d:Q,opera12:$,any3d:K,iosWeixin:W,mobile:q,mobileWebkit:q&&N,mobileWebkit3d:q&&J,mobileOpera:q&&window.opera,mobileGecko:q&&j,touch:!!ue,msPointer:!!Z,pointer:!!X,retina:de>1,devicePixelRatio:de,language:navigator.browserLanguage?navigator.browserLanguage:navigator.language,ie9:H&&9===document.documentMode,ie10:H&&10===document.documentMode,webgl:fe,imageBitMap:ee,roundRect:le,resizeObserver:te,btoa:re,decodeImageInWorker:pe,monitorDPRChange:!0,supportsPassive:me,proxy:se,requestIdleCallback:oe,checkDevicePixelRatio:function(){if("undefined"!=typeof window&&C.monitorDPRChange){var e=I(),t=e!==C.devicePixelRatio;return t&&(C.devicePixelRatio=e),t}return!1}}).roundRect||console.warn("current env the canvas not support roundRect")}var ye=C;function _e(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function ve(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function xe(e,t,n){return t&&function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,Pe(i.key),i)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function be(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return(n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return _e(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_e(e,t):void 0}}(e))||t){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function we(e){return we=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},we(e)}function Te(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,Ce(e,t)}function Se(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(Se=function(){return!!e})()}function Me(){Me=function(){return t};var e,t={},n=Object.prototype,i=n.hasOwnProperty,s=Object.defineProperty||function(e,t,n){e[t]=n.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",l=o.asyncIterator||"@@asyncIterator",h=o.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function u(e,t,n,i){var o=Object.create((t&&t.prototype instanceof S?t:S).prototype),a=new q(i||[]);return s(o,"_invoke",{value:z(e,n,a)}),o}function f(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var g="suspendedStart",m="suspendedYield",A="executing",w="completed",T={};function S(){}function M(){}function C(){}var I={};c(I,a,(function(){return this}));var E=Object.getPrototypeOf,D=E&&E(E(Z([])));D&&D!==n&&i.call(D,a)&&(I=D);var H=C.prototype=S.prototype=Object.create(I);function N(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function B(e,t){function n(s,o,a,l){var h=f(e[s],e,o);if("throw"!==h.type){var c=h.arg,u=c.value;return u&&"object"==typeof u&&i.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,a,l)}),(function(e){n("throw",e,a,l)})):t.resolve(u).then((function(e){c.value=e,a(c)}),(function(e){return n("throw",e,a,l)}))}l(h.arg)}var o;s(this,"_invoke",{value:function(e,i){function s(){return new t((function(t,s){n(e,i,t,s)}))}return o=o?o.then(s,s):s()}})}function z(t,n,i){var s=g;return function(o,a){if(s===A)throw Error("Generator is already running");if(s===w){if("throw"===o)throw a;return{value:e,done:!0}}for(i.method=o,i.arg=a;;){var l=i.delegate;if(l){var h=U(l,i);if(h){if(h===T)continue;return h}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if(s===g)throw s=w,i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);s=A;var c=f(t,n,i);if("normal"===c.type){if(s=i.done?w:m,c.arg===T)continue;return{value:c.arg,done:i.done}}"throw"===c.type&&(s=w,i.method="throw",i.arg=c.arg)}}}function U(t,n){var i=n.method,s=t.iterator[i];if(s===e)return n.delegate=null,"throw"===i&&t.iterator.return&&(n.method="return",n.arg=e,U(t,n),"throw"===n.method)||"return"!==i&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+i+"' method")),T;var o=f(s,t.iterator,n.arg);if("throw"===o.type)return n.method="throw",n.arg=o.arg,n.delegate=null,T;var a=o.arg;return a?a.done?(n[t.resultName]=a.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,T):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,T)}function j(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function W(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function q(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(j,this),this.reset(!0)}function Z(t){if(t||""===t){var n=t[a];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var s=-1,o=function n(){for(;++s<t.length;)if(i.call(t,s))return n.value=t[s],n.done=!1,n;return n.value=e,n.done=!0,n};return o.next=o}}throw new TypeError(typeof t+" is not iterable")}return M.prototype=C,s(H,"constructor",{value:C,configurable:!0}),s(C,"constructor",{value:M,configurable:!0}),M.displayName=c(C,h,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===M||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,C):(e.__proto__=C,c(e,h,"GeneratorFunction")),e.prototype=Object.create(H),e},t.awrap=function(e){return{__await:e}},N(B.prototype),c(B.prototype,l,(function(){return this})),t.AsyncIterator=B,t.async=function(e,n,i,s,o){void 0===o&&(o=Promise);var a=new B(u(e,n,i,s),o);return t.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},N(H),c(H,h,"Generator"),c(H,a,(function(){return this})),c(H,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var i in t)n.push(i);return n.reverse(),function e(){for(;n.length;){var i=n.pop();if(i in t)return e.value=i,e.done=!1,e}return e.done=!0,e}},t.values=Z,q.prototype={constructor:q,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(W),!t)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function s(i,s){return l.type="throw",l.arg=t,n.next=i,s&&(n.method="next",n.arg=e),!!s}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],l=a.completion;if("root"===a.tryLoc)return s("end");if(a.tryLoc<=this.prev){var h=i.call(a,"catchLoc"),c=i.call(a,"finallyLoc");if(h&&c){if(this.prev<a.catchLoc)return s(a.catchLoc,!0);if(this.prev<a.finallyLoc)return s(a.finallyLoc)}else if(h){if(this.prev<a.catchLoc)return s(a.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return s(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var s=this.tryEntries[n];if(s.tryLoc<=this.prev&&i.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var o=s;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,T):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),T},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),W(n),T}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var i=n.completion;if("throw"===i.type){var s=i.arg;W(n)}return s}}throw Error("illegal catch attempt")},delegateYield:function(t,n,i){return this.delegate={iterator:Z(t),resultName:n,nextLoc:i},"next"===this.method&&(this.arg=e),T}},t}function Ce(e,t){return Ce=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Ce(e,t)}function Pe(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"==typeof t?t:t+""}function Ie(e){var t="function"==typeof Map?new Map:void 0;return Ie=function(e){if(null===e||!function(e){try{return-1!==Function.toString.call(e).indexOf("[native code]")}catch(t){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return function(e,t,n){if(Se())return Reflect.construct.apply(null,arguments);var i=[null];i.push.apply(i,t);var s=new(e.bind.apply(e,i));return n&&Ce(s,n.prototype),s}(e,arguments,we(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),Ce(n,e)},Ie(e)}var ke,Oe,Ee=function(){function e(e,t,n){if(h(e)||h(t)?h(e.x)||h(e.y)?Array.isArray(e)&&(this.x=+e[0],this.y=+e[1],this.z=e[2]):(this.x=+e.x,this.y=+e.y,this.z=e.z):(this.x=+e,this.y=+t,this.z=n),this._isNaN())throw new Error("Position is NaN")}var t=e.prototype;return t.set=function(e,t,n){return this.x=e,this.y=t,this.z=n||0,this},t._abs=function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this},t._round=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},t._ceil=function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},t.distanceTo=function(e){var t=e.x-this.x,n=e.y-this.y;return Math.sqrt(t*t+n*n)},t.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t._floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},t._add=function(e,t){return h(e.x)?h(e[0])?(this.x+=e,this.y+=t):(this.x+=e[0],this.y+=e[1]):(this.x+=e.x,this.y+=e.y),this},t._sub=function(e,t){return h(e.x)?h(e[0])?(this.x-=e,this.y-=t):(this.x-=e[0],this.y-=e[1]):(this.x-=e.x,this.y-=e.y),this},t._substract=function(e,t){return c(t)?this._sub(e,t):this._sub(e)},t.substract=function(e,t){return this.sub(e,t)},t._multi=function(e){return this.x*=e,this.y*=e,this},t.div=function(e){return this.multi(1/e)},t._div=function(e){return this._multi(1/e)},t._isNaN=function(){return isNaN(this.x)||isNaN(this.y)||c(this.z)&&isNaN(this.z)},t.isZero=function(){return 0===this.x&&0===this.y},t.toArray=function(){return c(this.z)?[this.x,this.y,this.z]:[this.x,this.y]},t.toJSON=function(){var e={x:this.x,y:this.y};return c(this.z)&&(e.z=this.z),e},e}(),Re=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.closeTo=function(e,t){return t||(t=0),this.x>=e.x-t&&this.x<=e.x+t&&this.y>=e.y-t&&this.y<=e.y+t},n.unit=function(){return this.copy()._unit()},n._unit=function(){return this._div(this.mag()),this},n.perp=function(){return this.copy()._perp()},n._perp=function(){return[this.x,this.y]=[-this.y,this.x],this},n.angleWith=function(e){return this.angleWithSep(e.x,e.y)},n.angleWithSep=function(e,t){return Math.atan2(this.x*t-this.y*e,this.x*e+this.y*t)},n._rotate=function(e){var t=Math.cos(e),n=Math.sin(e),i=n*this.x+t*this.y;return this.x=t*this.x-n*this.y,this.y=i,this},n.rotate=function(e){return this.copy()._rotate(e)},n.abs=function(){return new t(Math.abs(this.x),Math.abs(this.y))},n.round=function(){return new t(Math.round(this.x),Math.round(this.y))},n.ceil=function(){return new t(Math.ceil(this.x),Math.ceil(this.y))},n.floor=function(){return new t(Math.floor(this.x),Math.floor(this.y))},n.copy=function(){return new t(this.x,this.y,this.z)},n.toFixed=function(e){return new t(this.x.toFixed(e),this.y.toFixed(e),c(this.z)?this.z.toFixed(e):void 0)},n.add=function(e,n){var i,s;return h(e.x)?h(e[0])?(i=this.x+e,s=this.y+n):(i=this.x+e[0],s=this.y+e[1]):(i=this.x+e.x,s=this.y+e.y),new t(i,s)},n.sub=function(e,n){var i,s;return h(e.x)?h(e[0])?(i=this.x-e,s=this.y-n):(i=this.x-e[0],s=this.y-e[1]):(i=this.x-e.x,s=this.y-e.y),new t(i,s)},n.multi=function(e){return new t(this.x*e,this.y*e)},n.equals=function(e){return e instanceof this.constructor&&(this.x===e.x&&this.y===e.y&&this.z===e.z)},t}(Ee);function Le(e){var t="data:image/svg+xml";return e.length>4&&".svg"===e.slice(-4)?1:e.slice(0,18)===t?2:0}function De(e,t){n&&De.node?De.node(e,t):e.src=t[0]}!function(){if(n)return ke=function(e){return setTimeout(e,16)},void(Oe=clearTimeout);ke=function(e){return requestAnimationFrame(e)},Oe=function(e){return cancelAnimationFrame(e)}}();var Fe=0;function He(){return Fe++}var Ne=He;function Be(e){return e&&g(e)?JSON.parse(e):e}function ze(...e){for(var t=e[0],n=1;n<e.length;n++){var i=e[n];if(i&&i.length)for(var s=0,o=i.length;s<o;s++)t.push(i[s])}return t.length}function Ge(...e){for(var t=[],n=-1,i=0;i<e.length;i++){var s=e[i];if(s&&s.length)for(var o=0,a=s.length;o<a;o++)t[++n]=s[o]}return t}function Ue(e,t){var n=t.indexOf(e);n>-1&&t.splice(n,1)}function Ve(e,t,n){if(!Array.isArray(e))return n?t.call(n,e):t(e);for(var i,s,o=[],a=0,l=e.length;a<l;a++)h(i=e[a])?o.push(null):Array.isArray(i)?o.push(Ve(i,t,n)):(s=n?t.call(n,i):t(i),o.push(s));return o}function je(e,t){return void 0===e?t:e}function We(e){return Math.sign?Math.sign(e):0===(e=+e)||isNaN(e)?Number(e):e>0?1:-1}function qe(e,t,n){return e*(1-n)+t*n}function Ze(e,t,n){if(e===n||e===t)return e;var i=n-t;return((e-t)%i+i)%i+t}function Xe(e,t,n){return Math.min(n,Math.max(t,e))}function Ye(e){return Array.isArray(e)&&e.length>0}var Je=/^([a-z][a-z\d+\-.]*:)?\/\//i;function $e(e){return Je.test(e)}var Ke=/^url\((['"])(.+)\1\)$/i,et=/^url\(([^'"].*[^'"])\)$/i;function tt(e){return g(e)?et.test(e)?1:Ke.test(e)?2:3:0}function nt(e){var t=tt(e);return 3===t?e:1===t?et.exec(e)[1]:2===t?Ke.exec(e)[2]:e}var rt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function it(e){if(ye.btoa)return window.btoa(e);for(var t,n,i=String(e),s="",o=0,a=rt;i.charAt(0|o)||(a="=",o%1);s+=a.charAt(63&t>>8-o%1*8)){if((n=i.charCodeAt(o+=3/4))>255)throw new Error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");t=t<<8|n}return s}function st(e,t){for(var n=atob(e),i=new ArrayBuffer(n.length),s=new Uint8Array(i),o=0;o<n.length;o++)s[o]=255&n.charCodeAt(o);return new Blob([i],{type:t})}function ot(e,t,n,i){return Math.atan2(i-t,n-e)}var at="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";function lt(e,t){if(!e&&!t)return!0;if(!e||!t)return!1;for(var n in e)if("center"===n){if(!t[n]||!ht(e[n][0],t[n][0])||!ht(e[n][1],t[n][1]))return!1}else if(e[n]!==t[n])return!1;return!0}function ht(e,t,n){return null==n&&(n=1e-6),e>=t-n&&e<=t+n}function ut(e=100,t=4,n=null,i=null){e||(e=100),t||(t=4);var s=this,o=this.isVisible();return t*=2,this._flashTimeout&&clearTimeout(this._flashTimeout),this._flashTimeout=setTimeout((function a(){if(0===t)return o?s.show():s.hide(),void(n&&(i?n.call(i):n()));t%2==0?s.hide():s.show(),t--,s._flashTimeout=setTimeout(a,e)}),e),this}function pt(e=[],t="_pt"){for(var n=[],i=0,s=e.length;i<s;i++){var o=e[i];if(o){o[t]||(o[t]=new Re(0,0));var a=o[t];a.x=0,a.y=0,n.push(a)}else n.push(null)}return n}function gt(e,t){t(e.data)}function mt(e){if(e&&0===e.indexOf("http://")||0===e.indexOf("https://"))return e;var t=document.createElement("a");return t.href=e,e=t.href,t=null,e}var At={cssWidth:"1px",cssHeight:"1px",width:1,height:1};function yt(e,t=1){var{width:n,height:i}=e;return At.cssWidth=n+"px",At.cssHeight=i+"px",At.width=Math.round(n*t),At.height=Math.round(i*t),At}var vt="_maptalks__internal_layer_",xt=["MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"],bt=["FeatureCollection","Feature","Point","LineString","Polygon"].concat(xt),wt=["markerFile","polygonPatternFile","linePatternFile","markerFillPatternFile","markerLinePatternFile"],Tt=[["markerWidth","markerHeight"],[],[null,"lineWidth"],[],[null,"markerLineWidth"]],Mt={lineWidth:1,lineOpacity:1,lineDx:1,lineDy:1,polygonOpacity:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerOpacity:1,markerFillOpacity:1,markerLineWidth:1,markerLineOpacity:1,textSize:1,textOpacity:1,textHaloRadius:1,textWrapWidth:1,textLineSpacing:1,textDx:1,textDy:1},Ct=["lineColor","polygonFill","markerFill","markerLineColor","textFill"],Pt=14,Ot=function(){function e(e,t){c(e)&&c(t)?(this.width=e,this.height=t):c(e.width)?(this.width=e.width,this.height=e.height):Array.isArray(e)&&(this.width=e[0],this.height=e[1])}var t=e.prototype;return t.copy=function(){return new e(this.width,this.height)},t.add=function(t,n){var i,s;return t instanceof e?(i=this.width+t.width,s=this.height+t.height):(i=this.width+t,s=this.height+n),new e(i,s)},t.equals=function(e){return this.width===e.width&&this.height===e.height},t.multi=function(t){return new e(this.width*t,this.height*t)},t._multi=function(e){return this.width*=e,this.height*=e,this},t._round=function(){return this.width=Math.round(this.width),this.height=Math.round(this.height),this},t.toPoint=function(){return new Re(this.width,this.height)},t.toArray=function(){return[this.width,this.height]},t.toJSON=function(){return{width:this.width,height:this.height}},e}(),Et="";function Rt(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}function Dt(e,t,n){if(!e)return e;for(;e.indexOf(t)>-1;)e=e.replace(t,n);return e}var Ht=/[\b\t\r\v\f]/gim;function Nt(e){return g(e)?e.replace(Ht,Et):e}function Bt(e){return Rt(e).split(/\s+/)}var zt="undefined"!=typeof document?document.createElement("canvas").getContext("2d"):null;function Ut(e,t){return Ut.node?Ut.node(e,t):(zt.font=t,zt.measureText(e).width)}function Vt(e,t,n){var i=Ut(e,t);return new Ot(i,n||Pt)}function Wt(e,t,n,i){if(!e||0===e.length)return[{text:"",width:0}];var s=h(i)?Ut(e,t):i,o=s/e.length,a=Math.floor(n/o/2);if(o>=n||a<=0)return[{text:"",width:n}];if(s<=n)return[{text:e,width:s}];for(var l=[],c=e.substring(0,a),u=o*a,f=a,g=e.length;f<g;f++){var m=e[f],A=Ut(c+m);A>=n?(l.push({text:c,width:u}),c=e.substring(f,a+f),f+=a-1,u=o*a):(c+=m,u=A),f>=g-1&&(u=Ut(c),l.push({text:c,width:u}))}return l}var qt=["{","}"];function Zt(e,t){if(!g(e))return e;var[n,i]=qt;if(-1===e.indexOf(n)&&-1===e.indexOf(i))return e;function s(e){if(!t)return Et;var n=t[e];return h(n)?Et:Array.isArray(n)?n.join():n}for(var o=function(e){e+=Et;for(var[t,n]=qt,i=[],s=!1,o=Et,a=0,l=e.length;a<l;a++){var h=e[a];s||h!==t||(s=!0),h===t&&s&&(o=Et),s&&h!==t&&h!==n&&(o+=h),h===n&&o&&(s=!1,i.push(o),o=Et)}return i}(e),a=0,l=o.length;a<l;a++){var c=o[a];e=Dt(e,""+n+c+i,s(c))}return e}function Xt(e,t){c(e)&&(e+="");var n=t.textMaxHeight||0,i=en(e=e||"",t);return n&&n<i.size.height&&(i.size.height=n),i}function Yt(e,t,n){var i=e.width,s=e.height;return new Re("left"===t?-i:"right"===t?0:-i/2,"top"===n?-s:"bottom"===n?0:-s/2)}var Qt="sans-serif",$t=14;function Kt(e){if(e.textFont)return e.textFont;var t=e.textSize;return h(t)&&(t=$t),(e.textStyle&&"normal"!==e.textStyle?e.textStyle+" ":"")+(e.textWeight&&"normal"!==e.textWeight?e.textWeight+" ":"")+t+"px "+(e.textFaceName&&function(e){for(var t=e.split(","),n=0;n<t.length;n++)t[n].trim&&(t[n]=t[n].trim()),t[n].indexOf(" ")>0&&'"'!==t[n][0]&&"'"!==t[n][0]&&(t[n]='"'+t[n]+'"');return t.join(",")}(e.textFaceName)||Qt)}function en(e,t){var n=Kt(t),i=t.textLineSpacing||0,s=Vt(e,n,t.textSize),o=s.width,a=s.height,l=t.textWrapCharacter||"\n",h=[],c=t.textWrapWidth;(!c||c>o)&&(c=o),g(e)||(e+="");var u=0;if(l&&e.indexOf(l)>=0)for(var f=e.split(l),m=0,A=f.length;m<A;m++){var w=f[m],T=Ut(w,n);if(T>c)for(var S=Wt(w,n,c,T),M=0,C=S.length;M<C;M++){var I=S[M].width;I>u&&(u=I),h.push({text:S[M].text,size:new Ot(I,a)})}else T>u&&(u=T),h.push({text:w,size:new Ot(T,a)})}else if(o>c)for(var E=Wt(e,n,c,o),D=0;D<E.length;D++){var H=E[D].width;H>u&&(u=H),h.push({text:E[D].text,size:new Ot(H,a)})}else o>u&&(u=o),h.push({text:e,size:s});var N=h.length;return{total:N,size:new Ot(u,a*N+i*(N-1)),rows:h,rawSize:s}}function tn(e){var t=0,n=e&&e.length||0;if(!n)return t;for(var i=0;i<n;i++)t=(t<<5)-t+e.charCodeAt(i),t|=0;return t}var nn=Object.freeze({__proto__:null,DEFAULT_FONT:Qt,DEFAULT_TEXTSIZE:$t,EMPTY_STRING:Et,describeText:Xt,escapeSpecialChars:Nt,getAlignPoint:Yt,getFont:Kt,hashCode:tn,replaceAll:Dt,replaceVariable:Zt,splitContent:Wt,splitTextToRow:en,splitWords:Bt,stringLength:Vt,stringWidth:Ut,trim:Rt}),rn=n?function(e){return e[0]}:function(e){for(var t=document.documentElement&&document.documentElement.style||{},n=0;n<e.length;n++)if(e[n]in t)return e[n];return!1},sn=rn(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]),un=rn(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"]),fn=rn(["transition","WebkitTransition","OTransition","MozTransition","msTransition"]),dn=rn(["filter","WebkitFilter","OFilter","MozFilter","msFilter"]);function pn(e,t){var n=document.createElement(e);return t&&Hn(n,t),n}function mn(e,t,n){var i=pn(e);return t&&Ln(i,t),n&&n.appendChild(i),i}function yn(e){if(!e)return this;if(ye.ielt9||ye.ie9){var t=pn("div");t.appendChild(e),t.innerHTML="",t=null}else e.parentNode&&e.parentNode.removeChild(e);return this}function vn(e,t,n,i){if(!(e&&e.addEventListener&&t&&n))return this;for(var s=function(t){t||(t=window.event),n.call(i||e,t)},o=t.split(" "),a=o.length-1;a>=0;a--){var l=o[a];if(l)e["Z__"+l]||(e["Z__"+l]=[]),wn(e,l,n)>=0&&(console.warn(e,"find '"+l+"' handler:",n," The old listener function will be removed"),bn(e,l,n)),e["Z__"+l].push({callback:s,src:n}),e.addEventListener(l,s,!!ye.supportsPassive&&{capture:!1,passive:!1})}return this}function bn(e,t,n){function i(t,n){"mousewheel"===t&&ye.gecko&&(t="DOMMouseScroll"),e.removeEventListener(t,n,!1)}if(!e||!e.removeEventListener||!t)return this;for(var s=t.split(" "),o=s.length-1;o>=0;o--){var a=s[o];if(a){if(!n&&e["Z__"+a]){for(var l=e["Z__"+a],h=0,c=l.length;h<c;h++)i(l[h].callback);return delete e["Z__"+a],this}var u=wn(e,a,n);if(u<0)return this;i(a,e["Z__"+a][u].callback),e["Z__"+a].splice(u,1)}}return this}function wn(e,t,n){if(!e||!e["Z__"+t]||!n)return-1;for(var i=e["Z__"+t],s=0,o=i.length;s<o;s++)if(i[s].src===n)return s;return-1}function Mn(e){return e.preventDefault?e.preventDefault():e.returnValue=!1,this}function Cn(e){return e._cancelBubble=!0,e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,this}function Pn(e){return e.onselectstart=function(){return!1},e.ondragstart=function(){return!1},e.setAttribute("unselectable","on"),this}function kn(e,t){return e?(ye.any3d?Bn(e,t):(e.style.left=t.x+"px",e.style.top=t.y+"px"),t):null}function En(e){var t=window.getComputedStyle(e),n=[parseInt(t["padding-left"]),parseInt(t["padding-top"])],i=e.getBoundingClientRect(),s=e.offsetWidth,o=e.offsetHeight;return e.__position=[i.left+n[0],i.top+n[1],s?i.width/s:1,o?i.height/o:1],e.__position}function Rn(e,t){e||(e=window.event);var n=t.__position;n||(n=En(t));var i=e;return i.touches&&i.touches.length&&(e=i.touches[0]),i.changedTouches&&i.changedTouches.length&&(e=i.changedTouches[0]),new Re((e.clientX-n[0]-t.clientLeft)/n[2],(e.clientY-n[1]-t.clientTop)/n[3])}function Ln(e,t){var n=e.style.cssText;return function(e,t){var n=e.length-t.length;return n>=0&&e.indexOf(t,n)===n}(n,";")||(n+=";"),e.style.cssText=n+t,this}function Dn(e,t){if(void 0!==e.classList)return e.classList.contains(t);var n=Nn(e);return n.length>0&&new RegExp("(^|\\s)"+t+"(\\s|$)").test(n)}function Fn(e,t){if(void 0===e.classList||Dn(e,t)){var n=Nn(e);Hn(e,(n?n+" ":"")+t)}else for(var i=Bt(t),s=0,o=i.length;s<o;s++)e.classList.add(i[s]);return this}function Hn(e,t){return h(e.className.baseVal)?e.className=t:e.className.baseVal=t,this}function Nn(e){return h(e.className.baseVal)?e.className:e.className.baseVal}function Bn(e,t){var n=t||new Re(0,0);return e.style[sn]=ye.any3d?"translate3d("+n.x+"px,"+n.y+"px,0px)":"translate("+n.x+"px,"+n.y+"px)",this}function zn(e){return/<[a-z\][\s\S]*>/i.test(e)}function Un(e,t){var n=Vn(e);g(t)?n.innerHTML=t:n.appendChild(t);var i=new Ot(n.clientWidth,n.clientHeight);return yn(n),i}function Vn(e){var t=document.createElement(e);return t.style.cssText="position:absolute;left:-10000px;top:-10000px;",document.body.appendChild(t),t}var jn=vn,Wn=bn;function qn(e){return e&&("mousemove"===e||"touchmove"===e)}function Zn(e,t){var n=a();return!!(e._mousemoveTime&&n-e._mousemoveTime<(t||48))||(e._mousemoveTime=n,!1)}var Xn=Object.freeze({__proto__:null,CSSFILTER:dn,MOUSEMOVE_THROTTLE_TIME:48,TRANSFORM:sn,TRANSFORMORIGIN:un,TRANSITION:fn,addClass:Fn,addDomEvent:vn,computeDomPosition:En,createEl:pn,createElOn:mn,getClass:Nn,getDomRuler:Vn,getEventContainerPoint:Rn,hasClass:Dn,isHTML:zn,isMousemoveEventBlocked:Zn,isMoveEvent:qn,listensDomEvent:wn,measureDom:Un,off:Wn,offsetDom:kn,on:jn,preventDefault:Mn,preventSelection:Pn,removeDomEvent:bn,removeDomNode:yn,removeTransform:function(e){return e.style[sn]&&(e.style[sn]=""),this},setClass:Hn,setOpacity:function(e,t){return e.style.opacity=t,this},setStyle:Ln,setTransform:Bn,setTransformMatrix:function(e,t){var n="matrix("+(g(t)?t:t.join())+")";return e.style[sn]!==n&&(e.style[sn]=n),this},stopPropagation:Cn}),Jn={jsonp:function(e,t){var n="_maptalks_jsonp_"+He();e.match(/\?/)?e+="&callback="+n:e+="?callback="+n;var i=document.createElement("script");return i.type="text/javascript",i.src=e,window[n]=function(e){t(null,e),document.getElementsByTagName("head")[0].removeChild(i),i=null,delete window[n]},document.getElementsByTagName("head")[0].appendChild(i),this},get:function(e,t,i){if(m(t)){var s=i;i=t,t=s}if(n&&Jn.get.node)return Jn.get.node(e,i,t);var o=Jn._getClient(i);if(o.open("GET",e,!0),t){for(var a in t.headers)o.setRequestHeader(a,t.headers[a]);o.withCredentials="include"===t.credentials,t.responseType&&(o.responseType=t.responseType)}return o.send(null),o},post:function(e,t,i){var s;if(g(e)){if(m(t)){var o=i;i=t,t=o}s=(t=t||{}).postData}else{s=t,e=(t=e).url,i=i}if(n&&Jn.post.node)return t.url=e,Jn.post.node(t,s,i);var a=Jn._getClient(i);if(a.open("POST",t.url,!0),t.headers||(t.headers={}),t.headers["Content-Type"]||(t.headers["Content-Type"]="application/x-www-form-urlencoded"),"setRequestHeader"in a)for(var l in t.headers)t.headers.hasOwnProperty(l)&&a.setRequestHeader(l,t.headers[l]);return g(s)||(s=JSON.stringify(s)),a.send(s),a},_wrapCallback:function(e,t){return function(){4===e.readyState&&(200===e.status?"arraybuffer"===e.responseType?0===e.response.byteLength?t(new Error("http status 200 returned without content.")):t(null,{data:e.response,cacheControl:e.getResponseHeader("Cache-Control"),expires:e.getResponseHeader("Expires"),contentType:e.getResponseHeader("Content-Type")}):t(null,e.responseText):t(new Error(e.statusText+","+e.status)))}},_getClient:function(e){var t;try{t=new XMLHttpRequest}catch(e){try{t=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{t=new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}}return t.onreadystatechange=Jn._wrapCallback(t,e),t},getArrayBuffer:function(e,t,n){if(m(t)){var i=n;n=t,t=i}return t||(t={}),t.responseType="arraybuffer",Jn.get(e,t,n)},getImage:function(e,t,n){return Jn.getArrayBuffer(t,n,(function(t,n){if(t)e.onerror&&e.onerror(t);else if(n){var i=window.URL||window.webkitURL,s=e.onload;e.onload=function(){s&&s(),i.revokeObjectURL(e.src)};var o=new Blob([new Uint8Array(n.data)],{type:n.contentType});e.cacheControl=n.cacheControl,e.expires=n.expires,e.src=n.data.byteLength?i.createObjectURL(o):at}}))},getJSON:function(e,t,n){}};Jn.getJSON=function(e,t,n){if(m(t)){var i=n;n=t,t=i}var s=function(e,t){var i=t?Be(t):null;n(e,i)};return t&&t.jsonp?Jn.jsonp(e,s):Jn.get(e,t,s)};var Kn="",er=/data:image\/.*;base64,/;function tr(e,t={}){for(var n in t){var i=t[n];if(i&&i.target&&(a=n,c(o=e)&&(o+=Kn),c(a)&&(a+=Kn),o&&a&&(o.includes?o.includes(a):o.indexOf(a)>-1))){var{target:s}=i;return e.replace(n,s)}}var o,a;return Kn}var nr,sr={host:Kn,resources:{},proxy:{},origin:{},fromJSON:function(e){try{g(e)&&(e=JSON.parse(e)),f(e)&&l(sr,e)}catch(e){console.error(e)}},toJSON:function(){return{host:sr.host,proxy:l({},sr.proxy||{}),origin:l({},sr.origin||{})}},getResource:function(e){return sr.resources[e]},removeResource:function(e){delete sr.resources[e]},addResource:function(e,t){sr.resources[e]?console.warn(e+" resource Already exists,the "+e+" Cannot be added,the resource name Cannot repeat "):sr.resources[e]=t},updateResource:function(e,t){sr.resources[e]=t},allResource:function(){return sr.resources},loadSprite:function(e={imgUrl:"",jsonUrl:""}){return new Promise((function(t,n){var{imgUrl:i,jsonUrl:s}=e;if(!i||!s)return n(new Error("not find imgUrl/jsonUrl from options")),void console.error(e);function o(e,t,n){e.width=t,e.height=n;var i=e.getContext("2d");return i.clearRect(0,0,t,n),i}function a(i={},s){var a=function(){var e;return ye.IS_NODE?console.error("Current environment does not support canvas dom"):e=pn("canvas"),e}();if(a){var l=[];for(var h in i){l.push({name:h,spriteItem:i[h]})}var c=function(){var e;return ye.decodeImageInWorker&&(e=new OffscreenCanvas(2,2)),e}(),u=e.sourceName||"";l.forEach((function(e){var t,{name:n,spriteItem:i}=e,{x:l,y:h,width:f,height:g}=i;c?(o(c,f,g).drawImage(s,l,h,f,g,0,0,f,g),t=c.transferToImageBitmap()):(o(a,f,g).drawImage(s,l,h,f,g,0,0,f,g),t=a.toDataURL());e.resource=t,sr.addResource(u+n,t)})),t(l)}else n(new Error("can not create canvas"))}Jn.getJSON(s,{},(function(e,t){if(e)n(e);else{var s=new Image;s.onload=function(){a(t,s)},s.onerror=function(e){n(e)},Jn.getImage(s,i,{})}}))}))},loadSvgs:function(e){return new Promise((function(t,n){var i="",s=[],o="",a="",l="";if(Array.isArray(e)||e instanceof NodeList)s=e;else if(f(e)){i=e.url,s=e.symbols,o=e.fill,a=e.stroke,l=e.sourceName||""}else g(e)&&(i=e);if(i||!s||0!==s.length){var h=[],c=function(e,t){var n=lr(t);n&&(n.forEach((function(e){o&&(e.fill=o),a&&(e.stroke=a)})),sr.addResource(l+e,n)),h.push({name:e,paths:n,body:t})};if(i&&g(i))fetch(i).then((function(e){return e.json()})).then((function(e){e.forEach((function(e){var{name:t,body:n}=e;c(t,n)})),t(h)})).catch((function(e){console.log(e),n(e)}));else if(s){for(var u=0,m=s.length;u<m;u++){var A=s[u],w=A.id;w&&c(w,"<xml><svg>"+A.innerHTML+"</svg></xml>")}t(h)}else n(new Error("not support svgs params type"))}else n(new Error("not find svgs data"))}))}};function or(e){if(c(e)&&(e+=Kn),!e)return console.error("resouce path is null,path:",e),e;if(!g(e))return e;if(function(e){return er.test(e)}(e)||function(e){return 0===e.indexOf("blob:")}(e))return e;if("$"===e[0])return sr.getResource(e.substring(1,1/0))||"";var t=sr.origin||{},n=$e(e);if(n&&f(t)){var i=tr(e,t);return i||e}var s=sr.proxy||{};if(f(s)){var o=tr(e,s);if(o)return o}var{host:a}=sr;return!n&&a&&g(a)?""+a+e:mt(e)}function ar(e,t){return e?e[t]&&e[t].value:null}function lr(e){var t=(nr||(nr=new DOMParser),nr).parseFromString(e,"text/xml").querySelector("svg");if(!t)return null;for(var n=t.childNodes,i=[],s=t.attributes,o=ar(s,"fill"),a=ar(s,"fill-opacity"),l=ar(s,"stroke"),h=ar(s,"stroke-opacity"),c=ar(s,"stroke-width"),u=0,f=n.length;u<f;u++){var g=n[u],m=g.attributes;if(m){var A=void 0,w="path"===(g.tagName||"").toLowerCase();if(A=w?ar(m,"d"):g){var T=ar(m,"fill")||o,S=ar(m,"stroke")||l,M={path:A};if(T&&(M.fill=T,M["fill-opacity"]=ar(m,"fill-opacity")||a||1),S&&(M.stroke=S,M["stroke-opacity"]=ar(m,"stroke-opacity")||h||1,M["stroke-width"]=ar(m,"stroke-width")||c||1),i.push(M),!w)for(var C in M)"path"!==C&&M.hasOwnProperty(C)&&g.setAttribute(C,M[C])}}}return i}let hr;const cr={width:100,height:10};let ur=!1;try{const e=new OffscreenCanvas(1,1);e.getContext("2d").fillText("hello",0,0),ur=!0}catch(e){ur=!1}let fr=class ColorIn{constructor(e,t={}){if(!Array.isArray(e))return void console.error("colors is not array");if(e.length<2)return void console.error("colors.length should >1");this.colors=e;let n=1/0,i=-1/0;for(let t=0,s=e.length;t<s;t++){const s=e[t][0];n=Math.min(s,n),i=Math.max(s,i)}this.min=n,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},cr,t),this._initImgData()}getImageData(){return this.imgData}_initImgData(){const e=function(){if(!hr){const{width:e,height:t}=cr;ur?hr=new OffscreenCanvas(e,t):(hr=document.createElement("canvas"),hr.width=e,hr.height=t)}return hr}(),{width:t,height:n}=this.options;e.width=t,e.height=n;const i=e.getContext("2d");i.clearRect(0,0,e.width,e.height);const s=i.createLinearGradient(0,0,e.width,0),{colors:o,valueOffset:a}=this;for(let e=0,t=o.length;e<t;e++){const[t,n]=o[e];s.addColorStop((t-this.min)/a,n)}i.fillStyle=s,i.fillRect(0,0,e.width,e.height),this.imgData=i.getImageData(0,0,e.width,e.height)}getColor(e){e=Math.max(this.min,e),e=Math.min(e,this.max);let t=Math.round((e-this.min)/this.valueOffset*this.imgData.width);t=Math.min(t,this.imgData.width-1);const n=4*t;return[this.imgData.data[n],this.imgData.data[n+1],this.imgData.data[n+2],this.imgData.data[n+3]]}};var dr;function pr(e){return null==e}function gr(e){return!pr(e)}function mr(e){return""===e}function Ar(e,t){var n,i,s;if(Rr(e)){var o,a=e.stops&&"object"==typeof e.stops[0][0],l=a||gr(e.property),h=a||!l,c=e.type||t||"exponential";if("exponential"===c)o=xr;else if("interval"===c)o=_r;else if("categorical"===c)o=yr;else if("identity"===c)o=Sr;else if("color-interpolate"===c)o=Tr;else{if("calculate-expression"!==c)throw new Error('Unknown function type "'+c+'"');o=Ir}if(a){var u={},f=[];for(let t=0;t<e.stops.length;t++){var g=e.stops[t];void 0===u[g[0].zoom]&&(u[g[0].zoom]={zoom:g[0].zoom,type:e.type,property:e.property,default:e.default,stops:[]}),u[g[0].zoom].stops.push([g[0].value,g[1]])}for(let e in u)f.push([u[e].zoom,Ar(u[e])]);n=function(t,n){const i=xr({stops:f,base:e.base},t)(t,n);return"function"==typeof i?i(t,n):i},i=!1,s=!1}else h?(n=function(t){const n=o(e,t);return"function"==typeof n?n(t):n},i=!0,s=!1):(n=function(t,n){const i=o(e,n?n[e.property]:null);return"function"==typeof i?i(t,n):i},i=!1,s=!0)}else n=function(){return e},i=!0,s=!0;return n.isZoomConstant=s,n.isFeatureConstant=i,n}function yr(e,t){for(let n=0;n<e.stops.length;n++)if(t===e.stops[n][0])return e.stops[n][1];return e.default}function _r(e,t){for(var n=0;n<e.stops.length&&!(t<e.stops[n][0]);n++);return e.stops[Math.max(n-1,0)][1]}function xr(e,t){for(var n=gr(e.base)&&!mr(e.base)?e.base:1,i=0;!(i>=e.stops.length||t<=e.stops[i][0]);)i++;return 0===i?e.stops[i][1]:i===e.stops.length?e.stops[i-1][1]:kr(t,n,e.stops[i-1][0],e.stops[i][0],e.stops[i-1][1],e.stops[i][1])}"function"==typeof Map&&(dr=new Map);const wr={width:100,height:1};function Tr(e,t){const n=e.stops;if(n&&n.length>1){let e;if(dr){const t=JSON.stringify(n);if(!dr.has(t)){const e=new fr(n,wr);dr.set(t,e)}e=dr.get(t)}else e=new fr(n,wr);const[i,s,o,a]=e.getColor(t);return[i/255,s/255,o/255,a/255]}return n&&1===n.length?n[0][1]:null}function Sr(e,t){return function(e,t,n){return gr(e)?e:gr(t)?t:gr(n)?n:null}(t,e.default)}function Ir(e,t){const n=String(e.property),i=e.expression,s=t;function o(t){return pr(t)||mr(t)||isNaN(t)?e.default:t}if(!gr(t)||mr(t)||isNaN(t)||t<0)return o(e.default);{const t=function e(t,n,i){const s=Number(i),o=String(n);return Array.isArray(t)?t.map((t=>e(t,o,s))):t===o?s:t}(i,n,s);return o(function t(n){if(!Array.isArray(n)){if("number"==typeof n)return n;throw new Error("Invalid expression format")}{const i=n[0];if(!["+","-","*","/"].includes(i))throw new Error(`Unknown operator: ${i}`);const s=n.slice(1).map((e=>t(e)));switch(i){case"+":return s.reduce(((e,t)=>e+t),0);case"-":return s.reduce(((e,t)=>e-t));case"*":return s.reduce(((e,t)=>e*t),1);case"/":return s.some((e=>0===e))?e.default:s.reduce(((e,t)=>e/t));default:throw new Error(`Unsupported operator: ${i}`)}}}(t))}}function kr(e,t,n,i,s,o){return"function"==typeof s?function(){var a=s.apply(void 0,arguments),l=o.apply(void 0,arguments);return kr(e,t,n,i,a,l)}:s.length?function(e,t,n,i,s,o){var a=[];for(let l=0;l<s.length;l++)a[l]=Er(e,t,n,i,s[l],o[l]);return a}(e,t,n,i,s,o):Er(e,t,n,i,s,o)}function Er(e,t,n,i,s,o){var a,l=i-n,h=e-n;return s*(1-(a=1===t?h/l:(Math.pow(t,h)-1)/(Math.pow(t,l)-1)))+o*a}function Rr(e){return e&&"object"==typeof e&&(e.stops||e.property&&"identity"===e.type||e.expression&&"calculate-expression"===e.type)}function Lr(e){for(const t in e)if(Rr(e[t]))return!0;return!1}function Dr(e){return Nr(e,"exponential")}function Fr(e,t){if(!e)return null;var n=!1;if(Array.isArray(e)){var i,s=[];for(let o=0;o<e.length;o++)(i=Fr(e[o],t))?(s.push(i),n=!0):s.push(e[o]);return n?s:e}var o,a={__fn_types_loaded:!0},l=[];for(o in e)e.hasOwnProperty(o)&&l.push(o);const h=function(e){Object.defineProperty(a,e,{get:function(){return this["__fn_"+e]||(this["__fn_"+e]=Dr(this["_"+e])),this["__fn_"+e].apply(this,t())},set:function(t){this["_"+e]=t},configurable:!0,enumerable:!0})};for(let t=0,i=l.length;t<i;t++)Rr(e[o=l[t]])?(n=!0,a["_"+o]=e[o],h(o)):a[o]=e[o];return n?a:e}function Hr(e){if(!e||!e.stops)return[];const t=[];for(let n=0,i=e.stops.length;n<i;n++)t.push(e.stops[n][1]);return t}function Nr(e,t){if(!Rr(e))return function(){return e};let n=!0,i=!0;const s=(e=JSON.parse(JSON.stringify(e))).stops;if(s)for(let e=0;e<s.length;e++)if(Rr(s[e][1])){const o=Nr(s[e][1],t);n=n&&o.isZoomConstant,i=i&&o.isFeatureConstant,s[e]=[s[e][0],o]}const o=Ar(e,t);return o.isZoomConstant=n&&o.isZoomConstant,o.isFeatureConstant=i&&o.isFeatureConstant,o}
/*!
      Feature Filter by

      (c) mapbox 2016 and maptalks 2018
      www.mapbox.com | www.maptalks.org
      License: MIT, header required.
  */const Br=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function Ur(e){return new Function("f",`var p = (f && f.properties || {}); return ${Vr(e)}`)}function Vr(e){if(!e)return"true";const t=e[0];if(e.length<=1)return"any"===t?"false":"true";const n="=="===t?qr(e[1],e[2],"===",!1):"!="===t?qr(e[1],e[2],"!==",!1):"<"===t||">"===t||"<="===t||">="===t?qr(e[1],e[2],t,!0):"any"===t?Xr(e.slice(1),"||"):"all"===t?Xr(e.slice(1),"&&"):"none"===t?Qr(Xr(e.slice(1),"||")):"in"===t?Yr(e[1],e.slice(2)):"!in"===t?Qr(Yr(e[1],e.slice(2))):"has"===t?Jr(e[1]):"!has"===t?Qr(Jr(e[1])):"contains"===t?function(e,t,n){const i=jr(e);return void 0!==n?`(${i} + '').indexOf("${t}") === ${n}`:`(${i} + '').indexOf("${t}") >= 0`}(e[1],e[2],e[3]):"true";return`(${n})`}function jr(e){return"$"===e[0]?"f."+e.substring(1):"p["+JSON.stringify(e)+"]"}function qr(e,t,n,i){if("object"==typeof(s=e)&&s&&e.op)return function(e,t,n,i){const s=e.property,o=e.op;let a=jr(s);return"length"!==o?(console.error(`not support ${o} op`),"false"):(a=`((${a}+='').length)`,Zr(a,s,t,n,i))}(e,t,n,i);var s;return Zr(jr(e),e,t,n,i)}function Zr(e,t,n,i,s){const o="$type"===t?Br.indexOf(n):JSON.stringify(n);return(s?`typeof ${e}=== typeof ${o}&&`:"")+e+i+o}function Xr(e,t){return e.map(Vr).join(t)}function Yr(e,t){"$type"===e&&(t=t.map((e=>Br.indexOf(e))));const n=JSON.stringify(t.sort($r)),i=jr(e);return t.length<=200?`${n}.indexOf(${i}) !== -1`:`function(v, a, i, j) {\n        while (i <= j) { var m = (i + j) >> 1;\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\n        }\n    return false; }(${i}, ${n},0,${t.length-1})`}function Jr(e){return"$id"===e?'"id" in f':`${JSON.stringify(e)} in p`}function Qr(e){return`!(${e})`}function $r(e,t){return e<t?-1:e>t?1:0}function Kr(e){const t=e._toJSON(),n=t.feature;return n.type=Br.indexOf(n.geometry.type),n.subType=t.subType,n}function ei(e){if(!Array.isArray(e))return ei([e]);const t=[];for(let n=0;n<e.length;n++){let i;i=!0===e[n].filter?function(){return!0}:Ur(e[n].filter),t.push(ni({},e[n],{filter:i}))}return t}function ni(e){for(let t=1;t<arguments.length;t++){const n=arguments[t];for(const t in n)e[t]=n[t]}return e}var ii=[],ai={};function li(e,t){return Fr(e,(function(){var e=t.getMap();return function(e,t,n){return e[0]=t,e[1]=n,e}(ii,e?e.getZoom():12,l({},t.getProperties(),function(e,t,n,i){return e["{bearing}"]=t,e["{pitch}"]=n,e["{zoom}"]=i,e}(ai,e&&e.getBearing()||0,e&&e.getPitch()||0,e?e.getZoom():10)))}))}var hi=Object.freeze({__proto__:null,compileStyle:ei,createFilter:Ur,getFilterFeature:Kr,getFunctionTypeResources:Hr,hasFunctionDefinition:Lr,interpolated:Dr,isFeatureFilter:function e(t){if(!0===t||!1===t)return!0;if(!Array.isArray(t)||0===t.length)return!1;switch(t[0]){case"has":case"!has":return 2===t.length&&("string"==typeof t[1]||t[1].property&&t[1].op);case"in":case"!in":return t.length>=2&&("string"==typeof t[1]||t[1].property&&t[1].op);case"==":case"!=":case">":case">=":case"<":case"<=":return 3===t.length&&("string"==typeof t[1]||t[1].property&&t[1].op);case"none":case"any":case"all":for(const n of t.slice(1))if(!e(n)&&"boolean"!=typeof n)return!1;return!0;case"contains":return!0;default:return!1}},isFunctionDefinition:Rr,loadFunctionTypes:Fr,loadGeoSymbol:li});function ci(e){var t={stroke:{stroke:e.markerLineColor,"stroke-width":e.markerLineWidth,"stroke-opacity":e.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:e.markerFill,"fill-opacity":e.markerFillOpacity}};return 0===t.stroke["stroke-width"]&&(t.stroke["stroke-opacity"]=0),t}function fi(e,t,n){if(!e.markerPath)return null;var i=1,s=ci(e);c(e.markerOpacity)&&(i=e.markerOpacity),c(e.opacity)&&(i*=e.opacity);var o,a={};if(s){for(var u in s.stroke)s.stroke.hasOwnProperty(u)&&(h(s.stroke[u])||(a[u]=s.stroke[u]));for(var f in s.fill)s.fill.hasOwnProperty(f)&&(h(s.fill[f])||(a[f]=s.fill[f]))}var m,A=e.markerPath;o=g(A)&&"$"===A[0]?sr.getResource(A.substring(1,1/0))||[]:Array.isArray(e.markerPath)?e.markerPath:[e.markerPath];for(var w=[],T=0;T<o.length;T++)(m=l({},m=g(o[T])?{path:o[T]}:o[T],a)).d=m.path,delete m.path,w.push(m);var S=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];i<1&&S.push('opacity="'+i+'"'),e.markerPathWidth&&e.markerPathHeight&&S.push('viewBox="0 0 '+e.markerPathWidth+" "+e.markerPathHeight+'"'),S.push('preserveAspectRatio="none"'),t&&S.push('width="'+t+'"'),n&&S.push('height="'+n+'"'),S.push("><defs></defs>");for(var M=0;M<w.length;M++)if(w[M].d instanceof Element)S.push(w[M].d.outerHTML);else{var C="<path ";for(var I in w[M])w[M].hasOwnProperty(I)&&(C+=" "+I+'="'+w[M][I]+'"');S.push(C+="></path>")}return S.push("</svg>"),"data:image/svg+xml;base64,"+it(S.join(" "))}function di(e,t){if(!e)return[];var n=e;Array.isArray(e)||(n=[e]);for(var i,s,o,a,l=[],h=wt,c=n.length-1;c>=0;c--)if(e=n[c]){t&&(e=mi(e));for(var u=0;u<h.length;u++)if(Rr(i=e[h[u]])&&(i=Hr(i)),i){Array.isArray(i)||(i=[i]);for(var f=0;f<i.length;f++)"url("===i[f].slice(0,4)&&(i[f]=nt(i[f])),l.push([i[f],e[(s=Tt[u])[0]],e[s[1]]])}if("path"===e.markerType&&e.markerPath)if(o=Rr(e.markerWidth)?200:e.markerWidth,a=Rr(e.markerHeight)?200:e.markerHeight,Rr(e.markerPath)){i=Hr(e.markerPath);for(var g=e.markerPath,m=0;m<i.length;m++)e.markerPath=i[m],l.push([fi(e),o,a]);e.markerPath=g}else l.push([fi(e),o,a])}return l}function mi(e){if(!e)return null;var t=e;if(n)return t;for(var i,s=wt,o=0,a=s.length;o<a;o++)(i=t[s[o]])&&(t[s[o]]=Ai(i));return t}function Ai(e){if(Rr(e)&&e.stops){for(var t=e.stops,n=0;n<t.length;n++)t[n][1]=Ai(t[n][1]);return e}return"url("===e.slice(0,4)&&(e=nt(e)),e}function yi(e){return e&&ye.decodeImageInWorker&&e instanceof ImageBitmap}function _i(e){return e&&e.colorStops}function vi(e){var t=[e.type];if(e.places&&t.push(e.places.join()),e.colorStops){for(var n=[],i=e.colorStops.length-1;i>=0;i--)n.push(e.colorStops[i].join());t.push(n.join(","))}return t.join("_")}function xi(e,t){if(!e)return 1;var n=[];if(Array.isArray(e)){for(var i=0;i<e.length;i++)n.push(xi(e[i],t));return n.sort().join(",")}var s=Object.keys(e).sort().reduce((function(n,i){return t&&0!==i.indexOf(t)||(n[i]=e[i]),n}),{});return tn(JSON.stringify(s))}function bi(e,t){function n(e,t){h(e.opacity)?e.opacity=t:e.opacity*=t}var i;if(Array.isArray(e)){i=[];for(var s=0;s<e.length;s++){var o=l({},e[s]);n(o,t),i.push(o)}}else n(i=l({},e),t);return i}function wi(...e){var t=e[0],n=Array.prototype.slice.call(e,1);if(n&&n.length||(n=[{}]),Array.isArray(t)){for(var i,s,o=[],a=0,c=t.length;a<c;a++){i=t[a],s={};for(var u=0,f=n.length;u<f;u++)Array.isArray(n[u])?h(n[u][a])?l(s,i||{}):l(s,i,n[u][a]):l(s,i,n[u]?n[u]:{});o.push(s)}return o}var g=[{},t];return g.push.apply(g,n),l.apply(this,g)}function Ti(e){if(e.symbol&&(e=[e]),Array.isArray(e))return e;var t=e.$root,n=e.$iconset;if(e=e.style,t||n){t&&"/"===t[t.length-1]&&(t=t.substring(0,t.length-1)),n&&"/"===n[n.length-1]&&(n=n.substring(0,n.length-1));Si(e,(function(e){return"{$root}"===e?t:"{$iconset}"===e?n:null}))}return e}function Si(e,t){for(var n=0;n<e.length;n++){var{symbol:i}=e[n];i&&Pi(i,t)}}var Mi=/(\{\$root\}|\{\$iconset\})/g;function Pi(e,t){for(var n in e)e.hasOwnProperty(n)&&"textName"!==n&&(g(e[n])&&e[n].length>2?e[n]=e[n].replace(Mi,t):Rr(e[n])?e[n]=Ii(e[n],t):f(e[n])&&Pi(e[n],t))}function Ii(e,t){var n=e.default;g(n)&&(e.default=n.replace(Mi,t));var i=e.stops;if(!i)return e;for(var s=0;s<i.length;s++)Array.isArray(i[s])&&(g(i[s][1])?i[s][1]=i[s][1].replace(Mi,t):Rr(i[s][1])&&(i[s][1]=Ii(i[s][1],t)));return e}function ki(e=[]){Array.isArray(e)||(e=[e]);for(var t=e.length,n=0;n<t;n++){var i=e[n];if(i.style){var{lineDasharray:s,lineWidth:o}=i.style;if(o&&c(o)&&o>0&&s&&Array.isArray(s)&&s.length)return!0}}return!1}function Oi(e,t,n,i,s){var o=1/Math.tan(t/2),a=1/(i-s);return e[0]=o/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(s+i)*a,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*s*i*a,e[15]=0,e}function Li(e,t,n){var i,s,o,a,l,h,c,u,f,g,m,A,w=n[0],T=n[1],S=n[2];return t===e?(e[12]=t[0]*w+t[4]*T+t[8]*S+t[12],e[13]=t[1]*w+t[5]*T+t[9]*S+t[13],e[14]=t[2]*w+t[6]*T+t[10]*S+t[14],e[15]=t[3]*w+t[7]*T+t[11]*S+t[15]):(s=t[1],o=t[2],a=t[3],l=t[4],h=t[5],c=t[6],u=t[7],f=t[8],g=t[9],m=t[10],A=t[11],e[0]=i=t[0],e[1]=s,e[2]=o,e[3]=a,e[4]=l,e[5]=h,e[6]=c,e[7]=u,e[8]=f,e[9]=g,e[10]=m,e[11]=A,e[12]=i*w+l*T+f*S+t[12],e[13]=s*w+h*T+g*S+t[13],e[14]=o*w+c*T+m*S+t[14],e[15]=a*w+u*T+A*S+t[15]),e}function Di(e,t,n){var i=n[0],s=n[1],o=n[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Fi(e,t,n){var i=Math.sin(n),s=Math.cos(n),o=t[4],a=t[5],l=t[6],h=t[7],c=t[8],u=t[9],f=t[10],g=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=o*s+c*i,e[5]=a*s+u*i,e[6]=l*s+f*i,e[7]=h*s+g*i,e[8]=c*s-o*i,e[9]=u*s-a*i,e[10]=f*s-l*i,e[11]=g*s-h*i,e}function Bi(e,t,n){var i=Math.sin(n),s=Math.cos(n),o=t[0],a=t[1],l=t[2],h=t[3],c=t[4],u=t[5],f=t[6],g=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*s+c*i,e[1]=a*s+u*i,e[2]=l*s+f*i,e[3]=h*s+g*i,e[4]=c*s-o*i,e[5]=u*s-a*i,e[6]=f*s-l*i,e[7]=g*s-h*i,e}function zi(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3],l=t[4],h=t[5],c=t[6],u=t[7],f=t[8],g=t[9],m=t[10],A=t[11],w=t[12],T=t[13],S=t[14],M=t[15],C=n[0],I=n[1],E=n[2],D=n[3];return e[0]=C*i+I*l+E*f+D*w,e[1]=C*s+I*h+E*g+D*T,e[2]=C*o+I*c+E*m+D*S,e[3]=C*a+I*u+E*A+D*M,e[4]=(C=n[4])*i+(I=n[5])*l+(E=n[6])*f+(D=n[7])*w,e[5]=C*s+I*h+E*g+D*T,e[6]=C*o+I*c+E*m+D*S,e[7]=C*a+I*u+E*A+D*M,e[8]=(C=n[8])*i+(I=n[9])*l+(E=n[10])*f+(D=n[11])*w,e[9]=C*s+I*h+E*g+D*T,e[10]=C*o+I*c+E*m+D*S,e[11]=C*a+I*u+E*A+D*M,e[12]=(C=n[12])*i+(I=n[13])*l+(E=n[14])*f+(D=n[15])*w,e[13]=C*s+I*h+E*g+D*T,e[14]=C*o+I*c+E*m+D*S,e[15]=C*a+I*u+E*A+D*M,e}function Ui(e,t){var n=t[0],i=t[1],s=t[2],o=t[3],a=t[4],l=t[5],h=t[6],c=t[7],u=t[8],f=t[9],g=t[10],m=t[11],A=t[12],w=t[13],T=t[14],S=t[15],M=n*l-i*a,C=n*h-s*a,I=n*c-o*a,E=i*h-s*l,D=i*c-o*l,H=s*c-o*h,N=u*w-f*A,B=u*T-g*A,z=u*S-m*A,U=f*T-g*w,j=f*S-m*w,W=g*S-m*T,q=M*W-C*j+I*U+E*z-D*B+H*N;return q?(e[0]=(l*W-h*j+c*U)*(q=1/q),e[1]=(s*j-i*W-o*U)*q,e[2]=(w*H-T*D+S*E)*q,e[3]=(g*D-f*H-m*E)*q,e[4]=(h*z-a*W-c*B)*q,e[5]=(n*W-s*z+o*B)*q,e[6]=(T*I-A*H-S*C)*q,e[7]=(u*H-g*I+m*C)*q,e[8]=(a*j-l*z+c*N)*q,e[9]=(i*z-n*j-o*N)*q,e[10]=(A*D-w*I+S*M)*q,e[11]=(f*I-u*D-m*M)*q,e[12]=(l*B-a*U-h*N)*q,e[13]=(n*U-i*B+s*N)*q,e[14]=(w*C-A*E-T*M)*q,e[15]=(u*E-f*C+g*M)*q,e):null}function ji(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function qi(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}var Zi=Object.freeze({__proto__:null,DEFAULT_FONT:Qt,DEFAULT_TEXTSIZE:$t,EMPTY_STRING:Et,GUID:Ne,IS_NODE:n,UID:He,_defaults:function(e,t){for(var n=Object.getOwnPropertyNames(t),i=0;i<n.length;i++){var s=n[i],o=Object.getOwnPropertyDescriptor(t,s);o&&o.configurable&&void 0===e[s]&&Object.defineProperty(e,s,o)}return e},b64toBlob:st,btoa:it,calCanvasSize:yt,get cancelAnimFrame(){return Oe},checkMTKVersion:s,clamp:Xe,computeDegree:ot,convertResourceUrl:mi,convertStylePath:Si,copy:qi,describeText:Xt,emptyImageUrl:at,equalMapView:lt,escapeSpecialChars:Nt,extend:l,extendSymbol:wi,extractCssUrl:nt,flash:ut,forEachCoord:Ve,getAbsoluteURL:mt,getAlignPoint:Yt,getExternalResources:di,getFont:Kt,getGlobalThis:i,getGradientStamp:vi,getImageBitMap:gt,getMarkerPathBase64:fi,getPointsResultPts:pt,getSymbolHash:xi,getSymbolStamp:function(e,t){return xi(e,t)},getValueOrDefault:je,hasOwn:w,hashCode:tn,identity:ji,interpolate:qe,invert:Ui,isArrayHasData:Ye,isCssUrl:tt,isDashLine:ki,isEmpty:function(e){var t;for(t in e)return!1;return!t},isFunction:m,isGradient:_i,isImageBitMap:yi,isInteger:u,isNil:h,isNoContentHttpCode:function(e){return 204===e||e>=400&&e<500||501===e},isNumber:c,isObject:f,isSVG:Le,isString:g,isURL:$e,join:function(e,t){return e.join?e.join(t||","):Array.prototype.join.call(e,t||",")},loadImage:De,log2:function(e){if(Math.log2)return Math.log2(e);var t=Math.log(e)*Math.LOG2E,n=Math.round(t);return Math.abs(n-t)<1e-14?n:t},lowerSymbolOpacity:bi,mergeArray:Ge,multiply:zi,now:a,parseJSON:Be,parseStyleRootPath:Ti,parseSymbolPath:Pi,perspective:Oi,pushIn:ze,removeFromArray:Ue,replaceAll:Dt,replaceVariable:Zt,get requestAnimFrame(){return ke},rotateX:Fi,rotateZ:Bi,scale:Di,sign:We,splitContent:Wt,splitTextToRow:en,splitWords:Bt,stringLength:Vt,stringWidth:Ut,toDegree:M,toRadian:S,translate:Li,translateToSVGStyles:ci,trim:Rt,wrap:Ze});"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function Yi(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Ji=Qi;function Qi(e,t,n){var i,s,o,a,l,h=e.length,c=Ki(e[0],t),u=[];for(n||(n=[]),i=1;i<h;i++){for(s=e[i-1],a=l=Ki(o=e[i],t);;){if(!(c|a)){u.push(s),a!==l?(u.push(o),i<h-1&&(n.push(u),u=[])):i===h-1&&u.push(o);break}if(c&a)break;c?c=Ki(s=$i(s,o,c,t),t):a=Ki(o=$i(s,o,a,t),t)}c=l}return u.length&&n.push(u),n}function $i(e,t,n,i){return 8&n?[e[0]+(t[0]-e[0])*(i[3]-e[1])/(t[1]-e[1]),i[3]]:4&n?[e[0]+(t[0]-e[0])*(i[1]-e[1])/(t[1]-e[1]),i[1]]:2&n?[i[2],e[1]+(t[1]-e[1])*(i[2]-e[0])/(t[0]-e[0])]:1&n?[i[0],e[1]+(t[1]-e[1])*(i[0]-e[0])/(t[0]-e[0])]:null}function Ki(e,t){var n=0;return e[0]<t[0]?n|=1:e[0]>t[2]&&(n|=2),e[1]<t[1]?n|=4:e[1]>t[3]&&(n|=8),n}Qi.polyline=Qi,Qi.polygon=function(e,t){var n,i,s,o,a,l,h;for(i=1;i<=8;i*=2){for(n=[],o=!(Ki(s=e[e.length-1],t)&i),a=0;a<e.length;a++)(h=!(Ki(l=e[a],t)&i))!==o&&n.push($i(s,l,i,t)),h&&n.push(l),s=l,o=h;if(!(e=n).length)break}return n};var ns=Yi(Ji),rs=1/0,is=1/0,ss=-1/0,ls=-1/0;function hs(){return[rs,is,ss,ls]}var fs=hs();function ds(e){e[0]=rs,e[1]=is,e[2]=ss,e[3]=ls}function ps(e,t){if(e)if(Array.isArray(e[0]))for(var n=0,i=e.length;n<i;n++)ps(e[n],t);else if(Array.isArray(e))for(var s=0,o=e.length;s<o;s++){var{x:a,y:l}=e[s];t[0]=Math.min(a,t[0]),t[1]=Math.min(l,t[1]),t[2]=Math.max(a,t[2]),t[3]=Math.max(l,t[3])}else{var{x:h,y:c}=e;t[0]=Math.min(h,t[0]),t[1]=Math.min(c,t[1]),t[2]=Math.max(h,t[2]),t[3]=Math.max(c,t[3])}}function As(e,t,n,i,s){(0===t||t)&&(Array.isArray(t)&&(n=t[1],i=t[2],s=t[3],t=t[0]),e[0]=Math.min(t,e[0]),e[1]=Math.min(n,e[1]),e[2]=Math.max(i,e[2]),e[3]=Math.max(s,e[3]))}function ys(e){return e&&e[0]!==1/0&&void 0!==e[0]}function _s(e,t=0){e[0]-=t,e[1]-=t,e[2]+=t,e[3]+=t}function vs(e,t){return!(e[2]<t[0])&&(!(e[1]>t[3])&&(!(e[0]>t[2])&&!(e[3]<t[1])))}function xs(e,t){var[n,i,s,o]=e;return n>=t[0]&&s<=t[2]&&i>=t[1]&&o<=t[3]}function ws(e,t){var n=t.bbox;if(!n)return console.error("maskGeoJSON bbox is null:",t),!1;if(vs(n,e)){var i=t.geometry;if(!i)return console.error("maskGeoJSON is error,not find geometry.",t),!1;var{coordinates:s}=i;"Polygon"===i.type&&(s=[s]);for(var o=0,a=s.length;o<a;o++){var l=ns.polygon(s[o][0],e);if(l.length>0){for(var h=1/0,c=-1/0,u=1/0,f=-1/0,g=0,m=l.length;g<m;g++){var[A,w]=l[g];h=Math.min(A,h),u=Math.min(w,u),c=Math.max(A,c),f=Math.max(w,f)}if(h!==c&&u!==f)return!0}}return!1}return!1}var Ss=Object.freeze({__proto__:null,BBOX_TEMP:fs,bboxInBBOX:xs,bboxInMask:ws,bboxIntersect:vs,bufferBBOX:_s,getDefaultBBOX:hs,pointsBBOX:ps,resetBBOX:ds,setBBOX:As,validateBBOX:ys}),Ms=function(){function e(){this.resources=new Map,this._errors=new Map}var t=e.prototype;return t.addResource=function(e,t){var n=this,i=this._getImgUrl(e);if(this.resources.set(i,{image:t,width:+e[1],height:+e[2],refCnt:0}),t&&t.width&&t.height&&!t.close&&ye.imageBitMap&&!ye.safari&&!ye.iosWeixin){if(t.src&&Le(t.src))return;createImageBitmap(t).then((function(e){n.resources.has(i)&&(n.resources.get(i).image=e)}))}},t.isResourceLoaded=function(e,t){if(!e)return!1;var n=this._getImgUrl(e);if(this._errors.has(n))return!0;var i=this.resources.get(n);return!!i&&!(t&&Le(e[0])&&(+e[1]>i.width||+e[2]>i.height))},t.login=function(e){var t=this.resources.get(e);t&&t.refCnt++},t.logout=function(e){var t=this.resources.get(e);t&&t.refCnt--<=0&&(t.image&&t.image.close&&t.image.close(),this.resources.delete(e))},t.getImage=function(e){var t=this._getImgUrl(e);return!this.isResourceLoaded(e)||this._errors.has(t)?null:this.resources.get(t).image},t.markErrorResource=function(e){var t=this._getImgUrl(e);this._errors.set(t,1)},t.merge=function(e){var t=this;if(!e)return this;var n=e.resources;return n&&n.forEach((function(e,n){t.addResource([n,e.width,e.height],e.image)})),this},t.forEach=function(e){return this.resources?(this.resources.forEach((function(t,n){e(n,t)})),this):this},t._getImgUrl=function(e){return yi(e)?e:Array.isArray(e)?e[0]:e},t.remove=function(){return this.resources?(this.resources.forEach((function(e){e&&e.image&&e.image.close&&e.image.close()})),this.resources.clear(),this):this},e}(),Cs=function(){function e(){this.resources={},this._errors={}}var t=e.prototype;return t.addResource=function(e,t){var n=this;if(this.resources[e[0]]={image:t,width:+e[1],height:+e[2],refCnt:0},t&&t.width&&t.height&&!t.close&&ye.imageBitMap&&!ye.safari&&!ye.iosWeixin){if(t.src&&Le(t.src))return;createImageBitmap(t).then((function(t){n.resources[e[0]]&&(n.resources[e[0]].image=t)}))}},t.isResourceLoaded=function(e,t){if(!e)return!1;var n=this._getImgUrl(e);if(this._errors[n])return!0;var i=this.resources[n];return!!i&&!(t&&Le(e[0])&&(+e[1]>i.width||+e[2]>i.height))},t.login=function(e){var t=this.resources[e];t&&t.refCnt++},t.logout=function(e){var t=this.resources[e];t&&t.refCnt--<=0&&(t.image&&t.image.close&&t.image.close(),delete this.resources[e])},t.getImage=function(e){var t=this._getImgUrl(e);return!this.isResourceLoaded(e)||this._errors[t]?null:this.resources[t].image},t.markErrorResource=function(e){this._errors[this._getImgUrl(e)]=1},t.merge=function(e){if(!e)return this;for(var t in e.resources){var n=e.resources[t];this.addResource([t,n.width,n.height],n.image)}return this},t.forEach=function(e){if(!this.resources)return this;for(var t in this.resources)w(this.resources,t)&&e(t,this.resources[t]);return this},t._getImgUrl=function(e){return Array.isArray(e)?e[0]:e},t.remove=function(){for(var e in this.resources){var t=this.resources[e];t&&t.image&&t.image.close&&t.image.close()}this.resources={}},e}();function Ps(){return ye.decodeImageInWorker?new Ms:new Cs}function Is(e,t,n,i){return e[0]=t,e[1]=n,e[2]=i,e}function ks(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e}function Os(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}function Es(e,t,n){return Os(e,t,n)}function Rs(e){var t=e[0],n=e[1],i=e[2];return Math.sqrt(t*t+n*n+i*i)}function Ds(e,t){var n=t[0],i=t[1],s=t[2],o=n*n+i*i+s*s;return o>0&&(o=1/Math.sqrt(o),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o),e}function Fs(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function Bs(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}function zs(e,t,n){var i=t[0],s=t[1],o=t[2],a=n[0],l=n[1],h=n[2];return e[0]=s*h-o*l,e[1]=o*a-i*h,e[2]=i*l-s*a,e}function Gs(e,t){var n=t[0]-e[0],i=t[1]-e[1],s=t[2]-e[2];return Math.hypot?Math.hypot(n,i,s):function(...e){var t=0,n=e.length;for(;n--;)t+=e[n]*e[n];return Math.sqrt(t)}(n,i,s)}function Us(e,t){Ds(e,e),Ds(t,t);var n=Fs(e,t);return n>1?0:n<-1?Math.PI:Math.acos(n)}var Vs,js=function(){function e(e,t){this.normal=e,this.constant=t}return e.prototype.distanceToPoint=function(e){return Fs(this.normal,e)+this.constant},e}(),qs=[0,0,0],Zs=[0,0,0],Xs=[0,0,0],Ys=[0,0,0],Qs=[0,0,0],Ks=new js([0,0,1],0),eo=function(){function e(e,t){this.setFromTo(e,t)}var t=e.prototype;return t.setFromTo=function(e,t){this.origin=e;var n=this.direction||[0,0,0];this.direction=Ds(n,Es(n,t,e))},t.distanceToPlane=function(e){var t=Fs(e.normal,this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;var n=-(Fs(this.origin,e.normal)+e.constant)/t;return n>=0?n:null},t.intersectGround=function(e){return this.intersectPlane(Ks,e)},t.distanceToGround=function(){return this.distanceToPlane(Ks)},t.intersectPlane=function(e,t){var n=this.distanceToPlane(e);return null===n?null:this.at(n,t)},t.intersectBox=function(e,t){var n,i,s,o,a,l,h=1/this.direction[0],c=1/this.direction[1],u=1/this.direction[2],f=this.origin;return h>=0?(n=(e[0][0]-f[0])*h,i=(e[1][0]-f[0])*h):(n=(e[1][0]-f[0])*h,i=(e[0][0]-f[0])*h),c>=0?(s=(e[0][1]-f[1])*c,o=(e[1][1]-f[1])*c):(s=(e[1][1]-f[1])*c,o=(e[0][1]-f[1])*c),n>o||s>i?null:((s>n||isNaN(n))&&(n=s),(o<i||isNaN(i))&&(i=o),u>=0?(a=(e[0][2]-f[2])*u,l=(e[1][2]-f[2])*u):(a=(e[1][2]-f[2])*u,l=(e[0][2]-f[2])*u),n>l||a>i?null:((a>n||n!=n)&&(n=a),(l<i||i!=i)&&(i=l),i<0?null:this.at(n>=0?n:i,t)))},t.intersectTriangle=function(e,t,n,i,s){Es(Zs,t,e),Es(Xs,n,e),zs(Ys,Zs,Xs);var o,a=Fs(this.direction,Ys);if(a>0){if(i)return null;o=1}else{if(!(a<0))return null;o=-1,a=-a}Es(Qs,this.origin,e),zs(Xs,Qs,Xs);var l=o*Fs(this.direction,Xs);if(l<0)return null;zs(Zs,Zs,Qs);var h=o*Fs(this.direction,Zs);if(h<0)return null;if(l+h>a)return null;var c=-o*Fs(Qs,Ys);return c<0?null:this.at(c/a,s)},t.at=function(e,t){return function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2]}(t,this.origin),ks(t,t,Bs(qs,this.direction,e))},e}(),to=Object.freeze({__proto__:null,Plane:js,Ray:eo}),no="core-fetch-image";var ro=!1;var so=[];function ao(e){return so.indexOf(e)>-1}function lo(e){ao(e)||so.push(e)}var ho={};function co(e,t){ho[e]=t}var uo,fo="\n    var adapters = {};\n    // Dynamic Create Adapter\n    function createAdapter(key,code){\n        if(adapters[key]||!code){\n            return;\n        }\n        var func=new Function('exports',code+'(exports)');\n        var workerExports={};\n        func(workerExports,self);\n        adapters[key]=workerExports;\n        workerExports.initialize && workerExports.initialize(self);\n\n    }\n    onmessage = function (msg) {\n        msg = msg.data;\n        //createAdapter\n        if (msg.messageType === 'createAdapter') {\n           var key=msg.key;\n           var code=msg.code;\n           createAdapter(key,code);\n           postMessage({adapterName:key});\n           return;\n        }\n        // postMessage when main thread idle\n        if(msg.messageType==='idle'){\n            var messageRatio = msg.messageRatio;\n            handleMessageQueue(messageRatio);\n            return;\n        }\n        if (msg.messageType === 'batch') {\n            const messages = msg.messages;\n            if (messages) {\n                for (let i = 0; i < messages.length; i++) {\n                    dispatch(messages[i]);\n                }\n            }\n        } else {\n            dispatch(msg);\n        }\n    };\n\n    function dispatch(msg) {\n        var workerKey = msg.workerKey;\n        var adapter = adapters[workerKey];\n        if (!adapter) {\n            post(msg.callback, 'Unregistered worker adapters for ' + workerKey);\n            return;\n        }\n        try {\n            adapter.onmessage(msg, wrap(msg.callback));\n        } catch (err) {\n            post(msg.callback, workerKey + ':' + err.message);\n            console.error(err);\n            throw err;\n        }\n    }\n\n    var messageResultQueue = [];\n\n    function handleMessageQueue(messageRatio){\n       if(messageResultQueue.length===0){\n          return;\n       }\n       var count = Math.ceil((messageRatio || 1) * messageResultQueue.length);\n       var queues = messageResultQueue.slice(0, count);\n       queues.forEach(function(queue){\n          post(queue.callback,queue.err,queue.data,queue.buffers);\n       });\n       messageResultQueue=messageResultQueue.slice(count, Infinity);\n    }\n\n    function post(callback, err, data, buffers) {\n        var msg = {\n            callback : callback\n        };\n        if (err) {\n            msg.error = err;\n        } else {\n            msg.data = data;\n        }\n        if (buffers && buffers.length > 0) {\n            postMessage(msg, buffers);\n        } else {\n            postMessage(msg);\n        }\n    }\n\n    function joinQueue(callback,err,data,buffers){\n        messageResultQueue.push({\n            callback:callback,\n            err:err,\n            data:data,\n            buffers:buffers\n        });\n    }\n\n    function wrap(callback) {\n        return function (err, data, buffers) {\n            joinQueue(callback, err, data, buffers);\n        };\n    }\n    var workerExports;\n",po="\n    workerExports = null;\n";function go(){if("undefined"==typeof window)return null;if(!uo){var e=function(){var e=fo;for(var t in ho){var n=ho[t];lo(t),m(n)&&0===n.length&&(n=n()),e+="\n    workerExports = {};\n    ("+n+")(workerExports, self);\n    adapters['"+t+"'] = workerExports",e+="\n    workerExports.initialize && workerExports.initialize(self);\n        "}return e+po}();uo=window.URL.createObjectURL(new Blob([e],{type:"text/javascript"})),ho={}}return uo}function Ao(e,t){if(ho[e]){var n=ho[e];m(n)&&0===n.length&&(n=n()),n="("+n+")";if(Vs){var i=Vs.workers||[];0===i.length&&console.error("workerpool workers count is 0");var s=0,o=function(n){(n=n.data||{}).adapterName===e&&++s===i.length&&(i.forEach((function(e){e.removeEventListener("message",o)})),delete ho[e],t())};i.forEach((function(t){t.addEventListener("message",o),t.postMessage({key:e,code:n,messageType:"createAdapter"})}))}}else console.error("not find "+e+" adapter")}var yo,_o="undefined"!=typeof window?window.navigator.hardwareConcurrency||4:0,vo=Math.max(Math.floor(_o/2),1),xo=function(){function e(e=50){this._limit=e,this._messages=[],this.buffers=[]}var t=e.prototype;return t.addMessage=function(e,t){if(this._messages.push(e),Array.isArray(t))for(var n=0;n<t.length;n++)this.buffers.indexOf(t[n])<0&&this.buffers.push(t[n])},t.isFull=function(){return this._messages.length>=this._limit},t.getMessage=function(){return{messageType:"batch",messages:this._messages}},e}(),bo=function(){function e(){this.active={},this.workerCount="undefined"!=typeof window?o.workerCount||vo:0,this._messages=[],this._messageBuffers=[]}var t=e.prototype;return t.acquire=function(e){if(!this.workers){this.workers=[];for(var t=go(),n=0;n<this.workerCount;n++){var i=new Worker(t);i.id=n,this.workers.push(i)}URL.revokeObjectURL(t),ro=!0}return this.active[e]=!0,this.workers.slice()},t.release=function(e){delete this.active[e],0===Object.keys(this.active).length&&(this.workers.forEach((function(e){e.terminate()})),this.workers=null)},t.addMessage=function(e,t,n){var i=this._messages[e];i&&i.length||(i=this._messages[e]=[new xo]);var s=i[i.length-1];s.isFull()&&(s=new xo,this._messages[e].push(s)),s.addMessage(t,n)},t.commit=function(){if(this.workers&&this._messages.length)for(var e=0;e<this._messages.length;e++)if(this._messages[e]&&this._messages[e].length){var t=this._messages[e].shift();this.workers[e].postMessage(t.getMessage(),t.buffers)}},t.getWorkers=function(){return this.workers||[]},t.broadcastIdleMessage=function(e){return this.getWorkers().forEach((function(t){t.postMessage({messageType:"idle",messageRatio:e})})),this},e}();function wo(){return yo||(yo=new bo,Vs=yo),yo}var To=[],So=[];function Mo(e){return Ro(),new Promise((function(t,n){if(e)if(m(e)&&(e={count:1,run:e}),e.run)if(h(e.count)&&(e.count=1),e.count=Math.ceil(e.count),c(e.count)){var i=e;i.results=[],To.push(i),i.resolve=t}else n(new Error("task.count is not number"));else n(new Error("task.run is null"));else n(new Error("task is null"))}))}function Co(e){var t=o.messagePostRatioPerWorker*(e?.5:1);wo().commit(),wo().broadcastIdleMessage(t),function(){if(0!==To.length){for(var e=[],t=[],n=To.length,i=0;i<n;i++){var s=To[i];if(s.count--,-1===s.count)t.push(s);else{e.push(s);var o=s.run();s.results.push(o)}}To=e,n=t.length;for(var a=0;a<n;a++){var l=t[a];l.resolve&&l.resolve(l.results)}}}(),So.forEach((function(e){e()}))}var Po=a();function Io(){Co(),Po=a(),requestIdleCallback(Io)}function ko(){if(ye.requestIdleCallback){var{idleForceTimeThreshold:e,idleLog:t}=o;a()-Po>e&&(Co(!0),Po=a(),t&&console.warn("did not apply for availability, forced run idle"))}else Co();ke(ko)}var Oo=!1;function Ro(){Oo||(Oo=!0,ye.requestIdleCallback&&requestIdleCallback(Io),ke(ko))}function Lo(e){So.indexOf(e)>-1||m(e)&&So.push(e)}var Do=Object.freeze({__proto__:null,pushLoopHook:Lo,runTaskAsync:Mo,startTasks:Ro}),Fo=function(){function e(e,t){this.max=e,this.onRemove=t||function(){},this.reset()}var t=e.prototype;return t.reset=function(){if(this.data)for(var e,t=be(this.data.values());!(e=t()).done;){this.onRemove(e.value)}return this.data=new Map,this},t.clear=function(){this.reset(),delete this.onRemove},t.add=function(e,t){return t?(this.has(e)?(this.data.delete(e),this.data.set(e,t)):this.data.set(e,t),this):this},t.keys=function(){for(var e,t=new Array(this.data.size),n=0,i=be(this.data.keys());!(e=i()).done;){t[n++]=e.value}return t},t.shrink=function(){for(var e=this.data.keys(),t=e.next();this.data.size>this.max;){var n=this.getAndRemove(t.value);n&&this.onRemove(n),t=e.next()}},t.has=function(e){return this.data.has(e)},t.getAndRemove=function(e){if(!this.has(e))return null;var t=this.data.get(e);return this.data.delete(e),t},t.get=function(e){return this.has(e)?this.data.get(e):null},t.remove=function(e){if(!this.has(e))return this;var t=this.data.get(e);return this.data.delete(e),this.onRemove(t),this},t.setMaxSize=function(e){return this.max=e,this.data.size>this.max&&this.shrink(),this},e}(),Ho={exports:{}},No={exports:{}};!function(e,t){e.exports=function(){function e(e,n,s,o,a){t(e,n,s||0,o||e.length-1,a||i)}function t(e,i,s,o,a){for(;o>s;){if(o-s>600){var l=o-s+1,h=i-s+1,c=Math.log(l),u=.5*Math.exp(2*c/3),f=.5*Math.sqrt(c*u*(l-u)/l)*(h-l/2<0?-1:1);t(e,i,Math.max(s,Math.floor(i-h*u/l+f)),Math.min(o,Math.floor(i+(l-h)*u/l+f)),a)}var g=e[i],m=s,A=o;for(n(e,s,i),a(e[o],g)>0&&n(e,s,o);m<A;){for(n(e,m,A),m++,A--;a(e[m],g)<0;)m++;for(;a(e[A],g)>0;)A--}0===a(e[s],g)?n(e,s,A):n(e,++A,o),A<=i&&(s=A+1),i<=A&&(o=A-1)}}function n(e,t,n){var i=e[t];e[t]=e[n],e[n]=i}function i(e,t){return e<t?-1:e>t?1:0}return e}()}(No);var Go=No.exports;Ho.exports=Vo,Ho.exports.default=Vo;var Uo=Go;function Vo(e,t){if(!(this instanceof Vo))return new Vo(e,t);this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&this._initFormat(t),this.clear()}function jo(e,t,n){if(!n)return t.indexOf(e);for(var i=0;i<t.length;i++)if(n(e,t[i]))return i;return-1}function Wo(e,t){qo(e,0,e.children.length,t,e)}function qo(e,t,n,i,s){s||(s=ra(null)),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(var o,a=t;a<n;a++)o=e.children[a],Zo(s,e.leaf?i(o):o);return s}function Zo(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function Xo(e,t){return e.minX-t.minX}function Yo(e,t){return e.minY-t.minY}function Qo(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function $o(e){return e.maxX-e.minX+(e.maxY-e.minY)}function Ko(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function ea(e,t){var n=Math.max(e.minX,t.minX),i=Math.max(e.minY,t.minY),s=Math.min(e.maxX,t.maxX),o=Math.min(e.maxY,t.maxY);return Math.max(0,s-n)*Math.max(0,o-i)}function ta(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function na(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function ra(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function oa(e,t,n,i,s){for(var o,a=[t,n];a.length;)(n=a.pop())-(t=a.pop())<=i||(o=t+Math.ceil((n-t)/i/2)*i,Uo(e,o,t,n,s),a.push(t,o,o,n))}Vo.prototype={all:function(){return this._all(this.data,[])},search:function(e){var t=this.data,n=[],i=this.toBBox;if(!na(e,t))return n;for(var s,o,a,l,h=[];t;){for(s=0,o=t.children.length;s<o;s++)a=t.children[s],na(e,l=t.leaf?i(a):a)&&(t.leaf?n.push(a):ta(e,l)?this._all(a,n):h.push(a));t=h.pop()}return n},collides:function(e){var t=this.data,n=this.toBBox;if(!na(e,t))return!1;for(var i,s,o,a,l=[];t;){for(i=0,s=t.children.length;i<s;i++)if(o=t.children[i],na(e,a=t.leaf?n(o):o)){if(t.leaf||ta(e,a))return!0;l.push(o)}t=l.pop()}return!1},load:function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0,n=e.length;t<n;t++)this.insert(e[t]);return this}var i=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var s=this.data;this.data=i,i=s}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this},insert:function(e){return e&&this._insert(e,this.data.height-1),this},clear:function(){return this.data=ra([]),this},remove:function(e,t){if(!e)return this;for(var n,i,s,o,a=this.data,l=this.toBBox(e),h=[],c=[];a||h.length;){if(a||(a=h.pop(),i=h[h.length-1],n=c.pop(),o=!0),a.leaf&&-1!==(s=jo(e,a.children,t)))return a.children.splice(s,1),h.push(a),this._condense(h),this;o||a.leaf||!ta(a,l)?i?(n++,a=i.children[n],o=!1):a=null:(h.push(a),c.push(n),n=0,i=a,a=a.children[0])}return this},toBBox:function(e){return e},compareMinX:Xo,compareMinY:Yo,toJSON:function(){return this.data},fromJSON:function(e){return this.data=e,this},_all:function(e,t){for(var n=[];e;)e.leaf?t.push.apply(t,e.children):n.push.apply(n,e.children),e=n.pop();return t},_build:function(e,t,n,i){var s,o=n-t+1,a=this._maxEntries;if(o<=a)return Wo(s=ra(e.slice(t,n+1)),this.toBBox),s;i||(i=Math.ceil(Math.log(o)/Math.log(a)),a=Math.ceil(o/Math.pow(a,i-1))),(s=ra([])).leaf=!1,s.height=i;var l,h,c,u,f=Math.ceil(o/a),g=f*Math.ceil(Math.sqrt(a));for(oa(e,t,n,g,this.compareMinX),l=t;l<=n;l+=g)for(oa(e,l,c=Math.min(l+g-1,n),f,this.compareMinY),h=l;h<=c;h+=f)u=Math.min(h+f-1,c),s.children.push(this._build(e,h,u,i-1));return Wo(s,this.toBBox),s},_chooseSubtree:function(e,t,n,i){for(var s,o,a,l,h,c,u,f;i.push(t),!t.leaf&&i.length-1!==n;){for(u=f=1/0,s=0,o=t.children.length;s<o;s++)h=Qo(a=t.children[s]),(c=Ko(e,a)-h)<f?(f=c,u=h<u?h:u,l=a):c===f&&h<u&&(u=h,l=a);t=l||t.children[0]}return t},_insert:function(e,t,n){var i=n?e:(0,this.toBBox)(e),s=[],o=this._chooseSubtree(i,this.data,t,s);for(o.children.push(e),Zo(o,i);t>=0&&s[t].children.length>this._maxEntries;)this._split(s,t),t--;this._adjustParentBBoxes(i,s,t)},_split:function(e,t){var n=e[t],i=n.children.length,s=this._minEntries;this._chooseSplitAxis(n,s,i);var o=this._chooseSplitIndex(n,s,i),a=ra(n.children.splice(o,n.children.length-o));a.height=n.height,a.leaf=n.leaf,Wo(n,this.toBBox),Wo(a,this.toBBox),t?e[t-1].children.push(a):this._splitRoot(n,a)},_splitRoot:function(e,t){this.data=ra([e,t]),this.data.height=e.height+1,this.data.leaf=!1,Wo(this.data,this.toBBox)},_chooseSplitIndex:function(e,t,n){var i,s,o,a,l,h,c,u;for(h=c=1/0,i=t;i<=n-t;i++)a=ea(s=qo(e,0,i,this.toBBox),o=qo(e,i,n,this.toBBox)),l=Qo(s)+Qo(o),a<h?(h=a,u=i,c=l<c?l:c):a===h&&l<c&&(c=l,u=i);return u},_chooseSplitAxis:function(e,t,n){var i=e.leaf?this.compareMinX:Xo,s=e.leaf?this.compareMinY:Yo;this._allDistMargin(e,t,n,i)<this._allDistMargin(e,t,n,s)&&e.children.sort(i)},_allDistMargin:function(e,t,n,i){e.children.sort(i);var s,o,a=this.toBBox,l=qo(e,0,t,a),h=qo(e,n-t,n,a),c=$o(l)+$o(h);for(s=t;s<n-t;s++)o=e.children[s],Zo(l,e.leaf?a(o):o),c+=$o(l);for(s=n-t-1;s>=t;s--)o=e.children[s],Zo(h,e.leaf?a(o):o),c+=$o(h);return c},_adjustParentBBoxes:function(e,t,n){for(var i=n;i>=0;i--)Zo(t[i],e)},_condense:function(e){for(var t,n=e.length-1;n>=0;n--)0===e[n].children.length?n>0?(t=e[n-1].children).splice(t.indexOf(e[n]),1):this.clear():Wo(e[n],this.toBBox)},_initFormat:function(e){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this.toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}};var aa=Yi(Ho.exports),la={},ha=function(){function e(){this._tree=aa(9,["[0]","[1]","[2]","[3]"])}var t=e.prototype;return t.collides=function(e){return[la.minX,la.minY,la.maxX,la.maxY]=e,this._tree.collides(la)},t.insertBox=function(e){return this._tree.insert(e),this},t.bulkInsertBox=function(e){return this._tree.load(e),this},t.clear=function(){return this._tree.clear(),this},e}(),ca=new Fo(5e4);function ua(e,t,n){var i=e.font,s=e.fillStyle,o=e.strokeStyle,a=t.textHaloFill||fa,l=t.textHaloRadius||0,h=t.textHaloOpacity;c(h)||(h=1);var u=i+"_"+s+"_"+a+"_"+l+"_"+h+"_"+n,f=ca.get(u);if(!f){var g=0!==h&&0!==l,m=2*(1.2*(t.textSize||14)+l),A=Ea.createCanvas(m,m);A.style.width=m/2+"px",A.style.height=m/2+"px";var w=m/4,T=m/4,S=Ea.getCanvas2DContext(A);S.scale(2,2),S.font=i,S.textAlign="center",S.textBaseline="middle",g&&(S.strokeStyle=o,S.lineWidth=2*l,S.globalAlpha=1,S.globalAlpha*=h,S.strokeText(n,w,T),S.globalAlpha=1),S.fillStyle=s,S.fillText(n,w,T),ca.add(u,f=A)}return f}var fa="#000",da=!1,pa=null,ga=Math.PI/180,ma=new ha,Aa=new ha;var ya,_a=function(){for(var e={},t=32;t<128;t++){var n=String.fromCharCode(t);e[n]=n}return e}();function va(e){if(e.toReversed)return e.toReversed();for(var t=[],n=0,i=e.length-1;n<=i;n++)t[n]=e[i-n];return t}function xa(e,t,n,i,s){var o=Math.atan2(t.y-e.y,t.x-e.x),a=o/Math.PI*180;return"left"===i?o=(a+=180)/180*Math.PI:"down"!==i||s?"up"!==i||s?o:o=(a+=90)/180*Math.PI:o=(a-=90)/180*Math.PI}function Ta(e,t){var n=t,i=t;return _a[e]&&(n=t/4,i=t),Math.sqrt(n*n+i*i)}function Sa(e,t){var{distance:n,p1:i,p2:s}=e,o=t/n;return new Re(i.x+o*(s.x-i.x),i.y+o*(s.y-i.y),(i.z||0)+o*((s.z||0)-(i.z||0)))}function Ma(e){for(var t=e[0].point,n=e[e.length-1].point,i=hs(),s=0,o=e.length;s<o;s++){ps(e[s].point,i)}var[a,l,h,c]=i,u=!0;return c-l>h-a&&(u=!1),u?t.x<n.x?"right":"left":t.y<n.y?"down":"up"}function Ca(e,t,n,i){var s=Ia(e),o=[],a=0,l=!1;ma.clear();for(var h=1,c=0,u=t.length;c<u;c++){for(var f=t[c],g=Ta(f,n),m=g+a,A=h,w=e.length;A<w;A++){var T=e[A-1],S=e[A];if(!(S.distance<m)){h=A;var M=(m-T.distance)/(S.distance-T.distance),C=new Re(T.x+(S.x-T.x)*M,T.y+(S.y-T.y)*M),{x:I,y:E}=C,D=g/3,H=[I-D,E-D,I+D,E+D];if(i&&i.collides(H)){l=!0;break}if(ma.collides(H)){l=!0;break}ma.insertBox(H),o.push({char:f,charSize:g,point:C,bbox:[I-(D=g/2),E-D,I+D,E+D]}),a+=g;break}}if(l)break}return l||s<a?[]:o}function Pa(e,t,n,i,s,o,a,l,h,c){var u=(e+n)/2,f=(t+i)/2,g=(n+s)/2,m=(i+o)/2,A=(s+a)/2,w=(o+l)/2,T=Math.sqrt((n-e)*(n-e)+(i-t)*(i-t)),S=Math.sqrt((s-n)*(s-n)+(o-i)*(o-i)),M=T/(T+S),C=S/(S+Math.sqrt((a-s)*(a-s)+(l-o)*(l-o))),I=u+(g-u)*M,E=f+(m-f)*M,D=g+(A-g)*C,H=m+(w-m)*C,N=I+(g-I)*h+n-I,B=E+(m-E)*h+i-E,z=D+(g-D)*h+s-D,U=H+(m-H)*h+o-H,j=[N,B,z,U];return c<1?function(e,t,n,i,s,o,a,l,h,c){var u=1-e,f=1-t,g=n*f*f+2*s*t*f+a*t*t,m=s*f*f+2*a*t*f+h*t*t,A=i*f*f+2*o*t*f+l*t*t,w=o*f*f+2*l*t*f+c*t*t;return[(n*u*u+2*s*e*u+a*e*e)*f+(s*u*u+2*a*e*u+h*e*e)*t,(i*u*u+2*o*e*u+l*e*e)*f+(o*u*u+2*l*e*u+c*e*e)*t,g*u+m*e,A*u+w*e,g*f+m*t,A*f+w*t]}(0,c,n,i,N,B,z,U,s,o):j}function Ia(e){if(e.length<2)return 0;var t=0;e[0].distance=0;for(var n=1,i=e.length;n<i;n++){var s=e[n-1],o=e[n],a=s.distanceTo(o);o.distance=a+s.distance,t+=a}return t}function ka(e,t,n){var i=e.x,s=e.y;return new Re(i+(t.x-i)*n,s+(t.y-s)*n)}function Oa(e,t,n,i){return"rgba("+e+", "+t+", "+n+", "+i/255+")"}var Ea={getTempCanvas:function(){return ya||(ya=Ea.createCanvas(1,1)),ya},getCanvas2DPerformanceContext:function(e){return e.getContext("2d",{})},getCanvas2DContext:function(e){return e.getContext("2d",{willReadFrequently:!0})},setHitTesting:function(e){da=e},createCanvas:function(e,t,i){var s;return n?s=new i(e,t):((s=pn("canvas")).width=e,s.height=t),s},prepareCanvasFont:function(e,t,n){"top"!==e.textBaseline&&(e.textBaseline="top"),n=n||Kt(t),e.font!==n&&(e.font=n);var i=t.textFill;i||(i="#000");var s=Ea.getRgba(i,t.textOpacity);e.fillStyle!==s&&(e.fillStyle=s)},prepareCanvas:function(e,t,n,i){if(t){var s=t.lineWidth;h(s)||e.lineWidth===s||(e.lineWidth=s);var o=t.linePatternFile,a=t.lineColor||fa,l=t.lineStrokeColor,c=t.lineStrokeWidth;if(e.lineStrokeColor=null,e.lineStrokeWidth=null,l&&(Array.isArray(l)&&(l=Ea.normalizeColorToRGBA(l)),e.lineStrokeColor=l),c&&c>0&&(e.lineStrokeWidth=c),i)e.strokeStyle="#000";else if(o&&n){var u;(t.linePatternDx||t.linePatternDy)&&(u=[t.linePatternDx,t.linePatternDy]),Ea._setStrokePattern(e,o,s,u,n),t.lineDasharray=[]}else _i(a)?e.strokeStyle=t.lineGradientExtent?Ea._createGradient(e,a,t.lineGradientExtent):fa:(Array.isArray(a)&&(a=Ea.normalizeColorToRGBA(a)),e.strokeStyle=a);t.lineJoin&&(e.lineJoin=t.lineJoin),t.lineCap&&(e.lineCap=t.lineCap),e.setLineDash&&Ye(t.lineDasharray)&&e.setLineDash(t.lineDasharray);var f=t.polygonPatternFile,g=t.polygonFill||"rgba(255,255,255,0)";if(i)e.fillStyle="#000";else if(f&&n){var m=Da(f),A=n.getImage([m,null,null]);if(A||(A=n.getImage([m+"-texture",null,s])),Le(m)&&A instanceof Image&&(ye.edge||ye.ie)){var w=A.width||20,T=A.height||20,S=Ea.createCanvas(w,T);Ea.image(S.getContext("2d"),A,0,0,w,T),A=S}A?(e.fillStyle=e.createPattern(A,"repeat"),(t.polygonPatternDx||t.polygonPatternDy)&&(e.fillStyle.polygonPatternOffset=[t.polygonPatternDx,t.polygonPatternDy])):"undefined"!=typeof console&&console.warn("img not found for",m)}else _i(g)?e.fillStyle=t.polygonGradientExtent?Ea._createGradient(e,g,t.polygonGradientExtent):"rgba(255,255,255,0)":(Array.isArray(g)&&(g=Ea.normalizeColorToRGBA(g)),e.fillStyle=g)}},_createGradient:function(e,t,n){var i=null,s=t.places,o=n.getMin(),a=n.getMax(),l=n.getWidth(),h=n.getHeight();if(t.type&&"linear"!==t.type){if("radial"===t.type){if(s){if(6!==s.length)throw new Error("A radial gradient's places should have 6 numbers.");s=[o.x+s[0]*l,o.y+s[1]*h,l*s[2],o.x+s[3]*l,o.y+s[4]*h,l*s[5]]}else{var c=n.getCenter()._round();s=[c.x,c.y,Math.abs(c.x-o.x),c.x,c.y,0]}i=e.createRadialGradient.apply(e,s)}}else{if(s){if(4!==s.length)throw new Error("A linear gradient's places should have 4 numbers.");s=[o.x+s[0]*l,o.y+s[1]*h,o.x+s[2]*l,o.y+s[3]*h]}else s=[o.x,o.y,a.x,o.y];i=e.createLinearGradient.apply(e,s)}return t.colorStops.forEach((function(e){i.addColorStop.apply(i,e)})),i},_setStrokePattern:function(e,t,i,s,o){var a,l=Da(t);if(n)a=o.getImage([l,null,i]);else{var h=l+"-texture-"+i;if(!(a=o.getImage(h))){var c=o.getImage([l,null,null]);if(c){var u;u=c.width&&c.height?Math.round(c.width*i/c.height):i;var f=Ea.createCanvas(u,i,e.canvas.constructor);Ea.image(f.getContext("2d"),c,0,0,u,i),o.addResource([h,null,i],f),a=f}}}a?(e.strokeStyle=e.createPattern(a,"repeat"),e.strokeStyle.linePatternOffset=s):"undefined"!=typeof console&&console.warn("img not found for",l)},clearRect:function(e,t,n,i,s){e.canvas._drawn=!1,e.clearRect(t,n,i,s)},fillCanvas:function(e,t,n,i){if(da&&(t=1),e.canvas._drawn=!0,0!==t){var s,o=Ea._isPattern(e.fillStyle),a=e.fillStyle&&e.fillStyle.polygonPatternOffset,l=a?a[0]:0,c=a?a[1]:0;h(t)&&(t=1),t<1&&(s=e.globalAlpha,e.globalAlpha*=t),o&&e.translate((n=n||0)+l,(i=i||0)+c),e.fill(),o&&e.translate(-n-l,-i-c),t<1&&(e.globalAlpha=s)}},getRgba:function(e,t){return h(t)&&(t=1),"#"===e[0]&&1===t?e:"#"!==e[0]?(Array.isArray(e)&&(e=Ea.normalizeColorToRGBA(e,t)),e):(7===e.length?(n=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),s=parseInt(e.substring(5,7),16)):(n=17*parseInt(e.substring(1,2),16),i=17*parseInt(e.substring(2,3),16),s=17*parseInt(e.substring(3,4),16)),"rgba("+n+","+i+","+s+","+t+")");var n,i,s},normalizeColorToRGBA:function(e,t=1){return"rgba("+255*e[0]+", "+255*e[1]+", "+255*e[2]+", "+(4===e.length?e[3]:1)*t+")"},image:function(e,t,n,i,s,o){e.canvas._drawn=!0;try{c(s)&&c(o)?e.drawImage(t,n,i,s,o):e.drawImage(t,n,i)}catch(e){console&&(console.warn("error when drawing image on canvas:",e),console.warn(t))}},text:function(e,t,n,i,s){return Ea._textOnMultiRow(e,s.rows,i,n,s.size,s.rawSize)},_textOnMultiRow:function(e,t,n,i,s,o){var a,l,h=Yt(s,n.textHorizontalAlignment,n.textVerticalAlignment),c=o.height+n.textLineSpacing,u=i.add(0,h.y),f=n.textMaxHeight,g=0;ds(fs);for(var m=0,A=t.length;m<A;m++){a=t[m].text,l=Yt(t[m].size,n.textHorizontalAlignment,n.textVerticalAlignment);var w=u.add(l.x,m*c);Ea._textOnLine(e,a,w,n.textHaloRadius,n.textHaloFill,n.textHaloOpacity);var T=t[m].size,S=w.x,M=w.y;if(As(fs,S,M,S+T.width,M+T.height),f>0&&(g+=c)+T.height>=f)break}return fs},_textOnLine:function(e,t,n,i,s,o){da&&(o=1);var a,l,h=0!==o&&0!==i;e.textBaseline="top";var c=e.shadowBlur,u=e.shadowOffsetX,f=e.shadowOffsetY;if(h){var g=e.globalAlpha;e.globalAlpha*=o,e.miterLimit=2,e.lineJoin="round",e.lineCap="round",e.lineWidth=2*i,Array.isArray(s)&&(s=Ea.normalizeColorToRGBA(s)),e.strokeStyle=s,e.strokeText(t,n.x,n.y+1),e.miterLimit=10,e.globalAlpha=g,a=e.globalCompositeOperation,e.globalCompositeOperation="destination-out",l=e.fillStyle,e.fillStyle="#000"}c&&h&&(e.shadowBlur=e.shadowOffsetX=e.shadowOffsetY=0),Ea.fillText(e,t,n),a&&(e.globalCompositeOperation=a,Ea.fillText(e,t,n,l),c&&(e.shadowBlur=c,e.shadowOffsetX=u,e.shadowOffsetY=f))},fillText:function(e,t,n,i){e.canvas._drawn=!0,i&&(e.fillStyle=i),e.fillText(t,n.x,n.y+1)},textAlongLine:function(e,t,n,i,s,o){if(t){var a=i.textSize||14,l=i.textSpacing||0,h=function(e,t){for(var n=0,i=0,s=e.length;i<s;i++)n+=Ta(e[i],t);return n}(t,a);if(!(l<h)){Array.isArray(n[0])||(n=[n]);var u=e.textBaseline,f=e.textAlign,g=e.strokeStyle,m=e.globalAlpha,A=e.lineWidth,w=i.textAlongDebug,T=i.textHaloFill||fa,S=i.textHaloRadius||0,M=i.textHaloOpacity;c(M)||(M=1);var C=0!==M&&0!==S;e.textBaseline="middle",e.textAlign="center",C&&(Array.isArray(T)&&(T=Ea.normalizeColorToRGBA(T)),e.strokeStyle=T,e.lineWidth=2*S),Aa.clear();var I=hs(),E=t.split(""),D=function(e){for(var t=0,n=e.length;t<n;t++)if(!_a[e[t]])return!1;return!0}(E);if(n.forEach((function(t){if(!(Ia(t)<h)){var n=function(e,t){t=Object.assign({segDistance:1,isGeo:!0},t);for(var n=Math.max(t.segDistance,1e-17),i=[],s=0,o=0,a=0,l=e.length;a<l-1;a++){var h=e[a],c=e[a+1],u=c.distanceTo(h);i[o]={p1:h,distance:u,p2:c},o++,s+=u}if(s<=n)return[{distance:s,points:e}];var f,g=i.length;o=0;for(var m=0,A=[],w=[i[0].p1];o<g;){var{distance:T,p2:S}=i[o];if((m+=T)<n)w.push(S),o++;else if(m!==n){if(m>n){var M=n-(m-T);f=Sa(i[o],M),w.push(f),A.push(w),m=0,i[o].p1=f,i[o].distance=T-M,w=[f]}}else w.push(S),m=0,A.push(w),w=[S],o++}w.length&&A.push(w);for(var C=[],I=0,E=A.length;I<E;I++){var D=A[I];C[I]={points:D,distance:Ia(D)}}return C}(t,{segDistance:l});if(n&&n.length)for(var s=0,c=n.length;s<c;s++){var u=n[s];if(!(u.distance<h)){var f=u.points;if(w){var g=e.fillStyle;e.fillStyle="red";var{x:m,y:A}=f[0];e.beginPath(),e.fillRect(m-2,A-2,4,4),e.fillStyle=g}var T=E,S=Ca(f,T,a,o);if(S.length){var M=Ma(S);"left"===M&&(S=Ca(f,T=va(T),a,o)),"up"!==M||D||(S=Ca(f,T=va(T),a,o));for(var C=!1,H=0,N=S.length;H<N;H++){var{bbox:B}=S[H];if(Aa.collides(B)){C=!0;break}if(o&&o.collides(B)){C=!0;break}}if(!C)for(var z=0,U=S.length;z<U;z++){var j=void 0,W=void 0;0===z?(j=S[z].point,W=S[1].point):z===U-1?(j=S[U-2].point,W=S[U-1].point):(j=S[z-1].point,W=S[z].point);var q=T[z],{point:Z,bbox:X}=S[z];Aa.insertBox(X),o&&o.insertBox(X);var{x:Y,y:J}=Z,Q=xa(j,W,0,M,D);e.save(),e.translate(Y,J),e.rotate(Q);var $=ua(e,i,q),{width:K,height:ee}=$;if(e.drawImage($,-K/4,-ee/4,K/2,ee/2),e.restore(),As(I,X),w){var te=e.strokeStyle,re=e.lineWidth;e.strokeStyle="red",e.lineWidth=.5;var[se,oe,le,he]=X;e.beginPath(),e.rect(se,oe,le-se,he-oe),e.stroke(),e.lineWidth=re,e.strokeStyle=te}}}}}}})),e.textBaseline=u,e.textAlign=f,e.strokeStyle=g,e.globalAlpha=m,e.lineWidth=A,ys(I))return I}}},_stroke:function(e,t,n,i){if(da&&(t=1),e.canvas._drawn=!0,0!==t){!function(){if(e.lineStrokeColor&&e.lineStrokeWidth&&e.lineStrokeWidth>0){var n=e.lineStrokeColor,i=e.lineStrokeWidth,s=e.globalAlpha,o=e.strokeStyle,a=e.lineWidth;c(t)&&t<1&&(e.globalAlpha=1,e.globalAlpha*=t),e.lineWidth=a+2*i,e.strokeStyle=n,e.stroke(),e.lineWidth=a,e.strokeStyle=o,e.globalAlpha=s}}();var s,o=e.strokeStyle&&e.strokeStyle.linePatternOffset,a=o?o[0]:0,l=o?o[1]:0,u=Ea._isPattern(e.strokeStyle)&&(!h(n)&&!h(i)||!h(a)&&!h(l));h(t)&&(t=1),t<1&&(s=e.globalAlpha,e.globalAlpha*=t),u&&e.translate((n=n||0)+a,(i=i||0)+l),e.stroke(),u&&e.translate(-n-a,-i-l),t<1&&(e.globalAlpha=s)}},_gradientPath:function(e,t,n,i,s=!1){if(c(i)||(i=1),da&&(i=1),0!==i&&0!==e.lineWidth){var o=e.globalAlpha;e.globalAlpha*=i;var a,l,h,u,f,g,m,A=e.lineColorIn,w=function(e){if(c(e.minStep))return e.minStep;for(var t=e.colors||[],n=t.length,i=[],s=0;s<n;s++)i[s]=t[s][0];i.sort((function(e,t){return e-t}));for(var o=1/0,a=1;a<n;a++)o=Math.min(o,i[a]-i[a-1]);return e.minStep=o,o}(A),T=Ia(t),S=0,[M,C,I,E]=A.getColor(0);a=Oa(M,C,I,E);var D=t[0];if(h=D.x,u=D.y,s)D.equals(t[t.length-1])||t.push(D);for(var H=n&&Array.isArray(n)&&n.length>1,N=function(){!H&&m&&(e.strokeStyle=l,e.beginPath(),e.moveTo(h,u),e.lineTo(f,g),e.lineTo(m.x,m.y),e.stroke());var t=e.createLinearGradient(h,u,f,g);t.addColorStop(0,a),t.addColorStop(1,l),e.strokeStyle=t,e.beginPath(),e.moveTo(h,u),e.lineTo(f,g),e.stroke(),a=l,h=f,u=g},B=1,z=t.length;B<z;B++){var U=t[B-1],j=t[B];m=t[B+1];var W=j.x,q=j.y,Z=j.distanceTo(U)/T;if(Z<=w){var[X,Y,J,Q]=A.getColor(S+Z);l=Oa(X,Y,J,Q),f=W,g=q,N()}else{var $=Math.ceil(Z/w);m=j;for(var K=1;K<=$;K++){var ee=Math.min(K*w,Z),[te,re,se,oe]=A.getColor(S+ee);if((l=Oa(te,re,se,oe))!==a){var le=ka(U,j,ee/Z);f=le.x,g=le.y,N()}}}S+=Z}e.globalAlpha=o}},_path:function(e,t,n,i,s){if(Ye(t))for(var o,a=Ye(n),l=!0!==s&&Ea._isPattern(e.strokeStyle),h=0,c=t.length;h<c;h++)if(o=t[h],!a||e.setLineDash)e.lineTo(o.x,o.y),l&&h>0&&(u(t[h-1],o),e.beginPath(),e.moveTo(o.x,o.y));else if(a){if(h===c-1)break;Ra(e,o,t[h+1],n)}function u(t,n){var s=ot(t.x,t.y,n.x,n.y);e.save();var o=Math.cos(s);Math.abs(o)<1e-7?e.translate(t.x-e.lineWidth/2,t.y):e.translate(t.x,t.y-e.lineWidth/2/o),e.rotate(s),Ea._stroke(e,i),e.restore()}},path:function(e,t,n,i,s){Ye(t)&&(e.lineColorIn?Ea._gradientPath(e,t,s,n):(e.beginPath(),e.moveTo(t[0].x,t[0].y),Ea._path(e,t,s,n)),Ea._stroke(e,n))},roundRect:function(e,t,n,i){if(ye.roundRect){for(var s=1/0,o=1/0,a=-1/0,l=-1/0,h=0,u=t.length;h<u;h++){var f=t[h],{x:g,y:m}=f;s=Math.min(s,g),o=Math.min(o,m),a=Math.max(a,g),l=Math.max(l,m)}var A=Math.abs(a-s),w=Math.abs(l-o);if(!(A*w<=0)){var T=Math.min(A,w);e.roundRect(s,o,A,w,T/4);var S=e.globalAlpha;c(i)&&i<1&&(e.globalAlpha=1,e.globalAlpha*=i),e.fill(),e.globalAlpha=S,c(n)&&n<1&&(e.globalAlpha=1,e.globalAlpha*=n),e.stroke(),e.globalAlpha=S}}},_multiClip:function(e,t){t&&0!==t.length&&t.forEach((function(t){for(var n=0,i=t.length;n<i;n++){var s=t[n],o=s.x,a=s.y;0===n?e.moveTo(o,a):e.lineTo(o,a),n===i-1&&e.lineTo(o=t[0].x,a=t[0].y)}}))},polygon:function(e,t,i,s,o,a){if(e.isMultiClip)Ea._multiClip(e,t);else if(e.isClip)Ea._multiClip(e,Array.isArray(t[0])?t:[t]);else if(Ye(t)){var l=Ea._isPattern(e.strokeStyle),h=Ye(o)&&!e.setLineDash||l&&!a;Ye(t[0])||(t=[t]);var c=e,u=e.dpr||1,f=1!==u;t.length>1&&!n&&(pa||(pa=Ea.createCanvas(1,1)),e.canvas._drawn=!1,pa.width=e.canvas.width,pa.height=e.canvas.height,Ha(e=pa.getContext("2d"),[]),Ha(e,o),Fa(e,c),f&&e.scale(u,u));var g,m,A,w=e.lineColorIn,T=e.lineWidth;if(h){for(e.save(),m=0,A=t.length;m<A;m++)Ye(t[m])&&(w&&(e.lineWidth=.1),Ea._ring(e,t[m],null,0,!0),g=s,m>0&&(e.globalCompositeOperation="destination-out",g=1),Ea.fillCanvas(e,g,t[m][0].x,t[m][0].y),m>0?e.globalCompositeOperation="source-over":A>1&&(e.fillStyle="#fff"),Ea._stroke(e,0),e.lineWidth=T,w&&Ea._gradientPath(e,t,null,0,!0));e.restore()}var S=e.fillStyle;for(m=0,A=t.length;m<A;m++)Ye(t[m])&&(w&&(e.lineWidth=.1),a?(Ea.paintSmoothLine(e,t[m],i,a,!0),e.closePath()):Ea._ring(e,t[m],o,i),h||(g=s,m>0&&(e.globalCompositeOperation="destination-out",g=1),Ea.fillCanvas(e,g,t[m][0].x,t[m][0].y),m>0?e.globalCompositeOperation="source-over":A>1&&(e.fillStyle="#fff")),Ea._stroke(e,i),e.lineWidth=T,w&&Ea._gradientPath(e,t[m],o,i,!0));if(e.fillStyle!==S&&(e.fillStyle=S),t.length>1&&!n){if(f){var M=1/u;c.scale(M,M)}c.drawImage(pa,0,0),f&&c.scale(u,u),c.canvas._drawn=e.canvas._drawn,Fa(c,e)}}},_ring:function(e,t,n,i,s){var o=Ea._isPattern(e.strokeStyle);s||!o||t[0].equals(t[t.length-1])||(t=t.concat([t[0]])),e.beginPath(),e.moveTo(t[0].x,t[0].y),Ea._path(e,t,n,i,s),o||e.closePath()},paintSmoothLine_bak:function(e,t,n,i,s,o,a){if(t)if(t.length<=2||!i)Ea.path(e,t,n);else{var l,h=t.length,c=s?h:h-1;e.beginPath(),e.moveTo(t[0].x,t[0].y),void 0!==a&&(c-=Math.max(c-o-1,0));for(var u=0;u<c;u++){var f=void 0,g=void 0,m=void 0,A=void 0,w=void 0,T=void 0;u-1<0?s?(f=t[c-1].x,g=t[c-1].y):(f=t[u+1].x,g=t[u+1].y):(f=t[u-1].x,g=t[u-1].y),u+1<h?(m=t[u+1].x,A=t[u+1].y):(m=t[u+1-h].x,A=t[u+1-h].y),u+2<h?(w=t[u+2].x,T=t[u+2].y):s?(w=t[u+2-h].x,T=t[u+2-h].y):(w=t[u].x,T=t[u].y);var S=Pa(f,g,t[u].x,t[u].y,m,A,w,T,i,u===c-1?a:1);if(u===c-1&&a>=0&&a<1){e.bezierCurveTo(S[0],S[1],S[2],S[3],S[4],S[5]),t.splice(c-1,h-(c-1)-1);var M=new Re(S[4],S[5]);M.prevCtrlPoint=new Re(S[2],S[3]),t.push(M),h=t.length}else e.bezierCurveTo(S[0],S[1],S[2],S[3],m,A);t[u].nextCtrlPoint=S.slice(0,2),t[u].prevCtrlPoint=l?l.slice(2):null,l=S}!s&&t[1].prevCtrlPoint&&(t[0].nextCtrlPoint=t[1].prevCtrlPoint,delete t[0].prevCtrlPoint),t[h-1].prevCtrlPoint||(t[h-1].prevCtrlPoint=t[h-2].nextCtrlPoint),Ea._stroke(e,n)}},paintSmoothLine:function(e,t,n,i,s,o,a){if(t)if(t.length<=2||!i)Ea.path(e,t,n);else{var l,h,c=t.length,u=s?c:c-1;e.beginPath(),e.moveTo(t[0].x,t[0].y),void 0!==a&&(u-=Math.max(u-o-1,0));for(var f=0;f<u;f++){var g=void 0,m=void 0,A=void 0,w=void 0,T=void 0,S=void 0;f-1<0?s?(g=t[u-1].x,m=t[u-1].y):(g=t[f+1].x,m=t[f+1].y):(g=t[f-1].x,m=t[f-1].y),f+1<c?(A=t[f+1].x,w=t[f+1].y):(A=t[f+1-c].x,w=t[f+1-c].y),f+2<c?(T=t[f+2].x,S=t[f+2].y):s?(T=t[f+2-c].x,S=t[f+2-c].y):(T=t[f].x,S=t[f].y);var M=t[f],C=Pa(g,m,t[f].x,t[f].y,A,w,T,S,i,f===u-1?a:1);if(f===u-1&&a>=0&&a<1){e.bezierCurveTo(C[0],C[1],C[2],C[3],C[4],C[5]),t.splice(u-1,c-(u-1)-1);var I=new Re(C[4],C[5]);t.push(I),c=t.length}else e.bezierCurveTo(C[0],C[1],C[2],C[3],A,w);0===f?(M.arrowNextPoint=M.arrowNextPoint||new Re(0,0),h=C[3],M.arrowNextPoint.x=l=C[2],M.arrowNextPoint.y=h):(M.arrowPrePoint=M.arrowPrePoint||new Re(0,0),M.arrowPrePoint.x=l,M.arrowPrePoint.y=h,l=C[2],h=C[3],f===u-1&&t[f+1]&&(t[f+1].arrowPrePoint=t[f+1].arrowPrePoint||new Re(0,0),t[f+1].arrowPrePoint.x=C[0],t[f+1].arrowPrePoint.y=C[1]))}Ea._stroke(e,n)}},_arcBetween:function(e,t,n,i){var s=Math.abs(i),o=t.distanceTo(n),a=Math.abs(o/2/Math.sin(s/2)),l=Math.asin((n.y-t.y)/o);t.x>n.x&&(l=Math.PI-l);var h=l-(90*ga-s/2),c=Math.cos(h)*a,u=Math.sin(h)*a,f=t.x+c,g=t.y+u,m=Math.asin((n.y-g)/a);f>n.x&&(m=Math.PI-m);var A=m+s;if(i<0){m+=Math.PI,A+=Math.PI;var w=(t.x+n.x)/2,T=(t.y+n.y)/2;f=w-(f-w),g=T-(g-T)}e.beginPath(),e.arc(f,g,a,m,A);var S=(A-m)/100,M=Math.cos(m+S)*a+f,C=Math.sin(m+S)*a+g,I=Math.cos(A-S)*a+f,E=Math.sin(A-S)*a+g;return t.arrowNextPoint=t.arrowNextPoint||new Re(0,0),n.arrowPrePoint=n.arrowPrePoint||new Re(0,0),i<0?(t.arrowNextPoint.x=M,t.arrowNextPoint.y=C,n.arrowPrePoint.x=I,n.arrowPrePoint.y=E):(t.arrowNextPoint.x=I,t.arrowNextPoint.y=E,n.arrowPrePoint.x=M,n.arrowPrePoint.y=C),[f,g]},_lineTo:function(e,t){e.lineTo(t.x,t.y)},bezierCurveAndFill:function(e,t,n,i){e.beginPath();var s=t[0];e.moveTo(s.x,s.y);var o=[e];o.push.apply(o,t.splice(1)),Ea._bezierCurveTo.apply(Ea,o),Ea.fillCanvas(e,i),Ea._stroke(e,n)},_bezierCurveTo:function(e,t,n,i){e.bezierCurveTo(t.x,t.y,n.x,n.y,i.x,i.y)},ellipse:function(e,t,n,i,s,o,a){e.beginPath(),n===i&&n===s?e.arc(t.x,t.y,n,0,2*Math.PI):e.ellipse?i!==s?(e.ellipse(t.x,t.y,n,i,0,180*ga,360*ga,!1),e.ellipse(t.x,t.y,n,s,0,0,180*ga,!1)):e.ellipse(t.x,t.y,n,i,0,0,360*ga,!1):function(t,n,i,s,o){var a=.5522848,l=i*a,h=s*a,c=o*a;e.moveTo(t-i,n),e.bezierCurveTo(t-i,n-h,t-l,n-s,t,n-s),e.bezierCurveTo(t+l,n-s,t+i,n-h,t+i,n),e.bezierCurveTo(t+i,n+c,t+l,n+o,t,n+o),e.bezierCurveTo(t-l,n+o,t-i,n+c,t-i,n),e.closePath()}(t.x,t.y,n,i,s),Ea.fillCanvas(e,a,t.x-n,t.y-i),Ea._stroke(e,o,t.x-n,t.y-i)},rectangle:function(e,t,n,i,s){var{x:o,y:a}=t;e.beginPath(),e.rect(o,a,n.width,n.height),Ea.fillCanvas(e,s,o,a),Ea._stroke(e,i,o,a)},sector:function(e,t,n,i,s,o){var a=ga;function l(e,t,n,i,l,h){var c=a*-h,u=a*-l;e.beginPath(),e.moveTo(t,n),e.arc(t,n,i,c,u),e.lineTo(t,n),Ea.fillCanvas(e,o,t-i,n-i),Ea._stroke(e,s,t-i,n-i)}l(e,t.x,t.y,n,i[0],i[1])},_isPattern:function(e){return!g(e)&&!("addColorStop"in e)},drawCross:function(e,t,n,i,s){e.canvas._drawn=!0,e.strokeStyle=s,e.lineWidth=i,e.beginPath(),e.moveTo(t-5,n),e.lineTo(t+5,n),e.moveTo(t,n-5),e.lineTo(t,n+5),e.stroke()},copy:function(e,t){var n=t||pn("canvas");return n.width=e.width,n.height=e.height,n.getContext("2d").drawImage(e,0,0),n},pixelRect:function(e,t,n,i){var s=e.globalAlpha,o=!1;if(e.lineWidth>0&&n>0)o=!0,n<1&&(e.globalAlpha*=n);else{if(!(i>0))return;i<1&&(e.globalAlpha*=i)}e.canvas._drawn=!0,o?e.strokeRect(t[0],t[1],1,1):e.fillRect(t[0],t[1],1,1),e.globalAlpha!==s&&(e.globalAlpha=s)}};function Ra(e,t,n,i){var s=t.x,o=t.y,a=n.x,l=n.y,h=i,c=function(e,t){return e<=t},u=function(e,t){return e>=t},f=function(e,t){return Math.min(e,t)},g=function(e,t){return Math.max(e,t)},m={thereYet:u,cap:f},A={thereYet:u,cap:f};o-l>0&&(A.thereYet=c,A.cap=g),s-a>0&&(m.thereYet=c,m.cap=g),e.moveTo(s,o);for(var w,T,S=s,M=o,C=0,I=!0;!m.thereYet(S,a)||!A.thereYet(M,l);)w=Math.atan2(l-o,a-s),T=h[C],S=m.cap(a,S+Math.cos(w)*T),M=A.cap(l,M+Math.sin(w)*T),I?e.lineTo(S,M):e.moveTo(S,M),C=(C+1)%h.length,I=!I}var La="data:image/";function Da(e){return e.substring(0,La.length)===La?e:nt(e)}function Fa(e,t){e.filter=t.filter,e.fillStyle=t.fillStyle,e.globalAlpha=t.globalAlpha,e.lineCap=t.lineCap,e.lineDashOffset=t.lineDashOffset,e.lineJoin=t.lineJoin,e.lineWidth=t.lineWidth,e.shadowBlur=t.shadowBlur,e.shadowColor=t.shadowColor,e.shadowOffsetX=t.shadowOffsetX,e.shadowOffsetY=t.shadowOffsetY,e.strokeStyle=t.strokeStyle,e.lineColorIn=t.lineColorIn,e.lineStrokeColor=t.lineStrokeColor,e.lineStrokeWidth=t.lineStrokeWidth}function Ha(e,t){t&&e.setLineDash&&Array.isArray(t)&&e.setLineDash(t)}function Na(e){return"Z__"+e}function Ba(e){return function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.on=function(e,t,n){if(!e)return this;if(!g(e))return this._switch("on",e,t);if(!t)return this;this._eventMap||(this._eventMap={});var i,s=e.toLowerCase().split(" ");n||(n=this);var a,l=c(t._id);t._id=He();for(var h=0,u=s.length;h<u;h++){var f=Na(i=s[h]);if(t[f]&&(t[f]._id=t._id),(a=this._eventMap[i])||(this._eventMap[i]=a=[]),l){var m=a.length;if(m>0)for(var A=0;A<m;A++)if(t===a[A].handler&&a[A].context===n)return o.isTest||console.warn(this,"find '"+e+"' handler:",t," The old listener function will be removed"),this;a.push({handler:t,context:n})}else a.push({handler:t,context:n})}return this},n.addEventListener=function(...e){return this.on.call(this,...e)},n.once=function(e,t,n){if(!g(e)){var i={};for(var s in e)e.hasOwnProperty(s)&&(i[s]=this._wrapOnceHandler(s,e[s],t));return this._switch("on",i)}for(var o=e.split(" "),a=0,l=o.length;a<l;a++)this.on(o[a],this._wrapOnceHandler(o[a],t,n));return this},n.off=function(e,t,n){if(!this._eventMap||!e)return this;if(!g(e))return this._switch("off",e,t);if(!t)return this;if(!c(t._id))return this;var i,s,o,a=e.split(" ");n||(n=this);for(var l=0,h=a.length;l<h;l++)if(o=Na(i=a[l].toLowerCase()),s=this._eventMap[i]){for(var u=s.length-1;u>=0;u--){var f=s[u];t!==f.handler&&t!==f.handler[o]||f.context!==n||(delete f.handler[o],s.splice(u,1))}s.length||delete this._eventMap[i]}return this},n.removeEventListener=function(...e){return this.off.call(this,...e)},n.listens=function(e,t,n){if(!this._eventMap||!g(e))return 0;var i=this._eventMap[e.toLowerCase()];if(!i||!i.length)return 0;if(!t)return i.length;for(var s=0,o=i.length;s<o;s++)if(t===i[s].handler&&(h(n)||i[s].context===n))return 1;return 0},n.getListeningEvents=function(){return this._eventMap?Object.keys(this._eventMap):[]},n.copyEventListeners=function(e){var t,n=e._eventMap;if(!n)return this;for(var i in n)for(var s=0,o=(t=n[i]).length;s<o;s++)this.on(i,t[s].handler,t[s].context);return this},n.fire=function(e,t){return this._eventParent?this._eventParent.fire.call(this._eventParent,e,t):this._fire.call(this,e,t)},n._wrapOnceHandler=function(e,t,n){var i=Na(e),s=!1,o=function e(...a){s||(delete o[i],s=!0,n?t.call(n,...a):t.call(this,...a),e._called=!0)};return o[i]=t,o},n._switch=function(e,t,n){for(var i in t)t.hasOwnProperty(i)&&this[e](i,t[i],n);return this},n._clearListeners=function(e){this._eventMap&&g(e)&&(this._eventMap[e.toLowerCase()]&&(this._eventMap[e]=null))},n._clearAllListeners=function(){this._eventMap=null},n._setEventParent=function(e){return this._eventParent=e,this},n._setEventTarget=function(e){return this._eventTarget=e,this},n._fire=function(e,t){if(!this._eventMap)return this;e=e.toLowerCase();var n=this._eventMap[e];if(!n)return this;t||(t={type:e,target:this._eventTarget||this}),t.type=e,t.target=this._eventTarget||this;for(var i,s,o=n.slice(0),a=0,h=o.length;a<h;a++){if(o[a])o[a].handler._called||(i=o[a].context,!0,s=l({},t),!1===(i?o[a].handler.call(i,s):o[a].handler(s))&&t.domEvent&&Cn(t.domEvent))}var c=this._eventMap[e];if(c){for(var u=[],f=0,g=c.length;f<g;f++){c[f].handler._called||u.push(c[f])}this._eventMap[e]=u}return this},t}(e)}var za=function(e){function t(t){var n;return(n=e.call(this)||this)._enabled=!1,n.target=t,n}Te(t,e);var n=t.prototype;return n.enable=function(){return this._enabled||(this._enabled=!0,this.addHooks()),this},n.disable=function(){return this._enabled?(this._enabled=!1,this.removeHooks(),this):this},n.enabled=function(){return!!this._enabled},n.remove=function(){this.disable(),delete this.target,delete this.dom},t}(Ba((function(){}))),Ua=function(){function e(e){if(!this||!this._setOptions)throw new Error('Class instance is being created without "new" operator.');this._setOptions(e),this.callInitHooks(),this._isUpdatingOptions=!1}var t=e.prototype;return t.proxyOptions=function(){var e=this;return ye.proxy?(this.options=new Proxy(this.options,{set:function(t,n,i){if(t[n]===i)return!0;if(t[n]=i,e._isUpdatingOptions)return!0;var s={};return s[n]=i,e.config(s),!0}}),this):this},t.callInitHooks=function(){var e=Object.getPrototypeOf(this);return this._visitInitHooks(e),this},t._setOptions=function(e){if(this.hasOwnProperty("options")&&!h(this.options)||(this.options=this.options?Object.create(this.options):{}),!e)return this;for(var t in e)this.options[t]=e[t];return this},t.setOptions=function(e){return console.warn("setOptions(options) It is a private method and deprecated, please use _setOptions(options) instead. If you want to update options, please use config(options) instead."),this._setOptions(e)},t.config=function(e,t){if(this._isUpdatingOptions=!0,!e){var n={};for(var i in this.options)this.options.hasOwnProperty(i)&&(n[i]=this.options[i]);return this._isUpdatingOptions=!1,n}if(2===arguments.length&&"string"==typeof e){var s={};s[e]=t,e=s}for(var o in e)this.options[o]=e[o],this[o]&&this[o]instanceof za&&(e[o]?this[o].enable():this[o].disable());return this.onConfig(e),this._isUpdatingOptions=!1,this},t.onConfig=function(e){},t._visitInitHooks=function(e){if(!this._initHooksCalled){var t=Object.getPrototypeOf(e);t._visitInitHooks&&t._visitInitHooks.call(this,t),this._initHooksCalled=!0;var n=e._initHooks;if(n&&n!==t._initHooks)for(var i=0;i<n.length;i++)n[i].call(this)}},e.addInitHook=function(e,...t){var n="function"==typeof e?e:function(){this[e].call(this,...t)},i=this.prototype,s=Object.getPrototypeOf(i);return i._initHooks&&i._initHooks!==s._initHooks||(i._initHooks=[]),i._initHooks.push(n),this},e.include=function(...e){for(var t=0;t<e.length;t++)l(this.prototype,e[t]);return this},e.mergeOptions=function(e){var t=this.prototype,n=Object.getPrototypeOf(t);return t.options&&t.options!==n.options||(t.options=t.options?Object.create(t.options):{}),l(t.options,e),this},e}(),ja=function(e){function t(){return e.apply(this,arguments)||this}return Te(t,e),t}(Ba((function(){}))),Wa=new ja,qa="dprchange",Za="docvisibilitychange",Xa="dragstart",Ya="dragend";if("undefined"!=typeof window&&window.matchMedia)for(var $a=1;$a<500;$a++){var Ka=(.01*$a).toFixed(2),el=window.matchMedia("screen and (resolution: "+Ka+"dppx)");el&&(el.addEventListener?el.addEventListener("change",ye.checkDevicePixelRatio):el.addListener&&el.addListener(ye.checkDevicePixelRatio))}if(ye.devicePixelRatio){var nl=ye.devicePixelRatio;Object.defineProperty(ye,"devicePixelRatio",{get:function(){return nl},set:function(e){e!==nl&&(nl=e,ye.monitorDPRChange&&Wa.fire(qa,{devicePixelRatio:e}))}})}ye.webgl&&"undefined"!=typeof document&&(vn(document,"visibilitychange",(function(){Wa.fire(Za,{visibilityState:document.visibilityState})})),vn(document,"dragstart",(function(){Wa.fire(Xa)})),vn(document,"dragend",(function(){Wa.fire(Ya)})));var il={};function ol(e){return function(e){function t(){return e.apply(this,arguments)||this}return Te(t,e),t.registerJSONType=function(e){e&&(il[e]?console.error(e+" has register. please use Different name for:",this):il[e]=this)},t.getJSONClass=function(e){return e?il[e]:null},t.prototype.getJSONType=function(){if(void 0===this._jsonType){var e=Object.getPrototypeOf(this).constructor;for(var t in il)if(il[t]===e){this._jsonType=t;break}}if(!this._jsonType)throw new Error("Found an unregistered Layer/Geometry class!");return this._jsonType},t}(e)}function al(e){return function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.addHandler=function(e,t){if(!t)return this;if(this._handlers||(this._handlers=[]),this[e])return this[e].enable(),this;var n=this[e]=new t(this);return this._handlers.push(n),this.options[e]&&n.enable(),this},n.removeHandler=function(e){if(!e)return this;var t=this[e];if(t){var n=this._handlers.indexOf(t);n>=0&&this._handlers.splice(n,1),this[e].remove(),delete this[e]}return this},n._clearHandlers=function(){for(var e=0,t=this._handlers.length;e<t;e++)this._handlers[e].remove();this._handlers=[]},t}(e)}var ll="touchstart mousedown",hl={mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"},cl={mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"},ul=function(e){function t(t,n={}){var i;return(i=e.call(this,null)||this).dom=t,i.options=n,i}Te(t,e);var n=t.prototype;return n.addHooks=function(){},n.removeHooks=function(){},n.enable=function(){return this.dom?(this._onMouseDown=function(e){return this.onMouseDown(e)},jn(this.dom,ll,this._onMouseDown,this),this):this},n.disable=function(){return this.dom?(this._offEvents(),Wn(this.dom,ll,this._onMouseDown),delete this._onMouseDown,this):this},n.onMouseDown=function(e){if(this.options.rightclick||2!==e.button){var t=e;if(!(t.touches&&t.touches.length>1||this.options.cancelOn&&!0===this.options.cancelOn(e))){var n=this.dom;n.setCapture?n.setCapture():window.captureEvents&&window.captureEvents(),n.ondragstart=function(){return!1},delete this.moved;var i=t.touches?t.touches[0]:e;this.startPos=new Re(i.clientX,i.clientY),Wn(document,hl[e.type],this.onMouseMove),Wn(document,cl[e.type],this.onMouseUp),jn(document,hl[e.type],this.onMouseMove,this),jn(document,cl[e.type],this.onMouseUp,this),this.options.ignoreMouseleave||(Wn(this.dom,"mouseleave",this.onMouseUp),jn(this.dom,"mouseleave",this.onMouseUp,this)),this.fire("mousedown",{domEvent:e,mousePos:new Re(i.clientX,i.clientY)})}}},n.onMouseMove=function(e){var t=e;if(t.touches&&t.touches.length>1)this.moved&&(this.interupted=!0,this.onMouseUp(e));else{var n=t.touches?t.touches[0]:e,i=new Re(n.clientX,n.clientY).sub(this.startPos);(i.x||i.y)&&(this.moved?this.fire("dragging",{domEvent:e,mousePos:new Re(n.clientX,n.clientY)}):(this.fire("dragstart",{domEvent:e,mousePos:this.startPos.copy()}),this.moved=!0))}},n.onMouseUp=function(e){var t=e.changedTouches?e.changedTouches[0]:e;this._offEvents();var n={domEvent:e};c(t.clientX)&&(n.mousePos=new Re(parseInt(t.clientX+"",0),parseInt(t.clientY+"",0))),this.moved&&(n.interupted=this.interupted,this.fire("dragend",n),delete this.interupted,delete this.moved),this.fire("mouseup",n)},n._offEvents=function(){var e=this.dom;if(Wn(e,"mouseleave",this.onMouseUp),"undefined"!=typeof document&&"undefined"!=typeof window){for(var t in hl)Wn(document,hl[t],this.onMouseMove),Wn(document,cl[t],this.onMouseUp);e.releaseCapture?e.releaseCapture():window.captureEvents&&window.captureEvents()}},t}(za),fl=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e),t.toNumberArrays=function(e){return Array.isArray(e)?Ve(e,(function(e){return e.toArray()})):e.toArray()},t.toCoordinates=function(e){if(c(e[0])&&c(e[1]))return new t(e);if(e instanceof t)return e;for(var n=[],i=0,s=e.length;i<s;i++){var o=e[i];Array.isArray(o)?c(o[0])?n.push(new t(o)):n.push(t.toCoordinates(o)):n.push(o instanceof t?o:new t(o))}return n};var n=t.prototype;return n.closeTo=function(e,t){return t||(t=0),this.x>=e.x-t&&this.x<=e.x+t&&this.y>=e.y-t&&this.y<=e.y+t},n.abs=function(){return new t(Math.abs(this.x),Math.abs(this.y))},n.round=function(){return new t(Math.round(this.x),Math.round(this.y))},n.ceil=function(){return new t(Math.ceil(this.x),Math.ceil(this.y))},n.floor=function(){return new t(Math.floor(this.x),Math.floor(this.y))},n.copy=function(){return new t(this.x,this.y,this.z)},n.toFixed=function(e){return new t(this.x.toFixed(e),this.y.toFixed(e),c(this.z)?this.z.toFixed(e):void 0)},n.add=function(e,n,i){var s,o,a=this.z;return h(e.x)?h(e[0])?(s=this.x+e,o=this.y+n,h(i)||(a=(this.z||0)+i)):(s=this.x+e[0],o=this.y+e[1],h(e[2])||(a=(this.z||0)+e[2])):(s=this.x+e.x,o=this.y+e.y,h(e.z)||(a=(this.z||0)+e.z)),new t(s,o,a)},n.sub=function(e,n,i){var s,o,a=this.z;return h(e.x)?h(e[0])?(s=this.x-e,o=this.y-n,h(i)||(a=(this.z||0)-i)):(s=this.x-e[0],o=this.y-e[1],h(e[2])||(a=(this.z||0)-e[2])):(s=this.x-e.x,o=this.y-e.y,h(e.z)||(a=(this.z||0)-e.z)),new t(s,o,a)},n.multi=function(e){return new t(this.x*e,this.y*e,h(this.z)?this.z:this.z*e)},n.equals=function(e){return e instanceof this.constructor&&(this.x===e.x&&this.y===e.y&&this.z===e.z)},t}(Ee),dl=function(){function e(e,t){this.type=e,this.properties=t}return e.createProj4=function(t){return new e("proj4",{proj:t})},e.fromProjectionCode=function(t){return t&&e[t=t.toUpperCase().replace(":","")]||null},e}();dl.WGS84=dl.createProj4("+proj=longlat +datum=WGS84 +no_defs"),dl.EPSG3857=dl.createProj4("+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"),dl.IDENTITY=dl.createProj4("+proj=identity +no_defs"),dl.CGCS2000=dl.createProj4("+proj=longlat +datum=CGCS2000"),dl.EPSG4490=dl.CGCS2000,dl.BD09LL=dl.createProj4("+proj=longlat +datum=BD09"),dl.GCJ02=dl.createProj4("+proj=longlat +datum=GCJ02");var pl,gl=new Re(0,0),ml=new fl(0,0),Al=new fl(0,0),yl=new fl(0,0),_l=new fl(0,0),vl=new fl(0,0),xl=new fl(0,0),bl=new fl(0,0),wl=new fl(0,0),Tl=[],Sl=[],Ml=function(){function e(...e){this._clazz=fl;var t=e.length,n=t>0?e[t-1]:null;n&&n.unproject&&(this.projection=e[t-1]),this._dirty=!0,this.antiMeridian=!1,this._initialize(e[0],e[1],e[2],e[3])}var t=e.prototype;return t._initialize=function(e,t,n,i){if(this.xmin=null,this.xmax=null,this.ymin=null,this.ymax=null,!h(e)){var s=this.projection;if(c(e)&&c(t)&&c(n)&&c(i))s?this.set(e,t,n,i):this.set(Math.min(e,n),Math.min(t,i),Math.max(e,n),Math.max(t,i));else if(Array.isArray(e))s?this.set(e[0],e[1],e[2],e[3]):this.set(Math.min(e[0],e[2]),Math.min(e[1],e[3]),Math.max(e[0],e[2]),Math.max(e[1],e[3]));else if(c(e.x)&&c(t.x)&&c(e.y)&&c(t.y)){var o=e,a=t;s?this.set(o.x,o.y,a.x,a.y):(o.x>a.x?(this.xmin=a.x,this.xmax=o.x):(this.xmin=o.x,this.xmax=a.x),o.y>a.y?(this.ymin=a.y,this.ymax=o.y):(this.ymin=o.y,this.ymax=a.y))}else c(e.xmin)&&c(e.xmax)&&c(e.ymin)&&c(e.ymax)&&this.set(e.xmin,e.ymin,e.xmax,e.ymax)}},t._add=function(e){return this._dirty=!0,h(e.x)?h(e.xmin)?h(e[0])||(this.xmin+=e[0],this.ymin+=e[1],this.xmax+=e[0],this.ymax+=e[1]):(this.xmin+=e.xmin,this.ymin+=e.ymin,this.xmax+=e.xmax,this.ymax+=e.ymax):(this.xmin+=e.x,this.ymin+=e.y,this.xmax+=e.x,this.ymax+=e.y),this},t.add=function(e){return new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection)._add(e)},t._scale=function(e){return this._dirty=!0,this.xmin*=e,this.ymin*=e,this.xmax*=e,this.ymax*=e,this},t._sub=function(e){return this._dirty=!0,h(e.x)?h(e.xmin)?h(e[0])||(this.xmin-=e[0],this.ymin-=e[1],this.xmax-=e[0],this.ymax-=e[1]):(this.xmin-=e.xmin,this.ymin-=e.ymin,this.xmax-=e.xmax,this.ymax-=e.ymax):(this.xmin-=e.x,this.ymin-=e.y,this.xmax-=e.x,this.ymax-=e.y),this},t._substract=function(e){return this._sub(e)},t.sub=function(e){return new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection)._sub(e)},t.substract=function(e){return this.sub(e)},t.round=function(){return new this.constructor(Math.round(this.xmin),Math.round(this.ymin),Math.round(this.xmax),Math.round(this.ymax),this.projection)},t._round=function(){return this._dirty=!0,this.xmin=Math.round(this.xmin),this.ymin=Math.round(this.ymin),this.xmax=Math.round(this.xmax),this.ymax=Math.round(this.ymax),this},t.getMin=function(e){return e?(e.set(this.xmin,this.ymin),e):new this._clazz(this.xmin,this.ymin)},t.getMax=function(e){return e?(e.set(this.xmax,this.ymax),e):new this._clazz(this.xmax,this.ymax)},t.getCenter=function(e){var t=(this.xmin+this.xmax)/2,n=(this.ymin+this.ymax)/2;return e?(e.set(t,n),e):new this._clazz(t,n)},t.isValid=function(){return!(h(this.xmin)||h(this.ymin)||h(this.xmax)||h(this.ymax))},t.equals=function(e){return this.xmin===e.xmin&&this.xmax===e.xmax&&this.ymin===e.ymin&&this.ymax===e.ymax},t.intersects=function(e){this._project(this),this._project(e);var t=Math.max(this.pxmin,e.pxmin),n=Math.max(this.pymin,e.pymin),i=Math.min(this.pxmax,e.pxmax),s=Math.min(this.pymax,e.pymax);return!(t>i||n>s)},t.within=function(e){return this._project(this),this._project(e),this.pxmin>=e.pxmin&&this.pxmax<=e.pxmax&&this.pymin>=e.pymin&&this.pymax<=e.pymax},t.contains=function(e){if(!e)return!1;this._project(this);var t=this.projection;if(t){var n=ml;Array.isArray(e)?(n.x=e[0],n.y=e[1],e=t.project(n,n)):void 0!==e.x?(n.x=e.x,n.y=e.y,e=t.project(n,n)):void 0!==e.xmin&&this._project(e)}return(e.x||e.pxmin||0)>=this.pxmin&&(e.x||e.pxmax||0)<=this.pxmax&&(e.y||e.pymin||0)>=this.pymin&&(e.y||e.pymax||0)<=this.pymax},t.getWidth=function(){return Math.abs(this.xmax-this.xmin)},t.getHeight=function(){return Math.abs(this.ymax-this.ymin)},t.getSize=function(){return new Ot(this.getWidth(),this.getHeight())},t.set=function(e,t,n,i){return this.xmin=e,this.ymin=t,this.xmax=n,this.ymax=i,this._dirty=!0,this},t.__combine=function(e){var t,n,i,s;void 0!==e.x&&(pl.xmin=pl.xmax=e.x,pl.ymin=pl.ymax=e.y,pl._dirty=!0,e=pl),this._project(e),this._project(this),c(this.pxmin)?(t=Math.min(this.pxmin,e.pxmin),n=Math.min(this.pymin,e.pymin),i=Math.max(this.pxmax,e.pxmax),s=Math.max(this.pymax,e.pymax)):(t=e.pxmin,n=e.pymin,i=e.pxmax,s=e.pymax);var o=this.projection;if(o){Al.set(t,n),yl.set(i,s);var a=o.unproject(Al,Al),l=o.unproject(yl,yl);t=a.x,n=a.y,i=l.x,s=l.y}return Sl[0]=t,Sl[1]=n,Sl[2]=i,Sl[3]=s,Sl},t._combine=function(e){if(!e||e.isValid&&!e.isValid())return this;var t=this.__combine(e);return this.set(t[0],t[1],t[2],t[3]),this._dirty=!0,this},t.combine=function(e){if(!e||e.isValid&&!e.isValid())return this;var t=this.__combine(e);return new this.constructor(t[0],t[1],t[2],t[3],this.projection)},t.intersection=function(e){if(!this.intersects(e))return null;_l.x=Math.max(this.pxmin,e.pxmin),_l.y=Math.max(this.pymin,e.pymin),vl.x=Math.min(this.pxmax,e.pxmax),vl.y=Math.min(this.pymax,e.pymax);var t=_l,n=vl,i=this.projection;return i&&(t=i.unproject(t,t),n=i.unproject(n,n)),new this.constructor(t,n,i)},t.expand=function(e){var t,n;return c(e)?t=n=e:(t=e.width||e.x||e[0]||0,n=e.height||e.y||e[1]||0),new this.constructor(this.xmin-t,this.ymin-n,this.xmax+t,this.ymax+n,this.projection)},t._expand=function(e){var t,n;return c(e)?t=n=e:(t=e.width||e.x||e[0]||0,n=e.height||e.y||e[1]||0),this.xmin-=t,this.ymin-=n,this.xmax+=t,this.ymax+=n,this._dirty=!0,this},t.toJSON=function(){return{xmin:this.xmin,ymin:this.ymin,xmax:this.xmax,ymax:this.ymax}},t.toArray=function(e){var t=this.xmin,n=this.ymin,i=this.xmax,s=this.ymax;return e?(e[0].x=t,e[0].y=s,e[1].x=i,e[1].y=s,e[2].x=i,e[2].y=n,e[3].x=t,e[3].y=n,e[4].x=t,e[4].y=s,e):[new this._clazz([t,s]),new this._clazz([i,s]),new this._clazz([i,n]),new this._clazz([t,n]),new this._clazz([t,s])]},t.toString=function(){return this.xmin+","+this.ymin+","+this.xmax+","+this.ymax},t.copy=function(){return new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection)},t.convertTo=function(e,t){if(!this.isValid())return null;var n,i=t||new this.constructor;return t&&i.set(null,null,null,null),this._clazz===fl?n=xl:this._clazz===Re&&(n=gl),n.x=this.xmin,n.y=this.ymax,i._combine(e(n)),n.x=this.xmax,i._combine(e(n)),n.y=this.ymin,i._combine(e(n)),n.x=this.xmin,i._combine(e(n)),i},t._project=function(e){if(e&&e.isValid()){var t=this.projection;if(t){if(e._dirty){bl.set(e.xmin,e.ymin),wl.set(e.xmax,e.ymax),Tl[0]=bl,Tl[1]=wl;var n=t.projectCoords(Tl,this.antiMeridian),i=n[0],s=n[1];e.pxmin=Math.min(i.x,s.x),e.pymin=Math.min(i.y,s.y),e.pxmax=Math.max(i.x,s.x),e.pymax=Math.max(i.y,s.y)}delete e._dirty}else e.pxmin=e.xmin,e.pxmax=e.xmax,e.pymin=e.ymin,e.pymax=e.ymax}else e&&(e.pxmin=e.pxmax=e.pymin=e.pymax=null)},e}();pl=new Ml(0,0,0,0);var Cl,Pl=function(e){function t(...t){var n;return(n=e.call(this,...t)||this)._clazz=Re,n}return Te(t,e),t}(Ml),kl=function(){function e(e){this.matrix=e}var t=e.prototype;return t.transform=function(e,t,n){var i=this.matrix[0]*(e.x-this.matrix[2])/t,s=-this.matrix[1]*(e.y-this.matrix[3])/t;return n?(n.x=i,n.y=s,n):new Re(i,s)},t.untransform=function(e,t,n){var i=e.x*t/this.matrix[0]+this.matrix[2],s=e.y*t/-this.matrix[1]+this.matrix[3];return n?(n.x=i,n.y=s,n):new fl(i,s)},e}(),Ol={code:"",is:function(e){if(this.code===e)return!0;if(!this.aliases)return!1;for(var t=0;t<this.aliases.length;t++)if(this.aliases[t]===e)return!0;return!1},project:function(e){return e},unproject:function(e){return e},projectCoords:function(e,t){var n=this;if(!e)return[];if(!Array.isArray(e))return this.project(e);if(0===e.length)return[];if(!this.isSphere())return Ve(e,this.project,this);if(Array.isArray(e[0]))return e.map((function(e){return n.projectCoords(e,t)}));for(var i,s,o,a,l,h=t,c=this.getCircum(),u=this.getSphereExtent().sy,f=e[0],g=[this.project(f)],m=1,A=e.length;m<A;m++){o=(s=e[m]).x-f.x,a=s.y-f.y,l=this.project(s);var w=!1;Math.abs(o)>180&&h&&(s.x=o<0?360-Math.abs(s.x):-180-(180-Math.abs(s.x)),w=!0),Math.abs(a)>90&&h&&(void 0===i&&(i=s.y<f.y),i&&(l._add(0,-c.y*We(a)*u),s._add(0,-180*We(a)))),w&&(l=this.project(s)),f=s,g.push(l)}return g},unprojectCoords:function(e){return e?Array.isArray(e)?Ve(e,this.unproject,this):this.unproject(e):[]},isSphere:function(){return!!this.sphere},isOutSphere:function(e){return!!this.isSphere()&&!this.getSphereExtent().contains(e)},wrapCoord:function(e){if(!this.isSphere())return e;var t=this.getSphereExtent(),n=new fl(e);return t.contains(n)||(n.x=Ze(e.x,t.xmin,t.xmax),n.y=Ze(e.y,t.ymin,t.ymax)),n},getCircum:function(){if(!this.circum&&this.isSphere()){var e=this.getSphereExtent();this.circum={x:e.getWidth(),y:e.getHeight()}}return this.circum},getSphereExtent:function(){if(!this.extent&&this.isSphere()){var e=this.project(new fl(180,90)),t=this.project(new fl(-180,-90));this.extent=new Ml(t,e,this),this.extent.sx=e.x>t.x?1:-1,this.extent.sy=e.y>t.y?1:-1}return this.extent}},El={measureLength:function(e,t){if(!Array.isArray(e))return this.measureLenBetween(e,t);for(var n=0,i=0,s=e.length;i<s-1;i++)n+=this.measureLenBetween(e[i],e[i+1]);return n}},Rl={measure:"IDENTITY",measureLenBetween:function(e,t,n=!1){if(!e||!t)return 0;try{var i=Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2));if(n)return i;var s=(e.z||0)-(t.z||0);return 0===s?i:Math.sqrt(i*i+s*s)}catch(e){return 0}},measureArea:function(e){if(!Array.isArray(e))return 0;for(var t=0,n=0,i=e.length;n<i;n++){var s=e[n],o=null;t+=s.x*(o=n===i-1?e[0]:e[n+1]).y-s.y*o.x}return Math.abs(t/2)},locate:function(e,t,n,i){return(i=i||new fl(0,0)).set(e.x,e.y),this._locate(i,t,n)},_locate:function(e,t,n){return e?(t||(t=0),n||(n=0),t||n?(e.x=e.x+t,e.y=e.y+n,e):e):null},rotate:function(e,t,n){return e=new fl(e.x,e.y),this._rotate(e,t,n)},_rotate:(Cl=new Re(0,0),function(e,t,n){return Cl.x=e.x-t.x,Cl.y=e.y-t.y,Cl._rotate(n*Math.PI/180),e.x=t.x+Cl.x,e.y=t.y+Cl.y,e})},Ll=l(Rl,El),Dl=function(){function e(e){this.radius=e}var t=e.prototype;return t.measureLenBetween=function(e,t,n=!1){if(!e||!t)return 0;var i=S(e.y),s=S(t.y),o=i-s,a=S(e.x)-S(t.x);i=2*Math.asin(Math.sqrt(Math.pow(Math.sin(o/2),2)+Math.cos(i)*Math.cos(s)*Math.pow(Math.sin(a/2),2)));i*=this.radius;if(n)return i;var l=(e.z||0)-(t.z||0);return 0===l?i:Math.sqrt(i*i+l*l)},t.measureArea=function(e){var t,n=S(this.radius),i=0,s=e,o=s.length;if(o<3)return 0;for(t=0;t<o-1;t++){var a=s[t],l=s[t+1];i+=a.x*n*Math.cos(S(a.y))*l.y*n-l.x*n*Math.cos(S(l.y))*a.y*n}var h=s[t],c=s[0];return i+=h.x*n*Math.cos(S(h.y))*c.y*n-c.x*n*Math.cos(S(c.y))*h.y*n,.5*Math.abs(i)},t.locate=function(e,t,n,i){return(i=i||new fl(0,0)).set(e.x,e.y),this._locate(i,t,n)},t._locate=function(e,t,n){if(!e)return null;if(t||(t=0),n||(n=0),!t&&!n)return e;var i,s,o=S(e.y);if(0!==n){var a=Math.abs(n);s=Ze(180*(o+=2*Math.sin(a/(2*this.radius))*(n>0?1:-1))/Math.PI,-90,90)}else s=e.y;if(0!==t){var l=Math.abs(t),h=S(e.x);i=Ze(180*(h+=2*Math.sqrt(Math.pow(Math.sin(l/(2*this.radius)),2)/Math.pow(Math.cos(o),2))*(t>0?1:-1))/Math.PI,-180,180)}else i=e.x;return e.x=i,e.y=s,e},t.rotate=function(e,t,n){var i=new fl(e);return this._rotate(i,t,n)},t._rotate=function(e,t,n){var i=function(e,t,n={}){var i;i=n.final?Fl(t,e):Fl(e,t);return i>180?-(360-i):i}(t,e),s=i-n,o=this.measureLenBetween(t,e,!0);return e.x=t.x,e.y=t.y,function(e,t,n,i){var s=t/i,o=e.x*Math.PI/180,a=S(e.y),l=S(n),h=s*Math.cos(l),c=a+h;Math.abs(c)>Math.PI/2&&(c=c>0?Math.PI-c:-Math.PI-c);var u=Math.log(Math.tan(c/2+Math.PI/4)/Math.tan(a/2+Math.PI/4)),f=Math.abs(u)>1e-11?h/u:Math.cos(a),g=s*Math.sin(l)/f;return e.x=(180*(o+g)/Math.PI+540)%360-180,e.y=180*c/Math.PI,e}(e,o,s,this.radius)},e}();function Fl(e,t){var n=S(e.y),i=S(t.y),s=S(t.x-e.x);s>Math.PI&&(s-=2*Math.PI),s<-Math.PI&&(s+=2*Math.PI);var o=Math.log(Math.tan(i/2+Math.PI/4)/Math.tan(n/2+Math.PI/4));return(M(Math.atan2(s,o))+360)%360}var Hl={measure:"EPSG:4326",sphere:new Dl(6378137),measureLenBetween:function(e,t){return this.sphere.measureLenBetween(e,t)},measureArea:function(e){return this.sphere.measureArea.call(this.sphere,e)},_locate:function(e,t,n){return this.sphere._locate.call(this.sphere,e,t,n)},locate:function(e,t,n,i){return this.sphere.locate.call(this.sphere,e,t,n,i)},_rotate:function(e,t,n){return this.sphere._rotate.call(this.sphere,e,t,n)},rotate:function(e,t,n){return this.sphere.rotate.call(this.sphere,e,t,n)}},Nl=l(Hl,El),Bl={measure:"BAIDU",sphere:new Dl(6370996.81),measureLenBetween:function(e,t){return this.sphere.measureLenBetween.call(this.sphere,e,t)},measureArea:function(e){return this.sphere.measureArea.call(this.sphere,e)},_locate:function(e,t,n){return this.sphere._locate.call(this.sphere,e,t,n)},locate:function(e,t,n,i){return this.sphere.locate.call(this.sphere,e,t,n,i)},_rotate:function(e,t,n){return this.sphere._rotate.call(this.sphere,e,t,n)},rotate:function(e,t,n){return this.sphere.rotate.call(this.sphere,e,t,n)}},zl=l(Bl,El),Gl=Nl,Ul={};function Vl(e){Ul[e.measure]=e}Vl(Ll),Vl(Nl),Vl(zl);var jl={getInstance:function(e){if(!e)return Gl;for(var t in Ul)if(w(Ul,t)){var n=Ul[t].measure;if(!n)continue;if(e.toLowerCase()===n.toLowerCase())return Ul[t]}return null}},Wl=Object.freeze({__proto__:null,BaiduSphere:zl,DEFAULT:Gl,Identity:Ll,Measurer:jl,WGS84Sphere:Nl}),ql={code:"EPSG:3857",rad:Math.PI/180,metersPerDegree:6378137*Math.PI/180,maxLatitude:85.0511287798,project:function(e,t){var n=this.rad,i=this.metersPerDegree,s=this.maxLatitude,o=e.x,a=Math.max(Math.min(s,e.y),-s),l=o*i,h=(0===a?0:Math.log(Math.tan((90+a)*n/2))/n)*i,c=e.z;return t?(t.x=l,t.y=h,t.z=c,t):new fl(l,h,c)},unproject:function(e,t){var n,i=this.rad,s=this.metersPerDegree,o=e.x/s,a=e.y;0===a?n=0:(n=a/s,n=(2*Math.atan(Math.exp(n*i))-Math.PI/2)/i),Math.abs(Math.abs(o)-180)<1e-7&&(o=180*We(o)),Math.abs(Math.abs(n)-this.maxLatitude)<1e-7&&(n=We(n)*this.maxLatitude);var l=o,h=n,c=e.z;return t?(t.x=l,t.y=h,t.z=c,t):new fl(l,h,c)}},Zl=l({},Ol,ql,Nl),Xl={code:"EPSG:4326",aliases:["EPSG:4490"],project:function(e,t){return t?(t.x=e.x,t.y=e.y,t.z=e.z,t):new fl(e)},unproject:function(e,t){return t?(t.x=e.x,t.y=e.y,t.z=e.z,t):new fl(e)}},Yl=l({},Ol,Xl,Nl),Jl=Math.abs,Ql=Math.sin,$l=Math.cos,Kl=Math.tan,eh=Math.atan,th=Math.atan2,nh=Math.sqrt,rh=Math.log,ih=Math.hypot,sh=Math.sinh,oh=Math.cosh,ah=1/0;function hh(e){var t,n,i,s,o,a,l=[],h=[],c=[],u=[];function f(e,t){for(var n,i=2*$l(2*t),s=e.length-1,o=e[s],a=0;--s>=0;)n=i*o-a+e[s],a=o,o=n;return t+n*Ql(2*t)}function g(e,t,n){for(var i,s,o=Ql(t),a=$l(t),l=sh(n),h=oh(n),c=2*a*h,u=-2*o*l,f=e.length-1,g=e[f],m=0,A=0,w=0;--f>=0;)i=A,s=m,g=c*(A=g)-i-u*(m=w)+e[f],w=u*A-s+c*m;return[(c=o*h)*g-(u=a*l)*w,c*w+u*g]}o=s=(i=e.es/(1+nh(1-e.es)))/(2-i),l[0]=s*(2+s*(-2/3+s*(s*(116/45+s*(26/45+s*(-2854/675)))-2))),h[0]=s*(s*(2/3+s*(4/3+s*(-82/45+s*(32/45+s*(4642/4725)))))-2),l[1]=(o*=s)*(7/3+s*(s*(-227/45+s*(2704/315+s*(2323/945)))-1.6)),h[1]=o*(5/3+s*(-16/15+s*(-13/9+s*(904/315+s*(-1522/945))))),l[2]=(o*=s)*(56/15+s*(-136/35+s*(-1262/105+s*(73814/2835)))),h[2]=o*(-26/15+s*(34/21+s*(1.6+s*(-12686/2835)))),l[3]=(o*=s)*(4279/630+s*(-332/35+s*(-399572/14175))),h[3]=o*(1237/630+s*(s*(-24832/14175)-2.4)),l[4]=(o*=s)*(4174/315+s*(-144838/6237)),h[4]=o*(-734/315+s*(109598/31185)),l[5]=(o*=s)*(601676/22275),h[5]=o*(444337/155925),t=e.k0/(1+s)*(1+(o=s*s)*(1/4+o*(1/64+o/256))),c[0]=s*(s*(2/3+s*(-37/96+s*(1/360+s*(81/512+s*(-96199/604800)))))-.5),u[0]=s*(.5+s*(-2/3+s*(5/16+s*(41/180+s*(-127/288+s*(7891/37800)))))),c[1]=o*(-1/48+s*(-1/15+s*(437/1440+s*(-46/105+s*(1118711/3870720))))),u[1]=o*(13/48+s*(s*(557/1440+s*(281/630+s*(-1983433/1935360)))-.6)),c[2]=(o*=s)*(-17/480+s*(37/840+s*(209/4480+s*(-5569/90720)))),u[2]=o*(61/240+s*(-103/140+s*(15061/26880+s*(167603/181440)))),c[3]=(o*=s)*(-4397/161280+s*(11/504+s*(830251/7257600))),u[3]=o*(49561/161280+s*(-179/168+s*(6601661/7257600))),c[4]=(o*=s)*(-4583/161280+s*(108847/3991680)),u[4]=o*(34729/80640+s*(-3418889/1995840)),c[5]=(o*=s)*(-20648693/638668800),u[5]=.6650675310896665*o,a=f(h,e.phi0),n=-t*(a+function(e,t){var n,i=2*$l(t),s=e.length-1,o=e[s],a=0;for(;--s>=0;)n=i*o-a+e[s],a=o,o=n;return Ql(t)*n}(u,2*a)),e.fwd=function(e,i){var s,o,a,l,c,m=e.phi,A=e.lam;m=f(h,m),s=Ql(m),o=$l(m),l=Ql(A),a=$l(A),m=th(s,a*o),A=th(l*o,ih(s,o*a)),A=function(e){var t=Jl(e);return t=function(e){var t=1+e,n=t-1;return 0===n?e:e*rh(t)/n}(t*(1+t/(ih(1,t)+1))),e<0?-t:t}(Kl(A)),c=g(u,2*m,2*A),m+=c[0],A+=c[1],Jl(A)<=2.623395162778?(i.y=t*m+n,i.x=t*A):i.x=i.y=ah},e.inv=function(e,i){var s,o,a,h,u,m=e.y,A=e.x;m=(m-n)/t,A/=t,Jl(A)<=2.623395162778?(m+=(u=g(c,2*m,2*A))[0],A=eh(sh(A+=u[1])),s=Ql(m),o=$l(m),h=Ql(A),a=$l(A),A=th(h,a*o),m=th(s*a,ih(h,a*o)),i.phi=f(l,m),i.lam=A):i.phi=i.lam=ah}}var ch=57.29577951308232,uh=.017453292519943295,fh=["Traverse_Mercator"],dh={code:"EPSG:9807",aliases:fh,centralMeridian:0,create:function(e){var t={a:6378137,es:.0066943799901413165,x0:h(e.falseEasting)?5e5:e.falseEasting,y0:h(e.falseNorthing)?0:e.falseNorthing,k0:e.scaleFactor||.9996,lam0:(e.centralMeridian||0)*uh,phi0:(e.latitudeOfOrigin||0)*uh,originLam0:e.startLongtitude||0,originPhi0:e.startLatitude||0};hh(t);var n={lam:0,phi:0},i={},s=0,o=0;(t.originLam0||t.originPhi0)&&(n.lam=t.originLam0*uh-t.lam0,n.phi=t.originPhi0*uh,t.fwd(n,i),s=t.a*i.x+t.x0,o=t.a*i.y+t.y0);var a={code:"EPSG:9807",aliases:fh,centralMeridian:e.centralMeridian,project:function(e,a){n.lam=e.x*uh-t.lam0,n.phi=e.y*uh,t.fwd(n,i);var l=t.a*i.x+t.x0-s,h=t.a*i.y+t.y0-o,c=e.z;return a?(a.x=l,a.y=h,a.z=c,a):new fl(l,h,c)},unproject:function(e,a){i.x=(e.x-t.x0+s)/t.a,i.y=(e.y-t.y0+o)/t.a,t.inv(i,n);var l=(n.lam+t.lam0)*ch,h=n.phi*ch,c=e.z;return a?(a.x=l,a.y=h,a.z=c,a):new fl(l,h,c)}};return l({},Ol,a,Nl)}},gh=l({},Ol,dh),mh={code:"utm",aliases:[],create:function(e){var t={},n=parseInt(e.zone);if(t.falseNorthing=e.south?1e7:0,t.falseEasting=5e5,!(n>0&&n<=60))throw new Error("zone must be > 0 and <= 60.");return n--,t.centralMeridian=6*(n+.5)-180,t.scaleFactor=.9996,gh.create(t)}},Ah=l({},gh,mh),yh={EARTHRADIUS:6370996.81,MCBAND:[12890594.86,8362377.87,5591021,3481989.83,1678043.12,0],LLBAND:[75,60,45,30,15,0],MC2LL:[[1.410526172116255e-8,898305509648872e-20,-1.9939833816331,200.9824383106796,-187.2403703815547,91.6087516669843,-23.38765649603339,2.57121317296198,-.03801003308653,17337981.2],[-7.435856389565537e-9,8983055097726239e-21,-.78625201886289,96.32687599759846,-1.85204757529826,-59.36935905485877,47.40033549296737,-16.50741931063887,2.28786674699375,10260144.86],[-3.030883460898826e-8,898305509983578e-20,.30071316287616,59.74293618442277,7.357984074871,-25.38371002664745,13.45380521110908,-3.29883767235584,.32710905363475,6856817.37],[-1.981981304930552e-8,8983055099779535e-21,.03278182852591,40.31678527705744,.65659298677277,-4.44255534477492,.85341911805263,.12923347998204,-.04625736007561,4482777.06],[3.09191371068437e-9,8983055096812155e-21,6995724062e-14,23.10934304144901,-.00023663490511,-.6321817810242,-.00663494467273,.03430082397953,-.00466043876332,2555164.4],[2.890871144776878e-9,8983055095805407e-21,-3.068298e-8,7.47137025468032,-353937994e-14,-.02145144861037,-1234426596e-14,.00010322952773,-323890364e-14,826088.5]],LL2MC:[[-.0015702102444,111320.7020616939,0x60e374c3105a3,-0x24bb4115e2e164,0x5cc55543bb0ae8,-0x7ce070193f3784,0x5e7ca61ddf8150,-0x261a578d8b24d0,0x665d60f3742ca,82.5],[.0008277824516172526,111320.7020463578,647795574.6671607,-4082003173.641316,10774905663.51142,-15171875531.51559,12053065338.62167,-5124939663.577472,913311935.9512032,67.5],[.00337398766765,111320.7020202162,4481351.045890365,-23393751.19931662,79682215.47186455,-115964993.2797253,97236711.15602145,-43661946.33752821,8477230.501135234,52.5],[.00220636496208,111320.7020209128,51751.86112841131,3796837.749470245,992013.7397791013,-1221952.21711287,1340652.697009075,-620943.6990984312,144416.9293806241,37.5],[-.0003441963504368392,111320.7020576856,278.2353980772752,2485758.690035394,6070.750963243378,54821.18345352118,9540.606633304236,-2710.55326746645,1405.483844121726,22.5],[-.0003218135878613132,111320.7020701615,.00369383431289,823725.6402795718,.46104986909093,2351.343141331292,1.58060784298199,8.77738589078284,.37238884252424,7.45]],convertMC2LL:function(e,t){for(var n,i=0,s=this.MCBAND.length;i<s;i++)if(Math.abs(e.y)>=this.MCBAND[i]){n=this.MC2LL[i];break}return this.convertor(e,n,t)},convertLL2MC:function(e,t){var n,i,s;e.x=this.getLoop(e.x,-180,180),e.y=this.getRange(e.y,-74,74);var o=new fl(e.x,e.y);for(i=0,s=this.LLBAND.length;i<s;i++)if(o.y>=this.LLBAND[i]){n=this.LL2MC[i];break}if(!n)for(i=this.LLBAND.length-1;i>=0;i--)if(o.y<=-this.LLBAND[i]){n=this.LL2MC[i];break}return this.convertor(e,n,t)},convertor:function(e,t,n){if(!e||!t)return null;var i=t[0]+t[1]*Math.abs(e.x),s=Math.abs(e.y)/t[9],o=t[2]+t[3]*s+t[4]*s*s+t[5]*s*s*s+t[6]*s*s*s*s+t[7]*s*s*s*s*s+t[8]*s*s*s*s*s*s;i*=e.x<0?-1:1,o*=e.y<0?-1:1;var a=e.z;return n?(n.x=i,n.y=o,n.z=a,n):new fl(i,o,a)},toRadians:function(e){return Math.PI*e/180},toDegrees:function(e){return 180*e/Math.PI},getRange:function(e,t,n){return null!=t&&(e=Math.max(e,t)),null!=n&&(e=Math.min(e,n)),e},getLoop:function(e,t,n){if(e===1/0)return n;if(e===-1/0)return t;for(;e>n;)e-=n-t;for(;e<t;)e+=n-t;return e}},_h=l({},Ol,{code:"BAIDU",project:function(e,t){return this.convertLL2MC(e,t)},unproject:function(e,t){return this.convertMC2LL(e,t)}},zl,yh),vh=l({},Ol,{code:"IDENTITY",project:function(e,t){return t?(t.x=e.x,t.y=e.y,t.z=e.z,t):e.copy()},unproject:function(e,t){return t?(t.x=e.x,t.y=e.y,t.z=e.z,t):e.copy()}},Ll),xh=Zl,bh=Object.freeze({__proto__:null,BAIDU:_h,Common:Ol,DEFAULT:xh,EPSG3857:Zl,EPSG4326:Yl,EPSG9807:gh,IDENTITY:vh,UTM:Ah});function wh(e){return function(e){function t(){return e.apply(this,arguments)||this}return Te(t,e),t.registerRenderer=function(e,t){var n=this.prototype,i=Object.getPrototypeOf(n);return n._rendererClasses&&n._rendererClasses!==i._rendererClasses||(n._rendererClasses=n._rendererClasses?Object.create(n._rendererClasses):{}),n._rendererClasses[e.toLowerCase()]=t,this},t.getRendererClass=function(e){var t=this.prototype;return t._rendererClasses?t._rendererClasses[e.toLowerCase()]:null},t}(e)}var Th={markerWidth:10,markerHeight:10,markerLineWidth:1},Sh=new Re(0,0);function Mh(e,t,n,i,s,o){var a=s.x+o.x,l=s.y+o.y;Sh.x=a,Sh.y=l;var h=function(e){if(!e)return 0;var{x:t,y:n}=e;if(0===t&&0===n)return 0;if(0===t||!t){if(n<0)return-Math.PI/2;if(n>0)return Math.PI/2}var i=n/t;return n<0&&t<0?Math.atan(i)-Math.PI:n>0&&t<0?Math.atan(i)+Math.PI:Math.atan(i)}(Sh),c=Math.sqrt(a*a+l*l),u=0,f=0;u+=Math.cos(t+h)*c,f+=Math.sin(t+h)*c;var[g,m,A,w]=function(e,t,n){var i=Math.PI/2+n,s=Math.PI/4+n,o=n,a=t,l=Math.sqrt(e*e+t*t),h=e,c=Math.cos(i)*a,u=Math.sin(i)*a,f=Math.cos(s)*l,g=Math.sin(s)*l,m=Math.cos(o)*h,A=Math.sin(o)*h,w=Math.min(c,f,m,0),T=Math.min(u,g,A,0);return[w,T,Math.max(c,f,m,0)-w,Math.max(u,g,A,0)-T]}(n,i,t);f+=m;var T=(u+=g)+Math.max(n,A),S=f+Math.max(i,w);return e.set(u,f,T,S),e}var Ch=new Re(0,0);function Ph(e,t,n,i,s,o,a){var l=Ch.set(t,n);if(i)return Mh(e,i,o,a,l,s);var h=e.set(l.x,l.y,l.x+o,l.y+a);return h._add(s),i&&function(e,t){var{xmin:n,ymin:i,xmax:s,ymax:o}=e;Fh.set(n,i,s,o),Fh.convertTo((function(e){return e._rotate(t)}),e)}(h,i),h}var Ih=[];function kh(e,t,n){if((n=n||Dh(Ih,t))&&(0===n[0]||0===n[1]))return Yh(e),e;var i=Lh(t,n[0],n[1]);return Ph(e,t.markerDx||0,t.markerDy||0,Hh(t),i,n[0],n[1])}function Oh(e){return"rectangle"===e||"roundrectangle"===e?"right":"middle"}function Eh(e){return"bar"===e||"pie"===e||"pin"===e?"top":"rectangle"===e||"roundrectangle"===e?"bottom":"middle"}var Rh=new Ot(0,0);function Lh(e,t,n){var i=2*(e.shadowBlur||0)+.5;Rh.width=t,Rh.height=n;var s=e.markerType,o=Yt(Rh,e.markerHorizontalAlignment||Oh(s),e.markerVerticalAlignment||Eh(s));return o.x!==-t/2&&(o.x-=We(o.x+t/2)*i),o.y!==-n/2&&(o.y-=We(o.y+n/2)*i),o}function Dh(e,t){var n=je(t.markerWidth,Th.markerWidth),i=je(t.markerHeight,Th.markerHeight);if(0===n||0===i)return e[0]=0,e[1]=0,e;var s=je(t.markerLineWidth,Th.markerLineWidth),o=2*((t.shadowBlur||0)+Math.max(Math.abs(t.shadowOffsetX||0)+Math.abs(t.shadowOffsetY||0))),a=Math.round(n+s+o+1),l=Math.round(i+s+o+1);return e[0]=a,e[1]=l,e}var Fh=new Pl;function Hh(e,t="markerRotation"){var n=e[t];return c(n)?-n*Math.PI/180:0}function Nh(e,t,n){var i=n?n.getImage(t.markerFile):null,s=t.markerWidth||(i?i.width:0),o=t.markerHeight||(i?i.height:0);if(Rh.width=s,Rh.height=o,0===t.markerWidth||0===t.markerHeight)return Yh(e),e;var a=Yt(Rh,t.markerHorizontalAlignment||"middle",t.markerVerticalAlignment||"top");return Ph(e,t.markerDx||0,t.markerDy||0,Hh(t),a,s,o)}function Bh(e,t,n){var i=n.size;if(i&&(0===i.width||0===i.height))return Yh(e),e;var s=Yt(i,t.textHorizontalAlignment,t.textVerticalAlignment),o=t.textHaloRadius||0,a=Ph(e,t.textDx||0,t.textDy||0,Hh(t,"textRotation"),s,i.width,i.height);return a.xmin-=o,a.xmax+=o,a.ymin-=o,a.ymax+=o,a}var zh=new Pl;function Gh(e,t,n,i){var s=e||new Pl;if(Array.isArray(t)){for(var o=t,a=0;a<o.length;a++)Gh(s,o[a],n,i[a]);return s}return Uh(t)&&s._combine(Bh(zh,t,i)),Vh(t)&&s._combine(Nh(zh,t,n)),jh(t)&&s._combine(kh(zh,t)),Wh(t)&&s._combine(Nh(zh,t)),s}function Uh(e){return!!e&&!h(e.textName)}function Vh(e){return!!e&&!h(e.markerFile)}function jh(e){return!!e&&!(!h(e.markerFile)||h(e.markerType)||"path"===e.markerType)}function Wh(e){return!!e&&!(!h(e.markerFile)||"path"!==e.markerType)}var qh,Zh=["markerWidth","markerHeight","markerHorizontalAlignment","markerVerticalAlignment","markerDx","markerDy","markerRotation","textName","textSize","textDx","textDy","textVerticalAlignment","textHorizontalAlignment","textRotation","textWrapWidth"],Xh=["textName","markerType","markerFile","textHaloRadius","shadowBlur","shadowOffsetX","shadowOffsetY","textWrapWidth"];function Yh(e){e&&(e.xmin=1/0,e.ymin=1/0,e.xmax=-1/0,e.ymax=-1/0)}function Jh(e,t,n,i){for(var s,o=[],a=0,l=0,h=e.length;l<h-1;l++)(s=Qh(e[l],e[l+1],t,l,n,i))&&(o[a]=o[a]||[],o[a].push({point:s[0],index:l}),s[1]===e[l+1]&&l!==h-2||(o[a].push({point:s[1],index:l+1}),a++));return o}function Qh(e,t,n,i,s,o){var a,l,h,c=i?qh:ec(e,n),u=ec(t,n);for(qh=u;;){if(!(c|u))return[e,t];if(c&u)return!1;if(o)return[e,t];h=ec(l=Kh(e,t,a=c||u,n,s),n),a===c?(e=l,c=h):(t=l,u=h)}}function $h(e,t,n){var i,s,o,a,l,h,c,u,f,g=[1,4,2,8];for(s=0,c=e.length;s<c;s++)e[s]._code=ec(e[s],t);for(a=0;a<4;a++){for(u=g[a],i=[],s=0,o=(c=e.length)-1;s<c;o=s++)h=e[o],(l=e[s])._code&u?h._code&u||((f=Kh(h,l,u,t,n))._code=ec(f,t),i.push(f)):(h._code&u&&((f=Kh(h,l,u,t,n))._code=ec(f,t),i.push(f)),i.push(l));e=i}return e}function Kh(e,t,n,i,s){var o,a,l=t.x-e.x,h=t.y-e.y,c=i.getMin(),u=i.getMax();8&n?(o=e.x+l*(u.y-e.y)/h,a=u.y):4&n?(o=e.x+l*(c.y-e.y)/h,a=c.y):2&n?(o=u.x,a=e.y+h*(u.x-e.x)/l):1&n&&(o=c.x,a=e.y+h*(c.x-e.x)/l);var f=new Re(o,a);return s&&f._round(),f}function ec(e,t){var n=0;return e.x<t.getMin().x?n|=1:e.x>t.getMax().x&&(n|=2),e.y<t.getMin().y?n|=4:e.y>t.getMax().y&&(n|=8),n}function tc(e,t,n,i){e=new Re(e);var s,o,a,l=Math.abs(n.x-t.x),h=Math.abs(n.y-t.y),c=Math.sqrt(Math.abs(l*l-h*h));return l>=h?(s=new Re(t.x-c,t.y),o=new Re(t.x+c,t.y),a=2*l):(s=new Re(t.x,t.y-c),o=new Re(t.x,t.y+c),a=2*h),e.distanceTo(s)+e.distanceTo(o)<=a+2*i}function nc(e){if(!e)return[0,0];var t=1/0,n=-1/0;if(c(e))return[t=n=e,n];var i=function(e){for(var i=0,s=e.length;i<s;i++){var o=e[i];t=Math.min(t,o),n=Math.max(n,o)}};if(!Array.isArray(e[0]))return i(e),[t,n];for(var s=0,o=e.length;s<o;s++){i(e[s])}return[t,n]}function rc(e,t,n){var i=t.x,s=t.y,o=n.x,a=n.y;return(s-a)*e.x+(o-i)*e.y+i*a-o*s>0}function ic(e,t,n){return!rc(e,t,n)}function sc(e,t,n,i,s){var o=ic(e,t,n),a=ic(e,n,i),l=ic(e,i,s),h=ic(e,s,t);return o&&a&&l&&h}function oc(e,t,n,i){var s=t.x-e.x,o=t.y-e.y,a=i.x-n.x,l=i.y-n.y;if(0===s&&0===a)return null;if(0===o&&0===l)return null;var h=o/s,c=l/a;if(Math.abs(h)===Math.abs(c))return null;var u,f,g=e.y-h*e.x,m=n.y-c*n.x;return 0===s?f=c*(u=e.x)+m:0===a?f=h*(u=n.x)+g:0===o?u=((f=e.y)-m)/c:0===l?u=((f=n.y)-g)/h:f=h*(u=(m-g)/(h-c))+g,new Re(u,f)}function ac(e){if(c(e))return 0!==e;if(Array.isArray(e)&&e.length>0)for(var t=0,n=e.length;t<n;t++)if(c(e[t])&&0!==e[t])return!0;return!1}var lc=function(){function e(){this.bbox=hs()}var t=e.prototype;return t._setBBOX=function(e,t,n,i,s){return e.isHitTesting||As(this.bbox,t,n,i,s),this},t._bufferBBOX=function(e,t){return e.isHitTesting||_s(this.bbox,t),this},t.getMap=function(){return this.geometry.getMap()},t.getPainter=function(){return this.painter},t.isDynamicSize=function(){return!1},t.isVisible=function(){if(!this.style)return!0;var e=this.style.visible;return!1!==e&&0!==e&&!(this.style.opacity<=0)},e.testColor=function(e){return!(!e||!g(e))&&Ct.indexOf(e)>=0},e}(),hc=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n._prepareContext=function(e){if(Rr(this.symbol.opacity)?this._opacityFn||(this._opacityFn=Dr(this.symbol.opacity)):delete this._opacityFn,c(this.symbol.opacity))e.globalAlpha!==this.symbol.opacity&&(e.globalAlpha=this.symbol.opacity);else if(this._opacityFn){var t=this.getMap();e.globalAlpha=this._opacityFn(t.getZoom())}else 1!==e.globalAlpha&&(e.globalAlpha=1)},n.prepareCanvas=function(e,t,n){e.setLineDash&&Ye(t.lineDasharray)&&e.setLineDash(t.lineDasharray);var i=this.getPainter().isHitTesting();Ea.prepareCanvas(e,t,n,i)},n.remove=function(){},n.setZIndex=function(){},n.show=function(){},n.hide=function(){},n._defineStyle=function(e){return this.symbol&&(e.visible=this.symbol.visible,e.opacity=this.symbol.opacity),li(e,this.geometry)},t}(lc);function cc(e,t,n,i,s){var o,a=uc(n),l=n,h=l.markerType.toLowerCase(),c=fc(h,l.markerWidth,l.markerHeight),u=a.lineOpacity,f=a.polygonOpacity;_i(a.polygonFill)&&(_i(a.polygonFill)&&(o||(o=function(e,t,n){var i=new Pl;return i._combine(e),i.xmin+=-t/2,i.ymin+=-n/2,i.xmax+=t/2,i.ymax+=n/2,i}(t,l.markerWidth,l.markerHeight)),a.polygonGradientExtent=o));Ea.prepareCanvas(e,a,i);var g=l.markerWidth,m=l.markerHeight,A=l.markerLineWidth||0,w=A/2;if("ellipse"===h)Ea.ellipse(e,t,g/2,m/2,m/2,u,f);else if("cross"===h||"x"===h){for(var T=c.length-1;T>=0;T--)c[T]._add(t);Ea.path(e,c.slice(0,2),u),Ea.path(e,c.slice(2,4),u)}else if("diamond"===h||"bar"===h||"square"===h||"rectangle"===h||"triangle"===h||"roundrectangle"===h){"bar"===h?t=t.add(0,-w):"rectangle"!==h&&"roundrectangle"!==h||(t=t.add(w,w));for(var S=c.length-1;S>=0;S--)c[S]._add(t);"roundrectangle"===h?Ea.roundRect(e,c,u,f):Ea.polygon(e,c,u,f)}else if("pin"===h){t=t.add(0,-w);for(var M=c.length-1;M>=0;M--)c[M]._add(t);var C=e.lineCap;e.lineCap="round",Ea.bezierCurveAndFill(e,c,u,f),e.lineCap=C}else{if("pie"!==h)throw new Error("unsupported markerType: "+h);t=t.add(0,-w);var I=180*Math.atan(g/2/m)/Math.PI,E=e.lineCap;e.lineCap="round",Ea.sector(e,t,m,[90-I,90+I],u,f),e.lineCap=E}if(s){var{x:D,y:H}=t;s[0]=D-g/2-A,s[1]=H-m/2-A,s[2]=D+g/2+A,s[3]=H+m/2+A}return e.canvas}function uc(e){var t={lineColor:e.markerLineColor,linePatternFile:e.markerLinePatternFile,lineWidth:e.markerLineWidth,lineOpacity:e.markerLineOpacity,lineDasharray:e.markerLineDasharray,lineCap:"butt",lineJoin:"round",polygonFill:e.markerFill,polygonPatternFile:e.markerFillPatternFile,polygonOpacity:e.markerFillOpacity};return 0===t.lineWidth&&(t.lineOpacity=0),t}function fc(e,t,n){var i,s,o,a,l=n/2,h=t/2;if("triangle"===e)return[i=new Re(0,0-l),s=new Re(0-h,0+l),o=new Re(0+h,0+l)];if("cross"===e)return[i=new Re(0-h,0),s=new Re(0+h,0),o=new Re(0,0-l),a=new Re(0,0+l)];if("diamond"===e)return[i=new Re(0-h,0),s=new Re(0,0-l),o=new Re(0+h,0),a=new Re(0,0+l)];if("square"===e)return[i=new Re(0-h,0+l),s=new Re(0+h,0+l),o=new Re(0+h,0-l),a=new Re(0-h,0-l)];if("rectangle"===e||"roundrectangle"===e)return s=(i=new Re(0,0)).add(t,0),o=i.add(t,n),a=i.add(0,n),[i,s,o,a];if("x"===e)return[i=new Re(0-h,0+l),s=new Re(0+h,0-l),o=new Re(0+h,0+l),a=new Re(0-h,0-l)];if("bar"===e)return[i=new Re(0-h,0-n),s=new Re(0+h,0-n),o=new Re(0+h,0),a=new Re(0-h,0)];if("pin"===e||"pie"===e){var c=n*Math.atan(h/l);return[i=new Re(0,0),s=new Re(0-c,0-n),o=new Re(0+c,0-n),a=new Re(0,0)]}return[]}var dc=new Re(0,0),pc=new Re(0,0),gc=new Re(0,0),mc=new Re(0,0),Ac=function(e){function t(t,n,i){var s;return(s=e.call(this)||this).symbol=t,s.geometry=n,s.painter=i,s.rotations=[],s}Te(t,e);var n=t.prototype;return n.get2DExtent=function(){for(var e=this.getMap(),t=e.getGLRes(),n=new Pl,i=this._getRenderPoints()[0],s=i.length-1;s>=0;s--)i[s]&&n._combine(e._pointAtResToPoint(i[s],t));return n},n.isDynamicSize=function(){var e=this.symbol;return Rr(e.markerWidth)||Rr(e.markerHeight)||Rr(e.textSize)},n._rotateExtent=function(e,t){return e.convertTo((function(e){return e._rotate(t)}))},n._getRenderPoints=function(){var e=this.getPainter().isSpriting()?"center":this.getPlacement();return this.getPainter().getRenderPoints(e)},n._getRenderContainerPoints=function(e){var t=this.getPainter();if(t.isSpriting())return this._getRenderPoints()[0];var n,i=this.geometry,s=this.getDxDy();if(i._cPoint&&!e){var o=e?gc:mc;o.set(i._cPoint.x,i._cPoint.y),o._sub(t.containerOffset);var a=s.x,l=s.y;(a||l)&&o._add(a||0,l||0),n=[o]}else{var h=this._getRenderPoints()[0];n=this.painter._pointContainerPoints(h,s.x,s.y,e,!0,this.getPlacement())}if(!n||!Array.isArray(n[0]))return n;for(var c=[],u=0,f=n.length;u<f;u++)for(var g=0,m=n[u].length;g<m;g++)c.push(n[u][g]);return c},n.getPlacement=function(){return this.symbol.markerPlacement},n.getRotation=function(){return Hh(this.style)},n.getDxDy=function(){var e=this.style;return new Re(e.markerDx,e.markerDy)},n._getRotationAt=function(e){var t=this.getRotation();t||(t=0);var n=this._getRenderPoints()[1];if(!n||!n[e])return t;var i=this.getMap(),s=n[e][0],o=n[e][1];if(!s||!o)return t;if(i.isTransforming()){var a=i.getGLRes();return s=i._pointAtResToContainerPoint(n[e][0],a,0,dc),o=i._pointAtResToContainerPoint(n[e][1],a,0,pc),t+ot(s.x,s.y,o.x,o.y)}return t+-ot(s.x,s.y,o.x,o.y)},n._rotate=function(e,t,n){if(n){var i=this.getDxDy(),s=t.sub(i);return e.save(),e.translate(s.x,s.y),e.rotate(n),i}return null},t}(hc),yc=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.getPlacement=function(){return"point"},n.getDxDy=function(){return new Re(0,0)},n.symbolize=function(e){var t=this.geometry,n=t.getLayer();if(t.options.debug||!n||n.options.debug){var i=this.getMap();if(i&&!i.isZooming()){var s=n.options.debugOutline;e.strokeStyle=s,e.fillStyle=s,e.lineWidth=1,e.font="18px  serif";var o=t.getContainerExtent().toArray();Ea.polygon(e,[o],1,0);for(var a=this._getRenderContainerPoints(),l=this.geometry.getId(),c=fc("cross",10,10),u=0;u<a.length;u++){var f=a[u];h(l)||Ea.fillText(e,l,f.add(8,-4),s);for(var g=[],m=0;m<c.length;m++)g.push(c[m].add(f));Ea.path(e,g.slice(0,2),1),Ea.path(e,g.slice(2,4),1)}}}},t}(Ac),_c=new Ot(1,1),vc=new Pl,xc=function(e){function t(t,n,i){var s;return(s=e.call(this,t,n,i)||this).style=s._defineStyle(s.translate()),s}Te(t,e),t.test=function(e){return Vh(e)};var n=t.prototype;return n.symbolize=function(e,t){if(this.isVisible()){var n=this.style;if(this.painter.isHitTesting()||0!==n.markerWidth&&0!==n.markerHeight&&0!==n.markerOpacity){var i=this._getRenderContainerPoints();if(Ye(i))if(n.markerFile||this._url){var s=this._getImage(t);if(s){this._prepareContext(e);var o,a=n.markerWidth,l=n.markerHeight;if(!c(a)||!c(l)){l=s.height,n.markerWidth=a=s.width,n.markerHeight=l;var h=n.markerFile;t.isResourceLoaded(h)||t.addResource(h,s);var u=this.getPainter();u.isSpriting()||u.removeCache()}"path"!==this.symbol.markerType&&c(n.markerOpacity)&&n.markerOpacity<1&&(o=e.globalAlpha,e.globalAlpha*=n.markerOpacity),_c.width=a,_c.height=l;var f=Yt(_c,n.markerHorizontalAlignment,n.markerVerticalAlignment);this.rotations=[];for(var g=0,m=i.length;g<m;g++){var A=i[g],w=this._rotate(e,A,this._getRotationAt(g)),T=void 0;if(w){var S=A.sub(w);A=w;var M=this._getRotationAt(g);(T=Mh(vc,M,a,l,A,f))._add(S),this.rotations.push(M)}var C=A.x+f.x,I=A.y+f.y;Ea.image(e,s,C,I,a,l),w&&e.restore(),w?this._setBBOX(e,T.xmin,T.ymin,T.xmax,T.ymax):this._setBBOX(e,C,I,C+a,I+l)}void 0!==o&&(e.globalAlpha=o)}else"undefined"!=typeof console&&console.warn("no img found for "+(this.style.markerFile||this._url[0]))}else console.warn("not find icon url:",n)}}},n._getImage=function(e){return function(e,t){return e&&e.getImage(t)||null}(e,this.style.markerFile)},n.getFixedExtent=function(e){return this._fixedExtent=this._fixedExtent||new Pl,Nh(this._fixedExtent,this.style,e)},n.translate=function(){var e=this.symbol;return{markerFile:e.markerFile,markerOpacity:je(e.markerOpacity,1),markerWidth:je(e.markerWidth,null),markerHeight:je(e.markerHeight,null),markerRotation:je(e.markerRotation,0),markerDx:je(e.markerDx,0),markerDy:je(e.markerDy,0),markerHorizontalAlignment:je(e.markerHorizontalAlignment,"middle"),markerVerticalAlignment:je(e.markerVerticalAlignment,"top")}},t}(Ac);let bc;const wc={width:100,height:10};let Tc=!1;try{const e=new OffscreenCanvas(1,1);e.getContext("2d").fillText("hello",0,0),Tc=!0}catch(e){Tc=!1}let Sc=class ColorIn{constructor(e,t={}){if(!Array.isArray(e))return void console.error("colors is not array");if(e.length<2)return void console.error("colors.length should >1");this.colors=e;let n=1/0,i=-1/0;for(let t=0,s=e.length;t<s;t++){const s=e[t][0];n=Math.min(s,n),i=Math.max(s,i)}this.min=n,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},wc,t),this._initImgData()}getImageData(){return this.imgData}_initImgData(){const e=function(){if(!bc){const{width:e,height:t}=wc;Tc?bc=new OffscreenCanvas(e,t):(bc=document.createElement("canvas"),bc.width=e,bc.height=t)}return bc}(),{width:t,height:n}=this.options;e.width=t,e.height=n;const i=e.getContext("2d");i.clearRect(0,0,e.width,e.height);const s=i.createLinearGradient(0,0,e.width,0),{colors:o,valueOffset:a}=this;for(let e=0,t=o.length;e<t;e++){const[t,n]=o[e];s.addColorStop((t-this.min)/a,n)}i.fillStyle=s,i.fillRect(0,0,e.width,e.height),this.imgData=i.getImageData(0,0,e.width,e.height)}getColor(e){e=Math.max(this.min,e),e=Math.min(e,this.max);let t=Math.round((e-this.min)/this.valueOffset*this.imgData.width);t=Math.min(t,this.imgData.width-1);const n=4*t;return[this.imgData.data[n],this.imgData.data[n+1],this.imgData.data[n+2],this.imgData.data[n+3]]}};var Mc=new fl(0,0),Cc=new fl(0,0),Pc=function(e){function t(t,n,i){var s;return(s=e.call(this)||this).symbol=t,s.geometry=n,s.painter=i,n.isPoint?ve(s):(s.style=s._defineStyle(s.translate()),s)}Te(t,e),t.test=function(e,t){if(!e)return!1;if(t&&t.isPoint)return!1;for(var n in e){var i=n.slice(0,4);if("line"===i||"poly"===i)return!0}return!1};var n=t.prototype;return n.symbolize=function(e,t){if(this.isVisible()){var n=this.style;if(0!==n.polygonOpacity||0!==n.lineOpacity||this.painter.isHitTesting()){var i=this._getPaintParams();if(i){this._prepareContext(e);var s=_i(n.lineColor)||n.lineGradientProperty,o="Polygon"===this.geometry.getJSONType()||"LineString"===this.geometry.type;!s||!n.lineColor.places&&o||(n.lineGradientExtent=this.geometry.getContainerExtent()._expand(n.lineWidth)),_i(n.polygonFill)&&(n.polygonGradientExtent=this.geometry.getContainerExtent());var a=this.geometry.getLayer().options.geometryEventTolerance||0,l=this.geometry._hitTestTolerance()+a,h=i[0];if("Polygon"===this.geometry.getJSONType()&&h.length>0&&Array.isArray(h[0][0])||"LineString"===this.geometry.type&&h.length>0&&Array.isArray(h[0]))for(var c=0;c<h.length;c++){this.prepareCanvas(e,n,t),s&&o&&!n.lineColor.places&&this._createGradient(e,h[c],n.lineColor);var u=[e,h[c]];i.length>1&&u.push(...i.slice(1)),u.push(n.lineOpacity,n.polygonOpacity,n.lineDasharray),s&&u.push(this._lineColorIn);var f=this.geometry._paintOn(...u);this._setBBOX(e,f),this._bufferBBOX(e,l)}else{this.prepareCanvas(e,n,t),s&&o&&!n.lineColor.places&&this._createGradient(e,h,n.lineColor);var g=[e];g.push(...i),g.push(n.lineOpacity,n.polygonOpacity,n.lineDasharray),s&&g.push(this._lineColorIn);var m=this.geometry._paintOn(...g);this._setBBOX(e,m),this._bufferBBOX(e,l)}e.setLineDash&&Array.isArray(n.lineDasharray)&&e.setLineDash([]),this._tempRenderPoints=h}}}},n.get2DExtent=function(){var e=this.getMap(),t=this.geometry._getPrjExtent();if(!t)return null;this._extMin&&this._extMax||(this._extMin=new fl(0,0),this._extMax=new fl(0,0)),this._extMin.x=t.xmin,this._extMin.y=t.ymin,this._extMax.x=t.xmax,this._extMax.y=t.ymax;var n=e._prjToPoint(this._extMin,void 0,Mc),i=e._prjToPoint(this._extMax,void 0,Cc);return this._pxExtent?this._pxExtent.set(Math.min(n.x,i.x),Math.min(n.y,i.y),Math.max(n.x,i.x),Math.max(n.y,i.y)):this._pxExtent=new Pl(n,i),this._pxExtent},n.getFixedExtent=function(){var e=this.style.lineWidth/2;return new Pl(-e,-e,e,e)},n._getPaintParams=function(){return this.getPainter().getPaintParams(this.style.lineDx,this.style.lineDy)},n.translate=function(){var e=this.symbol,t={lineColor:je(e.lineColor,"#000"),lineWidth:je(e.lineWidth,2),lineOpacity:je(e.lineOpacity,1),lineDasharray:je(e.lineDasharray,[]),lineCap:je(e.lineCap,"butt"),lineJoin:je(e.lineJoin,"miter"),linePatternFile:je(e.linePatternFile,null),lineDx:je(e.lineDx,0),lineDy:je(e.lineDy,0),polygonFill:je(e.polygonFill,null),polygonOpacity:je(e.polygonOpacity,1),polygonPatternFile:je(e.polygonPatternFile,null),polygonPatternDx:je(e.polygonPatternDx,0),polygonPatternDy:je(e.polygonPatternDy,0),linePatternDx:je(e.linePatternDx,0),linePatternDy:je(e.linePatternDy,0),lineGradientProperty:je(e.lineGradientProperty,null),lineStrokeColor:je(e.lineStrokeColor,null),lineStrokeWidth:je(e.lineStrokeWidth,null)};return 0===t.lineWidth&&(t.lineOpacity=0),"LineString"!==this.geometry.type||t.polygonFill||(t.polygonFill=t.lineColor),t},n._createGradient=function(e,t,n){if(Array.isArray(t)&&t.length){var[i,s]=function(e){var t,n=!0;Array.isArray(e[0])?(t=e[0],n=!1):t=e;var i=t.length;if(n)return[t[0],t[i-1]];for(var s,o=t[0],a=0,l=1;l<i;l++){var h=t[l],c=o.distanceTo(h);c>a&&(a=c,s=h)}return[o,s]}(t);if(i&&s){var o;if(n.colorStops&&(o=n.colorStops),!o)o=(this.geometry.properties||{})[(this.style||{}).lineGradientProperty];if(o&&Array.isArray(o)&&!(o.length<2)){if(!Array.isArray(o[0])){for(var a=[],l=[],h=0,c=0,u=o.length;c<u;c+=2)l[0]=o[c],l[1]=o[c+1],a[h]=l,h++,l=[];o=a}var f=e.createLinearGradient(i.x,i.y,s.x,s.y);o.forEach((function(e){f.addColorStop(...e)})),e.strokeStyle=f;var g=JSON.stringify(o);if(g!==this._lineColorStopsKey){this._lineColorStopsKey=g;var m=o.map((function(e){return[parseFloat(e[0]),e[1]]}));this._lineColorIn=new Sc(m,{height:1,width:100})}}}else console.error("unable create canvas LinearGradient,error data:",t)}},t}(hc);var Ic=new Pl;var kc,Oc=function(e){function t(t,n,i){var s,o=(s=e.call(this,t,n,i)||this).translate();return s._dynamic=Lr(o),s.style=s._defineStyle(o),0===s.style.textWrapWidth?ve(s):(s.strokeAndFill=s._defineStyle(s.translateLineAndFill(s.style)),s)}Te(t,e),t.test=function(e){return Uh(e)};var n=t.prototype;return n.isAlongLine=function(){var e=this.getPlacement(),t=this.style.textSpacing;return"line"===e&&c(t)&&t>0},n.symbolize=function(e,t){if(this.isVisible()){var n=this.style;if(this.painter.isHitTesting()||0!==n.textSize&&(n.textOpacity||n.textHaloRadius&&n.textHaloOpacity)&&0!==n.textWrapWidth){var i=this.strokeAndFill,s=Zt(this.style.textName,this.geometry.getProperties());this._dynamic&&delete this._textDesc;var o=this._textDesc=this._textDesc||Xt(s,this.style);this._prepareContext(e),this.prepareCanvas(e,i,t),this._textFont||(this._textFont=Kt(n)),Ea.prepareCanvasFont(e,n,this._dynamic?null:this._textFont);var a=n.textHaloRadius||0;if(this.rotations=[],this.isAlongLine()){var l=this.getPainter().getPathTempRenderPoints();if(!l)return;if(l=function(e,t){var{width:n,height:i}=t,s=n+0,o=i+0;Ic.xmin=-0,Ic.ymin=-0,Ic.xmax=s,Ic.ymax=o,Array.isArray(e[0])||(e=[e]);var a=[];return e.forEach((function(e){for(var t=!1,n=0,i=e.length;n<i;n++){var{x:l,y:h}=e[n];if(l<-0||l>s||h<-0||h>o){t=!0;break}}t?Jh(e,Ic,!1,!1).forEach((function(e){for(var t=[],n=0,i=e.length;n<i;n++)t[n]=e[n].point;a.push(t)})):a.push(e)})),a}(l,this.getMap().getSize()),l){var h=this.geometry.getLayer(),c=Ea.textAlongLine(e,s,l,n,o,h.options.collision?h.getCollisionIndex():null);c&&(this._setBBOX(e,c),this._bufferBBOX(e,a))}}else{var u=this._getRenderContainerPoints();if(!Ye(u))return;for(var f=0,g=u.length;f<g;f++){var m=u[f],A=this._rotate(e,m,this._getRotationAt(f)),w=void 0;if(A){var T=m.sub(A);m=A;var S=this._getRotationAt(f),{width:M,height:C}=o.size||{width:0,height:0},I=Yt(o.size,n.textHorizontalAlignment,n.textVerticalAlignment);(w=Mh(Ic,S,M,C,m,I))._add(T),this.rotations.push(S)}var E=Ea.text(e,s,m,n,o);A?(this._setBBOX(e,w.xmin,w.ymin,w.xmax,w.ymax),e.restore()):this._setBBOX(e,E),this._bufferBBOX(e,a)}}}}},n.getPlacement=function(){return this.symbol.textPlacement},n.getRotation=function(){var e=this.style.textRotation;return c(e)?-e*Math.PI/180:null},n.getDxDy=function(){var e=this.style;return new Re(e.textDx,e.textDy)},n.getFixedExtent=function(){var e=this.geometry.getTextDesc();return Array.isArray(e)&&(e=e[this._index]),this._fixedExtent=this._fixedExtent||new Pl,e?Bh(this._fixedExtent,this.style,e):this._fixedExtent},n.translate=function(){var e=this.symbol,t={textName:e.textName,textFaceName:je(e.textFaceName,"monospace"),textWeight:je(e.textWeight,"normal"),textStyle:je(e.textStyle,"normal"),textSize:je(e.textSize,Pt),textFont:je(e.textFont,null),textFill:je(e.textFill,"#000"),textOpacity:je(e.textOpacity,1),textHaloFill:je(e.textHaloFill,"#ffffff"),textHaloRadius:je(e.textHaloRadius,0),textHaloOpacity:je(e.textHaloOpacity,1),textWrapWidth:je(e.textWrapWidth,null),textWrapCharacter:je(e.textWrapCharacter,"\n"),textLineSpacing:je(e.textLineSpacing,0),textDx:je(e.textDx,0),textDy:je(e.textDy,0),textHorizontalAlignment:je(e.textHorizontalAlignment,"middle"),textVerticalAlignment:je(e.textVerticalAlignment,"middle"),textAlign:je(e.textAlign,"center"),textRotation:je(e.textRotation,0),textMaxWidth:je(e.textMaxWidth,0),textMaxHeight:je(e.textMaxHeight,0),textSpacing:je(e.textSpacing,0),textAlongDebug:je(e.textAlongDebug,!1)};return t.textMaxWidth>0&&(!t.textWrapWidth||t.textWrapWidth>t.textMaxWidth)&&(t.textWrapWidth||(t.textMaxHeight=1),t.textWrapWidth=t.textMaxWidth),t},n.translateLineAndFill=function(e){return{lineColor:e.textHaloRadius?e.textHaloFill:e.textFill,lineWidth:e.textHaloRadius,lineOpacity:e.textOpacity,lineDasharray:null,lineCap:"butt",lineJoin:"round",polygonFill:e.textFill,polygonOpacity:e.textOpacity}},t}(Ac),Ec=[0,0],Rc=new Pl,Lc=new Re(0,0),Dc=hs(),Fc=function(e){function t(t,n,i){var s,o=(s=e.call(this,t,n,i)||this).translate();return s._dynamic=Lr(o),s.style=s._defineStyle(o),s.strokeAndFill=s._defineStyle(uc(s.style)),s.padding=0,s}Te(t,e),t.test=function(e){return jh(e)};var n=t.prototype;return n.symbolize=function(e,t){if(this.isVisible()){var n=this.style;if(this.painter.isHitTesting()||0!==n.markerWidth&&0!==n.markerHeight&&(0!==n.polygonOpacity||0!==n.lineOpacity)){var i=this._getRenderContainerPoints();Ye(i)&&(this._prepareContext(e),this.getPainter().isSpriting()||this.geometry.getLayer().getMask()===this.geometry||this._dynamic||!1===this.geometry.getLayer().options.cacheVectorOnCanvas?this._drawMarkersWithDynamic(e,i,t):this._drawMarkersWithCache(e,i,t))}}},n._drawMarkersWithDynamic=function(e,t,n){for(var i=t.length-1;i>=0;i--){var s=t[i],o=Dh(Ec,this.style),[a,l]=o,h=this._rotate(e,s,this._getRotationAt(i));this.rotations=[];var c=void 0;if(h){var u=s.sub(h);s=h;var f=this._getRotationAt(i);(c=Mh(Rc,f,a,l,s,Lc))._add(u),this.rotations.push(f)}var g=this._drawVectorMarker(e,s,n);if(h)e.restore(),this._setBBOX(e,c.xmin,c.ymin,c.xmax,c.ymax);else if(g)this._setBBOX(e,g[0],g[1],g[2],g[3]);else{var{x:m,y:A}=s;this._setBBOX(e,m,A,m+a,A+l)}}},n._drawMarkersWithCache=function(e,t,n){var i=this._stampSymbol(),s=n.getImage(i);s||(s=this._createMarkerImage(e,n),n.addResource([i,s.width,s.height],s));for(var o=Lh(this.style,s.width,s.height),a=t.length-1;a>=0;a--){var l=t[a],h=this._rotate(e,l,this._getRotationAt(a));this.rotations=[];var c=void 0;if(h){var u=l.sub(h);l=h;var f=this._getRotationAt(a);(c=Mh(Rc,f,s.width,s.height,l,o))._add(u),this.rotations.push(f)}var g=l.x+o.x,m=l.y+o.y;Ea.image(e,s,g,m),h?(e.restore(),this._setBBOX(e,c.xmin,c.ymin,c.xmax,c.ymax)):this._setBBOX(e,g,m,g+s.width,m+s.height)}},n._createMarkerImage=function(e,t){var n=e.canvas.constructor,i=Dh(Ec,this.style),s=Ea.createCanvas(i[0],i[1],n),o=this._getCacheImageAnchor(i[0],i[1]),a=s.getContext("2d");return this._drawVectorMarker(a,o,t),s},n._stampSymbol=function(){return this._stamp||(this._stamp=tn([this.style.markerType,_i(this.style.markerFill)?vi(this.style.markerFill):this.style.markerFill,this.style.markerFillOpacity,this.style.markerFillPatternFile,_i(this.style.markerLineColor)?vi(this.style.markerLineColor):this.style.markerLineColor,this.style.markerLineWidth,this.style.markerLineOpacity,this.style.markerLineDasharray?this.style.markerLineDasharray.join(","):"",this.style.markerLinePatternFile,this.style.markerWidth,this.style.markerHeight,this.style.markerHorizontalAlignment,this.style.markerVerticalAlignment].join("_"))),this._stamp},n._getCacheImageAnchor=function(e,t){var n=2*(this.symbol.shadowBlur||0)+this.padding,i=this.style.markerType;return"bar"===i||"pie"===i||"pin"===i?new Re(e/2,t-n):"rectangle"===i||"roundrectangle"===i?new Re(n,n):new Re(e/2,t/2)},n._getGraidentExtent=function(e){var t=new Pl,n=this.getDxDy(),i=this.getFixedExtent();if(Array.isArray(e))for(var s=e.length-1;s>=0;s--)t._combine(e[s]);else t._combine(e);return t.xmin+=i.xmin-n.x,t.ymin+=i.ymin-n.y,t.xmax+=i.xmax-n.x,t.ymax+=i.ymax-n.y,t},n._drawVectorMarker=function(e,t,n){return ds(Dc),cc(e,t,this.style,n,Dc),Dc},n.getFixedExtent=function(){return this._fixedExtent=this._fixedExtent||new Pl,kh(this._fixedExtent,this.style,null)},n.translate=function(){var e=this.symbol,t={markerType:je(e.markerType,"ellipse"),markerFill:je(e.markerFill,"#00f"),markerFillOpacity:je(e.markerFillOpacity,1),markerFillPatternFile:je(e.markerFillPatternFile,null),markerLineColor:je(e.markerLineColor,"#000"),markerLineWidth:je(e.markerLineWidth,Th.markerLineWidth),markerLineOpacity:je(e.markerLineOpacity,1),markerLineDasharray:je(e.markerLineDasharray,[]),markerLinePatternFile:je(e.markerLinePatternFile,null),markerDx:je(e.markerDx,0),markerDy:je(e.markerDy,0),markerWidth:je(e.markerWidth,Th.markerWidth),markerHeight:je(e.markerHeight,Th.markerHeight),markerRotation:je(e.markerRotation,0),shadowBlur:je(e.shadowBlur,0),shadowOffsetX:je(e.shadowOffsetX,0),shadowOffsetY:je(e.shadowOffsetY,0)},n=t.markerType,i=Oh(n),s=Eh(n);return t.markerHorizontalAlignment=je(e.markerHorizontalAlignment,i),t.markerVerticalAlignment=je(e.markerVerticalAlignment,s),c(e.markerOpacity)&&(c(e.markerFillOpacity)&&(t.markerFillOpacity*=e.markerOpacity),c(e.markerLineOpacity)&&(t.markerLineOpacity*=e.markerOpacity)),t},t}(Ac),Hc=function(e){function t(t,n,i){var s;h(t.markerWidth)&&(t.markerWidth=80),h(t.markerHeight)&&(t.markerHeight=80),t=l({},t,(s=e.call(this,t,n,i)||this).translate());var o=s.style=s._defineStyle(t);return s._url=ye.gecko?[fi(o,o.markerWidth,o.markerHeight),o.markerWidth,o.markerHeight]:[fi(o),o.markerWidth,o.markerHeight],s}Te(t,e),t.test=function(e){return Wh(e)};var n=t.prototype;return n._prepareContext=function(){},n._getImage=function(e){var t=this;if(e&&e.isResourceLoaded(this._url))return e.getImage(this._url);var n=this.painter,i=new Image;return i.onload=function(){var e=n.getLayer()&&n.getLayer().getRenderer();e&&e.setToRedraw()},i.onerror=function(n){n&&"undefined"!=typeof console&&console.warn(n),e.markErrorResource(t._url)},i.src=this._url[0],e&&e.addResource(this._url,i),i},t}(xc),Nc={lineWidth:1,polygonFill:"#fff",polygonOpacity:.5},Bc=function(e){function t(t,n,i){var s;return(s=e.call(this,t,n,i)||this).style=n.getLayer().options.drawAltitude,s.style&&f(s.style)||(s.style={lineWidth:2}),s.style.lineWidth||(s.style.lineWidth=0),s.dxdy=s._defineStyle({dx:t.textDx||t.markerDx,dy:t.textDy||t.markerDy}),s}Te(t,e),t.test=function(e,t){if(!t.getLayer())return!1;var n=t.getJSONType();return"Marker"===n||"LineString"===n};var n=t.prototype;return n.symbolize=function(e){if(this.geometry.getLayer().options.drawAltitude&&this.geometry.hasAltitude()){var t=this._getStyle();if(this._prepareContext(e),"LineString"===this.geometry.type){var n=this._getPaintParams(t.lineDx,t.lineDy);if(!n)return;var i=this.getPainter().getPaintParams(t.lineDx,t.lineDy,!0,!0,"_groundpt")[0];this._drawLineAltitude(e,n[0],i)}else{var s=this._getRenderContainerPoints(),o=this._getRenderContainerPoints(!0);if(!s||0===s.length)return;this._drawMarkerAltitude(e,s[0],o[0])}}},n.getDxDy=function(){var e=this.dxdy;return new Re(e.dx||0,e.dy||0)},n.get2DExtent=function(){return"LineString"===this.geometry.type?Pc.prototype.get2DExtent.apply(this):e.prototype.get2DExtent.call(this)},n.getPlacement=function(){return"point"},n._getPaintParams=function(e,t){return this.getPainter().getPaintParams(e||0,t||0,null,!0,"_altpt")},n._drawMarkerAltitude=function(e,t,n){var i=this._getStyle();this.prepareCanvas(e,i),Ea.path(e,[t,n],i.lineOpacity,null,i.lineDasharray)},n._drawLineAltitude=function(e,t,n){var i=this._getStyle();if(t.length>0&&Array.isArray(t[0]))for(var s=0;s<t.length;s++)this._drawLine(e,t[s],n[s]);else this._drawLine(e,t,n);e.setLineDash&&Array.isArray(i.lineDasharray)&&e.setLineDash([])},n._drawLine=function(e,t,n){var i=this._getStyle();this.prepareCanvas(e,i);for(var s=0,o=t.length-1;s<o;s++)Ea.polygon(e,[t[s],t[s+1],n[s+1],n[s]],i.lineOpacity,i.polygonOpacity,i.lineDasharray)},n._getStyle=function(){var e=this.geometry.getLayer(),t=e.options.drawAltitude;if(Array.isArray(t)){var n=(e.getGeometries()||[]).indexOf(this.geometry);n>=0&&(t=t[n]||Nc)}return f(t)||(t=Nc),t.lineWidth||(t.lineWidth=0,t.lineOpacity=0),t},t}(Ac),zc=Object.freeze({__proto__:null,CanvasSymbolizer:hc,DebugSymbolizer:yc,DrawAltitudeSymbolizer:Bc,ImageMarkerSymbolizer:xc,PointSymbolizer:Ac,StrokeAndFillSymbolizer:Pc,Symbolizer:lc,TextMarkerSymbolizer:Oc,VectorMarkerSymbolizer:Fc,VectorPathMarkerSymbolizer:Hc}),Gc=[Bc,Pc,xc,Hc,Fc,Oc],Uc=new Re(0,0),Vc=new Pl,jc=new Pl,Wc=new Pl,qc=new Pl,Zc=new Pl,Xc={code:void 0},Yc={minx:1/0,miny:1/0,maxx:-1/0,maxy:-1/0},Jc=[],Qc=function(e){function t(t){var n;return(n=e.call(this)||this).geometry=t,n.symbolizers=n._createSymbolizers(),n._altAtGL=n._getGeometryAltitude(),n.bbox=hs(),n._drawTime=0,n}Te(t,e);var n=t.prototype;return n._setDrawTime=function(e){return this._drawTime=e,this},n.getRenderBBOX=function(){var e=this.getLayer();if(e&&e._drawTime!==this._drawTime)return null;ds(this.bbox);for(var t=!1,n=this.symbolizers.length-1;n>=0;n--){var i=this.symbolizers[n];if(!(i instanceof Bc||i instanceof yc)){var s=i.bbox;if(!ys(s)){t=!0;break}As(this.bbox,s)}}return t?null:ys(this.bbox)?this.bbox:null},n.getMap=function(){return this.geometry.getMap()},n.getLayer=function(){return this.geometry&&this.geometry.getLayer()},n._createSymbolizers=function(){var e=this.getSymbol(),t=[],n=Gc,i=e;Array.isArray(e)||(i=[e]);for(var s=i.length-1;s>=0;s--)for(var o=i[s],a=n.length-1;a>=0;a--)if(n[a].test(o,this.geometry)){var l=new n[a](o,this.geometry,this);l._index=s,t.push(l),l instanceof Ac&&(this._hasPoint=!0)}if(!t.length&&console){var h=this.geometry.getId();console.warn("invalid symbol for geometry("+(this.geometry?this.geometry.getType()+(h?":"+h:""):"")+") to draw : "+JSON.stringify(e))}return this._debugSymbolizer=new yc(e,this.geometry,this),t},n.hasPoint=function(){return!!this._hasPoint},n.getRenderPoints=function(e){return this._verifyProjection(),this._renderPoints||(this._renderPoints={}),e||(e="center"),this._renderPoints[e]||(this._renderPoints[e]=this.geometry._getRenderPoints(e)),this._renderPoints[e]},n.getPaintParams=function(e,t,n,i,s="_pt"){var o,a,l,h,u,f=this.getLayer()._getRenderer().mapStateCache,g=this.getMap();f&&!this._hitPoint?(o=f.resolution,a=f.pitch,l=f.bearing,h=f.glScale,u=f.containerExtent):(o=g.getResolution(),a=g.getPitch(),l=g.getBearing(),h=g.getGLScale(),u=g.getContainerExtent());var m=this.geometry,A=o,w=0!==a,T=0!==l,S=this._cachedParams,M=m._paintAsPath&&m._paintAsPath();if(M&&this._unsimpledParams&&A<=this._unsimpledParams._res)S=this._unsimpledParams;else if(!S||S._res!==o||this._pitched!==w&&m._redrawWhenPitch()||this._rotated!==T&&m._redrawWhenRotate()){if(!(S=m._getPaintParams()))return null;S._res=A,!m._simplified&&M&&(this._unsimpledParams||(this._unsimpledParams=S),A>this._unsimpledParams._res&&(this._unsimpledParams._res=A)),this._cachedParams=S}if(!S)return null;this._pitched=w,this._rotated=T;var C=h,I=[],E=!!m.getHoles,D=this._pointContainerPoints(S[0],e,t,n,i||this._hitPoint&&!u.contains(this._hitPoint),null,s,E);if(!D)return null;I.push(D);for(var H=1,N=S.length;H<N;H++)c(S[H])||S[H]instanceof Ot?c(S[H])?I.push(S[H]/C):I.push(S[H].multi(1/C)):I.push(S[H]);return I},n._pointContainerPoints=function(e,t,n,i,s,o,a="_pt",l){if(this._aboveCamera())return null;var h,u,f,g=this.getLayer()._getRenderer(),m=g.mapStateCache,A=this.getMap(),w=this.geometry,T=this.containerOffset;m?(h=m.glRes,u=m.containerExtent):(h=A.getGLRes(),u=A.getContainerExtent());var S=this.getLayer().options.roundPoint,M=1/0,C=1/0,I=-1/0,E=-1/0,D=!s,H=g.layer.options.clipBBoxBufferSize||3,N=this.symbolizers,B=w.options.enableClip,z=w.options.strictClip;function U(e=[],i=[]){var s=e;if(z&&A._currentViewGLInfo&&e.length>1&&!ac(i)){s=[];for(var{lt:o,rt:c,rb:f,lb:g,RB:m,LB:U}=A._currentViewGLInfo,j=0,W=e.length;j<W;j++){var q=e[j];if(!sc(q,o,c,f,g)&&rc(q,m,U)){var Z=e[j-1]||(l?e[W-1]:e[1]),X=e[j+1]||(l?e[0]:e[W-2]);if(Z&&X){var Y=rc(Z,m,U),J=rc(X,m,U);if(Y&&J)s.push(q);else{var Q=!1;if(!Y){var $=oc(Z,q,m,U);$&&(s.push($),Q=!0)}if(!J){var K=oc(X,q,m,U);K&&(s.push(K),Q=!0)}Q||s.push(q)}}else s.push(q)}else s.push(q)}}for(var ee=pt(s,a),te=0,re=(ee=A._pointsAtResToContainerPoints(s,h,i,ee)).length;te<re;te++){var se=ee[te];se._sub(T),(t||n)&&se._add(t||0,n||0),S&&(se.x=Math.ceil(se.x),se.y=Math.ceil(se.y)),M=Math.min(se.x,M),C=Math.min(se.y,C),I=Math.max(se.x,I),E=Math.max(se.y,E)}if(B&&D&&ki(N)){if(Zc.ymin=u.ymin,Zc.ymin<H&&(Zc.ymin=u.ymin-H),Zc.xmin=u.xmin-H,Zc.xmax=u.xmax+H,Zc.ymax=u.ymax+H,w.getShell&&w.getHoles)return $h(ee,Zc);var oe=Jh(ee,Zc,!1);if(oe.length){var le=[];return oe.forEach((function(e){for(var t=0,n=e.length;t<n;t++)le.push(e[t].point)})),le}}return ee}var j=this.getAltitude();if(Array.isArray(e)){var W;!s&&this.geometry.options.enableClip?(W=this._clip(e,j)).inView&&(D=!1):W={points:e,altitude:j};var q=W.points;j=W.altitude,i&&(j=0);var Z=j;f=[];for(var X=[],Y=c(j),J=0,Q=q.length;J<Q;J++){var $=q[J];if(Array.isArray($)){if(Y){var K=U($,j);f.push(K);continue}for(var ee=[],te=0,re=$.length;te<re;te++)Array.isArray(j)&&(Z=j[J]?j[J][te]:0),ee.push(Z);var se=U($,ee);f.push(se)}else Array.isArray(j)&&(Z="vertex-last"===o?j[j.length-1-J]:"line"===o?(j[J]+j[J+1])/2:j[J]),X.push(Z)}X.length&&(f=U(q,X))}else e instanceof Re&&(i&&(j=0),f=A._pointAtResToContainerPoint(e,h,j)._sub(T),(t||n)&&f._add(t,n));return Yc.minx=M,Yc.miny=C,Yc.maxx=I,Yc.maxy=E,this._containerBbox=Yc,f},n._clip=function(e,t){if(ac(t))return{points:e,altitude:t};var n=this.getMap(),i=this.geometry,s=this.getSymbol().lineWidth;c(s)||(s=4);var o,a,l,h=this.getLayer()._getRenderer().mapStateCache;h?(o=h._2DExtent,a=h.glExtent,l=h.pitch):(o=n.get2DExtent(),a=n.get2DExtentAtRes(n.getGLRes()),l=n.getPitch());var u=o._expand(s);if(l>0&&t){var f=n.cameraLookAt,g=n.cameraPosition;Uc.set(g[0],g[1]),u=u._combine(Uc._add(We(f[0]-g[0]),We(f[1]-g[1])))}var m=e;if(this.get2DExtent(null,qc).within(u))return{points:m,altitude:t,inView:!0};var A=a._expand(s*n.getGLScale());Wc.xmin=A.xmin,Wc.xmax=A.xmax,Wc.ymin=A.ymin,Wc.ymax=A.ymax;var w=i.options.smoothness;if(i.getShell&&this.geometry.getHoles&&!w){var{xmin:T,ymin:S,xmax:M,ymax:C}=A,I=Math.abs(M-T),E=Math.abs(C-S),D=Math.sqrt(I*I+E*E),H=(D-I)/2,N=(D-E)/2;if(Wc.xmin=A.xmin-H,Wc.xmax=A.xmax+H,Wc.ymin=A.ymin-N,Wc.ymax=A.ymax+N,Array.isArray(e[0])){m=[];for(var B=0;B<e.length;B++){var z=$h(e[B],Wc);z.length&&m.push(z)}}else m=$h(e,Wc)}else if("LineString"===i.getJSONType()&&!w){if(Array.isArray(e[0])){m=[];for(var U=0;U<e.length;U++)ze(m,Jh(e[U],Wc,!1,!!w))}else m=Jh(e,Wc,!1,!!w);return this._interpolateSegAlt(m,e,t)}return{points:m,altitude:t}},n._interpolateSegAlt=function(e,t,n){if(!Array.isArray(n)){var i=function(e){return e.point};return{points:e.map((function(e){return Array.isArray(e)?e.map(i):e.point})),altitude:n}}var s=$c(e,t,n);n=[];var o=s.map((function(e){if(Array.isArray(e)){var t=[],i=e.map((function(e){return t.push(e.altitude),e.point}));return n.push(t),i}return n.push(e.altitude),e.point}));return{points:o,altitude:n}},n.getSymbol=function(){return this.geometry._getInternalSymbol()},n._resetSymbolizersBBOX=function(){for(var e=this.symbolizers.length-1;e>=0;e--){ds(this.symbolizers[e].bbox)}return this},n.paint=function(e,t,n){if(this.symbolizers){var i=this.getLayer(),s=i._getRenderer();if(s&&(s.context||t)){var o=s.mapStateCache||{offset:void 0};if((this.geometry._isCheck||!e||e.intersects(this.get2DExtent(s.resources,Vc)))&&!this._aboveCamera()){if(this.containerOffset=n||o.offset,!this.containerOffset){var a=this.getMap();this.containerOffset=a._pointToContainerPoint(s.middleWest)._add(0,-a.height/2)}this._beforePaint();var l=t||s.context;l.isHitTesting||this._resetSymbolizersBBOX(),Jc[0]=l,Jc[1]=s.resources;for(var h=this.symbolizers.length-1;h>=0;h--)(l.shadowBlur||this.symbolizers[h].symbol.shadowBlur)&&this._prepareShadow(l,this.symbolizers[h].symbol),this.symbolizers[h].symbolize(...Jc);this._afterPaint(),this._painted=!0,(this.geometry.options.debug||i.options.debug)&&this._debugSymbolizer.symbolize(l)}}}},n.getSprite=function(e,t){if(!this.geometry.isPoint)return null;if(this._spriting=!0,!this._sprite&&this.symbolizers.length>0){var n=new Pl;this.symbolizers.forEach((function(t){var i=t.getFixedExtent(e);n._combine(i)}));var i,s=n.getMin().multi(-1),o=t||(this.getMap()?this.getMap().CanvasClass:null),a=Ea.createCanvas(n.getWidth(),n.getHeight(),o);this._renderPoints&&(i=this._renderPoints);for(var l=a.getContext("2d"),h=[l,e],c=this.symbolizers.length-1;c>=0;c--){var u=this.symbolizers[c].getDxDy();this._renderPoints={center:[[s.add(u)]]},this._prepareShadow(l,this.symbolizers[c].symbol),this.symbolizers[c].symbolize(...h)}i&&(this._renderPoints=i),this._sprite={canvas:a,offset:n.getCenter()}}return this._spriting=!1,this._sprite},n.isSpriting=function(){return!!this._spriting},n.hitTest=function(e,t){if((!t||t<.5)&&(t=.5),this._hitPoint=e.sub(t,t),!kc){var n=this.getMap()?this.getMap().CanvasClass:null;kc=Ea.createCanvas(1,1,n)}Ea.setHitTesting(!0),kc.width=kc.height=2*t;var i=Ea.getCanvas2DContext(kc);i.isHitTesting=!0;try{this.paint(null,i,this._hitPoint)}finally{Ea.setHitTesting(!1)}delete this._hitPoint;try{for(var s=i.getImageData(0,0,kc.width,kc.height).data,o=3,a=s.length;o<a;o+=4)if(s[o]>0)return!0}catch(e){console.error(e)}return!1},n.isHitTesting=function(){return!!this._hitPoint},n._prepareShadow=function(e,t){t.shadowBlur?(e.shadowBlur=this.isHitTesting()?0:t.shadowBlur,e.shadowColor=t.shadowColor||"#000",e.shadowOffsetX=t.shadowOffsetX||0,e.shadowOffsetY=t.shadowOffsetY||0):e.shadowBlur&&(e.shadowBlur=null,e.shadowColor=null,e.shadowOffsetX=null,e.shadowOffsetY=null)},n._eachSymbolizer=function(e,t){if(this.symbolizers){t||(t=this);for(var n=this.symbolizers.length-1;n>=0;n--)e.apply(t,[this.symbolizers[n]])}},n.get2DExtent=function(e,t){this._verifyProjection();var n=this.getMap();e=e||this.getLayer()._getRenderer().resources;var i=n.getZoom(),s=this._isDynamicSize();if(this._extent2D&&this._extent2D._zoom===i&&this._fixedExtent||(this._extent2D&&this._extent2D._zoom!==i&&delete this._extent2D,this.symbolizers&&(this._extent2D||(this._extent2D=this._computeExtent2D(new Pl),this._extent2D._zoom=i),this._fixedExtent||(this._fixedExtent=this._computeFixedExtent(e,new Pl)))),!this._extent2D)return s&&delete this._fixedExtent,null;var{xmin:o,ymin:a,xmax:l,ymax:h}=this._fixedExtent;return s&&delete this._fixedExtent,jc.set(o,-h,l,-a),t?(t.set(this._extent2D.xmin,this._extent2D.ymin,this._extent2D.xmax,this._extent2D.ymax),t._add(jc),t):this._extent2D.add(jc)},n._computeExtent2D=function(e){for(var t=this.symbolizers.length-1;t>=0;t--){e._combine(this.symbolizers[t].get2DExtent())}return e},n._computeFixedExtent=function(e,t){for(var n=this.symbolizers.length-1;n>=0;n--){var i=this.symbolizers[n];i.getFixedExtent&&t._combine(i.getFixedExtent(e))}return t},n._isDynamicSize=function(){for(var e=this.symbolizers.length-1;e>=0;e--){if(this.symbolizers[e].isDynamicSize())return!0}return!1},n._aboveCamera=function(){var e=this.getMinAltitude(),t=this.getMap(),n=t.getGLRes();e=t.altitudeToPoint(e,n)*We(e);var i=t.getFrustumAltitude();return e&&i&&i<e},n.getFixedExtent=function(){var e=this.getMap().getZoom();return this._isDynamicSize()?this._computeFixedExtent(null,new Pl):(this._extent2D&&this._extent2D._zoom===e||this.get2DExtent(null,jc),this._fixedExtent)},n.setZIndex=function(e){this._eachSymbolizer((function(t){t.setZIndex(e)}))},n.show=function(){this._painted?(this.removeCache(),this._eachSymbolizer((function(e){e.show()}))):this.getLayer().isCanvasRender()||this.paint()},n.hide=function(){this._eachSymbolizer((function(e){e.hide()}))},n.repaint=function(){this._altAtGL=this._getGeometryAltitude(),this.removeCache();var e=this.getLayer();if(e){var t=e.getRenderer();t&&t.setToRedraw()&&t.setToRedraw()}},n.refreshSymbol=function(){this.removeCache(),this._removeSymbolizers(),this.symbolizers=this._createSymbolizers()},n.remove=function(){this.removeCache(),this._removeSymbolizers()},n._removeSymbolizers=function(){this._eachSymbolizer((function(e){delete e.painter,e.remove()})),delete this.symbolizers},n.removeCache=function(){delete this._renderPoints,delete this._paintParams,delete this._sprite,delete this._extent2D,delete this._fixedExtent,delete this._cachedParams,delete this._unsimpledParams},n.getAltitude=function(){return this.geometry._getAltitude()!==this._propAlt&&(this._altAtGL=this._getGeometryAltitude()),this._altAtGL?this._altAtGL:0},n.getMinAltitude=function(){return this.minAltitude?this.minAltitude:0},n.getMaxAltitude=function(){return this.maxAltitude?this.maxAltitude:0},n._getGeometryAltitude=function(){if(!this.getMap())return 0;var e=this.geometry._getAltitude();this._propAlt=e;var[t,n]=nc(e);return this.minAltitude=t,this.maxAltitude=n,e&&this.geometry.getCenter()?e:0},n._verifyProjection=function(){var e=this.geometry._getProjection()||Xc;this._projCode&&this._projCode!==e.code&&this.removeCache(),this._projCode=e.code},n._beforePaint=function(){},n._afterPaint=function(){},n.getPathTempRenderPoints=function(){for(var e=0,t=(this.symbolizers||[]).length;e<t;e++){var n=this.symbolizers[e];if(n instanceof Pc&&n._tempRenderPoints)return n._tempRenderPoints}},t}(Ua);function $c(e,t,n){if(!Array.isArray(n))return e;for(var i=[],s=0,o=e.length;s<o;s++)if(Array.isArray(e[s]))i.push($c(e[s],t,n));else{var a=e[s];if(a.point.equals(t[a.index]))a.altitude=n[a.index],i.push(a);else{var l=void 0,h=void 0;0===a.index?(l=a.index,h=a.index+1):(l=a.index-1,h=a.index);var c=a.point.distanceTo(t[h]),u=c/(c+t[l].distanceTo(a.point)),f=qe(n[l],n[h],1-u);a.altitude=f,i.push(a)}}return i}var Kc=new Pl,eu=function(e){function t(t,n){var i;return(i=e.call(this)||this).geometry=t,i.isMask=n,i.bbox=hs(),i._drawTime=0,i}Te(t,e);var n=t.prototype;return n._setDrawTime=function(e){return this._drawTime=e,this._eachPainter((function(t){t._setDrawTime(e)})),this},n.getRenderBBOX=function(){var e=this,t=this.getLayer();if(t&&t._drawTime!==this._drawTime)return null;ds(this.bbox);var n=!1;return this._eachPainter((function(t){var i=t.getRenderBBOX();ys(i)?As(e.bbox,i):n=!0})),n?null:ys(this.bbox)?this.bbox:null},n._eachPainter=function(e){for(var t,n=this.geometry.getGeometries(),i=0,s=n.length;i<s&&(!(t=this.isMask?n[i]._getMaskPainter():n[i]._getPainter())||!t||!1!==e.call(this,t));i++);},n.getLayer=function(){return this.geometry&&this.geometry.getLayer()},n.paint=function(e){this.geometry&&this._eachPainter((function(t){t.paint(e)}))},n.get2DExtent=function(e,t){t&&t.set(null,null,null,null);var n=t||new Pl;return this._eachPainter((function(t){n=n._combine(t.get2DExtent(e,Kc))})),n},n.remove=function(){this._eachPainter((function(e){e.remove()}))},n.setZIndex=function(e){this._eachPainter((function(t){t.setZIndex(e)}))},n.show=function(){this._eachPainter((function(e){e.show()}))},n.hide=function(){this._eachPainter((function(e){e.hide()}))},n.repaint=function(){this._eachPainter((function(e){e.repaint()}))},n.refreshSymbol=function(){this._eachPainter((function(e){e.refreshSymbol()}))},n.hasPoint=function(){var e=!1;return this._eachPainter((function(t){return!t.hasPoint()||(e=!0,!1)})),e},n.getMinAltitude=function(){var e=!0,t=0;return this._eachPainter((function(n){var i=n.getMinAltitude();(e||i<t)&&(e=!1,t=i)})),t},n.getMaxAltitude=function(){var e=0;return this._eachPainter((function(t){var n=t.getMaxAltitude();n>e&&(e=n)})),e},t}(Ua);function tu(e,t=[]){return t.forEach((function(t){var[n,i]=t;e=e.replace(n,i)})),e}function nu(e){var{projection:t,isArcgis:n,isGeoServer:i,isSuperMap:s}=e,o=.0002645833333333333;return(n||i||s)&&(o=28e-5),t&&t.indexOf("4326")>-1&&(o=2.3767925226029154e-9,(n||s)&&(o=2.518101729011901e-9),i&&(o=2.51528279553466e-9)),o}var ru="wmts";function iu(e,t){var n=e.getElementsByTagName(t);return n&&n.length?n:e.getElementsByTagName(ru+":"+t)}function su(e,t){for(var n=0;n<e.length;n++){var i=e[n];if((i=i.getElementsByTagName("ows:Identifier")[0])&&i.textContent===t)return e[n]}return null}function ou(e,t={}){var n,i,s,o=iu(e,"TileMatrix"),a=[],l=[],h=[],c=!1;if(!n){var u=e.getElementsByTagName("ows:SupportedCRS")[0];u&&(n=function(e){for(var t="",n=e.split(""),i=n.length-1;i>=0&&!isNaN(n[i]);i--)t=n[i]+t;return t}(n=(n=u.textContent).split("EPSG")[1]),n=function(e){var t=e.indexOf("EPSG")>-1?e:"EPSG:"+e;return tu(t,[["4490","4326"],["102100","3857"],["900913","3857"]])}(n))}i||(i=e.getElementsByTagName("ows:Identifier")[0])&&(i=i.textContent),t.projection=n;for(var f=1/0,g=0;g<o.length;g++){var m=o[g],A=m.getElementsByTagName("ows:Identifier")[0].textContent;isNaN(parseInt(A))?(s=A.substr(0,A.lastIndexOf(":")),A=(A=A.split(":"))[A.length-1],A=parseInt(A),c=!0,t.isGeoServer=!0):A=parseInt(A),f=Math.min(f,A);var w=iu(m,"ScaleDenominator")[0].textContent,T=iu(m,"TopLeftCorner")[0].textContent,S=iu(m,"TileWidth")[0].textContent,M=iu(m,"TileHeight")[0].textContent;if(0===h.length&&h.push(parseInt(S),parseInt(M)),0===l.length){var[C,I]=T.split(" ").filter((function(e){return""!==e})).map((function(e){return parseFloat(e)}));C>0?l.push(1,-1,I,C):l.push(1,-1,C,I)}var E=nu(t),D=parseFloat(w)*E;a.push(D)}if(f>0)for(var H=a[0],N=f-1;N>=0;N--)a.splice(0,0,H*=2);return{resolutions:a,tileSize:h,tileSystem:l,projection:n,TileMatrixSet:i,isGeoServer:c,levelStr:s}}var au=function(e,t,n={jsonp:!0}){g(e)&&Jn.get(e,(function(i,s){if(i)t(i);else{var o=function(e,t,n){["isArcgis","isSuperMap","isGeoServer"].every((function(e){return null==n[e]}))&&console.warn("Please specify the server type, such as isArcgis, isSuperMap, isGeoServer, Otherwise, the system will determine by itself"),null==n.isArcgis&&(n.isArcgis=["arcgis","geoscene"].some((function(t){return e.indexOf(t)>-1}))),null==n.isSuperMap&&(n.isSuperMap=e.indexOf("supermap")>-1);var i=(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("Contents")[0];if(!i)return[];var s=iu(i,"Layer");if(!s.length)return[];for(var o=[],a=0,l=i.childNodes.length;a<l;a++)"TileMatrixSet"===i.childNodes[a].localName&&o.push(i.childNodes[a]);if(!o.length)return[];for(var h=[],c=0,u=s.length;c<u;c++){var f=s[c],g=f.querySelectorAll("Style")[0];g&&(g=g.getElementsByTagName("ows:Identifier")[0])&&(g=g.textContent);var m=f.getElementsByTagName("ows:Identifier")[0];m&&(m=m.textContent);var A=iu(f,"TileMatrixSetLink");if(0!==A.length)for(var w=0,T=A.length;w<T;w++){var S=A[w];(S=iu(S,"TileMatrixSet")[0])&&(S=S.textContent);var M=su(o,S);if(M){var C=f.querySelectorAll("ResourceURL")[0],I="";C&&(I=C.attributes.template.value);var{resolutions:E,tileSize:D,tileSystem:H,projection:N,TileMatrixSet:B,isGeoServer:z,levelStr:U}=ou(M,n);I.length||(I=t.substr(0,t.lastIndexOf("?")),I+="?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER={LAYER}&STYLE={Style}&TILEMATRIXSET={TileMatrixSet}&FORMAT={tiles}&TILEMATRIX={TileMatrix}&TILEROW={TileRow}&TILECOL={TileCol}");var j=tu(I,[["{LAYER}",m],["{Layer}",m],["{layer}",m],["{STYLE}",g],["{Style}",g],["{style}",g],["{TileMatrixSet}",B],["{TileMatrix}",z?U+":{z}":"{z}"],["{TileRow}","{y}"],["{TileCol}","{x}"],["{tiles}",z?"image/png":"tiles"]]);h.push({tileSize:D,tileSystem:H,spatialReference:{resolutions:E,projection:N},urlTemplate:j,info:{layerName:m,TileMatrixSet:B,style:g,tileSize:D,tileSystem:H,resolutions:E,projection:N,urlTemplate:j}})}}}return h}(s,e,n);t(null,o)}}),n)};function lu(e){for(var t=e.tileInfo,n=[t.cols,t.rows],i=[],s=t.lods,o=0,a=s.length;o<a;o++)i.push(s[o].resolution);var l=e.fullExtent,h=t.origin,c=[1,-1,h.x,h.y];return delete l.spatialReference,{spatialReference:{resolutions:i,fullExtent:l},tileSystem:c,tileSize:n}}var hu;function cu(){if(!hu){var e=Math.round(o.crsMaxNativeZoom||22);hu={"EPSG:3857":{projection:"EPSG:3857",resolutions:function(){for(var t=[],n=12756274*Math.PI,i=0;i<=e;i++)t[i]=n/(256*Math.pow(2,i));return t}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}},"EPSG:4326":{projection:"EPSG:4326",fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){for(var t=[],n=0;n<=e;n++)t[n]=180/(128*Math.pow(2,n));return t}()},BAIDU:{projection:"baidu",resolutions:function(){for(var t=Math.pow(2,18),n=[],i=0;i<=e;i++)n[i]=t,t*=.5;return n}(),fullExtent:{top:33554432,left:-33554432,bottom:-33554432,right:33554432}},IDENTITY:{projection:"identity",resolutions:function(){for(var t=Math.pow(2,8),n=[],i=0;i<=e;i++)n[i]=t,t*=.5;return n}(),fullExtent:{top:2e5,left:-2e5,bottom:-2e5,right:2e5}},"PRESET-VT-3857":{projection:"EPSG:3857",resolutions:function(){for(var t=[],n=6378137*Math.PI,i=0;i<=e;i++)t[i]=n/(256*Math.pow(2,i));return t}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}},"PRESET-VT-4326":{projection:"EPSG:4326",fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){for(var t=[],n=0;n<=e;n++)t[n]=45/(128*Math.pow(2,n));return t}()}},hu["EPSG:4490"]=hu["EPSG:4326"],hu["PRESET-3857-512"]=hu["PRESET-VT-3857"],hu["PRESET-4326-512"]=hu["PRESET-VT-4326"],hu["PRESET-4490-512"]=hu["PRESET-VT-4326"]}return hu}var uu=function(){function e(e={}){this.options=e,this._initSpatialRef()}e.registerPreset=function(e,t){e=e&&e.toUpperCase();var n=cu();n[e]&&console.warn("Spatial reference "+e+" already registered."),n[e]=t},e.getPreset=function(e){return cu()[e.toUpperCase()]},e.getAllPresets=function(){return Object.keys(cu())},e.loadArcgis=function(e,t,n){return function(e,t,n={jsonp:!0}){if(g(e)&&"{"!==e.substring(0,1))Jn.getJSON(e,(function(e,n){if(e)t(e);else{var i=lu(n);t(null,i)}}),n);else{g(e)&&(e=Be(e));var i=lu(e);t(null,i)}}(e,t,n),this},e.loadWMTS=function(e,t,n){return au(e,t,n),this},e.getProjectionInstance=function(e){var t;if(!e)return null;if((t=g(e)?{code:e}:e).project)return t.locate||(t=l({},t),l(t,jl.getInstance("identity"===t.measure?"IDENTITY":"EPSG:4326"))),t;var n=(t.code+"").toLowerCase();for(var i in bh)if(w(bh,i)){var s=bh[i].aliases||[],o=bh[i].code;o&&s.push(o);for(var a=0;a<s.length;a++)if(s[a].toLowerCase()===n){if(bh[i].create){var h=bh[i].create(e);return h.code=s[a],h}if(bh[i].code===s[a])return bh[i];var c=l({},bh[i]);return c.code=s[a],c}}return null},e.equals=function(e,t){if(g(e)||g(t))return e===t;if(!e&&!t)return!0;if(!e||!t)return!1;if(e.projection!==t.projection)return!1;var n=e.fullExtent,i=t.fullExtent;if(n&&!i||!n&&i)return!1;if(n&&i&&(n.top!==i.top||n.bottom!==i.bottom||n.left!==i.left||n.right!==i.right))return!1;var s=e.resolutions,o=t.resolutions;if(s&&o){if(s.length!==o.length)return!1;for(var a=0;a<s.length;a++)if(s[a]!==o[a])return!1}else if(s||o)return!1;return!0};var t=e.prototype;return t._initSpatialRef=function(){var t;if(!(t=this.options.projection?e.getProjectionInstance(this.options.projection):xh))throw new Error("must provide a valid projection in map's spatial reference.");(t=l({},Ol,t)).measureLength||l(t,Gl),this._projection=t;var n,i=cu(),s=this.options.resolutions;if(!s&&(t.code&&(n=i[t.code.toUpperCase()])&&(s=n.resolutions,this.isEPSG="IDENTITY"!==t.code),!s))throw new Error("must provide valid resolutions in map's spatial reference.");if(this._resolutions=s,this._pyramid=!0,this._pyramid)for(var o=0;o<s.length;o++)if(s[o]&&s[o-1]&&Math.round(s[o-1]/s[o]*1e4)/1e4!=2){this._pyramid=!1;break}var a=this.options.fullExtent;if(!a&&(t.code&&(n=i[t.code.toUpperCase()])&&(a=n.fullExtent),!a))throw new Error("must provide a valid fullExtent in map's spatial reference.");if(h(a.left)?(this._fullExtent=new Ml(a),a.left=a.xmin,a.right=a.xmax,a.top=a.ymax,a.bottom=a.ymin):this._fullExtent=new Ml(new fl(a.left,a.top),new fl(a.right,a.bottom)),h(a.top)||h(a.bottom)||h(a.left)||h(a.right))throw new Error("must provide valid top/bottom/left/right in fullExtent.");l(this._fullExtent,a),this._projection.fullExtent=a,this._transformation=new kl([a.right>=a.left?1:-1,a.top>=a.bottom?-1:1,0,0])},t.getResolutions=function(){return this._resolutions||[]},t.getResolution=function(e){var t=0|e;t<0?t=0:t>this._resolutions.length-1&&(t=this._resolutions.length-1);var n=this._resolutions[t];return t!==e&&e>0&&t<this._resolutions.length-1?n+(this._resolutions[t+1]-n)*(e-t):n},t.getProjection=function(){return this._projection},t.getFullExtent=function(){return this._fullExtent},t.getTransformation=function(){return this._transformation},t.getMinZoom=function(){for(var e=0;e<this._resolutions.length;e++)if(!h(this._resolutions[e]))return e;return 0},t.getMaxZoom=function(){for(var e=this._resolutions.length-1;e>=0;e--)if(!h(this._resolutions[e]))return e;return this._resolutions.length-1},t.getZoomDirection=function(){return We(this._resolutions[this.getMinZoom()]-this._resolutions[this.getMaxZoom()])},t.toJSON=function(){return this.json||(this.json={resolutions:this._resolutions,fullExtent:{top:this._fullExtent.top,left:this._fullExtent.left,bottom:this._fullExtent.bottom,right:this._fullExtent.right},projection:this._projection.code}),this.json},t.isPyramid=function(){return this._pyramid},e}();var fu=new Re(0,0),du=new Pl,pu={};var gu=function(e){function t(t){var n,i=l({},t),s=i.symbol,o=i.properties,a=i.id;return delete i.symbol,delete i.id,delete i.properties,n=e.call(this,i)||this,s?n.setSymbol(s):n._genSizeSymbol(),o&&n.setProperties(o),h(a)||n.setId(a),t&&c(t.rotateAngle)&&(n._dirtyRotate=!0),n}Te(t,e),t.fromJSON=function(e){return e};var n=t.prototype;return n.getFirstCoordinate=function(){if("GeometryCollection"===this.type){var e=this.getGeometries();return e.length?e[0].getFirstCoordinate():null}var t=this.getCoordinates();if(!Array.isArray(t))return t;do{t=t[0]}while(Array.isArray(t)&&t.length>0);return t},n.getLastCoordinate=function(){if("GeometryCollection"===this.type){var e=this.getGeometries();return e.length?e[e.length-1].getLastCoordinate():null}var t=this.getCoordinates();if(!Array.isArray(t))return t;do{t=t[t.length-1]}while(Array.isArray(t)&&t.length>0);return t},n.addTo=function(e,t){return e.addGeometry(this,t),this},n.getLayer=function(){return this._layer?this._layer:null},n.getMap=function(){return this._layer?this._layer.getMap():null},n.getId=function(){return this._id},n.setId=function(e){var t=this.getId();return this._id=e,this._fireEvent("idchange",{old:t,new:e}),this},n.getProperties=function(){return this.properties?this.properties:this._getParent()?this._getParent().getProperties():null},n.setProperties=function(e){var t=this.properties;return this.properties=f(e)?l({},e):e,(this.getGeometries?this.getGeometries():[]).forEach((function(t){var n=l(t.getProperties&&t.getProperties()||{},e||{});t.setProperties&&t.setProperties(n)})),this._clearAltitudeCache(),this._repaint(),this._fireEvent("propertieschange",{old:t,new:e}),this},n.getType=function(){return this.type},n.getSymbol=function(){var e=this._symbol;return e?Array.isArray(e)?wi(e):l({},e):null},n.setSymbol=function(e){return this._symbolUpdated=e,this._symbol=this._prepareSymbol(e),this.onSymbolChanged(),delete this._compiledSymbol,delete this._symbolHash,this},n.getSymbolHash=function(){return this._symbolHash||(this._symbolHash=xi(this._symbolUpdated)),this._symbolHash},n.updateSymbol=function(e){if(!e)return this;var t=this._getSymbol(),n=Array.isArray(e);if(t||(t=this._getInternalSymbol()||{}),!Array.isArray(t)&&n&&(e=e[0]||{}),Array.isArray(t)){if(!n)for(e=[e];e.length<t.length;)e.push({});for(var i=0;i<e.length;i++)Uh(e[i])&&delete this._textDesc,t[i]&&e[i]&&(t[i]=wi(t[i],e[i]))}else{if(Array.isArray(e))return console.error("Geometry's symbol is object but the update symbol is array."),console.error("Geometry's symbol and update symbol:",t,e),this;Uh(t)&&delete this._textDesc,t=wi(t||this._getInternalSymbol(),e)}return this._eventSymbolProperties=e,delete this._compiledSymbol,this.setSymbol(t)},n.getTextContent=function(){var e=this._getInternalSymbol();if(Array.isArray(e)){for(var t=[],n=!1,i=0;i<e.length;i++)t[i]=Zt(e[i]&&e[i].textName,this.getProperties()),h(t[i])||(n=!0);return n?t:null}return Zt(e&&e.textName,this.getProperties())},n.getTextDesc=function(){if(!this._textDesc){var e=this.getTextContent(),t=this._sizeSymbol,n=Array.isArray(e);this._textDesc=Array.isArray(t)?t.map((function(t,i){return Xt(n?e[i]:"",t)})):Xt(e,t)}return this._textDesc},n.getCenter=function(){return this._computeCenter(this._getMeasurer())},n.getExtent=function(){var e=this._getPrjExtent(),t=this._getProjection();if(e&&t){var n=t.unproject(new fl(e.xmin,e.ymin)),i=t.unproject(new fl(e.xmax,e.ymax));return new Ml(n,i,t)}return this._computeExtent(this._getMeasurer())},n.getContainerExtent=function(e){var t=this.get2DExtent();if(!t||!t.isValid())return null;var n=this.getMap(),i=n.getGLRes(),s=this.getMinAltitude(),o=t.convertTo((function(e){return n._pointAtResToContainerPoint(e,i,s,fu)}),e),a=this.getMaxAltitude();if(a!==s){var l=t.convertTo((function(e){return n._pointAtResToContainerPoint(e,i,a,fu)}),du);o._combine(l)}var h=this.getLayer();if(h&&"LineString"===this.type&&a&&h.options.drawAltitude){var c=t.convertTo((function(e){return n._pointAtResToContainerPoint(e,i,0,fu)}),du);o._combine(c)}if(o){var u=this._getFixedExtent();(function(e){if(!e)return!1;var{xmin:t,ymin:n,xmax:i,ymax:s}=e;return i-t>0&&s-n>0})(u)&&o._add(u)}return this.options.smoothness&&o._expand(.15*o.getWidth()),o},n._getFixedExtent=function(){this._fixedExtent||(this._fixedExtent=new Pl);var e=this._sizeSymbol,t=(e&&e.lineWidth||1)/2;return this._fixedExtent.set(-(t+=e&&e.lineStrokeWidth||0),-t,t,t),this._fixedExtent._add([e&&e.lineDx||0,0]),this._fixedExtent._add([0,e&&e.lineDy||0]),this._fixedExtent},n.get2DExtent=function(){var e=this.getMap();if(!e)return null;if(this._extent2d)return this._extent2d;var t=this._getPrjExtent();if(!t||!t.isValid())return null;var n=t.getMin(),i=t.getMax(),s=e.getGLRes();return e._prjToPointAtRes(n,s,n),e._prjToPointAtRes(i,s,i),this._extent2d=new Pl(n,i),this._extent2d.z=e.getZoom(),this._extent2d},n.getSize=function(){var e=this.getContainerExtent();return e?e.getSize():null},n.containsPoint=function(e,t){if(!this.getMap())throw new Error('The geometry is required to be added on a map to perform "containsPoint".');return e instanceof fl&&(e=this.getMap().coordToContainerPoint(e)),this._containsPoint(e,t)},n._containsPoint=function(e,t){var n=this._getPainter();return!!n&&(t=t||0,this._hitTestTolerance&&(t+=this._hitTestTolerance()),n.hitTest(e,t))},n.show=function(){if(this.options.visible=!0,this.getMap()){var e=this._getPainter();e&&e.show(),this._fireEvent("show")}return this},n.hide=function(){if(this.options.visible=!1,this.getMap()){this.onHide();var e=this._getPainter();e&&e.hide(),this._fireEvent("hide")}return this},n.isVisible=function(){if(!this.options.visible)return!1;var e=this._getInternalSymbol();if(!e)return!0;if(!this.symbolIsVisible())return!1;if(Array.isArray(e)){if(!e.length)return!0;for(var t=0,n=e.length;t<n;t++)if(h(e[t].opacity)||e[t].opacity>0)return!0;return!1}return h(e.opacity)||f(e.opacity)||c(e.opacity)&&e.opacity>0},n.symbolIsVisible=function(){var e=this._getCompiledSymbol();if(!e)return!0;Array.isArray(e)||(e=[e]);for(var t=0,n=e.length;t<n;t++){var i=e[t];if(i){var s=i.visible;if(!1!==s&&0!==s)return!0}}return!1},n.getZIndex=function(){return this.options.zIndex||0},n.setZIndex=function(e){var t=this.options.zIndex;return this.options.zIndex=e,this._fireEvent("zindexchange",{old:t,new:e}),this},n.setZIndexSilently=function(e){return this.options.zIndex=e,this},n.bringToFront=function(){var e=this.getLayer();if(!e||!e.getGeoMaxZIndex)return this;var t=e.getGeoMaxZIndex();return this.setZIndex(t+1),this},n.bringToBack=function(){var e=this.getLayer();if(!e||!e.getGeoMinZIndex)return this;var t=e.getGeoMinZIndex();return this.setZIndex(t-1),this},n.translate=function(e,t,n){if(h(e))return this;var i=new fl(e,t,n);if(0===i.x&&0===i.y&&(h(i.z)||0===i.z))return this;var s=this.getCoordinates();if(this._silence=!0,s)if(Array.isArray(s)){var o=Ve(s,(function(e){return e.add(i)}));this.setCoordinates(o)}else this.setCoordinates(s.add(i));return this._silence=!1,this._fireEvent("positionchange"),this},n._translateRotatePivot=function(e){if(!this._pivot||!e)return this;if(this.options.rotatePivot){var t=this.getCoordinates();if(!t)return this;e instanceof fl||(e=new fl(e));var n=e.sub(t);if(0===n.x&&0===n.y)return this;this._pivot._add(n),this.options.rotatePivot=this._pivot.toArray()}return this},n.flash=function(e,t,n,i){return ut.call(this,e,t,n,i)},n.copy=function(){var e=this.toJSON(),n=t.fromJSON(e);return n.options.visible=!0,n},n.remove=function(){return this.getLayer()?(this._fireEvent("removestart"),this._unbind(),this._fireEvent("removeend"),this._fireEvent("remove"),this):this},n.toGeoJSONGeometry=function(){return this._exportGeoJSONGeometry()},n.toGeoJSON=function(e){e||(e={});var t={type:"Feature",geometry:null};if(h(e.geometry)||e.geometry){var n=this._exportGeoJSONGeometry();t.geometry=n}var i,s=this.getId();return h(s)||(t.id=s),(h(e.properties)||e.properties)&&(i=this._exportProperties()),t.properties=i,t},n.toJSON=function(e){e||(e={});var t=this._toJSON(e);return l(t,this._exportGraphicOptions(e)),t},n.getLength=function(){return this._computeGeodesicLength(this._getMeasurer())},n.getArea=function(){return this._computeGeodesicArea(this._getMeasurer())},n.rotate=function(e,t){if(!c(e))return console.error("angle:"+e+" is not number"),this;if(this._painter||(this._dirtyRotate=!0),"GeometryCollection"===this.type)return this.getGeometries().forEach((function(n){return n.rotate(e,t)})),this;t=t?new fl(t):this.getCenter(),this._angle=e,this._pivot=t;var n=this._getMeasurer(),i=this.getCoordinates();if(!Array.isArray(i)){if(t.x===i.x&&t.y===i.y||this.getShell)this.onPositionChanged();else{var s=n._rotate(i,t,e);this.setCoordinates(s)}return this.getShell&&(this.options.rotateAngle=e,this.options.rotatePivot=t.toArray()),this}return Ve(i,(function(i){return n._rotate(i,t,e)})),this.setCoordinates(i),this},n._rotatePrjCoordinates=function(e){if(!e||0===this._angle||!this._pivot)return e;var t=this._getProjection();if(!t)return e;var n,i,s=0,o=Array.isArray(e),a=o?e:[e],l=[];if(this.getRotateOffsetAngle){s=this.getRotateOffsetAngle();var h=a[a.length-1];n=h.x,i=h.y}else{var c=hs();ps(a,c);var[u,f,g,m]=c;n=(u+g)/2,i=(f+m)/2}for(var A=0,w=a.length;A<w;A++){var T=a[A],{x:S,y:M}=T,C=S-n,I=M-i,E=Math.sqrt(C*C+I*I),D=(xu(n,i,S,M)-this._angle+s)/180*Math.PI,H=Math.cos(D)*E,N=Math.sin(D)*E,B=new fl(n+H,i+N);l.push(B)}for(var z=t.project(this._pivot),U=n-z.x,j=i-z.y,W=0,q=l.length;W<q;W++){var Z=l[W];Z.x-=U,Z.y-=j}return o?l:l[0]},n.isRotated=function(){return!(!c(this._angle)||!this._pivot)},n._getConnectPoints=function(){return[this.getCenter()]},n._initOptions=function(e){var t=l({},e),n=t.symbol,i=t.properties,s=t.id;delete t.symbol,delete t.id,delete t.properties,this._setOptions(t),n&&this.setSymbol(n),i&&this.setProperties(i),h(s)||this.setId(s)},n._bindLayer=function(e){if(e!==this.getLayer()){if(this.getLayer())throw new Error("Geometry cannot be added to two or more layers at the same time.");this._layer=e,this._clearCache(),this._bindInfoWindow(),this._bindMenu()}},n._prepareSymbol=function(e){if(Array.isArray(e)){for(var t=[],n=0;n<e.length;n++)t.push(mi(this._checkAndCopySymbol(e[n])));return t}return e?mi(e=this._checkAndCopySymbol(e)):null},n._checkAndCopySymbol=function(e){var t={};for(var n in e)t[n]=Mt[n]&&g(e[n])?+e[n]:e[n];return t},n._getSymbol=function(){return this._symbol},n._setExternSymbol=function(e){return this._eventSymbolProperties=e,this._symbol||delete this._textDesc,this._externSymbol=this._prepareSymbol(e),this.onSymbolChanged(),this},n._getInternalSymbol=function(){return this._symbol?this._symbol:this._externSymbol?this._externSymbol:this.options.symbol?this.options.symbol:null},n._getPrjExtent=function(){var e=this._getProjection();return this._verifyProjection(),!this._extent&&e&&(this._extent=this._computePrjExtent(e)),this._extent},n._unbind=function(){var e=this.getLayer();e&&(this._animPlayer&&this._animPlayer.finish(),this._unbindMenu(),this._unbindInfoWindow(),this.isEditing()&&this.endEdit(),this._removePainter(),this.onRemove&&this.onRemove(),e.onRemoveGeometry&&e.onRemoveGeometry(this),delete this._layer,delete this._internalId,delete this._extent)},n._getInternalId=function(){return this._internalId},n._setInternalId=function(e){this._internalId=e},n._getMeasurer=function(){return this._getProjection()?this._getProjection():uu.getProjectionInstance(this.options.defaultProjection)},n._getProjection=function(){var e=this.getMap();return e?e.getProjection():null},n._verifyProjection=function(){var e=this._getProjection();this._projCode&&e&&this._projCode!==e.code&&this._clearProjection(),this._projCode=e?e.code:this._projCode},n._getExternalResources=function(){return di(this._getInternalSymbol())},n._getPainter=function(){if(this._painter)return this._painter;var e=this.getLayer();if(e)if(-1!==xt.indexOf(this.type)){if(e.constructor.getCollectionPainterClass){var t=e.constructor.getCollectionPainterClass();t&&(this._painter=new t(this))}}else if(e.constructor.getPainterClass){var n=e.constructor.getPainterClass();n&&(this._painter=new n(this))}return this._painter},n._getMaskPainter=function(){return this._maskPainter||(this._maskPainter=this.getGeometries&&this.getGeometries()?new eu(this,!0):new Qc(this)),this._maskPainter},n._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter},n._paint=function(e){if(this.symbolIsVisible()&&this._painter){if(this._dirtyCoords){delete this._dirtyCoords;var t=this._getProjection();t&&(this._pcenter=t.project(this._coordinates),this._clearCache())}this._dirtyRotate&&c(this.options.rotateAngle)&&this.rotate(this.options.rotateAngle,this.options.rotatePivot),this._dirtyRotate=!1,this._painter.paint(e)}},n._clearCache=function(){delete this._extent,delete this._extent2d,this._clearAltitudeCache()},n._clearProjection=function(){delete this._extent,delete this._extent2d},n._repaint=function(){this._painter&&this._painter.repaint()},n.onHide=function(){this.closeMenu(),this.closeInfoWindow()},n.onShapeChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("shapechange")},n.onPositionChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("positionchange")},n.onSymbolChanged=function(){this._painter&&this._painter.refreshSymbol();var e={};this._eventSymbolProperties?(e.properties=JSON.parse(JSON.stringify(this._eventSymbolProperties)),delete this._eventSymbolProperties):delete this._textDesc,this._genSizeSymbol(),this._fireEvent("symbolchange",e)},n._genSizeSymbol=function(){var e=this._getInternalSymbol();if(e)if(Array.isArray(e)){this._sizeSymbol=[];for(var t=!1,n=0;n<e.length;n++){var i=this._sizeSymbol[n]=this._getSizeSymbol(e[n]);!t&&i&&i._dynamic&&(t=!0)}this._sizeSymbol._dynamic=t}else this._sizeSymbol=this._getSizeSymbol(e);else delete this._sizeSymbol},n._getSizeSymbol=function(e){var t=li({lineWidth:e.lineWidth,lineDx:e.lineDx,lineDy:e.lineDy},this);return(Rr(e.lineWidth)||Rr(e.lineDx)||Rr(e.lineDy))&&(t._dynamic=!0),t},n._getCompiledSymbol=function(){return this._compiledSymbol||(this._compiledSymbol=li(this._getInternalSymbol(),this)),this._compiledSymbol},n.onConfig=function(e){var t;e.properties&&(t=e.properties,delete e.properties);var n=!1;for(var i in e)if(e.hasOwnProperty(i)){var s=i.slice(0,5);if("arrow"===s||"smoot"===s){n=!0;break}}t?(this.setProperties(t),this._repaint()):n&&this._repaint()},n._setParent=function(e){e&&(this._parent=e)},n._getParent=function(){return this._parent},n._fireEvent=function(e,t){this._silence||(this.getLayer()&&this.getLayer()._onGeometryEvent&&(t||(t={}),t.type=e,t.target=this,this.getLayer()._onGeometryEvent(t)),this.fire(e,t))},n._toJSON=function(e){return{feature:this.toGeoJSON(e)}},n._recordVisible=function(){var e=this.options.visible;h(e)&&(e=!0),this._savedVisible=e},n._recoveryVisible=function(){delete this._savedVisible},n._exportGraphicOptions=function(e){var t={};return(h(e.options)||e.options)&&(t.options=this.config()),t.options&&this.isEditing&&this.isEditing()&&(t.options.visible=this._savedVisible),(h(e.symbol)||e.symbol)&&(t.symbol=this.getSymbol()),(h(e.infoWindow)||e.infoWindow)&&this._infoWinOptions&&(t.infoWindow=this._infoWinOptions),t},n._exportGeoJSONGeometry=function(){var e=this.getCoordinates(),t=fl.toNumberArrays(e);return{type:this.getType(),coordinates:t}},n._exportProperties=function(){var e=null,t=this.getProperties();return h(t)||(e=f(t)?l({},t):t),e},n._hitTestTolerance=function(){return 0},n._getAltitude=function(){var e=this.getLayer();if(!e)return 0;var t=e.options,n=e.getAltitude?e.getAltitude():0,i=t.enableAltitude;if(!i&&e.isVectorLayer)return n;var s=mu(e),o=(this.properties||pu)[s];if(h(o)){var a=Au(this,n,i);return h(a)?n:a}return Array.isArray(o)?o.map((function(e){return e+n})):o+n},n.getAltitude=function(){var e=mu(this.getLayer()),t=(this.properties||pu)[e];if(!h(t))return t;var n=Au(this,0,!1);return h(n)?0:n},n.hasAltitude=function(){return this._genMinMaxAlt(),!!this._minAlt||!!this._maxAlt},n.setAltitude=function(e){if(!c(e))return this;var t=this.getLayer(),n=mu(t),i=this.properties||pu,s=i[n];if(!h(s))if(Array.isArray(s))for(var o=0,a=s.length;o<a;o++)s[o]=e;else i[n]=e;var l=this.getCoordinates?this.getCoordinates():null;if(!l)return this;if(yu(l,e),t){var u=t.getRenderer();u&&(u.gl||u.device)?this.setCoordinates(l):u&&this._repaint()}return this._clearAltitudeCache(),this.onPositionChanged(),this},n._genMinMaxAlt=function(){if(void 0===this._minAlt||void 0===this._maxAlt){var e=this._getAltitude(),[t,n]=nc(e);this._minAlt=t,this._maxAlt=n}},n.getMinAltitude=function(){return this._genMinMaxAlt(),this._minAlt},n.getMaxAltitude=function(){return this._genMinMaxAlt(),this._maxAlt},n._clearAltitudeCache=function(){return this._minAlt=void 0,this._maxAlt=void 0,this},n._getEditCenter=function(){var e=this.getCenter().copy();e.z=0;var t=this.getAltitude();if(c(t))return e.z=t,e;var n=0,i=0,s=function(e){for(var t=0,o=e.length;t<o;t++)Array.isArray(e[t])?s(e[t]):(i++,n+=e[t])};return Array.isArray(t)&&(s(t),e.z=n/i),e},t}(ol(Ba(al(Ua))));function mu(e){var t="altitude";if(e){if(!e.isVectorLayer)return null;t=e.options.altitudeProperty}return t}function Au(e,t,n){var i=e.getCoordinates?e.getCoordinates():null;if(i){var s=[];if(_u(i,s),s.length)return vu(i,t,n)}return null}function yu(e,t){if(Array.isArray(e))for(var n=0,i=e.length;n<i;n++)yu(e[n],t);else e.z=t}function _u(e,t){if(!t.length)if(Array.isArray(e))for(var n=0,i=e.length;n<i;n++)_u(e[n],t);else c(e.z)&&t.push(e.z)}function vu(e,t,n){if(Array.isArray(e)){for(var i=[],s=0,o=e.length;s<o;s++)i.push(vu(e[s],t,n));return i}return c(e.z)?n?t+e.z:e.z:n?t:0}function xu(e,t,n,i){return e===n?i>t?-90:90:(n-=e,i=-(i-=t),Math.atan2(i,n)/Math.PI*180)}gu.mergeOptions({id:null,visible:!0,interactive:!0,editable:!0,cursor:null,antiMeridian:!1,defaultProjection:"EPSG:4326"});var bu="check_browser_max_fps";co(bu,(function(){return"function (exports) {\n    exports.initialize = function () {};\n    function now(){\n        return new Date().getTime();\n    }\n    function checkFPS(cb) {\n        if (typeof(requestAnimationFrame) === 'undefined') {\n            cb(-1);\n            return;\n        }\n        const count = 100;\n        let idx = 0;\n        let id;\n        let startTime;\n        function loop() {\n            idx++;\n            if (idx === count) {\n                cancelAnimationFrame(id);\n                const endTime = now();\n                const timePerFPS = (endTime - startTime) / count;\n                const fps = Math.floor(1000 / timePerFPS);\n                cb(fps);\n            } else {\n                id = requestAnimationFrame(loop);\n            }\n        }\n        startTime = now();\n        id = requestAnimationFrame(loop);\n    }\n    //recive message\n    exports.onmessage = function (msg, postResponse) {\n        checkFPS((fps) => {\n            if (fps <= -1) {\n                postResponse('check fps fail');\n            } else {\n                postResponse(null, { fps });\n            }\n        })\n    }\n}"}));var wu,Tu=0,Su=[],Mu=function(){function e(e){var t=this;Ro(),this._delayMessages=[],this.initializing=!1;var n=ao(e);ro&&!n&&(this.initializing=!0,console.log("Injecting codes in worker with worker key: :"+e),Ao(e,(function(){t.initializing=!1,t.created()}))),this.workerKey=e,this.workerPool=wo(),this.currentActor=0,this.actorId=He(),this.workers=this.workerPool.acquire(this.actorId),this.callbacks={},this.callbackID=0,this.receiveFn=this.receive.bind(this),this.workers.forEach((function(e){e.addEventListener("message",t.receiveFn,!1)})),lo(e)}var t=e.prototype;return t.created=function(){var e=this;this._delayMessages.forEach((function(t){var{command:n,data:i,buffers:s,cb:o,workerId:a}=t;e[n](i,s,o,a)})),this._delayMessages=[]},t.isActive=function(){return!!this.workers},t.broadcast=function(e,t,n){var i=this;return this.initializing?(this._delayMessages.push({command:"broadcast",data:e,buffers:t,cb:n}),this):(function(e,t,n){e.length||n(null,[]);var i=e.length,s=new Array(e.length),o=null;e.forEach((function(e,a){t(e,(function(e,t){e&&(o=e),s[a]=t,0==--i&&n(o,s)}))}))}(this.workers,(function(n,s){i.send(e,t,s,n.id)}),n=n||function(){}),this)},t.send=function(e,t,n,i){if(this.initializing)return this._delayMessages.push({command:"send",data:e,buffers:t,cb:n,workerId:i}),this;var s=n?this.actorId+":"+this.callbackID++:null;return n&&(this.callbacks[s]=n),this.post({data:e,callback:String(s)},t,i),this},t.receive=function(e){var t=this,n=e.data,i=n.callback,s=this.callbacks[i];delete this.callbacks[i],"<request>"===n.type?this.actorId===n.actorId&&this[n.command](n.params,(function(e,i,s){var o={type:"<response>",callback:n.callback};e?o.error=e.message:o.data=i,t.post(o,s||Su,n.workerId)})):s&&n.error?s(n.error):s&&s(null,n.data)},t.remove=function(){var e=this;this.workers.forEach((function(t){t.removeEventListener("message",e.receiveFn,!1)})),delete this.receiveFn,delete this.workers,delete this.callbacks,delete this.workerPool},t.post=function(e,t,n){return("number"!=typeof n||isNaN(n))&&(n=this.currentActor=(this.currentActor+1)%this.workerPool.workerCount),e.workerId=n,e.workerKey=this.workerKey,e.actorId=this.actorId,this.workerPool.addMessage(n,e,t||Su),n},t.getDedicatedWorker=function(){return Tu=(Tu+1)%this.workerPool.workerCount},e}();var Cu=function(e){function t(){return e.call(this,bu)||this}return Te(t,e),t}(Mu),Pu=!1;var Iu=!1;Lo((function(){var e;Iu||o.maxFPS<=0&&(Iu=!0,e=function(e){c(e)&&e>0&&o.maxFPS<=0&&(o.maxFPS=e),Iu=!1},wu||(wu=new Cu),wu.send({},[],(function(t,n){t?(Pu||(console.error(t),Pu=!0),e()):e(n.fps)})))}));var ku=[],Ou=function(e){function t(){return e.call(this,no)||this}return Te(t,e),t.prototype.fetchImage=function(e,t){this.send({url:e},ku,t)},t}(Mu),Eu=function(e){function t(t){var n;return(n=e.call(this)||this).layer=t,n._painted=!1,n._drawTime=0,!ye.decodeImageInWorker||ye.safari||ye.iosWeixin||(n._resWorkerConn=new Ou),n.setToRedraw(),n}Te(t,e);var i=t.prototype;return i.render=function(e){this.prepareRender(),this.getMap()&&this.layer.isVisible()&&(this.resources||(this.resources=Ps()),this.checkAndDraw(this._tryToDraw,e),this._frameTime=e)},i.getFrameTimestamp=function(){return this._frameTime||0},i.checkAndDraw=function(e,...t){var n=this;if(this._toRedraw=!1,this.checkResources){var i=this.checkResources();i.length>0?(this._loadingResource=!0,this.loadResources(i).then((function(){if(n._loadingResource=!1,n.layer){n.layer.fire("resourceload");var e=n.layer.getMap();n.setToRedraw(),e.getRenderer().callInNextFrame((function(){n.setToRedraw()}))}}))):e.call(this,...t)}else e.call(this,...t)},i.testIfNeedRedraw=function(){var e=this.getMap();return!this._loadingResource&&(!!this._toRedraw||!(e.isInteracting()&&!this.drawOnInteracting)&&!!this.needToRedraw())},i.needToRedraw=function(){var e=this.getMap();return!(!e.isInteracting()&&!e.getRenderer().isViewChanged())},i.onSkipDrawOnInteracting=function(){},i.isLoadingResource=function(){return this._loadingResource},i.isRenderComplete=function(){return!!this._renderComplete},i.mustRenderOnInteracting=function(){return!this._painted},i.setToRedraw=function(){return this._toRedraw=!0,this},i.remove=function(){this.onRemove(),delete this._loadingResource,delete this.middleWest,delete this.canvas,delete this.context,delete this.canvasExtent2D,delete this._extent2D,this.resources&&this.resources.remove(),delete this.resources,this._resWorkerConn&&(this._resWorkerConn.remove(),delete this._resWorkerConn),delete this.layer},i.onRemove=function(){},i.onAdd=function(){},i.getMap=function(){return this.layer?this.layer.getMap():null},i.clear=function(){this.clearContext(),this.setToRedraw()},i.isBlank=function(){return!this._painted},i.show=function(){this.setToRedraw()},i.hide=function(){this.clear(),this.setToRedraw()},i.setZIndex=function(e){this.setToRedraw()},i.screenshotRenderResult=function(e,t,n,i){if(this.canvas){var s=Ea.getTempCanvas();s.width=n,s.height=i;var o=Ea.getCanvas2DContext(s);return o.clearRect(0,0,n,i),o.drawImage(this.canvas,e,t,n,i,0,0,n,i),o}console.warn("not find layer canvas for screenshotRenderResult,the layerId:",this.layer.getId())},i.hitDetect=function(e){if(!this.context||this.layer.isEmpty&&this.layer.isEmpty()||this.isBlank()||this._errorThrown||this.layer.isVisible&&!this.layer.isVisible())return!1;var t=this.getMap(),n=this.mapDPR||t.getDevicePixelRatio(),i=t.getSize();if(e.x<0||e.x>i.width*n||e.y<0||e.y>i.height*n)return!1;var s=Math.round(n*e.x),o=Math.round(n*e.y),a=this.getImageData&&this.getImageData();if(a)return a.data[o*a.width*4+4*s+3]>0;try{var l=this.screenshotRenderResult(s,o,2,2);if(l)if(l.getImageData(s,o,1,1).data[3]>0)return!0}catch(e){return this._errorThrown||(console&&console.warn("hit detect failed with tainted canvas, some geometries have external resources in another domain:\n",e),this._errorThrown=!0),!1}return!1},i.loadResources=function(e){this.resources||(this.resources=new Cs);var t=this.resources,n=[];if(Ye(e))for(var i={},s=e.length-1;s>=0;s--){var o=e[s];if(o&&o.length){var a=o.join("-");if(!yi(o[0])){if(i[a])continue;i[a]=1}t.isResourceLoaded(o,!0)||n.push(new Promise(this._promiseResource(o)))}}return Promise.all(n)},i.prepareRender=function(){delete this._renderComplete;var e=this.getMap();this._renderZoom=e.getZoom(),this.canvasExtent2D=this._extent2D=e.get2DExtent(),this.middleWest=e._containerPointToPoint(new Re(0,e.height/2))},i.prepareCanvas=function(){var e=this.layer.parent,{canvas:t,context:n}=e.getRenderer(),i=n instanceof CanvasRenderingContext2D;this.context?i&&(this.clearContext(),this.resizeCanvas()):(i?this.createContext():(this.canvas=t,this.context=n),this.initContext()),this.prepareContext(),delete this._maskExtent;var s=this.layer.getMask();if(!s)return this.layer.fire("renderstart",{context:this.context}),null;var o=this._maskExtent=s._getMaskPainter().get2DExtent();return o&&this._extent2D&&o.intersects(this._extent2D),this.layer.fire("renderstart",{context:this.context}),o},i.initContext=function(){},i.prepareContext=function(){},i.clearContext=function(){},i.createContext=function(){throw new Error("createContext not implemented")},i.getViewExtent=function(){return{extent:this._extent2D,maskExtent:this._maskExtent,zoom:this._renderZoom,middleWest:this.middleWest}},i.completeRender=function(){this.getMap()&&(this._renderComplete=!0,this.layer.fire("renderend",{context:this.context}),this.setCanvasUpdated())},i.getEvents=function(){return{_zoomstart:this.onZoomStart,_zooming:this.onZooming,_zoomend:this.onZoomEnd,_resize:this.onResize,_movestart:this.onMoveStart,_moving:this.onMoving,_moveend:this.onMoveEnd,_dragrotatestart:this.onDragRotateStart,_dragrotating:this.onDragRotating,_dragrotateend:this.onDragRotateEnd,_spatialreferencechange:this.onSpatialReferenceChange}},i.onZoomStart=function(e){},i.onZoomEnd=function(e){this.setToRedraw()},i.onZooming=function(e){},i.onMoveStart=function(e){},i.onMoving=function(e){},i.onMoveEnd=function(e){this.setToRedraw()},i.onResize=function(e){delete this._extent2D,this.setToRedraw()},i.onDragRotateStart=function(e){},i.onDragRotating=function(e){},i.onDragRotateEnd=function(e){this.setToRedraw()},i.onSpatialReferenceChange=function(e){},i.getDrawTime=function(){return this._drawTime},i._tryToDraw=function(e){this._toRedraw=!1,!this.canvas&&this.layer.isEmpty&&this.layer.isEmpty()?this._renderComplete=!0:this._drawAndRecord(e)},i._drawAndRecord=function(e){var t=this.getMap();if(t){var n=this._painted;this._painted=!0;var i=a();this.mapDPR=t.getDevicePixelRatio(),this.draw(e),i=a()-i,this._drawTime=n?i:i/2,n&&this.layer&&this.layer.options.logDrawTime&&console.log(this.layer.getId(),"frameTimeStamp:",e,"drawTime:",this._drawTime)}},i._promiseResource=function(e){var t=this,i=this.layer,s=this.resources,o=i.options.crossOrigin,a=i.options.renderer||"";return function(l){if(s.isResourceLoaded(e,!0))l(e);else{var c=or(e[0]);if(yi(c))createImageBitmap(c).then((function(n){t._cacheResource(e,n),l(e)})).catch((function(t){console.error(t),l(e)}));else if(!Le(e[0])&&t._resWorkerConn&&("canvas"!==i.options.renderer||i.options.decodeImageInWorker))t._resWorkerConn.fetchImage(c,(function(n,i){if(n)return n&&"undefined"!=typeof console&&console.warn(n),void l(e);gt(i,(function(n){t._cacheResource(e,n),l(e)}))}));else{var u=new Image;h(o)?"canvas"!==a&&(u.crossOrigin=""):u.crossOrigin=o,Le(e[0])&&!n&&(e[1]&&(e[1]*=2),e[2]&&(e[2]*=2)),u.onload=function(){t._cacheResource(e,u),l(e)},u.onabort=function(t){console&&console.warn("image loading aborted: "+e[0]),t&&console&&console.warn(t),l(e)},u.onerror=function(t){t&&"undefined"!=typeof console&&console.warn(t),s.markErrorResource(e),l(e)},De(u,[c])}}}},i._cacheResource=function(e,t){if(this.layer&&this.resources){var n=e[1],i=e[2];if(this.layer.options.cacheSvgOnCanvas&&1===Le(e[0])&&(ye.edge||ye.ie)){h(n)&&(n=t.width||this.layer.options.defaultIconSize[0]),h(i)&&(i=t.height||this.layer.options.defaultIconSize[1]);var s=Ea.createCanvas(n,i);Ea.image(s.getContext("2d"),t,0,0,n,i),t=s}this.resources.addResource(e,t)}},i.setCanvasUpdated=function(){return this._canvasUpdated=!0,this},i.isCanvasUpdated=function(){return!!this._canvasUpdated},i.getCanvasImage=function(){var e=this.getMap();if(this._canvasUpdated=!1,this._renderZoom!==e.getZoom()||!this.canvas||!this._extent2D)return null;if(this.isBlank())return null;if(this.layer.isEmpty&&this.layer.isEmpty())return null;var t=e._pointToContainerPoint(this.middleWest)._add(0,-e.height/2);return{image:this.canvas,layer:this.layer,point:t}},i.clearCanvas=function(){this.clearContext()},i.createCanvas=function(){if(!this.canvas){var e=this.getMap(),t=e.getSize(),n=e.getDevicePixelRatio(),i=Math.round(n*t.width),s=Math.round(n*t.height);if(this.layer._canvas){var o=this.layer._canvas;o.width=i,o.height=s,o.style&&(o.style.width=t.width+"px",o.style.height=t.height+"px"),this.canvas=this.layer._canvas}else this.canvas=Ea.createCanvas(i,s,e.CanvasClass);this.onCanvasCreate()}},i.onCanvasCreate=function(){},i.resizeCanvas=function(e){var t=this.canvas,n=this.getMap();if(t&&t!==n.canvas){var i=e||n.getSize(),s=n.getDevicePixelRatio(),{width:o,height:a,cssWidth:l,cssHeight:h}=yt(i,s);!this.layer._canvas||t.style.width===l&&t.style.height===h||(t.style.width=l,t.style.height=h),t.width===o&&t.height===a||(t.height=a,t.width=o,this.context&&(this.context.dpr=1),1!==s&&this.context&&this._canvasContextScale(this.context,s))}},i.clipCanvas=function(e){var t=this.layer.getMask();if(!t)return!1;if(!this.layer.options.maskClip)return!1;var n=this.middleWest,i=this.getMap();this.middleWest=i._containerPointToPoint(new Re(0,i.height/2));var s=e.globalAlpha;e.save();var o=this.mapDPR||i.getDevicePixelRatio();if(1!==o&&(e.save(),this._canvasContextScale(e,o)),t.getGeometries){e.isMultiClip=!0;var a=t.getGeometries()||[];e.beginPath(),a.forEach((function(t){t._getMaskPainter().paint(null,e)})),e.stroke(),e.isMultiClip=!1}else{e.isClip=!0,e.beginPath(),t._getMaskPainter().paint(null,e),e.isClip=!1}1!==o&&e.restore();try{e.clip("evenodd")}catch(e){console.error(e)}return this.middleWest=n,e.globalAlpha=s,!0},i._canvasContextScale=function(e,t){return e.scale?(e.scale(t,t),e.dpr=t,this):this},t}(Ua);ye.decodeImageInWorker&&co(no,(function(){return"\nfunction (exports) {\n    exports.onmessage = function (msg, postResponse) {\n        var url = msg.data.url;\n        var fetchOptions = msg.data.fetchOptions;\n        requestImageOffscreen(url, function (err, data) {\n            var buffers = [];\n            if (data && data.data) {\n                buffers.push(data.data);\n            }\n            postResponse(err, data, buffers);\n        }, fetchOptions);\n    };\n\n    function requestImageOffscreen(url, cb, fetchOptions) {\n        fetch(url, fetchOptions ? fetchOptions : {})\n            .then(response => response.arrayBuffer())\n            .then(arrayBuffer => {\n                const blob=new Blob([arrayBuffer]);\n                return createImageBitmap(blob);\n            })\n            .then(bitmap => {\n                cb(null, {data:bitmap});\n            }).catch(err => {\n                console.error('error when loading tile:', url);\n                console.error(err);\n                cb(err);\n            });\n    }\n}"}));var Ru={attribution:null,minZoom:null,maxZoom:null,visible:!0,opacity:1,globalCompositeOperation:null,renderer:"canvas",debugOutline:"#0f0",cssFilter:null,forceRenderOnMoving:!1,forceRenderOnZooming:!1,forceRenderOnRotating:!1,collision:!1,collisionScope:"layer",hitDetect:!ye.mobile,maskClip:!0},Lu=function(e){function t(t,n){var i,s;return n&&(s=n.canvas,delete n.canvas),(i=e.call(this,n)||this)._canvas=s,i.setId(t),n&&(i.setZIndex(n.zIndex),n.mask&&i.setMask(gu.fromJSON(n.mask))),i.proxyOptions(),i}Te(t,e);var n=t.prototype;return n.load=function(){if(!this.getMap())return this;if(this.onLoad()){this._initRenderer();var e=this.getZIndex();h(e)||this._renderer&&(this._renderer.setZIndex(e),this.isCanvasRender()||this._renderer.render()),this.onLoadEnd()}return this},n.getId=function(){return this._id},n.setId=function(e){var t=this._id;return h(e)||(e+=""),this._id=e,this.fire("idchange",{type:"idchange",target:this,old:t,new:e}),this},n.addTo=function(e){return e.addLayer(this),this},n.setZIndex=function(e){return this._zIndex=e,h(e)?delete this.options.zIndex:this.options.zIndex=e,this.map&&this.map._sortLayersByZIndex(),this._renderer&&this._renderer.setZIndex(e),this.fire("setzindex",{type:"setzindex",target:this,zIndex:e}),this},n.getZIndex=function(){return this._zIndex||0},n.getMinZoom=function(){var e=this.getMap(),t=this.options.minZoom;return e?Math.max(e.getMinZoom(),t||0):t},n.getMaxZoom=function(){var e=this.getMap(),t=this.options.maxZoom;return e?Math.min(e.getMaxZoom(),h(t)?1/0:t):t},n.getOpacity=function(){return this.options.opacity},n.setOpacity=function(e){return this.config("opacity",e),this.fire("setopacity",{type:"setopacity",target:this,opacity:e}),this},n.isCanvasRender=function(){var e=this._getRenderer();return e&&e instanceof Eu},n.getMap=function(){return this.map?this.map:null},n.getProjection=function(){var e=this.getMap();return e?e.getProjection():null},n.bringToFront=function(){var e=this._getLayerList();if(!e.length)return this;var t=e[e.length-1];if(1===e.length||t===this)return this;var n=t.getZIndex();return this.setZIndex(n+1),this},n.bringToBack=function(){var e=this._getLayerList();if(!e.length)return this;var t=e[0];if(1===e.length||t===this)return this;var n=t.getZIndex();return this.setZIndex(n-1),this},n.show=function(){var e=this;if(!this.options.visible){this.options.visible=!0;var t=this.getRenderer();t&&t.show();var n=this.getMap();t&&n&&n.getRenderer()?n.getRenderer().callInNextFrame((function(){n.getRenderer().callInNextFrame((function(){e.fire("show")}))})):this.fire("show")}return this},n.hide=function(){var e=this;if(this.options.visible){this.options.visible=!1;var t=this.getRenderer();t&&t.hide();var n=this.getMap();t&&n&&n.getRenderer()?n.getRenderer().callInNextFrame((function(){n.getRenderer().callInNextFrame((function(){e.fire("hide")}))})):this.fire("hide")}return this},n.isVisible=function(){var e=this.options.opacity;if(c(e)&&e<=0)return!1;var t=this.map;if(t){var n=t.getZoom(),i=this.options.minZoom,s=this.options.maxZoom;if(!h(s)&&s<n||!h(i)&&i>n)return!1}return h(this.options.visible)&&(this.options.visible=!0),this.options.visible},n.remove=function(){if(this.map){var e=this.map.getRenderer();this.map.removeLayer(this),e&&e.setToRedraw()}else this.fire("remove");return this},n.getMask=function(){return this._mask},n.setMask=function(e){if(!("Point"===e.type&&e._isVectorMarker()||"Polygon"===e.type||"MultiPolygon"===e.type))throw new Error("Mask for a layer must be a marker with vector marker symbol or a Polygon(MultiPolygon).");if(e._bindLayer(this),"Point"===e.type?e.updateSymbol({markerLineColor:"rgba(0, 0, 0, 0)",markerFillOpacity:0}):e.setSymbol({lineColor:"rgba(0, 0, 0, 0)",polygonOpacity:0}),this._mask=e,e&&e.toGeoJSON)try{this._maskGeoJSON=e.toGeoJSON()}catch(e){delete this._maskGeoJSON,console.error(e)}if(this.options.mask=e.toJSON(),!this.getMap()||this.getMap().isZooming())return this;var t=this._getRenderer();return t&&t.setToRedraw&&this._getRenderer().setToRedraw(),this},n.removeMask=function(){if(delete this._mask,delete this._maskGeoJSON,delete this.options.mask,!this.getMap()||this.getMap().isZooming())return this;var e=this._getRenderer();return e&&e.setToRedraw&&this._getRenderer().setToRedraw(),this},n.onLoad=function(){return!0},n.onLoadEnd=function(){},n.isLoaded=function(){return!!this._loaded},n.getCollisionIndex=function(){if("layer"===this.options.collisionScope)return this._collisionIndex||(this._collisionIndex=new ha),this._collisionIndex;var e=this.getMap();return e?e.getCollisionIndex():null},n.clearCollisionIndex=function(){return"layer"===this.options.collisionScope&&this._collisionIndex&&this._collisionIndex.clear(),this},n.getRenderer=function(){return this._getRenderer()},n.onConfig=function(e){if(e&&Object.keys&&Object.keys(e).length>0&&h(e.animation)){if(this._optionsHook&&m(this._optionsHook)&&this._optionsHook(e),this._silentConfig)return;var t=this.getRenderer();if(t&&t.setToRedraw&&t.setToRedraw(),"attribution"in e){var n=this.getMap();n&&n.attributionControl&&n.attributionControl._update&&n.attributionControl._update()}}},n.onAdd=function(){},n.onRendererCreate=function(){},n.onCanvasCreate=function(){},n.onRemove=function(){},n._bindMap=function(e,t){e&&(this.parent=e,this.map=e.isMap?e:e.getMap(),h(t)||this.setZIndex(t),this._switchEvents("on",this),this.onAdd(),this.fire("add"))},n._initRenderer=function(){var e=this.options.renderer;if(this.constructor.getRendererClass&&e){var t=this.constructor.getRendererClass(e);if(!t)throw new Error("Invalid renderer for Layer("+this.getId()+"):"+e);this._renderer=new t(this),this._renderer.layer=this,this._renderer.setZIndex(this.getZIndex()),this._switchEvents("on",this._renderer),this._renderer.onAdd&&this._renderer.onAdd(),this.onRendererCreate(),this.fire("renderercreate",{type:"renderercreate",target:this,renderer:this._renderer})}},n._doRemove=function(){this._loaded=!1,this._switchEvents("off",this),this.onRemove(),this._renderer&&(this._switchEvents("off",this._renderer),this._renderer.remove(),delete this._renderer),delete this.map,delete this._collisionIndex},n._switchEvents=function(e,t){t&&t.getEvents&&this.getMap()&&this.getMap()[e](t.getEvents(),t)},n._getRenderer=function(){return this._renderer},n._getLayerList=function(){if(!this.map)return[];var e=+!!this.map.getBaseLayer();return this.map.getLayers().slice(e)},n._getMask2DExtent=function(){if(!this._mask||!this.getMap())return null;var e=this._mask._getMaskPainter();return e?e.get2DExtent():null},n.toJSON=function(e){return{type:"Layer",id:this.getId(),options:e||this.config()}},t.fromJSON=function(e){if(!e)return null;var n=e.type,i=t.getJSONClass(n);if(!i||!i.fromJSON)throw new Error("unsupported layer type:"+n);return i.fromJSON(e)},n.identify=function(e,t){},n.identifyAtPoint=function(e,t){},t}(ol(Ba(wh(Ua))));Lu.mergeOptions(Ru);var Du=Lu.prototype.fire;Lu.prototype.fire=function(e,t){return"layerload"===e&&(this._loaded=!0),this.map&&(t||(t={type:null,target:null}),t.type=e,t.target=this,this.map._onLayerEvent(t)),Du.apply(this,arguments),["show","hide"].indexOf(e)>-1&&this.fire("visiblechange",Object.assign({},t,{visible:this.options.visible})),this};var Fu=new fl(0,0),Hu=new Re(0,0),Nu=["centerCross","fog","fogColor","debugSky"],Bu={maxVisualPitch:70,maxPitch:80,centerCross:!1,zoomable:!0,zoomInCenter:!1,zoomOrigin:null,zoomAnimation:!n,zoomAnimationDuration:330,tileBackgroundLimitPerFrame:3,panAnimation:!n,panAnimationDuration:600,rotateAnimation:!n,enableInfoWindow:!0,hitDetect:!ye.mobile,hitDetectLimit:5,fpsOnInteracting:25,layerCanvasLimitOnInteracting:-1,maxZoom:null,minZoom:null,maxExtent:null,limitExtentOnMaxExtent:!1,fixCenterOnResize:!0,checkSize:!0,checkSizeInterval:1e3,renderer:["canvas","gl","gpu"],cascadePitches:[10,60],renderable:!0,clickTimeThreshold:280,stopRenderOnOffscreen:!0,preventWheelScroll:!0,preventTouch:!0,supportPluginEvent:!0,switchDragButton:!1,mousemoveThrottleTime:48,mousemoveThrottleEnable:!0,maxFPS:0,debug:!1,cameraFarUndergroundInMeter:2e3,onlyWebGL1:!1,forceRedrawPerFrame:!1,preserveDrawingBuffer:!0,extensions:[],optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","EXT_frag_depth","EXT_texture_filter_anisotropic","WEBGL_compressed_texture_astc","WEBGL_compressed_texture_etc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_compressed_texture_s3tc_srgb"]},zu=function(e){function t(n,i){var s;if(!i)throw new Error("Invalid options when creating map.");if(!i.center)throw new Error("Invalid center when creating map.");var o=l({},i),a=o.zoom;delete o.zoom;var h=new fl(o.center);delete o.center;var c=o.baseLayer;delete o.baseLayer;var u=o.layers;return delete o.layers,(s=e.call(this,o)||this).isMap=!0,s.VERSION=t.VERSION,Object.defineProperty(s,"id",{value:He(),writable:!1}),s._loaded=!1,s._initContainer(n),s._panels={},s._baseLayer=null,s._layers=[],s._zoomLevel=a,s._center=h,s.setSpatialReference(o.spatialReference||o.view),s._mapViewPoint=new Re(0,0),s._initRenderer(),s._updateMapSize(s._getContainerDomSize()),c&&s.setBaseLayer(c),u&&s.addLayer(u),s.setMaxExtent(o.maxExtent),s._Load(),s.proxyOptions(),s}Te(t,e),t.addOnLoadHook=function(e,...t){var n="function"==typeof e?e:function(){this[e].call(this,...t)};return this.prototype._onLoadHooks=this.prototype._onLoadHooks||[],this.prototype._onLoadHooks.push(n),this};var i=t.prototype;return i.isLoaded=function(){return!!this._loaded},i.getContainer=function(){return this._containerDOM},i.getSpatialReference=function(){return this._spatialReference},i.setSpatialReference=function(e){var t=this.options.spatialReference;return this._loaded&&uu.equals(t,e)||this._updateSpatialReference(e,t),this},i._updateSpatialReference=function(e,t){g(e)&&(e=uu.getPreset(e)),e=l({},e),this._center=this.getCenter(),this.options.spatialReference=e,this._spatialReference=new uu(e);var n=this._spatialReference.getProjection();return this.options.spatialReference&&m(this.options.spatialReference.projection)&&(this.options.spatialReference.projection=n.code),this._resetMapStatus(),gh.is(n.code)&&(this._originLng=n.centralMeridian,this._altitudeOriginDirty=!0),this._fireEvent("spatialreferencechange",{old:t,new:l({},this.options.spatialReference)}),this},i.onConfig=function(e){var t=e.spatialReference||e.view;if(h(t)||this._updateSpatialReference(t,null),"canvas"===this.options.renderer){for(var n=!1,i=0,s=Nu.length;i<s;i++){if(!h(e[Nu[i]])){n=!0;break}}if(!n)return this}var o=this.getRenderer();return o&&o.setToRedraw(),this},i.getProjection=function(){return this._spatialReference?this._spatialReference.getProjection():null},i.getFullExtent=function(){return this._spatialReference?this._spatialReference.getFullExtent():null},i.setCursor=function(e){return delete this._cursor,this._trySetCursor(e),this._cursor=e,this},i.resetCursor=function(){return this.setCursor(null)},i.getCenter=function(){if(!this._loaded||!this._prjCenter)return this._center;var e=this.getProjection().unproject(this._prjCenter);return e.x=Math.round(1e8*e.x)/1e8,e.y=Math.round(1e8*e.y)/1e8,this.centerAltitude&&(e.z=this.centerAltitude),e},i.setCenter=function(e,t){if(!e)return this;e=new fl(e),t&&(e=this._getCenterByPadding(e,this.getZoom(),t));var n=this.getProjection().project(e);return this._verifyExtent(n)||this.options.limitExtentOnMaxExtent?this._loaded?(this.onMoveStart(),this._setPrjCenter(n),this.onMoveEnd(this._parseEventFromCoord(this.getCenter())),this):(this._center=e,this):this},i.getSize=function(){return h(this.width)||h(this.height)?this._getContainerDomSize():new Ot(this.width,this.height)},i.getContainerExtent=function(){var e=this.height,t=this.getPitch(),n=this.options.maxVisualPitch;return n&&t>n&&(e=this._getVisualHeight(n)),new Pl(0,this.height-e,this.width,this.height)},i._getVisualHeight=function(e){e=e||.01;var t=(90-this.getPitch())*Math.PI/180,n=this.getFov()*Math.PI/180;e*=Math.PI/180;var i=this.cameraCenterDistance/this.getGLScale(),s=Math.tan(n/2),o=i*s/(1/Math.tan(e)-s)/Math.sin(e),a=i*(Math.sin(t)*o/(i+Math.cos(t)*o));return this.height/2+a},i.getExtent=function(){return this.pointToExtent(this.get2DExtent())},i.getProjExtent=function(){var e=this.get2DExtent();return new Ml(this._pointToPrj(e.getMin()),this._pointToPrj(e.getMax()))},i.getPrjExtent=function(){return this.getProjExtent()},i.getMaxExtent=function(){return this.options.maxExtent?new Ml(this.options.maxExtent,this.getProjection()):null},i.setMaxExtent=function(e){if(e){var t=new Ml(e,this.getProjection());this.options.maxExtent=t;var n=this.getProjection();this._prjMaxExtent=t.convertTo((function(e){return n.project(e)})),this._verifyExtent(this._getPrjCenter())||(this._loaded?this._panTo(this._prjMaxExtent.getCenter()):this._center=n.unproject(this._prjMaxExtent.getCenter()))}else delete this.options.maxExtent,delete this._prjMaxExtent;return this},i.getZoom=function(){return this._zoomLevel},i.getZoomForScale=function(e,t,n){var i=this.getZoom();if(h(t)&&(t=i),1===e&&t===i)return i;var s=this._getResolution(t),o=this.getZoomFromRes(s/e);if(n)return o;var a=1e-6;return this.getSpatialReference().getZoomDirection()<0?Math.ceil(o-a):Math.floor(o+a)},i.getZoomFromRes=function(e){var t=this._getResolutions(),n=this._getResolution(this.getMinZoom()),i=this._getResolution(this.getMaxZoom());if(n<=i){if(e<=n)return this.getMinZoom();if(e>=i)return this.getMaxZoom()}else{if(e>=n)return this.getMinZoom();if(e<=i)return this.getMaxZoom()}for(var s=t.length,o=0;o<s-1;o++)if(t[o]){var a=t[o+1]-t[o],l=e-t[o];if(We(a)===We(l)&&Math.abs(a)>=Math.abs(l))return o+l/a}return s-1},i.setZoom=function(e,t={animation:!0}){return isNaN(e)||h(e)||(e=+e,this._loaded&&this.options.zoomAnimation&&t.animation?this._zoomAnimation(e):this._zoom(e)),this},i.getMaxZoom=function(){return h(this.options.maxZoom)?this.getMaxNativeZoom():this.options.maxZoom},i.setMaxZoom=function(e){var t=this.getMaxNativeZoom();return e>t&&(e=t),null!==e&&e<this._zoomLevel&&(this.setZoom(e),e=+e),this.options.maxZoom=e,this},i.getMinZoom=function(){return h(this.options.minZoom)?this._spatialReference.getMinZoom():this.options.minZoom},i.setMinZoom=function(e){if(null!==e){e=+e;var t=this._spatialReference.getMinZoom();e<t&&(e=t),e>this._zoomLevel&&this.setZoom(e)}return this.options.minZoom=e,this},i.getMaxNativeZoom=function(){var e=this.getSpatialReference();return e?e.getMaxZoom():null},i.getGLRes=function(){if(this._glRes)return this._glRes;var e=this.getSpatialReference().getFullExtent();return this._glRes=(e.right-e.left)/Math.pow(2,19),this._glRes},i.getGLScale=function(e){return h(e)&&(e=this.getZoom()),this._getResolution(e)/this.getGLRes()},i.zoomIn=function(){return this.setZoom(this.getZoom()+1)},i.zoomOut=function(){return this.setZoom(this.getZoom()-1)},i.isZooming=function(){return!!this._zooming},i.isInteracting=function(){return this.isZooming()||this.isMoving()||this.isRotating()},i.setCenterAndZoom=function(e,t){return h(t)||this._zoomLevel===t?this.setCenter(e):(this.setCenter(e),this.setZoom(t,{animation:!1})),this},i._getPaddingSize=function(e={}){return e.paddingLeft||e.paddingTop||e.paddingRight||e.paddingBottom?{width:(e.paddingLeft||0)+(e.paddingRight||0),height:(e.paddingTop||0)+(e.paddingBottom||0)}:null},i.getFitZoom=function(e,t,n){var i=this;if(!(e&&e instanceof Ml))return this._zoomLevel;if(e.xmin===e.xmax&&e.ymin===e.ymax)return this.getMaxZoom();var s=this.getSize(),o=this._getPaddingSize(n);if(o){var a={width:s.width-(o.width||0),height:s.height-(o.height||0)};s=new Ot(a.width,a.height)}var l=e.convertTo((function(e){return i.coordToPoint(e)})),h=l.getWidth(),c=l.getHeight(),u=s.width/h,f=s.height/c,g=this.getSpatialReference().getZoomDirection()<0?Math.max(u,f):Math.min(u,f);return this.getZoomForScale(g,null,t)},i.getView=function(){return{center:this.getCenter().toArray(),zoom:this.getZoom(),pitch:this.getPitch(),bearing:this.getBearing()}},i._validateView=function(e){if(e&&f(e)){if(c(e.bearing)){var t=e.bearing;(t%=360)>180&&(t=-180+Math.abs(t-180)),t<-180&&(t=180-Math.abs(t+180)),e.bearing=t}c(e.pitch)&&(e.pitch=Math.max(0,e.pitch),e.pitch=Math.min(this.options.maxPitch,e.pitch));var n=this.getMaxZoom();c(e.zoom)&&(e.zoom=Math.max(0,e.zoom),e.zoom=Math.min(n,e.zoom))}},i.setView=function(e){return e?(this._validateView(e),e.center&&this.setCenter(e.center),null===e.zoom||isNaN(+e.zoom)||this.setZoom(+e.zoom,{animation:!1}),null===e.pitch||isNaN(+e.pitch)||this.setPitch(+e.pitch),null===e.bearing||isNaN(+e.bearing)||this.setBearing(+e.bearing),this):this},i.getResolution=function(e){return this._getResolution(e)},i.getScale=function(e){var t=h(e)?this.getZoom():e,n=this._getResolution(this.getMaxNativeZoom());return this._getResolution(t)/n},i._getCenterByPadding=function(e,t,n){var i=this.coordinateToPoint(e,t),{paddingLeft:s=0,paddingRight:o=0,paddingTop:a=0,paddingBottom:l=0}=n||{},h=0,c=0;(s||o)&&(h=(o-s)/2),(a||l)&&(c=(a-l)/2);var u=new Re({x:i.x+h,y:i.y+c});return this.pointToCoordinate(u,t)},i.fitExtent=function(e,t,n,i){var s=this;if(n=n||{},!e)return this;var o=new Ml(e),a=this.getFitZoom(o,n.isFraction||!1,n)+(t||0),l=o.convertTo((function(e){return s.coordToPoint(e)})),h=this.pointToCoord(l.getCenter());return this._getPaddingSize(n)&&(h=this._getCenterByPadding(h,a,n)),void 0===n.animation||n.animation?this._animateTo({center:h,zoom:a},{duration:n.duration||this.options.zoomAnimationDuration,easing:n.easing||"out"},i):this.setCenterAndZoom(h,a)},i.getBaseLayer=function(){return this._baseLayer},i.setBaseLayer=function(e){var t=!1;if(this._baseLayer&&(t=!0,this._fireEvent("baselayerchangestart"),this._baseLayer.remove()),!e)return delete this._baseLayer,this._fireEvent("baselayerchangeend"),this._fireEvent("setbaselayer"),this;return this._baseLayer=e,e._bindMap(this,-1),this._baseLayer.on("layerload",(function(){this._fireEvent("baselayerload"),t&&(t=!1,this._fireEvent("baselayerchangeend"))}),this),this._loaded&&this._baseLayer.load(),this._fireEvent("setbaselayer"),this},i.removeBaseLayer=function(){return this._baseLayer&&(this._baseLayer.remove(),delete this._baseLayer,this._fireEvent("baselayerremove")),this},i.getLayers=function(e){return this._getLayers((function(t){return!(t===this._baseLayer||t.getId().indexOf(vt)>=0)&&(!e||e(t))}))},i.getLayer=function(e){if(!e)return null;var t=this._layerCache?this._layerCache[e]:null;if(t)return t;var n=this.getBaseLayer();return n&&n.getId()===e?n:null},i.addLayer=function(e,...t){if(!e)return this;Array.isArray(e)||(e=[e]),t&&t.length&&(e=e.concat(t)),this._layerCache||(this._layerCache={});for(var n=this._layers,i=0,s=e.length;i<s;i++){var o=e[i],a=o.getId();if(h(a))throw new Error("Invalid id for the layer: "+a);if(o.getMap()!==this){if(this._layerCache[a])throw new Error("Duplicate layer id in the map: "+a);this._layerCache[a]=o,o._bindMap(this),n.push(o),this._loaded&&o.load()}}return this._sortLayersByZIndex(),this._fireEvent("addlayer",{layers:e}),this},i.removeLayer=function(e){if(!e)return this;if(!Array.isArray(e))return this.removeLayer([e]);for(var t=[],n=0,i=e.length;n<i;n++){var s=e[n];if(s instanceof Lu||(s=this.getLayer(s)),s){var o=s.getMap();if(o&&o===this){t.push(s),this._removeLayer(s,this._layers),this._loaded&&s._doRemove();var a=s.getId();this._layerCache&&delete this._layerCache[a]}}}if(t.length>0){var l=this.getRenderer();l&&("canvas"===this.options.renderer?l.setLayerCanvasUpdated():l.setToRedraw()),this.once("frameend",(function(){t.forEach((function(e){e.fire("remove")}))}))}return this._fireEvent("removelayer",{layers:e}),this},i._findTerrainLayer=function(){if(Gu(this._baseLayer))return this._baseLayer;for(var e=this._getLayers()||[],t=0;t<e.length;t++){var n=e[t];if(Gu(n))return n}return null},i.sortLayers=function(e){if(!e||!Array.isArray(e))return this;for(var t=[],n=Number.MAX_VALUE,i=0,s=e.length;i<s;i++){var o=e[i];if(g(e[i])&&(o=this.getLayer(o)),!(o instanceof Lu&&o.getMap()&&o.getMap()===this))throw new Error("It must be a layer added to this map to order.");o.getZIndex()<n&&(n=o.getZIndex()),t.push(o)}for(var a=0,l=t.length;a<l;a++)t[a].setZIndex(n+a);return this},i.toDataURL=function(e){e||(e={});var t=e.mimeType;t||(t="image/png");var n=e.save,i=this._getRenderer();if(i&&i.toDataURL){var s=e.fileName;s||(s="export");var o=i.toDataURL(t,e.quality||.92);if(n&&o){var a;if("undefined"!=typeof Blob&&"undefined"!=typeof atob){var l=st(o.replace(/^data:image\/(png|jpeg|jpg|webp);base64,/,""),t);a=URL.createObjectURL(l)}else a=o;var h=document.createElement("a");h.download=s,h.href=a,document.body.appendChild(h),h.click(),document.body.removeChild(h)}return o}return null},i.coordToPoint=function(e,t,n){return this.coordinateToPoint(e,t,n)},i.coordToPointAtRes=function(e,t,n){return this.coordinateToPointAtRes(e,t,n)},i.pointToCoord=function(e,t,n){return this.pointToCoordinate(e,t,n)},i.pointAtResToCoord=function(e,t,n){return this.pointAtResToCoordinate(e,t,n)},i.coordToViewPoint=function(e,t,n){return this.coordinateToViewPoint(e,t,n)},i.viewPointToCoord=function(e,t){return this.viewPointToCoordinate(e,t)},i.coordToContainerPoint=function(e,t,n){return this.coordinateToContainerPoint(e,t,n)},i.containerPointToCoord=function(e,t){return this.containerPointToCoordinate(e,t)},i.containerPointToViewPoint=function(e,t){return t?t.set(e.x,e.y):t=e.copy(),t._sub(this.getViewPoint())},i.viewPointToContainerPoint=function(e,t){return t?t.set(e.x,e.y):t=e.copy(),t._add(this.getViewPoint())},i.checkSize=function(e){var t=a()-this._initTime<1500&&0===this.width||0===this.height,n=this._getContainerDomSize(),i=this.height,s=this.width;if(!e&&n.width===s&&n.height===i)return this;En(this._containerDOM);var o=this.getCenter();if(this.options.fixCenterOnResize)this._updateMapSize(n);else{var l=this._getVisualHeight(this.getPitch()),h=new Re(0,this.height-l),c=this._containerPointToPrj(h);this._updateMapSize(n);var u=this._getVisualHeight(this.getPitch()),f=new Re(0,this.height-u);this._setPrjCoordAtContainerPoint(c,f),this._mapViewCoord=this._getPrjCenter()}return(t||(0===n.width||0===n.height||0===s||0===i))&&(this._eventSilence=!0,this.setCenter(o),delete this._eventSilence),this._fireEvent("resize"),this},i.locate=function(e,t,n){return this.getProjection()._locate(new fl(e),t,n)},i.getMainPanel=function(){var e=this._getRenderer();return e?e.getMainPanel():null},i.getPanels=function(){return this._panels},i.remove=function(){var e=this;if(this.isRemoved())return this;this._fireEvent("removestart"),[this._animPlayer,this._mapAnimPlayer].forEach((function(t){t&&t.finish&&e._stopAnim(t)})),this._removeDomEvents(),this._clearHandlers(),this.removeBaseLayer();for(var t=this.getLayers(),n=0;n<t.length;n++)t[n].remove();return this._getRenderer()&&this._getRenderer().remove(),this._containerDOM.childNodes&&this._containerDOM.childNodes.length>0&&Array.prototype.slice.call(this._containerDOM.childNodes,0).filter((function(e){return"maptalks-wrapper"===e.className})).forEach((function(t){return e._containerDOM.removeChild(t)})),delete this._panels,delete this._containerDOM,delete this._renderer,this._fireEvent("removeend"),this._clearAllListeners(),this},i.isRemoved=function(){return!this._containerDOM},i.isMoving=function(){return!!this._moving},i.onMoveStart=function(e){this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer);var t=this._getPrjCenter();this._originCenter&&!this._verifyExtent(t)||(this._originCenter=t),this._moving=!0,this._trySetCursor("move"),this._fireEvent("movestart",this._parseEvent(e?e.domEvent:null,"movestart"))},i.onMoving=function(e){this._fireEvent("moving",this._parseEvent(e?e.domEvent:null,"moving")),this._limitMaxExtent()},i.onMoveEnd=function(e){(this._moving=!1,this._suppressRecenter||this._recenterOnTerrain(),this._trySetCursor("default"),this._fireEvent("moveend",e&&e.domEvent?this._parseEvent(e.domEvent,"moveend"):e),this._verifyExtent(this._getPrjCenter())||!this._originCenter||this.options.limitExtentOnMaxExtent)||this._panTo(this._originCenter);this._limitMaxExtent()},i.onDragRotateStart=function(e){this._dragRotating=!0,this._fireEvent("dragrotatestart",this._parseEvent(e?e.domEvent:null,"dragrotatestart"))},i.onDragRotating=function(e){this._fireEvent("dragrotating",this._parseEvent(e?e.domEvent:null,"dragrotating"))},i.onDragRotateEnd=function(e){this._dragRotating=!1,this._fireEvent("dragrotateend",this._parseEvent(e?e.domEvent:null,"dragrotateend"))},i.isDragRotating=function(){return!!this._dragRotating},i.isOffscreen=function(e,t=0){var{width:n,height:i}=this,s=n+t,o=i+t,{xmin:a,ymin:l,xmax:h,ymax:c}=e;return Array.isArray(e)&&([a,l,h,c]=e),h<t||a>=s||c<t||l>o},i.getRenderer=function(){return this._getRenderer()},i.getDevicePixelRatio=function(){return this.options.devicePixelRatio||ye.devicePixelRatio||1},i.setDevicePixelRatio=function(e){return c(e)&&e>0&&e!==this.options.devicePixelRatio&&(this.options.devicePixelRatio=e,this.checkSize(!0)),this},i._initContainer=function(e){var t,i;if(g(e)){if(this._containerDOM=document.getElementById(e),!this._containerDOM)throw new Error("Invalid container when creating map: '"+e+"'")}else this._containerDOM=e,n&&(this.CanvasClass=this._containerDOM.constructor);if((null===(i=null===(t=this._containerDOM)||void 0===t?void 0:t.childNodes)||void 0===i?void 0:i.length)>0){var s=this._containerDOM.childNodes[0];if(s instanceof HTMLElement&&s.classList.contains("maptalks-wrapper"))throw new Error("Container is already loaded with another map instance, use map.remove() to clear it.")}},i._trySetCursor=function(e){return this._cursor||this._priorityCursor||(e||(e="default"),this._setCursorToPanel(e)),this},i._setPriorityCursor=function(e){if(e)this._priorityCursor=e,this._setCursorToPanel(e);else{var t=!1;this._priorityCursor&&(t=!0),delete this._priorityCursor,t&&this.setCursor(this._cursor)}return this},i._setCursorToPanel=function(e){var t=this.getMainPanel();t&&t.style&&t.style.cursor!==e&&(t.style.cursor=e)},i._removeLayer=function(e,t){if(e&&t){var n=t.indexOf(e);n>-1&&t.splice(n,1)}},i._sortLayersByZIndex=function(){if(this._layers){for(var e=0,t=this._layers.length;e<t;e++){var n=this._layers[e];n._order=e,n.sortLayersByZIndex&&n.sortLayersByZIndex()}this._layers.sort((function(e,t){var n=e.getZIndex()-t.getZIndex();return 0===n?e._order-t._order:n}))}},i._fireEvent=function(e,t){if(!this._eventSilence){"_"!==e[0]&&this.fire("_"+e,t),this.fire(e,t)}},i._Load=function(){this._resetMapStatus(),this.options.pitch&&(this.setPitch(this.options.pitch),delete this.options.pitch),this.options.bearing&&(this.setBearing(this.options.bearing),delete this.options.bearing),delete this._glRes,this._loadAllLayers(),this._getRenderer().onLoad(),this._loaded=!0,this._callOnLoadHooks(),this._initTime=a()},i._initRenderer=function(){var e=this.options.renderer;Array.isArray(e)||(e=[e]);for(var n=0;n<e.length;n++){var i=t.getRendererClass(e[n]);if(i){this._renderer=new i(this),this._renderer.load();break}}if(!this._renderer)throw new Error("Invalid map.options.renderer: "+this.options.renderer)},i._getRenderer=function(){return this._renderer},i._loadAllLayers=function(){this._baseLayer&&this._baseLayer.load(),this._eachLayer((function(e){e&&e.load()}),this.getLayers())},i._getLayers=function(e){for(var t=this._baseLayer?[this._baseLayer].concat(this._layers):this._layers,n=[],i=0;i<t.length;i++)e&&!e.call(this,t[i])||n.push(t[i]);return n},i._eachLayer=function(e,...t){if(!(arguments.length<2)){t&&!Array.isArray(t)&&(t=[t]);for(var n=[],i=0,s=t.length;i<s;i++)n=n.concat(t[i]);for(var o=0,a=n.length;o<a;o++)e.call(e,n[o])}},i._onLayerEvent=function(e){e&&"idchange"===e.type&&(delete this._layerCache[e.old],this._layerCache[e.new]=e.target)},i._resetMapStatus=function(){var e=this.getMaxZoom(),t=this.getMinZoom(),n=this._spatialReference.getMaxZoom(),i=this._spatialReference.getMinZoom();(h(e)||-1===e||e>n)&&this.setMaxZoom(n),(h(t)||-1===t||t<i)&&this.setMinZoom(i),(e=this.getMaxZoom())<(t=this.getMinZoom())&&this.setMaxZoom(t),(h(this._zoomLevel)||this._zoomLevel>e)&&(this._zoomLevel=e),this._zoomLevel<t&&(this._zoomLevel=t),delete this._prjCenter,delete this._glRes;var s=this.getProjection();this._prjCenter=s.project(this._center),this._prjCenter.z=this._center.z,this._calcMatrices();var o=this._getRenderer();o&&o.resetContainer()},i.setContainerDomRect=function(e){this._containerDomContentRect=e},i._getContainerDomSize=function(){if(!this._containerDOM)return null;var e,t,n=this._containerDOM;if(this._containerDomContentRect)return new Ot(e=this._containerDomContentRect.width,t=this._containerDomContentRect.height);var i=n;if(h(i.width)||h(i.height)){if(h(n.clientWidth)||h(n.clientHeight))throw new Error("can not get size of container");e=parseInt(n.clientWidth+"",0),t=parseInt(n.clientHeight+"",0)}else{e=i.width,t=i.height;var s=this.getDevicePixelRatio();1!==s&&n.layer&&(e/=s,t/=s)}return new Ot(e,t)},i._updateMapSize=function(e){this.width=e.width,this.height=e.height;var t=this._getRenderer();return t&&t.updateMapSize(e),this._calcMatrices(),this},i._getPrjCenter=function(){return this._prjCenter},i._setPrjCenter=function(e){this._prjCenter=e,this.isInteracting()&&!this.isMoving()&&(this._mapViewCoord=e),this._calcMatrices()},i._setPrjCoordAtContainerPoint=function(e,t){if(!this.centerAltitude&&t.x===this.width/2&&t.y===this.height/2)return this;var n=this._containerPointToPoint(t)._sub(this._prjToPoint(this._getPrjCenter())),i=this._pointToPrj(this._prjToPoint(e)._sub(n));return this._setPrjCenter(i),this},i._setPrjCoordAtOffsetToCenter=function(e,t){var n=this._pointToPrj(this._prjToPoint(e)._sub(t));return this._setPrjCenter(n),this},i._verifyExtent=function(e){if(!e)return!1;var t=this._prjMaxExtent;return!t||t.contains(e)},i._limitMaxExtent=function(){var e=this;if(this._limitMaxExtenting||!this.options.limitExtentOnMaxExtent)return this;var t=this._prjMaxExtent,n=this.getMaxExtent();if(!t||!n)return this;var i=t.toArray().map((function(t){return e.prjToContainerPoint(t)})),s=hs();ps(i,s);var{width:o,height:a}=this.getSize(),l=[0,0,o,a];if(xs(l,s))return this;if(xs(s,l))return this;var h=0,c=0,u=0,f=0,g=0,m=0,A=Math.abs,[w,T,S,M]=s;if(w>0&&S>o&&(h=u=A(w)),w<0&&S<o&&(h=u=-A(w)),w<0&&S<o&&(h=f=-A(o-S)),w>0&&S>o&&(h=f=A(o-S)),T>0&&M>a&&(c=g=A(T)),T<0&&M<a&&(c=g=-A(T)),T<0&&M<a&&(c=m=-A(a-M)),T>0&&M>a&&(c=m=A(a-M)),0!==u&&0!==f&&(h=u,A(f)<A(u)&&(h=f)),0!==g&&0!==m&&(c=g,A(m)<A(g)&&(c=m)),0!==h||0!==c){var C=new Re(o/2+h,a/2+c),I=this.containerPointToCoord(C);this._limitMaxExtenting=!0,this.setCenter(I),this._limitMaxExtenting=!1}return this},i._offsetCenterByPixel=function(e){var t=Hu.set(this.width/2-e.x,this.height/2-e.y),n=this._containerPointToPrj(t,Fu),i=Hu.set(this.width/2,this.height/2);this._setPrjCoordAtContainerPoint(n,i)},i.offsetPlatform=function(e){return e?(this._getRenderer().offsetPlatform(e),this._mapViewCoord=this._getPrjCenter(),this._mapViewPoint=this._mapViewPoint.add(e),this._mapViewPoint):this._mapViewPoint},i.getViewPoint=function(){var e=this.getViewPointFrameOffset(),t=this.offsetPlatform();return e&&(t=t.add(e)),t},i._resetMapViewPoint=function(){this._mapViewPoint=new Re(0,0),this._mapViewCoord=this._getPrjCenter()},i._getResolution=function(e){return void 0!==e&&e!==this._zoomLevel||void 0===this._mapRes?(h(e)&&(e=this._zoomLevel),this._spatialReference.getResolution(e)):this._mapRes},i._getResolutions=function(){return this._spatialReference.getResolutions()},i._prjToPoint=function(e,t,n){t=h(t)?this.getZoom():t;var i=this._getResolution(t);return this._prjToPointAtRes(e,i,n)},i._prjToPointAtRes=function(e,t,n){return this._spatialReference.getTransformation().transform(e,t,n)},i._prjsToPointsAtRes=function(e,t,n=[]){for(var i=this._spatialReference.getTransformation(),s=[],o=0,a=e.length;o<a;o++){var l=i.transform(e[o],t,n[o]);s.push(l)}return s},i._pointToPrj=function(e,t,n){t=h(t)?this.getZoom():t;var i=this._getResolution(t);return this._pointToPrjAtRes(e,i,n)},i._pointToPrjAtRes=function(e,t,n){return this._spatialReference.getTransformation().untransform(e,t,n)},i._pointToPoint=function(e,t,n){return h(t)?(n?(n.x=e.x,n.y=e.y):n=e.copy(),n):this._pointAtResToPoint(e,this._getResolution(t),n)},i._pointAtResToPoint=function(e,t,n){return n?(n.x=e.x,n.y=e.y):n=e.copy(),n._multi(t/this._getResolution())},i._pointToPointAtRes=function(e,t,n){return n?(n.x=e.x,n.y=e.y):n=e.copy(),n._multi(this._getResolution()/t)},i._containerPointToPrj=function(e,t){return this._pointToPrj(this._containerPointToPoint(e,void 0,t),void 0,t)},i._callOnLoadHooks=function(){var e=t.prototype;if(e._onLoadHooks)for(var n=0,i=e._onLoadHooks.length;n<i;n++)e._onLoadHooks[n].call(this)},i._fixPrjOnWorldWide=function(e){var t=this.getProjection();if(t&&t.fullExtent&&e){var{left:n,bottom:i,top:s,right:o}=t.fullExtent||{};c(n)&&(e.x=Math.max(n,e.x)),c(o)&&(e.x=Math.min(o,e.x)),c(i)&&(e.y=Math.max(i,e.y)),c(s)&&(e.y=Math.min(s,e.y))}return this},i.toJSON=function(e){e||(e={});var t={jsonVersion:this.JSON_VERSION,version:this.VERSION,extent:this.getExtent().toJSON()};t.options=this.config(),t.options.center=this.getCenter(),t.options.zoom=this.getZoom(),t.options.bearing=this.getBearing(),t.options.pitch=this.getPitch();var n=this.getBaseLayer();(h(e.baseLayer)||e.baseLayer)&&n&&(t.baseLayer=n.toJSON(e.baseLayer));var i={};e.clipExtent&&(i.clipExtent=!0===e.clipExtent?this.getExtent():e.clipExtent);var s=[];if(h(e.layers)||e.layers&&!Array.isArray(e.layers)){for(var o=this.getLayers(),a=0,c=o.length;a<c;a++)if(o[a].toJSON){var u=l({},f(e.layers)?e.layers:{},i);s.push(o[a].toJSON(u))}t.layers=s}else if(Ye(e.layers)){for(var g=e.layers,m=0;m<g.length;m++){var A=g[m],w=this.getLayer(A.id);if(w.toJSON){var T=l({},A.options,i);s.push(w.toJSON(T))}}t.layers=s}else t.layers=[];return t},t.fromJSON=function(e,n,i){if(!e||!n)return null;i||(i={});var s=new t(e,n.options);if(h(i.baseLayer)||i.baseLayer){var o=Lu.fromJSON(n.baseLayer);o&&s.setBaseLayer(o)}if(h(i.layers)||i.layers){for(var a=[],l=n.layers,c=0;c<l.length;c++){var u=Lu.fromJSON(l[c]);a.push(u)}s.addLayer(a)}return s},t}(al(Ba(wh(Ua))));function Gu(e){return e&&e.queryTerrainAtPoint&&e.getTerrainLayer&&e.getTerrainLayer()}zu.mergeOptions(Bu);var Uu=function(e){function t(){return e.apply(this,arguments)||this}return Te(t,e),t}(za),Vu=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.addHooks=function(){this.target&&this.target.on("_dblclick",this._onDoubleClick,this)},n.removeHooks=function(){this.target&&this.target.off("_dblclick",this._onDoubleClick,this)},n._onDoubleClick=function(e){var t=this.target;if(t.options.doubleClickZoom){var n=t.getZoom(),i=e.domEvent.shiftKey?Math.ceil(n)-1:Math.floor(n)+1;t._zoomAnimation(i,e.containerPoint)}},t}(Uu);zu.mergeOptions({doubleClickZoom:!0}),zu.addOnLoadHook("addHandler","doubleClickZoom",Vu);var ju=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.addHooks=function(){var e=this.target;if(e){var t=e.getPanels().mapWrapper||e.getContainer();this._dragHandler=new ul(t,{cancelOn:this._cancelOn.bind(this),rightclick:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this).on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this).enable()}},n.removeHooks=function(){this._dragHandler.off("mousedown",this._onMouseDown,this).off("dragstart",this._onDragStart,this).off("dragging",this._onDragging,this).off("dragend",this._onDragEnd,this),this._dragHandler.remove(),delete this._dragHandler},n._cancelOn=function(e){return!(!this.target.isZooming()&&!this._ignore(e))},n._ignore=function(e){return!!e&&(e.domEvent&&(e=e.domEvent),this.target._ignoreEvent(e))},n._onMouseDown=function(e){delete this.startDragTime,delete this._mode;var t=this.target.options.switchDragButton;t&&"touchstart"===e.domEvent.type||e.domEvent.button===(t?0:2)||e.domEvent.ctrlKey?(this.target.options.dragRotate||this.target.options.dragPitch)&&(this._mode="rotatePitch"):this.target.options.dragPan&&(this._mode="move"),this.target._stopAnim(this.target._mapAnimPlayer),Mn(e.domEvent)},n._onDragStart=function(e){this.startDragTime=a(),"move"===this._mode?this._moveStart(e):"rotatePitch"===this._mode&&this._rotateStart(e)},n._onDragging=function(e){"move"===this._mode?this._moving(e):"rotatePitch"===this._mode&&this._rotating(e)},n._onDragEnd=function(e){"move"===this._mode?this._moveEnd(e):"rotatePitch"===this._mode&&this._rotateEnd(e),delete this.startDragTime,delete this.startBearing},n._start=function(e){this.preX=e.mousePos.x,this.preY=e.mousePos.y,this.startX=this.preX,this.startY=this.preY,this._startPrjCenter=this.target._getPrjCenter().copy()},n._moveStart=function(e){delete this.startContainerPoint,this._start(e);var t=this.target;t.onMoveStart(e);var n=Rn(t._getActualEvent(e.domEvent),t.getContainer());this.startPrjCoord=t.queryPrjCoordAtContainerPoint(n),t._isContainerPointOutOfMap(n)&&void 0===this.startPrjCoord.z&&(this.startContainerPoint=n)},n._moving=function(e){if(this.startDragTime){var t=this.target,n=Rn(t._getActualEvent(e.domEvent),t.getContainer());if(this.startContainerPoint){var i=n._sub(this.startContainerPoint);n.set(t.width/2+i.x,t.height/2+i.y)}var s=t._containerPointToPoint(n,void 0,void 0,this.startPrjCoord.z)._sub(t._prjToPoint(t._getPrjCenter()));t._setPrjCoordAtOffsetToCenter(this.startPrjCoord,s),t.onMoving(e)}},n._moveEnd=function(e){if(this.startDragTime){var t="touchend"===e.domEvent.type,n=this.target,i=a()-this.startDragTime,s=e.mousePos.x-this.startX,o=e.mousePos.y-this.startY,l=n._getPrjCenter(),h=l.sub(this._startPrjCenter);if(this._clear(),n.options.panAnimation&&!e.interupted&&n._verifyExtent(n._getPrjCenter())&&i<280&&Math.abs(o)+Math.abs(s)>5){i*=5;var c=l.add(h._multi(t?5:2.8));n._panTo(c,{duration:t?3*i:2*i,easing:n.options.dragPanEasing||"outExpo"})}else n.onMoveEnd(e)}},n._rotateStart=function(e){this._start(e),delete this._rotateMode,this.startBearing=this.target.getBearing(),this.target.onDragRotateStart(e),this._db=0},n._rotating=function(e){var t=this.target,n=e.mousePos.x,i=e.mousePos.y,s=t.getPitch(),o=t.getBearing(),a=Math.abs(n-this.preX),l=Math.abs(i-this.preY);if(this._rotateMode||(this._rotateMode=t.options.dragRotatePitch?"rotate_pitch":a>l?"rotate":a<l?"pitch":"rotate"),!("pitch"===this._rotateMode&&0===s&&l<10)){if(this._rotateMode.indexOf("rotate")>=0&&t.options.dragRotate){var h=.15,c=0;c=t.options.dragPitch||a>l?-.15*(this.preX-n):n>t.width/2?h*(this.preY-i):-.15*(this.preY-i);var u=t.getBearing()+c;this._db=this._db||0,this._db+=c,t._setBearing(u)}this._rotateMode.indexOf("pitch")>=0&&t.options.dragPitch&&t._setPitch(t.getPitch()+.15*(this.preY-i)),this.preX=n,this.preY=i,t.getBearing()===o&&t.getPitch()===s||t.onDragRotating(e)}},n._rotateEnd=function(e){var t=this.target,n=t.getBearing();this._clear();var i=a()-this.startDragTime;if(t.onDragRotateEnd(e),t.options.rotateAnimation&&Math.abs(n-this.startBearing)>20&&("rotate"===this._rotateMode||"rotate_pitch"===this._rotateMode)&&!e.interupted&&i<400){var s=t.getBearing();t._animateTo({bearing:s+this._db/1.5},{easing:"outQuint",duration:1600})}},n._clear=function(){delete this.startPrjCoord,delete this.preX,delete this.preY,delete this.startX,delete this.startY},t}(Uu);zu.mergeOptions({draggable:!0,dragPan:!0,dragRotatePitch:!0,dragRotate:!0,dragPitch:!0}),zu.addOnLoadHook("addHandler","draggable",ju);var Wu="mousedown mouseup mousemove click dblclick contextmenu touchstart touchmove touchend mouseout",qu={mousemove:["mousemove","mouseover","mouseout","mouseenter"],touchend:["touchend","click"]},Zu=function(e){return e&&e.getLayer&&e.on&&e.fire},Xu=function(e,t,n){if(e._onEvent)return e._onEvent(t,n);var i=e.getLayer();return i&&i.fireGeoEvent?i.fireGeoEvent(e,t,n):null},Yu=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.addHooks=function(){var e=this.target,t=e.getPanels().allLayers||e.getContainer();jn(t,Wu,this._identifyGeometryEvents,this)},n.removeHooks=function(){var e=this.target,t=e.getPanels().allLayers||e.getContainer();Wn(t,Wu,this._identifyGeometryEvents)},n._identifyGeometryEvents=function(e,t){var n=this.target;if(!n.isInteracting()&&!n._ignoreEvent(e)){var i=null,s=t||e.type;if(qn(s)&&!o.isTest&&n.options.mousemoveThrottleEnable&&Zn(this,n.options.mousemoveThrottleTime))Cn(e);else{var l="mousedown"===s||"touchstart"===s&&e.touches&&1===e.touches.length;if(l)this._mouseDownTime=a();else if(("click"===s||"touchend"===s)&&this._mouseDownTime){var h=this._mouseDownTime;if(delete this._mouseDownTime,a()-h>300){if("click"===s)return}else"touchend"===s&&(i="click")}var c=e.touches&&e.touches.length>0?e.touches[0]:e.changedTouches&&e.changedTouches.length>0?e.changedTouches[0]:e;if(c){var u=Rn(c,n.getContainer());"touchstart"===s&&n.options.preventTouch&&Mn(e);for(var f=null,g=this.target.getRenderer().getTopElements(),m=l&&2!==e.button,A=0;A<g.length;A++)if(g[A].hitTest(u)){var w=g[A].options.cursor;if(w&&(f=w),m||g[A].events&&g[A].events.indexOf(s)>=0){var T={target:n,type:s,domEvent:e,containerPoint:u};if(m)return n._setPriorityCursor(f),void g[A].mousedown(T);g[A].onEvent(T)}}var S=n._getLayers((function(e){return!(!e.identify||!e.options.geometryEvents)}));if(S.length){var M={includeInternals:!0,filter:function(t){if(t instanceof gu){var n=t._getEventTypeToFire(e);return"mousemove"===s?(!f&&t.options.cursor&&(f=t.options.cursor),!0):!(!t.listens(n)&&!t.listens(i))}return!!Zu(t)},count:1,onlyVisible:n.options.onlyVisibleGeometryEvents,containerPoint:u,layers:S,eventTypes:qu[s]||[s],domEvent:e},C=function(t){var o=this,a=!0,l=function(){return o._prevOverGeos&&o._prevOverGeos.geos||[]},h=function(t=[],n=[]){if(t&&t.length>0)for(var i=t.length-1;i>=0;i--){var s=t[i];Zu(s)&&(-1===n.indexOf(s)&&(a=Xu(s,e,"mouseout")))}};if("mouseout"===s){var c=l();this._prevOverGeos={geos:[],geomap:{}},h(c,[])}else if("mousemove"===s){var u={};if(t.length>0)for(var g=t.length-1;g>=0;g--){var m=t[g];if(Zu(m)){var A=(S=m)._getInternalId?S._getInternalId():S.getId?S.getId():null;u[A]=m,Xu(m,e),this._prevOverGeos&&this._prevOverGeos.geomap[A]||Xu(m,e,"mouseenter"),a=Xu(m,e,"mouseover")}}n._setPriorityCursor(f);var w=l();this._prevOverGeos={geos:t,geomap:u},h(w,t)}else{if(!t||!t.length)return;for(var T=t.length-1;T>=0;T--)if(Zu(t[T])){a=Xu(t[T],e),i&&Xu(t[T],e,i);break}}var S;!1===a&&Cn(e)}.bind(this);qn(s)?this._queryIdentifyTimeout=n.getRenderer().callInNextFrame((function(){n.isInteracting()||n.identifyAtPoint(M,C)})):n.identifyAtPoint(M,C)}}}}},t}(Uu);zu.mergeOptions({geometryEvents:!0,onlyVisibleGeometryEvents:!0}),zu.addOnLoadHook("addHandler","geometryEvents",Yu);var Ju=4.000244140625,Qu=1/450,$u=function(e){function t(t){var n;return(n=e.call(this,t)||this)._thisScrollZoom=n._scrollZoom.bind(n),n._thisCheckIfEndZoom=n._checkIfEndZoom.bind(n),n._wheelZoomRate=Qu,n._defaultZoomRate=.01,n._delta=0,n}Te(t,e);var n=t.prototype;return n.addHooks=function(){vn(this.target._containerDOM,"wheel",this._onWheelScroll,this)},n.removeHooks=function(){bn(this.target._containerDOM,"wheel",this._onWheelScroll)},n._currentZoomCanScroll=function(e){if(c(e)){var t=this.target,n=t.getZoom(),i=t.getMinZoom(),s=t.getMaxZoom();if(n===i&&e>0)return!1;if(n===s&&e<0)return!1}return!0},n._onWheelScroll=function(e){var t=this.target;if(t.options.preventWheelScroll&&(Mn(e),Cn(e)),t._ignoreEvent(e)||!t.options.zoomable)return!1;var n=t.getContainer(),i=t._checkZoomOrigin(Rn(e,n));return t.options.seamlessZoom?(this._zooming||(this._trackPadSuspect=0,this._ensureTrackpad=!1),this._seamless(e,i)):this._interval(e,i)},n._seamless=function(e,t){var n=e.deltaMode===window.WheelEvent.DOM_DELTA_LINE?60*e.deltaY:e.deltaY;if(n%Ju!=0&&(this._ensureTrackpad||(Math.abs(n)<60?this._trackPadSuspect++:this._trackPadSuspect=0,this._trackPadSuspect>=2&&(this._ensureTrackpad=!0)),this._ensureTrackpad&&(n*=14)),e.shiftKey&&n&&(n/=4),this._lastWheelEvent=e,h(this._delta)&&(this._delta=0),this._delta-=n,this._currentZoomCanScroll(n)){if(!this._zooming&&this._delta){var i=this.target;this._zoomOrigin=t,i.onZoomStart(null,t)}this._start()}},n._start=function(){this._delta&&(this._zooming=!0,this._active||(this.target.getRenderer().callInNextFrame(this._thisScrollZoom),this._active=!0))},n._scrollZoom=function(){if(this._active=!1,this._delta){var e=Math.abs(this._delta)>Ju?this._wheelZoomRate:this._defaultZoomRate,t=2/(1+Math.exp(-Math.abs(this._delta*e)));this._delta<0&&0!==t&&(t=1/t);var n=this.target,i=n.getZoom(),s=n.getZoomForScale(t,i,!0);this._delta=0,n.onZooming(s,this._zoomOrigin),this._scrollTime=performance.now(),n.getRenderer().callInNextFrame(this._thisCheckIfEndZoom)}},n._checkIfEndZoom=function(){if(this._zooming){var e=this.target;performance.now()-this._scrollTime>210?(this._zooming=!1,e.onZoomEnd(e.getZoom(),this._zoomOrigin)):e.getRenderer().callInNextFrame(this._thisCheckIfEndZoom)}},n._interval=function(e,t){var n=this,i=this.target;if(this._zooming)return this._requesting++,!1;this._requesting=0;var s=(e.deltaY?-1*e.deltaY:e.wheelDelta?e.wheelDelta:e.detail)>0?1:-1;e.detail&&(s*=-1);var o=i.getZoom(),a=o+s;if((a=i._checkZoom(s>0?Math.ceil(a):Math.floor(a)))===o)return!1;this._zooming=!0,this._delta||(i.onZoomStart(null,t),this._origin=t,this._delta=s,this._startZoom=i.getZoom());return i._animateTo({zoom:a-1*this._delta/2,around:this._origin},{continueOnViewChanged:!0,easing:"linear",duration:90,wheelZoom:!0},(function(t){"finished"===t.state.playState?n._requesting<1||Math.abs(a-n._startZoom)>2||a===i.getMaxZoom()||a===i.getMinZoom()?(i._animateTo({zoom:a,around:n._origin},{continueOnViewChanged:!0,duration:100},(function(e){"running"!==e.state.playState&&(delete n._zooming,delete n._requesting)})),delete n._startZoom,delete n._origin,delete n._delta,n._requesting=0):h(n._requesting)||(delete n._zooming,n._onWheelScroll(e)):"running"!==t.state.playState&&(delete n._zooming,delete n._requesting)})),!1},t}(Uu);zu.mergeOptions({scrollWheelZoom:!0,seamlessZoom:!0}),zu.addOnLoadHook("addHandler","scrollWheelZoom",$u);var Ku=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.addHooks=function(){vn(this.target.getContainer(),"touchstart",this._onTouchStart,this)},n.removeHooks=function(){bn(this.target.getContainer(),"touchstart",this._onTouchStart)},n._onTouchStart=function(e){var t=this.target;if(e.touches&&!(e.touches.length<2)){var n=t.getContainer(),i=Rn(e.touches[0],n),s=Rn(e.touches[1],n);this.preY=i.y,this._startP1=i,this._startP2=s,this._startDist=i.distanceTo(s),this._startVector=i.sub(s),this._startZoom=t.getZoom(),this._startBearing=t.getBearing(),Wn(document,"touchmove",this._onTouchMove),Wn(document,"touchend",this._onTouchEnd),vn(document,"touchmove",this._onTouchMove,this),vn(document,"touchend",this._onTouchEnd,this),t.options.preventTouch&&Mn(e),t._fireEvent("touchactstart")}},n._onTouchMove=function(e){var t=this.target;if(e.touches&&!(e.touches.length<2)){var n=t.getContainer(),i=Rn(e.touches[0],n),s=Rn(e.touches[1],n),o=i.sub(this._startP1),a=s.sub(this._startP2),l=i.sub(s),h=i.distanceTo(s)/this._startDist,c=180*l.angleWith(this._startVector)/Math.PI,u=.4*((this.preY||i.y)-i.y);this.preY=i.y;var f={domEvent:e,mousePos:[i,s]};if(this.mode||(t.options.touchRotate&&Math.abs(c)>8?this.mode=t.options.touchZoomRotate?"rotate_zoom":"rotate":t.options.touchPitch&&o.y*a.y>0&&Math.abs(o.y)>10&&Math.abs(a.y)>10?this.mode="pitch":t.options.zoomable&&t.options.touchZoom&&Math.abs(1-h)>.15&&(this.mode=t.options.touchZoomRotate&&t.options.touchRotate?"rotate_zoom":"zoom"),this._startTouching(f)),"zoom"===this.mode||"rotate_zoom"===this.mode){this._scale=h;var g=t._getResolution(this._startZoom)/h,m=t.getZoomFromRes(g);t.onZooming(m,this._Origin)}"rotate"===this.mode||"rotate_zoom"===this.mode?(t._setBearing(this._startBearing+c),t.onDragRotating(f)):"pitch"===this.mode&&(t._setPitch(t.getPitch()+u),t.onDragRotating(f)),t._fireEvent("touchactinging")}},n._startTouching=function(e){var t=this.target;if("zoom"===this.mode||"rotate_zoom"===this.mode){var n=t.getSize();this._Origin=new Re(n.width/2,n.height/2),t.onZoomStart(null,this._Origin)}"rotate"!==this.mode&&"pitch"!==this.mode&&"rotate_zoom"!==this.mode||t.onDragRotateStart(e)},n._onTouchEnd=function(e){delete this.preY;var t=this.target;if(Wn(document,"touchmove",this._onTouchMove),Wn(document,"touchend",this._onTouchEnd),"zoom"===this.mode||"rotate_zoom"===this.mode){var n=this._scale,i=t._getResolution(this._startZoom)/n,s=t.getZoomFromRes(i);t.onZoomEnd(s,this._Origin)}"pitch"!==this.mode&&"rotate"!==this.mode&&"rotate_zoom"!==this.mode||t.onDragRotateEnd({domEvent:e}),delete this.mode,t._fireEvent("touchactend")},t}(Uu);zu.mergeOptions({touchGesture:!0,touchZoom:!0,touchPitch:!0,touchRotate:!0,touchZoomRotate:!1}),zu.addOnLoadHook("addHandler","touchGesture",Ku);var ef="__anim_player",tf={outExpo:function(e){return 1===e?1:1-Math.pow(2,-10*e)},outQuint:function(e){return 1-Math.pow(1-e,5)},in:function(e){return Math.pow(e,2)},out:function(e){return 1-tf.in(1-e)},inAndOut:function(e){return 3*e*e-2*e*e*e},linear:function(e){return e},upAndDown:function(e){return e<.5?tf.inAndOut(2*e):1-tf.inAndOut(2*(e-.5))}},nf=xe((function(e,t){this.state=e,this.styles=t}),[{key:"playState",get:function(){return this.state.playState}},{key:"symbol",get:function(){return this.styles.symbol}}]),rf=function(){function e(e,t,n,i){this._animation=e,this.options=t,this._onFrame=n,this.playState="idle",this.ready=!0,this.finished=!1,this.target=i}var t=e.prototype;return t._prepare=function(){var e=this.options,t=e.speed||e.duration;g(t)&&((t=sf.speed[t])||(t=+t)),t||(t=sf.speed.normal),this.duration=t,this._framer=e.framer||sf._requestAnimFrame.bind(sf)},t.play=function(){if("idle"!==this.playState&&"paused"!==this.playState||this.target&&this.target[ef])return this;this.target&&(this.target[ef]=1),"idle"===this.playState&&(this.currentTime=0,this._prepare());var e=a();if(!this.startTime){var t=this.options;this.startTime=t.startTime?t.startTime:e}return this._playStartTime=Math.max(e,this.startTime),"paused"===this.playState&&(this._playStartTime-=this.currentTime),this.playState="running",this._run(),this},t.pause=function(){return"paused"===this.playState||(this.playState="paused",this._run()),this},t.cancel=function(){return"idle"===this.playState||(this.playState="idle",this.finished=!1,this._run()),this},t.finish=function(){return"finished"===this.playState||(this.playState="finished",this.finished=!0,this._run()),this},t.reverse=function(){},t._run=function(){var e=this,t=this._onFrame,n=a(),i=n-this._playStartTime;if(this.options.repeat&&i>=this.duration&&(this._playStartTime=n,i=0),"running"===this.playState){var s=this._animation(i,this.duration);this.playState=s.state.playState,"running"!==this.playState&&this.target&&delete this.target[ef],"idle"===this.playState?this.startTime>n&&setTimeout(this._run.bind(this),this.startTime-n):"running"===this.playState?this._framer((function(){"running"===e.playState&&(e.currentTime=i,t&&t(s),e._run())})):"finished"===this.playState&&(this.finished=!0,t&&t(s))}else if(this.target&&delete this.target[ef],t){"finished"===this.playState?i=this.duration:"idle"===this.playState&&(i=0);var o=this._animation(i,this.duration);o.state.playState=this.playState,t(o)}},e}(),sf={speed:{slow:2e3,normal:1e3,fast:500},_resolveStyles:function(e){if(!e)return null;function t(e){if(!Array.isArray(e))return sf._resolveStyles(e);for(var t=[],n=[],i=[],s=0;s<e.length;s++){var o=sf._resolveStyles(e[s]);o&&(t.push(o[0]),n.push(o[1]),i.push(o[2]))}return t.length?[t,n,i]:null}function n(e){var t,n=e;Array.isArray(e)||(n=c(e)?[0,e]:e instanceof Re||e instanceof fl?[new(t=e.constructor)(0,0),e]:[e,e]);var i=n[0],s=n[1];return c(i)&&c(s)?i===s?null:[i,s-i,s]:Array.isArray(i)&&c(i[0])||i instanceof fl||i instanceof Re?(Array.isArray(i)?(i=new fl(i),s=new fl(s)):(i=new(t=i.constructor)(i),s=new t(s)),i.equals(s)?null:[i,s.sub(i),s]):[i,s,s]}var i,s={},o={},a={};for(var l in e)if(e.hasOwnProperty(l)){var u=e[l];if(!u)continue;if(Array.isArray(u)&&(h(u[0])||h(u[1])))continue;var f=void 0;i=u,(f=!Array.isArray(i)&&i.constructor===Object||Array.isArray(i)&&i[0].constructor===Object?t(u):n(u))&&(o[l]=f[0],s[l]=f[1],a[l]=f[2])}return[o,s,a]},framing:function(e,t){var n,i,s,o;t||(t={}),(n=m(t.easing)?t.easing:t.easing?tf[t.easing]:tf.linear)&&m(n)||(n=tf.linear),(e=sf._resolveStyles(e))&&(s=e[0],i=e[1],o=e[2]);var a=function(e,t,n){if(!t||!n)return null;var i={};for(var s in n)if(n.hasOwnProperty(s)){if(t[s]===o[s]){i[s]=t[s];continue}var l=t[s],h=n[s];if(c(h))i[s]=l+e*h;else if(Array.isArray(h)){for(var u=[],f=0;f<h.length;f++)u.push(a(e,l[f],h[f]));i[s]=u}else{i[s]=h.constructor===Object?a(e,l,h):l instanceof Re||l instanceof fl?l.add(h.multi(e)):h}}return i};return function(e,t){var l,h;if(e<0)l={playState:"idle",delta:0},h=s;else if(e<t){var c=n(e/t);l={playState:"running",delta:c},h=a(c,s,i)}else l={playState:"finished",delta:1},h=o;return l.startStyles=s,l.destStyles=o,l.progress=e,l.remainingMs=t-e,new nf(l,h)}},_requestAnimFrame:function(e){this._frameQueue||(this._frameQueue=[]),this._frameQueue.push(e),this._a()},_a:function(){this._animationFrameId||(this._animationFrameId=ke(sf._frameFn))},_run:function(){if(this._frameQueue.length){var e=this._frameQueue;this._frameQueue=[];for(var t=0,n=e.length;t<n;t++)e[t]();this._frameQueue.length?this._animationFrameId=ke(sf._frameFn):delete this._animationFrameId}},animate:function(e,t,n,i){t||(t={});var s=sf.framing(e,t);return new rf(s,t,n,i)},_frameFn:function(){}};sf._frameFn=sf._run.bind(sf);var of=sf.animate,af=Object.freeze({__proto__:null,Animation:sf,Easing:tf,Frame:nf,Player:rf,animate:of}),lf={exports:{}};!function(e){!function(){function t(e,t,n){var i=t.x,s=t.y,o=n.x-i,a=n.y-s;if(0!==o||0!==a){var l=((e.x-i)*o+(e.y-s)*a)/(o*o+a*a);l>1?(i=n.x,s=n.y):l>0&&(i+=o*l,s+=a*l)}return(o=e.x-i)*o+(a=e.y-s)*a}function n(e,i,s,o,a){for(var l,h=o,c=i+1;c<s;c++){var u=t(e[c],e[i],e[s]);u>h&&(l=c,h=u)}h>o&&(l-i>1&&n(e,i,l,o,a),a.push(e[l]),s-l>1&&n(e,l,s,o,a))}function i(e,t){var i=e.length-1,s=[e[0]];return n(e,0,i,t,s),s.push(e[i]),s}function s(e,t,n){if(e.length<=2)return e;var s=void 0!==t?t*t:1;return e=n?e:function(e,t){for(var n,i,s,o,a,l=e[0],h=[l],c=1,u=e.length;c<u;c++)o=void 0,a=void 0,(o=(i=n=e[c]).x-(s=l).x)*o+(a=i.y-s.y)*a>t&&(h.push(n),l=n);return l!==n&&h.push(n),h}(e,s),e=i(e,s)}e.exports=s,e.exports.default=s}()}(lf);var hf=Yi(lf.exports),cf="not find Geometry' Projection. please add Geometry to Layer and add Layer to Map",uf=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.animateShow=function(e={},t){var n=this;this._showPlayer&&this._showPlayer.finish(),m(e)&&(t=e={});var i=this.getCoordinates();if(0!==i.length){this._animIdx=0,this._animLenSoFar=0,this.show();var s=!!this.getShell?this.getShell().concat(this.getShell()[0]):i,o=this._getProjection();if(o){var a=o.projectCoords(s,this.options.antiMeridian);this._prjAniShowCenter=this._getPrjExtent().getCenter(),this._aniShowCenter=o.unproject(this._prjAniShowCenter);var l=e.duration||1e3,h=e.easing||"out";this.setCoordinates([]);var c=0;a.length&&(a[0]._distance=0);for(var u=1;u<a.length;u++){var f=a[u].distanceTo(a[u-1]);a[u]._distance=f,c+=f}this._tempCoord=new fl(0,0),this._tempPrjCoord=new Re(0,0);var g=this._showPlayer=sf.animate({t:l},{duration:l,easing:h},(function(e){if(n.getMap()){var o=n._drawAnimShowFrame(e.styles.t,l,c,s,a);"finished"===e.state.playState&&(delete n._showPlayer,delete n._aniShowCenter,delete n._prjAniShowCenter,delete n._animIdx,delete n._animLenSoFar,delete n._animTailRatio,delete n._tempCoord,delete n._tempPrjCoord,n.setCoordinates(i)),t&&t(e,o)}else if("finished"!==g.playState&&(g.finish(),t)){var h=n.getCoordinates();t(e,h[h.length-1])}}),this);return g.play(),g}console.error(cf)}},n._drawAnimShowFrame=function(e,t,n,i,s){if(0===e)return i[0];var o,a,l=e/t*n,h=0;for(o=this._animIdx+1,a=s.length;o<a&&!(this._animLenSoFar+(h=s[o]._distance)>l);o++)this._animLenSoFar+=h;if(this._animIdx=o-1,this._animIdx>=a-1)return this.setCoordinates(i),i[i.length-1];var c=this._animIdx,u=s[c],f=s[c+1],g=(l-this._animLenSoFar)/h;this._animTailRatio=g;var m=u.y+(f.y-u.y)*g;this._tempPrjCoord.x=u.x+(f.x-u.x)*g,this._tempPrjCoord.y=m;var A=this._tempPrjCoord,w=i[c],T=i[c+1],S=w.y+(T.y-w.y)*g,M=(w.z||0)+((T.z||0)-(w.z||0))*g;this._tempCoord.x=w.x+(T.x-w.x)*g,this._tempCoord.y=S,this._tempCoord.z=M;var C=this._tempCoord,I=!!this.getShell;if(!I&&this.options.smoothness>0){for(var E=[],D=[],H=0;H<=this._animIdx;H++)E.push(i[H]),D.push(s[H]);E.push(C,C),D.push(A,A),this.setCoordinates(E),this._setPrjCoordinates(D)}else{var N=i.slice(0,this._animIdx+1);N.push(C);var B=s.slice(0,this._animIdx+1);B.push(A),I?(this.setCoordinates([this._aniShowCenter].concat(N)),this._setPrjCoordinates([this._prjAniShowCenter].concat(B))):(this.setCoordinates(N),this._setPrjCoordinates(B))}return C},n._getCenterInExtent=function(e,t,n){var i=this.getExtent();if(!e.intersects(i))return null;var s=n(t,e);if(0===s.length)return null;var[o,a,l]=[0,0,0];s.forEach((function(e){Array.isArray(e)?e.forEach((function(e){e.point&&(e=e.point),o+=e.x,a+=e.y,l++})):(e.point&&(e=e.point),o+=e.x,a+=e.y,l++)}));var h=new fl(o,a)._multi(1/l);return h.count=l,h},n._getPath2DPoints=function(e,t,n){if(!Ye(e))return[];var i=this.getMap(),s=!t&&this._shouldSimplify(),o=this.options.simplifyTolerance*i._getResolution(),a=Array.isArray(e[0]);if(delete this._simplified,s&&!a){var l=e.length;e=hf(e,o,!1),this._simplified=e.length<l}if(n||(n=i._getResolution()),Array.isArray(e)){var h=[],c="_glPt";if(!Array.isArray(e[0]))return h=pt(e,c),i._prjsToPointsAtRes(e,n,h);for(var u=[],f=0,g=e.length;f<g;f++){var m=e[f];h=pt(m,c);var A=i._prjsToPointsAtRes(m,n,h);u.push(A)}return u}return i._prjToPointAtRes(e,n)},n._shouldSimplify=function(){var e=this.getLayer();return e&&e.options.enableSimplify&&!e.options.enableAltitude&&this.options.enableSimplify&&!this._showPlayer},n._setPrjCoordinates=function(e){this._prjCoords=e,this.onShapeChanged()},n._getPrjCoordinates=function(){return this._verifyProjection(),!this._prjCoords&&this._getProjection()&&(this._prjCoords=this._projectCoords(this._coordinates)),this._prjCoords},n._updateCache=function(){this._clearCache(),this._getProjection()&&this._prjCoords&&(this._coordinates=this._unprojectCoords(this._getPrjCoordinates()))},n._clearProjection=function(){this._prjCoords=null,e.prototype._clearProjection.call(this)},n._projectCoords=function(e){var t=this._getProjection();return t?t.projectCoords(e,this.options.antiMeridian):[]},n._unprojectCoords=function(e){var t=this._getProjection();return t?t.unprojectCoords(e):[]},n._computeCenter=function(){var e=this._coordinates;if(!Ye(e))return null;for(var t=0,n=0,i=0,s=e.length,o=0;o<s;o++)e[o]&&c(e[o].x)&&c(e[o].y)&&(t+=e[o].x,n+=e[o].y,i++);return new fl(t/i,n/i)},n._computeExtent=function(e){var t=this._coordinates;if(!Ye(t))return null;var n=[t];return this.hasHoles&&this.hasHoles()&&n.push.call(n,...this.getHoles()),this._coords2Extent(n,this._getProjection())},n._computePrjExtent=function(e){var t=[this._getPrjCoordinates()];return this.hasHoles&&this.hasHoles()&&t.push.call(t,...this._getPrjHoles()),this._coords2Extent(t)},n._get2DLength=function(){for(var e=this._getPath2DPoints(this._getPrjCoordinates(),!0),t=0,n=1,i=e.length;n<i;n++)t+=e[n].distanceTo(e[n-1]);return t},n._hitTestTolerance=function(){var t,n=this._getInternalSymbol(),i=0;if(Array.isArray(n)){t=0;for(var s=0;s<n.length;s++)c(n[s].lineWidth)&&n[s].lineWidth>t&&(t=n[s].lineWidth),c(n[s].lineStrokeWidth)&&(i=Math.max(i,n[s].lineStrokeWidth))}else t=n.lineWidth,i=n.lineStrokeWidth||0;return t+=2*i,e.prototype._hitTestTolerance.call(this)+(c(t)?t/2:1.5)},n._coords2Extent=function(e,t){if(!e||0===e.length||Array.isArray(e[0])&&0===e[0].length)return null;for(var n=new Ml(t),i=0,s=e.length;i<s;i++)for(var o=0,a=e[i].length;o<a;o++)n._combine(e[i][o]);return n},t}(gu);uf.mergeOptions({smoothness:!1,enableClip:!0,enableSimplify:!0,simplifyTolerance:2,symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:1,opacity:1}});var ff="Polygon",df=function(e){function t(t,n){var i;return(i=e.call(this,n)||this).type="Polygon",t&&i.setCoordinates(t),i}Te(t,e);var n=t.prototype;return n.getOutline=function(){return this._getPainter()?new t(this.getExtent().toArray(),{symbol:{lineWidth:1,lineColor:"6b707b"}}):null},n.setCoordinates=function(e){if(!e)return this._coordinates=null,this._holes=null,this._projectRings(),this;var t=fl.toCoordinates(e),n=t.length;if(Array.isArray(t[0]))if(this._coordinates=this._trimRing(t[0]),n>1){for(var i=[],s=1;s<n;s++)t[s]&&i.push(this._trimRing(t[s]));this._holes=i}else this._holes=null;else this._coordinates=this._trimRing(t);return this._projectRings(),this},n.getCoordinates=function(){if(!this._coordinates)return[];for(var e=this.getHoles(),t=[this._copyAndCloseRing(this._coordinates)],n=0,i=e.length;n<i;n++)t.push(this._copyAndCloseRing(e[n]));return t},n.getCenterInExtent=function(e){return this._getCenterInExtent(e,this.getShell(),$h)},n.getShell=function(){return this._coordinates||[]},n.getHoles=function(){return this._holes||[]},n.hasHoles=function(){return this.getHoles().length>0},n._projectRings=function(){this.getMap()?(this._prjCoords=this._projectCoords(this._coordinates),this._prjHoles=this._projectCoords(this._holes),this.onShapeChanged()):this.onShapeChanged()},n._setPrjCoordinates=function(e){this._prjCoords=e,this.onShapeChanged()},n._cleanRing=function(e){for(var t=e.length-1;t>=0;t--)e[t]||e.splice(t,1)},n._checkRing=function(e){if(this._cleanRing(e),!e||!Ye(e))return!1;var t=e[e.length-1],n=!0;return e[0].x===t.x&&e[0].y===t.y||(n=!1),n},n._trimRing=function(e){var t=this._checkRing(e);return Ye(e)&&t&&e.splice(e.length-1,1),e},n._copyAndCloseRing=function(e){e=e.slice(0);var t=this._checkRing(e);return Ye(e)&&!t?(e.push(e[0].copy()),e):e},n._getPrjShell=function(){return this.getJSONType()===ff?this._getPrjCoordinates():(this._verifyProjection(),this._getProjection()&&!this._prjShell&&(this._prjShell=this._projectCoords(this._getShell?this._getShell():this.getShell())),this._prjShell)},n._getPrjHoles=function(){var e=this._getProjection();return this._verifyProjection(),e&&!this._prjHoles&&(this._prjHoles=this._projectCoords(this.getHoles())),this._prjHoles},n._computeGeodesicLength=function(e){var t=this.getCoordinates();if(!Ye(t))return 0;for(var n=0,i=0,s=t.length;i<s;i++)n+=e.measureLength(t[i]);return n},n._computeGeodesicArea=function(e){var t=this.getCoordinates();if(!Ye(t))return 0;for(var n=e.measureArea(t[0]),i=1,s=t.length;i<s;i++)n-=e.measureArea(t[i]);return n},n._updateCache=function(){e.prototype._updateCache.call(this),this._prjHoles&&(this._holes=this._unprojectCoords(this._getPrjHoles()))},n._clearCache=function(){return delete this._prjShell,e.prototype._clearCache.call(this)},n._clearProjection=function(){this._prjHoles&&(this._prjHoles=null),this._prjShell&&(this._prjShell=null),e.prototype._clearProjection.call(this)},t}(uf);function pf(e){return function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.getCoordinates=function(){return this._coordinates},n.setCoordinates=function(e){var t=e instanceof fl?e:new fl(e);if(this._translateRotatePivot(t),this._coordinates=t,!this.getMap())return this._dirtyCoords=!0,this.onPositionChanged(),this;var n=this._getProjection();return this._setPrjCoordinates(n.project(this._coordinates)),this},n._getCenter2DPoint=function(e){var t=this.getMap();if(!t)return null;var n=this._getPrjCoordinates();return n?(e||(e=t._getResolution()),t._prjToPointAtRes(n,e)):null},n._getPrjCoordinates=function(){var e=this._getProjection();return this._verifyProjection(),!this._pcenter&&e&&this._coordinates&&(this._pcenter=e.project(this._coordinates)),this._pcenter},n._setPrjCoordinates=function(e){this._pcenter=e,this.onPositionChanged()},n._updateCache=function(){this._clearCache();var e=this._getProjection();this._pcenter&&e&&(this._coordinates=e.unproject(this._pcenter))},n._clearProjection=function(){this._pcenter=null,e.prototype._clearProjection.call(this)},n._computeCenter=function(){return this._coordinates?this._coordinates.copy():null},t}(e)}df.registerJSONType(ff);var gf=new Pl,mf=function(e){function t(t,n){var i;return(i=e.call(this,n)||this).isPoint=!0,i.type="Point",t&&i.setCoordinates(t),i}Te(t,e);var n=t.prototype;return n.getOutline=function(){var e=this.getCoordinates(),n=this.getContainerExtent(),i=this.getMap().coordToContainerPoint(e);return new t(e,{symbol:{markerType:"square",markerWidth:n.getWidth(),markerHeight:n.getHeight(),markerLineWidth:1,markerLineColor:"6b707b",markerFill:"rgba(0, 0, 0, 0)",markerDx:n.xmin-(i.x-n.getWidth()/2),markerDy:n.ymin-(i.y-n.getHeight()/2)}})},n.setSymbol=function(t){return delete this._fixedExtent,e.prototype.setSymbol.call(this,t)},n._getSizeSymbol=function(e){for(var t,n={},i=!1,s=!1,o=0;o<Zh.length;o++){var a=e[Zh[o]];h(a)||(!i&&Rr(a)&&(i=!0,s=!0),n[Zh[o]]=a)}for(var l=0;l<Xh.length;l++){var c=e[Xh[l]];h(c)||(!i&&Rr(c)&&(i=!0),n[Xh[l]]=c)}return i?(t=li(n,this),s&&(t._dynamic=!0)):t=n,t},n._setExternSymbol=function(t){return this._symbol||delete this._fixedExtent,e.prototype._setExternSymbol.call(this,t)},n._isDynamicSize=function(){return this._sizeSymbol&&this._sizeSymbol._dynamic},n._getFixedExtent=function(){if(this._fixedExtent&&!this._isDynamicSize())return this._fixedExtent;this._fixedExtent=this._fixedExtent||new Pl,this._fixedExtent.set(null,null,null,null);var e=this._sizeSymbol;if(!e)return this._fixedExtent;var t=this.getLayer()&&this.getLayer().getRenderer(),n=t&&t.resources,i=this.getTextDesc();if(Array.isArray(e)){gf.set(1/0,1/0,-1/0,-1/0);for(var s=0;s<e.length;s++)e[s]&&this._fixedExtent._combine(Gh(gf,e[s],n,i&&i[s]))}else this._fixedExtent=Gh(this._fixedExtent,e,n,i);return this._fixedExtent},n._isVectorMarker=function(){var e=this._getInternalSymbol();return!Array.isArray(e)&&jh(e)},n._canEdit=function(){var e=this._getInternalSymbol();return!Array.isArray(e)&&(jh(e)||Wh(e)||Vh(e))},n._containsPoint=function(t,n){var i=this.getContainerExtent();return n&&(i=i.expand(n)),!!i.contains(t)&&(!this.options.hitTestForEvent||e.prototype._containsPoint.call(this,t,n))},n._computeExtent=function(){return Af.call(this,"getCenter")},n._computePrjExtent=function(){return Af.call(this,"_getPrjCoordinates")},n._computeGeodesicLength=function(){return 0},n._computeGeodesicArea=function(){return 0},n._getSprite=function(e,t){return this._getPainter()?this._getPainter().getSprite(e,t):new Qc(this).getSprite(e,t)},t}(pf(gu));function Af(e){var t=this[e]();return t?new Ml(t,t,this._getProjection()):null}mf.mergeOptions({symbol:{markerType:"path",markerPath:[{path:"M8 23l0 0 0 0 0 0 0 0 0 0c-4,-5 -8,-10 -8,-14 0,-5 4,-9 8,-9l0 0 0 0c4,0 8,4 8,9 0,4 -4,9 -8,14z M3,9 a5,5 0,1,0,0,-0.9Z",fill:"#DE3333"}],markerPathWidth:16,markerPathHeight:23,markerWidth:24,markerHeight:34},hitTestForEvent:!1,collision:!0}),mf.registerJSONType("Marker");var yf=function(e){function t(t,n){var i;return(i=e.call(this,n)||this).type="LineString",t&&i.setCoordinates(t),i}Te(t,e);var n=t.prototype;return n.getOutline=function(){return df.prototype.getOutline.call(this)},n.setCoordinates=function(e){return e?(this._coordinates=fl.toCoordinates(e),this.getMap()?this._setPrjCoordinates(this._projectCoords(this._coordinates)):this.onShapeChanged(),this):(this._coordinates=null,this._setPrjCoordinates(null),this)},n.getCoordinates=function(){return this._coordinates||[]},n.getCenterInExtent=function(e){return this._getCenterInExtent(e,this.getCoordinates(),Jh)},n._computeGeodesicLength=function(e){return e.measureLength(this.getCoordinates())},n._computeGeodesicArea=function(){return 0},t}(uf);yf.mergeOptions({arrowStyle:null,arrowPlacement:"vertex-last"}),yf.registerJSONType("LineString");var _f=new Pl,vf=function(e){function t(t,n){var i;return(i=e.call(this,n)||this).type="GeometryCollection",i._lastUndoEditIndex=0,i._lastRedoEditIndex=0,i.setGeometries(t),i}Te(t,e);var n=t.prototype;return n.getContainerExtent=function(e){var t=e||new Pl;return this.forEach((function(e){t._combine(e.getContainerExtent(_f))})),t},n.setGeometries=function(e){for(var t=this._checkGeometries(e||[]),n=this._getSymbol(),i=this.config(),s=this.getProperties(),o=t.length-1;o>=0;o--)t[o]._initOptions(i),t[o]._setParent(this),t[o]._setEventParent(this),n&&t[o].setSymbol(n),s&&t[o].setProperties(s);return this._geometries=t,this.getLayer()&&(this._bindGeometriesToLayer(),this.onShapeChanged()),this},n.getGeometries=function(){return this._geometries||[]},n.forEach=function(e,t){for(var n=this.getGeometries(),i=0,s=n.length;i<s;i++)n[i]&&(t?e.call(t,n[i],i):e(n[i],i));return this},n.filter=function(e,n){if(!e)return new t;var i=[],s=m(e),o=s?e:Ur(e);return this.forEach((function(e){var t=s?e:Kr(e);(n?o.call(n,t):o(t))&&i.push(e)}),this),new t(i)},n.translate=function(e){if(!e)return this;if(this.isEmpty())return this;var t=arguments;return this.forEach((function(e){e&&e.translate&&e.translate.apply(e,t)})),this},n.isEmpty=function(){return!Ye(this.getGeometries())},n.remove=function(){return this.forEach((function(e){e._unbind()})),gu.prototype.remove.apply(this,arguments)},n.show=function(){return this.options.visible=!0,this.forEach((function(e){e.show()})),this},n.hide=function(){return this.options.visible=!1,this.forEach((function(e){e.hide()})),this},n.onConfig=function(e){this.forEach((function(t){t.config(e)}))},n.getSymbol=function(){var t=e.prototype.getSymbol.call(this);if(!t){var n=[],i=!1;this.forEach((function(e){e.getSymbol()&&!i&&(i=!0),n.push(e.getSymbol())})),i&&(t={children:n})}return t},n.setSymbol=function(e){var t=this;if(e&&e.children)this._symbol=null,this.forEach((function(n,i){n._eventSymbolProperties=t._eventSymbolProperties,n.setSymbol(e.children[i])}));else{var n=this._prepareSymbol(e);this._symbol=n,this.forEach((function(e){e._eventSymbolProperties=t._eventSymbolProperties,e.setSymbol(n)}))}return this.onSymbolChanged(),this},n._setExternSymbol=function(e){return e=this._prepareSymbol(e),this._externSymbol=e,this.forEach((function(t){t._setExternSymbol(e)})),this.onSymbolChanged(),this},n._bindLayer=function(){e.prototype._bindLayer.apply(this,arguments),this._bindGeometriesToLayer()},n._bindGeometriesToLayer=function(){var e=this.getLayer();this.forEach((function(t){t._bindLayer(e)}))},n._checkGeometries=function(e){for(var t=[],n=0,i=(e=Array.isArray(e)?e:[e]).length;n<i;n++){var s=e[n];s&&(this._checkGeo(s)?bf(s)?o.isTest||console.error(s," is GeometryCollection sub class,it Cannot be placed in GeometryCollection"):t.push(s):console.error("The geometry added to collection is invalid. Index: "+n))}return t},n._checkGeo=function(e){return e instanceof gu},n._updateCache=function(){this._clearCache(),this.isEmpty()||this.forEach((function(e){e&&e._updateCache&&e._updateCache()}))},n._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter,this.forEach((function(e){e._removePainter()}))},n._computeCenter=function(e){if(!e||this.isEmpty())return null;for(var t=0,n=0,i=0,s=this.getGeometries(),o=0,a=s.length;o<a;o++)if(s[o]){var l=s[o]._computeCenter(e);l&&(t+=l.x,n+=l.y,i++)}return 0===i?null:new fl(t/i,n/i)},n._containsPoint=function(e,t){if(this.isEmpty())return!1;delete this._pickGeometryIndex;for(var n=this.getGeometries(),i=0,s=n.length;i<s;i++)if(n[i]._containsPoint(e,t))return this._pickGeometryIndex=i,!0;return!1},n._hitTestTolerance=function(){for(var e=this.getGeometries(),t=0,n=0,i=e.length;n<i;n++){var s=e[n]._hitTestTolerance();t=Math.max(t,s)}return t},n._computeExtent=function(e){return xf.call(this,e,"_computeExtent")},n._computePrjExtent=function(e){return xf.call(this,e,"_computePrjExtent")},n._computeGeodesicLength=function(e){if(!e||this.isEmpty())return 0;for(var t=this.getGeometries(),n=0,i=0,s=t.length;i<s;i++)t[i]&&(n+=t[i]._computeGeodesicLength(e));return n},n._computeGeodesicArea=function(e){if(!e||this.isEmpty())return 0;for(var t=this.getGeometries(),n=0,i=0,s=t.length;i<s;i++)t[i]&&(n+=t[i]._computeGeodesicArea(e));return n},n._exportGeoJSONGeometry=function(){var e=[];if(!this.isEmpty())for(var t=this.getGeometries(),n=0,i=t.length;n<i;n++)t[n]&&e.push(t[n]._exportGeoJSONGeometry());return{type:"GeometryCollection",geometries:e}},n._toJSON=function(e){e=l({},e);var t,n={type:"Feature",geometry:{type:"GeometryCollection",geometries:this.getGeometries().filter((function(e){return e&&e._toJSON})).map((function(e){var t=e._toJSON();return t.subType?t:e._exportGeoJSONGeometry()}))}},i=this.getId();return h(i)||(n.id=i),(h(e.properties)||e.properties)&&(t=this._exportProperties()),n.properties=t,e.feature=n,e},n._clearProjection=function(){if(!this.isEmpty())for(var e=this.getGeometries(),t=0,n=e.length;t<n;t++)e[t]&&e[t]._clearProjection()},n._getConnectPoints=function(){var e=this.getExtent();return[new fl(e.xmin,e.ymax),new fl(e.xmax,e.ymin),new fl(e.xmin,e.ymin),new fl(e.xmax,e.ymax)]},n._getExternalResources=function(){if(this.isEmpty())return[];for(var e,t,n=this.getGeometries(),i=[],s={},o=0,a=n.length;o<a;o++)if(n[o])for(var l=0,h=(e=di(n[o]._getInternalSymbol())).length;l<h;l++)s[t=e[l].join()]||(i.push(e[l]),s[t]=1);return i},n.startEdit=function(e){var t=this;if(this.isEmpty())return this;e||(e={}),e.symbol&&(this._originalSymbol=this.getSymbol(),this.setSymbol(e.symbol)),this._draggbleBeforeEdit=this.options.draggable,this.config("draggable",!1),this._recordVisible();for(var n=this.getGeometries(),i=0,s=n.length;i<s;i++)n[i].startEdit(e);this._editing=!0;var o=this.getLayer();return o&&"canvas"===o.options.renderer&&this.hide(),setTimeout((function(){t.fire("editstart")}),1),this},n.endEdit=function(){if(this.isEmpty())return this;this._recoveryVisible();for(var e=this.getGeometries(),t=0,n=e.length;t<n;t++)e[t].endEdit();return this._originalSymbol&&(this.setSymbol(this._originalSymbol),delete this._originalSymbol),this._editing=!1,this.show(),this.config("draggable",this._draggbleBeforeEdit),this.fire("editend"),this},n.isEditing=function(){return!!this._editing},n.undoEdit=function(){if(this.isEmpty())return this;this._recoveryVisible();for(var e=this.getGeometries(),t=this._lastUndoEditIndex;t<e.length;t++)if(!e[t].undoEditcheck()){e[t].undoEdit(),this._lastUndoEditIndex=t;break}return t===e.length&&(this._lastUndoEditIndex=0),this.fire("undoedit"),this},n.redoEdit=function(){if(this.isEmpty())return this;this._recoveryVisible();for(var e=this.getGeometries(),t=this._lastRedoEditIndex;t<e.length;t++)if(!e[t].redoEditcheck()){e[t].redoEdit(),this._lastRedoEditIndex=t;break}return t===e.length&&(this._lastRedoEditIndex=0),this.fire("redoedit"),this},n.undoEditcheck=function(){for(var e=this.getGeometries(),t=0;t<e.length;t++)if(!e[t].undoEditcheck())return!1;return!0},n.redoEditcheck=function(){for(var e=this.getGeometries(),t=0;t<e.length;t++)if(!e[t].redoEditcheck())return!1;return!0},t}(gu);function xf(e,t){if(this.isEmpty())return null;for(var n=new Ml,i=this.getGeometries(),s=0,o=i.length;s<o;s++)if(i[s]){var a=i[s][t](e);a&&n._combine(a)}return n}function bf(e){return e instanceof vf}vf.registerJSONType("GeometryCollection");var wf=function(e){function t(t,n,i,s){var o;return(o=e.call(this,null,s)||this).GeometryType=t,o.type=n,o._initData(i),o}Te(t,e);var n=t.prototype;return n.getCoordinates=function(){for(var e=[],t=this.getGeometries(),n=0,i=t.length;n<i;n++){var s=t[n];e.push(s.getShell&&"Polygon"!==s.getJSONType()?[s.getShell()]:s.getCoordinates())}return e},n.setCoordinates=function(e){for(var t=[],n=0,i=(e=e||[]).length;n<i;n++){var s=new this.GeometryType(e[n],this.config());t.push(s)}return this.setGeometries(t),this},n._initData=function(e){(e=e||[]).length&&(e[0]instanceof this.GeometryType?this.setGeometries(e):this.setCoordinates(e))},n._checkGeo=function(e){return e instanceof this.GeometryType},n._exportGeoJSONGeometry=function(){var e=this.getCoordinates(),t=fl.toNumberArrays(e);return{type:this.getType(),coordinates:t}},n._toJSON=function(e){return{feature:this.toGeoJSON(e)}},t}(vf),Tf=function(e){function t(t,n){return e.call(this,mf,"MultiPoint",t,n)||this}return Te(t,e),t.prototype.findClosest=function(e){if(!e)return null;var t=this.getCoordinates(),n=null,i=1/0;return t.forEach((function(t){var s=function(e,t){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)}(t,e);s<i&&(n=t,i=s)})),n},t}(wf);Tf.registerJSONType("MultiPoint");var Sf=function(e){function t(){return e.apply(this,arguments)||this}return Te(t,e),t.prototype.getCenterInExtent=function(e){var t=this.getGeometries(),[n,i,s]=[0,0,0];return t.forEach((function(t){var o=t.getCenterInExtent(e);o&&(n+=o.x*o.count,i+=o.y*o.count,s+=o.count)})),0===s?null:new fl(n,i)._multi(1/s)},t}(wf),Mf=function(e){function t(t,n){return e.call(this,yf,"MultiLineString",t,n)||this}return Te(t,e),t}(Sf);Mf.registerJSONType("MultiLineString");var Cf=function(e){function t(t,n){return e.call(this,df,"MultiPolygon",t,n)||this}return Te(t,e),t}(Sf);Cf.registerJSONType("MultiPolygon");var Pf,kf={Marker:mf,LineString:yf,Polygon:df,MultiPoint:Tf,MultiLineString:Mf,MultiPolygon:Cf},Of="geojson-fetch-worker-page-async",Ef=function(e){function t(){return e.call(this,Of)||this}Te(t,e);var n=t.prototype;return n._sendMsg=function(e,t,n){var i=this;this.send(e,[],(function(s,o){s?n(s):i._pageFeatures(e,o,t,n)}),e.workerId)},n._fetchGeoJSON=function(e,t,n=[],i){var s=l({},t);s.type="fetchdata",s.url=e,this._sendMsg(s,n,i)},n._pageFeatures=function(e,t,n,i){if(n.push(t),0!==t.length){var s=l({},e);s.type="pagefeatures",this._sendMsg(s,n,i)}else i(null,n)},t}(Mu);co(Of,(function(){return"\nfunction (exports) {\n    const resultMap = {};\n\n    function handleResult(msg, postResponse) {\n        const data = msg.data || {};\n        const { taskId } = data;\n        const features = resultMap[taskId];\n        if (!features) {\n            postResponse('not find geojson dataset the taskId:' + taskId);\n            return;\n        }\n        if (features.length === 0) {\n            delete resultMap[taskId];\n            postResponse(null, []);\n            return;\n        }\n        const pageSize = data.pageSize || 2000;\n        const pageFeatures = features.slice(0, pageSize);\n        resultMap[taskId] = features.slice(pageSize, Infinity);\n        postResponse(null, pageFeatures);\n    }\n    //worker init\n    exports.initialize = function () {\n        // console.log(\"geojson fetch init\");\n    };\n    //recive message\n    exports.onmessage = function (msg, postResponse) {\n        const { taskId, type, url } = msg.data || {};\n        if (!taskId) {\n            postResponse('not find task id for get geojson dataset,taskId=' + taskId);\n            return;\n        }\n        if (type === 'fetchdata') {\n            if (!url) {\n                postResponse('url is null,url=' + url);\n                return;\n            }\n            fetch(url).then(res => res.json()).then(geojson => {\n                let features;\n                if (Array.isArray(geojson)) {\n                    features = geojson;\n                } else if (geojson.features) {\n                    features = geojson.features;\n                } else {\n                    features = [geojson];\n                }\n                resultMap[taskId] = features;\n                handleResult(msg, postResponse);\n            }).catch(errror => {\n                postResponse(errror.message);\n            });\n        } else if (type === 'pagefeatures') {\n            handleResult(msg, postResponse);\n        } else {\n            postResponse('not support task type:' + type);\n        }\n    };\n}"}));var Rf={toGeometry:function(e,t,n){var i;if(g(e)&&(e=Be(e)),Array.isArray(e)){i=[];for(var s=0,o=e.length;s<o;s++){var a=Rf._convert(e[s],t);Array.isArray(a)?ze(i,a):i.push(a)}}else i=Rf._convert(e,t);return n&&m(n)&&Array.isArray(i)?i.filter(n):i},toGeometryAsync:function(e,t,n,i){return g(e)&&(e=Be(e)),new Promise((function(s){var o=[];if(e&&(Array.isArray(e)||Array.isArray(e.features))){var a=c(n)?Math.round(n):2e3,l=e.features||e,h=Math.ceil(l.length/a),u=1;Mo({count:h,run:function(){var e=l.slice((u-1)*a,u*a),n=Rf.toGeometry(e,t,i);return u++,n}}).then((function(e){for(var t=0,n=e.length;t<n;t++){var i=e[t];i&&(Array.isArray(i)?ze(o,i):o.push(i))}s(o)}))}else{var f=Rf.toGeometry(e,t);s(f)}}))},_convert:function(e,t){if(!e||h(e.type))return null;var n=e.type;if("Feature"===n){var i=Rf._convert(e.geometry);return i?(i.setId(e.id),i.setProperties(e.properties),t&&t(i),i):null}if("FeatureCollection"===n){var s=e.features;return s?Rf.toGeometry(s,t):null}if(["Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon"].indexOf(n)>=0){var o=new kf["Point"===n?"Marker":n](e.coordinates);return t&&t(o),o}if("GeometryCollection"===n){var a=e.geometries;if(!Ye(a)){var l=new vf;return t&&t(l),l}for(var c=[],u=a.length,f=0;f<u;f++)c.push(a[f].subType?gu.getJSONClass(a[f].subType).fromJSON(a[f]):Rf._convert(a[f]));var g=new vf(c);return t&&t(g),g}return null},_isGeoJSON:function(e){if(!e)return!1;if(e=e||{},Array.isArray(e)&&e.length)return Rf.isGeoJSON(e[0]);var t=e.type;if(!t)return!1;if(-1===bt.indexOf(t))return!1;var{features:n,geometries:i,geometry:s,coordinates:o}=e;if(o&&Array.isArray(o))return!0;if(Array.isArray(i))return!0;if(Array.isArray(n))return!0;if(s){var a=s.coordinates;if(a&&Array.isArray(a))return!0}return!1},fetch:function(e,t=2e3){return new Promise((function(n,i){if(e&&g(e)){var s=l({pageSize:2e3},{pageSize:t});e=mt(e),Pf||(Pf=new Ef);var o=Pf.workers.length,a=Math.floor(Math.random()*o);a=Math.min(o-1,a),s.workerId=a,s.taskId=Ne(),Pf._fetchGeoJSON(e,s,[],(function(e,t){if(e)i(e);else{var s=[];t.forEach((function(e){for(var t=0,n=e.length;t<n;t++)s.push(e[t])})),n({type:"FeatureCollection",features:s})}}))}else i("url is error,It should be string")}))}},Lf=function(e){function t(t,n,i){var s;return s=e.call(this,null,i)||this,t&&s.setCoordinates(t),s._radius=n,s}Te(t,e),t.fromJSON=function(e){var n=e.feature,i=new t(e.coordinates,e.radius,e.options);return i.setProperties(n.properties),i};var n=t.prototype;return n.getRadius=function(){return this._radius},n.setRadius=function(e){return this._radius=e,this.onShapeChanged(),this},n.getShell=function(){for(var e,t,n,i=this._getMeasurer(),s=this.getCoordinates(),o=this.options.numberOfShellPoints,a=this.getRadius(),l=[],h=0,c=o-1;h<c;h++){e=360*h/c*Math.PI/180,t=a*Math.cos(e),n=a*Math.sin(e);var u=i.locate(s,t,n);u.z=s.z,l.push(u)}return l.push(l[0]),l},n.getHoles=function(){return[]},n.animateShow=function(){return this.show()},n._containsPoint=function(t,n){var i=this.getMap();if(i.getPitch())return e.prototype._containsPoint.call(this,t,n);var s=i._pointToContainerPoint(this._getCenter2DPoint()),o=this.getSize(),a=this._hitTestTolerance()+(n||0),l=s.add(o.width/2,o.height/2);return tc(t,s,l,a)},n._computePrjExtent=function(e){var t=this._getMinMax(e);if(!t)return null;var n=this._getPrjCoordinates(),i=t.map((function(t){return e.project(t)})),s=i[1].x-n.x,o=i[3].y-n.y;return new Ml(n.add(i[0].x-n.x,i[2].y-n.y),n.add(s,o))},n._computeExtent=function(e){var t=this._getMinMax(e);return t?new Ml(t[0].x,t[2].y,t[1].x,t[3].y,this._getProjection()):null},n._getMinMax=function(e){if(!e||!this._coordinates||h(this._radius))return null;var t=this._radius;return[e.locate(this._coordinates,-t,0),e.locate(this._coordinates,t,0),e.locate(this._coordinates,0,t),e.locate(this._coordinates,0,-t)]},n._computeGeodesicLength=function(){return h(this._radius)?0:2*Math.PI*this._radius},n._computeGeodesicArea=function(){return h(this._radius)?0:Math.PI*Math.pow(this._radius,2)},n._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:fl.toNumberArrays([this.getShell()])}},n._toJSON=function(e){var t=this.getCenter(),n=l({},e);n.geometry=!1;var i=this.toGeoJSON(n);return i.geometry={type:"Polygon"},{feature:i,subType:"Circle",coordinates:t.toArray(),radius:this.getRadius()}},t}(pf(df));function Df(e){return e*e*e*e}Lf.mergeOptions({numberOfShellPoints:60}),Lf.registerJSONType("Circle");var Ff=function(e){function t(t,n,i,s){var o;return o=e.call(this,null,s)||this,t&&o.setCoordinates(t),o.width=n,o.height=i,o}Te(t,e),t.fromJSON=function(e){var n=e.feature,i=new t(e.coordinates,e.width,e.height,e.options);return i.setProperties(n.properties),i};var n=t.prototype;return n.getWidth=function(){return this.width},n.setWidth=function(e){return this.width=e,this.onShapeChanged(),this},n.getHeight=function(){return this.height},n.setHeight=function(e){return this.height=e,this.onShapeChanged(),this},n.getShell=function(){return this.isRotated()?this.getRotatedShell():this._getShell()},n._getShell=function(){var e,t,n,i,s=this._getMeasurer(),o=this.getCoordinates(),a=this.options.numberOfShellPoints-1,l=this.getWidth(),h=this.getHeight(),c=[],u=Math.pow(l/2,2)*Math.pow(h/2,2),f=Math.pow(l/2,2),g=Math.pow(h/2,2),m=[];if(Math.max(l/h,h/l)>2){var{fs:A,sum:w}=function(e){for(var t=[],n=[],i=0;i<e;i++)n.push(Df(i/e));var s=n.map((function(e){return e})).reverse(),o=[];ze(o,n,s,n,s);for(var a=0,l=0,h=o.length;l<h;l+=4)t.push(o[l]),a+=o[l];return{fs:t,sum:a}}(a),T=360/w,S=0;h>l&&(S=90);for(var M=0,C=0,I=A.length;C<I;C++)m.push((M+=T*A[C])+S)}else for(var E=0;E<a;E++){m.push(360*E/a)}this.options.debug&&console.log(m);for(var D=0;D<m.length;D++){t=(e=m[D])*Math.PI/180,n=Math.sqrt(u/(f*Math.pow(Math.tan(t),2)+g)),i=Math.sqrt(u/(g*Math.pow(1/Math.tan(t),2)+f)),e>90&&e<270&&(n*=-1),e>180&&e<360&&(i*=-1);var H=s.locate(o,n,i);H.z=o.z,c.push(H)}return c.push(c[0].copy()),c},n._getPrjShell=function(){var t=e.prototype._getPrjShell.call(this);return this._rotatePrjCoordinates(t)},n.getHoles=function(){return[]},n.animateShow=function(){return this.show()},n._containsPoint=function(t,n){var i=this.getMap();if(i.isTransforming())return e.prototype._containsPoint.call(this,t,n);var s=i.getProjection(),o=this._hitTestTolerance()+(n||0),a=s.projectCoords([this._coordinates,i.locate(this._coordinates,this.getWidth()/2,this.getHeight()/2)],this.options.antiMeridian);return tc(t,i.prjToContainerPoint(a[0]),i.prjToContainerPoint(a[1]),o)},n._computePrjExtent=function(){return this.isRotated()?this._computeRotatedPrjExtent():Lf.prototype._computePrjExtent.apply(this,arguments)},n._computeExtent=function(){return Lf.prototype._computeExtent.apply(this,arguments)},n._getMinMax=function(e){if(!e||!this._coordinates||h(this.width)||h(this.height))return null;var t=this.getWidth(),n=this.getHeight();return[e.locate(this._coordinates,-t/2,0),e.locate(this._coordinates,t/2,0),e.locate(this._coordinates,0,-n/2),e.locate(this._coordinates,0,n/2)]},n._computeGeodesicLength=function(){return h(this.width)||h(this.height)?0:2*Math.PI*(this.width>this.height?this.width:this.height)/2-4*Math.abs(this.width-this.height)},n._computeGeodesicArea=function(){return h(this.width)||h(this.height)?0:Math.PI*this.width*this.height/4},n._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:fl.toNumberArrays([this.getShell()])}},n._toJSON=function(e){var t=l({},e),n=this.getCenter();t.geometry=!1;var i=this.toGeoJSON(t);return i.geometry={type:"Polygon"},{feature:i,subType:"Ellipse",coordinates:n.toArray(),width:this.getWidth(),height:this.getHeight()}},t}(pf(df));Ff.mergeOptions({numberOfShellPoints:81}),Ff.registerJSONType("Ellipse");var Hf=function(e){function t(t,n,i,s){var o;return o=e.call(this,null,s)||this,t&&o.setCoordinates(t),o._width=n,o._height=i,o}Te(t,e),t.fromJSON=function(e){var n=e.feature,i=new t(e.coordinates,e.width,e.height,e.options);return i.setProperties(n.properties),i};var n=t.prototype;return n.getCoordinates=function(){return this._coordinates},n.setCoordinates=function(e){var t=e instanceof fl?e:new fl(e);if(this._translateRotatePivot(t),this._coordinates=t,!this._coordinates||!this.getMap())return this.onPositionChanged(),this;var n=this._getProjection();return this._setPrjCoordinates(n.project(this._coordinates)),this},n.getWidth=function(){return this._width},n.setWidth=function(e){return this._width=e,this.onShapeChanged(),this},n.getHeight=function(){return this._height},n.setHeight=function(e){return this._height=e,this.onShapeChanged(),this},n.getShell=function(){return this.isRotated()?this.getRotatedShell():this._getShell()},n._getShell=function(){var e=this._getMeasurer(),t=this._coordinates,n=this.getMap(),i=1,s=-1;if(n){var o=n.getFullExtent();o.left>o.right&&(i=-1),o.bottom>o.top&&(s=1)}var a=[];a.push(t);var l=e.locate(t,i*this._width,0);l.z=t.z,a.push(l);var h=e.locate(t,i*this._width,s*this._height);h.z=t.z,a.push(h);var c=e.locate(t,0,s*this._height);return a.push(c),c.z=t.z,a.push(t),a},n.getHoles=function(){return[]},n.animateShow=function(){return this.show()},n._getPrjCoordinates=function(){var e=this._getProjection();return this._verifyProjection(),!this._pnw&&e&&this._coordinates&&(this._pnw=e.project(this._coordinates)),this._pnw},n._setPrjCoordinates=function(e){this._pnw=e,this.onPositionChanged()},n._getPrjShell=function(){var t=e.prototype._getPrjShell.call(this),n=this._getProjection();if(!n.isSphere())return this._rotatePrjCoordinates(t);for(var i=n.getSphereExtent(),s=i.sx,o=i.sy,a=this._getProjection().getCircum(),l=t[0],h=1,c=t.length;h<c;h++){var u=t[h],f=0,g=0;s*(l.x-u.x)>0&&(f=a.x*s),o*(l.y-u.y)<0&&(g=a.y*o),t[h]._add(f,g)}return this._rotatePrjCoordinates(t)},n._updateCache=function(){this._clearCache();var e=this._getProjection();this._pnw&&e&&(this._coordinates=e.unproject(this._pnw))},n._clearProjection=function(){this._pnw=null,e.prototype._clearProjection.call(this)},n._computeCenter=function(e){return e.locate(this._coordinates,this._width/2,-this._height/2)},n._containsPoint=function(t,n){var i=this.getMap();if(i.isTransforming())return e.prototype._containsPoint.call(this,t,n);var s=h(n)?this._hitTestTolerance():n,o=i._getResolution()*s,a=this._getPrjExtent().expand(o),l=i._containerPointToPrj(t);return a.contains(l)},n._computePrjExtent=function(e){if(this.isRotated())return this._computeRotatedPrjExtent();var t=this._getSouthEast(e);if(!t)return null;var n=e.projectCoords([new fl(this._coordinates.x,t.y),new fl(t.x,this._coordinates.y)],this.options.antiMeridian);return new Ml(n[0],n[1])},n._computeExtent=function(e){var t=this._getSouthEast(e);return t?new Ml(this._coordinates,t,this._getProjection()):null},n._getSouthEast=function(e){if(!e||!this._coordinates||h(this._width)||h(this._height))return null;var t=this.getWidth(),n=-this.getHeight();if(e.fullExtent){var i=e.fullExtent;t*=i.right>i.left?1:-1,n*=i.top>i.bottom?1:-1}var s=e.locate(this._coordinates,t,0),o=e.locate(this._coordinates,0,n);return s.y=o.y,s},n._computeGeodesicLength=function(){return h(this._width)||h(this._height)?0:2*(this._width+this._height)},n._computeGeodesicArea=function(){return h(this._width)||h(this._height)?0:this._width*this._height},n._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:fl.toNumberArrays([this.getShell()])}},n._toJSON=function(e){var t=l({},e),n=this.getCoordinates();t.geometry=!1;var i=this.toGeoJSON(t);return i.geometry={type:"Polygon"},{feature:i,subType:"Rectangle",coordinates:n.toArray(),width:this.getWidth(),height:this.getHeight()}},t}(df);Hf.registerJSONType("Rectangle");var Nf=function(e){function t(t,n,i,s,o){var a;return(a=e.call(this,t,n,o)||this).startAngle=i,a.endAngle=s,a}Te(t,e),t.fromJSON=function(e){var n=e.feature,i=new t(e.coordinates,e.radius,e.startAngle,e.endAngle,e.options);return i.setProperties(n.properties),i};var n=t.prototype;return n.getStartAngle=function(){return this.startAngle},n.setStartAngle=function(e){return this.startAngle=e,this.onShapeChanged(),this},n.getEndAngle=function(){return this.endAngle},n.setEndAngle=function(e){return this.endAngle=e,this.onShapeChanged(),this},n._correctAngles=function(){var e=this.getStartAngle(),t=this.getEndAngle();if(t<e)return console.error("The ending angle should be greater than the starting angle ",e,t),[0,0];return t-e>360?(console.error("The difference between the end angle and the start angle is greater than 360 degrees ",e,t),[0,0]):(e<0&&(e+=360,t+=360),[e,t])},n.getShell=function(){return this.isRotated()?this.getRotatedShell():this._getShell()},n._getShell=function(){for(var e,t,n,[i,s]=this._correctAngles(),o=this._getMeasurer(),a=this.getCoordinates(),l=this.options.numberOfShellPoints-2,h=this.getRadius(),c=[a.copy()],u=s-i,f=0;f<l;f++){e=(u*f/(l-1)+i)*Math.PI/180,t=h*Math.cos(e),n=h*Math.sin(e);var g=o.locate(a,t,n);g.z=a.z,c.push(g)}return c.push(a.copy()),c},n.getRotateOffsetAngle=function(){return 90},n._getPrjShell=function(){var t=e.prototype._getPrjShell.call(this);return this._rotatePrjCoordinates(t)},n._computePrjExtent=function(){return this.isRotated()?this._computeRotatedPrjExtent():Lf.prototype._computePrjExtent.apply(this,arguments)},n._containsPoint=function(e,t){return gu.prototype._containsPoint.call(this,e,t)},n._computeGeodesicLength=function(){if(h(this._radius))return 0;var[e,t]=this._correctAngles();return 2*Math.PI*this._radius*Math.abs(e-t)/360+2*this._radius},n._computeGeodesicArea=function(){if(h(this._radius))return 0;var[e,t]=this._correctAngles();return Math.PI*Math.pow(this._radius,2)*Math.abs(e-t)/360},n._toJSON=function(e){var t=l({},e),n=this.getCenter();t.geometry=!1;var i=this.toGeoJSON(t);return i.geometry={type:"Polygon"},{feature:i,subType:"Sector",coordinates:n.toArray(),radius:this.getRadius(),startAngle:this.getStartAngle(),endAngle:this.getEndAngle()}},t}(Lf);Nf.mergeOptions({numberOfShellPoints:60}),Nf.registerJSONType("Sector");var Bf=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n._arc=function(e,t,n){var i=this.options.arcDegree;0===i&&(i=1);for(var s=i*Math.PI/180,o=1,a=t.length;o<a;o++)Ea._arcBetween(e,t[o-1],t[o],s),Ea._stroke(e,n)},n._quadraticCurve=function(e,t){if(t.length<=2)Ea._path(e,t);else{var n,i;for(n=2,i=t.length;n<i;n+=2)e.quadraticCurveTo(t[n-1].x,t[n-1].y,t[n].x,t[n].y);if((n-=1)<i)for(;n<i;n++)e.lineTo(t[n].x,t[n].y)}},n._bezierCurve=function(e,t){if(t.length<=3)Ea._path(e,t);else{var n,i;for(n=1,i=t.length;n+2<i;n+=3)e.bezierCurveTo(t[n].x,t[n].y,t[n+1].x,t[n+1].y,t[n+2].x,t[n+2].y);if(n<i)for(;n<i;n++)e.lineTo(t[n].x,t[n].y)}},n._getCurveArrowPoints=function(e,t,n,i,s,o){var a,l=t.length;for(a=o;a<l;a+=o){var h=this._getArrowShape(t[a-1],t[a],n,i,s);h&&e.push(h)}if((a-=o)<l-1)for(a+=1;a<l;a++){var c=this._getArrowShape(t[a-1],t[a],n,i,s);c&&e.push(c)}},t}(yf);Bf.mergeOptions({enableSimplify:!1,enableClip:!1});var zf=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n._toJSON=function(e){return{feature:this.toGeoJSON(e),subType:"ArcCurve"}},n._paintOn=function(e,t,n){e.beginPath(),this._arc(e,t,n),Ea._stroke(e,n),this._paintArrow(e,t,n)},t.fromJSON=function(e){var n=e.feature,i=new t(n.geometry.coordinates,e.options);return i.setProperties(n.properties),i},t}(Bf);zf.registerJSONType("ArcCurve"),zf.mergeOptions({arcDegree:90});var Gf=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e),t.fromJSON=function(e){var n=e.feature,i=new t(n.geometry.coordinates,e.options);return i.setProperties(n.properties),i};var n=t.prototype;return n._toJSON=function(e){return{feature:this.toGeoJSON(e),subType:"CubicBezierCurve"}},n._paintOn=function(e,t,n){e.beginPath(),e.moveTo(t[0].x,t[0].y),this._bezierCurve(e,t),Ea._stroke(e,n),this._paintArrow(e,t,n)},n._getArrowPoints=function(e,t,n,i,s){return this._getCurveArrowPoints(e,t,n,i,s,3)},t}(Bf);Gf.registerJSONType("CubicBezierCurve");var Uf=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e),t.fromJSON=function(e){var n=e.feature,i=new t(n.geometry.coordinates,e.options);return i.setProperties(n.properties),i};var n=t.prototype;return n._toJSON=function(e){return{feature:this.toGeoJSON(e),subType:"QuadBezierCurve"}},n._paintOn=function(e,t,n){e.beginPath(),e.moveTo(t[0].x,t[0].y),this._quadraticCurve(e,t,n),Ea._stroke(e,n),this._paintArrow(e,t,n)},n._getArrowPoints=function(e,t,n,i,s){return this._getCurveArrowPoints(e,t,n,i,s,2)},t}(Bf);Uf.registerJSONType("QuadBezierCurve");var Vf={textFaceName:"monospace",textSize:12,textLineSpacing:8,textWrapCharacter:"\n",textHorizontalAlignment:"middle",textVerticalAlignment:"middle"},jf={markerType:"square",markerLineColor:"#000",markerLineWidth:2,markerLineOpacity:1,markerFill:"#fff",markerOpacity:1},Wf=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.getContent=function(){return this._content},n.setContent=function(e){var t=this._content;return this._content=Nt(e),this._refresh(),this._fireEvent("contentchange",{old:t,new:e}),this},n.onAdd=function(){this._refresh()},n.toJSON=function(){var t=e.prototype.toJSON.call(this);return delete t.symbol,t},n.setSymbol=function(t){if(this._refreshing||!t)return e.prototype.setSymbol.call(this,t);var n=this._parseSymbol(t);if(this.setTextStyle){var i=this.getTextStyle()||{};i.symbol=n[0],this.setTextStyle(i)}else this.setTextSymbol&&this.setTextSymbol(n[0]);if(this.setBoxStyle){var s=this.getBoxStyle()||{};s.symbol=n[1],this.setBoxStyle(s)}else this.setBoxSymbol&&this.setBoxSymbol(n[1]);return this},n._parseSymbol=function(e){var t={},n={};for(var i in e)w(e,i)&&(0===i.indexOf("text")?t[i]=e[i]:n[i]=e[i]);return[t,n]},n._getTextSize=function(e){return en(this._content,e).size},n._getInternalSymbol=function(){return this._symbol},n._getDefaultTextSymbol=function(){return l({},Vf)},n._getDefaultBoxSymbol=function(){return l({},jf)},n._getDefaultPadding=function(){return[12,8]},t}(mf),qf=function(e){function t(t,n,i,s,o={}){var a;return(a=e.call(this,n,o)||this)._content=Nt(t),a._width=h(i)?100:i,a._height=h(s)?40:s,o.boxSymbol&&a.setBoxSymbol(o.boxSymbol),o.textStyle&&a.setTextStyle(o.textStyle),a._refresh(),a}Te(t,e);var n=t.prototype;return n.getWidth=function(){return this._width},n.setWidth=function(e){return this._width=e,this._refresh(),this},n.getHeight=function(){return this._height},n.setHeight=function(e){return this._height=e,this._refresh(),this},n.getBoxSymbol=function(){return l({},this.options.boxSymbol)},n.setBoxSymbol=function(e){return this.options.boxSymbol=e?l({},e):e,this.getSymbol()&&this._refresh(),this},n.getTextStyle=function(){return this.options.textStyle?l({},this.options.textStyle):null},n.setTextStyle=function(e){return this.options.textStyle=e?l({},e):e,this.getSymbol()&&this._refresh(),this},t.fromJSON=function(e){var n=e.feature,i=new t(e.content,n.geometry.coordinates,e.width,e.height,e.options);return i.setProperties(n.properties),i.setId(n.id),e.symbol&&i.setSymbol(e.symbol),i},n._toJSON=function(e){return{feature:this.toGeoJSON(e),width:this.getWidth(),height:this.getHeight(),subType:"TextBox",content:this._content}},n._refresh=function(){var e,t,n=this.getTextStyle()||{},i=n.padding||[12,8];if(Rr(this._width)){var s=(e=JSON.parse(JSON.stringify(this._width))).stops;if(s)for(var o=0;o<s.length;o++)s[o][1]=s[o][1]-2*i[0]}else e=this._width-2*i[0];if(Rr(this._height)){var a=(t=JSON.parse(JSON.stringify(this._height))).stops;if(a)for(var h=0;h<a.length;h++)a[h][1]=a[h][1]-2*i[1]}else t=this._height-2*i[1];var c=l({},n.symbol||this._getDefaultTextSymbol(),this.options.boxSymbol||this._getDefaultBoxSymbol(),{textName:this._content,markerWidth:this._width,markerHeight:this._height,textHorizontalAlignment:"middle",textVerticalAlignment:"middle",textMaxWidth:e,textMaxHeight:t});n.wrap&&!c.textWrapWidth&&(c.textWrapWidth=e);var u,f=n.horizontalAlignment;if(c.textDx=c.markerDx||0,Rr(this._width)){var g=(u=JSON.parse(JSON.stringify(this._width))).stops;if(g)for(var m=0;m<g.length;m++)g[m][1]=g[m][1]/2-i[0],"left"===f&&(g[m][1]*=-1)}else u=c.markerWidth/2-i[0],"left"===f&&(u*=-1);"left"===f?(c.textHorizontalAlignment="right",c.textDx=u):"right"===f&&(c.textHorizontalAlignment="left",c.textDx=u);var A,w=n.verticalAlignment;if(c.textDy=c.markerDy||0,Rr(this._height)){var T=(A=JSON.parse(JSON.stringify(this._height))).stops;if(T)for(var S=0;S<T.length;S++)T[S][1]=T[S][1]/2-i[1],"top"===w&&(T[S][1]*=-1)}else A=c.markerHeight/2-i[1],"top"===w&&(A*=-1);"top"===w?(c.textVerticalAlignment="bottom",c.textDy=A):"bottom"===w&&(c.textVerticalAlignment="top",c.textDy=A),this._refreshing=!0,this.updateSymbol(c),delete this._refreshing},n.startEdit=function(t){var n=this._getCompiledSymbol();if(Rr(this._width)){var i=n.markerWidth;this._oldWidth=this._width,this.setWidth(i)}if(Rr(this._height)){var s=n.markerHeight;this._oldHeight=this._height,this.setHeight(s)}return e.prototype.startEdit.call(this,t)},n.endEdit=function(){var t=this.getMap(),n=t&&t.getZoom();if(this._oldWidth){for(var i=this._width/Dr(this._oldWidth)(n),s=this._oldWidth.stops,o=0;o<s.length;o++)s[o][1]*=i;this.setWidth(this._oldWidth),delete this._oldWidth}if(this._oldHeight){for(var a=this._height/Dr(this._oldHeight)(n),l=this._oldHeight.stops,h=0;h<l.length;h++)l[h][1]*=a;this.setHeight(this._oldHeight),delete this._oldHeight}return e.prototype.endEdit.call(this)},t}(Wf);qf.mergeOptions({textStyle:{wrap:!0,padding:[12,8],verticalAlignment:"middle",horizontalAlignment:"middle"},boxSymbol:null}),qf.registerJSONType("TextBox");var Zf=function(e){function t(t,n,i={}){var s;return s=e.call(this,n,i)||this,i.textSymbol&&s.setTextSymbol(i.textSymbol),i.boxStyle&&s.setBoxStyle(i.boxStyle),s._content=Nt(t),s._refresh(),s}Te(t,e);var n=t.prototype;return n.getBoxStyle=function(){return this.options.boxStyle?l({},this.options.boxStyle):null},n.setBoxStyle=function(e){return this.options.boxStyle=e?l({},e):e,this._refresh(),this},n.getTextSymbol=function(){return l({},this._getDefaultTextSymbol(),this.options.textSymbol)},n.setTextSymbol=function(e){return this.options.textSymbol=e?l({},e):e,this._refresh(),this},t.fromJSON=function(e){var n=e.feature,i=new t(e.content,n.geometry.coordinates,e.options);return i.setProperties(n.properties),i.setId(n.id),e.symbol&&i.setSymbol(e.symbol),i},n._canEdit=function(){return!1},n._toJSON=function(e){return{feature:this.toGeoJSON(e),subType:"Label",content:this._content}},n._refresh=function(){var e=l({},this.getTextSymbol(),{textName:this._content}),t=this.getBoxStyle();if(t){l(e,t.symbol);var n=this._getBoxSize(e),i=n[1],s=t.padding||this._getDefaultPadding(),o=n[0];e.markerWidth=o.width,e.markerHeight=o.height;var a=e.textDx||0,h=e.textDy||0,c=Yt(i,e.textHorizontalAlignment,e.textVerticalAlignment)._add(a,h),u=t.horizontalAlignment||"middle";e.markerDx=c.x,"left"===u?e.markerDx+=e.markerWidth/2-s[0]:"right"===u?e.markerDx-=e.markerWidth/2-i.width-s[0]:e.markerDx+=i.width/2;var f=t.verticalAlignment||"middle";e.markerDy=c.y,"top"===f?e.markerDy+=e.markerHeight/2-s[1]:"bottom"===f?e.markerDy-=e.markerHeight/2-i.height-s[1]:e.markerDy+=i.height/2}this._refreshing=!0,this.updateSymbol(e),delete this._refreshing},n._getBoxSize=function(e){e.markerType||(e.markerType="square");var t,n,i=this.getBoxStyle(),s=this._getTextSize(e),o=i.padding||this._getDefaultPadding();return t=s.width+2*o[0],n=s.height+2*o[1],i.minWidth&&(!t||t<i.minWidth)&&(t=i.minWidth),i.minHeight&&(!n||n<i.minHeight)&&(n=i.minHeight),[new Ot(t,n),s]},t}(Wf);Zf.mergeOptions({boxStyle:null,textSymbol:null}),Zf.registerJSONType("Label");var Xf=function(e){return function(e){function t(...t){return e.call(this,...t)||this}Te(t,e),t._hasConnectors=function(e){return!h(e.__connectors)&&e.__connectors.length>0},t._getConnectors=function(e){return e.__connectors};var n=t.prototype;return n.getConnectSource=function(){return this._connSource},n.setConnectSource=function(e){var t=this._connTarget;return this.onRemove(),this._connSource=e,this._connTarget=t,this.onAdd(),this},n.getConnectTarget=function(){return this._connTarget},n.setConnectTarget=function(e){var t=this._connSource;return this.onRemove(),this._connSource=t,this._connTarget=e,this._updateCoordinates(),this._registerEvents(),this},n._updateCoordinates=function(){var e=this.getMap();if(!e&&this._connSource&&(e=this._connSource.getMap()),!e&&this._connTarget&&(e=this._connTarget.getMap()),e&&this._connSource&&this._connTarget){for(var t,n,i=this._connSource._getConnectPoints(),s=this._connTarget._getConnectPoints(),o=0,a=this.getCoordinates(),l=0,h=i.length;l<h;l++)for(var c=i[l],u=0,f=s.length;u<f;u++){var g=s[u],m=e.computeLength(c,g);0===l&&0===u?(t=c,n=g,o=m):m<o&&(t=c,n=g)}Ye(a)&&a[0].equals(t)&&a[1].equals(n)||this.setCoordinates([t,n])}},n.onAdd=function(){this._registerEvents(),this._updateCoordinates()},n.onRemove=function(){if(this._connSource&&(this._connSource.__connectors&&Ue(this,this._connSource.__connectors),this._connSource.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connSource.off("dragstart mousedown mouseover",this._showConnect,this),this._connSource.off("dragend mouseup mouseout",this.hide,this),this._connSource.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connSource),this._connTarget&&(Ue(this,this._connTarget.__connectors),this._connTarget.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connTarget.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connTarget),!(this._connSource instanceof gu&&this._connTarget instanceof gu)){var e=this.getMap();e&&e.off("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}},n._showConnect=function(){this._connSource&&this._connTarget&&this._connSource.isVisible()&&this._connTarget.isVisible()&&(this._updateCoordinates(),this.show())},n._registerEvents=function(){if(this._connSource&&this._connTarget){this._connSource.__connectors||(this._connSource.__connectors=[]),this._connTarget.__connectors||(this._connTarget.__connectors=[]),this._connSource.__connectors.push(this),this._connTarget.__connectors.push(this),this._connSource.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connTarget.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connSource.on("show",this._showConnect,this).on("hide",this.hide,this),this._connTarget.on("show",this._showConnect,this).on("hide",this.hide,this);var e=this.options.showOn;if(this.hide(),"moving"===e?(this._connSource.on("dragstart",this._showConnect,this).on("dragend",this.hide,this),this._connTarget.on("dragstart",this._showConnect,this).on("dragend",this.hide,this)):"click"===e?(this._connSource.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this),this._connTarget.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this)):"mouseover"===e?(this._connSource.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this),this._connTarget.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this)):this._showConnect(),!(this._connSource instanceof gu&&this._connTarget instanceof gu)){var t=this.getMap();t&&t.on("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}}},t}(e)},Yf={showOn:"always"},Jf=function(e){function t(t,n,i){var s;return s=e.call(this,null,i)||this,1===arguments.length&&(i=t,t=null,n=null),s._connSource=t,s._connTarget=n,s}return Te(t,e),t}(Xf(yf));Jf.mergeOptions(Yf),Jf.registerJSONType("ConnectorLine");var Qf=function(e){function t(t,n,i){var s;return s=e.call(this,null,i)||this,1===arguments.length&&(i=t,t=null,n=null),s._connSource=t,s._connTarget=n,s}return Te(t,e),t}(Xf(zf));function $f(e){return e&&e instanceof gu}Qf.mergeOptions(Yf),Qf.registerJSONType("ArcConnectorLine");var Kf=[],ed=function(e){function t(t,n,i){var s;n&&!$f(n)&&!Array.isArray(n)&&bt.indexOf(n.type)<0&&(i=n,n=null),(s=e.call(this,t,i)||this)._maxZIndex=0,s._minZIndex=0,s._initCache(),n&&s.addGeometry(n);var o=s.options.style;return o&&s.setStyle(o),s}Te(t,e);var n=t.prototype;return n.getAltitude=function(){return 0},n.getGeometryById=function(e){return h(e)||""===e?null:this._geoMap[e]?this._geoMap[e]:null},n.getGeometries=function(e,t){if(!e)return this._geoList.slice(0);for(var n,i=[],s=0,o=this._geoList.length;s<o;s++)n=this._geoList[s],(t?e.call(t,n):e(n))&&i.push(n);return i},n.getFirstGeometry=function(){return this._geoList.length?this._geoList[0]:null},n.getLastGeometry=function(){var e=this._geoList.length;return 0===e?null:this._geoList[e-1]},n.getCount=function(){return this._geoList.length},n.getExtent=function(){if(0===this.getCount())return null;var e=new Ml(this.getProjection());return this.forEach((function(t){e._combine(t.getExtent())})),e},n.forEach=function(e,t){for(var n=this._geoList.slice(0),i=0,s=n.length;i<s;i++)t?e.call(t,n[i],i):e(n[i],i);return this},n.filter=function(e,t){var n=[],i=m(e),s=i?e:Ur(e);return this.forEach((function(e){var o=i?e:Kr(e);(t?s.call(t,o):s(o))&&n.push(e)}),this),n},n.isEmpty=function(){return!this._geoList.length},n.addGeometry=function(e,t){if(!e)return this;if("FeatureCollection"===e.type)return this.addGeometry(Rf.toGeometry(e),t);if(!Array.isArray(e)){var n=arguments.length,i=arguments[n-1];return e=Array.prototype.slice.call(arguments,0,n-1),t=i,i&&f(i)&&("type"in i||$f(i))&&(e.push(i),t=!1),this.addGeometry(e,t)}if(0===e.length)return this;var s;this._initCache(),t&&(s=new Ml),this._toSort=this._maxZIndex>0;for(var o=[],a=0,c=e.length;a<c;a++){var u=e[a];if(!u||!Rf._isGeoJSON(u)&&!$f(u))throw new Error("Invalid geometry to add to layer("+this.getId()+") at index:"+a);if(!u.getLayer||u.getLayer()!==this){if(!$f(u)&&(u=gu.fromJSON(u),Array.isArray(u)))for(var g=0,A=u.length;g<A;g++)this._add(u[g],s,a),o.push(u[g]);if(!u)throw new Error("Invalid geometry to add to layer("+this.getId()+") at index:"+a);Array.isArray(u)||(this._add(u,s,a),o.push(u))}}var w=this.getMap();if(w&&(this._getRenderer().onGeometryAdd(o),s&&!h(s.xmin))){var T=s.getCenter(),S=w.getFitZoom(s);if(f(t)){var M=m(t.step)?t.step:function(){};w.animateTo({center:T,zoom:S},l({duration:w.options.zoomAnimationDuration,easing:"out"},t),M)}else!0===t&&w.setCenterAndZoom(T,S)}return this.fire("addgeo",{type:"addgeo",target:this,geometries:e}),this},n.getGeoMinZIndex=function(){return this._minZIndex},n.getGeoMaxZIndex=function(){return this._maxZIndex},n._add=function(e,t,n){this._toSort||(this._toSort=0!==e.getZIndex()),this._updateZIndex(e.getZIndex());var i=e.getId();if(!h(i)){if(!h(this._geoMap[i]))throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+i+", at index:"+n);this._geoMap[i]=e}var s=He();e._setInternalId(s),this._geoList.push(e),this.onAddGeometry(e),e._bindLayer(this),e.onAdd&&e.onAdd(),t&&t._combine(e.getExtent()),e._fireEvent("add",{layer:this}),this._cookedStyles&&this._styleGeometry(e)},n.removeGeometry=function(e){if(!Array.isArray(e))return this.removeGeometry([e]);for(var t=e.length-1;t>=0;t--)e[t]instanceof gu||(e[t]=this.getGeometryById(e[t])),e[t]&&this===e[t].getLayer()&&e[t].remove();return this},n.clear=function(){this._clearing=!0,this.forEach((function(e){e.remove()})),this._geoMap={};var e=this._geoList;this._geoList=[];var t=this._getRenderer();return t&&(t.onGeometryRemove(e),t.clearImageData&&(t.clearImageData(),delete t._lastGeosToDraw)),this._clearing=!1,this.fire("clear"),this},n.onRemoveGeometry=function(e){if(e&&!this._clearing&&(this===e.getLayer()&&!h(e._getInternalId()))){var t=e.getId();h(t)||delete this._geoMap[t];var n=this._findInList(e);n>=0&&this._geoList.splice(n,1),this._getRenderer()&&this._getRenderer().onGeometryRemove([e])}},n.getStyle=function(){return this.options.style?this.options.style:null},n.setStyle=function(e){return this.options.style=e,e=Ti(e),this._cookedStyles=ei(e),this.forEach((function(e){this._styleGeometry(e)}),this),this.fire("setstyle",{type:"setstyle",target:this,style:e}),this},n._styleGeometry=function(e){if(!this._cookedStyles)return!1;for(var t=Kr(e),n=0,i=this._cookedStyles.length;n<i;n++)if(!0===this._cookedStyles[n].filter(t))return e._setExternSymbol(this._cookedStyles[n].symbol),!0;return!1},n.removeStyle=function(){return this.options.style?(delete this.options.style,delete this._cookedStyles,this.forEach((function(e){e._setExternSymbol(null)}),this),this.fire("removestyle"),this):this},n.onAddGeometry=function(e){this.getStyle()&&this._styleGeometry(e)},n.hide=function(){for(var e=0,t=this._geoList.length;e<t;e++)this._geoList[e].onHide();return Lu.prototype.hide.call(this)},n._initCache=function(){this._geoList||(this._geoList=[],this._geoMap={})},n._updateZIndex=function(...e){this._maxZIndex=Math.max(this._maxZIndex,Math.max(...e)),this._minZIndex=Math.min(this._minZIndex,Math.min(...e))},n._sortGeometries=function(){var e=this;this._toSort&&(this._maxZIndex=0,this._minZIndex=0,this._geoList.sort((function(t,n){return e._updateZIndex(t.getZIndex(),n.getZIndex()),e._compare(t,n)})),this._toSort=!1)},n._compare=function(e,t){return e.getZIndex()===t.getZIndex()?e._getInternalId()-t._getInternalId():e.getZIndex()-t.getZIndex()},n._findInList=function(e){var t=this._geoList.length;if(0===t)return-1;this._sortGeometries();for(var n,i=0,s=t-1;i<=s;){if(n=Math.floor((i+s)/2),this._geoList[n]===e)return n;this._compare(this._geoList[n],e)>0?s=n-1:i=n+1}return-1},n.onGeometryEvent=function(e){return this._onGeometryEvent(e)},n._onGeometryEvent=function(e){if(e&&e.target){var t=e.type;"idchange"===t?this._onGeometryIdChange(e):"zindexchange"===t?this._onGeometryZIndexChange(e):"positionchange"===t?this._onGeometryPositionChange(e):"shapechange"===t?this._onGeometryShapeChange(e):"symbolchange"===t?this._onGeometrySymbolChange(e):"show"===t?this._onGeometryShow(e):"hide"===t?this._onGeometryHide(e):"propertieschange"===t&&this._onGeometryPropertiesChange(e)}},n._onGeometryIdChange=function(e){if(e.new!==e.old||!this._geoMap[e.old]||this._geoMap[e.old]!==e.target){if(!h(e.new)){if(this._geoMap[e.new])throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+e.new);this._geoMap[e.new]=e.target}h(e.old)||e.new===e.old||delete this._geoMap[e.old]}},n._onGeometryZIndexChange=function(e){e.old!==e.new&&(this._updateZIndex(e.new),this._toSort=!0,this._getRenderer()&&this._getRenderer().onGeometryZIndexChange(e))},n._onGeometryPositionChange=function(e){this._getRenderer()&&this._getRenderer().onGeometryPositionChange(e)},n._onGeometryShapeChange=function(e){this._getRenderer()&&this._getRenderer().onGeometryShapeChange(e)},n._onGeometrySymbolChange=function(e){this._getRenderer()&&this._getRenderer().onGeometrySymbolChange(e)},n._onGeometryShow=function(e){this._getRenderer()&&this._getRenderer().onGeometryShow(e)},n._onGeometryHide=function(e){this._getRenderer()&&this._getRenderer().onGeometryHide(e)},n._onGeometryPropertiesChange=function(e){this._getRenderer()&&this._getRenderer().onGeometryPropertiesChange(e)},n._hasGeoListeners=function(e){if(!e)return!1;Array.isArray(e)||(Kf[0]=e,e=Kf);for(var t=this.getGeometries()||[],n=0,i=t.length;n<i;n++){var s=t[n];if(s){if(s.options.cursor)return!0;for(var o=0,a=e.length;o<a;o++){if(s.listens(e[o])>0)return!0}}}return!1},n._getRenderer=function(){return e.prototype._getRenderer.call(this)},t}(Lu);ed.mergeOptions({drawImmediate:!1,geometryEvents:!0,geometryEventTolerance:1});var td=function(e){function t(n,i,s={}){var o;return i&&!$f(i)&&!Array.isArray(i)&&bt.indexOf(i.type)<0&&(s=i,i=null),o=e.call(this,n,s)||this,s.sceneConfig={depthFunc:o.options.depthFunc||"always"},o._markerLayer=new t.markerLayerClazz(n+"_____________marker",s),o._lineLayer=new t.lineLayerClazz(n+"_____________line",s),o._polygonLayer=new t.polygonLayerClazz(n+"_____________polygon",s),i&&o.addGeometry(i),o}Te(t,e),t.setLayerClass=function(e,n,i){t.markerLayerClazz=e,t.lineLayerClazz=n,t.polygonLayerClazz=i};var n=t.prototype;return n.bringToFront=function(){return this._polygonLayer.bringToFront(),this._lineLayer.bringToFront(),this._markerLayer.bringToFront(),this},n.addGeometry=function(e){Array.isArray(e)||(e=[e]),ze(this._geoList,e);for(var t=0;t<e.length;t++)this._markerLayer.isVectorLayer||e[t]instanceof mf||e[t]instanceof Tf?this._markerLayer.addGeometry(e[t]):e[t]instanceof yf||e[t]instanceof Mf?this._lineLayer.addGeometry(e[t]):(e[t]instanceof df||e[t]instanceof Cf)&&this._polygonLayer.addGeometry(e[t])},n.removeGeometry=function(e){Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++)this._geoList.splice(e[t],1),this._markerLayer.isVectorLayer||e[t]instanceof mf||e[t]instanceof Tf?this._markerLayer.removeGeometry(e[t]):e[t]instanceof yf||e[t]instanceof Mf?this._lineLayer.removeGeometry(e[t]):(e[t]instanceof df||e[t]instanceof Cf)&&this._polygonLayer.removeGeometry(e[t])},n._onRemoveDrawToolGeo=function(e){for(var t=e.geometries,n=0;n<t.length;n++)t[n]&&this._geoList.splice(t[n],1)},n.onRemove=function(){return this._geoList=[],this._markerLayer.off("removegeo",this._onRemoveDrawToolGeo,this),this._lineLayer.off("removegeo",this._onRemoveDrawToolGeo,this),this._polygonLayer.off("removegeo",this._onRemoveDrawToolGeo,this),this._markerLayer.remove(),this._lineLayer.remove(),this._polygonLayer.remove(),delete this._markerLayer,delete this._lineLayer,delete this._polygonLayer,e.prototype.onRemove.call(this)},n.onAdd=function(){var t=this.getMap();return this._polygonLayer.addTo(t),this._lineLayer.addTo(t),this._markerLayer.addTo(t),this._markerLayer.on("removegeo",this._onRemoveDrawToolGeo,this),this._lineLayer.on("removegeo",this._onRemoveDrawToolGeo,this),this._polygonLayer.on("removegeo",this._onRemoveDrawToolGeo,this),e.prototype.onAdd.call(this)},n.getRenderer=function(){return this._getRenderer()},n._getRenderer=function(){return this._markerLayer.getRenderer()},t}(ed);td.mergeOptions({renderer:null});var nd="_map_tool",rd=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.addTo=function(e){return e?(this._map=e,e[nd]&&e[nd].disable(),this.onAdd&&this.onAdd(),this.enable(),e[nd]=this,this._fireEvent("add"),this):this},n.getMap=function(){return this._map},n.enable=function(){return!this._map||this._enabled||(this._enabled=!0,this._switchEvents("off"),this._registerEvents(),this.onEnable&&this.onEnable(),this._fireEvent("enable")),this},n.disable=function(){return this._enabled&&this._map?(this._enabled=!1,this._switchEvents("off"),this.onDisable&&this.onDisable(),this._fireEvent("disable"),this):this},n.isEnabled=function(){return!!this._enabled},n.remove=function(){return this._map?(this.disable(),this._map&&(delete this._map[nd],delete this._map),this._fireEvent("remove"),this):this},n._registerEvents=function(){this._switchEvents("on")},n._switchEvents=function(e){var t=this.getEvents();t&&this._map[e](t,this)},n._fireEvent=function(e,t){t||(t={}),this.fire(e,t)},t}(Ba(Ua)),id={symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:.3},doubleClickZoom:!1,mode:null,once:!1,autoPanAtEdge:!1,ignoreMouseleave:!0,blockGeometryEvents:!1,zIndex:Number.MAX_VALUE,enableAltitude:!0,interactive:!0,transformCoordinate:null},sd={},od=function(e){function t(t){var n;return(n=e.call(this,t)||this)._checkMode(),n._events={click:n._clickHandler,"mousemove touchmove":n._mouseMoveHandler,dblclick:n._doubleClickHandler,"mousedown touchstart":n._mouseDownHandler,"mouseup touchend":n._mouseUpHandler,mousemove:n._mouseMoveHandler,mousedown:n._mouseDownHandler,mouseup:n._mouseUpHandler},n}Te(t,e),t.registerMode=function(e,t){sd[e.toLowerCase()]=t},t.getRegisterMode=function(e){return sd[e.toLowerCase()]};var n=t.prototype;return n.getMode=function(){return this.options.mode?this.options.mode.toLowerCase():null},n.setMode=function(e){return this._geometry&&(this._geometry.remove(),delete this._geometry),this._clearStage(),this._switchEvents("off"),this.options.mode=e,this._checkMode(),this.isEnabled()&&(this._switchEvents("on"),this._restoreMapCfg(),this._saveMapCfg()),this},n.getSymbol=function(){var e=this.options.symbol;return wi(e||this.options.symbol)},n.setSymbol=function(e){return e?(this.options.symbol=e,this._geometry&&this._geometry.setSymbol(e),this):this},n.getCurrentGeometry=function(){return this._geometry},n.onAdd=function(){this._checkMode()},n.onEnable=function(){this._saveMapCfg(),this._drawToolLayer=this._getDrawLayer(),this._clearStage(),this._loadResources();var e=this.getMap();return this.options.autoPanAtEdge&&(this._mapAutoPanAtEdge=e.options.autoPanAtEdge,this._mapAutoPanAtEdge||e.config({autoPanAtEdge:!0})),this._geometryEvents=e.options.geometryEvents,this.options.blockGeometryEvents&&e.config("geometryEvents",!1),this},n.onDisable=function(){var e=this.getMap();return this._restoreMapCfg(),this.endDraw({ignoreEndEvent:!0}),this._map&&(e.removeLayer(this._getDrawLayer()),this.options.autoPanAtEdge&&(this._mapAutoPanAtEdge||e.config({autoPanAtEdge:!1}))),this.options.blockGeometryEvents&&e.config("geometryEvents",this._geometryEvents),this},n.undo=function(){var e=this._getRegisterMode();if(!this._shouldRecordHistory(e.action)||!this._historyPointer)return this;var t=this._clickCoords.slice(0,--this._historyPointer);return e.update(this.getMap().getProjection(),t,this._geometry),this},n.redo=function(){var e=this._getRegisterMode();if(!this._shouldRecordHistory(e.action)||h(this._historyPointer)||this._historyPointer===this._clickCoords.length)return this;var t=this._clickCoords.slice(0,++this._historyPointer);return e.update(this.getMap().getProjection(),t,this._geometry),this},n._shouldRecordHistory=function(e){return Array.isArray(e)&&"click"===e[0]&&"mousemove"===e[1]&&"dblclick"===e[2]},n._checkMode=function(){this._getRegisterMode()},n._saveMapCfg=function(){var e=this.getMap();this._mapDoubleClickZoom=e.options.doubleClickZoom,e.config({doubleClickZoom:this.options.doubleClickZoom});for(var t=this._getRegisterMode().action,n=!1,i=0;i<t.length;i++)if(t[i].indexOf("mousedown")>=0||t[i].indexOf("touchstart")>=0){n=!0;break}if(n){var s=this.getMap();this._mapDraggable=s.options.draggable,s.config({draggable:!1})}},n._restoreMapCfg=function(){var e=this.getMap();e.config({doubleClickZoom:this._mapDoubleClickZoom}),h(this._mapDraggable)||e.config("draggable",this._mapDraggable),delete this._mapDraggable,delete this._mapDoubleClickZoom},n._loadResources=function(){var e=di(this.getSymbol());e.length>0&&this._drawToolLayer.getRenderer().loadResources(e)},n._getProjection=function(){return this._map.getProjection()},n._getRegisterMode=function(){var e=this.getMode(),n=t.getRegisterMode(e);if(!n)throw new Error(e+" is not a valid mode of DrawTool.");return n},n.getEvents=function(){var e=this._getRegisterMode().action,t={};if(Array.isArray(e)){for(var n=0;n<e.length;n++)t[e[n]]=this._events[e[n]];return t}return null},n._mouseDownHandler=function(e){(null==e?void 0:e.coordinate)&&this._createGeometry(e)},n._mouseUpHandler=function(e){(null==e?void 0:e.coordinate)&&this.endDraw(e)},n._clickHandler=function(e){if(null==e?void 0:e.coordinate){if(!this.options.interactive)return this;e.enableAltitude=this.options.enableAltitude;var t=this.getMap(),n=this._getRegisterMode();if(this._clickCoords&&this._clickCoords.length){var i=this._clickCoords.length,s=t._pointToPrj(e.point2d);if(this._clickCoords[i-1].equals(s))return}if(this._geometry){var o=t._pointToPrj(e.point2d);h(this._historyPointer)||(this._clickCoords=this._clickCoords.slice(0,this._historyPointer));var a=this._geometry.snapTo;if(a&&m(a)){var l=this._getSnapResult(a,e.containerPoint);if(o=l.prjCoord,this._clickCoords=this._clickCoords.concat(l.effectedVertex),this._clickCoords[this._clickCoords.length-1].equals(o))return}if(this._clickCoords.push(o),this._historyPointer=this._clickCoords.length,e.drawTool=this,n.update(t.getProjection(),this._clickCoords,this._geometry,e),"point"===this.getMode())return void this.endDraw(e);this._fireEvent(this._clickCoords.length<=1?"drawstart":"drawvertex",e),n.clickLimit&&n.clickLimit===this._historyPointer&&this.endDraw(e)}else this._createGeometry(e)}},n._createGeometry=function(e){var t=this.getMode(),n=this.getMap(),i=this._getRegisterMode(),s=n._pointToPrj(e.point2d),o=this.getSymbol();if(!this._geometry){this._fireEvent("drawprepare",e),this._clickCoords=[s],e.drawTool=this,this._geometry=i.create(this.getMap().getProjection(),this._clickCoords,e),o&&"point"!==t?this._geometry.setSymbol(o):this.options.hasOwnProperty("symbol")&&this._geometry.setSymbol(this.options.symbol),this._addGeometryToStage(this._geometry),this._fireEvent("drawstart",e);var a=this._geometry.snapTo;if(a&&m(a)){var l=this._getSnapResult(a,e.containerPoint),h=this.getMap();if(h&&l)this._clickCoords=[l.prjCoord],i.update(h.getProjection(),this._clickCoords,this._geometry,e)}}"point"===t&&"mousemove"!==e.type&&this.endDraw(e)},n._mouseMoveHandler=function(e){if(null==e?void 0:e.coordinate){if(!this.options.interactive)return this;e.enableAltitude=this.options.enableAltitude;var t=this.getMap();if(t&&!t.isInteracting())if("point"!==this.getMode()||this._geometry){if(this._geometry){var n=this._getMouseContainerPoint(e);if(this._isValidContainerPoint(n)){var i=t._pointToPrj(e.point2d),s=[],o=this._geometry.snapTo;if(o&&m(o)){var a=this._getSnapResult(o,n);i=a.prjCoord,s=a.effectedVertex}var l=t.getProjection();e.drawTool=this;var h=this._getRegisterMode();if(this._shouldRecordHistory(h.action)){var c=this._clickCoords.slice(0,this._historyPointer);if(c&&c.length>0&&i.equals(c[c.length-1]))return;h.update(l,c.concat(s,[i]),this._geometry,e)}else h.update(l,i,this._geometry,e);this._fireEvent("mousemove",e)}}}else this._createGeometry(e)}},n._doubleClickHandler=function(e){if(null==e?void 0:e.coordinate){if(!this.options.interactive)return this;if(e.enableAltitude=this.options.enableAltitude,this._geometry){var t=this._getMouseContainerPoint(e);if(this._isValidContainerPoint(t)){var n=this._getRegisterMode(),i=this._clickCoords;if(i&&!(i.length<2)){var s=this.getMode();if(!(s&&s.indexOf("polygon")>-1&&i.length<3)){for(var o=this.getMap().getProjection(),a=[i[0]],l=1,h=i.length;l<h;l++)i[l].x===i[l-1].x&&i[l].y===i[l-1].y||a.push(i[l]);a.length<2||this._geometry&&this._geometry instanceof df&&a.length<3||(e.drawTool=this,n.update(o,a,this._geometry,e),this.endDraw(e))}}}}}},n._addGeometryToStage=function(e){this._getDrawLayer().addGeometry(e)},n.endDraw=function(e){if(!this._geometry||this._ending)return this;this._ending=!0;var t=this._geometry;return this._clearStage(),e=e||{},this._geometry=t,e.ignoreEndEvent||this._fireEvent("drawend",e),delete this._geometry,this.options.once&&this.disable(),delete this._ending,delete this._historyPointer,this._vertexes&&(this._vertexes=[]),this},n._clearStage=function(){this._getDrawLayer().clear(),delete this._geometry,delete this._clickCoords},n._getMouseContainerPoint=function(e){var t=this._getRegisterMode().action;return(t[0].indexOf("mousedown")>=0||t[0].indexOf("touchstart")>=0)&&Cn(e.domEvent),e.containerPoint},n._isValidContainerPoint=function(e){var t=this._map.getSize();return!(e.x<0||e.y<0)&&!(e.x>t.width||e.y>t.height)},n._getSnapResult=function(e,t){var n=this.getMap(),i=[];if(this.options.edgeAutoComplete){i.push(n.prjToContainerPoint(this._clickCoords[(this._historyPointer||1)-1]));var s=this._clickCoords[(this._historyPointer||1)-2];s&&i.push(n.prjToContainerPoint(s))}var o=e(t,i),a=n._containerPointToPrj(t=(o.effectedVertex?o.point:o)||t);return o.effectedVertex&&(o.effectedVertex=o.effectedVertex.map((function(e){return n._containerPointToPrj(e)}))),{prjCoord:a,effectedVertex:o.effectedVertex||[]}},n._getDrawLayer=function(){var e=vt+"drawtool",t=this._map.getLayer(e);return t||(t=new td(e,{enableSimplify:!1,enableAltitude:this.options.enableAltitude,zIndex:this.options.zIndex}),this._map.addLayer(t)),this._pushLayers(t),t},n._fireEvent=function(e,t){t||(t={}),t=l({},t),this._geometry&&(t.geometry=this._getRegisterMode().generate(this._geometry,{drawTool:this}),t.tempGeometry=this._geometry),rd.prototype._fireEvent.call(this,e,t)},n._pushLayers=function(e){var t=this;return e?(Array.isArray(e)||(e=[e]),this._layers=this._layers||[],e.forEach((function(e){-1===t._layers.indexOf(e)&&t._layers.push(e)})),this):this},n._outLayers=function(e){var t=this;return e?(Array.isArray(e)||(e=[e]),this._layers=this._layers||[],e.forEach((function(e){for(var n=0,i=t._layers.length;n<i;n++)if(e===t._layers[n]){t._layers.splice(n,1);break}})),this):this},n.setLayerZIndex=function(e){return c(e)?(this.options.zIndex=e,this._layers=this._layers||[],this._layers.forEach((function(t){t&&t.setZIndex&&t.setZIndex(e)})),this):this},n.addCoordinate=function(e){if(!this.isEnabled())return this;var t=this.getMap();if(!t)return this;e=new fl(e);var n=t._parseEventFromCoord(e);return this._clickHandler(n),this},n.getTempGeometry=function(){return this._geometry},t}(rd);od.mergeOptions(id);var ad=function(e){function t(t){var n;return(n=e.call(this,t)||this).drawTool=new od({mode:"boxZoom",ignoreMouseleave:!1}),n}Te(t,e);var n=t.prototype;return n.addHooks=function(){this.target.on("_mousedown",this._onMouseDown,this)},n.removeHooks=function(){this.target.off("_mousedown",this._onMouseDown,this),this.drawTool.isEnabled()&&this.drawTool.remove()},n._onMouseDown=function(e){this.target.options.boxZoom&&e.domEvent.shiftKey&&this.drawTool.setSymbol(this.target.options.boxZoomSymbol).on("drawend",this._boxZoom,this).addTo(this.target)},n._boxZoom=function(e){var t=this.target;this.drawTool.remove();var n=e.geometry,i=n.getCenter(),s=n.getSymbol(),o=new Ml(i,t.locateByPoint(i,s.markerWidth,s.markerHeight),t.getProjection()),a=t.getFitZoom(o);t._animateTo({center:o.getCenter(),zoom:a})},t}(Uu);zu.mergeOptions({boxZoom:!0,boxZoomSymbol:{markerType:"rectangle",markerLineWidth:3,markerLineColor:"#1bbc9b",markerLineDasharray:[10,5],markerFillOpacity:.1,markerFill:"#1bbc9b",markerWidth:1,markerHeight:1}}),zu.addOnLoadHook("addHandler","boxZoom",ad);var ld=30,hd=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.addHooks=function(){this.target&&this.target.on("_mousemove",this._onMouseMove,this)},n.removeHooks=function(){this.target&&this.target.off("_mousemove",this._onMouseMove,this)},n._onMouseMove=function(e){var t=this.target;if(t.options.autoPanAtEdge){var{containerPoint:n}=e,i=t.getContainerExtent();if(i){var s,{x:o,y:a}=n,{xmax:l,ymax:h}=i;o<ld&&(s=[Math.abs(o-ld),0]),a<ld&&(s=[0,Math.abs(a-ld)]),o+ld>l&&(s=[-Math.abs(o+ld-l),0]),a+ld>h&&(s=[0,-Math.abs(a+ld-h)]),s&&t.panBy(s,{duration:1})}}},t}(Uu);function cd(e,t){var n=e.bearing,i=t.getBearing();return!(i>=0&&n>180)&&!(i<=0&&n<-180)}function ud(e,t){var n=e.bearing,i=t.getBearing();i>=0&&n<0&&(e.bearing=180-Math.abs(n)+180),i<=0&&n>0&&(e.bearing=-180-(180-Math.abs(n))),i>=0&&n>0&&(e.bearing=-180-(180-Math.abs(n))),i<=0&&n<0&&(e.bearing=180-Math.abs(n)+180)}function fd(e,t,n){return e*(1-n)+t*n}zu.mergeOptions({autoPanAtEdge:!1}),zu.addOnLoadHook("addHandler","autoPanAtEdge",hd),zu.include({animateTo:function(e,t={},n){var i=this;(e=l({},this.getView(),e)).bearing=e.bearing%360,m(t)&&(n=t,t={}),t.counterclockwise&&ud(e,this),cd(e,this)&&this._validateView(e);var s=this.getProjection(),o=this.getView(),a={},c=!0;for(var u in e)if(w(e,u)&&!h(e[u])&&("prjCenter"===u||!h(o[u])))if(c=!1,"center"===u){var f=new fl(o[u]),g=new fl(e[u]);f.equals(g)||(a.center=[f,g])}else if("prjCenter"===u){var A=new fl(this._getPrjCenter()),T=new fl(e[u]);A.equals(T)||(a.prjCenter=[A,T])}else o[u]!==e[u]&&"around"!==u&&(a[u]=[o[u],e[u]]);if(c)return null;this._animPlayer&&(this._isInternalAnimation?"running"===this._animPlayer.playState&&(this._animPlayer.pause(),this._prevAnimPlayer=this._animPlayer):(delete this._prevAnimPlayer,this._stopAnim(this._animPlayer)));var S=e.around||null,M=this._getRenderer(),C=this._animPlayer=sf.animate(a,{easing:t.easing||"out",duration:t.duration||this.options.zoomAnimationDuration,framer:function(e){M.callInNextFrame(e)},repeat:t.repeat},(function(e){if(i.isRemoved())C.finish();else{if("running"===C.playState){if(e.styles.center)i._setPrjCenter(s.project(e.styles.center)),i.onMoving(i._parseEventFromCoord(i.getCenter()));else if(e.styles.prjCenter){i._setPrjCenter(e.styles.prjCenter),i.onMoving(i._parseEventFromCoord(i.getCenter()))}h(e.styles.zoom)||i.onZooming(e.styles.zoom,S),h(e.styles.pitch)||i._setPitch(e.styles.pitch),h(e.styles.bearing)||i._setBearing(e.styles.bearing),i._fireEvent("animating")}else"paused"===C.playState&&C!==i._mapAnimPlayer||(C._interupted||(a.center?i._setPrjCenter(s.project(a.center[1])):a.prjCenter&&i._setPrjCenter(a.prjCenter[1]),h(a.pitch)||i._setPitch(a.pitch[1]),h(a.bearing)||i._setBearing(a.bearing[1])),i._endAnim(C,a,S,t));n&&n(e)}}),this);return this._startAnim(a,S),C},_animateTo:function(e,t={},n){return this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._isInternalAnimation=!0,this._mapAnimPlayer=this.animateTo(e,t,n),delete this._isInternalAnimation,this._mapAnimPlayer},flyTo:function(e,t={},n){var i=this;(e=l({},this.getView(),e)).bearing=e.bearing%360,t.counterclockwise&&ud(e,this),cd(e,this)&&this._validateView(e),this._animPlayer&&(this._isInternalAnimation?"running"===this._animPlayer.playState&&(this._animPlayer.pause(),this._prevAnimPlayer=this._animPlayer):(delete this._prevAnimPlayer,this._stopAnim(this._animPlayer))),m(t)&&(n=t,t={}),t=l({curve:1.42},t);var s=this;function o(e,t){return s.getResolution(t)/s.getResolution(e)}var a=e.around||new Re(this.width/2,this.height/2),h=this.getMinZoom(),c=this.getMaxZoom(),u=this.getProjection(),f=this.getView(),g=f.zoom,A=f.bearing,w=f.pitch,T="zoom"in e?Xe(+e.zoom,h,c):g,S="bearing"in e?+e.bearing:A,M="pitch"in e?+e.pitch:w,C=u.project(e.center&&new fl(e.center)||this.getCenter()),I=o(T,g),E=u.project(this.getCenter()),D=C.sub(E),H=t.curve,N=Math.max(this.width,this.height),B=N/I,z=D.mag();if("minZoom"in t){var U=Xe(Math.min(t.minZoom,g,T),h,c),j=N/o(U,g);H=Math.sqrt(j/z*2)}var W=H*H;function q(e){var t=(B*B-N*N+(e?-1:1)*W*W*z*z)/(2*(e?B:N)*W*z);return Math.log(Math.sqrt(t*t+1)-t)}function Z(e){return(Math.exp(e)-Math.exp(-e))/2}function X(e){return(Math.exp(e)+Math.exp(-e))/2}var Y=q(0),J=function(e){return X(Y)/X(Y+H*e)},Q=function(e){return N*((X(Y)*function(e){return Z(e)/X(e)}(Y+H*e)-Z(Y))/W)/z},$=(q(1)-Y)/H;if(Math.abs(z)<1e-6||!isFinite($)){if(Math.abs(N-B)<1e-6)return this.animateTo(e,t,n);var K=B<N?-1:1;$=Math.abs(Math.log(B/N))/H,Q=function(){return 0},J=function(e){return Math.exp(K*H*e)}}var ee=this._getRenderer(),te=this._animPlayer=sf.animate({k:[0,1]},{easing:t.easing||"out",duration:t.duration||8,framer:function(e){ee.callInNextFrame(e)}},(function(s){if(i.isRemoved())te.finish();else{var o=s.styles.k,l=o*$,h=1/J(l),c={};if(e.center){var u=1===o?C:E.add(D.multi(Q(l)));c.prjCenter=[C,u]}if(g!==T){var f=1===o?T:i.getZoomForScale(h,g,!0);c.zoom=[g,f]}if(w!==M){var m=fd(w,M,o);c.pitch=[M,m]}if(A!==S){var I=fd(A,S,o);c.bearing=[S,I]}if("running"===te.playState){if(c.prjCenter)i._setPrjCenter(c.prjCenter[1]),i.onMoving(i._parseEventFromCoord(i.getCenter()));c.zoom&&i.onZooming(c.zoom[1],a),c.pitch&&i._setPitch(c.pitch[1]),c.bearing&&i._setBearing(c.bearing[1]),i._fireEvent("animating")}else"paused"===te.playState&&te!==i._mapAnimPlayer||(te._interupted||(c.prjCenter&&i._setPrjCenter(c.prjCenter[1]),c.pitch&&i._setPitch(c.pitch[1]),c.bearing&&i._setBearing(c.bearing[1])),i._endAnim(te,c,a,t));n&&n(s)}}),{});return this._startAnim({center:e.center,zoom:e.zoom!==g,pitch:M!==w,bearing:S!==A},a),this},isAnimating:function(){return!!this._animPlayer},isRotating:function(){return this.isDragRotating()||!!this._animRotating},_endAnim:function(e,t,n,i){delete this._animRotating;var s,o=e._interupted?"animateinterrupted":"animateend";if(e===this._animPlayer&&delete this._animPlayer,e===this._mapAnimPlayer&&delete this._mapAnimPlayer,t.center)s=e._interupted?this.getCenter():t.center[1],this.onMoveEnd(this._parseEventFromCoord(s));else if(t.prjCenter){var a;a=e._interupted?this._getPrjCenter():t.prjCenter[1];var l=this._parseEventFromCoord(this.getProjection().unproject(a));l.point2d=this._prjToPoint(a),this.onMoveEnd(l)}h(t.zoom)||(e._interupted?this.onZoomEnd(this.getZoom()):i.wheelZoom?this.onZooming(t.zoom[1],n):this.onZoomEnd(t.zoom[1])),o&&this._fireEvent(o),h(t.pitch)||this.getPitch()||this.getRenderer().setToRedraw(),i.wheelZoom||this._resumePrev(e)},_startAnim:function(e,t){this._animPlayer&&((e.center||e.prjCenter)&&this.onMoveStart(),e.zoom&&!this.isZooming()&&this.onZoomStart(e.zoom[1],t),(e.pitch||e.bearing)&&(this._animRotating=!0),this._fireEvent("animatestart"),this._animPlayer.play())},_stopAnim:function(e){e&&(delete this._animRotating,"finished"!==e.playState&&(e._interupted=!0,e.cancel()),e===this._animPlayer&&delete this._animPlayer,e===this._mapAnimPlayer&&delete this._mapAnimPlayer)},_resumePrev:function(e){if(this._prevAnimPlayer){var t=this._prevAnimPlayer;"paused"!==t.playState&&delete this._prevAnimPlayer,e!==t&&(this._animPlayer=t,t.play())}}});var dd=[60,120];function pd(e){e.stopPropagation(),e.preventDefault()}var gd=["dragstart","dragenter","dragend","dragleave","dragover"].join(" ").toString(),md="mousedown mouseup mouseover mouseout mouseenter mouseleave mousemove click dblclick contextmenu keypress touchstart touchmove touchend drop ";function Ad(e,t,n){var i=t[0],s=t[1],o=t[2],a=1/(n[3]*i+n[7]*s+n[11]*o+n[15]);return e[0]=(n[0]*i+n[4]*s+n[8]*o+n[12])*a,e[1]=(n[1]*i+n[5]*s+n[9]*o+n[13])*a,e[2]=(n[2]*i+n[6]*s+n[10]*o+n[14])*a,e}zu.include({_registerDomEvents:function(){var e=this._panels.mapWrapper||this._containerDOM;vn(e,md,this._handleDOMEvent,this),vn(e,gd,pd,this)},_removeDomEvents:function(){var e=this._panels.mapWrapper||this._containerDOM;bn(e,md,this._handleDOMEvent),bn(e,gd,pd)},_handleDOMEvent:function(e){if(e&&"drop"===e.type){e.stopPropagation(),e.preventDefault();var t=this._parseEvent(e,e.type);return t=l({},t,{dataTransfer:e.dataTransfer}),void this._fireEvent(e.type,t)}var n=this.options.clickTimeThreshold,i=e.type;if(!qn(i)||o.isTest||!this.options.mousemoveThrottleEnable||!Zn(this,this.options.mousemoveThrottleTime)){var s="mousedown"===i||"touchstart"===i&&(!e.touches||1===e.touches.length);s&&(this._domMouseDownTime=a(),this._domMouseDownView=this.getView());var h="contextmenu"===i&&function(e){if(!e._domMouseDownView)return!0;var t=e.getView(),n=e._domMouseDownView;return t.bearing!==n.bearing||t.pitch!==n.pitch}(this);if("contextmenu"===i){Mn(e);var c=this._domMouseDownTime;a()-c<=n&&!h&&this._fireDOMEvent(this,e,"dom:"+e.type)}else this._fireDOMEvent(this,e,"dom:"+e.type);if(!this._ignoreEvent(e)){var u,f=!1;if(s)this._mouseDownTime=a();else if("click"===i||"touchend"===i||"contextmenu"===i){if(!this._mouseDownTime)return;var g=this._mouseDownTime;if(delete this._mouseDownTime,a()-g>n){if("click"===i||"contextmenu"===i)return}else if("contextmenu"===i){if(h)return}else"touchend"===i&&(f=!0)}f&&(this._clickTime&&a()-this._clickTime<=n?(delete this._clickTime,u="dblclick",this._fireDOMEvent(this,e,"dom:dblclick")):(this._clickTime=a(),u="click",this._fireDOMEvent(this,e,"dom:click"))),this._ignoreEvent(e)||(this._fireDOMEvent(this,e,i),u&&this._fireDOMEvent(this,e,u))}}},_ignoreEvent:function(e){if(!e||!this._panels.control)return!1;var t,n=e.srcElement||e.target;if(n)for(;n&&n!==this._containerDOM;){if(n.className&&n.className.indexOf&&(n.className.indexOf("maptalks-control")>=0||n.className.indexOf("maptalks-ui")>=0&&t&&!t.eventsPropagation))return!0;t=n,n=n.parentNode}return!1},_isEventOutMap:function(e){var t=Rn(this._getActualEvent(e),this._containerDOM);return this._isContainerPointOutOfMap(t)},_isContainerPointOutOfMap:function(){var e=[0,0,0],t=[0,0,0],n=new eo(e,t),i=[0,0,0];return function(s){var o=this.getPitch();if(o>dd[0]&&o<dd[1]){if(this.getContainerPointRay(e,t,s,0,.5),n.setFromTo(e,t),!n.intersectGround(i))return!0;if(n.distanceToGround()<=0)return!0}return!1}}(),_wrapTerrainData:function(e){this.options.queryTerrainInMapEvents&&e.containerPoint&&!e.terrain&&(e.terrain=this._queryTerrainInfo(e.containerPoint))},_parseEvent:function(e,t){if(!e)return null;var n={domEvent:e};if("keypress"!==t){var i=this._getActualEvent(e);if(i&&void 0!==i.clientX){var s=Rn(i,this._containerDOM);n=l(n,{containerPoint:s,viewPoint:this.containerPointToViewPoint(s)}),this._isContainerPointOutOfMap(s)||(n=l(n,{coordinate:this.containerPointToCoord(s),point2d:this._containerPointToPoint(s)}))}}return this._wrapTerrainData(n),n},_parseEventFromCoord:function(e){var t=this.coordToContainerPoint(e);return{coordinate:e,containerPoint:t,viewPoint:this.containerPointToViewPoint(t),point2d:this.coordToPoint(e)}},_getActualEvent:function(e){return e.touches&&e.touches.length>0?e.touches[0]:e.changedTouches&&e.changedTouches.length>0?e.changedTouches[0]:e},_fireDOMEvent:function(e,t,n){var i=this;if(!this.isRemoved()){var s=this._parseEvent(t,n);if(s.coordinate||"keypress"===n||-1!==n.indexOf("dom:")){this._wrapTerrainData(s);var o=function(){i._fireEvent(s.domEvent&&s.domEvent._cancelBubble?"_"+n:n,s)};qn(n)?this.options.mousemoveThrottleEnable?this.getRenderer().callInNextFrame((function(){o()})):o():this._fireEvent(n,s)}}},_getEventParams:function(e){var t=this,n={domEvent:e},i=e.touches&&e.touches.length>0?e.touches[0]:e.changedTouches&&e.changedTouches.length>0?e.changedTouches[0]:e;if(i){var s=Rn(i,t.getContainer());n.coordinate=t.containerPointToCoordinate(s),n.containerPoint=s,n.viewPoint=t.containerPointToViewPoint(s),n.point2d=t._containerPointToPoint(s)}return this._wrapTerrainData(n),n}}),zu.addOnLoadHook("_registerDomEvents"),zu.mergeOptions({queryTerrainInMapEvents:!0}),zu.include({isFullScreen:function(){var e=document;return!!(e.webkitIsFullScreen||e.mozFullScreen||e.msFullscreenElement||e.fullscreenElement)},requestFullScreen:function(e){return this._fireEvent("fullscreenstart"),this._requestFullScreen(e||this._containerDOM),this._fireEvent("fullscreenend"),this},cancelFullScreen:function(){return this._cancelFullScreen(),this._fireEvent("cancelfullscreen"),this},_requestFullScreen:function(e){if(e.requestFullscreen)e.requestFullscreen();else if(e.mozRequestFullScreen)e.mozRequestFullScreen();else if(e.webkitRequestFullScreen)e.webkitRequestFullScreen();else if(e.msRequestFullScreen)e.msRequestFullScreen();else{var t="fullscreen=1,status=no,resizable=yes,top=0,left=0,scrollbars=no,titlebar=no,menubar=no,location=no,toolbar=no,z-look=yes,width="+(screen.availWidth-8)+",height="+(screen.availHeight-45);null!==window.open(location.href,"_blank",t)&&(window.opener=null,window.close())}},_cancelFullScreen:function(){var e=document;if(document.exitFullscreen)document.exitFullscreen();else if(e.mozCancelFullScreen)e.mozCancelFullScreen();else if(e.webkitCancelFullScreen)e.webkitCancelFullScreen();else{null!==window.open(location.href,"_blank","fullscreen=no,status=yes,resizable=yes,scrollbars=no,titlebar=no,menubar=yes,location=yes,toolbar=yes,z-look=yes")&&(window.opener=null,window.close())}}}),zu.include({panTo:function(e,t={},n){if(!e)return this;if(m(t)&&(n=t,t={}),e=new fl(e),void 0===t.animation||t.animation){var i=this.getProjection().project(e);return this._panAnimation(i,t.duration,n)}return this.setCenter(e),this},_panTo:function(e,t={}){return void 0===t.animation||t.animation?this._panAnimation(e,t.duration):(this.onMoveStart(),this._setPrjCenter(e),this.onMoveEnd(this._parseEventFromCoord(this.getCenter())),this)},panBy:function(e,t={},n){if(!e)return this;if(m(t)&&(n=t,t={}),e=new Re(e),this.getContainerExtent().ymin>0&&e.y>30){var i=e.y;e.y=30,e.x=30*e.x/i,console.warn("offset is limited to panBy when pitch is above maxPitch")}if(void 0===t.animation||t.animation){e=e.multi(-1);var s=this._containerPointToPrj(new Re(this.width/2+e.x,this.height/2+e.y));this._panAnimation(s,t.duration,n)}else{this.onMoveStart(),this._offsetCenterByPixel(e);var o=this.containerPointToCoord(new Re(this.width/2,this.height/2));this.onMoveEnd(this._parseEventFromCoord(o))}return this},_panAnimation:function(e,t,n){return this._animateTo({prjCenter:e},{duration:t||this.options.panAnimationDuration},n)}}),zu.include({computeLength:function(e,t){if(!this.getProjection())return null;var n=new fl(e),i=new fl(t);return n.equals(i)?0:this.getProjection().measureLength(n,i)},computeGeometryLength:function(e){return e._computeGeodesicLength(this.getProjection())},computeGeometryArea:function(e){return e._computeGeodesicArea(this.getProjection())},identify:function(e,t){var n=new fl((e=e||{}).coordinate);return this._identify(e,t,(function(t){return t.identify(n,e)}))},identifyAtPoint:function(e,t){var n=e.includeInternals,i=e.tolerance,s=new Re((e=e||{}).containerPoint),o=this.containerPointToCoord(s);return this._identify(e,t,(function(t){var s,a=e.containerPoint;if(n&&!h(t.options.geometryEventTolerance)&&(e.tolerance=e.tolerance||0,e.tolerance+=t.options.geometryEventTolerance),t._hasGeoListeners&&n&&e.eventTypes.indexOf("mousemove")>=0&&!t._hasGeoListeners(e.eventTypes))return[];(s=t.identifyAtPoint?t.identifyAtPoint(a,e):o&&t.identify?t.identify(o,e):[],n&&(h(i)?delete e.tolerance:e.tolerance=i),s&&s.length)||(t.fire("identifyempty",e),t.getLayers&&m(t.getLayers)&&(t.getLayers()||[]).filter((function(e){return e})).forEach((function(t){t.fire("identifyempty",e)})));return s}))},_identify:function(e,t,n){var i=e.layers;if(!Ye(i))return this;for(var s=e.eventTypes,o=[],a=0,l=i.length;a<l;a++)g(i[a])?o.push(this.getLayer(i[a])):o.push(i[a]);s&&(o=o.filter((function(e){return!e._hasGeoListeners||e._hasGeoListeners(s)})));for(var c=[],u=o.length-1;u>=0&&!(e.count&&c.length>=e.count);u--){var f=o[u];if(f&&f.getMap()&&(e.includeInvisible||f.isVisible())&&(e.includeInternals||!(f.getId().indexOf(vt)>=0))){var m=n(f),A=f.getId();if(m)if(Array.isArray(m)){for(var w=0;w<m.length;w++)m[w]&&!m[w].getLayer&&h(m[w].layer)&&(m[w].layer=A);ze(c,m)}else!m.getLayer&&h(m.layer)&&(m.layer=A),c.push(m)}}return t.call(this,c),this}}),zu.include({_zoom:function(e,t){this.options.zoomable&&!this.isZooming()&&(t=this._checkZoomOrigin(t),e=this._checkZoom(e),this.onZoomStart(e,t),this._frameZoom=this.getZoom(),this.onZoomEnd(e,t))},_zoomAnimation:function(e,t,n){this.options.zoomable&&!this.isZooming()&&(e=this._checkZoom(e),this.getZoom()!==e&&(t=this._checkZoomOrigin(t),this._startZoomAnim(e,t,n)))},_checkZoomOrigin:function(e){return(!e||this.options.zoomInCenter||this._isContainerPointOutOfMap(e))&&(e=new Re(this.width/2,this.height/2)),this.options.zoomOrigin&&(e=new Re(this.options.zoomOrigin)),e},_startZoomAnim:function(e,t,n){h(n)&&(n=1);var i=this._getResolution(this._startZoomVal)/this._getResolution(e),s=this.options.zoomAnimationDuration*Math.abs(i-n)/Math.abs(i-1);this._frameZoom=this._startZoomVal,this._animateTo({zoom:e,around:t},{continueOnViewChanged:!0,duration:s})},onZoomStart:function(e,t){this.options.zoomable&&!this.isZooming()&&(this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),delete this.cameraZenithDistance,this._zooming=!0,this._startZoomVal=this.getZoom(),this._startZoomCoord=t&&this._containerPointToPrj(t),this._fireEvent("zoomstart",{from:this._startZoomVal,to:e}))},onZooming:function(e,t,n){if(this.options.zoomable&&this._frameZoom!==e){h(n)&&(n=1),this._zoomTo(e,t);var i=this.getResolution(e),s=this.getResolution(this._startZoomVal)/i/n,o=this._startZoomCoord&&this.prjToContainerPoint(this._startZoomCoord,this._startZoomVal),a=this.getViewPoint();if(!this.isRotating()&&o&&t&&!o.equals(t)&&1!==s){var l=this.getPitch(),c=o._sub(t)._multi(1/(1-s));l&&(c.y/=Math.cos(l*Math.PI/180)),t=t.add(c)}var u=t&&t.x||this.width/2,f=t&&t.y||this.height/2,g={view:[s,0,0,s,(u-a.x)*(1-s),(f-a.y)*(1-s)]},m=this.getDevicePixelRatio();g.container=[s,0,0,s,u*m*(1-s),f*m*(1-s)],this._fireEvent("zooming",{from:this._startZoomVal,to:e,origin:new Re(u,f),matrix:g}),this._frameZoom=e}},onZoomEnd:function(e,t){if(this.options.zoomable){var n=this._startZoomVal;this._zoomTo(e,t),this._zooming=!1,this._getRenderer().onZoomEnd(),this._suppressRecenter||this._recenterOnTerrain(),this._fireEvent("zoomend",{from:n,to:e}),this._verifyExtent(this._getPrjCenter())||this.options.limitExtentOnMaxExtent||this._panTo(this._prjMaxExtent.getCenter())}},_zoomTo:function(e,t){if(this._zoomLevel=e,this._calcMatrices(),t&&this._startZoomCoord){var n=this._containerPointToPoint(t)._sub(this._prjToPoint(this._getPrjCenter()));this._setPrjCoordAtOffsetToCenter(this._startZoomCoord,n)}},_checkZoom:function(e){var t=this.getMaxZoom(),n=this.getMinZoom();return e<n&&(e=n),e>t&&(e=t),e}});var yd,_d=Math.PI/180,vd=new fl(0,0),xd=new Re(0,0),bd=[0,-1,0],wd=[];function Td(){return ji(new Array(16))}zu.include({getFov:function(){return this._fov||(this._fov=.6435011087932844),this._fov/_d},setFov:function(e){if(this.isZooming())return this;if(e=Math.max(.01,Math.min(60,e)),this._fov===e)return this;var t=this.getFov();return this._fov=e*_d,this._calcMatrices(),this._renderLayers(),this._fireEvent("fovchange",{from:t,to:this.getFov()}),this},getBearing:function(){return this._angle?-this._angle/_d:0},setBearing:function(e){var t={bearing:e};return this._validateView(t),this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._setBearing(t.bearing)},_setBearing:function(e){if(ye.ie9)throw new Error("map can't rotate in IE9.");var t=-Ze(e,-180,180)*_d;if(this._angle===t)return this;var n=this.getBearing();return this._fireEvent("rotatestart",{from:n,to:t}),this._angle=t,this._calcMatrices(),this._renderLayers(),this._fireEvent("rotate",{from:n,to:t}),this._fireEvent("rotateend",{from:n,to:t}),this},getPitch:function(){return this._pitch?this._pitch/Math.PI*180:0},setPitch:function(e){var t={pitch:e};return this._validateView(t),this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._setPitch(t.pitch)},_setPitch:function(e){if(ye.ie9)throw new Error("map can't tilt in IE9.");var t=Xe(e,0,this.options.maxPitch)*_d;if(this._pitch===t)return this;var n=this.getPitch();return this._fireEvent("pitchstart",{from:n,to:t}),this._pitch=t,this._calcMatrices(),this._renderLayers(),this._fireEvent("pitch",{from:n,to:t}),this._fireEvent("pitchend",{from:n,to:t}),this},setCameraMovements:function(e,t){var n=this;if(!Array.isArray(e)||!e.length)return this;if(e.forEach((function(e){n._validateView(e)})),this.setView({center:e[0].center,zoom:e[0].zoom,pitch:e[0].pitch,bearing:e[0].bearing}),1===e.length)return this;var i=1,s=function(o){if("finished"===o.state.playState){++i===e.length-1&&(s=null);var a=e[i];a.duration=a.timestamp-e[i-1].timestamp,t&&t.autoRotate&&(a.bearing=function(e,t){var n=S(e[0]),i=S(t[0]),s=S(e[1]),o=S(t[1]),a=Math.sin(i-n)*Math.cos(o),l=Math.cos(s)*Math.sin(o)-Math.sin(s)*Math.cos(o)*Math.cos(i-n);return M(Math.atan2(a,l))}(e[i-1].center,a.center)),n._setCameraMovement(a,s)}};2===e.length&&(s=null);var o=this.getBearing();this._setCameraMovement(Object.assign({bearing:o,duration:e[i].timestamp-e[i-1].timestamp},e[i]),s);return{play:function(){n._animPlayer.play()},pause:function(){n._animPlayer.pause()},cancel:function(){n._animPlayer.cancel()},finish:function(){n._animPlayer.finish()},reverse:function(){n._animPlayer.reverse()}}},_setCameraMovement:function(e,t){this.animateTo({zoom:e.zoom,center:e.center,pitch:e.pitch,bearing:e.bearing},{duration:e.duration,easing:"out"},t)},lookAt:function(e){var{coordinates:t,bearing:n,pitch:i,distance:s}=e;if(t=e.center||t,Array.isArray(t)&&(t=new fl(t)),!t.z&&!s)return this.setCenter(t);var o=this.getGLRes();n=h(n)?this.getBearing():n;var a=(i=h(i)?this.getPitch():i)*_d,l=n*_d;if(s){var c=s*Math.sin(a),u=Math.sin(a)*s,f=u*Math.sin(l),g=u*Math.cos(l);c*=this._meterToGLPoint,u=this.distanceToPointAtRes(f,g,o).mag(),s=Math.sqrt(u*u+c*c)}var m=this.coordToPointAtRes(t,o);m.z=0,t.z&&(m.z=t.z*this._meterToGLPoint);var A=s||this.cameraToGroundDistance||this.cameraToCenterDistance,w=Math.sin(a)*A,T=A*Math.cos(a),S=m.x-w*Math.sin(l),M=m.y-w*Math.cos(l),C=new Re([S,M,T+m.z]),I=this.pointAtResToCoord(C,o);return I.z=C.z/this._meterToGLPoint,this.setCameraOrientation({position:I.toArray(),bearing:n,pitch:i})},setCameraOrientation:function(e){var{position:t}=e;this._validateView(e);var{pitch:n,bearing:i}=e;n=n||0,i=i||0;var{zoom:s,cameraToGroundDistance:o}=this.getFitZoomForCamera(t,n),a=Math.sin(n*_d)*o,l=Ze(i,-180,180)*_d,h=this.getGLRes(),c=new fl(t[0],t[1]),u=this.coordToPointAtRes(c,h),f=new Re(0,0);f.x=u.x+a*Math.sin(l),f.y=u.y+a*Math.cos(l);var g=this._pointToPrjAtRes(f,this.getGLRes());return this._setPrjCenter(g),this.setView({bearing:i,pitch:n,zoom:s}),this},setCameraPosition:function(e){var t=this.getGLRes(),n=this.coordToPointAtRes(e,t);n.z=this.altitudeToPoint(e.z||0,t);var i=this.getCenter(),s=this.coordToPointAtRes(i,t);s.z=this.altitudeToPoint(i.z,t);var o=Os([],n.toArray(),s.toArray());return Is(this.cameraUp||[0,0,0],0,0,1),this._pitch=Us(o,this.cameraUp),Is(wd,o[0],o[1],0),this._angle=-Us(wd,bd),this._zoomLevel=this.getFitZoomForCamera(e,this._pitch).zoom,this._calcMatrices(),this},getFitZoomForCamera:function(e,t){c(t)||(t=0);var n=Array.isArray(e)?e[2]||0:e.z||0,i=(this.centerAltitude||0)*this._meterToGLPoint,s=(n*this._meterToGLPoint-i)/Math.cos(t*_d);return{zoom:this.getFitZoomForAltitude(s+i),cameraToGroundDistance:s}},getFitZoomForAltitude:function(e){var t=e*this._getFovRatio()*2/(this.height||1)*this.getGLRes();return this.getZoomFromRes(t)},isTransforming:function(){return!!(this._pitch||this._angle||this._terrainLayer)},getFrustumAltitude:function(){return this._frustumAltitude},_calcFrustumAltitude:function(){var e=90-this.getPitch(),t=this.getFov()/2,n=this.cameraPosition?this.cameraPosition[2]:0;if(t<=e)return n;t=Math.PI*t/180;var i=new Re(this.cameraPosition).distanceTo(new Re(this.cameraLookAt)),s=n*Math.tan(2*t);return n+Math.tan(t)*(i+s)},_pointToContainerPoint:function(e,t,n=0,i){var s=this._getResolution(t);return this._pointAtResToContainerPoint(e,s,n,i)},_pointAtResToContainerPoint:function(e,t,n=0,i){i||(i=new Re(0,0)),e=this._pointAtResToPoint(e,t,i);var s,o=this.isTransforming();return o||n||(s=this._prjToPoint(this._getPrjCenter(),void 0,vd)),this._toContainerPoint(i,o,n,s),i},_pointsAtResToContainerPoints:function(e,t,n=[],i=[]){var s=this.getPitch(),o=this.getBearing(),a=t/this._getResolution();if(0===s&&0===o&&!ac(n)){var{xmin:l,ymin:h,xmax:c,ymax:u}=this.get2DExtent();if(c>l&&u>h){for(var{width:f,height:g}=this.getSize(),m=(c-l)/f,A=(u-h)/g,w=0,T=e.length;w<T;w++)if(e[w]){var S=i[w];S.x=e[w].x,S.y=e[w].y,S._multi(a),S.x=(S.x-l)*m,S.y=g-(S.y-h)*A}else i[w]=null;return i}}for(var M=Array.isArray(n),C=this.isTransforming(),I=this._prjToPoint(this._getPrjCenter(),void 0,vd),E=0,D=e.length;E<D;E++)if(e[E]){var H=i[E];H.x=e[E].x,H.y=e[E].y,H._multi(a),this._toContainerPoint(H,C,M?n[E]||0:n,I)}else i[E]=null;return i},_toContainerPoint:function(){var e=[0,0,0];return function(t,n,i,s){var o=this.width/2,a=this.height/2;if(n||i){this._altitudeScale||(this._altitudeScale=this.altitudeToPoint(100,this.getGLRes())/100);var l=this._glScale;Is(e,t.x*l,t.y*l,i*this._altitudeScale);var h=this._projIfBehindCamera(e,this.cameraPosition,this.cameraForward);Ad(h,h,this.projViewMatrix),t.x=h[0]*o+o,t.y=-h[1]*a+a}else t._sub(s.x,s.y),t.set(t.x,-t.y),t._add(o,a)}}(),_projIfBehindCamera:function(){var e=new Array(3),t=new Array(3),n=new Array(3);return function(i,s,o){Os(e,i,s);var a=Fs(o,e);return a<=0&&(Bs(t,o,1.01*a),ks(i,s,Os(n,e,t))),i}}(),_containerPointToPoint:function(e,t,n,i){var s=this._getResolution(t);return this._containerPointToPointAtRes(e,s,n,i)},_containerPointToPointAtRes:function(){var e=[0,0,0],t=[0,0,0];return function(n,i,s,o){if(this.isTransforming()){this.getContainerPointRay(e,t,n);var a=e[0],l=t[0],h=e[1],c=t[1],u=e[2],f=t[2],g=o?this.altitudeToPoint(o,i)*this._glScale:0,m=u===f?g:(g-u)/(f-u),A=qe(a,l,m),w=qe(h,c,m);return s?(s.x=A,s.y=w):s=new Re(A,w),s._multi(1/this._glScale),this._getResolution()===i?s:this._pointToPointAtRes(s,i,s)}var T=this._prjToPointAtRes(this._getPrjCenter(),i,s),S=this._getResolution()/i;return T._add(S*(n.x-this.width/2),-(S*(n.y-this.height/2)))}}(),getContainerPointRay:function(){var e=[0,0,0],t=[0,0,0,1],n=[0,0,0,1];return function(i,s,o,a=0,l=1){var h=this.width/2||1,c=this.height/2||1;Is(e,(o.x-h)/h,(c-o.y)/c,0),Is(t,e[0],e[1],a),Is(n,e[0],e[1],l),t[3]=n[3]=1,Ad(i,t,this.projViewMatrixInverse),Ad(s,n,this.projViewMatrixInverse)}}(),_calcMatrices:(yd=Td(),function(){delete this._mapRes,delete this._mapGlRes,delete this._mapExtent2D,delete this._mapGlExtent2D;var e=this.getSize(),t=e.width||1,n=e.height||1;this._glScale=this.getGLScale();var i=this._getCameraWorldMatrix(),s=this.getFov()*Math.PI/180,o=this._getCameraFar(s,this.getPitch());this.cameraFar=o,this.cameraNear=this.cameraCenterDistance/20;var a=this.projMatrix||Td();Oi(a,s,t/n,this.cameraNear,o),this.projMatrix=a,this.viewMatrix=Ui(this.viewMatrix||Td(),i),this.projViewMatrix=zi(this.projViewMatrix||Td(),a,this.viewMatrix),this._calcCascadeMatrixes(),this.projViewMatrixInverse=zi(this.projViewMatrixInverse||Td(),i,Ui(yd,a)),this.domCssMatrix=this._calcDomMatrix(),this._frustumAltitude=this._calcFrustumAltitude(),this._mapRes=this._getResolution(),this._mapGlRes=this.getGLRes(),this._mapExtent2D=this.get2DExtent(),this._mapGlExtent2D=this.get2DExtentAtRes(this._mapGlRes)}),_getCameraFar:function(e,t){var n=this.cameraCenterDistance=Gs(this.cameraPosition,this.cameraLookAt),i=n/this._meterToGLPoint;t=(t=Math.min(t,85))*Math.PI/180;var s=i+this.options.cameraFarUndergroundInMeter/Math.cos(t);return Math.max(s*this._meterToGLPoint,5*n)},_calcCascadeMatrixes:function(){var e=Td();function t(t,n,i){var s=this.width,o=this.height,a=this.getFov()*Math.PI/180,l=this._getCameraFar(a,n),h=this.cameraCenterDistance;return l=h+(l-h)/Math.cos((90-n)*Math.PI/180)*Math.cos((90-t)*Math.PI/180),Oi(e,a,s/o,.1,l),zi(i,e,this.viewMatrix)}return function(){var e=this.getPitch(),n=this.options.cascadePitches[0],i=this.options.cascadePitches[1],s=this.cascadeFrustumMatrix0=this.cascadeFrustumMatrix0||Td(),o=this.cascadeFrustumMatrix1=this.cascadeFrustumMatrix1||Td();e>n?t.call(this,e,n,s):qi(this.cascadeFrustumMatrix0,this.projViewMatrix),e>i?t.call(this,e,i,o):qi(this.cascadeFrustumMatrix1,this.cascadeFrustumMatrix0)}}(),_calcDomMatrix:function(){var e=Td(),t=Td(),n=[1,-1,1],i=[0,0,0];return function(){var s=this.width||1,o=this.height||1,a=.5/Math.tan(this._fov/2)*o;return Di(e,this.projMatrix,n),Li(e,e,Is(i,0,0,-a)),this._pitch&&Fi(e,e,this._pitch),this._angle&&Bi(e,e,this._angle),ji(t),Di(t,t,Is(i,s/2,-o/2,1)),zi(this.domCssMatrix||Td(),t,e)}}(),_getFovZ:function(e){var t=this.getGLScale(e),n=this._getFovRatio();return t*(this.height||1)/2/n},_getCameraWorldMatrix:function(){var e={};return function(){var t=this.getGLRes();this._meterToGLPoint||(this._meterToGLPoint=this.altitudeToPoint(100,t)/100);var n=this._prjToPointAtRes(this._prjCenter,t,xd),i=this.getCenter().z,s=(void 0!==i?i:this.centerAltitude||0)*this._meterToGLPoint;this.cameraLookAt=Is(this.cameraLookAt||[0,0,0],n.x,n.y,s);var o=this.getPitch()*_d,a=this.getBearing()*_d,l=this._getFovZ(),h=(void 0===this.cameraZenithDistance?l:this.cameraZenithDistance)-s;this.cameraToGroundDistance=h;var c=h*Math.cos(o),u=Math.sin(o)*h,f=n.x-u*Math.sin(a),g=n.y-u*Math.cos(a);this.cameraPosition=Is(this.cameraPosition||[0,0,0],f,g,c+s),this.cameraToCenterDistance=l,this.cameraUp=this.cameraUp||[0,0,0],this.cameraUp=this._getCameraUp(this.cameraUp,this.cameraLookAt,this.cameraPosition,o,a);var m=this.cameraWorldMatrix=this.cameraWorldMatrix||Td();!function(e,t,n,i){var s=[0,0,0],o=[0,0,0],a=[0,0,0];Os(a,t,n),0===Rs(a)&&(a[2]=1),Ds(a,a),zs(s,i,a),0===Rs(a)&&(1===Math.abs(i[2])?a[0]+=1e-4:a[2]+=1e-4,Ds(a,a),zs(s,i,a)),Ds(s,s),zs(o,a,s),e[0]=s[0],e[4]=o[0],e[8]=a[0],e[1]=s[1],e[5]=o[1],e[9]=a[1],e[2]=s[2],e[6]=o[2],e[10]=a[2]}(m,this.cameraPosition,this.cameraLookAt,this.cameraUp);var A=this.cameraForward||[0,0,0];return Os(A,this.cameraLookAt,this.cameraPosition),this.cameraForward=Ds(A,A),function(e,t){var n,i=t[0],s=t[4],o=t[8],a=t[1],l=t[5],h=t[9],c=t[2],u=t[6],f=t[10],g=i+l+f;g>0?(n=.5/Math.sqrt(g+1),e.w=.25/n,e.x=(u-h)*n,e.y=(o-c)*n,e.z=(a-s)*n):i>l&&i>f?(n=2*Math.sqrt(1+i-l-f),e.w=(u-h)/n,e.x=.25*n,e.y=(s+a)/n,e.z=(o+c)/n):l>f?(n=2*Math.sqrt(1+l-i-f),e.w=(o-c)/n,e.x=(s+a)/n,e.y=.25*n,e.z=(h+u)/n):(n=2*Math.sqrt(1+f-i-l),e.w=(a-s)/n,e.x=(o+c)/n,e.y=(h+u)/n,e.z=.25*n)}(e,m),function(e,t){var n=e,i=t.x,s=t.y,o=t.z,a=t.w,l=i+i,h=s+s,c=o+o,u=i*l,f=i*h,g=i*c,m=s*h,A=s*c,w=o*c,T=a*l,S=a*h,M=a*c;n[0]=1-(m+w),n[4]=f-M,n[8]=g+S,n[1]=f+M,n[5]=1-(u+w),n[9]=A-T,n[2]=g-S,n[6]=A+T,n[10]=1-(u+m),n[3]=0,n[7]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1}(m,e),function(e,t){var n=e;n[12]=t[0],n[13]=t[1],n[14]=t[2]}(m,this.cameraPosition),m}}(),_getCameraUp:function(){var e=[0,0,0],t=[0,0,0],n=[0,0,0];return function(i,s,o,a,l){Is(n,0,0,1),0===a?Is(n,Math.sin(l),Math.cos(l),0):a===Math.PI&&Is(n,-Math.sin(l),-Math.cos(l),0);var h=Os(e,s,o);Ds(h,h);var c=zs(t,h,n);return zs(i,c,h)}}(),updateCenterAltitude:function(){this.getRenderer().setToRedraw(),!this.centerAltitude&&this._hasAltitudeLayer()&&(this.centerAltitude=0),this._recenterOnTerrain()},_recenterOnTerrain:function(){if(void 0!==this.centerAltitude){var e=this._queryTerrainByProjCoord(this._prjCenter);h(e)&&this._hasAltitudeLayer()&&(e=this.centerAltitude);var t=e>0&&e||0,n=this.getPitch()*_d,i=this.getBearing()*_d,s=(t-this.centerAltitude)*this._meterToGLPoint,o=this._getFovZ(),a=(void 0===this.cameraZenithDistance?o:this.cameraZenithDistance)-this.centerAltitude*this._meterToGLPoint-s/Math.cos(n),l=this.cameraPosition,c=Math.sin(n)*a,u=xd;u.x=l[0]+c*Math.sin(i),u.y=l[1]+c*Math.cos(i);var f=t*this._meterToGLPoint;this.cameraZenithDistance=(l[2]-f)/Math.cos(n)+f,this.centerAltitude=t;var g=this.pointAtResToCoordinate(u,this.getGLRes(),vd);this._eventSilence=!0,this._suppressRecenter=!0,this.setCenter(g),delete this._suppressRecenter,delete this._eventSilence,h(e)&&delete this.centerAltitude}},_queryTerrainByProjCoord:function(e){for(var t=this._getLayers(),n=0;n<t.length;n++)if(t[n].queryTerrainByProjCoord)return t[n].queryTerrainByProjCoord(e)[0];return 0},_hasAltitudeLayer:function(){for(var e=this._getLayers(),t=0;t<e.length;t++)if(e[t].getTerrainLayer&&e[t].getTerrainLayer())return!0;return!1},_queryTerrainInfo:function(e){if(e){var t=this._findTerrainLayer();if(!t)return null;var n=t.queryTerrainAtPoint(e);if(n)return{coordinate:n,altitude:n.z}}return null},_query3DTilesInfo:function(e){for(var t=this._getLayers()||[],n=0;n<t.length;n++){var i=t[n];if(e&&i&&i.query3DTilesAtPoint){var s=i.query3DTilesAtPoint(e);if(s)return{coordinate:s,altitude:s.z};break}}return null},queryPrjCoordAtContainerPoint:function(e){var t=this._query3DTilesInfo(e);if(t||(t=this._queryTerrainInfo(e)),t){var n=this.getProjection().project(t.coordinate);return n.z=t.altitude,n}return this._isContainerPointOutOfMap(e)&&(e=new Re(this.width/2,this.height/2)),this._containerPointToPrj(e)},_getFovRatio:function(){var e=this.getFov();return Math.tan(e/2*_d)},_renderLayers:function(){this.isInteracting()||this._getLayers().forEach((function(e){if(e){var t=e._getRenderer();t&&t.setToRedraw&&t.setToRedraw()}}))}}),zu.include({_onViewChange:function(e){this._viewHistory||(this._viewHistory=[],this._viewHistoryPointer=0);for(var t=this._getCurrentView(),n=this._viewHistory.length-1;n>=0;n--)if(lt(e,this._viewHistory[n]))return this._viewHistoryPointer=n,void this._fireViewChange(t,e);this._viewHistoryPointer<this._viewHistory.length-1&&this._viewHistory.splice(this._viewHistoryPointer+1),this._viewHistory.push(e);var i=this.options.viewHistoryCount;i>0&&this._viewHistory.length>i&&this._viewHistory.splice(0,this._viewHistory.length-i),this._viewHistoryPointer=this._viewHistory.length-1,this._fireViewChange(t,e)},zoomToPreviousView:function(e={}){if(!this.hasPreviousView())return null;var t=this._viewHistory[--this._viewHistoryPointer];return this._zoomToView(t,e),t},hasPreviousView:function(){return!(!this._viewHistory||0===this._viewHistoryPointer)},zoomToNextView:function(e={}){if(!this.hasNextView())return null;var t=this._viewHistory[++this._viewHistoryPointer];return this._zoomToView(t,e),t},hasNextView:function(){return!(!this._viewHistory||this._viewHistoryPointer===this._viewHistory.length-1)},_zoomToView:function(e,t){var n=this,i=this.getView();t.animation?this._animateTo(e,{duration:t.duration},(function(t){"finished"===t.state.playState&&n._fireViewChange(i,e)})):(this.setView(e),this._fireViewChange(i,e))},getViewHistory:function(){return this._viewHistory},_fireViewChange:function(e,t){this._fireEvent("viewchange",{old:e,new:t}),this._insertUICollidesQueue()},_getCurrentView:function(){return this._viewHistory?this._viewHistory[this._viewHistoryPointer]:null}}),zu.mergeOptions({viewHistory:!0,viewHistoryCount:10});var Sd=new ha;zu.include({getCollisionIndex:function(){return this._collisionIndex||this.createCollisionIndex(),this._collisionIndex||this.createCollisionIndex()},createCollisionIndex:function(){return this.clearCollisionIndex(),this._collisionIndex=new ha,this._collisionIndex},clearCollisionIndex:function(){return this.collisionFrameTime=0,this._collisionIndex&&this._collisionIndex.clear(),this},_insertUICollidesQueue:function(){return this._uiCollidesQueue||(this._uiCollidesQueue=[]),this._uiCollidesQueue.push(1),this},uiCollides:function(){if(!this.uiList||0===this.uiList.length||!this._uiCollidesQueue||0===this._uiCollidesQueue.length)return this;var e=Sd;e.clear();for(var t=this.uiList,n=0,i=t.length;n<i;n++){var s=t[n],{collisionBufferSize:o,collision:a}=s.options;if(a){var l=s.getDOM();if(s.isVisible()&&l&&l.getBoundingClientRect){s.bbox||(s.bbox=[0,0,0,0]);var h=l.getBoundingClientRect(),{x:c,y:u}=h,{width:f,height:g}=h;if(0===f||0===g){var m=s.getSize();m&&(f=m.width,g=m.height)}var A=c+f+o,w=u-o,T=u+g+o;s.bbox[0]=c-o,s.bbox[1]=w,s.bbox[2]=A,s.bbox[3]=T,e.collides(s.bbox)?s._collidesEffect(!1):(e.insertBox(s.bbox),s._collidesEffect(!0))}}else s._collidesEffect(!0)}return this._uiCollidesQueue=[],this},_addUI:function(e){return this.uiList||(this.uiList=[]),this.uiList.indexOf(e)>-1?this:(this.uiList.push(e),this._sortUI())},_sortUI:function(){return this.uiList=this.uiList||[],this.uiList=this.uiList.sort((function(e,t){return t.options.collisionWeight-e.options.collisionWeight})),this},_removeUI:function(e){if(!this.uiList)return-1;var t=this.uiList.indexOf(e);return t<0||this.uiList.splice(t,1),t}});var Md,Cd,Pd=new fl(0,0);zu.include({coordinateToPoint:function(e,t,n){var i=this._getResolution(t);return this.coordinateToPointAtRes(e,i,n)},coordinateToPointAtRes:function(){var e=new fl(0,0);return function(t,n,i){var s=this.getProjection().project(t,e);return this._prjToPointAtRes(s,n,i)}}(),pointToCoordinate:function(){var e=new fl(0,0);return function(t,n,i){var s=this._pointToPrj(t,n,e);return this.getProjection().unproject(s,i)}}(),pointAtResToCoordinate:function(){var e=new fl(0,0);return function(t,n,i){var s=this._pointToPrjAtRes(t,n,e);return this.getProjection().unproject(s,i)}}(),coordinateToViewPoint:function(){var e=new fl(0,0);return function(t,n,i){return this._prjToViewPoint(this.getProjection().project(t,e),n,i)}}(),viewPointToCoordinate:function(){var e=new fl(0,0);return function(t,n){return this.getProjection().unproject(this._viewPointToPrj(t,e),n)}}(),coordinateToContainerPoint:function(e,t,n){var i=this._getResolution(t);return this.coordinateToContainerPointAtRes(e,i,n)},coordinateToContainerPointAtRes:function(){var e=new fl(0,0);return function(t,n,i){var s=this.getProjection().project(t,e);return this._prjToContainerPointAtRes(s,n,i,s.z)}}(),coordinatesToContainerPoints:function(e,t){var n=this._getResolution(t);return this.coordinatesToContainerPointsAtRes(e,n)},coordinatesToContainerPointsAtRes:function(e,t){for(var n=[],i=this._spatialReference.getTransformation(),s=t/this._getResolution(),o=this.getProjection(),a=new fl(0,0),l=this.isTransforming(),h=this._prjToPoint(this._getPrjCenter(),void 0,Pd),c=0,u=e.length;c<u;c++){var f=o.project(e[c],a),g=i.transform(f,t);g=g._multi(s),this._toContainerPoint(g,l,e[c].z,h),n.push(g)}return n},containerPointToCoordinate:function(){var e=new fl(0,0);return function(t,n){var i=this._containerPointToPrj(t,e);return this.getProjection().unproject(i,n)}}(),containerToExtent:function(){var e=new Re(0,0),t=new Re(0,0);return function(n){var i=new Pl(this._containerPointToPoint(n.getMin(e),void 0,e),this._containerPointToPoint(n.getMax(t),void 0,t));return this._pointToExtent(i)}}(),distanceToPixel:function(){var e=new Re(0,0),t=new Re(0,0);return function(n,i,s){var o=this.getProjection();if(!o)return null;var a=this.getScale()/this.getScale(s),l=this.getCenter(),h=o.locate(l,n,i),c=this.coordToContainerPoint(l,void 0,e),u=this.coordToContainerPoint(h,void 0,t);return u._sub(c)._multi(a)._abs(),new Ot(u.x,u.y)}}(),distanceToPoint:function(e,t,n,i){var s=this._getResolution(n);return this.distanceToPointAtRes(e,t,s,i)},distanceToPointAtRes:function(){var e=new Re(0,0),t=new fl(0,0);return function(n,i,s,o,a){var l=this.getProjection();if(!l)return null;var h=o||this.getCenter(),c=l.locate(h,n,i,t),u=this.coordToPointAtRes(h,s,e),f=this.coordToPointAtRes(c,s,a);return f._sub(u)._abs(),f}}(),altitudeToPoint:(Md=new fl(0,40),Cd=new Re(0,0),function(e=0,t,n){this._altitudeOriginDirty&&(Md.x=this._originLng,this._altitudeOriginDirty=!1);var i=this.distanceToPointAtRes(e,e,t,n||Md,Cd),s=this.options.heightFactor;return s&&1!==s&&(i.x*=s,i.y*=s),i.x*Math.sign(e)}),pointAtResToAltitude:function(){var e=new fl(0,40);return function(t=0,n,i){return this.pointAtResToDistance(t,0,n,i||e)*Math.sign(t)}}(),pixelToDistance:function(){var e=new fl(0,0),t=new fl(0,0),n=new fl(0,0),i=new fl(0,0);return function(s,o){var a=this.getProjection();if(!a)return null;var l=this.getFullExtent(),h=l.top>l.bottom?-1:1,c=e.set(this.width/2,this.height/2),u=t.set(this.width/2+s,this.height/2+h*o),f=this.containerPointToCoord(c,n),g=this.containerPointToCoord(u,i);return a.measureLength(f,g)}}(),pointToDistance:function(e,t,n){var i=this.getResolution(n);return this.pointAtResToDistance(e,t,i)},pointAtResToDistance:function(){var e=new Re(0,0),t=new fl(0,0),n=new fl(0,0),i=new fl(0,0);return function(s,o,a,l){var h=this.getProjection();if(!h)return null;var c=l?h.project(l,t):this._getPrjCenter(),u=this._prjToPointAtRes(c,a,e);u._add(s,o);var f=this.pointAtResToCoord(u,a,n),g=l||h.unproject(c,i);return g.z=0,f.z=0,h.measureLength(g,f)}}(),locateByPoint:function(){var e=new Re(0,0);return function(t,n,i){var s=this.coordToContainerPoint(t,void 0,e);return this.containerPointToCoord(s._add(n,i))}}(),_get2DExtent:function(e,t){var n;if(void 0!==e&&e!==this._zoomLevel||!this._mapExtent2D||(n=this._mapExtent2D),n)return t?(t.set(n.xmin,n.ymin,n.xmax,n.ymax),t):n.copy();var i=this._getResolution(e);return this._get2DExtentAtRes(i,t)},get2DExtent:function(e,t){return this._get2DExtent(e,t)},_get2DExtentAtRes:function(){var e=new Re(0,0);return function(t,n){var i=this;return t===this._mapGlRes&&this._mapGlExtent2D?this._mapGlExtent2D:this.getContainerExtent().convertTo((function(n){return i._containerPointToPointAtRes(n,t,e)}),n)}}(),get2DExtentAtRes:function(e,t){return this._get2DExtentAtRes(e,t)},pointToExtent:function(e){return this._pointToExtent(e)},_pointToExtent:function(){var e=new fl(0,0),t=new fl(0,0);return function(n){var i=n.getMin(),s=n.getMax(),o=this.getFullExtent(),[a,l]=!o||o.left<=o.right?[i.x,s.x]:[s.x,i.x],[h,c]=!o||o.top>o.bottom?[s.y,i.y]:[i.y,s.y],u=i.set(a,c),f=s.set(l,h);return new Ml(this.pointToCoord(u,void 0,e),this.pointToCoord(f,void 0,t),this.getProjection())}}(),getViewPointFrameOffset:function(){var e=new Re(0,0);return function(){if(this.isZooming())return null;var t=this._getPrjCenter();return this._mapViewCoord&&!this._mapViewCoord.equals(t)?this._prjToContainerPoint(this._mapViewCoord)._sub(this._prjToContainerPoint(t,void 0,e)):null}}(),_viewPointToPrj:function(){var e=new Re(0,0);return function(t,n){return this._containerPointToPrj(this.viewPointToContainerPoint(t,e),n)}}(),viewPointToPrj:function(e,t){return this._viewPointToPrj(e,t)},_prjToContainerPoint:function(e,t,n,i){var s=this._getResolution(t);return this._prjToContainerPointAtRes(e,s,n,i)},prjToContainerPoint:function(e,t,n,i){return this._prjToContainerPoint(e,t,n,i)},_prjToContainerPointAtRes:function(){var e=new Re(0,0);return function(t,n,i,s){return this._pointAtResToContainerPoint(this._prjToPointAtRes(t,n,e),n,s||0,i)}}(),prjToContainerPointAtRes:function(e,t,n,i){return this.prjToContainerPointAtRes(e,t,n,i)},_prjToViewPoint:function(){var e=new Re(0,0);return function(t,n,i){var s=this._prjToContainerPoint(t,void 0,e,i);return this.containerPointToViewPoint(s,n)}}(),prjToViewPoint:function(e,t,n){return this._prjToViewPoint(e,t,n)},_viewPointToPoint:function(){var e=new Re(0,0);return function(t,n,i){return this._containerPointToPoint(this.viewPointToContainerPoint(t,e),n,i)}}(),viewPointToPoint:function(e,t,n){return this._viewPointToPoint(e,t,n)},_pointToViewPoint:function(){var e=new fl(0,0);return function(t,n,i){return this._prjToViewPoint(this._pointToPrj(t,n,e),i)}}(),pointToViewPoint:function(e,t,n){return this._pointToViewPoint(e,t,n)}});var Id={distancetool:{start:"起点",units:{mile:" 英里",feet:" 英尺",kilometer:" 公里",meter:" 米"}},areatool:{units:{mile:" 平方英里",feet:" 平方英尺",kilometer:" 平方公里",meter:" 平方米"}}},kd={distancetool:{start:"Inicio",units:{mile:" mi",feet:" ft",kilometer:" km",meter:" m"}},areatool:{units:{mile:" mi²",feet:" ft²",kilometer:" km²",meter:" m²"}}},Od={distancetool:{start:"Start",units:{mile:" mi",feet:" ft",kilometer:" km",meter:" m"}},areatool:{units:{mile:" mi²",feet:" ft²",kilometer:" km²",meter:" m²"}}},Ed=function(e){function t(t){var n;return(n=e.call(this,"Translator: "+t)||this).name="TranslatorError",n}return Te(t,e),t}(Ie(Error)),Rd=function(e){function t(t){var n;return(n=e.call(this)||this).languages={"zh-CN":Id,"es-MX":kd,"en-US":Od},n.setLang(t||"zh-CN"),n}Te(t,e);var n=t.prototype;return n.setLang=function(e){var t=this.languages[e];if(!t)throw new Ed("Setted Lang does not exist");this.nodes=t},n._validateNestedProps=function(e){e.forEach((function(e){if(""===e)throw new Ed('Any of sides of a dot "." cannot be empty')}))},n.translate=function(e=null){if(null==e)throw new Ed("Missing parameter textNode");if("string"!=typeof e)throw new Ed("Param passed has to be a String");if(!e.includes("."))return this.nodes[e];var t=e.split(".");if(t.length>3)throw new Ed("Translate function can only access through 3 nested properties, trying to access -> "+t.length);this._validateNestedProps(t);try{var n=null;switch(t.length){case 2:n=this.nodes[t[0]][t[1]];break;case 3:n=this.nodes[t[0]][t[1]][t[2]]}return n}catch(e){throw new Ed("Unable to find the text translated in lang json"+e.message)}},t}(Ua),Ld=function(e){function t(t){var n;return(n=e.call(this,t)||this).on("enable",n._afterEnable,n).on("disable",n._afterDisable,n),n._measureLayers=[],n.translator=new Rd(n.options.language),n}Te(t,e);var n=t.prototype;return n.clear=function(){if(Ye(this._measureLayers))for(var e=0;e<this._measureLayers.length;e++)this._measureLayers[e].remove();return delete this._lastMeasure,delete this._lastVertex,this._outLayers(this._measureLayers),this._measureLayers=[],this},n.getMeasureLayers=function(){return this._measureLayers},n.getLastMeasure=function(){return this._lastMeasure?this._lastMeasure:0},n.undo=function(){e.prototype.undo.call(this);var t=this._historyPointer;if(t!==this._vertexes.length)for(var n=t;n<this._vertexes.length;n++)this._vertexes[n].label&&this._vertexes[n].label.remove(),this._vertexes[n].marker.remove();return this},n.redo=function(){e.prototype.redo.call(this);var t=this._historyPointer-1;return this._vertexes[t]&&(this._vertexes[t].marker.getLayer()||(this._vertexes[t].label&&this._vertexes[t].label.addTo(this._measureMarkerLayer),this._vertexes[t].marker.addTo(this._measureMarkerLayer))),this},n._formatLabelContent=function(e){var t=this.options.formatLabelContent;return t&&m(t)?t.call(this,e)+"":null},n._measure=function(e){var t,n=this.getMap();e instanceof gu?t=n.computeGeometryLength(e):Array.isArray(e)&&(t=n.getProjection().measureLength(e)),this._lastMeasure=t;var i=this._formatLabelContent(t);if(i)return i;var s=[this.translator.translate("distancetool.units.meter"),this.translator.translate("distancetool.units.kilometer"),this.translator.translate("distancetool.units.feet"),this.translator.translate("distancetool.units.mile")],o="",a=this.options.decimalPlaces;return this.options.metric&&(o+=t<1e3?t.toFixed(a)+s[0]:(t/1e3).toFixed(a)+s[1]),this.options.imperial&&(o.length>0&&(o+="\n"),o+=(t*=3.2808399)<5280?t.toFixed(a)+s[2]:(t/5280).toFixed(a)+s[3]),o},n._registerMeasureEvents=function(){this.on("drawstart",this._msOnDrawStart,this).on("drawvertex",this._msOnDrawVertex,this).on("mousemove",this._msOnMouseMove,this).on("drawend",this._msOnDrawEnd,this)},n._afterEnable=function(){this._registerMeasureEvents()},n._afterDisable=function(){this.off("drawstart",this._msOnDrawStart,this).off("drawvertex",this._msOnDrawVertex,this).off("mousemove",this._msOnMouseMove,this).off("drawend",this._msOnDrawEnd,this)},n._msOnDrawStart=function(e){var t=this.getMap(),n=He(),i="distancetool_"+n,s="distancetool_markers_"+n,o=this.options.zIndex,a=this.options.enableAltitude;t.getLayer(i)?(this._measureLineLayer=t.getLayer(i),this._measureMarkerLayer=t.getLayer(s)):(this._measureLineLayer=new td(i,{zIndex:o,enableAltitude:a}).addTo(t),this._measureMarkerLayer=new td(s,{zIndex:o,enableAltitude:a}).addTo(t)),this._measureLayers.push(this._measureLineLayer),this._measureLayers.push(this._measureMarkerLayer),this._pushLayers([this._measureLineLayer,this._measureMarkerLayer]);var l=this._getFirstCoordinate()||e.coordinate,h=new mf(l.copy(),{symbol:this.options.vertexSymbol}),c=this.translator.translate("distancetool.start"),u=new Zf(c,l.copy(),this.options.labelOptions);this._lastVertex=u,this._addVertexMarker(h,u)},n._msOnMouseMove=function(e){var t=this._measure(this._msGetCoordsToMeasure(e));if(!this._tailMarker){var n=wi(this.options.vertexSymbol);n.markerWidth/=2,n.markerHeight/=2,this._tailMarker=new mf(e.coordinate,{symbol:n}).addTo(this._measureMarkerLayer),this._tailLabel=new Zf(t,e.coordinate,this.options.labelOptions).addTo(this._measureMarkerLayer)}var i=this._getLasttCoordinate()||e.coordinate;this._tailMarker.setCoordinates(i.copy()),this._tailLabel.setContent(t),this._tailLabel.setCoordinates(i.copy())},n._msGetCoordsToMeasure=function(e){return e.geometry.getCoordinates().concat([e.coordinate])},n._msOnDrawVertex=function(e){var t=this._getLasttCoordinate()||e.coordinate,n=e.geometry,i=new mf(t.copy(),{symbol:this.options.vertexSymbol}),s=this._measure(n),o=new Zf(s,t.copy(),this.options.labelOptions);this._addVertexMarker(i,o),this._lastVertex=o},n._addVertexMarker=function(e,t){this._vertexes||(this._vertexes=[]),void 0!==this._historyPointer&&this._vertexes.length>this._historyPointer-1&&(this._vertexes.length=this._historyPointer-1),this._vertexes.push({label:t,marker:e}),this._measureMarkerLayer.addGeometry(e),t&&this._measureMarkerLayer.addGeometry(t)},n._msOnDrawEnd=function(e){if(this._clearTailMarker(),e.geometry.getCoordinates().length<2)return this._lastMeasure=0,void this._clearMeasureLayers();var t=this._lastVertex.getSize();t||(t=new Ot(10,10)),this._addClearMarker(this._lastVertex.getCoordinates(),this._lastVertex._getPrjCoordinates(),t.width);var n=e.geometry.copy();n.setCoordinates(e.geometry.getCoordinates()),n.addTo(this._measureLineLayer),this._lastMeasure=n.getLength()},n._addClearMarker=function(e,t,n){var i=this.options.clearButtonSymbol,s={markerDx:(i.markerDx||0)+n,textDx:(i.textDx||0)+n};Array.isArray(i)&&(s=i.map((function(e){return e?{markerDx:(e.markerDx||0)+n,textDx:(e.textDx||0)+n}:null}))),i=wi(i,s);var o=new mf(e,{symbol:i}),a=this._measureLineLayer,l=this._measureMarkerLayer;o.on("click",(function(){return a.remove(),l.remove(),!1}),this),o.addTo(this._measureMarkerLayer)},n._clearTailMarker=function(){this._tailMarker&&(this._tailMarker.remove(),delete this._tailMarker),this._tailLabel&&(this._tailLabel.remove(),delete this._tailLabel)},n._clearMeasureLayers=function(){this._measureLineLayer.remove(),this._measureMarkerLayer.remove()},n._getFirstCoordinate=function(){return this._geometry?(this._geometry.getCoordinates()||[])[0]:null},n._getLasttCoordinate=function(){if(!this._geometry)return null;var e=this._geometry.getCoordinates()||[];return e[e.length-1]},t}(od);Ld.mergeOptions({formatLabelContent:null,decimalPlaces:2,mode:"LineString",language:"zh-CN",metric:!0,imperial:!1,symbol:{lineColor:"#000",lineWidth:3,lineOpacity:1},vertexSymbol:{markerType:"ellipse",markerFill:"#fff",markerLineColor:"#000",markerLineWidth:3,markerWidth:11,markerHeight:11},labelOptions:{textSymbol:{textFaceName:"monospace",textLineSpacing:1,textHorizontalAlignment:"right",textDx:15},boxStyle:{padding:[6,2],symbol:{markerType:"square",markerFill:"#fff",markerFillOpacity:.9,markerLineColor:"#b4b3b3"}}},clearButtonSymbol:[{markerType:"square",markerFill:"#fff",markerLineColor:"#b4b3b3",markerLineWidth:2,markerWidth:15,markerHeight:15,markerDx:20},{markerType:"x",markerWidth:10,markerHeight:10,markerDx:20}]});var Dd=function(e){function t(t){var n;return(n=e.call(this,t)||this).translator=new Rd(n.options.language),n._measureLayers=[],n}Te(t,e);var n=t.prototype;return n._measure=function(e){var t,n=this.getMap();e instanceof gu?t=n.computeGeometryArea(e):Array.isArray(e)&&(t=n.getProjection().measureArea(e)),this._lastMeasure=t;var i=this._formatLabelContent(t);if(i)return i;var s=[this.translator.translate("areatool.units.meter"),this.translator.translate("areatool.units.kilometer"),this.translator.translate("areatool.units.feet"),this.translator.translate("areatool.units.mile")],o="",a=this.options.decimalPlaces;if(this.options.metric&&(o+=t<1e6?t.toFixed(a)+s[0]:(t/1e6).toFixed(a)+s[1]),this.options.imperial){t*=Math.pow(3.2808399,2),o.length>0&&(o+="\n");var l=27878400;o+=t<l?t.toFixed(a)+s[2]:(t/l).toFixed(a)+s[3]}return o},n._msGetCoordsToMeasure=function(e){return e.geometry.getShell().concat([e.coordinate])},n._msOnDrawVertex=function(e){var t=this._getLasttCoordinate()||e.coordinate,n=new mf(t.copy(),{symbol:this.options.vertexSymbol});this._measure(e.geometry),this._lastVertex=n,this._addVertexMarker(n)},n._msOnDrawEnd=function(e){var t;this._clearTailMarker();var n=this.getMap();if(e.point2d)t=n._pointToPrj(e.point2d);else{var i=e.geometry._getPrjCoordinates()||[];t=(i=i.slice(0,i.length-1))[i.length-1]}if(e.geometry.getShell().length<3)return this._lastMeasure=0,void this._clearMeasureLayers();var s=this._measure(e.geometry),o=this._getLasttCoordinate(),a=new Zf(s,o.copy(),this.options.labelOptions).addTo(this._measureMarkerLayer).getSize();a||(a=new Ot(10,10)),this._addClearMarker(o.copy(),t,a.width);var l=e.geometry.copy();l.setCoordinates(e.geometry.getCoordinates()),l.addTo(this._measureLineLayer),this._lastMeasure=l.getArea()},t}(Ld);function Fd(e,t,n){var i,s,o=Array.isArray(t);if(o||(t=[t]),n&&n.drawTool&&n.drawTool.options&&(s=n.drawTool.options.transformCoordinate),s&&m(s))i=t.map((function(t){return e.unproject(t)})),i=i.map((function(e){return s(e,n)||e}));else{if(!n||!n.target||!n.target._queryTerrainInfo)return i=t.map((function(t){return e.unproject(t)})),o?i:i[0];var a=n.target,l=n.enableAltitude;i=t.map((function(t){if(l){var n=a.prjToContainerPoint(t),i=a._queryTerrainInfo(n);if(i&&i.coordinate)return i.coordinate}return e.unproject(t)}))}return o?i:i[0]}Dd.mergeOptions({mode:"Polygon",symbol:{lineColor:"#000000",lineWidth:2,lineOpacity:1,lineDasharray:"",polygonFill:"#ffffff",polygonOpacity:.5},language:"zh-CN"});var Hd={create:function(e,t,n){var i=Fd(e,t[0],n);return new Lf(i,0)},update:function(e,t,n,i){var s=n.getMap(),o=Fd(e,Array.isArray(t)?t[t.length-1]:t,i),a=s.computeLength(n.getCenter(),o);n.setRadius(a)},generate:function(e){return e}};od.registerMode("circle",l({clickLimit:2,action:["click","mousemove","click"]},Hd)),od.registerMode("freeHandCircle",l({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},Hd));var Nd={create:function(e,t,n){var i=Fd(e,t[0],n);return new Ff(i,0,0)},update:function(e,t,n,i){var s=n.getMap(),o=n.getCenter(),a=Fd(e,Array.isArray(t)?t[t.length-1]:t,i),l=s.computeLength(o,new fl({x:a.x,y:o.y})),h=s.computeLength(o,new fl({x:o.x,y:a.y}));n.setWidth(2*l),n.setHeight(2*h)},generate:function(e){return e}};od.registerMode("ellipse",l({clickLimit:2,action:["click","mousemove","click"]},Nd)),od.registerMode("freeHandEllipse",l({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},Nd));var Bd={create:function(e,t){var n=new df([]);return n._firstClick=t[0],n},update:function(e,t,n,i){var s=n.getMap(),o=i.containerPoint,a=s.prjToContainerPoint(n._firstClick),l=[[a.x,a.y],[o.x,a.y],[o.x,o.y],[a.x,o.y]].map((function(e){return s._containerPointToPrj(new Re(e))})),h=Fd(e,l,i);n.setCoordinates(h)},generate:function(e){return e}};od.registerMode("rectangle",l({clickLimit:2,action:["click","mousemove","click"]},Bd)),od.registerMode("freeHandRectangle",l({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},Bd)),od.registerMode("point",{clickLimit:1,action:["click","mousemove"],create:function(e,t,n){var i=Fd(e,t[0],n);return new mf(i)},generate:function(e){return e},update:function(e,t,n,i){if(Array.isArray(t)&&(t=t[t.length-1]),!t)return n;var s=Fd(e,t,i);return n.setCoordinates(s),n}});var zd={create:function(e,t,n){var i=Fd(e,t,n),s=new yf(i);return s.setCoordinates(i),s},update:function(e,t,n,i){var s,o=n.getSymbol();Array.isArray(t)?s=t:(s=n._drawPrjs||[]).push(t),n._drawPrjs=s;var a=Fd(e,s,i);n.setCoordinates(a);var l=n.getLayer();if(l){var h=l.getGeometryById("polygon");if(!h&&s.length>=3){if(h=new df([a],{id:"polygon",zIndex:-1}),o){var c=wi(o,{lineOpacity:0});h.setSymbol(c)}h.addTo(l)}h&&h.setCoordinates([a])}},generate:function(e){var t=new df(e.getCoordinates(),{symbol:e.getSymbol(),properties:e.getProperties()});return t._projCode=e._projCode,t}};od.registerMode("polygon",l({action:["click","mousemove","dblclick"]},zd)),od.registerMode("freeHandPolygon",l({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},zd));var Gd={create:function(e,t,n){var i=Fd(e,t,n),s=new yf(i);return s.setCoordinates(i),s},update:function(e,t,n,i){var s;Array.isArray(t)?s=t:(s=n._drawPrjs||[]).push(t),n._drawPrjs=s;var o=Fd(e,s,i);n.setCoordinates(o)},generate:function(e){return e}};od.registerMode("linestring",l({action:["click","mousemove","dblclick"]},Gd)),od.registerMode("freeHandLinestring",l({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},Gd)),od.registerMode("arccurve",{action:["click","mousemove","dblclick"],create:function(e,t){var n=t.map((function(t){return e.unproject(t)})),i=new zf(n);return i._setPrjCoordinates(t),i},update:Gd.update,generate:function(e){return e}}),od.registerMode("quadbeziercurve",{action:["click","mousemove","dblclick"],create:function(e,t){var n=t.map((function(t){return e.unproject(t)})),i=new Uf(n);return i._setPrjCoordinates(t),i},update:Gd.update,generate:function(e){return e}}),od.registerMode("cubicbeziercurve",{action:["click","mousemove","dblclick"],create:function(e,t){var n=t.map((function(t){return e.unproject(t)})),i=new Gf(n);return i._setPrjCoordinates(t),i},update:Gd.update,generate:function(e){return e}}),od.registerMode("boxZoom",{action:["mousedown","mousemove","mouseup"],create:function(e,t){var n=e.unproject(t=t[0]),i=new mf(n);return i._firstClick=t,i},update:function(e,t,n,i){var s=n.getMap(),o=s.prjToContainerPoint(n._firstClick),a=i.containerPoint;t=s._containerPointToPrj(new fl(Math.min(o.x,a.x),Math.min(o.y,a.y)));var l=e.unproject(t);n.setCoordinates(l)._setPrjCoordinates(t),n.updateSymbol({markerWidth:Math.abs(o.x-a.x),markerHeight:Math.abs(o.y-a.y)})},generate:function(e){return e}});var Ud=["collision","collisionBufferSize","collisionWeight","collisionFadeIn"],Vd=function(e){function t(t){var n;return(n=e.call(this,t)||this).proxyOptions(),n}Te(t,e);var n=t.prototype;return n._appendCustomClass=function(e){if(!e)return console.warn("dom is null:",e),this;if(this.options.cssName){var t=this.options.cssName;Array.isArray(t)||(t=[t]),t.forEach((function(t){e.classList.add(t)}))}return this},n.onAdd=function(){},n.onRemove=function(){},n.onDomRemove=function(){},n.getEvents=function(){return{}},n.getOwnerEvents=function(){return{}},n.buildOn=function(){return null},n.addTo=function(e){return this._owner=e,this._switchEvents("on"),this.onAdd&&this.onAdd(),this.fire("add"),this},n.getMap=function(){return this._owner?this._owner.getBaseLayer?this._owner:this._owner.getMap():null},n._collides=function(){var e=this.getMap();return e?(e._addUI(this),e._insertUICollidesQueue(),this):this},n._collidesEffect=function(e){var t=this.getDOM();if(!t)return this;if(t.style.visibility=e?"visible":"hidden",!t.classList||!t.classList.add)return this;if(!this.options.collisionFadeIn)return this;var n="mtk-ui-fadein",i=t.classList.contains(n);return e&&!i?t.classList.add(n):!e&&i&&t.classList.remove(n),this},n.show=function(e){var t=this,n=this.getMap();if(!n)return this;this.options.visible=!0,(e=e||this._coordinate||this._owner.getCenter())instanceof fl||(e=new fl(e));var i=this.isVisible();this._onlyUpdatePosition||this.fire("showstart");var s,o=this._getUIContainer();this._coordinate=e,this._onlyUpdatePosition||this._removePrevDOM(),this._mapEventsOn||this._switchMapEvents("on"),(s=this._onlyUpdatePosition?this.__uiDOM:this.__uiDOM=this.buildOn()).eventsPropagation=this.options.eventsPropagation,this._observerDomSize(s);var a=this.options.zIndex;if(!s)return this._onlyUpdatePosition||this.fire("showend"),this._collides(),this.setZIndex(a),this;this._onlyUpdatePosition||this._measureSize(s),this._singleton()&&(s._uiComponent=this,n[this._uiDomKey()]=s),this._setPosition(),s.style[fn]=null,this._onlyUpdatePosition||o.appendChild(s);var l=this._getAnimation();if(i&&(l.ok=!1),l.ok&&(l.fade&&(s.style.opacity="0"),l.scale)){if(this.getTransformOrigin){var h=this.getTransformOrigin();s.style[un]=h}s.style[sn]=this._toCSSTranslate(this._pos)+" scale(0)"}this.isSupportZoomFilter()||(s.style.display=""),this.options.eventsToStop&&jn(s,this.options.eventsToStop,Cn);var c=l.transition;return l.ok&&c&&(c&&(s.style[fn]=c),l.fade&&(s.style.opacity="1"),l.scale&&(s.style[sn]=this._toCSSTranslate(this._pos)+" scale(1)")),this._onlyUpdatePosition||this.fire("showend"),this._collides(),clearTimeout(this._autoPanId),this.options.autoPan&&(this._autoPanId=setTimeout((function(){t._autoPan()}),32)),this.setZIndex(a),this},n.hide=function(){var e=this;if(!this.getDOM())return this;this._onDomMouseout&&this._onDomMouseout(),this.options.visible=!1;var t=this._getAnimation(),n=this.getDOM();return this.options.animationOnHide||(t.ok=!1),t.ok?(n.style[fn]=t.transition,setTimeout((function(){n.style.display="none",e.fire("hide")}),this.options.animationDuration)):(n.style.display="none",this.fire("hide")),t.fade&&(n.style.opacity="0"),t.scale&&(n.style[sn]=this._toCSSTranslate(this._pos)+" scale(0)"),this._switchMapEvents("off"),this._collides(),this},n.isVisible=function(){if(!this.options.visible)return!1;var e=this.getDOM();return this.getMap()&&e&&e.parentNode&&"none"!==e.style.display},n.remove=function(){if(delete this._mapEventsOn,!this._owner)return this;var e=this.getMap();return e&&e._removeUI(this),this.hide(),this._switchEvents("off"),this.onRemove&&this.onRemove(),!this._singleton()&&this.__uiDOM&&this._removePrevDOM(),delete this._owner,this.fire("remove"),this._collides(),this},n.getSize=function(){return this._domContentRect&&this._size&&(this._size.width=this._domContentRect.width,this._size.height=this._domContentRect.height),this._size?this._size.copy():null},n.getOwner=function(){return this._owner},n.getDOM=function(){return this.__uiDOM},n.setZIndex=function(e){if(!c(e))return this;var t=this.getDOM();return t?(t.style.zIndex=e+"",e!==this.options.zIndex&&(this.options.zIndex=e),this):this},n._roundPoint=function(e){return this.options.roundPoint&&(e=e._round()),e},n.getPosition=function(){if(!this.getMap())return null;var e=this._roundPoint(this._getViewPoint());if(this.getOffset){var t=this._roundPoint(this.getOffset());t&&e._add(t)}return e},n._getAnimation=function(){for(var e={fade:!1,scale:!1,ok:!1,transition:""},t=this.options.animation?this.options.animation.split(","):[],n=0;n<t.length;n++){var i=Rt(t[n]);"fade"===i?e.fade=!0:"scale"===i&&(e.scale=!0)}var s=null;return e.fade&&(s="opacity "+this.options.animationDuration+"ms"),e.scale&&(s=s?s+",":"",s+=sn+" "+this.options.animationDuration+"ms"),e.transition=s,e.ok=null!==s,e},n._getViewPoint=function(){var e=0,t=this._coordinate||{};if(c(t.z)?e=t.z:this._owner&&this._owner.getAltitude&&(c(e=this._owner.getAltitude()||0)||(e=0)),this._owner.getLayer){var n=this._owner.getLayer();n&&n.isVectorLayer&&(c(e=this._owner._getAltitude()||0)||(e=0))}var i=this._meterToPoint(this._coordinate,e);return this.getMap().coordToViewPoint(this._coordinate,void 0,i)._add(this.options.dx,this.options.dy)},n._meterToPoint=function(e,t){return t},n._autoPan=function(){var e=this.getMap(),t=this.getDOM();if(t&&e&&!e.isMoving()){var n=this._getViewPoint()._round(),i=e.width,s=e.height,o=e.getContainer();if(t&&o&&t.getBoundingClientRect){var a=o.getBoundingClientRect(),l=a.left,h=a.top,c=50,u=t.getBoundingClientRect(),f=0,g=0,{left:m,right:A,top:w,bottom:T}=u,{width:S,height:M}=u;if(m-=l,A-=l,w-=h,T-=h,S>0&&M>0){if(m<c&&(f=c-m),0===f&&A+c>i&&(f=-(A+c-i)),w<c&&(g=c-w),0===g&&T+c>s&&(g=-(T+c-s)),0!==f||0!==g)e.getPitch()>40&&0!==g&&this._coordinate?e.animateTo({center:this._coordinate},{duration:e.options.panAnimationDuration}):e.panBy([Math.ceil(f),Math.ceil(g)]);return}}var C=e.viewPointToContainerPoint(n),I=this.getOffset(),E=C.add(I),D=e.viewPointToPrj(n),H=parseInt(t.clientWidth+""),N=parseInt(t.clientHeight+""),B=0,z=0;if(E.x<0?B=50-E.x:E.x+H>i&&(B=-(E.x+H-i)-50),E.y-N<0?z=Math.abs(E.y-N)+50:E.y+N>s&&(z=s-(E.y+N)-50),H>=i&&(B=i/2-C.x),0!==z||0!==B){var U=C.add(B,z),j=e._containerPointToPoint(U)._sub(e._prjToPoint(e._getPrjCenter())),W=e._pointToPrj(e._prjToPoint(D).sub(j));e._panAnimation(W)}}},n._measureSize=function(e){var t=this._getUIContainer();e.style.position="absolute";var n=e.style.bottom?"bottom":"top";if(e.style.display="",t.appendChild(e),e.getBoundingClientRect){var i=e.getBoundingClientRect();this._size=new Ot(i.width,i.height)}else this._size=new Ot(e.clientWidth,e.clientHeight);return e.style.display="none",e.style.left="0px",e.style[n]="0px",this._size},n._removePrevDOM=function(){this.onDomRemove&&this.onDomRemove();var e=this.options.eventsToStop;if(this._singleton()){var t=this.getMap(),n=this._uiDomKey();if(t[n]){e&&Wn(t[n],e,Cn);var i=t[n]._uiComponent;i&&i!==this&&i.isVisible()&&i.fire("hide"),yn(t[n]),i&&!this.hideDom&&i._switchMapEvents("off"),delete t[n]}delete this.__uiDOM}else this.__uiDOM&&(e&&Wn(this.__uiDOM,e,Cn),yn(this.__uiDOM),delete this.__uiDOM);this._resizeObserver&&(this._resizeObserver.disconnect(),delete this._resizeObserver,delete this._domContentRect)},n._uiDomKey=function(){return"__ui_"+this._getClassName()},n._singleton=function(){return this.options.single},n._getUIContainer=function(){return this.getMap().getPanels().ui},n._getClassName=function(){return"UIComponent"},n._switchMapEvents=function(e){var t=this.getMap();if(t){this._mapEventsOn="on"===e;var n=this._getDefaultEvents();if(this.getEvents&&l(n,this.getEvents()),n)for(var i in n)n.hasOwnProperty(i)&&t[e](i,n[i],this)}},n._switchEvents=function(e){var t=this._getOwnerEvents();if(this._owner)for(var n in t)t.hasOwnProperty(n)&&this._owner[e](n,t[n],this)},n._getDefaultEvents=function(){return{"zooming rotate pitch":this.onEvent,zoomend:this.onZoomEnd,moving:this.onMoving,moveend:this.onMoving,resize:this.onResize}},n._getOwnerEvents=function(){var e={};return this._owner&&this._owner instanceof gu&&(e.positionchange=this.onGeometryPositionChange,e.symbolchange=this._updatePosition),this.getOwnerEvents&&l(e,this.getOwnerEvents()),e},n.onGeometryPositionChange=function(e){if(this._owner&&this.isVisible()){this._onlyUpdatePosition=!0;var t=e.target,n=t.getCenter();if(t._getAltitude){var i=t._getAltitude();c(i)&&(n.z=i)}this.show(n),this._onlyUpdatePosition=!1}},n.onMoving=function(){this.isVisible()&&this.getMap().isTransforming()&&this._updatePosition()},n.onEvent=function(){this.isVisible()&&this._updatePosition()},n.onZoomEnd=function(){this.isVisible()&&this._setPosition()},n.onResize=function(){this.isVisible()&&this._setPosition()},n.onDomSizeChange=function(){this.isVisible()&&(this._setPosition(),this._collides())},n._updatePosition=function(){return this.getMap()?(this.getMap()._getRenderer().callInNextFrame(this._setPosition.bind(this)),this):this},n._setPosition=function(){var e=this.getDOM();if(e){e.style[fn]=null;var t=this.getPosition();this._pos=t,e.style[sn]=this._toCSSTranslate(t)+" scale(1)"}},n._toCSSTranslate=function(e){if(!e)return"";if(ye.any3d){var t=this.getMap(),n=t?t.getBearing():0,i=t?t.getPitch():0,s="";return this.options.pitchWithMap&&i&&(s+=" rotateX("+Math.round(i)+"deg)"),this.options.rotateWithMap&&n&&(s+=" rotateZ("+Math.round(-n)+"deg)"),"translate3d("+Math.round(e.x)+"px,"+Math.round(e.y)+"px, 0px)"+s}return"translate("+Math.round(e.x)+"px,"+Math.round(e.y)+"px)"},n._observerDomSize=function(e){var t=this;return e&&ye.resizeObserver&&!this._resizeObserver?(this._resizeObserver=new ResizeObserver((function(e){if(e.length){var n=e[0].borderBoxSize;t._domContentRect=n&&n.length?{width:n[0].inlineSize,height:n[0].blockSize}:e[0].contentRect}else delete t._domContentRect;t.onDomSizeChange&&t.onDomSizeChange()})),this._resizeObserver.observe(e),this):this},n.isSupportZoomFilter=function(){return!1},n.onConfig=function(e){var t=!1;if(e)for(var n=0,i=Ud.length;n<i;n++){if(Ud[n]in e){t=!0;break}}if(this._updatePosition(),t){this._collides();var s=this.getMap();s&&s._sortUI&&s._sortUI()}return this},t.isSupport=function(e){return!!(e&&m(e.on)&&m(e.off)&&m(e.getCenter))},n._bindDomEvents=function(e,t){if(e){var n=this._getDomEvents()||{},i="on"===t?jn:Wn;for(var s in n)"on"===t&&Wn(e,s,n[s]),i(e,s,n[s],this)}},n._getDomEvents=function(){return{mouseover:this._onDomMouseover,mouseout:this._onDomMouseout}},n._configMapPreventWheelScroll=function(e){var t=this.getMap();t&&(this.options.eventsPropagation||(t.options.preventWheelScroll=e))},n._onDomMouseover=function(){this._configMapPreventWheelScroll(!1),this.fire("mouseover")},n._onDomMouseout=function(){this._configMapPreventWheelScroll(!0),this.fire("mouseout")},t}(Ba(Ua));Vd.mergeOptions({eventsPropagation:!1,eventsToStop:null,dx:0,dy:0,autoPan:!1,autoPanDuration:600,single:!0,animation:"scale",animationOnHide:!1,animationDuration:500,pitchWithMap:!1,rotateWithMap:!1,visible:!0,roundPoint:!1,collision:!1,collisionBufferSize:2,collisionWeight:0,collisionFadeIn:!1,zIndex:0});var jd="mousedown mouseup mouseenter mouseover mouseout mousemove click dblclick contextmenu keypress touchstart touchmove touchend",Wd=function(e){function t(t,n){var i;return(i=e.call(this,n)||this)._markerCoord=new fl(t),i}Te(t,e);var n=t.prototype;return n._getClassName=function(){return"UIMarker"},n.setCoordinates=function(e){if(!e)return this;if(!(e instanceof fl))try{e=new fl(e)}catch(e){return console.error(e),this}return this._markerCoord=e,this.fire("positionchange"),this.isVisible()&&(this._onlyUpdatePosition=!0,this._coordinate=this._markerCoord,this._setPosition(),this._collides(),this._onlyUpdatePosition=!1),this},n.getCoordinates=function(){return this._markerCoord},n.getCenter=function(){return this.getCoordinates()},n.getAltitude=function(){var e=this.getCoordinates()||{};return c(e.z)?e.z:this.options.altitude||0},n.setAltitude=function(e){return c(e)&&this._markerCoord&&(this._markerCoord.z=e,this._updatePosition&&(this._updatePosition(),this._collides())),this},n.setContent=function(e){var t=this.options.content;return this.options.content=e,this.fire("contentchange",{old:t,new:e}),this.isVisible()&&this.show(),this},n.getContent=function(){return this.options.content},n.onAdd=function(){if(this._owner&&!this._owner.isMap){var e=this._owner;throw new Error("UIMarker Can only be added to the map, but owner is:"+e.getJSONType&&e.getJSONType())}return this.show(),this},n.show=function(){return e.prototype.show.call(this,this._markerCoord)},n.flash=function(e,t,n,i){return ut.call(this,e,t,n,i)},n.buildOn=function(){var e,t=this.getDOM();this._bindDomEvents(t,"off");var n=this.options.content,i=g(n);return i||m(n)?(e=pn("div"),i?e.innerHTML=this.options.content:n.bind(this)(e)):e=this.options.content,this.options.containerClass&&(e.className=this.options.containerClass),this._registerDOMEvents(e),this._bindDomEvents(e,"on"),this._appendCustomClass(e),e},n.getOffset=function(){var e=this.getSize(),t=-e.width/2,n=-e.height/2,{horizontalAlignment:i,verticalAlignment:s}=this.options;return"left"===i?t=-e.width:"right"===i&&(t=0),"top"===s?n=-e.height:"bottom"===s&&(n=0),new Re(t,n)},n.getTransformOrigin=function(){return"center center"},n.onDomRemove=function(){var e=this.getDOM();this._removeDOMEvents(e)},n.isDragging=function(){return!!this.draggable&&this.draggable.isDragging()},n._registerDOMEvents=function(e){jn(e,jd,this._onDomEvents,this)},n._onDomEvents=function(e,t){var n=this.getMap()._parseEvent(e,e.type);if("mousedown"===(t=t||e.type)&&(this._mousedownEvent=e),"mouseup"===t&&(this._mouseupEvent=e),("click"!==t||!this._mouseClickPositionIsChange())&&("touchstart"===t&&(this._touchstartTime=a()),this.fire(t,n),"touchend"===t&&ye.touch)){var i=this.getMap().options.clickTimeThreshold||280;a()-this._touchstartTime<i&&this._onDomEvents(e,"click")}},n._removeDOMEvents=function(e){Wn(e,jd,this._onDomEvents)},n._mouseClickPositionIsChange=function(){var{x:e,y:t}=this._mousedownEvent||{},{x:n,y:i}=this._mouseupEvent||{};return e!==n||t!==i},n._getConnectPoints=function(){var e=this.getMap(),t=e.coordToContainerPoint(this.getCoordinates()),n=this.getSize(),i=n.width,s=n.height;return[e.containerPointToCoordinate(t.add(-i/2,0)),e.containerPointToCoordinate(t.add(i/2,0)),e.containerPointToCoordinate(t.add(0,s/2)),e.containerPointToCoordinate(t.add(0,-s/2))]},n._getViewPoint=function(){var e=0;if(this._owner){var t=this.getAltitude();t>0&&(e=this._meterToPoint(this._coordinate,t))}return this.getMap().coordToViewPoint(this._coordinate,void 0,e)._add(this.options.dx,this.options.dy)},n._getDefaultEvents=function(){return l({},e.prototype._getDefaultEvents.call(this),{"zooming zoomend":this.onZoomFilter})},n._setPosition=function(){this.onZoomFilter(),e.prototype._setPosition.call(this)},n.onZoomFilter=function(){var e=this.getDOM();e&&(this.isVisible()||"none"===e.style.display?this.isVisible()&&"none"===e.style.display&&(e.style.display=""):e.style.display="none")},n.isVisible=function(){var e=this.getMap();if(!e)return!1;if(!this.options.visible)return!1;var t=e.getZoom(),{minZoom:n,maxZoom:i}=this.options;return!(!h(n)&&t<n||!h(i)&&t>i)&&(this.getDOM()&&!0)},n.isSupportZoomFilter=function(){return!0},t}(al(Vd));Wd.mergeOptions({containerClass:null,eventsPropagation:!0,draggable:!1,single:!1,content:null,altitude:0,minZoom:0,maxZoom:null,horizontalAlignment:"middle",verticalAlignment:"middle"});var qd=ye.touch?"touchstart mousedown":"mousedown",Zd=function(e){function t(t){return e.call(this,t)||this}Te(t,e);var n=t.prototype;return n.addHooks=function(){this.target.on(qd,this._startDrag,this)},n.removeHooks=function(){this.target.off(qd,this._startDrag,this)},n._startDrag=function(e){var t=e.domEvent;t.touches&&t.touches.length>1||2===t.button||this.isDragging()||(this.target.on("click",this._endDrag,this),this._lastCoord=e.coordinate,this._lastPoint=e.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(e.domEvent),this.target.fire("dragstart",e))},n._prepareDragHandler=function(){this._dragHandler=new ul(this.target.getDOM(),{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this),this._dragHandler.on("dragging",this._dragging,this),this._dragHandler.on("mouseup",this._endDrag,this),this._dragHandler.enable()},n._cancelOn=function(e){var t=(e.srcElement||e.target).tagName.toLowerCase();return"button"===t||"input"===t||"select"===t||"option"===t||"textarea"===t},n._onMouseDown=function(e){Cn(e.domEvent)},n._dragging=function(e){var t=this.target,n=t.getMap()._parseEvent(e.domEvent),i=n.domEvent;if(!(i.touches&&i.touches.length>1))if(this._isDragging){var s=n.coordinate,o=n.containerPoint;this._lastCoord||(this._lastCoord=s),this._lastPoint||(this._lastPoint=o);var a=s.sub(this._lastCoord),l=o.sub(this._lastPoint);this._lastCoord=s,this._lastPoint=o,this.target.setCoordinates(this.target.getCoordinates().add(a)),n.coordOffset=a,n.pointOffset=l,t.fire("dragging",n)}else this._isDragging=!0},n._endDrag=function(e){var t=this.target,n=t.getMap();if(this._dragHandler&&(t.off("click",this._endDrag,this),this._dragHandler.disable(),delete this._dragHandler),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1,n){var i=n._parseEvent(e.domEvent);t&&t._mouseClickPositionIsChange&&t._mouseClickPositionIsChange()&&t.fire("dragend",i)}},n.isDragging=function(){return!!this._isDragging},t}(za);Wd.addInitHook("addHandler","draggable",Zd);var Xd=/\{ *([\w_]+) *\}/g,Yd={containerClass:"maptalks-msgBox",autoPan:!0,autoCloseOn:null,autoOpenOn:"click",width:"auto",minHeight:120,custom:!1,title:null,content:null,enableTemplate:!1},Jd=new Ot(0,0),Qd=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n._getClassName=function(){return"InfoWindow"},n.addTo=function(t){return t instanceof gu&&(t.getInfoWindow()&&t.getInfoWindow()!==this&&t.removeInfoWindow(),t._infoWindow=this),e.prototype.addTo.call(this,t)},n.setContent=function(e){var t=this.options.content;return this.options.content=e,this.fire("contentchange",{old:t,new:e}),this.isVisible()&&this.show(this._coordinate),this},n.getContent=function(){return this.options.content},n.setTitle=function(e){var t=e;return this.options.title=e,this.fire("contentchange",{old:t,new:e}),this.isVisible()&&this.show(this._coordinate),this},n.getTitle=function(){return this.options.title},n.buildOn=function(){var e=this,t=m(this.options.content),n=g(this.options.content);if(this.options.custom){var i,s=this.getDOM();if(this._bindDomEvents(s,"off"),n||t){var o=pn("div");n?(o.innerHTML=this.options.content,this._replaceTemplate(o)):this.options.content.bind(this)(o),i=o}else this._replaceTemplate(this.options.content),i=this.options.content;return this._bindDomEvents(i,"on"),this._appendCustomClass(i),i}this._bindDomEvents(this.getDOM(),"off");var a=pn("div");this.options.containerClass&&(a.className=this.options.containerClass);var l=this._getWindowWidth();a.style.width=c(l)?l+"px":"auto",a.style.bottom="0px";var h='<em class="maptalks-ico"></em>';this.options.title&&(h+="<h2>"+this.options.title+"</h2>"),a.innerHTML=h+='<a href="javascript:void(0);" class="maptalks-close">×</a><div class="maptalks-msgContent"></div>',this._replaceTemplate(a);var u=a.querySelector(".maptalks-msgContent");return n||t?n?u.innerHTML=this.options.content:this.options.content.bind(this)(u):u.appendChild(this.options.content),this._onCloseBtnClick=function(t){e.options.eventsPropagation||(Mn(t),Cn(t)),e.hide()},vn(a.querySelector(".maptalks-close"),"click touchend",this._onCloseBtnClick),t||this._replaceTemplate(u),this._bindDomEvents(a,"on"),this._appendCustomClass(a),a},n._replaceTemplate=function(e){var t=this._owner;if(this.options.enableTemplate&&t&&t.getProperties&&e&&e.innerHTML){var n=t.getProperties()||{};if(f(n))e.innerHTML=e.innerHTML.replace(Xd,(function(e,t){return n[t]}))}return this},n.getTransformOrigin=function(){return this.getSize().width/2+"px bottom"},n.getOffset=function(){var e=this.getSize(),t=new Re(-e.width/2,0);this.options.custom?t._sub(0,e.height):t._sub(4,12);var n=this.getOwner();if(n instanceof mf||n instanceof Tf){var i,s;if(n instanceof mf)i=n._getPainter(),s=n.getSize();else{var o=n.getGeometries();if(!o||!o.length)return t;i=o[0]._getPainter(),s=o[0].getSize()}if(s||(s=Jd),i){var a=i.getFixedExtent();t._add(a.xmax-s.width/2,a.ymin)}else t._add(0,-s.height)}return t},n.show=function(t){return this.getMap()&&this.getMap().options.enableInfoWindow?e.prototype.show.call(this,t):this},n.getEvents=function(){if(!this.options.autoCloseOn)return null;var e={};return e[this.options.autoCloseOn]=this.hide,e},n.getOwnerEvents=function(){var e=this.getOwner();if(!this.options.autoOpenOn||!e)return null;var t={};return t[this.options.autoOpenOn]=this._onAutoOpen,t},n.onRemove=function(){this._onDomMouseout(),this.onDomRemove()},n.onDomRemove=function(){this._onCloseBtnClick&&(bn(this.getDOM().childNodes[2],"click touchend",this._onCloseBtnClick),delete this._onCloseBtnClick)},n._onAutoOpen=function(e){var t=this,n=this.getOwner();setTimeout((function(){n instanceof mf||n instanceof Vd?t.show(n.getCoordinates()):n instanceof Tf?t.show(n.findClosest(e.coordinate)):n instanceof yf||n instanceof Mf?(t.getMap().getScale()>=8&&(e.coordinate=t._rectifyMouseCoordinte(n,e.coordinate)),t.show(e.coordinate)):t.show(e.coordinate)}),1)},n._rectifyMouseCoordinte=function(e,t){var n=this;return e instanceof yf?this._rectifyLineStringMouseCoordinate(e,t).coordinate:e instanceof Mf?e.getGeometries().map((function(e){return n._rectifyLineStringMouseCoordinate(e,t)})).sort((function(e,t){return e.dis-t.dis}))[0].coordinate:t},n._rectifyLineStringMouseCoordinate=function(e,t){for(var n=this.getMap(),i=e.getCoordinates()||[],s=n.getGLRes(),o=i.map((function(e){var t=n.coordToPointAtRes(e,s);return n._pointAtResToContainerPoint(t,s,e.z||0)})),a=n.coordToContainerPoint(t),l=1/0,h=-1,c=0,u=o.length;c<u;c++){var f=a.distanceTo(o[c]);f<l&&(l=f,h=c)}for(var g=[h-1,h,h+1].filter((function(e){return e>=0&&e<=o.length-1})),m=g.map((function(e){return o[e]})),A=[],{width:w,height:T}=n.getSize(),S=0,M=m.length-1;S<M;S++){var C=S,I=m[S],E=m[S+1];if(I.x===E.x)for(var D=Math.max(0,Math.min(I.y,E.y)),H=Math.min(T,Math.max(I.y,E.y)),N=D;N<=H;N++)A.push({point:new Re(I.x,N),coordinateIndex:C});else for(var B=(E.y-I.y)/(E.x-I.x),z=Math.max(0,Math.min(I.x,E.x)),U=Math.min(w,Math.max(I.x,E.x)),j=z;j<=U;j++){A.push({point:new Re(j,B*(j-I.x)+I.y),coordinateIndex:C})}}for(var W,q=1/0,Z=-1,X=-1,Y=0,J=A.length;Y<J;Y++){var{point:Q,coordinateIndex:$}=A[Y],K=a.distanceTo(Q);K<q&&(q=K,Z=Y,X=$,W=Q)}if(Z<0)return{dis:q,coordinate:t};var ee=m[X],te=ee.distanceTo(m[X+1]),re=W.distanceTo(ee)/te,se=g.map((function(e){return i[e]})),oe=se[X],le=se[X+1],he=oe.x,ue=oe.y,fe=oe.z||0;return{dis:q,coordinate:new fl(he+(le.x-he)*re,ue+(le.y-ue)*re,fe+((le.z||0)-fe)*re)}},n._getWindowWidth=function(){var e=this.options.width;return e||(e=Yd.width),e},t}(Vd);Qd.mergeOptions(Yd);var $d="remove hide shapechange positionchange dragend animatestart",Kd=function(e){function t(t,n={}){var i;return(i=e.call(this,n)||this)._content=t,i}Te(t,e);var n=t.prototype;return n._getClassName=function(){return"ToolTip"},n.addTo=function(n){if(t.isSupport(n))return n.on("mousemove",this.onMouseMove,this),n.on("mouseout",this.onMouseOut,this),n.on($d,this.hideDom,this),e.prototype.addTo.call(this,n);throw new Error("Invalid geometry or UIMarker the tooltip is added to.")},n.setStyle=function(e){return this.options.containerClass=e,this},n.getStyle=function(){return this.options.containerClass},n.getContent=function(){return this._content},n.buildOn=function(){var e=pn("div"),t=this.options||{};t.height&&(e.style.height=t.height+"px"),t.width&&(e.style.width=t.width+"px");var n=t.containerClass||t.cssName;return!n&&t.height&&(e.style.lineHeight=t.height+"px"),m(this._content)?this._content.bind(this)(e):e.innerHTML='<div class="'+n+'">'+this._content+"</div>",this._appendCustomClass(e),e},n.onMouseOut=function(){clearTimeout(this._timeout),this.isVisible()&&this._removePrevDOM(),this._switchMapEvents("off")},n.onMouseMove=function(e){var t=this;clearTimeout(this._timeout);var n=this.getMap();if(n){var i=n.locateByPoint(e.coordinate,-5,25);0===this.options.showTimeout?this.show(i):this._timeout=setTimeout((function(){n&&t.show(i)}),this.options.showTimeout)}},n.onRemove=function(){clearTimeout(this._timeout),this._owner&&(this._owner.off("mousemove",this.onMouseMove,this),this._owner.off("mouseout",this.onMouseOut,this),this._owner.off($d,this.hideDom,this))},n.hideDom=function(){this.hide()},n.onEvent=function(){return e.prototype.onEvent.call(this),this.hideDom(),this},n._getViewPoint=function(){return this.getMap().coordToViewPoint(this._coordinate,void 0,0)._add(this.options.dx,this.options.dy)},t}(Vd);Kd.mergeOptions({width:0,height:0,animation:"fade",containerClass:"maptalks-tooltip",showTimeout:400});var ep=function(e){function t(t){return e.call(this,t)||this}Te(t,e);var n=t.prototype;return n._getClassName=function(){return"Menu"},n.addTo=function(e){return e._menu&&e._menu!==this&&e.removeMenu(),e._menu=this,this._owner=e,Vd.prototype.addTo.apply(this,[e])},n.setItems=function(e){return this.options.items=e,this},n.getItems=function(){return this.options.items||[]},n.buildOn=function(){var e;if(this.options.custom)if(g(this.options.items)){var t=pn("div");t.innerHTML=this.options.items,this._appendCustomClass(t),e=t}else e=this.options.items;else{e=pn("div"),this.options.containerClass&&Fn(e,this.options.containerClass),e.style.width=this._getMenuWidth()+"px";var n=this._createMenuItemDom();e.appendChild(n),jn(e,"contextmenu",Mn),this._appendCustomClass(e)}return e&&(this._bindDomEvents(e,"off"),this._bindDomEvents(e,"on")),e},n.getOffset=function(){if(!this.getMap())return null;var e=this.getMap().getSize(),t=this.getMap().viewPointToContainerPoint(this._getViewPoint()),n=this.getSize(),i=0,s=0;return t.x+n.width>e.width&&(i=-n.width),t.y+n.height>e.height&&(s=-n.height),new Re(i,s)},n.getTransformOrigin=function(){var e=this.getOffset()._multi(-1);return e.x+"px "+e.y+"px"},n.getEvents=function(){return{"_zoomstart _zoomend _movestart _dblclick _click":this._removePrevDOM}},n._createMenuItemDom=function(){var e=this,t=this.getMap(),n=pn("ul");Fn(n,"maptalks-menu-items");var i,s,o=this.getItems();function a(n){return function(i){var s=t._parseEvent(i,"click");s.target=e,s.owner=e._owner,s.index=n,!1!==this._callback(s)&&(e.hide(),e._owner&&e._owner.fire("closemenu"))}}for(var l=0,h=o.length;l<h;l++){if("-"===(i=o[l])||"_"===i)Fn(s=pn("li"),"maptalks-menu-splitter");else{s=pn("li");var c=i.item;m(c)&&(c=c({owner:this._owner,index:l})),s.innerHTML=c,s._callback=i.click,jn(s,"click",a(l))}n.appendChild(s)}var u=this.options.maxHeight||0;return u>0&&Ln(n,"max-height: "+u+"px; overflow-y: auto;"),n},n._getMenuWidth=function(){return this.options.width||160},t}(Vd);ep.mergeOptions({containerClass:"maptalks-menu",animation:null,animationDelay:10,animationOnHide:!1,autoPan:!1,width:160,maxHeight:0,custom:!1,items:[]});var tp={setMenu:function(e){return this._menuOptions=e,this._menu?this._menu._setOptions(e):this.on("contextmenu",this._defaultOpenMenu,this),this},getMenu:function(){return this._menu},openMenu:function(e){var t=this instanceof zu?this:this.getMap();return e||(e=this.getCenter()),this._menu?this._menu.show(e):this._menuOptions&&t&&(this._bindMenu(),this._menu.show(e)),this.fire("openmenu",{coordinate:e}),this},setMenuItems:function(e){return this._menuOptions||(this._menuOptions={}),Array.isArray(e)&&(this._menuOptions.custom=!1),this._menuOptions.items=e,this.setMenu(this._menuOptions),this},getMenuItems:function(){return this._menu?this._menu.getItems():this._menuOptions&&this._menuOptions.items||[]},closeMenu:function(){return this._menu&&this._menu.hide(),this.fire("closemenu",{}),this},removeMenu:function(){return this.off("contextmenu",this._defaultOpenMenu,this),this._unbindMenu(),delete this._menuOptions,this.fire("removemenu",{}),this},_bindMenu:function(){return this._menuOptions?(this._menu=new ep(this._menuOptions),this._menu.addTo(this),this):this},_unbindMenu:function(){return this._menu&&(this.closeMenu(),this._menu.remove(),delete this._menu),this},_defaultOpenMenu:function(e){return this.openMenu(e.coordinate),!1}};zu.include(tp),gu.include(tp);var np=Object.freeze({__proto__:null,InfoWindow:Qd,Menu:ep,Menuable:tp,ToolTip:Kd,UIComponent:Vd,UIMarker:Wd}),rp=function(e){function t(t){return t&&t.position&&!g(t.position)&&(t.position=l({},t.position)),e.call(this,t)||this}Te(t,e);var n=t.prototype;return n._appendCustomClass=function(e){if(!e)return console.warn("dom is null:",e),this;if(this.options.cssName){var t=this.options.cssName;Array.isArray(t)||(t=[t]),t.forEach((function(t){e.classList.add(t)}))}return this},n.onAdd=function(){},n.onRemove=function(){},n.addTo=function(e){if(this.remove(),!e.options.control)return this;this._map=e;var t=e.getPanels().control;return this.__ctrlContainer=pn("div"),Ln(this.__ctrlContainer,"position:absolute;overflow:visible;"),this.update(),t.appendChild(this.__ctrlContainer),this.onAdd&&this.onAdd(),this.fire("add",{dom:t}),this},n.update=function(){return this.__ctrlContainer.innerHTML="",this._controlDom=this.buildOn(this.getMap()),this._controlDom&&(this._updatePosition(),this.__ctrlContainer.appendChild(this._controlDom)),this},n.getMap=function(){return this._map},n.getPosition=function(){return l({},this._parse(this.options.position))},n.setPosition=function(e){return this.options.position=g(e)?e:l({},e),this._updatePosition(),this},n.getContainerPoint=function(){var e,t,n=this.getPosition(),i=this.getMap().getSize();return h(n.left)?h(n.right)||(e=i.width-parseInt(n.right+"")):e=parseInt(n.left+""),h(n.top)?h(n.bottom)||(t=i.height-parseInt(n.bottom+"")):t=parseInt(n.top+""),new Re(e,t)},n.getContainer=function(){return this.__ctrlContainer},n.getDOM=function(){return this._controlDom},n.show=function(){return this.__ctrlContainer.style.display="",this},n.hide=function(){return this.__ctrlContainer.style.display="none",this},n.isVisible=function(){return this.__ctrlContainer&&""===this.__ctrlContainer.style.display},n.remove=function(){return this._map?(yn(this.__ctrlContainer),this.onRemove&&this.onRemove(),delete this._map,delete this.__ctrlContainer,delete this._controlDom,this.fire("remove"),this):this},n._parse=function(e){var n=e;return g(e)&&(n=t.positions[n]),n},n._updatePosition=function(){var e=this.getPosition();for(var t in e||(e={top:20,left:20}),this.__ctrlContainer&&Object.assign(this.__ctrlContainer.style,{top:null,bottom:null,right:null,left:null}),e)if(e.hasOwnProperty(t)){var n=e[t]||0;c(n)&&(n+="px"),this.__ctrlContainer.style[t]=n}this.fire("positionchange",{position:l({},e)})},n.onConfig=function(e){e&&"position"in e&&this._updatePosition()},t}(Ba(Ua));rp.positions={"top-left":{top:20,left:20},"top-right":{top:20,right:20},"bottom-left":{bottom:20,left:20},"bottom-right":{bottom:20,right:20}},zu.mergeOptions({control:!0}),zu.include({addControl:function(e){return this._containerDOM.getContext||e.addTo(this),this},removeControl:function(e){return e&&e.getMap()===this?(e.remove(),this):this}});var ip="addlayer removelayer setbaselayer baselayerremove",sp=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.buildOn=function(){return this._attributionContainer=pn("div"),this._attributionContainer.className="maptalks-attribution",this._appendCustomClass(this._attributionContainer),this._update(),this._attributionContainer},n.getContent=function(){return this.options.content},n.setContent=function(e){return this.options.content=e,this._update(),this},n.onAdd=function(){this.getMap().on(ip,this._update,this)},n.onRemove=function(){this.getMap().off(ip,this._update,this)},n._updateContent=function(){var e=this._attributionContainer,t=this.options.content||"";return e&&(e.innerHTML="",g(t)?e.innerHTML=t:t instanceof HTMLElement&&e.appendChild(e)),this},n._update=function(){if(this.options.custom)this._updateContent();else{var e=this.getMap();if(e){var t=e._getLayers((function(e){return!!e.options.attribution})).reverse().map((function(e){return e.options.attribution})),n=this.options.content+(t.length>0?" - "+t.join(", "):"");this._attributionContainer.innerHTML='<span style="padding:0px 4px">'+n+"</span>"}}},t}(rp);sp.mergeOptions({position:{bottom:0,left:0},content:'<a href="http://maptalks.org" target="_blank">maptalks</a>',custom:!1}),zu.mergeOptions({attribution:!0}),zu.addOnLoadHook((function(){var e=this.options.attribution||this.options.attributionControl;e&&(this.attributionControl=new sp(e),this.addControl(this.attributionControl))}));var op=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.buildOn=function(e){var t=this._getCompass();return this._appendCustomClass(t),this._compass=t,this._registerDomEvents(),e.on("resize moving moveend zooming zoomend rotate rotateend dragrotating dragrotateend viewchange",this._rotateCompass,this),t},n.onAdd=function(){this._rotateCompass()},n._getCompass=function(){return pn("div","maptalks-compass")},n._registerDomEvents=function(){jn(this._compass,"click",this._resetView,this)},n._rotateCompass=function(){var e=this.getMap().getBearing().toFixed(1),t=parseFloat(e);t<=180&&(t*=-1),t!==this._bearing&&(this._bearing=t,Ln(this._compass,"transform: rotate("+this._bearing+"deg);"))},n.onRemove=function(){this.getMap().off("resize moving moveend zooming zoomend rotate rotateend dragrotating dragrotateend viewchange",this._rotateCompass,this),delete this._compass,delete this._bearing},n._resetView=function(){this.getMap().animateTo({bearing:0})},t}(rp);op.mergeOptions({position:{top:120,left:20}}),zu.mergeOptions({compassControl:!1}),zu.addOnLoadHook((function(){this.options.compassControl&&(this.compassControl=new op(this.options.compassControl),this.addControl(this.compassControl))}));var ap=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.buildOn=function(){var e=this.container=pn("div",this.options.containerClass),t=this.panel=pn("div","panel"),n=this.button=pn("button");return e.appendChild(n),e.appendChild(t),this._appendCustomClass(e),e},n.onAdd=function(){jn(this.button,"mouseover",this._show,this),jn(this.panel,"mouseleave",this._hide,this)},n.onRemove=function(){this.panel&&(Wn(this.button,"mouseover",this._show),Wn(this.panel,"mouseleave",this._hide),yn(this.panel),yn(this.button),delete this.panel,delete this.button,delete this.container)},n._show=function(){Dn(this.container,"shown")||(Fn(this.container,"shown"),this._createPanel())},n._hide=function(e){this.panel.contains(e.toElement||e.relatedTarget)||Hn(this.container,this.options.containerClass)},n._createPanel=function(){this.panel.innerHTML="";var e=pn("ul");this.panel.appendChild(e),this._renderLayers(this.getMap(),e)},n._renderLayers=function(e,t){var n=this,i=e.getBaseLayer(),s=e.getLayers(),o=s.length;if(i){var a=i.layers||[i],l=pn("li","group"),h=pn("ul"),c=pn("label");c.innerHTML=this.options.baseTitle,l.appendChild(c);for(var u=0,f=a.length;u<f;u++){this._isExcluded(a[u])&&(h.appendChild(this._renderLayer(a[u],!0)),l.appendChild(h),t.appendChild(l))}}if(o){var g=pn("li","group"),m=pn("ul"),A=pn("label"),w=pn("input");w.type="checkbox",w.checked=!0,A.innerHTML=this.options.overlayTitle,g.appendChild(w),g.appendChild(A);for(var T=function(e){var t=e.target.checked,n=e.target.parentNode;if(n){var i=n.getElementsByTagName("ul")[0];if(i){var s=function(e){var n=e._layer;n&&n[t?"show":"hide"]()},o=function(e){var n=e._layer,i=e.childNodes[0];i&&(i.checked=t),n&&n[t?"show":"hide"]()};s(n),i.childNodes.forEach((function(e){o(e);var t=e.getElementsByTagName("ul")[0];t&&(s(e),t.childNodes.forEach((function(e){o(e)})))}))}}},S=function(){var e=s[M];if(n._isExcluded(e)){if(e.getLayers){var t=pn("li","group"),i=pn("ul"),o=pn("label"),a=pn("input");o.innerHTML=e.getId(),a.type="checkbox",a.checked=e.isVisible(),a.onchange=T,t.appendChild(a),t.appendChild(o),t.appendChild(i),t._layer=e,m.appendChild(t),(e.getLayers()||[]).forEach((function(e){i.appendChild(n._renderLayer(e,!1,a.checked))}))}else m.appendChild(n._renderLayer(e));e&&!e.isVisible()&&(w.checked=!1)}},M=0;M<o;M++)S();g.appendChild(m),t.appendChild(g),w.onchange=T}},n._isExcluded=function(e){var t=e.getId(),n=this.options.excludeLayers;return!(n.length&&n.indexOf(t)>=0)},n._renderLayer=function(e,t,n=!0){var i=this,s=pn("li","layer"),o=pn("label"),a=pn("input"),l=this.getMap(),h=e.options.visible;e.options.visible=!0;var c=e.isVisible();e.options.visible=h,s.className="layer";var u=a;return t?(u.type="radio",u.name="base"):u.type="checkbox",u.checked=h&&c,n||(u.checked=!1),c||u.setAttribute("disabled","disabled"),u.onchange=function(t){if("radio"===t.target.type){var n=l.getBaseLayer(),s=n.layers;if(s)for(var o=0,a=s.length;o<a;o++){var h=s[o];h[h===e?"show":"hide"]()}else n.isVisible()||n.show();l._fireEvent("setbaselayer")}else e[t.target.checked?"show":"hide"]();i.fire("layerchange",{target:e})},s.appendChild(a),o.innerHTML=e.getId(),s.appendChild(o),s._layer=e,s},t}(rp);ap.mergeOptions({position:"top-right",baseTitle:"Base Layers",overlayTitle:"Layers",excludeLayers:[],containerClass:"maptalks-layer-switcher"}),zu.mergeOptions({layerSwitcherControl:!1}),zu.addOnLoadHook((function(){this.options.layerSwitcherControl&&(this.layerSwitcherControl=new ap(this.options.layerSwitcherControl),this.addControl(this.layerSwitcherControl))}));var lp=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.buildOn=function(){var e=this.options.size;this.options.maximize||(e=[0,0]);var t=pn("div");this._appendCustomClass(t);var n=this.mapContainer=pn("div");n.style.width=e[0]+"px",n.style.height=e[1]+"px",n.className=this.options.containerClass;var i=this.button=pn("div");return i.className=this.options.buttonClass,t.appendChild(n),t.appendChild(i),t},n.onAdd=function(){this.options.maximize&&this._createOverview(),this.getMap().on("resize moving zooming rotate dragrotating viewchange",this._update,this).on("setbaselayer",this._updateBaseLayer,this).on("spatialreferencechange",this._updateSpatialReference,this),jn(this.button,"click",this._onButtonClick,this),this._updateButtonText()},n.onRemove=function(){this.getMap().off("resize moving zooming rotate dragrotating viewchange",this._update,this).off("setbaselayer",this._updateBaseLayer,this).off("spatialreferencechange",this._updateSpatialReference,this),this._overview&&(this._overview.remove(),delete this._overview,delete this._perspective),Wn(this.button,"click",this._onButtonClick)},n.maxmize=function(){var e=this.options.size,t=this.mapContainer;return t.style.width=e[0]+"px",t.style.height=e[1]+"px",this._createOverview(),this},n.minimize=function(){this._overview&&this._overview.remove(),delete this._overview,delete this._perspective;var e=this.mapContainer;return e.style.width="0px",e.style.height="0px",this},n.getOverviewMap=function(){return this._overview},n._onButtonClick=function(){this._overview?this.minimize():this.maxmize(),this._updateButtonText()},n._updateButtonText=function(){this.button.innerHTML=this._overview?"-":"+"},n._createOverview=function(){var e=this.getMap(),t=this.mapContainer,n=e.config();l(n,{center:e.getCenter(),zoom:this._getOverviewZoom(),zoomAnimationDuration:150,pitch:0,bearing:0,scrollWheelZoom:!1,checkSize:!1,doubleClickZoom:!1,touchZoom:!1,control:!1,draggable:!1,maxExtent:null}),this._overview=new zu(t,n),this._updateBaseLayer(),this._perspective=new df(this._getPerspectiveCoords(),{draggable:!0,cursor:"move",symbol:this.options.symbol}).on("dragend",this._onDragEnd,this),new td("perspective_layer",this._perspective).addTo(this._overview),this.fire("load")},n._getOverviewZoom=function(){var e=this.getMap(),t=e.getZoom(),n=e.getMinZoom(),i=this.options.level;if(i>0){for(var s=i;s>0;s--)if(t-s>=n)return t-s}else for(var o=i;o<0;o++)if(t-o>=n)return t-o;return t},n._onDragEnd=function(){var e=this._perspective.getCenter();this._overview.setCenter(e),this.getMap().panTo(e)},n._getPerspectiveCoords=function(){var e=this.getMap(),t=e.getProjection();return e.getContainerExtent().toArray().map((function(n){if(t){var i=e._containerPointToPrj(n);return e._fixPrjOnWorldWide(i),t.unproject(i)}return e.containerPointToCoordinate(n)}))},n._update=function(){if(this._overview){En(this._overview.getContainer());var e=this._getPerspectiveCoords();this._perspective.setCoordinates(e),this._overview.setCenterAndZoom(this.getMap().getCenter(),this._getOverviewZoom())}},n._updateSpatialReference=function(){if(this._overview){var e=this.getMap();this._overview.setSpatialReference(e.options.spatialReference)}},n._updateBaseLayer=function(){if(this._overview){var e=this.getMap().getBaseLayer();if(e){var t=e.layers,n=0;if(t)for(var i=0,s=t.length;i<s;i++){if(t[i].isVisible()){n=i;break}}var o=e.toJSON(),a=null;t?(a=o.layers[n].options).visible=!0:a=o.options,this._overview.setMinZoom(a.minZoom||null).setMaxZoom(a.maxZoom||null),delete a.minZoom,delete a.maxZoom,delete o.options.canvas,o.options.visible=!0,o.options.renderer="canvas";var l=Lu.fromJSON(o);for(var h in e)m(e[h])&&e.hasOwnProperty(h)&&e[h]!==e.constructor.prototype[h]&&(l[h]=e[h]);this._overview.setBaseLayer(l)}else this._overview.setBaseLayer(null)}},t}(rp);lp.mergeOptions({level:4,position:{right:1,bottom:1},size:[300,200],maximize:!0,symbol:{lineWidth:3,lineColor:"#1bbc9b",polygonFill:"#1bbc9b",polygonOpacity:.4},containerClass:"maptalks-overview",buttonClass:"maptalks-overview-button"}),zu.mergeOptions({overviewControl:!1}),zu.addOnLoadHook((function(){this.options.overviewControl&&(this.overviewControl=new lp(this.options.overviewControl),this.addControl(this.overviewControl))}));var hp=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.buildOn=function(){var e,t=this;if(this.options.custom)g(this.options.content)?((e=pn("div")).innerHTML=this.options.content,this._appendCustomClass(e)):e=this.options.content;else{if(e=pn("div","maptalks-panel"),this._appendCustomClass(e),this.options.closeButton){var n=pn("a","maptalks-close");n.innerText="×",n.href="javascript:;",n.onclick=function(){e.style.display="none",t.fire("close")},e.appendChild(n)}var i=pn("div","maptalks-panel-content");g(this.options.content)?i.innerHTML=this.options.content:i.appendChild(this.options.content),e.appendChild(i)}return this.draggable=new ul(e,{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this.draggable.on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this),this.options.draggable&&this.draggable.enable(),e},n.update=function(){return this.draggable&&(this.draggable.disable(),delete this.draggable),rp.prototype.update.call(this)},n.setContent=function(e){var t=this.options.content;return this.options.content=e,this.fire("contentchange",{old:t,new:e}),this.isVisible()&&this.update(),this},n.getContent=function(){return this.options.content},n._cancelOn=function(e){var t=(e.srcElement||e.target).tagName.toLowerCase();return"button"===t||"input"===t||"select"===t||"option"===t||"textarea"===t},n._onDragStart=function(e){this._startPos=e.mousePos,this._startPosition=l({},this.getPosition()),this.fire("dragstart",e)},n._onDragging=function(e){var t=e.mousePos.sub(this._startPos),n=this._startPosition,i=this.getPosition();h(i.top)||(i.top=parseInt(n.top)+t.y),h(i.bottom)||(i.bottom=parseInt(n.bottom)-t.y),h(i.left)||(i.left=parseInt(n.left)+t.x),h(i.right)||(i.right=parseInt(n.right)-t.x),this.setPosition(i),this.fire("dragging",e)},n._onDragEnd=function(e){delete this._startPos,delete this._startPosition,this.fire("dragend",e)},n._getConnectPoints=function(){var e=this.getMap(),t=this.getContainerPoint(),n=this.getDOM(),i=parseInt(n.clientWidth+""),s=parseInt(n.clientHeight+"");return[e.containerPointToCoordinate(t.add(i/2,0)),e.containerPointToCoordinate(t.add(i,s/2)),e.containerPointToCoordinate(t.add(i/2,s)),e.containerPointToCoordinate(t.add(0,s/2))]},t}(rp);hp.mergeOptions({position:"top-right",draggable:!0,custom:!1,content:"",closeButton:!0});var cp=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.buildOn=function(){var e=this._getReset();return this._appendCustomClass(e),this._reset=e,this._registerDomEvents(),e},n.onAdd=function(){this._view=this.options.view?this.options.view:this.getMap().getView()},n.setView=function(e){this._view=e},n._getReset=function(){return pn("div","maptalks-reset")},n._registerDomEvents=function(){jn(this._reset,"click",this._resetView,this)},n.onRemove=function(){delete this._reset,delete this._view},n._resetView=function(){this.getMap().setView(this._view)},t}(rp);cp.mergeOptions({position:{top:156,left:20},view:null}),zu.mergeOptions({resetControl:!1}),zu.addOnLoadHook((function(){this.options.resetControl&&(this.resetControl=new cp(this.options.resetControl),this.addControl(this.resetControl))}));var up="zoomend moving moveend",fp=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.buildOn=function(e){return this._map=e,this._scaleContainer=pn("div",this.options.containerClass),this._addScales(),e.on(up,this._update,this),this._map.isLoaded()&&this._update(),this._appendCustomClass(this._scaleContainer),this._scaleContainer},n.onRemove=function(){this.getMap().off(up,this._update,this)},n._addScales=function(){var e="border: 2px solid #000000;border-top: none;line-height: 1.1;padding: 0px;color: #000000;font-size: 11px;text-align:center;white-space: nowrap;overflow: hidden;-moz-box-sizing: content-box;box-sizing: content-box;background: #fff; background: rgba(255, 255, 255, 0);";this.options.metric&&(this._mScale=mn("div",this.options.containerClass?null:e,this._scaleContainer)),this.options.imperial&&(this._iScale=mn("div",this.options.containerClass?null:e,this._scaleContainer))},n._update=function(){var e=this._map.pixelToDistance(this.options.maxWidth,0);this._updateScales(e)},n._updateScales=function(e){this.options.metric&&e&&this._updateMetric(e),this.options.imperial&&e&&this._updateImperial(e)},n._updateMetric=function(e){var t=this._getRoundNum(e);this._updateScale(this._mScale,t<1e3?t+" m":t/1e3+" km",t/e)},n._updateImperial=function(e){var t,n,i,s=3.2808399*e;s>5280?(n=this._getRoundNum(t=s/5280),this._updateScale(this._iScale,n+" mile",n/t)):(i=this._getRoundNum(s),this._updateScale(this._iScale,i+" feet",i/s))},n._updateScale=function(e,t,n){e.style.width=Math.round(this.options.maxWidth*n)+"px",e.innerHTML=t},n._getRoundNum=function(e){var t=Math.pow(10,(Math.floor(e)+"").length-1),n=e/t;return t*(n=n>=10?10:n>=5?5:n>=3?3:n>=2?2:1)},t}(rp);fp.mergeOptions({position:"bottom-left",maxWidth:100,metric:!0,imperial:!1,containerClass:null}),zu.mergeOptions({scaleControl:!1}),zu.addOnLoadHook((function(){this.options.scaleControl&&(this.scaleControl=new fp(this.options.scaleControl),this.addControl(this.scaleControl))}));var dp=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.buildOn=function(e){this._map=e;var t=pn("div"),n=pn("ul","maptalks-toolbar-hx");t.appendChild(n),Fn(t,this.options.vertical?"maptalks-toolbar-vertical":"maptalks-toolbar-horizonal");var i=this;function s(e,t,n,s){var o=i._getItems()[t];return function(i){return Cn(i),e({target:o,index:t,childIndex:n,dom:s})}}var o=this.options.items;if(Ye(o))for(var a=0,l=o.length;a<l;a++){var h=o[a],c=pn("li");if(28!==this.options.height&&(c.style.lineHeight=this.options.height+"px"),c.style.height=this.options.height+"px",c.style.cursor="pointer",zn(h.item)){c.style.textAlign="center";var u=Un("div",h.item);c.innerHTML='<div style="margin-top:'+(this.options.height-u.height)/2+'px;">'+h.item+"</div>"}else c.innerHTML=h.item;if(h.click&&jn(c,"click",s(h.click,a,null,c)),Ye(h.children)){var f=this._createDropMenu(a);c.appendChild(f),c._menu=f,jn(c,"mouseover",(function(){this._menu.style.display=""})),jn(c,"mouseout",(function(){this._menu.style.display="none"}))}n.appendChild(c)}return this._appendCustomClass(t),t},n._createDropMenu=function(e){var t=this;function n(e,n,i){var s=t._getItems()[n].children[i];return function(t){return Cn(t),e({target:s,index:n,childIndex:i})}}var i=pn("div","maptalks-dropMenu"),s=this._getItems(),o=s.length,a=pn("ul"),l=s[e].children;e===o-1&&l&&(i.style.cssText="right: 0px;",a.style.cssText="right: 0px;position: absolute;",this.options.reverseMenu&&(a.style.bottom="0")),i.appendChild(pn("em","maptalks-ico"));for(var h=0,c=0,u=l.length;c<u;c++){var f=Vt(l[c].item,"12px");f.width>h&&(h=f.width)}for(var g=0,m=l.length;g<m;g++){var A=l[g],w=pn("li");w.innerHTML='<a href="javascript:;">'+A.item+"</a>",w.style.cursor="pointer",w.style.width=h+24+"px",jn(w.childNodes[0],"click",n(A.click,e,g)),a.appendChild(w)}if(this.options.vertical){var T=h<95?95:h;this.options.reverseMenu?i.style.right=-(T+20+2)+"px":i.style.left=-(T+20+2)+"px"}else this.options.reverseMenu?i.style.bottom="28px":i.style.top="29px";return i.appendChild(a),i.style.display="none",i},n._getItems=function(){return this.options.items||[]},t}(rp);dp.mergeOptions({height:28,vertical:!1,position:"top-right",reverseMenu:!1,items:[]});var pp=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.buildOn=function(e){var t=this.options,n=pn("div","maptalks-zoom");if(this._appendCustomClass(n),t.zoomLevel){var i=pn("span","maptalks-zoom-zoomlevel"),s=pn("span","maptalks-zoom-zoomlevel-text");i.appendChild(s),n.appendChild(i),this._levelDOM=s}var o=pn("div","maptalks-zoom-slider"),a=pn("a","maptalks-zoom-zoomin");a.href="javascript:;",o.appendChild(a),this._zoomInButton=a;var l=pn("a","maptalks-zoom-zoomout");return l.href="javascript:;",o.appendChild(l),this._zoomOutButton=l,n.appendChild(o),e.on("_zoomend _zooming _zoomstart _spatialreferencechange",this._update,this),this._update(),this._registerDomEvents(),n},n.onRemove=function(){this.getMap().off("_zoomend _zooming _zoomstart _spatialreferencechange",this._update,this)},n._update=function(){this._updateText()},n._updateText=function(){if(this._levelDOM){var e=this.getMap().getZoom();u(e)||(e=Math.floor(10*e)/10),this._levelDOM.innerHTML=e+""}},n._registerDomEvents=function(){this._zoomInButton&&jn(this._zoomInButton,"click",this._onZoomInClick,this),this._zoomOutButton&&jn(this._zoomOutButton,"click",this._onZoomOutClick,this)},n._onZoomInClick=function(e){Mn(e),this.getMap().zoomIn()},n._onZoomOutClick=function(e){Mn(e),this.getMap().zoomOut()},t}(rp);pp.mergeOptions({position:"top-left",zoomLevel:!0,seamless:!1}),zu.mergeOptions({zoomControl:!1}),zu.addOnLoadHook((function(){this.options.zoomControl&&(this.zoomControl=new pp(this.options.zoomControl),this.addControl(this.zoomControl))}));var gp=Object.freeze({__proto__:null,Attribution:sp,Compass:op,Control:rp,LayerSwitcher:ap,Overview:lp,Panel:hp,Reset:cp,Scale:fp,Toolbar:dp,Zoom:pp}),mp=function(){function e(e,t,n,i){Array.isArray(e)?(this.scale={x:e[0],y:e[1]},this.origin={x:e[2],y:e[3]}):(this.scale={x:e,y:t},this.origin={x:n,y:i})}return e.getDefault=function(e){var t=e.code.toLowerCase();return"baidu"===t?"baidu":t==="EPSG:4326".toLowerCase()||t==="EPSG:4490".toLowerCase()?"tms-global-geodetic":"identity"===t?[1,-1,0,0]:"web-mercator"},e}(),Ap=6378137*Math.PI;l(mp,{"web-mercator":new mp([1,-1,-Ap,Ap]),"tms-global-mercator":new mp([1,1,-Ap,-Ap]),"tms-global-geodetic":new mp([1,1,-180,-90]),baidu:new mp([1,1,0,0])});for(var yp=function(){function e(e,t,n,i){this.map=e,this.tileSize=i,this.fullExtent=n,this.prepareTileInfo(t,n),this._xScale=n.right>=n.left?1:-1,this._yScale=n.top>=n.bottom?1:-1;var s=e.getGLRes();this._pointOrigin=e._prjToPointAtRes(new Re(this.tileSystem.origin),s),this._glRes=s}var t=e.prototype;return t.prepareTileInfo=function(e,t){if(g(e)?e=mp[e.toLowerCase()]:Array.isArray(e)&&(e=new mp(e)),!e)throw new Error("Invalid TileSystem");this.tileSystem=e,this.transformation=new kl([t.right>t.left?1:-1,t.top>t.bottom?-1:1,e.origin.x,e.origin.y])},t._getTileNum=function(e,t){var n=this.tileSystem,i=this.tileSize,s=Math.floor(1e-7*n.scale.x+e.x/(i.width*t)),o=Math.ceil(1e-7*n.scale.y+e.y/(i.height*t));return{x:n.scale.x*s,y:n.scale.y*o}},t.getTileIndex=function(e,t,n){var i=this.tileSystem,s=this.transformation.transform(e,1),o=this._getTileNum(s,t);return i.scale.x<0&&(o.x-=1),i.scale.y>0&&(o.y-=1),this.getNeighorTileIndex(o.x,o.y,0,0,t,n)},t.getNeighorTileIndex=function(e,t,n,i,s,o){var a=this.tileSystem,l=e+a.scale.x*n,h=t-a.scale.y*i,c=!1,u=l,f=h,g=this._getTileFullIndex(s);return o&&(!0!==o&&"x"!==o||(g.xmax===g.xmin?l=g.xmin:l<g.xmin?(l=g.xmax-(g.xmin-l)%(g.xmax-g.xmin))===g.xmax&&(l=g.xmin):l>=g.xmax&&(l=g.xmin+(l-g.xmin)%(g.xmax-g.xmin))),!0!==o&&"y"!==o||(g.ymax===g.ymin?h=g.ymin:h>=g.ymax?h=g.ymin+(h-g.ymin)%(g.ymax-g.ymin):h<g.ymin&&(h=g.ymax-(g.ymin-h)%(g.ymax-g.ymin))===g.ymax&&(h=g.ymin))),(l<g.xmin||l>g.xmax||h>g.ymax||h<g.ymin)&&(c=!0),{x:l,y:h,idx:u,idy:f,out:c}},t._getTileFullIndex=function(e){if(this._tileFullIndex||(this._tileFullIndex={}),this._tileFullIndex[e])return this._tileFullIndex[e];var t=this.fullExtent,n=this.transformation,i=this._getTileNum(n.transform(new fl(t.left,t.top),1),e),s=this._getTileNum(n.transform(new fl(t.right,t.bottom),1),e),o=this.tileSystem;return o.scale.x<0&&(i.x-=1,s.x-=1),o.scale.y>0&&(i.y-=1,s.y-=1),this._tileFullIndex[e]=new Ml(i,s,null),this._tileFullIndex[e]},t.getTilePrjNW=function(e,t,n,i){var s=this.tileSystem,o=this.tileSize,a=s.origin.y+this._yScale*s.scale.y*(t+(1===s.scale.y?1:0))*n*o.height,l=s.origin.x+this._xScale*s.scale.x*(e+(1===s.scale.x?0:1))*n*o.width;return i?(i.set(l,a),i):new fl(l,a)},t.getTilePointNW=function(e,t,n,i){var s=this._glRes/n,o=this.tileSystem,a=this.tileSize,l=this._pointOrigin.y*s+this._yScale*o.scale.y*(t+(1===o.scale.y?1:0))*a.height,h=this._pointOrigin.x*s+this._xScale*o.scale.x*(e+(1===o.scale.x?0:1))*a.width;return i?(i.set(h,l),i):new Re(h,l)},t.getTilePrjSE=function(e,t,n,i){var s=this.tileSystem,o=this.tileSize,a=s.origin.y+this._yScale*s.scale.y*(t+(1===s.scale.y?0:1))*n*o.height,l=s.origin.x+this._xScale*s.scale.x*(e+(1===s.scale.x?1:0))*n*o.width;return i?(i.set(l,a),i):new fl(l,a)},t.getTilePointSE=function(e,t,n,i){var s=this._glRes/n,o=this.tileSystem,a=this.tileSize,l=this._pointOrigin.y*s+this._yScale*o.scale.y*(t+(1===o.scale.y?0:1))*a.height,h=this._pointOrigin.x*s+this._xScale*o.scale.x*(e+(1===o.scale.x?1:0))*a.width;return i?(i.set(h,l),i):new Re(h,l)},t.getTilePrjExtent=function(e,t,n){var i=this.getTilePrjNW(e,t,n),s=this.getTilePrjSE(e,t,n);return new Ml(i,s)},e}(),_p=[],vp=0
/*!
  * Contains code from THREE.js
  * MIT License
  * https://github.com/mrdoob/three.js
  */;vp<6;vp++)_p[vp]=[];var xp=[];function bp(e,t,n){!function(e){var t=e,n=t[0],i=t[1],s=t[2],o=t[3],a=t[4],l=t[5],h=t[6],c=t[7],u=t[8],f=t[9],g=t[10],m=t[11],A=t[12],w=t[13],T=t[14],S=t[15];Tp(_p[0],o-n,c-a,m-u,S-A),Tp(_p[1],o+n,c+a,m+u,S+A),Tp(_p[2],o+i,c+l,m+f,S+w),Tp(_p[3],o-i,c-l,m-f,S-w),Tp(_p[4],o-s,c-h,m-g,S-T),Tp(_p[5],o+s,c+h,m+g,S+T)}(e);for(var i=0;i<6;i++){var s=_p[i];if(xp[0]=s[0]>0?t[1][0]:t[0][0],xp[1]=s[1]>0?t[1][1]:t[0][1],xp[2]=s[2]>0?t[1][2]:t[0][2],Sp(s,xp)<0)return!1}return!0}var wp=1/6;function Tp(e,t,n,i,s){return e[0]=t*wp,e[1]=n*wp,e[2]=i*wp,e[3]=s*wp,e}function Sp(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]}var Mp,Cp=new Re(0,0),Pp="undefined"!=typeof Set,Ip=function(){function e(){this._table=Pp?new Set:{}}var t=e.prototype;return t.add=function(e){Pp?this._table.add(e):this._table[e]=!0},t.has=function(e){return Pp?this._table.has(e):this._table[e]},t.reset=function(){Pp?this._table.clear():this._table={}},e}(),kp={urlTemplate:null,subdomains:null,errorUrl:null,repeatWorld:!0,background:!0,loadingLimitOnInteracting:3,loadingLimit:0,placeholder:!1,crossOrigin:null,tileSize:[256,256],offset:[0,0],tileSystem:null,fadeAnimation:!n,fadeDuration:1e3/60*10,debug:!1,spatialReference:null,maxCacheSize:256,renderer:ye.webgl?"gl":"canvas",clipByPitch:!0,maxAvailableZoom:null,cascadeTiles:!0,zoomOffset:0,pyramidMode:1,decodeImageInWorker:!1,tileLimitPerFrame:0,tileStackStartDepth:7,tileStackDepth:6,awareOfTerrain:!0,bufferPixel:.5,mipmapTexture:!0,depthMask:!0,currentTilesFirst:!0,forceRenderOnMoving:!0,tileErrorScale:1},Op=/\{ *([\w_]+) *\}/g,Ep=new Re(0,0),Rp=new Re(0,0),Lp=new Re(0,0),Dp=new Re(0,0),Fp=new Re(0,0),Hp=new Re(0,0),Np=[[0,0,0],[0,0,0]],Bp=[0,0,0],zp=[0,0,0],Gp=[0,0,0],Up=function(e){function t(t,n){return e.call(this,t,n)||this}Te(t,e),t.fromJSON=function(e){return e&&"TileLayer"===e.type?new t(e.id,e.options):null};var n=t.prototype;return n.forceReload=function(){return this.fire("forcereloadstart"),this.clear(),this._renderer&&this._renderer.setToRedraw(),this.fire("forcereloadend"),this},n.getTileSize=function(e){if(this._tileSize)return this._tileSize;var t=this.options.tileSize;return c(t)&&(t=[t,t]),this._tileSize=new Ot(t),this._tileSize},n.getTiles=function(e,t){var n,i=this;if(this._coordCache={},n=this._isPyramidMode()?this._getPyramidTiles(e,t):this._getCascadeTiles(e,t),!this._maskGeoJSON)return n;var s=0;return(n.tileGrids||[]).forEach((function(e){e.tiles=(e.tiles||[]).filter((function(e){return i._tileInMask(e)})),s+=e.tiles.length;var t=e.tiles.map((function(e){return e.parent}));e.parents=(e.parents||[]).filter((function(e){return t.indexOf(e.id)>-1}))})),n.count=s,n},n._isPyramidMode=function(){var e=this._spatialRef||this.getSpatialReference();return!this._disablePyramid&&!this._hasOwnSR&&this.options.pyramidMode&&e&&e.isPyramid()},n._getTileFullExtent=function(){if(this._tileFullExtent)return this._tileFullExtent;var e=this.getSpatialReference(),t=e.getFullExtent(),n=e.getResolution(0),i=this.getMap();return this._tileFullExtent=t.convertTo((function(e){return i._prjToPointAtRes(e,n,Cp)})),this._tileFullExtent},n._getRootNodes=function(e){var t=this.getMap();if(this._rootNodes){var{tiles:n,mapWidth:i,mapHeight:s}=this._rootNodes;if(t.width!==i||t.height!==s){for(var o=this._getRootError(),a=0;a<n.length;a++)n[a].error=o;this._rootNodes.mapWidth=t.width,this._rootNodes.mapHeight=t.height}for(var l=0;l<n.length;l++)n[l].offset[0]=e[0],n[l].offset[1]=e[1];return this._rootNodes}var h=this._spatialRef||this.getSpatialReference(),c=h.getResolution(0),u=this._getTileConfig(),f=h.getFullExtent(),{origin:g,scale:m}=u.tileSystem,A=u.getTilePrjExtent(0,0,c),w=A.getWidth(),T=A.getHeight(),S=1e-5,M=Math.abs((g.x-f.left)/w);M=Math.ceil(M-S);var C=Math.abs((f.right-g.x)/w);C=Math.ceil(C-S);var I=Math.ceil(Math.abs(f.top-g.y)/T);I=Math.ceil(I-S);var E=Math.ceil(Math.abs(f.bottom-g.y)/T);if((C+M)*((E=Math.ceil(E-S))+I)>32)return{status:0,error:"Too many root nodes"};for(var D=this._getRootError(),H=[],N=-M;N<C;N++)for(var B=-I;B<E;B++){var z=m.y<0?B:-(B+1);H.push(this.createTileNode(N,z,0,N,z,c,D))}return this._rootNodes={status:1,tiles:H,mapWidth:t.width,mapHeight:t.height},this._getRootNodes(e)},n.createTileNode=function(e,t,n,i,s,o,a,l,h,c){var u=this.map,f=this.options.zoomOffset;h||(h=this._getTileConfig().getTilePrjExtent(e,t,o).convertTo((function(e){return u._prjToPointAtRes(e,o,Cp)})));var g=this._getTileOffset(n),m=this.getTileUrl(e,t,n+f);return{parent:l,layer:this.getId(),x:e,y:t,z:n,idx:i,idy:s,res:o,extent2d:h,id:c||this._getTileId(e,t,n),url:or(m),offset:g,error:a,children:[]}},n._getRootError=function(){var e=this.getMap(),t=S(e.getFov()),n=e.width/e.height,i=e.cameraPosition[2],s=i*Math.tan(.5*t),o=s*n,a=Math.sqrt(i*i+s*s+o*o);return e._getFovZ(0)*(a/i)*(this._spatialRef||this.getSpatialReference()).getResolution(0)/e.getResolution(0)},n._getPyramidTiles=function(e,t){var n=this.map;isNaN(+e)&&(e=this._getTileZoom(n.getZoom()));var i,s=this._spatialRef||this.getSpatialReference(),o=Math.min(e,this.getMaxZoom(),this.getMaxAvailableZoom()||1/0),a=n.projViewMatrix,l=this._getTileFullExtent(),h=this._getTileOffset(0);if(this.options.repeatWorld){var c=n.getContainerExtent(),u=this._convertToExtent2d(c),f=s.getResolution(0)/n.getResolution();if(u.within(l.copy()._scale(f))){var g=this._getRootNodes(h);if(1!==g.status)return console.warn(g.error),this._disablePyramid=!0,this.getTiles(e,t);i=[...g.tiles]}else{var m=n.getPitch(),A=n.options.cascadePitches[1],w=Math.floor(n._getVisualHeight(A)),T=m<=A?c:new Pl(0,n.height-w,n.width,n.height);this._visitedTiles=new Ip;var S=this._getTiles(0-this.options.zoomOffset,T,2,t&&t.getRenderer(),!0),M=this._getRootError()*Math.pow(2,this.options.zoomOffset);S.tiles.forEach((function(e){e.error=M})),i=S.tiles}}else{var C=this._getRootNodes(h);if(1!==C.status)return console.warn(C.error),this._disablePyramid=!0,this.getTiles(e,t);i=[...C.tiles]}for(var I=n.getGLRes(),E={0:h},D=new Pl,H=[],N=[],B=t&&t.getRenderer();i.length>0;){var z=i.pop();z.z!==o?(E[z.z+1]||(E[z.z+1]=this._getTileOffset(z.z+1)),this._splitNode(z,a,i,H,N,e,D,o,E[z.z+1],B,I)):(D._combine(z.extent2d),H.push(z))}return N.sort(Vp),this._debugTile(H,"_getPyramidTiles"),{tileGrids:[{extent:D,count:H.length,tiles:H,parents:N,offset:[0,0],zoom:e}],count:H.length}},n.isParentTile=function(e,t,n){var i=Math.max(this.getMinZoom(),e-this.options.tileStackStartDepth);return n.z>=i&&n.z<i+this.options.tileStackDepth&&n.z<t},n._splitNode=function(e,t,n,i,s,o,a,l,h,c,u){var f=e.z+1,g=this._spatialRef||this.getSpatialReference(),{idx:m,idy:A}=e,w=c||this.getRenderer(),T=!1,S=[],M=g.getResolution(f)/u;this.tileInfoCache||(this.tileInfoCache=new Fo(4*this.options.maxCacheSize));for(var C=0;C<4;C++){var I=C%2,E=C>>1;e.children||(e.children=[]);var D=e.children[C];if(!D)D=this._getTileId((m<<1)+I,(A<<1)+E,f),e.children[C]=D;var H=w.isTileCachedOrLoading(D),N=H&&H.info;N||(N=this.tileInfoCache.get(D))||(N=this._createChildNode(e,I,E,h,D)),N.error=e.error/2,N.offset[0]=h[0],N.offset[1]=h[1];var B=this._isTileVisible(N,t,M,l,h);if(B===Mp.VISIBLE)T=!0;else{if(B===Mp.OUT_OF_FRUSTUM)continue;if(B===Mp.SCREEN_ERROR_TOO_SMALL&&f!==l)return i.push(e),void a._combine(e.extent2d)}S.push(N)}f===l?T?ze(n,S):(i.push(e),a._combine(e.extent2d)):ze(n,S),this.isParentTile(o,l,e)&&s.push(e)},n._createChildNode=function(e,t,n,i,s){var o,{x:a,y:l,idx:h,idy:c,extent2d:u}=e,f=e.z+1,g=(a<<1)+t,m=(l<<1)+n,A=(h<<1)+t,w=(c<<1)+n,T=u.getWidth()/2*2,S=u.getHeight()/2*2,M=2*u.xmin,C=2*u.ymax,I=2*u.ymin,E=this._getTileConfig().tileSystem.scale.y;if(s=s||this._getTileId(A,w,f),E<0){var D=M+t*T,H=C-n*S;o=new Pl(D,H-S,D+T,H)}else{var N=M+t*T,B=I+n*S;o=new Pl(N,B,N+T,B+S)}var z=this.createTileNode(g,m,f,A,w,e.res/2,e.error/2,e.id,o,s);return this.tileInfoCache.add(s,z),z},n._isTileVisible=function(e,t,n,i,s){if(0===e.z)return Mp.VISIBLE;if(!this._isTileInFrustum(e,t,n,s))return Mp.OUT_OF_FRUSTUM;var o=this.options.maxError;return h(o)&&(o=1),this._getScreenSpaceError(e,n,i,s)>=o?Mp.VISIBLE:Mp.SCREEN_ERROR_TOO_SMALL},n._isTileInFrustum=function(e,t,n,i){if(!this._zScale){var s=this.getMap(),o=s.getGLRes();this._zScale=s.altitudeToPoint(100,o)/100}var a=this.getRenderer(),{xmin:l,ymin:h,xmax:c,ymax:u}=e.extent2d;if(e.offset&&0!==e.offset[0]&&0!==e.offset[1]&&!m(this.options.offset)){var[f,g]=e.offset;l+=f,c+=f,h+=g,u+=g}return Np[0][0]=(l-i[0])*n,Np[0][1]=(h-i[1])*n,Np[0][2]=(e.minAltitude||a&&a.avgMinAltitude||0)*this._zScale,Np[1][0]=(c-i[0])*n,Np[1][1]=(u-i[1])*n,Np[1][2]=(e.maxAltitude||a&&a.avgMaxAltitude||0)*this._zScale,bp(t,Np)},n._getScreenSpaceError=function(e,t,n,i){var s=e.error,o=this.map,{xmin:a,ymin:l,xmax:h,ymax:c}=e.extent2d;Bp[0]=(a-i[0])*t,Bp[1]=(l-i[1])*t,zp[0]=(h-i[0])*t,zp[1]=(c-i[1])*t;var u=function(e,t,n){var i=Math.max(e[0]-n[0],0,n[0]-t[0]),s=Math.max(e[1]-n[1],0,n[1]-t[1]),o=Math.max(e[2]-n[2],0,n[2]-t[2]);return Math.sqrt(i*i+s*s+o*o)}(Bp,zp,o.cameraPosition),f=Math.max(Math.abs(u),1e-7),g=Math.abs(e.z-n),m=s*(o.height<1e3||g<=1?1:g<=2?.7:.605)/f*this.options.tileErrorScale;return o.getPitch()<=60?1.45*m:m},n._getCascadeTiles=function(e,t){var n=this.getMap(),i=n.getPitch(),s=t&&t.getRenderer(),o=n.getContainerExtent(),a=[],l=0,c=this.getMinZoom(),u=n.options.cascadePitches[0],f=n.options.cascadePitches[1],g=Math.floor(n._getVisualHeight(f)),m=h(e)?this._getTileZoom(n.getZoom()):e;if(this._visitedTiles=new Ip,!h(e)||!this.options.cascadeTiles||i<=u||!h(c)&&m<=c){var A=i<=f?o:new Pl(0,n.height-g,n.width,n.height),w=this._getTiles(m,A,2,s);return w&&(l+=w.tiles.length,a.push(w)),{tileGrids:a,count:l}}var T=Math.floor(n._getVisualHeight(u)),S=new Pl(0,n.height-T,n.width,n.height),M=this._getTiles(m,S,0,s);l+=M?M.tiles.length:0,a.push(M);var C,I,E=S.ymin,D=n.getSpatialReference().getZoomDirection(),H=D;if(i>f){m-H<=c&&(H=0);var N=new Pl(0,n.height-g,n.width,E);l+=(C=this._getTiles(m-H,N,1,s))?C.tiles.length:0,E=N.ymin,H+=4*D,a.push(C)}if(m-H>=c){var B=new Pl(0,o.ymin,n.width,E);l+=(I=this._getTiles(m-H,B,2,s))?I.tiles.length:0,a.push(I)}return C&&I&&(a[1]=I,a[2]=C),{tileGrids:a,count:l}},n.getTileUrl=function(e,t,n){var i=this.options.urlTemplate,s="",o=this.options.subdomains;if(o&&Ye(o)){var a=(e+t)%o.length;a<0&&(a=0),s=o[a]}if(m(i))return i(e,t,n,s);var h={x:e,y:t,z:n,s};return this.options.token&&(h.token=this.options.token),this.options.customTags&&l(h,this.options.customTags),i.replace(Op,(function(e,t){var n=h[t];if(void 0===n)throw new Error("No value provided for variable "+e);return"function"==typeof n&&(n=n(h)),n}))},n.clear=function(){return this._renderer&&this._renderer.clear(),this.tileInfoCache&&this.tileInfoCache.reset(),this.fire("clear"),this},n.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),options:this.config()}},n.getSpatialReference=function(){var e=this.getMap();if(e&&(!this.options.spatialReference||uu.equals(this.options.spatialReference,e.options.spatialReference)))return e.getSpatialReference();if(this._sr)return this._sr;var t=this.options.spatialReference;if(g(t)&&!(t=uu.getPreset(t)))throw new Error("Unsupported spatial reference: "+this.options.spatialReference+", possible values: "+uu.getAllPresets().join());return this._sr=new uu(t),this._srMinZoom=this._sr.getMinZoom(),this._srMaxZoom=this._sr.getMaxZoom(),this._hasOwnSR=this._sr.toJSON().projection!==e.getSpatialReference().toJSON().projection,this._sr},n.getMinZoom=function(){var e=this.options.minZoom||0;return(this._spatialRef||this.getSpatialReference())!==this.getMap().getSpatialReference()?Math.max(e,this._srMinZoom):e},n.getMaxZoom=function(){return(this._spatialRef||this.getSpatialReference())!==this.getMap().getSpatialReference()?Math.min(e.prototype.getMaxZoom.call(this),this._srMaxZoom):e.prototype.getMaxZoom.call(this)},n._getTileZoom=function(e){if(!this._hasOwnSR){var t=this.getMap().getResolution(e),n=this.getSpatialReference().getResolution(e);e+=Math.log(n/t)*Math.LOG2E}var i=this.getMaxAvailableZoom();return!h(i)&&e>i&&(e=i),u(e)||(e=Math.round(e)),e=Math.max(0,e)},n.getMaxAvailableZoom=function(){var e=this._spatialRef||this.getSpatialReference();return this.options.maxAvailableZoom||e&&e.getMaxZoom()},n._getTiles=function(e,t,n,i,s){var o=this.getMap(),a=e,l=o.projViewMatrix,c=o.getResolution(e)/o.getResolution(e-1)==.5;n<2&&(0===n&&c&&(a-=1),l=0===n?o.cascadeFrustumMatrix0:1===n?o.cascadeFrustumMatrix1:o.projViewMatrix);var u=a+this.options.zoomOffset,f=this._getTileOffset(a),g=f[0]||f[1],m={zoom:a,extent:null,offset:f,tiles:[]};if(u<0)return m;if(!(o&&this.isVisible()&&o.width&&o.height))return m;if(!s){var A=this.getMinZoom(),w=this.getMaxZoom();if(!h(A)&&a<A||!h(w)&&a>w)return m}var T=this._getTileConfig();if(!T)return m;var S,M={zoom:f},C=(this._spatialRef||this.getSpatialReference()).getResolution(a);S=this._hasOwnSR?o.getGLScale(a):C/o.getGLRes();var I=!this._hasOwnSR&&this.options.repeatWorld,E=this._convertToExtent2d(t),D=this._getMask2DExtent();if(D){var H=D.intersection(E);if(!H)return m;t=H.convertTo((function(e){return o._pointToContainerPoint(e,void 0,0,Cp)}))}var N,B=o._containerPointToPrj(t.getCenter(),Ep),z=o._prjToPoint(B,a,Rp);N=this._project(g?o._pointToPrj(z._add(f),a,Rp):B,Rp);var U=o.getGLScale()/o.getGLScale(a);Lp.x=E.xmin*U,Lp.y=E.ymax*U,Dp.x=E.xmax*U,Dp.y=E.ymin*U;for(var j=this._project(o._pointToPrj(Lp._add(f),a,Lp),Lp),W=this._project(o._pointToPrj(Dp._add(f),a,Dp),Dp),q=T.getTileIndex(N,C,I),Z=T.getTileIndex(j,C,I),X=T.getTileIndex(W,C,I),Y=Math.ceil(Math.abs(q.idy-Z.idy)),J=Math.ceil(Math.abs(q.idx-Z.idx)),Q=Math.ceil(Math.abs(q.idy-X.idy)),$=Math.ceil(Math.abs(q.idx-X.idx)),K=(Y+Q+1)*(J+$+1),ee=this.getTileSize(),te=this.getRenderer()||i,re=this._getTileConfig().tileSystem.scale,se=[],oe=new Pl,le=new Re(0,0),he=-Y;he<=Q;he++)for(var ue=-J,fe=-1/0,de=!1;ue>=fe&&ue<=$;){var pe=T.getNeighorTileIndex(q.idx,q.idy,ue,he,C,I);fe===-1/0?ue++:ue--;var me=this._getTileId(pe.idx,pe.idy,a);if(!(pe.out||this._visitedTiles&&this._visitedTiles.has(me))){var Ae=te&&te.isTileCachedOrLoading(me);Ae&&(Ae=Ae.info);var ye=void 0;if(Ae){var{extent2d:_e}=Ae;le.set(_e.xmin,_e.ymax),ye=le}else if(this._hasOwnSR){var ve=T.getTilePrjNW(pe.x,pe.y,C);ye=o._prjToPoint(this._unproject(ve,Dp),a)}else ye=T.getTilePointNW(pe.x,pe.y,C);var xe=void 0,be=void 0;if(this._hasOwnSR){var we=void 0;if(this._hasOwnSR){var Te=T.getTilePrjSE(pe.x,pe.y,C);we=o._prjToPoint(this._unproject(Te,Dp),a,Dp)}else we=T.getTilePointSE(pe.x,pe.y,C);xe=Math.ceil(Math.abs(we.x-ye.x)),be=Math.ceil(Math.abs(we.y-ye.y))}else xe=ee.width,be=ee.height;var Se=re.x*(pe.idx-pe.x)*xe,Me=re.y*(pe.idy-pe.y)*be;Ae||!Se&&!Me||ye._add(Se,Me);var Ce=Ae&&Ae.extent2d||new Pl(ye.x,ye.y-be,ye.x+xe,ye.y);if(K<=4||de||this._isTileInExtent(l,Ce,f,S)){var Pe=this._hasOwnSR?o._getResolution(a):C;this._visitedTiles&&0===n&&this._visitedTiles.add(me),c&&0===n?(this._splitTiles(l,se,te,pe,a+1,Pe,Ce,Se,Me,M),oe._combine(Ce)):(Ae?(Ae.offset[0]=f[0],Ae.offset[1]=f[1]):Ae=this.createTileNode(pe.x,pe.y,a,pe.idx,pe.idy,Pe,0,null,Ce,me),se.push(Ae),oe._combine(Ce)),fe===-1/0?(fe=ue,ue=$):de||(de=!0)}}}if(se.length){var Ie=o._containerPointToPoint(t.getCenter(),a,Cp)._add(f),ke=new Re(0,0),Oe=new Re(0,0);se.sort((function(e,t){return ke.set((e.extent2d.xmin+e.extent2d.xmax)/2,(e.extent2d.ymin+e.extent2d.ymax)/2),Oe.set((t.extent2d.xmin+t.extent2d.xmax)/2,(t.extent2d.ymin+t.extent2d.ymax)/2),ke.distanceTo(Ie)-Oe.distanceTo(Ie)}))}return{offset:f,zoom:e,extent:oe,tiles:se}},n._convertToExtent2d=function(e){var t=this,n=this.getMap();return e.convertTo((function(e){if(e.y>0&&e.y<n.height){var i=(0===e.x?0:1)+e.y;t._coordCache[i]||(t._coordCache[i]=n._containerPointToPoint(e)),t._coordCache[i]}return n._containerPointToPoint(e,void 0,Cp)}))},n._splitTiles=function(e,t,n,i,s,o,a,l,h,c){var u=this._getTileConfig().tileSystem.scale.y,f=this.getMap().getGLScale(s),g=Fp.set(2*a.xmin,u<0?2*a.ymax:2*a.ymin),m=a.getWidth(),A=a.getHeight(),w=2*i.idx,T=2*i.idy,S=2*i.x,M=2*i.y,C=this._checkAndAddTile(e,n,w,T,S,M,s,o,0,0,m,A,g,f,c);C&&t.push(C),(C=this._checkAndAddTile(e,n,w,T,S,M,s,o,0,1,m,A,g,f,c))&&t.push(C),(C=this._checkAndAddTile(e,n,w,T,S,M,s,o,1,0,m,A,g,f,c))&&t.push(C),(C=this._checkAndAddTile(e,n,w,T,S,M,s,o,1,1,m,A,g,f,c))&&t.push(C)},n._checkAndAddTile=function(e,t,n,i,s,o,a,l,h,c,u,f,g,m,A){var w=this._getTileId(n+h,i+c,a);if(this._visitedTiles&&this._visitedTiles.has(w))return null;var T=A[a];T||(T=A[a]=this._getTileOffset(a));var S=this._getTileConfig().tileSystem.scale.y,M=new Pl(g.x+h*u,g.y+S*c*f,g.x+(h+1)*u,g.y+S*(c+1)*f);if(!this._isSplittedTileInExtent(e,M,T,m))return null;var C=l/2,I=t&&t.isTileCachedOrLoading(w);return I?I.info:this.createTileNode(s+h,o+c,a,n+h,n+o,C,0,null,M,w)},n._getTileOffset=function(...e){var t=this.options.offset;return t?(m(t)&&(t=t.call(this,...e)),c(t)&&(t=[t,t]),t||[0,0]):[0,0]},n.getTileId=function(e,t,n,i){return this._getTileId(e,t,n,i)},n._getTileId=function(e,t,n,i){return(i||this.getId())+"_"+e+"_"+t+"_"+n},n._project=function(e,t){if(this._hasOwnSR){var n=this.getMap().getProjection();return(this._spatialRef||this.getSpatialReference()).getProjection().project(n.unproject(e,t),t)}return e},n._unproject=function(e,t){if(this._hasOwnSR){var n=this.getMap(),i=this._spatialRef||this.getSpatialReference(),s=n.getProjection(),o=i.getProjection();return s.project(o.unproject(e,t),t)}return e},n._initTileConfig=function(){var e=this.getMap(),t=this.getTileSize(),n=this.getSpatialReference(),i=n.getProjection(),s=n.getFullExtent();this._defaultTileConfig=new yp(e,mp.getDefault(i),s,t),this.options.hasOwnProperty("tileSystem")&&(this._tileConfig=new yp(e,this.options.tileSystem,s,t)),delete this._rootNodes,delete this._tileFullExtent,delete this._disablePyramid},n._getTileConfig=function(){return this._defaultTileConfig||this._initTileConfig(),this._tileConfig||this._defaultTileConfig},n._bindMap=function(t){return this._onSpatialReferenceChange(),e.prototype._bindMap.apply(this,arguments)},n._isTileInExtent=function(e,t,n,i){var s,o=this.getMap();if(e!==o.projViewMatrix){var a=t.getCenter(Hp)._sub(n[0],n[1])._multi(i);Is(Gp,a.x,a.y,0);var l=function(e,t,n){var i=t[0],s=t[1],o=t[2],a=n[3]*i+n[7]*s+n[11]*o+n[15];return e[0]=(n[0]*i+n[4]*s+n[8]*o+n[12])/(a=a||1),e[1]=(n[1]*i+n[5]*s+n[9]*o+n[13])/a,e[2]=(n[2]*i+n[6]*s+n[10]*o+n[14])/a,e}(Gp,Gp,o.projViewMatrix);s=l[1]<0?o.projViewMatrix:e}else s=o.projViewMatrix;return Np[0][0]=(t.xmin-n[0])*i,Np[0][1]=(t.ymin-n[1])*i,Np[1][0]=(t.xmax-n[0])*i,Np[1][1]=(t.ymax-n[1])*i,bp(s,Np)},n._isSplittedTileInExtent=function(e,t,n,i){var s=this.getMap();return Np[0][0]=(t.xmin-n[0])*i,Np[0][1]=(t.ymin-n[1])*i,Np[1][0]=(t.xmax-n[0])*i,Np[1][1]=(t.ymax-n[1])*i,bp(s.projViewMatrix,Np)},n.getEvents=function(){return{spatialreferencechange:this._onSpatialReferenceChange}},n._onSpatialReferenceChange=function(){delete this._tileConfig,delete this._defaultTileConfig,delete this._sr,delete this._srMinZoom,delete this._hasOwnSR,delete this._rootNodes,this.tileInfoCache&&this.tileInfoCache.reset();var e=this.getRenderer();e&&e.clear()},n.getPolygonOffsetCount=function(){return 2},n.getPolygonOffset=function(){return this._polygonOffset||0},n.setPolygonOffset=function(e){return this._polygonOffset=e,this},n.getRenderer=function(){return e.prototype.getRenderer.call(this)},n._getTileBBox=function(e){var t=this.getMap();if(t){var n=e.extent2d,i=e.offset||[0,0];if(n){var s=e.res,[o,a]=i,{xmin:l,ymin:h,xmax:c,ymax:u}=n;c-=o,u-=a;var f=new Re(l-=o,h-=a),g=new Re(c,u),m=t.pointAtResToCoordinate(f,s,Ep),A=t.pointAtResToCoordinate(g,s,Rp);return[m.x,m.y,A.x,A.y]}}},n._tileInMask=function(e){var t=this.getMask();if(!t)return!0;var n=t.type;if(!n||-1===n.indexOf("Polygon"))return!0;var i=this._maskGeoJSON;if(!i||!i.geometry)return!0;var{coordinates:s,type:o}=i.geometry;if(!s||!o)return!0;if(-1===o.indexOf("Polygon"))return!0;if(!i.bbox){var a=t.getExtent();if(!a)return!0;i.bbox=[a.xmin,a.ymin,a.xmax,a.ymax]}var l=this._getTileBBox(e);return!l||ws(l,this._maskGeoJSON)},n._debugTile=function(e,t,n){if(this.options.debugTile){if(Array.isArray(e)){for(var i=0;i<e.length;i++)e[i]&&this._debugTile(e[i],t+" at "+i,n);return}if(!e)return;var{x:s,y:o,z:a}=this.options.debugTile;e.x===s&&e.y===o&&e.z===a&&console.log("Debug Tile Found in TileLayer."+t+":",e)}},t}(Lu);function Vp(e,t){return e.z-t.z}Up.registerJSONType("TileLayer"),Up.mergeOptions(kp),function(e){e[e.OUT_OF_FRUSTUM=0]="OUT_OF_FRUSTUM",e[e.SCREEN_ERROR_TOO_SMALL=1]="SCREEN_ERROR_TOO_SMALL",e[e.VISIBLE=2]="VISIBLE"}(Mp||(Mp={}));var jp=new Ot(256,256),Wp="show hide remove setzindex forcereloadstart";function qp(e){return Array.isArray(e)||(e=[e]),e}var Zp=function(e){function t(t,n,i){var s;return(s=e.call(this,t,i)||this).layers=n||[],s._checkChildren(),s.layerMap={},s._groupChildren=[],s}Te(t,e),t.fromJSON=function(e){if(!e||"GroupTileLayer"!==e.type)return null;var n=e.layers.map((function(e){return Lu.fromJSON(e)}));return new t(e.id,n,e.options)};var n=t.prototype;return n.getLayers=function(){return this.layers},n.addLayer=function(e=[]){var t=this;e=qp(e);var n=this.layers.length;return e.forEach((function(e){e instanceof Up&&(-1!==t.layers.indexOf(e)||t.layerMap[e.getId()]||t.layers.push(e))})),n!==this.layers.length&&(this._sortLayers(),this._refresh(),this._renderLayers()),this},n.removeLayer=function(e=[]){var t=this;e=qp(e);var n=this.layers.length;return e.forEach((function(e){if(e instanceof Up||(e=t.layerMap[e]),e instanceof Up){var n=t.layers.indexOf(e);n>=0&&(t.layers.splice(n,1),e._doRemove(),e.off(Wp,t._onLayerShowHide,t))}})),n!==this.layers.length&&(this._refresh(),this._renderLayers()),this},n.clearLayers=function(){var e=this;return this.layers.forEach((function(t){t._doRemove(),t.off(Wp,e._onLayerShowHide,e)})),this.layers=[],this._refresh(),this._renderLayers(),this},n.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),layers:this.layers.map((function(e){return e.toJSON()})),options:this.config()}},n.getTileSize=function(e){var t=this.getLayer(e);return t?t.getTileSize():jp},n.getTiles=function(e,t){for(var n=this.layers,i=[],s=0,o=0,a=n.length;o<a;o++){var l=n[o];if(l&&l.options.visible&&l.isVisible()&&l.getMap()){var h=l.getTiles(e,t||this);h&&0!==h.count&&(s+=h.count,ze(i,h.tileGrids))}}return{count:s,tileGrids:i}},n.onAdd=function(){this._sortLayers(),this._refresh(),e.prototype.onAdd.call(this)},n.onRemove=function(){var t=this;this.layers.forEach((function(e){e._doRemove(),e.off(Wp,t._onLayerShowHide,t)})),this.layerMap={},this._groupChildren=[],e.prototype.onRemove.call(this)},n.getLayer=function(e){return this.getChildLayer(e)},n.getChildLayer=function(e){var t=this.layerMap[e];if(t)return t;for(var n=0;n<this._groupChildren.length;n++){var i=this._groupChildren[n].getChildLayer(e);if(i)return i}return null},n._removeChildTileCache=function(e){if(!e)return this;var t,n=this.getRenderer();if(!n)return this;var i=e.getId(),s=function(){return t&&t.info&&t.info.layer===i};n.tileCache&&n.tileCache.keys().forEach((function(e){t=n.tileCache.get(e),s()&&n.tileCache.remove(e)}));var o=n.tilesInView||{};for(var a in o)t=o[a],s()&&delete o[a];var l=n.tilesLoading||{};for(var h in l)t=l[h],s()&&n.abortTileLoading(t.image,t.info);return this},n._onLayerShowHide=function(e){var{type:t,target:n}=e||{};"remove"===t&&n?(this.layers.splice(this.layers.indexOf(n),1),n._doRemove(),n.off(Wp,this._onLayerShowHide,this),this._refresh()):"setzindex"===t?this._sortLayers():"forcereloadstart"===t&&this._removeChildTileCache(n),this._renderLayers()},n._renderLayers=function(){var e=this.getRenderer();return e&&e.setToRedraw(),this},n._refresh=function(){var e=this,t=this.getMap();return this._groupChildren=[],this.layerMap={},this.layers.forEach((function(n){e.layerMap[n.getId()]=n,n.getChildLayer&&e._groupChildren.push(n),n.getMap()||n._bindMap(t),n.off(Wp,e._onLayerShowHide,e),n.on(Wp,e._onLayerShowHide,e)})),this},n.isVisible=function(){if(!e.prototype.isVisible.call(this))return!1;for(var t=this.layers,n=0,i=t.length;n<i;n++)if(t[n].isVisible())return!0;return!1},n._checkChildren=function(){var e=this,t={};this.layers.forEach((function(n){var i=n.getId();if(t[i])throw new Error("Duplicate child layer id ("+i+") in the GroupTileLayer ("+e.getId()+")");t[i]=1}))},n._sortLayers=function(){this.layers.sort((function(e,t){return e.options.zIndex-t.options.zIndex}))},t}(Up);Zp.registerJSONType("GroupTileLayer"),Zp.mergeOptions({urlTemplate:"",maxCacheSize:1024});var Xp,Yp={urlTemplate:"",crs:null,uppercase:!1,detectRetina:!1},Jp={service:"WMS",request:"GetMap",layers:"",styles:"",format:"image/jpeg",transparent:!1,version:"1.1.1"},Qp=function(e){function t(t,n){var i;return i=e.call(this,t)||this,Xp||(Xp=l({},i.options)),i.wmsParams=l({},Jp),i._setOptions(n),i.setZIndex(n.zIndex),ye.proxy||i._optionsHook(n),i}Te(t,e);var n=t.prototype;return n._optionsHook=function(e={}){for(var t in e)"tileSize"===t&&(this._tileSize=null),t in Xp||(this.wmsParams[t]=e[t]);var n=this.getTileSize();return this.wmsParams.width=n.width,this.wmsParams.height=n.height,this._wmsVersion=parseFloat(this.wmsParams.version),this},n.onAdd=function(){var t=this.getMap().getDevicePixelRatio(),n=Yp.detectRetina?t:1;this.wmsParams.width*=n,this.wmsParams.height*=n;var i=this.options.crs||this.getMap().getProjection().code;this.wmsParams[this._wmsVersion>=1.3?"crs":"srs"]=i,e.prototype.onAdd.call(this)},n.getTileUrl=function(t,n,i){var s=this.getSpatialReference().getResolution(i),o=this._getTileConfig().getTilePrjExtent(t,n,s),a=o.getMax(),l=o.getMin(),h=(this._wmsVersion>=1.3&&("EPSG:4326"===this.wmsParams.crs||"EPSG:4490"===this.wmsParams.crs)?[l.y,l.x,a.y,a.x]:[l.x,l.y,a.x,a.y]).join(","),c=e.prototype.getTileUrl.call(this,t,n,i);return c+function(e,t,n){var i=[];for(var s in e)i.push(encodeURIComponent(n?s.toUpperCase():s)+"="+encodeURIComponent(e[s]));return(t&&-1!==t.indexOf("?")?"&":"?")+i.join("&")}(this.wmsParams,c,this.options.uppercase)+(this.options.uppercase?"&BBOX=":"&bbox=")+h},n.toJSON=function(){return{type:"WMSTileLayer",id:this.getId(),options:this.config()}},t.fromJSON=function(e){return e&&"WMSTileLayer"===e.type?new t(e.id,e.options):null},t}(Up);Qp.registerJSONType("WMSTileLayer"),Qp.mergeOptions(Yp);var $p=function(e){function t(t,n){var i;return(i=e.call(this,t,n)||this).options.hasOwnProperty("forceRenderOnMoving")||(i.options.forceRenderOnMoving=!1),i}Te(t,e);var n=t.prototype;return n.drawTile=function(){},n.toJSON=function(){return{type:"CanvasTileLayer",id:this.getId(),options:this.config()}},t.fromJSON=function(e){return e&&"CanvasTileLayer"===e.type?new t(e.id,e.options):null},t}(Up);function Kp(e,t,n){var i=e.createShader(t);if(e.shaderSource(i,n),e.compileShader(i),!e.getShaderParameter(i,e.COMPILE_STATUS)){var s=e.getShaderInfoLog(i);throw e.deleteShader(i),new Error("Failed to compile shader: "+s)}return i}function eg(e,t,n){var i=Kp(e,e.VERTEX_SHADER,t),s=Kp(e,e.FRAGMENT_SHADER,n);if(!i||!s)return null;var o=e.createProgram();return o?(e.attachShader(o,i),e.attachShader(o,s),e.linkProgram(o),{program:o,vertexShader:i,fragmentShader:s}):null}function tg(e,t,n){if(Array.isArray(n[0])){for(var i=Float32Array.BYTES_PER_ELEMENT,s=0,o=0;o<n.length;o++)s+=n[o][1]||0;for(var a=0,l=0;l<n.length;l++){var h=e.getAttribLocation(t,n[l][0]);if(h<0)throw new Error("Failed to get the storage location of "+n[l][0]);e.vertexAttribPointer(h,n[l][1],e[n[l][2]||"FLOAT"],!1,i*s,i*a),a+=n[l][1]||0,e.enableVertexAttribArray(h)}}else{var c=e.getAttribLocation(t,n[0]);e.vertexAttribPointer(c,n[1],e[n[2]||"FLOAT"],!1,0,0),e.enableVertexAttribArray(c)}}$p.registerJSONType("CanvasTileLayer");var ng={never:512,"<":513,"=":514,"<=":515,">":516,"!=":517,">=":518,always:519};var rg=[1,1,1,1],ig=new Float32Array(8),sg=new Int16Array(8),og="\n        attribute vec2 a_position;\n\n        attribute vec2 a_texCoord;\n\n        uniform mat4 u_matrix;\n\n        varying vec2 v_texCoord;\n\n        void main() {\n            gl_Position = u_matrix * vec4(a_position, 0., 1.);\n\n            v_texCoord = a_texCoord;\n        }\n    ",ag="\n        precision mediump float;\n\n        uniform sampler2D u_image;\n\n        uniform float u_opacity;\n        uniform float u_debug_line;\n        uniform vec4 u_base_color;\n        uniform float u_alpha_test;\n        varying vec2 v_texCoord;\n\n        void main() {\n            if (u_debug_line == 1.) {\n                gl_FragColor = vec4(0., 1., 0., 1.);\n            } else {\n                gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;\n            }\n            gl_FragColor *= u_base_color;\n            if (gl_FragColor.a < u_alpha_test) {\n                discard;\n            }\n        }\n    ",lg=["",0],hg=[0,0,0],cg=new Array(16),ug=new Re(20,20),fg=function(e){var t=function(e){function t(){var t;return(t=e.apply(this,arguments)||this)._layerAlt=0,t._layerAltitude=0,t}Te(t,e);var i=t.prototype;return i.drawGLImage=function(e,t,n,i,s,o,a,l,u,f){this.gl.program!==this.program&&this.useProgram(this.program);var g=this.gl;if(this.loadTexture(e,l),this.canvas.gl&&this.canvas.gl.wrap){var m=this.layer&&this.layer.options.opacity;h(m)&&(m=1),a*=m}hg[0]=t||0,hg[1]=n||0,hg[2]=0;var A=this.layer,w=this.getMap();if(A){var{altitude:T}=A.options,S=c(T);if(S||(this._layerAlt=0),this._layerAltitude!==T&&S){var M=w.altitudeToPoint(T,w.getGLRes());this._layerAltitude=T,this._layerAlt=M}}hg[2]=this._layerAlt||0;var C=ji(cg);Li(C,C,hg),Di(C,C,[o,o,1]),zi(C,w.projViewMatrix,C),g.uniformMatrix4fv(this.program.u_matrix,!1,C),g.uniform1f(this.program.u_opacity,a),g.uniform1f(this.program.u_debug_line,0),g.uniform4fv(this.program.u_base_color,f||rg),g.uniform1f(this.program.u_alpha_test,this.layer.options.alphaTest||0);var{glBuffer:I}=e;!I||I.width===i&&I.height===s||(this.saveImageBuffer(I),delete e.glBuffer),e.glBuffer?g.bindBuffer(g.ARRAY_BUFFER,I):e.glBuffer=this.bufferTileData(0,0,i,s),lg[0]="a_position",lg[1]=2,lg[2]=e.glBuffer.type,this.enableVertexAttrib(lg),g.bindBuffer(g.ARRAY_BUFFER,this.texBuffer),lg[0]="a_texCoord",lg[1]=2,lg[2]="UNSIGNED_BYTE",this.enableVertexAttrib(lg),g.drawArrays(g.TRIANGLE_STRIP,0,4),u&&this.drawDebug(C,0,0,i,s,u)},i.drawDebug=function(e,t,n,i,s,o){var a=this.gl;a.disable(a.DEPTH_TEST),a.bindBuffer(a.ARRAY_BUFFER,this._debugBuffer),this.enableVertexAttrib(["a_position",2,"FLOAT"]),a.bufferData(a.ARRAY_BUFFER,new Float32Array([t,n,t+i,n,t+i,n-s,t,n-s,t,n]),a.DYNAMIC_DRAW),a.uniformMatrix4fv(this.program.u_matrix,!1,e),a.uniform1f(this.program.u_opacity,1),a.uniform1f(this.program.u_debug_line,1),a.uniform4fv(this.program.u_base_color,rg),a.uniform1f(this.program.u_alpha_test,this.layer.options.alphaTest||0),a.drawArrays(a.LINE_STRIP,0,5);var l=this._debugInfoCanvas;if(!l){var h=this.mapDPR||this.getMap().getDevicePixelRatio()>1?2:1;(l=this._debugInfoCanvas=document.createElement("canvas")).width=256*h,l.height=32*h;var c=l.getContext("2d");c.font="20px monospace",c.scale(h,h)}var u=l.getContext("2d");u.clearRect(0,0,l.width,l.height),Ea.fillText(u,o,ug,this.layer.options.debugOutline),this.loadTexture(l),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,l);var f=t+(i=256),g=n-s+32,m=n-s;a.bufferData(a.ARRAY_BUFFER,this.set8(t,g,t,m,f,g,f,m),a.DYNAMIC_DRAW),a.uniform1f(this.program.u_debug_line,0),a.bindBuffer(a.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2,"UNSIGNED_BYTE"]),a.drawArrays(a.TRIANGLE_STRIP,0,4),a.enable(a.DEPTH_TEST)},i.bufferTileData=function(e,t,n,i,s){var o,a=e,l=e+n,h=t,c=t-i;o=u(a)&&u(l)&&u(h)&&u(c)?this.set8Int(a,h,a,c,l,h,l,c):this.set8(a,h,a,c,l,h,l,c);var f=this.loadImageBuffer(o,s);return f.width=n,f.height=i,f.type=o instanceof Int16Array?"SHORT":"FLOAT",f},i.createCanvas2=function(){this.canvas2=Ea.createCanvas(this.canvas.width,this.canvas.height)},i.createGLContext=function(){this.gl=this.canvas.gl&&this.canvas.gl.wrap?this.canvas.gl.wrap():function(e,t){for(var n={alpha:!0,stencil:!0,preserveDrawingBuffer:!0,antialias:!1},i=["webgl","experimental-webgl"],s=null,o=0;o<i.length;++o){try{s=e.getContext(i[o],t||n)}catch(e){}if(s)break}return s}(this.canvas2||this.canvas,this.layer.options.glOptions);var e=this.gl;e.clearColor(0,0,0,0),e.enable(e.DEPTH_TEST),e.enable(e.STENCIL_TEST),e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),this.program=this.createProgram(og,this.layer.options.fragmentShader||ag),this._debugBuffer=this.createBuffer(),this.useProgram(this.program),this.texBuffer=this.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2,"UNSIGNED_BYTE"]),e.bufferData(e.ARRAY_BUFFER,new Uint8Array([0,0,0,1,1,0,1,1]),e.STATIC_DRAW),this.enableSampler("u_image"),e.activeTexture(e.TEXTURE0),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0)},i.resizeGLCanvas=function(){this.gl&&this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.canvas2&&(this.canvas2.width===this.canvas.width&&this.canvas2.height===this.canvas.height||(this.canvas2.width=this.canvas.width,this.canvas2.height=this.canvas.height))},i.clearGLCanvas=function(){this.gl&&(this.gl.clearStencil(255),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.STENCIL_BUFFER_BIT)),this.gl.wrap||this.gl.clear(this.gl.DEPTH_BUFFER_BIT)},i.disposeImage=function(e){e&&(e.texture&&this.saveTexture(e.texture),e.glBuffer&&this.saveImageBuffer(e.glBuffer),delete e.texture,delete e.glBuffer)},i._createTexture=function(e){var t=this.gl,n=this.getTexture()||t.createTexture();t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);var i=this.layer.options.mipmapTexture;return!i||dg(e.width)&&dg(e.height)||(e=function(e){if(dg(e.width)&&dg(e.height))return e;var t=e.width,n=e.height;dg(t)||(t=pg(t));dg(n)||(n=pg(n));var i=document.createElement("canvas");i.width=t,i.height=n;var s=i.getContext("2d");return s.imageSmoothingEnabled=!1,s.drawImage(e,0,0,t,n),i}(e)),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),i&&t.generateMipmap(t.TEXTURE_2D),n},i.getTexture=function(){this._textures||(this._textures=[]);var e=this._textures;return e&&e.length>0?e.pop():null},i.saveTexture=function(e){this._textures.push(e)},i.loadTexture=function(e,t=!1){var n=this.gl,i=e.texture;if(i||(i=this._createTexture(e),e.texture=i),n.bindTexture(n.TEXTURE_2D,i),this.layer.options.mipmapTexture){var s=this.getMap(),o=this.mapDPR||s.getDevicePixelRatio();s.isMoving()&&s.getRenderer().isViewChanged()?n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR_MIPMAP_LINEAR):n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,1!==o||t?n.LINEAR:n.NEAREST)}return i},i.getImageBuffer=function(){this._imageBuffers||(this._imageBuffers=[]);var e=this._imageBuffers;return e&&e.length>0?e.pop():null},i.saveImageBuffer=function(e){this._imageBuffers||(this._imageBuffers=[]),this._imageBuffers.push(e)},i.loadImageBuffer=function(e,t){var n=this.gl,i=t||this.createImageBuffer();return n.bindBuffer(n.ARRAY_BUFFER,i),n.bufferData(n.ARRAY_BUFFER,e,n.STATIC_DRAW),i},i.createImageBuffer=function(){return this.getImageBuffer()||this.createBuffer()},i.removeGLCanvas=function(){var e=this.gl;if(e){if(this._debugBuffer&&(e.deleteBuffer(this._debugBuffer),delete this._debugBuffer),this._buffers&&(this._buffers.forEach((function(t){e.deleteBuffer(t)})),delete this._buffers),this._textures&&(this._textures.forEach((function(t){return e.deleteTexture(t)})),delete this._textures),this._debugInfoCanvas){var t=this._debugInfoCanvas.texture;t&&e.deleteTexture(t),delete this._debugInfoCanvas.texture,delete this._debugInfoCanvas}var n=e.program;e.deleteShader(n.fragmentShader),e.deleteShader(n.vertexShader),e.deleteProgram(n),delete this.gl,delete this.canvas2}},i.createBuffer=function(){var e=this.gl.createBuffer();if(!e)throw new Error("Failed to create the buffer object");return this._buffers||(this._buffers=[]),this._buffers.push(e),e},i.enableVertexAttrib=function(e){tg(this.gl,this.gl.program,e)},i.createProgram=function(e,t){for(var n=this.gl,{program:i,vertexShader:s,fragmentShader:o}=eg(n,e,t),a=n.getProgramParameter(i,35718),l=[],h=0;h<a;++h){var c=n.getActiveUniform(i,h);l.push(c.name)}return i.vertexShader=s,i.fragmentShader=o,this._initUniforms(i,l),i},i.useProgram=function(e){var t=this.gl;return t.useProgram(e),t.program=e,this},i.enableSampler=function(e,t){var n=this.gl,i=this._getUniform(n.program,e);return t||(t=0),n.uniform1i(i,t),i},i._initUniforms=function(e,t){for(var i=0;i<t.length;i++){var s=t[i],o=t[i],a=s.indexOf("[");a>=0&&(s=s.substring(0,a),n||(o=o.substring(0,a))),e[s]=this._getUniform(e,o)}},i._getUniform=function(e,t){var n=this.gl.getUniformLocation(e,t);if(!n)throw new Error("Failed to get the storage location of "+t);return n},i.set8=function(e,t,n,i,s,o,a,l){var h=ig;return h[0]=e,h[1]=t,h[2]=n,h[3]=i,h[4]=s,h[5]=o,h[6]=a,h[7]=l,h},i.set8Int=function(e,t,n,i,s,o,a,l){var h=sg;return h[0]=e,h[1]=t,h[2]=n,h[3]=i,h[4]=s,h[5]=o,h[6]=a,h[7]=l,h},t}(e);return t};function dg(e){return!(e&e-1)&&0!==e}function pg(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))}var gg=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.needToRedraw=function(){var e=this.getMap();return!(!e.isInteracting()&&!e.getRenderer().isViewChanged())&&!(!e.getPitch()&&e.isMoving()&&!e.isZooming()&&!e.isRotating()&&!this.layer.options.forceRenderOnMoving)},n.createContext=function(){if(!(this.gl&&this.gl.canvas===this.canvas||this.context)&&(this.context=Ea.getCanvas2DPerformanceContext(this.canvas),this.context)){this.context.dpr=1,this.layer.options.globalCompositeOperation&&(this.context.globalCompositeOperation=this.layer.options.globalCompositeOperation);var e=this.getMap().getDevicePixelRatio();1!==e&&this._canvasContextScale(this.context,e)}},n.resetCanvasTransform=function(){if(this.context){var e=this.getMap().getDevicePixelRatio();this.context.setTransform(e,0,0,e,0,0)}},n.clearCanvas=function(){if(this.context){var e=this.getMap();if(e){var t=1/(this.mapDPR||e.getDevicePixelRatio()),n=this.canvas.height*t;Ea.clearRect(this.context,0,0,Math.max(this.canvas.width*t,this.canvas.width),Math.max(n,this.canvas.height))}}},n.clear=function(){this.clearCanvas(),this.setToRedraw()},n.prepareCanvas=function(){this.canvas?(this.resetCanvasTransform(),this.clearCanvas(),this.resizeCanvas()):(this.createCanvas(),this.createContext(),this.layer.onCanvasCreate(),this.layer.fire("canvascreate",{context:this.context,gl:this.gl})),delete this._maskExtent;var e=this.layer.getMask();if(!e)return this.layer.fire("renderstart",{context:this.context,gl:this.gl}),null;var t=this._maskExtent=e._getMaskPainter().get2DExtent();return t&&this._extent2D&&t.intersects(this._extent2D),this.layer.fire("renderstart",{context:this.context,gl:this.gl}),t},n.onResize=function(e){delete this._extent2D,this.resizeCanvas(),this.setToRedraw()},t}(Eu),mg={renderer:ye.webgl?"gl":"canvas",crossOrigin:null,alphaTest:!1,depthMask:!0,depthFunc:"<="},Ag=new Re(0,0),yg=function(e){function t(t,n,i){var s;return!n||Array.isArray(n)||n.url||(i=n,n=null),(s=e.call(this,t,i)||this)._images=n,s}Te(t,e);var n=t.prototype;return n.onAdd=function(){this._prepareImages(this._images)},n.setImages=function(e){return this._images=e,this._prepareImages(e),this},n.getImages=function(){return this._images},n._prepareImages=function(e){e=e||[],Array.isArray(e)||(e=[e]);var t=this.getMap(),n=t.getGLRes();this._imageData=e.map((function(e){var i=new Ml(e.extent);return l({},e,{extent:i,extent2d:i.convertTo((function(e){return t.coordToPointAtRes(e,n)}))})})),this._images=e;var i=this.getRenderer();i&&i.refreshImages()},n.getRenderer=function(){return e.prototype.getRenderer.call(this)},t}(Lu);yg.mergeOptions(mg);var _g,vg=[],xg=function(e){var t=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.isDrawable=function(){return!0},n.checkResources=function(){var e=this;if(this._imageLoaded)return vg;var t=this.layer._imageData.map((function(e){return[e.url,null,null]}));if(this.resources){var n=[],i=Ps();t.forEach((function(t){if(e.resources.isResourceLoaded(t)){var s=e.resources.getImage(t);i.addResource(t,s)}else n.push(t)})),this.resources.forEach((function(t,n){i.isResourceLoaded(t)||e.retireImage(n.image)})),this.resources=i,t=n}return this._imageLoaded=!0,t},n.retireImage=function(e){e.close&&e.close()},n.refreshImages=function(){this._imageLoaded=!1,this.setToRedraw()},n.draw=function(e,t){this.isDrawable()&&(this.prepareCanvas(),this._painted=!1,this.drawImages(e,t),this.completeRender())},n.drawImage=function(e,t,n){},n.drawImages=function(e,t){var n=this.layer._imageData,i=this.getMap(),s=i.get2DExtentAtRes(i.getGLRes());if(n&&n.length)for(var o=0;o<n.length;o++){var a=n[o].extent2d,l=this.resources&&this.resources.getImage(n[o].url);if(l&&s.intersects(a)){this._painted=!0;var h=n[o].opacity;c(h)||(h=1),this.drawImage(l,a,h)}}},n.drawOnInteracting=function(e,t,n){this.draw()},t}(e);return t},bg=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.isDrawable=function(){return!this.getMap().getPitch()||(console&&console.warn("ImageLayer with canvas renderer can't be pitched, use gl renderer ('renderer' : 'gl') instead."),!1)},n.drawImage=function(e,t,n){var i=0,s=this.context;n<1&&(i=s.globalAlpha,s.globalAlpha=n);var o=this.getMap(),a=Ag.set(t.xmin,t.ymax),l=o._pointAtResToContainerPoint(a,o.getGLRes()),h=l.x,c=l.y,u=o.getBearing();u&&(s.save(),s.translate(h,c),u&&s.rotate(-u*Math.PI/180),h=c=0);var f=o.getGLScale();s.drawImage(e,h,c,t.getWidth()/f,t.getHeight()/f),u&&s.restore(),i&&(s.globalAlpha=i)},t}(xg(gg)),wg=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.drawOnInteracting=function(e,t,n){this.draw(t,n)},n._prepareGLContext=function(){var e=this.gl;e&&(e.disable(e.STENCIL_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.enable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.depthFunc(function(e){return ng[e]}(this.layer.options.depthFunc)),e.depthMask(!!this.layer.options.depthMask))},n.drawImages=function(t,n){var i=this.gl;if(n&&n.renderTarget){var s=n.renderTarget.fbo;if(s){var o=n.renderTarget.getFramebuffer(s);i.bindFramebuffer(i.FRAMEBUFFER,o)}}(this._prepareGLContext(),e.prototype.drawImages.call(this),n&&n.renderTarget)&&(n.renderTarget.fbo&&i.bindFramebuffer(i.FRAMEBUFFER,null))},n.isDrawable=function(){return!0},n.drawImage=function(e,t,n){var i=t.getWidth();this.drawGLImage(e,t.xmin,t.ymax,i,t.getHeight(),1,n,e.width!==i)},n.createContext=function(){this.createGLContext()},n.resizeCanvas=function(t){this.canvas&&(e.prototype.resizeCanvas.call(this,t),this.resizeGLCanvas())},n.clearCanvas=function(){this.canvas&&(e.prototype.clearCanvas.call(this),this.clearGLCanvas())},n.retireImage=function(e){e.close&&e.close(),this.disposeImage(e)},n.onRemove=function(){this.removeGLCanvas(),e.prototype.onRemove.call(this)},t}(fg(bg));yg.registerRenderer("canvas",bg),yg.registerRenderer("gl",wg),function(e){e[e.never=0]="never",e[e["<"]=1]="<",e[e["="]=2]="=",e[e["<="]=3]="<=",e[e[" >"]=4]=" >",e[e["!="]=5]="!=",e[e[">="]=6]=">=",e[e.always=7]="always"}(_g||(_g={}));var Tg=new Pl,Sg={debug:!1,enableSimplify:!0,defaultIconSize:[20,20],cacheVectorOnCanvas:!0,cacheSvgOnCanvas:ye.gecko,enableAltitude:!0,altitudeProperty:"altitude",drawAltitude:!1,sortByDistanceToCamera:!1,roundPoint:!1,altitude:0,clipBBoxBufferSize:3,collision:!1,collisionBufferSize:2,collisionDelay:250,collisionScope:"layer",progressiveRender:!1,progressiveRenderCount:1e3,progressiveRenderDebug:!1},Mg=function(e){function t(t,n,i){var s;return(s=e.call(this,t,n,i)||this).isVectorLayer=!0,s}Te(t,e);var n=t.prototype;return n.onConfig=function(t){if(e.prototype.onConfig.call(this,t),!h(t.enableAltitude))for(var n=this.getGeometries()||[],i=0,s=n.length;i<s;i++){var o=n[i];o&&(o._clearAltitudeCache(),o.fire("positionchange"))}if(t.enableAltitude||t.drawAltitude||t.altitudeProperty){var a=this.getRenderer();a&&a.setToRedraw&&a.setToRedraw()}},n.identify=function(e,t){t=t||{};var n=this.getRenderer();e instanceof fl||(e=new fl(e));var i=this.getMap().coordToContainerPoint(e);return t.onlyVisible&&n&&n.identifyAtPoint?n.identifyAtPoint(i,t):this._hitGeos(this._geoList,i,t)},n.identifyAtPoint=function(e,t){t=t||{};var n=this.getRenderer();return e instanceof Re||(e=new Re(e)),t.onlyVisible&&n&&n.identifyAtPoint?n.identifyAtPoint(e,t):this._hitGeos(this._geoList,e,t)},n._hitGeos=function(e,t,n={}){if(!e||!e.length)return[];for(var i=[],s=0,o=0,a=e.length;o<a;o++){var l=e[o];l.isPoint&&!0===l._collided||(i[s]=l,s++)}e=i;var h=n.filter,u=[],f=n.tolerance,g=this.getMap(),m=this.getRenderer(),A=m&&m.getImageData&&m.getImageData();if(A){var w=0,T=m.maxTolerance;if(c(T))w=T;else for(var S=e.length-1;S>=0;S--){var M=e[S]._hitTestTolerance()+(f||0);M>w&&(w=M)}var C=g.getDevicePixelRatio();A.r=C;for(var I=!1,E=t.x-w,D=t.y-w,H=-w;H<=w;H++){for(var N=-w;N<=w;N++){var B=Math.round((E+H)*C),z=Math.round((D+N)*C);if(A.data[z*A.width*4+4*B+3]>0){I=!0;break}}if(I)break}if(!I)return u}for(var U=n.onlyVisible,j=e.length-1;j>=0;j--){var W=e[j];if(W&&W.options.interactive&&(U||W.isVisible())){var q=W._getPainter();if(q){var Z=q.getRenderBBOX&&q.getRenderBBOX();if(Z){var{x:X,y:Y}=t;if(X<Z[0]||Y<Z[1]||X>Z[2]||Y>Z[3])continue}if(!(W instanceof yf&&(W._getArrowStyle()||W instanceof Bf))){var J=W.getContainerExtent(Tg);if(f&&(J=J._expand(f)),!J||!J.contains(t))continue}if(W._containsPoint(t,f)&&(!h||h(W))&&(u.push(W),n.count&&u.length>=n.count))break}}}return u},n.getAltitude=function(){return this.options.altitude||0},n.toJSON=function(e){e||(e={clipExtent:null,geometries:null});var t={type:this.getJSONType(),id:this.getId(),options:this.config()};if(h(e.geometries)||e.geometries){var n;if(e.clipExtent){var i=this.getMap(),s=i?i.getProjection():null;n=new Ml(e.clipExtent,s)}for(var o=[],a=this.getGeometries(),l=0,c=a.length;l<c;l++){var u=a[l],f=u.getExtent();if(f&&(!n||n.intersects(f))){var g=u.toJSON(e.geometries);o.push(g)}}t.geometries=o}return t},n.getRenderer=function(){return e.prototype.getRenderer.call(this)},t.fromJSON=function(e){if(!e||"VectorLayer"!==e.type)return null;for(var n=new t(e.id,e.options),i=e.geometries,s=[],o=0;o<i.length;o++){var a=gu.fromJSON(i[o]);a&&s.push(a)}return n.addGeometry(s),n},t.getPainterClass=function(){return Qc},t.getCollectionPainterClass=function(){return eu},t}(ed);Mg.mergeOptions(Sg),Mg.registerJSONType("VectorLayer"),td.setLayerClass(Mg,Mg,Mg);var Cg=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.getPrepareParams=function(){return[]},n.getDrawParams=function(){return[]},n.onCanvasCreate=function(){this.canvas&&this.layer.options.doubleBuffer&&(this.buffer=Ea.createCanvas(this.canvas.width,this.canvas.height,this.getMap().CanvasClass))},n.needToRedraw=function(){return!!this.layer.options.animation||!(this.getMap().isInteracting()&&!this.layer.drawOnInteracting)&&e.prototype.needToRedraw.call(this)},n.draw=function(...e){this.prepareCanvas(),this.prepareDrawContext(),this._drawLayer(...e)},n.drawOnInteracting=function(...e){this._drawLayerOnInteracting(...e)},n.getCanvasImage=function(){var t=e.prototype.getCanvasImage.call(this);if(t&&t.image&&this.layer.options.doubleBuffer){var n=t.image;this.buffer.width===n.width&&this.buffer.height===n.height||(this.buffer.width=n.width,this.buffer.height=n.height);var i=this.buffer.getContext("2d"),s=this.layer.doubleBuffer(i,this.context);(void 0===s||s)&&(Ea.image(i,n,0,0),t.image=this.buffer)}return t},n.remove=function(){return delete this._drawContext,e.prototype.remove.call(this)},n.onZoomStart=function(t){this.layer.onZoomStart(t),e.prototype.onZoomStart.call(this,t)},n.onZooming=function(t){this.layer.onZooming(t),e.prototype.onZooming.call(this,t)},n.onZoomEnd=function(t){this.layer.onZoomEnd(t),e.prototype.onZoomEnd.call(this,t)},n.onMoveStart=function(t){this.layer.onMoveStart(t),e.prototype.onMoveStart.call(this,t)},n.onMoving=function(t){this.layer.onMoving(t),e.prototype.onMoving.call(this,t)},n.onMoveEnd=function(t){this.layer.onMoveEnd(t),e.prototype.onMoveEnd.call(this,t)},n.onResize=function(t){this.layer.onResize(t),e.prototype.onResize.call(this,t)},n.prepareDrawContext=function(){if(!this._predrawed){var e=Pg(this.getPrepareParams());this._drawContext=this.layer.prepareToDraw(this.context,...e),this._drawContext||(this._drawContext=[]),Array.isArray(this._drawContext)||(this._drawContext=[this._drawContext]),this._predrawed=!0}},n._prepareDrawParams=function(){if(!this.getMap())return null;var e=this.getViewExtent();return e.maskExtent&&!e.extent.intersects(e.maskExtent)?(this.completeRender(),null):[...[this.context,e],...Pg(this.getDrawParams()),...this._drawContext]},n._drawLayer=function(...e){var t=this._prepareDrawParams();t&&(this.layer.draw.apply(this.layer,t.concat(e)),this.completeRender())},n._drawLayerOnInteracting=function(...e){if(this.layer.drawOnInteracting){var t=this._prepareDrawParams();t&&(this.layer.drawOnInteracting(...t,...e),this.completeRender())}},t}(gg);function Pg(e){return e||(e=[]),Array.isArray(e)||(e=[e]),e}var Ig=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.isCanvasRender=function(){return!0},n.prepareToDraw=function(){},n.draw=function(...e){},n.redraw=function(){return this._getRenderer()&&this._getRenderer().setToRedraw(),this},n.play=function(){return this.config("animation",!0),this},n.pause=function(){return this.config("animation",!1),this},n.isPlaying=function(){return this.options.animation},n.clearCanvas=function(){return this._getRenderer()&&this._getRenderer().clearCanvas(),this},n.requestMapToRender=function(){var e=this._getRenderer();return e&&e.requestMapToRender&&e.requestMapToRender(),this},n.completeRender=function(){return this._getRenderer()&&this._getRenderer().completeRender(),this},n.onCanvasCreate=function(){return this},n.onZoomStart=function(){},n.onZooming=function(){},n.onZoomEnd=function(){},n.onMoveStart=function(){},n.onMoving=function(){},n.onMoveEnd=function(){},n.onResize=function(){},n.doubleBuffer=function(e){return e.clearRect(0,0,e.canvas.width,e.canvas.height),this},n._getRenderer=function(){return e.prototype._getRenderer.call(this)},t}(Lu);Ig.mergeOptions({doubleBuffer:!1,animation:!1}),Ig.registerRenderer("canvas",Cg);var kg=new Re(0,0),Og=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.getParticles=function(e){},n.draw=function(e,t){var n=this.getParticles(a());if(n&&0!==n.length){var i=this.getMap(),s=t.extent;t.maskExtent&&(s=t.extent.intersection(t.maskExtent)),s=s.convertTo((function(e){return i._pointToContainerPoint(e,void 0,0,kg)}));for(var o=2*Math.PI,l=0,h=n.length;l<h;l++){var c=n[l].point;if(s.contains(c)){var u=n[l].color||this.options.lineColor||"#fff",f=n[l].r;e.fillStyle!==u&&(e.fillStyle=u),f<=2?e.fillRect(c.x-f/2,c.y-f/2,f,f):(e.beginPath(),e.arc(c.x,c.y,f/2,0,o),e.fill())}}this._fillCanvas(e)}else{this._getRenderer()&&(this._getRenderer()._shouldClear=!0)}},n._fillCanvas=function(e){var t=e.globalCompositeOperation;e.globalCompositeOperation="destination-out",e.fillStyle="rgba(0, 0, 0, "+1/(this.options.trail||30)+")",e.fillRect(0,0,e.canvas.width,e.canvas.height),e.globalCompositeOperation=t},t}(Ig);Og.mergeOptions({animation:!0}),Og.registerRenderer("canvas",function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.draw=function(){this.canvas&&this.layer.options.animation&&!this._shouldClear||(this.prepareCanvas(),this._shouldClear=!1),this.prepareDrawContext(),this._drawLayer()},n.drawOnInteracting=function(){this.draw(),this._shouldClear=!1},n.onSkipDrawOnInteracting=function(){this._shouldClear=!0},t}(Cg));var Eg,Rg,Lg=Ps(),Dg=function(e){function t(t,n,i){var s;(s=e.call(this,i||{})||this).target=t,t.once("remove",s.delete,s);var o=s.options.symbol,a=o.markerLineWidth||1;return s.w=o.markerWidth+a,s.h=o.markerHeight+a,s.opacity=h(o.opacity)?1:o.opacity,s.map=n,s.events=i.events,s._fetchImage(),s.addTo(n),s}Te(t,e);var n=t.prototype;return n.getCursor=function(){return this.options.cursor||"default"},n._fetchImage=function(){var e=this.map,t=this.options.symbol,{markerFile:n}=t;this.url=n||xi(t);var i=Lg.getImage(this.url);if(!i){var s=this.w,o=this.h;if(n)(i=new Image).onload=function(){var t=e.getRenderer();t&&t.setToRedraw()},i.src=this.url;else{var a=document.createElement("canvas");a.width=s,a.height=o,i=cc(a.getContext("2d"),{x:s/2,y:o/2},t,Lg)}Lg.addResource([this.url,s,o],i)}Lg.login(this.url),this._img=i},n.setContainerPoint=function(e){this._point=e,this._point._sub(this.w/2,this.h/2)},n.getContainerPoint=function(){return this._point.add(this.w/2,this.h/2)},n.offset=function(e){this._point._add(e)},n.render=function(e){if(!this._img)return!1;var t=this.options.symbol,n=t.markerDx||0,i=t.markerDy||0,s=this.map,{x:o,y:a}=this._point,l=this.w,h=this.h;if(o+l>0&&o<s.width&&a+h>0&&a<s.height){var c=s.getDevicePixelRatio();return e.globalAlpha=this.opacity,e.drawImage(this._img,Math.round((o+n)*c),Math.round((a+i)*c),Math.round(l*c),Math.round(h*c)),!0}return!1},n.delete=function(){if(this.map){var e=this.map.getRenderer();e&&e.removeTopElement(this)}Lg.logout(this.url),this._dragger&&(this._dragger.disable(),delete this._dragger),delete this.map},n.hitTest=function(e){var t=this.options.symbol,n=this._point.x+(t.markerDx||0),i=this._point.y+(t.markerDy||0);return e.x>=n&&e.x<=n+this.w&&e.y>=i&&e.y<=i+this.h},n.addTo=function(e){this.map=e,e.getRenderer().addTopElement(this)},n.onEvent=function(e){this.fire(e.type,e)},n.mousedown=function(e){var t=this.options.cursor;t&&e.target.setCursor(t),this.onDragstart(e)},n.onDragstart=function(e){var{containerPoint:t,target:n}=e,i=n.getPanels().mapWrapper||n.getContainer(),s=this._dragger=new ul(i);s.on("dragging",this.onDragging,this).on("mouseup",this.onDragend,this).enable(),s.onMouseDown(e.domEvent),Eg=t.x,Rg=t.y,this.fire("dragstart",{containerPoint:t})},n.onDragging=function(e){if(this._dragger){var t=this.map,n=Rn(e.domEvent,t.getContainer()),i={x:n.x-Eg,y:n.y-Rg},s=t.containerPointToCoord(new Re(Eg,Rg)),o=t.containerPointToCoord(n);Eg=n.x,Rg=n.y,this.offset(i),this.fire("dragging",{containerPoint:n,coordOffset:o._sub(s)})}},n.onDragend=function(e){if(this._dragger){var t=this.map;t.resetCursor();var n=Rn(e.domEvent,t.getContainer());this.offset({x:n.x-Eg,y:n.y-Rg}),this._dragger.disable(),delete this._dragger,this.fire("dragend",{containerPoint:n})}},n.needCollision=function(){var{target:e}=this;return!this.options.ignoreCollision&&(e&&e.options&&e.options.collision)},n.getRenderBBOX=function(e){var{target:t,map:n}=this;if(!t||!t.options||!n)return null;var i=this.options.symbol,s=i.markerDx||0,o=i.markerDy||0,{x:a,y:l}=this._point,h=this.w,c=this.h;e=e||n.getDevicePixelRatio(),this.bbox=this.bbox||hs();var u=Math.round((a+s)*e),f=Math.round((l+o)*e),g=Math.round(h*e),m=Math.round(c*e);this.bbox[0]=u,this.bbox[1]=f,this.bbox[2]=u+g,this.bbox[3]=f+m;var{options:A}=t;return _s(this.bbox,A.collisionBufferSize||0),this.bbox},n.setZIndex=function(e){this.options.zIndex=e},t}(Ba(Ua)),Fg=function(){function e(e,t,n){this.target=e,e.once("remove",this.delete,this),this.map=t,this.options=n||{},this.addTo(t)}var t=e.prototype;return t.setPoints=function(e){this.points=e;var t=e.map((function(e){return e.x})),n=e.map((function(e){return e.y}));this.xmin=Math.min(...t),this.xmax=Math.max(...t),this.ymin=Math.min(...n),this.ymax=Math.max(...n)},t.hitTest=function(){return!1},t.render=function(e){var t=this.map;if(!(this.xmax<=0||this.xmin>=t.width||this.ymax<=0||this.ymin>=t.height)){var n=t.getDevicePixelRatio();e.lineWidth=1,e.strokeStyle="#000",e.globalAlpha=1,e.beginPath();var i=this.points;e.moveTo(o(i[0].x),o(i[0].y));for(var s=1;s<this.points.length;s++)e.lineTo(o(i[s].x),o(i[s].y));e.closePath(),e.stroke()}function o(e){return Math.round(e)*n+.5}},t.addTo=function(e){this.map=e,e.getRenderer().addTopElement(this)},t.delete=function(){if(this.map){var e=this.map.getRenderer();e&&e.removeTopElement(this)}},e}(),Hg=vt+"_edit_stage_",Ng="dragend dragstart";function Bg(e,t){return{markerType:e,markerFill:"#fff",markerLineColor:"#000",markerLineWidth:2,markerWidth:10,markerHeight:10,opacity:t}}function zg(e,t){var n=e.getGLRes(),i=e.coordToPointAtRes(t,n);return e._pointAtResToContainerPoint(i,n,t.z||0)}function Gg(e,t,n){var i=e.getMap();if(!t||0===t.z)return i.containerPointToCoord(n);var s=t.z,o=i.getGLRes(),a=i.coordToPointAtRes(t,o),l=i._pointAtResToContainerPoint(a,o,0),h=i._pointAtResToContainerPoint(a,o,s).sub(l),c=n.sub(h),u=i.containerPointToCoord(c);return u.z=0,!e.getGeometries&&e.isPoint&&(u.z=s),u}function Ug(e){var t=this.target,n=this.paramOptions;return t._updating=!0,n.onDown&&(n.onDown.call(t,e.containerPoint,e),t._geometry.fire("handledragstart")),!1}function Vg(e){var t=this.target,n=this.paramOptions;return t._hideContext(),n.onMove&&(n.onMove.call(t,e),t._geometry.fire("handledragging")),!1}function jg(e){var t=this.target,n=this.paramOptions;return n.onUp&&(n.onUp.call(t,e),t._geometry.fire("handledragend")),t._updating=!1,!1}var Wg={fixAspectRatio:!1,symbol:null,removeVertexOn:"contextmenu",centerHandleSymbol:Bg("ellipse",1),vertexHandleSymbol:Bg("square",1),newVertexHandleSymbol:Bg("square",.4),collision:!1,collisionBufferSize:0,vertexZIndex:0,newVertexZIndex:0,shadowDraggable:!1},qg=function(e){function t(t,n){var i;return(i=e.call(this,n)||this)._geometry=t,i._geometry?i:ve(i)}Te(t,e);var n=t.prototype;return n.getMap=function(){return this._geometry.getMap()},n.prepare=function(){var e=this.getMap();e&&(e.on("drawtopstart",this._refresh,this),this.options.symbol&&(this._originalSymbol=this._geometry.getSymbol(),this._geometry.setSymbol(this.options.symbol)),this._prepareEditStageLayer())},n._prepareEditStageLayer=function(){var e=this._geometry.getLayer();if("canvas"===e.options.renderer){var t=this.getMap(),n=He(),i=Hg+n+"_shadow";if(this._shadowLayer=t.getLayer(i),!this._shadowLayer)this._shadowLayer=new(0,e.constructor)(i),t.addLayer(this._shadowLayer)}},n.start=function(){if(this._geometry&&this._geometry.getMap()&&!this._geometry.editing){this.editing=!0,this.prepare();var e,t=this._geometry,n="canvas"===this._geometry.getLayer().options.renderer;this._geometryDraggble=t.options.draggable,n?(t.config("draggable",!1),(e=t.copy()).setSymbol(t._getInternalSymbol()),e.copyEventListeners(t),t._getParent()&&e.copyEventListeners(t._getParent()),e._setEventTarget(t),e.setId(null).config({draggable:this.options.shadowDraggable}),this._shadow=e,t.hide()):t instanceof mf&&t.config("draggable",!0),this._switchGeometryEvents("on"),(t instanceof mf||t instanceof Lf||t instanceof Hf||t instanceof Ff)&&this._createOrRefreshOutline(),this._shadowLayer&&this._shadowLayer.bringToFront().addGeometry(e),t instanceof mf?e&&(e.config("draggable",!0),e.on("dragend",this._onMarkerDragEnd,this)):this._createCenterHandle(),t instanceof mf&&!1!==this.options.resize?this.createMarkerEditor():t instanceof Lf?this.createCircleEditor():t instanceof Hf||t instanceof Ff?this.createEllipseOrRectEditor():t instanceof Nf||(t instanceof df||t instanceof yf)&&this.createPolygonEditor()}},n.stop=function(){delete this._history,delete this._historyPointer,delete this._editOutline,this._switchGeometryEvents("off"),this.getMap()?(this._geometry.config("draggable",this._geometryDraggble),this._shadow&&(this._shadow.off(Ng,this._shadowDragEvent,this),delete this._shadow,delete this._geometryDraggble,this._geometry.show()),this._shadowLayer&&(this._shadowLayer.remove(),delete this._shadowLayer),this._refreshHooks=[],this.options.symbol&&(this._geometry.setSymbol(this._originalSymbol),delete this._originalSymbol),this.editing=!1,this.fire("remove")):this.fire("remove")},n.isEditing=function(){return!h(this.editing)&&this.editing},n._getGeometryEvents=function(){return{symbolchange:this._onGeoSymbolChange,dragstart:this._onDragStart,dragend:this._onDragEnd,"positionchange shapechange":this._exeAndReset}},n._switchGeometryEvents=function(e){if(this._geometry){var t=this._getGeometryEvents();for(var n in t)this._geometry[e](n,t[n],this)}},n._onGeoSymbolChange=function(e){this._shadow&&this._shadow.setSymbol(e.target._getInternalSymbol())},n._onMarkerDragEnd=function(){this._update("setCoordinates",this._shadow.getCoordinates().toArray())},n._createOrRefreshOutline=function(){var e=this._geometry,t=this._editOutline;t||(this._editOutline=new Fg(this,this.getMap()),this._addRefreshHook(this._createOrRefreshOutline));var n=this._editOutline.points;if(e instanceof mf)this._editOutline.setPoints(e.getContainerExtent().toArray(n));else{var i=e.getShell(),s=e._getEditCenter(),o=hs();ps(i,o);var a=new Ml(o[0],o[1],o[2],o[3]),l=this.getMap(),h=a.toArray().map((function(e){return e.z=s.z,zg(l,e)}));this._editOutline.setPoints(h)}return t},n._shadowDragEvent=function(e){"dragend"===e.type&&this._updateCoordFromShadow()},n._createCenterHandle=function(){var e,t=this,n=this.getMap(),i=this.options.centerHandleSymbol;this._shadow&&this._shadow.off(Ng,this._shadowDragEvent,this),this.options.shadowDraggable&&this._shadow&&this._shadow.on(Ng,this._shadowDragEvent,this);var s=zg(n,this._geometry._getEditCenter()),o=this.createHandle(s,{ignoreCollision:!0,symbol:i,cursor:"move",onDown:function(){if(t._shadow){var n=bi((e=t._shadow.copy())._getInternalSymbol(),.5);e.setSymbol(n).addTo(t._geometry.getLayer())}},onMove:function(n){var i=n.coordOffset;e?e.translate(i):t._geometry.translate(i)},onUp:function(){if(e){var n=e.getFirstCoordinate(),i=t._geometry.getFirstCoordinate(),s=n.sub(i);t._update("translate",s),e.remove()}}});this._addRefreshHook((function(){var e=t._geometry._getEditCenter();o.setContainerPoint(zg(n,e))}))},n._createHandleInstance=function(e,t){t=t||{};var n=this.getMap(),i=Fr(t.symbol,(function(){return[n.getZoom(),{"{bearing}":n.getBearing(),"{pitch}":n.getPitch(),"{zoom}":n.getZoom()}]})),s=new Dg(this,n,{symbol:i,cursor:t.cursor,events:this.options.removeVertexOn,ignoreCollision:t.ignoreCollision});return s.setContainerPoint(e),s},n.createHandle=function(e,t){t||(t={});var n=this._createHandleInstance(e,t);return n.paramOptions=t,n.on("dragstart",Ug),n.on("dragging",Vg),n.on("dragend",jg),t.onRefresh&&(n.refresh=t.onRefresh),n},n._createResizeHandles=function(e,t,n){var i=this,s=["nw-resize","n-resize","ne-resize","w-resize","e-resize","sw-resize","s-resize","se-resize"],o=[null,"y",null,"x","x",null,"y",null],a=this._geometry,l=a instanceof mf,h=[];e||(e=[]);var c=this,u=[],f={},g=this.getMap(),m=this.options.vertexHandleSymbol,A=function(){for(var A=function(){if(l){var e=a.getContainerExtent();return[new Re(e.xmin,e.ymin),new Re((e.xmax+e.xmin)/2,e.ymin),new Re(e.xmax,e.ymin),new Re(e.xmin,(e.ymin+e.ymax)/2),new Re(e.xmax,(e.ymin+e.ymax)/2),new Re(e.xmin,e.ymax),new Re((e.xmax+e.xmin)/2,e.ymax),new Re(e.xmax,e.ymax)]}var t=a.getShell(),n=a._getEditCenter(),i=hs();ps(t,i);var s=new Ml(i[0],i[1],i[2],i[3]);return(h=[new fl(s.xmin,s.ymax),new fl((s.xmax+s.xmin)/2,s.ymax),new fl(s.xmax,s.ymax),new fl(s.xmin,(s.ymax+s.ymin)/2),new fl(s.xmax,(s.ymax+s.ymin)/2),new fl(s.xmin,s.ymin),new fl((s.xmax+s.xmin)/2,s.ymin),new fl(s.xmax,s.ymin)]).map((function(e){return e.z=n.z,zg(g,e)}))}(),w=function(l){if(Array.isArray(e)&&e.some((function(e){return e===l})))return 1;var g,w=A[l],T=h[l];if(u.length<A.length-e.length){var S=i.createHandle(w,{symbol:m,cursor:s[l],axis:o[l],onMove:(g=l,function(e){c._updating=!0,t(e.containerPoint,g),a.fire("resizing")}),onUp:function(){c._updating=!1,n()}});f[l]=u.length,u.push(S),S.coord=T}else u[f[l]].coord=T,u[f[l]].setContainerPoint(w)},T=0;T<A.length;T++)w(T)};return A(),this._addRefreshHook(A),u},n.createMarkerEditor=function(){var e=this,t=this._shadow||this._geometry,n=this.getMap();if(t._canEdit()){this._history||this._recordHistory(A());var i=t._getInternalSymbol(),s=new Re(0,0);c(i.markerDx)&&(s.x=i.markerDx),c(i.markerDy)&&(s.y=i.markerDy);var o=null,a="middle",l="middle";if(Fc.test(i)){var h=i.markerType;"pin"===h||"pie"===h||"bar"===h?(o=[5,6,7],a="bottom"):"rectangle"===h&&(o=[0,1,2,3,5],a="top",l="left")}else(xc.test(i)||Hc.test(i))&&(a="bottom",o=[5,6,7]);var u,f=[2,1,2,0,0,2,1,2];if(this.options.fixAspectRatio){var g=t.getSize();u=g.width/g.height}var m=this._createResizeHandles(o,(function(i,h){if(o&&o.indexOf(h)>=0){var c=n.containerPointToCoordinate(i.sub(s)),g=t.getCoordinates();c.x=g.x,t.setCoordinates(c),e._updateCoordFromShadow(!0),i=m[m.length-1-h].getContainerPoint()}var A=zg(n,t._getEditCenter()).add(s),w=t._getInternalSymbol(),T=i.sub(A);"bottom"===a&&i.y>A.y&&(T.y=0);var S="middle"===a?2:1,M="left"===l?1:2,C=Math.abs(T.x)*M,I=Math.abs(T.y)*S;u&&(I=(C=Math.max(C,I*u))/u);var E=f[h];t instanceof qf?((u||0===E||2===E)&&(t.setWidth(C),t!==e._geometry&&e._geometry.setWidth(C)),(u||1===E||2===E)&&(t.setHeight(I),t!==e._geometry&&e._geometry.setHeight(I))):((u||0===E||2===E)&&(w.markerWidth=Math.min(C,e._geometry.options.maxMarkerWidth||1/0)),(u||1===E||2===E)&&(w.markerHeight=Math.min(I,e._geometry.options.maxMarkerHeight||1/0)),t.setSymbol(w),t!==e._geometry&&e._geometry.setSymbol(w))}),(function(){e._update(A())}))}else console&&console.warn("A marker can't be resized with symbol:",t.getSymbol());function A(){var e=[["setCoordinates",t.getCoordinates().toArray()]];return t instanceof qf?(e.push(["setWidth",t.getWidth()]),e.push(["setHeight",t.getHeight()])):e.push(["setSymbol",t.getSymbol()]),e}},n.createCircleEditor=function(){var e=this,t=this._shadow||this._geometry,n=this.getMap();this._history||this._recordHistory([["setCoordinates",t.getCoordinates().toArray()],["setRadius",t.getRadius()]]),this._createResizeHandles(null,(function(i){var s=t.getCenter(),o=Gg(t,s,i),a=new yf([[s.x,s.y],[o.x,s.y]]),l=new yf([[s.x,s.y],[s.x,o.y]]),h=Math.max(n.computeGeometryLength(a),n.computeGeometryLength(l));t.setRadius(h),t!==e._geometry&&e._geometry.setRadius(h)}),(function(){e._update("setRadius",t.getRadius())}))},n.createEllipseOrRectEditor=function(){var e=this,t=[2,1,2,0,0,2,1,2],n=this._shadow||this._geometry;this._history||this._recordHistory(l());var i,s=this.getMap(),o=this._geometry instanceof Hf;this.options.fixAspectRatio&&(i=n.getWidth()/n.getHeight());var a=this._createResizeHandles(null,(function(l,h){var c,u,f,g=o?1:2,m=a[h].getContainerPoint(),A=t[h];if(o){var w=a[7-h],T=w.getContainerPoint(),S=(c=m.sub(T)).abs();u=s.pixelToDistance(S.x,0),f=s.pixelToDistance(0,S.y);var M=n.getSize(),C=n.getCoordinates(),I=n.getWidth(),E=n.getHeight(),D=w.coord,H=Gg(n,C,l),N=new yf([[D.x,D.y],[H.x,D.y]]),B=new yf([[D.x,D.y],[D.x,H.y]]);if(u=s.computeGeometryLength(N),f=s.computeGeometryLength(B),0===A)if(i&&(S.y=S.x/i,M.height=Math.abs(S.y),f=u/i),m.y=T.y-M.height/2,H.y=C.y,4===h)H.x=Math.min(H.x,C.x);else{var z=s.locate(C,I,0);H.x=s.locate(new fl(z.x,H.y),-u,0).x}else if(1===A)i&&(S.x=S.y*i,M.width=Math.abs(S.x),u=f*i),m.x=T.x-M.width/2,H.x=C.x,H.y=Math.max(H.y,D.y);else{if(i&&(u>f*i?(f=u/i,m.y=T.y+S.x*We(c.y)/i):(u=f*i,m.x=T.x+S.y*We(c.x)*i)),0===h||5===h){var U=s.locate(C,I,0===h?0:-E);H.x=s.locate(new fl(U.x,H.y),-u,0).x}else H.x=Math.min(H.x,D.x);H.y=Math.max(H.y,D.y)}H.z=C.z,n.setCoordinates(H),e._updateCoordFromShadow(!0)}else{var j=n.getCenter(),W=Gg(n,j,l),q=new yf([[j.x,j.y],[W.x,j.y]]),Z=new yf([[j.x,j.y],[j.x,W.y]]);u=s.computeGeometryLength(q),f=s.computeGeometryLength(Z),i&&(f=(u=Math.max(u,f*i))/i)}(i||0===A||2===A)&&(n.setWidth(u*g),n!==e._geometry&&e._geometry.setWidth(u*g)),(i||1===A||2===A)&&(n.setHeight(f*g),n!==e._geometry&&e._geometry.setHeight(f*g))}),(function(){e._update(l())}));function l(){return[["setCoordinates",n.getCoordinates().toArray()],["setWidth",n.getWidth()],["setHeight",n.getHeight()]]}},n.createPolygonEditor=function(){var e=this.getMap(),t=this._shadow||this._geometry,n=this;this._history||this._recordHistory("setCoordinates",fl.toNumberArrays(t.getCoordinates()));var i=t instanceof df?3:2,s="maptalks--editor-vertex-index",{vertexZIndex:o,newVertexZIndex:a}=this.options,l={0:[]},h={0:[]};function u(e,n){if(t instanceof df){var i=t.getCoordinates();i[n]=e,t.setCoordinates(i)}else t.setCoordinates(e)}function f(e=0){if(t instanceof df){var n=t.getCoordinates()[e]||[];return n.slice(0,n.length-1)}return t.getCoordinates()}function g(){for(var e in l){for(var t=l[e].length-1;t>=0;t--)l[e][t][s]=t;for(var i=h[e].length-1;i>=0;i--)h[e][i][s]=i}n._updateCoordFromShadow()}function A(o){n._updating=!0;var a=o.target,m=a[s],A=c(a._ringIndex)?a._ringIndex:0,w=f(A);if(w.length<=i)console.warn(" Geometry."+t.type+" Require at least "+i+" vertices,Geometry: ",t);else{if(w.splice(m,1),u(w,A),0===m)h[A][0].delete(),h[A].splice(0,1);else if(m===l[A].length-1){var T=h[A].length;h[A][T-1].delete(),h[A].splice(T-1,1)}else h[A][m-1].delete(),h[A].splice(m-1,1),h[A][m-1].delete(),h[A].splice(m-1,1),h[A].splice(m-1,0,E.call(n,m-1,A));if(l[A].splice(m,1)[0].delete(),A>0){var S=t.getCoordinates(),M=S[A];M&&Array.isArray(M)&&M.length>1&&t!==this._geometry&&t.setCoordinates(S)}g(),n._updating=!1,n._geometry.fire("handleremove",Object.assign({},o,{coordinate:e.containerPointToCoordinate(o.containerPoint),vertex:o.target}))}}function w(e,i,s=0){var o=n._geometry.snapTo;o&&m(o)&&(e=n._geometry.snapTo(e)||e);var a,l=f(s),c=e.sub(S()),u=Gg(n._geometry,l[i],c),g=l[i];g.x=u.x,g.y=u.y,t.setCoordinates(t.getCoordinates()),n._updateCoordFromShadow(!0),a=0===i?h[s].length-1:i-1,h[s][i]&&h[s][i].refresh(),h[s][a]&&h[s][a].refresh()}var T=new Re(0,0);function S(){var e=t._getCompiledSymbol();return T.x=e.lineDx||0,T.y=e.lineDy||0,T}function M(t,i=0,a){var l=(a||f(i))[t],h=zg(e,l)._add(S()),c=n.createHandle(h,{symbol:n.options.vertexHandleSymbol,cursor:"pointer",axis:null,onMove:function(){w(c.getContainerPoint(),c[s],i)},onRefresh:function(t,n){if(l=(n||f(i))[c[s]]){var o=zg(e,l);c.setContainerPoint(o._add(S()))}},onUp:function(){n._updateCoordFromShadow()},onDown:function(e,t){}});return c[s]=t,c._ringIndex=i,c.on(n.options.removeVertexOn,A),c.setZIndex(o),c}var C=!1,I=!1;function E(t,i=0,o){var c=o||f(i),m=c[t].add(t+1>=c.length?c[0]:c[t+1]).multi(.5);I&&(m=zg(e,m));var A=n.createHandle(m,{symbol:n.options.newVertexHandleSymbol,cursor:"pointer",axis:null,onDown:function(e,t){if(!t||!t.domEvent||2!==t.domEvent.button){var o=f(i),a=A[s],l=o[a].add(o[a+1]||o[0]).multi(.5);o.splice(a+1,0,l),u(o,i),A.opacity=1,I=!0,h[i].splice(a,0,E.call(n,a,i),E.call(n,a+1,i)),I=!1,C=!0}},onMove:function(){w(A.getContainerPoint(),A[s]+1,i)},onUp:function(e){if(e&&e.domEvent&&2===e.domEvent.button)C=!1;else{var t=A[s];Ue(A,h[i]),A.delete(),l[i].splice(t,0,M.call(n,t,i)),g(),n._updateCoordFromShadow(),C=!1}},onRefresh:function(t,n){c=n||f(t);var i,o=A[s];if(i=o===c.length-1?0:o+1,c[o]&&c[i]){var a=c[o].add(c[i]).multi(.5),l=zg(e,a);A.setContainerPoint(l._add(S()))}}});return A[s]=t,A.setZIndex(a),A}if(t instanceof df)for(var D=t.getHoles().length+1,H=0;H<D;H++){l[H]=[],h[H]=[];for(var N=f(H),B=0,z=N.length;B<z;B++)l[H].push(M.call(this,B,H,N)),B<z-1&&h[H].push(E.call(this,B,H,N));h[H].push(E.call(this,N.length-1,H,N))}else{for(var U=f(0),j=0,W=U.length;j<W;j++)l[0].push(M.call(this,j,0,U)),j<W-1&&h[0].push(E.call(this,j,0,U));h[0].length&&2===t.getCoordinates().length&&(h[0][0].options.symbol.markerDx=12)}var q=e.getRenderer();q&&q.sortTopElements(),this._addRefreshHook((function(){if(!C){for(var e in h)for(var n=f(e),i=h[e].length-1;i>=0;i--)h[e][i].refresh(e,n);for(var s in h[0].length&&t instanceof yf&&(2===t.getCoordinates().length?h[0][0].options.symbol.markerDx=12:t.getCoordinates().length>2&&(h[0][0].options.symbol.markerDx=0)),l)for(var o=f(s),a=l[s].length-1;a>=0;a--)l[s][a].refresh(s,o)}}))},n._refresh=function(){if(this._refreshHooks)for(var e=this._refreshHooks.length-1;e>=0;e--)this._refreshHooks[e].call(this)},n._hideContext=function(){this._geometry&&(this._geometry.closeMenu(),this._geometry.closeInfoWindow())},n._addRefreshHook=function(e){e&&(this._refreshHooks||(this._refreshHooks=[]),this._refreshHooks.push(e))},n._update=function(e,...t){this._exeHistory([e,t]),this._recordHistory(e,...t)},n._updateCoordFromShadow=function(e){var t=(this._shadow||this._geometry).getCoordinates(),n=this._geometry,i=this._updating;this._updating=!0,n.setCoordinates(t),e||this._recordHistory("setCoordinates",fl.toNumberArrays(n.getCoordinates())),this._updating=i},n._recordHistory=function(e,...t){if(this._history||(this._history=[],this._historyPointer=0),this._history.length){var n=this._history[this._history.length-1];if(n[0]===e&&JSON.stringify(n[1])===JSON.stringify(t))return}this._historyPointer<this._history.length-1&&this._history.splice(this._historyPointer+1),this._history.push([e,t]),this._historyPointer=this._history.length-1,this._geometry.fire("editrecord")},n.cancel=function(){return this._history&&0!==this._historyPointer?(this._historyPointer=0,this._exeAndReset(this._history[0]),this):this},n.undo=function(){if(this._isundoEdit())return this;var e=this._history[--this._historyPointer];return this._exeAndReset(e),this},n.redo=function(){if(this._isRedoEdit())return this;var e=this._history[++this._historyPointer];return this._exeAndReset(e),this},n._exeAndReset=function(e){if(!this._updating){this._exeHistory(e);var t=this._history,n=this._historyPointer;this.stop(),this._history=t,this._historyPointer=n,this.start()}},n._onDragStart=function(){this._updating=!0},n._onDragEnd=function(){this._updating=!1},n._exeHistory=function(e){if(Array.isArray(e)){var t=this._updating;this._updating=!0;var n=this._shadow||this._geometry,i=this._geometry;Array.isArray(e[0])?e[0].forEach((function(e){var t=e[0],s=e.slice(1);n[t].call(n,...s),n!==i&&i[t].call(i,...s)})):(n[e[0]].call(n,...e[1]),n!==i&&i[e[0]].call(i,...e[1])),this._updating=t}},n._isRedoEdit=function(){return!this._history||this._historyPointer===this._history.length-1},n._isundoEdit=function(){return!this._history||0===this._historyPointer},t}(Ba(Ua));qg.mergeOptions(Wg),Wf.include({startEditText:function(){return this.getMap()?(this._recordVisible(),this.hide(),this.endEditText(),this._prepareEditor(),this._fireEvent("edittextstart"),this):this},endEditText:function(){if(this._textEditor){var e=this._textEditor.innerHTML;e=e.replace(/<p>/gi,"").replace(/<\/p>/gi,"<br/>"),this._textEditor.innerHTML=e;var t=this._textEditor.innerText.replace(/[\r\n]+$/gi,"");this.setContent(t),Wn(this._textEditor,"mousedown dblclick",Cn),this.getMap().off("mousedown",this.endEditText,this),this._editUIMarker.remove(),delete this._editUIMarker,this._textEditor.onkeyup=null,delete this._textEditor,this._recoveryVisible(),this.show(),this._fireEvent("edittextend")}return this},isEditingText:function(){return!!this._textEditor},getTextEditor:function(){return this._editUIMarker},_prepareEditor:function(){var e=this.getMap(),t=this._createEditor();this._textEditor=t,e.on("mousedown",this.endEditText,this);var n=this._getEditorOffset();this._editUIMarker=new Wd(this.getCoordinates(),{animation:null,content:t,dx:n.dx,dy:n.dy}).addTo(e),this._setCursorToLast(this._textEditor)},_getEditorOffset:function(){var e=this._getInternalSymbol()||{},t=0,n=0,i=e.textHorizontalAlignment;return"middle"===i||h(i)?(t=(e.textDx||0)-2,n=(e.textDy||0)-2):(t=(e.markerDx||0)-2,n=(e.markerDy||0)-2),{dx:t,dy:n}},_createEditor:function(){var e=this.getContent(),t=this.getSize(),n=this._getInternalSymbol()||{},i=t.width,s=n.textFill||"#000000",o=n.textSize||12,a=t.height,l=n.markerLineColor||"#000",h=n.markerFill||"#3398CC",c=n.textLineSpacing||0,u=pn("div");return u.contentEditable=!0,u.style.cssText="background:"+h+"; border:1px solid "+l+";\n            color:"+s+";font-size:"+o+"px;width:"+(i-2)+"px;height:"+(a-2)+"px;margin: auto;\n            line-height:"+(o+c)+"px;outline: 0; padding:0; margin:0;word-wrap: break-word;\n            overflow: hidden;-webkit-user-modify: read-write-plaintext-only;",u.innerText=e,jn(u,"mousedown dblclick",Cn),u.onkeyup=function(e){13===e.keyCode&&(u.style.height=parseInt(u.style.height||0)+o/2+"px")},u},_setCursorToLast:function(e){var t;window.getSelection?(e.focus(),(t=window.getSelection()).selectAllChildren(e),t.collapseToEnd()):document.selection&&((t=document.selection.createRange()).moveToElementText(e),t.collapse(!1),t.select())}}),gu.include({animate:function(e,t,n){var i=this;this._animPlayer&&this._animPlayer.finish(),m(t)&&(n=t),t||(t={});var s,o=this.getMap(),a=this._getProjection(),l=this._prepareAnimationStyles(e),h=t.focus;if(delete this._animationStarted,o){var c=o._getRenderer();t.framer=function(e){c.callInNextFrame(e)}}if(a||!h){var u=sf.animate(l,t,(function(e){if(o&&o.isRemoved())u.finish();else{o&&!i._animationStarted&&h&&o.onMoveStart();var t=e.styles;for(var l in t)if("symbol"!==l&&"translate"!==l&&t.hasOwnProperty(l)){var c="set"+l[0].toUpperCase()+l.slice(1);i[c](t[l])}var f=t.translate;if(f){var g=f;s&&(g=f.sub(s)),s=f,i.translate(g)}var m=t.symbol;if(m){var A=i.getSymbol()||{};i.setSymbol(wi(A,m))}if(o&&h){var w=a.project(i.getCenter());o._setPrjCenter(w);var T=o._parseEventFromCoord(a.unproject(w));"running"!==u.playState?o.onMoveEnd(T):o.onMoving(T)}i._fireAnimateEvent(u.playState),n&&n(e)}}),this);return this._animPlayer=u,this._animPlayer.play()}console.error(cf)},_prepareAnimationStyles:function(e){var t=this._getInternalSymbol(),n={};for(var i in e)if(e.hasOwnProperty(i)){var s=e[i];if("translate"!==i&&"symbol"!==i){var o=this["get"+i[0].toUpperCase()+i.substring(1)]();n[i]=[o,s]}else if("symbol"===i){var a=void 0;if(Array.isArray(e.symbol)){if(!Array.isArray(t))throw new Error("geometry'symbol isn't a composite symbol, while the symbol in styles is.");a=[];for(var l=e.symbol,h=0;h<l.length;h++)if(l[h]){var c={};for(var u in l[h])l[h].hasOwnProperty(u)&&(c[u]=[t[h][u],l[h][u]]);a.push(c)}else a.push(null)}else{if(Array.isArray(t))throw new Error("geometry'symbol is a composite symbol, while the symbol in styles isn't.");for(var f in a={},s)s.hasOwnProperty(f)&&(a[f]=[t[f],s[f]])}n.symbol=a}else"translate"===i&&(n.translate=new fl(s))}return n},_fireAnimateEvent:function(e){"finished"===e?(delete this._animationStarted,this._fireEvent("animateend")):"running"===e&&(this._animationStarted?this._fireEvent("animating"):(this._fireEvent("animatestart"),this._animationStarted=!0))}});var Zg=vt+"_drag_stage",Xg=ye.touch?"touchstart mousedown":"mousedown";function Yg(e,t,n){var i=e._getEditCenter(),s=e.getMap();if(!i||0===i.z)return n||s.containerPointToCoord(t);var o=i.z,a=s.getGLRes(),l=s.coordToPointAtRes(i,a),h=s._pointAtResToContainerPoint(l,a,0),c=s._pointAtResToContainerPoint(l,a,o).sub(h),u=t.sub(c),f=s.containerPointToCoord(u);return f.z=0,!e.getGeometries&&e.isPoint&&(f.z=o),f}var Jg=function(e){function t(t){return e.call(this,t)||this}Te(t,e);var n=t.prototype;return n.addHooks=function(){this.target.on(Xg,this._startDrag,this)},n.removeHooks=function(){this._endDrag(),this.target.off(Xg,this._startDrag,this),delete this.container},n._prepareDragHandler=function(){this._dragHandler=new ul(this.container),this._dragHandler.on("dragging",this._dragging,this).on("mouseup",this._endDrag,this).enable()},n._prepareShadow=function(){var e=this,t=this.target;if("canvas"===t.getLayer().options.renderer&&t.options.dragShadow){this._prepareDragStageLayer(),this._shadow&&this._shadow.remove();var n=this._shadow=t.copy();if(n.getGeometries){var i=n.getGeometries(),s=t.getGeometries();i.forEach((function(t,n){e._updateShadowSymbol(t,s[n])}))}else this._updateShadowSymbol(n,t);n.setId(null),this._prepareShadowConnectors()}},n._updateShadowSymbol=function(e,t){if(e.setSymbol(t._getInternalSymbol()),t.options.dragShadow){var n=bi(e._getInternalSymbol(),.5);e.setSymbol(n)}},n._prepareShadowConnectors=function(){var e=this.target,t=this._shadow,n=this._dragStageLayer._getRenderer().resources,i=[];if(Jf._hasConnectors(e))for(var s=Jf._getConnectors(e),o=0,a=s.length;o<a;o++){var l=s[o],h=l.config(),c=l._getInternalSymbol();h.symbol=bi(c,.5);var u=void 0;u=l.getConnectSource()===e?new l.constructor(t,l.getConnectTarget(),h):new l.constructor(l.getConnectSource(),t,h),i.push(u),l.getLayer()&&l.getLayer()._getRenderer()&&n.merge(l.getLayer()._getRenderer().resources)}this._shadowConnectors=i,i.push(t),this._dragStageLayer.bringToFront().addGeometry(i)},n._onTargetUpdated=function(){this._shadow&&this._shadow.setSymbol(this.target._getSymbol())},n._prepareDragStageLayer=function(){var e=this.target.getMap(),t=this.target.getLayer(),n=e.getLayer(Zg);n&&n.remove(),this._dragStageLayer=new(0,t.constructor)(Zg,{enableAltitude:t.options.enableAltitude,altitudeProperty:t.options.altitudeProperty}),e.addLayer(this._dragStageLayer);var i=Ps();i.merge(t._getRenderer().resources),this._dragStageLayer._getRenderer().resources=i},n._startDrag=function(e){var t=this.target.getMap();if(t&&(!this.target._getParent()&&!this.isDragging())){var n=e.domEvent;if(!(n.touches&&n.touches.length>1||2===n.button)){this.container=t.getPanels().mapWrapper||t.getContainer(),this.target.on("click",this._endDrag,this);var i=this._correctCoord(e.coordinate);this._lastCoord=Yg(this.target,e.containerPoint,i),this._lastPoint=e.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(e.domEvent),jn(this.container,"mouseleave",this._endDrag,this),this._startParam=e,this._moved=!1}}},n._dragging=function(e){var t=this.target,n=t.getMap();if(!n._isEventOutMap(e.domEvent)){var i=n._parseEvent(e.domEvent),s=i.domEvent;if(!(s.touches&&s.touches.length>1||n._isContainerPointOutOfMap(i.containerPoint))){if(!this._moved)return this._moved=!0,t.on("symbolchange",this._onTargetUpdated,this),this._isDragging=!0,this._prepareShadow(),this._shadow&&(t.options.dragShadow||t.hide(),this._shadow._fireEvent("dragstart",i)),this.target._fireEvent("dragstart",this._startParam||i),void delete this._startParam;var o=this._shadow||t,a=o.options.dragOnAxis,l=o.options.dragOnScreenAxis,h=i.containerPoint,c=i.coordinate;this._lastPoint=this._lastPoint||h,this._lastCoord=this._lastCoord||c,l?("x"===a?h.y=this._lastPoint.y:"y"===a&&(h.x=this._lastPoint.x),c=n.containerPointToCoord(h)):c=this._correctCoord(c),c=Yg(t,i.containerPoint,c);var u=h.sub(this._lastPoint),f=c.sub(this._lastCoord);l||("x"===a?u.y=f.y=0:"y"===a&&(u.x=f.x=0)),this._lastPoint=h,this._lastCoord=c;var g=!o.getGeometries&&o.isPoint;g?o.setCoordinates(c):o.translate(f),o===t||t.options.dragShadow||(g?t.setCoordinates(c):t.translate(f)),i.coordOffset=f,i.pointOffset=u,o._fireEvent("dragging",i),o!==t&&t._fireEvent("dragging",i)}}},n._endDrag=function(e){if(this._dragHandler&&(this._dragHandler.disable(),delete this._dragHandler),this.container&&Wn(this.container,"mouseleave",this._endDrag),this.target){var t=this.target;t.off("click",this._endDrag,this),t.off("symbolchange",this._onTargetUpdated,this),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1;var n=t.getMap();if(this.enabled()&&n){var i=n._parseEvent(e?e.domEvent:null);this._updateTargetAndRemoveShadow(i),this._moved&&t._fireEvent("dragend",i)}}},n.isDragging=function(){return!!this._isDragging},n._updateTargetAndRemoveShadow=function(e){if(this._shadow){var t=this.target,n=t.getMap();t.options.dragShadow||t.show();var i=this._shadow;if(i){if(t.options.dragShadow){var s=i.getFirstCoordinate(),o=t.getFirstCoordinate(),a=s.sub(o);t.translate(a)}i._fireEvent("dragend",e),i.remove(),delete this._shadow}this._shadowConnectors&&(n.getLayer(Zg).removeGeometry(this._shadowConnectors),delete this._shadowConnectors),this._dragStageLayer&&(this._dragStageLayer._getRenderer().resources=Ps(),this._dragStageLayer.remove())}},n._correctCoord=function(e){var t=this.target.getMap();if(!t.getPitch())return e;var n=this.target;if(!n.getMinAltitude())return e;var i=(n.getMinAltitude()+n.getMaxAltitude())/2;return t.locateByPoint(e,0,-i)},t}(za);gu.mergeOptions({draggable:!1,dragShadow:!0,dragOnAxis:null,dragOnScreenAxis:!1}),gu.addInitHook("addHandler","draggable",Jg),gu.include({isDragging:function(){return this._getParent()?this._getParent().isDragging():!!this.draggable&&this.draggable.isDragging()}}),gu.include({startEdit:function(e){var t=this.getMap();return t&&this.options.editable?(this._editor&&this.endEdit(),this._recordVisible(),this._editor=new qg(this,e),this._editor.start(),this._getParent()||this.fire("editstart"),t.getRenderer().setToRedraw(),this):this},endEdit:function(){if(this._editor){this._editor.stop(),delete this._editor,this._recoveryVisible(),this._getParent()||this.fire("editend");var e=this.getMap();e&&e.getRenderer().setToRedraw()}return this},redoEdit:function(){return this.isEditing()?(this._editor.redo(),this._getParent()||this.fire("redoedit"),this):this},undoEdit:function(){return this.isEditing()?(this._editor.undo(),this._getParent()||this.fire("undoedit"),this):this},cancelEdit:function(){return this.isEditing()?(this._recoveryVisible(),this._editor.cancel(),this._getParent()||this.fire("canceledit"),this):this},isEditing:function(){return!!this._editor&&this._editor.isEditing()},undoEditcheck:function(){if(this.isEditing())return this._editor._isundoEdit()},redoEditcheck:function(){if(this.isEditing())return this._editor._isRedoEdit()}}),gu.include({_onEvent:function(e,t){var n=this.getMap();if(n){var i=t||this._getEventTypeToFire(e);"contextmenu"===i&&this.listens("contextmenu")&&(Cn(e),Mn(e));var s=n._getEventParams(e);c(this._pickGeometryIndex)&&(s.pickGeometryIndex=this._pickGeometryIndex),this._fireEvent(i,s)}},_getEventTypeToFire:function(e){return e.type}}),gu.include({setInfoWindow:function(e){return this.removeInfoWindow(),e instanceof Qd?(this._infoWindow=e,this._infoWinOptions=l({},this._infoWindow.options),this._infoWindow.addTo(this),this):(this._infoWinOptions=l({},e),this._infoWindow?this._infoWindow._setOptions(e):this.getMap()&&this._bindInfoWindow(),this)},getInfoWindow:function(){return this._infoWindow?this._infoWindow:null},openInfoWindow:function(e){return this.getMap()?(e||(e=this.getCenter()),this._infoWindow?this._infoWindow.show(e):this._infoWinOptions&&this.getMap()&&(this._bindInfoWindow(),this._infoWindow.show(e)),this):this},closeInfoWindow:function(){return this._infoWindow&&this._infoWindow.hide(),this},removeInfoWindow:function(){return this._unbindInfoWindow(),delete this._infoWinOptions,delete this._infoWindow,this},_bindInfoWindow:function(){var e=this._infoWinOptions;return e?(this._infoWindow=new Qd(e),this._infoWindow.addTo(this),this):this},_unbindInfoWindow:function(){return this._infoWindow&&(this.closeInfoWindow(),this._infoWindow.remove(),delete this._infoWindow),this}}),gu.fromJSON=function(e){if(Array.isArray(e)){for(var t=[],n=0,i=e.length;n<i;n++){var s=gu.fromJSON(e[n]);Array.isArray(e)?t=t.concat(s):t.push(s)}return t}return e&&!e.feature?Rf.toGeometry(e):(e.subType?(o=gu.getJSONClass(e.subType).fromJSON(e),h(e.feature.id)||o.setId(e.feature.id)):(o=Rf.toGeometry(e.feature),e.options&&o.config(e.options)),e.symbol&&o.setSymbol(e.symbol),e.infoWindow&&o.setInfoWindow(e.infoWindow),o);var o};var Qg=new Re(0,0),$g=new Re(0,0),Kg=[],em=function(e){function t(){return e.call(this,no)||this}Te(t,e);var n=t.prototype;return n.checkUrl=function(e){return e&&g(e)?mt(e):e},n.fetchImage=function(e,t,n,i){e=this.checkUrl(e),this.send({url:e,fetchOptions:i},Kg,n,t)},t}(Mu),tm=function(e){var t=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.init=function(){var e=this;this.tilesInView={},this.tilesLoading={},this._parentTiles=[],this._childTiles=[],this._tileQueue=[],this._tileQueueIds=new Set;var t=this.layer.getTileSize().width;this.tileCache=new Fo(this.layer.options.maxCacheSize*t/512*t/512,(function(t){e.deleteTile(t)})),ye.decodeImageInWorker&&this.layer.options.decodeImageInWorker&&("gl"===this.layer.options.renderer||!ye.safari&&!ye.iosWeixin)&&(this._tileImageWorkerConn=new em),this._compareTiles=rm.bind(this)},n.getCurrentTileZoom=function(){return this._tileZoom},n.draw=function(e,t){var n=this.getMap();if(!this.isDrawable||this.isDrawable()){var i,s=this.prepareCanvas();if(s)if(((this.layer||{}).parent||{}).isMap&&!s.intersects(this.canvasExtent2D))return void this.completeRender();this._renderTimestamp!==e&&(this._consumeTileQueue(),this._computeAvgTileAltitude(),this._renderTimestamp=e);var o=!1,a=this._frameTiles;if(a&&e===a.timestamp){if(a.empty)return;i=a}else{if(!(i=this._getTilesInCurrentFrame()))return this._frameTiles={empty:!0,timestamp:e},void this.completeRender();o=!0,this._frameTiles=i,this._frameTiles.timestamp=e,i.loadingCount&&this.loadTileQueue(i.tileQueue)}var{tiles:l,childTiles:h,parentTiles:c,placeholders:u,loading:f,loadingCount:g,missedTiles:m,incompleteTiles:A}=i;this._drawTiles(l,c,h,u,t,m,A),g||f||(n.isAnimating()||!this._parentTiles.length&&!this._childTiles.length||(this._parentTiles=[],this._childTiles=[],this.setToRedraw()),this.completeRender()),o&&this.retireTiles()}},n.getTileGridsInCurrentFrame=function(){return this._frameTileGrids},n.getCurrentTimestamp=function(){return this._renderTimestamp||0},n._getTilesInCurrentFrame=function(){var e=this.getMap();this.map=e;var t=this.layer;t._spatialRef=t.getSpatialReference();var n=t._isPyramidMode()&&t.options.terrainTileMode,i=t.getTiles();if(this._frameTileGrids=i,!(i=i.tileGrids)||!i.length)return t._spatialRef=null,this.map=null,null;var s=i.reduce((function(e,t){return e+(t&&t.tiles&&t.tiles.length||0)}),0);s>=this.tileCache.max/2&&this.tileCache.setMaxSize(2*s+1);var o=0,a=!1,l={},h=[],c=[],u={},f=[],g={},m=[],A={},w={},T=this.markTiles(),S=this._getLoadLimit(),M=i.length,C=void 0===this._tileZoom&&t.options.currentTilesFirst&&!this._terrainHelper;this._tileZoom=i[0].zoom;var I=null,E=null;n&&(I=[],E=new Map);for(var D=0;D<M;D++){var H=i[D],N=H.tiles,B=H.parents||Kg,z=B.length,U=C?N:Ge(B,N),j=void 0;U.length&&(j=this._generatePlaceHolder(U[0].res));for(var W=0,q=U.length;W<q;W++){var Z=U[W];t._debugTile(Z,"_getTilesInCurrentFrame");var X=Z.id,Y=!C&&W<z,J=!1,Q=h.length;if(this._isLoadingTile(X))J=a=!0,this.markCurrent(this.tilesLoading[X],!0);else{var $=this.getCachedTile(Z,Y);if($)Y||($.image&&this.isTileFadingIn($.image)&&(J=a=!0,this.setToRedraw()),this.isTileComplete($)?h.push($):(J=!0,n&&E.set(X,$)));else{J=a=!0;var K=S&&o+T[0]>S;if(!this._tileQueueIds.has(Z.id)&&!K&&(!e.isInteracting()||e.isMoving()||e.isRotating()))o++,w[X]=Z}}if(n&&!Y&&(h.length===Q?I.push(Z):l[Z.id]=1),!n&&!Y&&J&&!l[X]){l[X]=1,j&&!A[X]&&(Z.cache=!1,m.push({image:j,info:Z}),A[X]=1);var ee=this._findChildTiles(Z);if(ee.length&&ee.forEach((function(e){g[e.info.id]||(f.push(e),g[e.info.id]=1)})),!ee.length||4!==ee.length){var te=this._findParentTile(Z);if(te){var re=te.info.id;void 0===u[re]&&(u[re]=c.length,c.push(te))}}}}}var se=[];if(n)for(var oe=0;oe<I.length;oe++){var le=I[oe].info?I[oe].info:I[oe];if(le.parent&&!l[le.id]){var{tiles:he,missedTiles:ue}=this._findChildTiles(le);he.length?(ze(h,he),ze(se,ue)):E.has(le.id)?(h.push(E.get(le.id)),E.delete(le.id)):(l[le.id]=1,se.push(le))}}return this.tileCache.shrink(),t._spatialRef=null,this.map=null,{childTiles:f,missedTiles:se,parentTiles:c,tiles:h,incompleteTiles:E&&Array.from(E.values()),placeholders:m,loading:a,loadingCount:o,tileQueue:w}},n.removeTileCache=function(e){delete this.tilesInView[e],this.tileCache.remove(e)},n.isTileCachedOrLoading=function(e){return this.tileCache.get(e)||this.tilesInView[e]||this.tilesLoading[e]},n.isTileCached=function(e){return!(!this.tileCache.get(e)&&!this.tilesInView[e])},n.isTileFadingIn=function(e){return this.getTileFadingOpacity(e)<1},n._drawTiles=function(e,t,n,i,s,o,a){t.length&&(t.sort(this._compareTiles),this._parentTiles=t),n.length&&(this._childTiles=n,this._childTiles.sort(this._compareTiles));var l=this.getMap(),h=l.getRenderer().canvas,c=!0,u=h._frameTileState;u||(u=h._frameTileState={timestamp:0,count:0}),this.layer.constructor!==Up&&this.layer.constructor!==Qp||(this._renderTimestamp===u.timestamp&&u.count>l.options.tileBackgroundLimitPerFrame?c=!1:this._renderTimestamp!==u.timestamp?(u.timestamp=this._renderTimestamp,u.count=1):u.count++);var f={tiles:e,parentTiles:this._parentTiles,childTiles:this._childTiles,parentContext:s};if(this.onDrawTileStart(f,s),c&&1===this.layer.options.opacity){this.layer._silentConfig=!0;var g=this.layer.options.fadeAnimation;this.layer.options.fadeAnimation=!1,this._drawChildTiles(n,s),this._drawParentTiles(this._parentTiles,s),this.layer.options.fadeAnimation=g,this.layer._silentConfig=!1}this.drawingCurrentTiles=!0,e.sort(this._compareTiles);for(var m=0,A=e.length;m<A;m++)this._drawTileAndCache(e[m],s);if(delete this.drawingCurrentTiles,c&&this.layer.options.opacity<1){this.layer._silentConfig=!0;var w=this.layer.options.fadeAnimation;this.layer.options.fadeAnimation=!1,this._drawChildTiles(n,s),this._drawParentTiles(this._parentTiles,s),this.layer.options.fadeAnimation=w,this.layer._silentConfig=!1}this.onDrawTileEnd(f,s)},n._drawChildTiles=function(e,t){var n=this;this.drawingChildTiles=!0,e.forEach((function(e){return n._drawTile(e.info,e.image,t)})),delete this.drawingChildTiles},n._drawParentTiles=function(e,t){var n=this;this.drawingParentTiles=!0,e.forEach((function(e){return n._drawTile(e.info,e.image,t)})),delete this.drawingParentTiles},n.onDrawTileStart=function(e,t){},n.onDrawTileEnd=function(e,t){},n._drawTile=function(e,t,n){t&&this.drawTile(e,t,n)},n.drawTile=function(e,t,n){},n._drawTileAndCache=function(e,t){this.isValidCachedTile(e)&&(this.tilesInView[e.info.id]=e),this._drawTile(e.info,e.image,t)},n.drawOnInteracting=function(e,t,n){this.draw(t,n)},n.checkIfNeedRedraw=function(){return!!this._tileQueue.length},n.hitDetect=function(){return!1},n._getLoadLimit=function(){return(this.map||this.getMap()).isInteracting()?this.layer.options.loadingLimitOnInteracting:this.layer.options.loadingLimit||0},n._isLoadingTile=function(e){return!!this.tilesLoading[e]},n.loadTileQueue=function(e){for(var t in e)if(e.hasOwnProperty(t)){var n=e[t],i=this.loadTile(n);void 0===i.loadTime&&(this.tilesLoading[n.id]={image:i,current:!0,info:n})}},n.loadTile=function(e){var t=this,n={};if(this.loadTileBitmap&&m(this.loadTileBitmap)){this.loadTileBitmap(e.url,e,(function(n){t.onTileLoad(n,e)}),(function(n,i){t.onTileError(i,e,n)}))}else if(this._tileImageWorkerConn&&this.loadTileImage===this.constructor.prototype.loadTileImage)this._fetchImage(n,e);else{var i=this.layer.getTileSize(e.layer);(n=new Image).width=i.width,n.height=i.height,n.onload=this.onTileLoad.bind(this,n,e),n.onerror=this.onTileError.bind(this,n,e),this.loadTileImage(n,e.url,e)}return n},n._fetchImage=function(e,t){var n=this;if(e instanceof Image)e.src=t.url;else{var{x:i,y:s}=t,o=Math.abs(i+s)%this._tileImageWorkerConn.workers.length;this._tileImageWorkerConn.fetchImage(t.url,o,(function(i,s){i?n.onTileError(e,t,i):gt(s,(function(e){n.onTileLoad(e,t)}))}),this.layer.options.fetchOptions||{referrer:document.location.href,headers:{accept:"image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8"}})}},n.loadTileImage=function(e,t,n){var i=this.layer.options.crossOrigin;return h(i)||(e.crossOrigin=i),De(e,[t])},n.abortTileLoading=function(e,t){(t&&void 0!==t.id&&this.removeTileLoading(t),e)&&(e instanceof Image&&(e.onload=nm,e.onerror=nm,e.src=at),this.loadTileBitmap&&m(this.loadTileBitmap)&&this.loadTileBitmap(t.url,t,(function(){}),{command:"abortTile"}))},n.onTileLoad=function(e,t){this.removeTileLoading(t),this._tileQueue.push({tileInfo:t,tileData:e}),this._tileQueueIds.add(t.id),this.setToRedraw()},n.removeTileLoading=function(e){delete this.tilesLoading[e.id],this.setToRedraw()},n._consumeTileQueue=function(){for(var e=0,t=this.layer.options.tileLimitPerFrame,n=this._tileQueue;n.length&&(t<=0||e<t);){var{tileData:i,tileInfo:s}=n.shift();this._tileQueueIds.has(s.id)&&(this._tileQueueIds.delete(s.id),this.checkTileInQueue(i,s)&&(this.consumeTile(i,s),e++))}},n._computeAvgTileAltitude=function(){var e=0,t=0,n=0;for(var i in this.tilesInView){var s=this.tilesInView[i]&&this.tilesInView[i].info;s&&(e+=s.minAltitude||0,t+=s.maxAltitude||0,n++)}this.avgMinAltitude=e/n,this.avgMaxAltitude=t/n},n.checkTileInQueue=function(e,t){return!0},n.consumeTile=function(e,t){if(this.layer&&this.tilesInView){var n={tile:t,tileImage:e};this.resetTileLoadTime(e=n.tileImage),this.removeTileLoading(t),this._addTileToCache(t,e),this.layer.fire("tileload",n),this.setToRedraw()}},n.resetTileLoadTime=function(e){0!==e.loadTime&&(e.loadTime=a())},n.onTileError=function(e,t,n){if(this.layer){var i=this.layer.options.reloadErrorTileFunction;if(i)i.call(this,this.layer,this,t,e);else{var s=this.layer.options.errorUrl,o=!(e instanceof Image);if(s){if(e instanceof Image&&e.src!==s)return e.src=s,void this.removeTileLoading(t);(e=new Image).src=s}this.abortTileLoading(e,t),e.loadTime=0,o&&(e.fetchErrorTime=a()),this.removeTileLoading(t),this._addTileToCache(t,e),this.setToRedraw(),this.layer.fire("tileerror",{tile:t})}}},n.getDebugInfo=function(e){var t=e.split("_"),n=t.length;return t[n-3]+"/"+t[n-2]+"/"+t[n-1]},n.findChildTiles=function(e){return this._findChildTiles(e)},n._findChildTiles=function(e){var t=this._getLayerOfTile(e.layer),n=t._isPyramidMode(),i=t&&t.options.terrainTileMode&&n;if(!t||!t.options.background&&!i||e.z>this.layer.getMaxZoom())return Kg;var s=this.map||this.getMap(),o=[];if(n){if(!i){for(var a=2*e.x,l=2*e.y,h=e.z+1,c=[],u=0;u<2;u++)for(var f=0;f<2;f++)c.push(a+u,l+f,h);for(;c.length;){var g=c.pop(),m=c.pop(),A=c.pop(),w=t._getTileId(A,m,g,e.layer),T=g+1<=e.z+2,S=this.tileCache.getAndRemove(w);if(S){if(this.isValidCachedTile(S))o.push(S),this.tileCache.add(w,S);else if(T)for(var M=0;M<2;M++)for(var C=0;C<2;C++)c.push(2*A+M,2*m+C,g+1)}else if(T)for(var I=0;I<2;I++)for(var E=0;E<2;E++)c.push(2*A+I,2*m+E,g+1)}return o}var D;i&&(D=[]);for(var H=2*e.x,N=2*e.y,B=e.z+1,z=[],U=0;U<2;U++)for(var j=0;j<2;j++){var W=t._getTileId(H+U,N+j,B,e.layer),q=this.tileCache.getAndRemove(W);q&&this.isValidCachedTile(q)?(o.push(q),this.tileCache.add(W,q),z.push(null)):z.push(W)}if(o.length<4)for(var Z=0,X=0;X<2;X++)for(var Y=0;Y<2;Y++){var J=z[Z++];if(J){for(var Q=H+X,$=N+Y,K=B,ee=o.length,te=[],re=0;re<2;re++)for(var se=0;se<2;se++){var oe=t._getTileId(2*Q+re,2*$+se,K+1,e.layer),le=this.tileCache.getAndRemove(oe);le&&this.isValidCachedTile(le)?(o.push(le),this.tileCache.add(oe,le),te.push(null)):te.push(oe)}if(i&&o.length-ee<4){var he=t.tileInfoCache.get(J)||t._createChildNode(e,X,Y,[0,0],J);if(o.length-ee==0)D.push(he);else for(var ue=0,fe=0;fe<2;fe++)for(var de=0;de<2;de++){var pe=te[ue++];if(pe){var me=this.layer.tileInfoCache.get(pe)||t._createChildNode(he,fe,de,[0,0],pe);D.push(me)}}}}}return i?{tiles:o,missedTiles:D}:o}for(var Ae=e.res,ye=e.extent2d.getMin(),_e=e.extent2d.getMax(),ve=t._project(s._pointToPrjAtRes(ye,Ae,Qg),Qg),xe=t._project(s._pointToPrjAtRes(_e,Ae,$g),$g),be=1;be<1;be++)this._findChildTilesAt(o,ve,xe,t,e.z+be);return o},n._findChildTilesAt=function(e,t,n,i,s){var o=i._spatialRef||i.getSpatialReference(),a=i.getId(),l=o.getResolution(s);if(l)for(var h,c,u=i._getTileConfig(),f=u.getTileIndex(t,l),g=u.getTileIndex(n,l),m=Math.min(f.idx,g.idx),A=Math.max(f.idx,g.idx),w=Math.min(f.idy,g.idy),T=Math.max(f.idy,g.idy),S=m;S<A;S++)for(var M=w;M<T;M++)h=i._getTileId(S,M,s,a),(c=this.tileCache.getAndRemove(h))&&this.isValidCachedTile(c)&&(e.push(c),this.tileCache.add(h,c))},n.findParentTile=function(e,t){return this._findParentTile(e,t)},n._findParentTile=function(e,t){var n=this.map||this.getMap(),i=this._getLayerOfTile(e.layer);if(!i||!i.options.background&&!i.options.terrainTileMode)return null;var s=i.getMinZoom(),o=t||e.z-s;if(i._isPyramidMode()){for(var a=e.z-o,l=e.z-1;l>=a;l--){var h=Math.pow(2,e.z-l),c=Math.floor(e.x/h),u=Math.floor(e.y/h),f=void 0;f=l===e.z-1?e.parent:i._getTileId(c,u,l,e.layer);var g=this.tileCache.getAndRemove(f);if(g&&this.isValidCachedTile(g))return this.tileCache.add(f,g),g}return null}for(var m=i.getSpatialReference(),A=m.getZoomDirection(),w=e.res,T=e.extent2d.getCenter(),S=i._project(n._pointToPrjAtRes(T,w)),M=1;M<=o;M++){var C=e.z-A*M,I=m.getResolution(C);if(I){var E=i._getTileConfig().getTileIndex(S,I),D=i._getTileId(E.x,E.y,C,e.layer),H=this.tileCache.getAndRemove(D);if(H)return this.tileCache.add(D,H),H}}return null},n.isValidCachedTile=function(e){return!!e.image},n.isTileComplete=function(e){return!0},n._getLayerOfTile=function(e){return this.layer.getChildLayer?this.layer.getChildLayer(e):this.layer},n.getCachedTile=function(e,t){var n=e.id,i=this.tilesInView,s=this.tileCache.getAndRemove(n);if(s){t||(i[n]=s);var o=this.tilesLoading;if(o&&o[n]){this.markCurrent(o[n],!1);var{image:a,info:l}=o[n];this.abortTileLoading(a,l),delete o[n]}}else s=i[n];return s&&(s.current=!0,this.isValidCachedTile(s)&&this.tileCache.add(n,s)),s},n._addTileToCache=function(e,t){this.isValidCachedTile({info:e,image:t})&&this.tileCache.add(e.id,{image:t,info:e})},n.getTileOpacity=function(e,t){var n=this.getTileFadingOpacity(e);if(this.layer.getChildLayer){var i=this.layer.getLayer(t.layer);i&&(n*=i.options.opacity)}return n},n.getTileFadingOpacity=function(e){return this.layer.options.fadeAnimation&&e.loadTime?Math.min(1,(a()-e.loadTime)/this.layer.options.fadeDuration):1},n.clearTileCaches=function(){this.retireTiles(!0),this.tileCache.reset(),this.tilesInView={},this.tilesLoading={},this._tileQueue=[],this._tileQueueIds.clear(),this._parentTiles=[],this._childTiles=[]},n.removeTileCaches=function(){delete this.tileCache,delete this._tilePlaceHolder,delete this._tileZoom},n.markCurrent=function(e,t){e.current=t},n.markTiles=function(){var e=0,t=0;if(this.tilesLoading)for(var n in this.tilesLoading)this.markCurrent(this.tilesLoading[n],!1),e++;if(this.tilesInView)for(var i in this.tilesInView)this.markCurrent(this.tilesInView[i],!1),t++;return[e,t]},n.retireTiles=function(e){for(var t in this.tilesLoading){var n=this.tilesLoading[t];!e&&n.current||(n.image&&this.abortTileLoading(n.image,n.info),this.deleteTile(n),this.removeTileLoading(n.info))}for(var i in this.tilesInView){var s=this.tilesInView[i];s.current||(delete this.tilesInView[i],this.tileCache.has(i)||this.deleteTile(s))}},n.deleteTile=function(e){if(e&&e.image){var t=e.info.id;this._tileQueueIds.has(t)&&this._tileQueueIds.delete(t),e.image.close&&e.image.close(),e.image instanceof Image&&(e.image.onload=null,e.image.onerror=null);var n=this.layer;n&&n.fire("tiledelete",{tile:e.info,tileImage:e.image})}},n._generatePlaceHolder=function(e){var t=this.map||this.getMap(),n=this.layer.options.placeholder;if(!n||t.getPitch())return null;var i=this.layer.getTileSize(),s=e/t._getResolution(),o=this._tilePlaceHolder=this._tilePlaceHolder||Ea.createCanvas(1,1,t.CanvasClass);return o.width=i.width*s,o.height=i.height*s,m(n)?n(o):function(e){var t=e.getContext("2d"),n=e.width,i=e.height,s=n/16,o=i/16;t.beginPath();for(var a=0;a<16;a++)t.moveTo(0,a*o),t.lineTo(n,a*o),t.moveTo(a*s,0),t.lineTo(a*s,i);t.strokeStyle="rgba(180, 180, 180, 0.1)",t.lineWidth=1,t.stroke(),t.beginPath();for(var l=[[0,0],[n,0],[0,i],[n,i],[0,0],[0,i],[n,0],[n,i],[0,i/2],[n,i/2],[n/2,0],[n/2,i]],h=1;h<l.length;h+=2)t.moveTo(l[h-1][0],l[h-1][1]),t.lineTo(l[h][0],l[h][1]);t.lineWidth=4,t.stroke()}(o),o},n.setTerrainHelper=function(e){this._terrainHelper=e},n._validateTileImage=function(e){if(e)return!e.fetchErrorTime},t}(e);return t};function nm(){return!1}function rm(e,t){return Math.abs(this._tileZoom-e.info.z)-Math.abs(this._tileZoom-t.info.z)}var im=new Re(0,0),sm=new Re(0,0),om=function(e){function t(t){var n;return(n=e.call(this,t)||this).init(),n}Te(t,e);var n=t.prototype;return n._drawTiles=function(e,t,n,i,s,o,a){var l=this;t.length&&(t.sort(this._compareTiles),this._parentTiles=t),n.length&&(this._childTiles=n,this._childTiles.sort(this._compareTiles));var h=!0;this.layer.constructor!==Up&&this.layer.constructor!==Qp||(this._renderTimestamp===this.canvas._parentTileTimestamp?h=!1:this.canvas._parentTileTimestamp=this._renderTimestamp);var c="gl"===this.layer.options.renderer&&(!this.isGL||this.isGL()),u={tiles:e,parentTiles:this._parentTiles,childTiles:this._childTiles,parentContext:s};if(this.onDrawTileStart(u,s),h&&1===this.layer.options.opacity){this.layer._silentConfig=!0;var f=this.layer.options.fadeAnimation;this.layer.options.fadeAnimation=!1,c?(this._drawChildTiles(n,s),this._drawParentTiles(this._parentTiles,s)):(this._drawParentTiles(this._parentTiles,s),this._drawChildTiles(n,s)),this.layer.options.fadeAnimation=f,this.layer._silentConfig=!1}this.drawingCurrentTiles=!0,e.sort(this._compareTiles);for(var g=0,m=e.length;g<m;g++)this._drawTileAndCache(e[g],s);if(delete this.drawingCurrentTiles,h&&this.layer.options.opacity<1){this.layer._silentConfig=!0;var A=this.layer.options.fadeAnimation;this.layer.options.fadeAnimation=!1,c?(this._drawChildTiles(n,s),this._drawParentTiles(this._parentTiles,s)):(this._drawParentTiles(this._parentTiles,s),this._drawChildTiles(n,s)),this.layer.options.fadeAnimation=A,this.layer._silentConfig=!1}i.forEach((function(e){return l._drawTile(e.info,e.image,s)})),this.onDrawTileEnd(u,s)},n.needToRedraw=function(){var t=this.getMap();return!!this.checkIfNeedRedraw()||(t.getPitch()?e.prototype.needToRedraw.call(this):!(!t.isRotating()&&!t.isZooming())||(t.isMoving()?!!this.layer.options.forceRenderOnMoving:e.prototype.needToRedraw.call(this)))},n.isDrawable=function(){return!this.getMap().getPitch()||(console&&console.warn("TileLayer with canvas renderer can't be pitched, use gl renderer ('renderer' : 'gl') instead."),this.clear(),!1)},n.clipCanvas=function(t){return e.prototype.clipCanvas.call(this,t)},n.clear=function(){this.clearTileCaches(),e.prototype.clear.call(this)},n.onRemove=function(){this.clear(),this.removeTileCaches(),e.prototype.onRemove.call(this)},n.drawTile=function(e,t,n){if(this._validateTileImage(t)){var i=this.getMap();if(i){var{extent2d:s,offset:o}=e,a=im.set(s.xmin-o[0],s.ymax-o[1]),l=e.z,h=e.id,c=i.getZoom(),u=this.context,f=i._pointAtResToContainerPoint(a,e.res,0,sm),g=i.getBearing(),m=g||c!==l,A=this.getTileOpacity(t,e),w=u.globalAlpha;A<1&&(u.globalAlpha=A),m||f._round();var T=f.x,S=f.y,M=e.extent2d.xmax-e.extent2d.xmin,C=e.extent2d.ymax-e.extent2d.ymin,I=this.layer,E=I?I.options.bufferPixel:0;if(m){u.save(),u.translate(T,S),g&&u.rotate(-g*Math.PI/180),M+=E,C+=E;var D=i._getResolution();if(D!==e.res){var H=e.res/D;u.scale(H,H)}T=S=0}if(Ea.image(u,t,T,S,M,C),this.layer.options.debug){var N=this.layer.options.debugOutline;u.save(),u.strokeStyle=N,u.fillStyle=N,u.font="20px monospace";var B=new Re(T,S);Ea.rectangle(u,B,{width:M,height:C},1,0),Ea.fillText(u,this.getDebugInfo(h),B._add(32,C-14),N),Ea.drawCross(u,T+M/2,S+C/2,2,N),u.restore()}m&&u.restore(),u.globalAlpha!==w&&(u.globalAlpha=w),this.setCanvasUpdated()}}},t}(tm(gg));Up.registerRenderer("canvas",om);var am=new Re(0,0),lm={properties:{}},hm=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.isDrawable=function(){return!0},n.needToRedraw=function(){var t=this.getMap();return!(!this.isGL()||t.getPitch()||!t.isZooming()||t.isMoving()||t.isRotating())||e.prototype.needToRedraw.call(this)},n.onDrawTileStart=function(e,t){var n=this.gl;if(n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL),n.enable(n.POLYGON_OFFSET_FILL),n.enable(n.STENCIL_TEST),n.stencilOp(n.KEEP,n.KEEP,n.REPLACE),n.depthMask(!!this.layer.options.depthMask),t&&t.renderTarget){var i=t.renderTarget.fbo;if(i){var s=t.renderTarget.getFramebuffer(i);n.bindFramebuffer(n.FRAMEBUFFER,s)}}},n.onDrawTileEnd=function(e,t){var n=this.gl;t&&t.renderTarget&&(t.renderTarget.fbo&&n.bindFramebuffer(n.FRAMEBUFFER,null))},n.drawTile=function(t,n,i){if(this._validateTileImage(n)&&(!i||!i.sceneFilter||i.sceneFilter(lm))){var s=this.getMap();if(t&&s&&n){var o=t._glScale=t._glScale||t.res/s.getGLRes(),a=t.extent2d.xmax-t.extent2d.xmin,l=t.extent2d.ymax-t.extent2d.ymin;if(!1!==t.cache&&this._bindGLBuffer(n,a,l),this.isGL()){var{extent2d:c,offset:u}=t,f=am.set(c.xmin-u[0],t.extent2d.ymax-u[1]),g=f.x*o,m=f.y*o,A=this.layer.options.opacity;A=h(A)?1:A;var w=this.getTileOpacity(n,t)*A,T=null;this.layer.options.debug&&(T=this.getDebugInfo(t.id));var S=this.gl;S.stencilFunc(S.LEQUAL,Math.abs(this.getCurrentTileZoom()-t.z),255);var M=this.layer.getPolygonOffset(),C=this.drawingCurrentTiles?M:M+1;S.polygonOffset(C,C),this.drawGLImage(n,g,m,a,l,o,w,s._getResolution()!==t.res,T),this.getTileFadingOpacity(n)<1?this.setToRedraw():this.setCanvasUpdated()}else e.prototype.drawTile.call(this,t,n)}}},n._bindGLBuffer=function(e,t,n){e.glBuffer||(e.glBuffer=this.bufferTileData(0,0,t,n))},n.loadTileImage=function(e,t){var n=this.layer.options.crossOrigin;e.crossOrigin=null!==n?n:"",e.src=t},n.onCanvasCreate=function(){this.canvas.gl&&this.canvas.gl.wrap||this.createCanvas2()},n.createContext=function(){e.prototype.createContext.call(this),this.createGLContext()},n.resizeCanvas=function(t){this.canvas&&(e.prototype.resizeCanvas.call(this,t),this.resizeGLCanvas())},n.clearCanvas=function(){this.canvas&&(e.prototype.clearCanvas.call(this),this.clearGLCanvas())},n.getCanvasImage=function(){if(!this.isGL()||!this.canvas2)return e.prototype.getCanvasImage.call(this);var t=e.prototype.getCanvasImage.call(this);return t&&(t.image=this.canvas2),t},n.isGL=function(){return!0},n.deleteTile=function(t){e.prototype.deleteTile.call(this,t),t&&t.image&&this.disposeImage(t.image),delete t.image},n.onRemove=function(){e.prototype.onRemove.call(this),this.removeGLCanvas()},t}(fg(om));function cm(e){var t=this,n=this.layer.getTileSize(),i=this.canvas.constructor,s=this.getMap(),o=s.getDevicePixelRatio(),a=Ea.createCanvas(n.width*o,n.height*o,i);a.layer=this.layer;var l=new Re(e.extent2d.xmin,e.extent2d.ymax),h=new Ml(s.pointToCoordinate(l),s.pointToCoordinate(l.add(n.width,n.height)),s.getProjection());return this.layer.drawTile(a,{url:e.url,point:l,center:s.pointToCoordinate(l.add(n.width/2,n.height/2)),extent:h,z:e.z,x:e.x,y:e.y},(function(n){n?t.onTileError(a,e):t.onTileLoad(a,e)})),a}Up.registerRenderer("gl",hm);var um=function(e){function t(){return e.apply(this,arguments)||this}return Te(t,e),t.prototype.loadTile=function(...e){return cm.apply(this,e)},t}(om),fm=function(e){function t(){return e.apply(this,arguments)||this}return Te(t,e),t.prototype.loadTile=function(...e){return cm.apply(this,e)},t}(hm);$p.registerRenderer("canvas",um),$p.registerRenderer("gl",fm);var dm="undefined"!=typeof Int8Array?new Int8Array([-1,1,0,-1,-1,0,1,1,0,1,-1,0]):[],pm=function(){function e(e,t,n){this.gl=e,this.quadVertices=t||dm,this.attributes=["a_position",3,gm(t)],this.debug=n}var t=e.prototype;return t.start=function(){var e=this.gl;e.enable(e.STENCIL_TEST),e.stencilMask(255),e.stencilOp(e.KEEP,e.REPLACE,e.REPLACE),e.depthMask(!1),this._save(),this.buffer||(this._createBuffer(),this._createProgram()),e.useProgram(this.program),e.bindBuffer(e.ARRAY_BUFFER,this.buffer),tg(e,this.program,this.attributes),this.transformLoc||(this.transformLoc=e.getUniformLocation(this.program,"transform")),this.colorLoc||(this.colorLoc=e.getUniformLocation(this.program,"color")),this.debug||e.colorMask(!1,!1,!1,!1)},t.end=function(){var e=this.gl;e.depthMask(!0),this._restore(),this.debug||e.colorMask(!0,!0,!0,!0)},t.draw=function(e){var t=this.gl;t.uniformMatrix4fv(this.transformLoc,!1,e),t.uniform3fv(this.colorLoc,[Math.random(),Math.random(),Math.random()]),t.drawArrays(t.TRIANGLE_STRIP,0,4)},t.remove=function(){var e=this.gl;return this.buffer&&e.deleteBuffer(this.buffer),this.program&&(e.deleteShader(this.program.fragmentShader),e.deleteShader(this.program.vertexShader),e.deleteProgram(this.program)),delete this.transformLoc,delete this.gl,this},t.stencilMask=function(e){return this.gl.stencilMask(e),this},t.stencilFunc=function(e,t,n){return this.ref=t,this.gl.stencilFunc(e,t,n),this},t.stencilOp=function(e,t,n){return this.gl.stencilOp(e,t,n),this},t.resetFunc=function(){return this.ref=1,this.gl.stencilFunc(this.gl.ALWAYS,1,255),this},t._save=function(){this._savedProgram=this.gl.program},t._restore=function(){var e=this.gl;e.program=this._savedProgram,e.program&&e.useProgram(e.program)},t._createBuffer=function(){var e=this.gl;if(this.buffer=e.createBuffer(),!this.buffer)throw new Error("Failed to create the buffer object");e.bindBuffer(e.ARRAY_BUFFER,this.buffer),e.bufferData(e.ARRAY_BUFFER,this.quadVertices,e.STATIC_DRAW)},t._createProgram=function(){var{program:e,vertexShader:t,fragmentShader:n}=eg(this.gl,"\n    attribute vec3 a_position;\n    uniform mat4 transform;\n\n    void main()\n    {\n        gl_Position = transform * vec4(a_position, 1.0);\n    }\n","\n    precision mediump float;\n    uniform vec3 color;\n    void main()\n    {\n        gl_FragColor = vec4(color, 1.0);\n    }\n");e.vertexShader=t,e.fragmentShader=n,this.program=e},e}();function gm(e){return e instanceof Float32Array?"FLOAT":e instanceof Int16Array?"SHORT":e instanceof Uint16Array?"UNSIGNED_SHORT":e instanceof Int8Array?"BYTE":e instanceof Uint8Array||e instanceof Uint8ClampedArray?"UNSIGNED_BYTE":"FLOAT"}var mm=function(e){var t=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.checkResources=function(){var e=this._geosToCheck||[];if(!this._resourceChecked&&this.layer._geoList&&ze(e,this.layer._geoList),!Ye(e))return[];for(var t=[],n={},i=e.length-1;i>=0;i--){var s=e[i]._getExternalResources();if(s.length)if(this.resources)for(var o=0;o<s.length;o++){var a=s[o][0];this.resources.isResourceLoaded(s[o])||n[a]||(t.push(s[o]),n[a]=1)}else t.push(...s)}return this._resourceChecked=!0,delete this._geosToCheck,t},n._addGeoToCheckRes=function(e){e&&(Array.isArray(e)||(e=[e]),this._geosToCheck||(this._geosToCheck=[]),ze(this._geosToCheck,e))},n.onGeometryAdd=function(e){this._addGeoToCheckRes(e),_m(this)},n.onGeometryRemove=function(e){this.layer.fire("removegeo",{type:"removegeo",target:this,geometries:e}),_m(this)},n.onGeometrySymbolChange=function(e){this._addGeoToCheckRes(e.target),_m(this)},n.onGeometryShapeChange=function(e){_m(this)},n.onGeometryPositionChange=function(e){_m(this)},n.onGeometryZIndexChange=function(e){_m(this)},n.onGeometryShow=function(e){_m(this)},n.onGeometryHide=function(e){_m(this)},n.onGeometryPropertiesChange=function(e){_m(this)},t}(e);return t},Am=function(e){function t(){return e.apply(this,arguments)||this}return Te(t,e),t.prototype.render=function(...t){return this.layer._sortGeometries(),e.prototype.render.apply(this,t)},t}(mm(gg)),ym=function(e){function t(){return e.apply(this,arguments)||this}return Te(t,e),t.prototype.render=function(...t){return this.layer._sortGeometries(),e.prototype.render.apply(this,t)},t}(mm(Eu));function _m(e){e instanceof Am&&e.layer.options.drawImmediate&&e.render(),e.setToRedraw()}var vm=new Pl,xm=[],bm=new Pl;function wm(e){if(!e)return null;var t=e.getContext("2d");return t.clearRect(0,0,e.width,e.height),t}function Tm(e){return e&&e.options.progressiveRender&&e.options.progressiveRenderDebug}var Sm=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.setToRedraw=function(){return e.prototype.setToRedraw.call(this),this._resetProgressiveRender(),this},n._geoIsCollision=function(e,t){if(!e)return!1;if(!e.options.collision)return!1;if(e.isPoint&&e.getContainerExtent){e.bbox||(e.bbox=[0,0,0,0]);var n=this.layer.options.collisionBufferSize,i=e.getContainerExtent();if(!i)return!1;if(e.bbox[0]=i.xmin-n,e.bbox[1]=i.ymin-n,e.bbox[2]=i.xmax+n,e.bbox[3]=i.ymax+n,t.collides(e.bbox))return e._collided=!0,!0;t.insertBox(e.bbox)}return!1},n.getImageData=function(){if(!this._lastRenderTime||a()-this._lastRenderTime<32)return null;if(!this.context||!this.context.canvas)return null;if(!this._imageData){var{width:e,height:t}=this.context.canvas;try{var n=this.screenshotRenderResult(0,0,e,t);n&&(this._imageData=n.getImageData(0,0,e,t))}catch(e){console.warn("hit detect failed with tainted canvas, some geometries have external resources in another domain:\n",e)}}return this._imageData},n.clearImageData=function(){this._imageData=null,delete this._imageData,this._lastRenderTime=a()},n.checkResources=function(...t){var n=this,i=e.prototype.checkResources.apply(this,t),s=this.layer.getStyle();return s&&(Array.isArray(s)||(s=[s]),s.forEach((function(e){for(var t=di(e.symbol,!0),s=0,o=t.length;s<o;s++)n.resources.isResourceLoaded(t[s])||i.push(t[s])}))),i},n.needToRedraw=function(){if(this.isProgressiveRender()&&!this.renderEnd)return!0;var t=this.getMap();return!(!t.isInteracting()||!this.layer.options.enableAltitude)||!(t.isZooming()&&!t.isRotating()&&!t.getPitch()&&!this._hasPoint&&this.layer.constructor===Mg)&&e.prototype.needToRedraw.call(this)},n.draw=function(){if(this.getMap()){if(!this.layer.isVisible()||this.layer.isEmpty())return this.clearCanvas(),void this.completeRender();this.prepareCanvas(),this.drawGeos(),this.completeRender()}},n.isBlank=function(){return!!this.context&&(!this.isProgressiveRender()&&!this.context.canvas._drawn)},n.drawOnInteracting=function(){if(this._geosToDraw){this._updateMapStateCache(),this._updateDisplayExtent();var e=this.getMap(),t=this.layer.getCount(),n=this.mapStateCache.resolution;(e.isZooming()&&e.options.seamlessZoom&&void 0!==this._drawnRes&&n>1.5*this._drawnRes&&this._geosToDraw.length<t||e.isMoving()||e.isInteracting())&&(this.prepareToDraw(),this._batchConversionMarkers(this.mapStateCache.glRes),this._onlyHasPoint||this._checkGeos(),this._drawnRes=n),this._sortByDistanceToCamera(e.cameraPosition);var{collision:i,collisionDelay:s}=this.layer.options;if(i){var o=a();this._lastCollisionTime||(this._lastCollisionTime=o),o-this._lastCollisionTime<=s?this._geosToDraw=this._lastGeosToDraw||this._geosToDraw:(this._collidesGeos(),this._lastCollisionTime=o)}for(var l=0,h=this._geosToDraw.length;l<h;l++){var c=this._geosToDraw[l];c._isCheck||c.isVisible()?(c._paint(this._displayExtent),this._geosToDraw[l]._cPoint=void 0,this._geosToDraw[l]._inCurrentView=void 0):(delete c._cPoint,delete c._inCurrentView)}this.clearImageData(),this._lastGeosToDraw=this._geosToDraw,Tm(this.layer)&&console.log("progressiveRender on drawOnInteracting page:",this.page)}},n.show=function(...t){this.layer.forEach((function(e){e._repaint()})),e.prototype.show.apply(this,t)},n.forEachGeo=function(e,t){this.layer.forEach(e,t)},n._checkGeos=function(){for(var e=this._getCurrentNeedRenderGeos(),t=0,n=e.length;t<n;t++)this.checkGeo(e[t]);return this},n.drawGeos=function(){this._drawSnapshot(),this._updateMapStateCache(),this._drawnRes=this.mapStateCache.resolution,this._updateDisplayExtent(),this.prepareToDraw(),this._batchConversionMarkers(this.mapStateCache.glRes),this._onlyHasPoint||this._checkGeos(),this._sortByDistanceToCamera(this.getMap().cameraPosition),this._collidesGeos();for(var e=0,t=this._geosToDraw.length;e<t;e++)this._geosToDraw[e]._paint(),this._geosToDraw[e]._cPoint=void 0,this._geosToDraw[e]._inCurrentView=void 0;this.clearImageData(),this._lastGeosToDraw=this._geosToDraw,Tm(this.layer)&&console.log("progressiveRender drawGeos page:",this.page),this._snapshot(),this._setDrawGeosDrawTime()},n.prepareToDraw=function(){return this.layer._drawTime=a(),this._hasPoint=!1,this._geosToDraw=[],this},n._setDrawGeosDrawTime=function(){for(var e=a(),t=this.layer._drawTime,n=this.getGeoPainterList(),i=0,s=n.length;i<s;i++){var o=n[i];o&&o._setDrawTime&&o._setDrawTime(t)}return Tm(this.layer)&&console.log("_setDrawGeosDrawTime time:",a()-e+"ms"),this},n.checkGeo=function(e){if(e.isPoint&&void 0!==this._onlyHasPoint)(e._inCurrentView||e.hasAltitude())&&(this._hasPoint=!0,e._isCheck=!0,this._geosToDraw.push(e));else if(e._isCheck=!1,e&&e.isVisible()&&e.getMap()&&e.getLayer()&&e.getLayer().isCanvasRender()){var t=e._getPainter(),n=!0;if(e._inCurrentView||!h(e.options.arcDegree)||e.hasAltitude())n=!0;else if(!1===e._inCurrentView)n=!1;else{var i=t.get2DExtent(this.resources,vm);i&&i.intersects(this._displayExtent)||(n=!1)}n&&(t.hasPoint()&&(this._hasPoint=!0),e._isCheck=!0,this._geosToDraw.push(e))}},n._collidesGeos=function(){var e=this._geosToDraw;if(!this.layer.options.collision){for(var t=0,n=e.length;t<n;t++){var i=e[t];i.isPoint&&(i._collided=!1)}return this}var s=this.layer.options.collisionScope,o=this.layer.getCollisionIndex();"layer"===s&&o.clear(),this._geosToDraw=[];for(var a=0,l=e.length;a<l;a++){var h=e[a];h.isPoint&&(h._collided=!1,this._geoIsCollision(h,o))?h._collided=!0:this._geosToDraw.push(e[a])}return this},n.onZoomEnd=function(...t){delete this.canvasExtent2D,e.prototype.onZoomEnd.apply(this,t)},n.onRemove=function(){this.forEachGeo((function(e){e.onHide()})),delete this._geosToDraw,delete this.snapshotCanvas,delete this.pageGeos,delete this.geoPainterList},n.onGeometryPropertiesChange=function(t){t&&this.layer._styleGeometry(t.target),e.prototype.onGeometryPropertiesChange.call(this,t)},n._updateDisplayExtent=function(){var e=this.canvasExtent2D;if(this._maskExtent){if(!this._maskExtent.intersects(e))return void this.completeRender();e=e.intersection(this._maskExtent)}this._displayExtent=e},n.identifyAtPoint=function(e,t={}){var n=this.getGeosForIdentify();return n?this.layer._hitGeos(n,e,t):[]},n._updateMapStateCache=function(){var e=this.getMap(),t=e._pointToContainerPoint(this.middleWest)._add(0,-e.height/2),n=e.getResolution(),i=e.getPitch(),s=e.getBearing(),o=e.getGLScale(),a=e.getGLRes(),l=e.getContainerExtent(),h=e.get2DExtent(),c=e.get2DExtentAtRes(a);return this.mapStateCache={resolution:n,pitch:i,bearing:s,glScale:o,glRes:a,_2DExtent:h,glExtent:c,containerExtent:l,offset:t},this},n._batchConversionMarkers=function(e){if(this._onlyHasPoint=void 0,!this._constructorIsThis())return[];var t=[],n=[],i=[],s={},o=this.layer,a=o.options,l=o.getAltitude?o.getAltitude():0,h=o.isCanvasRender();this._onlyHasPoint=!0;for(var c=0,u=this._getCurrentNeedRenderGeos(),f=0,g=u.length;f<g;f++){var m=u[f];if(m.isPoint){var A=m._painter;A||(A=m._getPainter());var w=A.getRenderPoints("center")[0][0],T=a.enableAltitude?m._getAltitude():l;void 0===s[T]&&(s[T]=A.getAltitude()),t[c]=w,i[c]=s[T],n[c]=m,c++}else this._onlyHasPoint=!1}if(0===c)return[];var S=this.getMap(),M=pt(t,"_pt");M=S._pointsAtResToContainerPoints(t,e,i,M);for(var C=S.getContainerExtent(),{xmax:I,ymax:E,xmin:D,ymin:H}=C,N={},B=0,z=n.length;B<z;B++){var U=n[B];if(U._cPoint=M[B],U._cPoint){var{x:j,y:W}=M[B];if(U._inCurrentView=j>=D&&W>=H&&j<=I&&W<=E||U.hasAltitude(),!U._inCurrentView){var q=U.getSymbolHash(),Z=void 0;Z=q?N[q]=N[q]||U._painter.getFixedExtent():U._painter.getFixedExtent(),bm.set(Z.xmin,Z.ymin,Z.xmax,Z.ymax),bm._add(M[B]),U._inCurrentView=bm.intersects(C)}U._inCurrentView&&(U.isVisible()&&h||(U._inCurrentView=!1),this._onlyHasPoint&&U._inCurrentView&&(this._hasPoint=!0,U._isCheck=!0,this._geosToDraw.push(U)))}else U._inCurrentView=!1}return M},n._sortByDistanceToCamera=function(e){if(this.layer.options.sortByDistanceToCamera&&this._geosToDraw.length){var t=this.getMap(),n=t.distanceToPoint(1e3,0,t.getGLScale()).x/1e3,i="center";this._geosToDraw.sort((function(t,s){if(!t.isPoint||!s.isPoint)return 0;var o=t._painter,a=s._painter;if(!o||!a)return 0;var l=o.getRenderPoints(i)[0][0],h=a.getRenderPoints(i)[0][0],c=o.getAltitude()*n,u=a.getAltitude()*n;Is(xm,l.x,l.y,c);var f=Gs(xm,e);return Is(xm,h.x,h.y,u),Gs(xm,e)-f}))}},n._constructorIsThis=function(){return this.constructor===t},n.isProgressiveRender=function(){var e=this.layer;if(!e)return!1;var{progressiveRender:t,collision:n}=e.options||{};return!n&&t},n.getGeosForIdentify=function(){return this.isProgressiveRender()?this.pageGeos||[]:this._geosToDraw||[]},n.getGeoPainterList=function(){if(!this.isProgressiveRender()){for(var e=[],t=this._geosToDraw||[],n=0,i=t.length;n<i;n++)e.push(t[n]._painter);return e}return this.geoPainterList||[]},n._checkSnapshotCanvas=function(){if(!this.isProgressiveRender())return delete this.snapshotCanvas,null;var e=this.canvas;if(!e)return delete this.snapshotCanvas,null;this.snapshotCanvas||(this.snapshotCanvas=Ea.createCanvas(1,1));var t=this.snapshotCanvas,{width:n,height:i,style:s}=e;return t.width===n&&t.height===i||(t.width=n,t.height=i),t.style.width===s.width&&t.style.height===s.height||(t.style.width=s.width,t.style.height=s.height),t},n._getCurrentNeedRenderGeos=function(){var e=this.layer._geoList||[];if(!this.isProgressiveRender())return e;var t=this.layer,{progressiveRenderCount:n}=t.options,i=this.page;return e.slice((i-1)*n,i*n)},n._resetProgressiveRender=function(){Tm(this.layer)&&console.log("progressiveRender resetProgressiveRender"),this.renderEnd=!1,this.page=1,this.pageGeos=[],this.geoPainterList=[],this.maxTolerance=0,this._clearSnapshotCanvas()},n._clearSnapshotCanvas=function(){var e=this._checkSnapshotCanvas();e&&wm(e)},n._snapshot=function(){for(var e=this.isProgressiveRender(),t=this._geosToDraw||[],n=0,i=t.length;n<i;n++){var s=t[n],o=s._hitTestTolerance()||0;if(this.maxTolerance=Math.max(this.maxTolerance,o),e)this.pageGeos.push(s),this.geoPainterList.push(s._painter)}if(!e)return this;var l=a(),h=this._checkSnapshotCanvas();h&&this.canvas&&wm(h).drawImage(this.canvas,0,0);var c=this.layer,{progressiveRenderCount:u}=c.options,f=Math.ceil((c._geoList||[]).length/u);return this.renderEnd=this.page>=f,this.renderEnd&&this._setDrawGeosDrawTime(),Tm(this.layer)&&console.log("snapshot time:",a()-l+"ms"),this.renderEnd||this.page++,this},n._drawSnapshot=function(){if(!this.isProgressiveRender())return this;var{snapshotCanvas:e,context:t}=this;if(!e||!t)return this;var n=this.getMap();if(!n)return this;var i=this.mapDPR||n.getDevicePixelRatio()||1;return this._canvasContextScale(t,1/i),t.drawImage(e,0,0),this._canvasContextScale(t,i),this},t}(Am);Mg.registerRenderer("canvas",Sm);var Mm=function(e){function t(t){var n;return(n=e.call(this)||this).map=t,n._handlerQueue=[],n._thisDocVisibilitychange=n._onDocVisibilitychange.bind(n),n._thisDocDragStart=n._onDocDragStart.bind(n),n._thisDocDragEnd=n._onDocDragEnd.bind(n),n._thisDocDPRChange=n._onDocDPRChange.bind(n),n}Te(t,e);var n=t.prototype;return n._getAllLayerToRender=function(){return this.map._getLayers()},n.setToRedraw=function(){for(var e=this._getAllLayerToRender(),t=0,n=e.length;t<n;t++){var i=e[t].getRenderer();i&&i.canvas&&i.setToRedraw&&i.setToRedraw()}},n.callInNextFrame=function(e){this._handlerQueue.push(e)},n.executeFrameCallbacks=function(){var e=this._handlerQueue;this._handlerQueue=[];for(var t=0,n=e.length;t<n;t++)e[t]()},n.offsetPlatform=function(e,t){if(!this.map.getPanels().front)return this;if(!t&&0===e.x&&0===e.y)return this;var n=this.map.getPanels(),i=this._frontCount=n.back.layerDOM.childElementCount,s=this._backCount=n.front.layerDOM.childElementCount,o=this._uiCount=n.front.uiDOM.childElementCount;if(i||s||o){var a=this.map.offsetPlatform();a=e?a.add(e)._round():a.round(),s&&kn(n.back,a),(i||o)&&kn(n.front,a)}return this},n.domChanged=function(){var e=this.map.getPanels();return!!e.front&&(void 0===this._frontCount||this._frontCount!==e.back.layerDOM.childElementCount||(void 0===this._backCount||this._backCount!==e.front.layerDOM.childElementCount||(void 0===this._uiCount||this._uiCount!==e.front.uiDOM.childElementCount)))},n.resetContainer=function(){if(this.map&&(this.map._resetMapViewPoint(),this.map.getPanels().front)){var e=new Re(0,0);kn(this.map.getPanels().back,e),kn(this.map.getPanels().front,e)}},n.onZoomEnd=function(){this.resetContainer()},n._onDocVisibilitychange=function(){"visible"===document.visibilityState&&this.setToRedraw()},n._getWrapPanel=function(){if(!this.map)return null;var e=this.map.getPanels();return e&&e.mapWrapper},n._onDocDragStart=function(){var e=this._getWrapPanel();e&&(e.style.overflow="visible")},n._onDocDragEnd=function(){var e=this._getWrapPanel();e&&(e.style.overflow="hidden")},n._onDocDPRChange=function(){var e=this.map;e&&e.options&&!e.options.devicePixelRatio&&e.checkSize&&e.getRenderer&&(e.getRenderer()&&e.checkSize(!0))},n._containerIsOffscreen=function(){var e=this.map.getContainer();return!e||!e.style||"none"===e.style.display||Math.min(e.clientWidth,e.clientHeight)<=0},t}(Ua);function Cm(e,t,n,i){return new(n||(n=Promise))((function(t,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function a(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof n?i:new n((function(e){e(i)}))).then(o,a)}l((i=i.apply(e,[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;var Pm=new ha,Im=function(e){function t(t){var n;return(n=e.call(this,t)||this).ready=!1,n._containerIsCanvas=!!t.getContainer().getContext,n._registerEvents(),n._loopTime=0,n._resizeEventList=[],n._resizeTime=-1/0,n._frameCycleRenderCount=0,n}Te(t,e);var i=t.prototype;return i.load=function(){this.initContainer()},i._updateMapCurrentViewGLInfo=function(){var e=this.map;if(!e)return this;e._currentViewGLInfo=null;var t=e.getContainerExtent();if(!t)return this;var n=100,{xmin:i,ymin:s,xmax:o,ymax:a}=t,l=new Re(i,s),h=new Re(o,s),c=new Re(o+n,a+n),u=new Re(i-n,a+n),f=e._getResolution()/e.getGLRes(),g=[l,h,c,u].map((function(t){return e._containerPointToPoint(t)._multi(f)})),m=g[2],A=g[3];g=g.sort((function(e,t){return t.y-e.y}));var w,T,S,M,[C,I,E,D]=g;C.x<I.x?(w=C,S=I):(w=I,S=C),E.x<D.x?(T=E,M=D):(T=D,M=E);var H=hs();ps(g,H);var[N,B,z,U]=H,j=new Re((N+z)/2,(B+U)/2);e._currentViewGLInfo={lt:w,rt:S,rb:M,lb:T,center:j,RB:m,LB:A}},i.renderFrame=function(e){this._updateMapCurrentViewGLInfo();var t=this.map;if(!t||!t.options.renderable)return!1;if(this._handleResizeEventList(e),t.options.stopRenderOnOffscreen&&this._containerIsOffscreen())return!1;this._updateDomPosition(e),delete this._isViewChanged,t._fireEvent("framestart"),this.updateMapDOM(),t.clearCollisionIndex();var n=this._getAllLayerToRender();return this.drawLayers(n,e)&&this.drawTops(),t._fireEvent("frameend"),this._recordView(),this._mapview=this._getMapView(),delete this._spatialRefChanged,this._fireLayerLoadEvents(n),this.executeFrameCallbacks(),t.uiCollides(),!0},i.getFrameTimestamp=function(){return this._frameTimestamp||0},i.updateMapDOM=function(){var e=this.map;if(!e.isZooming()){var t=e.getViewPointFrameOffset();t?e.offsetPlatform(t):this.domChanged()&&this.offsetPlatform(null,!0)}},i.checkIfNeedToRedrawLayers=function(e){if(this.isSpatialReferenceChanged())return!0;for(var t=0,n=e.length;t<n;t++)if(this._checkLayerRedraw(e[t]))return!0;return!1},i.drawLayers=function(e,t){if(!this.checkIfNeedToRedrawLayers(e)&&!this.map.options.forceRedrawPerFrame)return!1;this.clearCanvas();for(var n=this.map,i=n.isInteracting(),s=e.length,o=0;o<s;o++){var a=e[o];if(a.isVisible()){var l=a.isCanvasRender(),h=a._getRenderer();h&&(l&&this.clearLayerCanvasContext(a),i&&l?this._drawCanvasLayerOnInteracting(a,0,0,t):i&&h.drawOnInteracting?(h.prepareRender&&h.prepareRender(),h.checkAndDraw?h.checkAndDraw(h.drawOnInteracting,this._eventParam,t):h.drawOnInteracting(this._eventParam,t)):h.render(t))}}return n._fireEvent("renderend",{context:this.context}),!0},i._checkLayerRedraw=function(e){if(this.isSpatialReferenceChanged())return!0;var t=this.map,n=e._getRenderer();return!!n&&(e.isCanvasRender()?n.testIfNeedRedraw():!(!n.needToRedraw||!n.needToRedraw())||(t.isInteracting()||this.isViewChanged()))},i._drawCanvasLayerOnInteracting=function(e,t,n,i){var s=e._getRenderer();if(s.mustRenderOnInteracting&&s.mustRenderOnInteracting())s.render(i);else if(s.drawOnInteracting){s.prepareRender();var o=s.prepareCanvas();return s.checkAndDraw?s.checkAndDraw(s.drawOnInteracting,this._eventParam,i):s.drawOnInteracting(this._eventParam,i),o}return null},i._fireLayerLoadEvents=function(e){for(var t=e.length-1;t>=0;t--){var n=e[t],i=n._getRenderer();i&&i.isRenderComplete()&&n.fire("layerload")}},i.updateMapSize=function(e){if(e&&!this._containerIsCanvas){var t=e.width+"px",n=e.height+"px",i=this.map.getPanels();i.mapWrapper.style.width=t,i.mapWrapper.style.height=n,this._updateCanvasSize()}},i.getMainPanel=function(){return this.map?this._containerIsCanvas?this.map.getContainer():this.map.getPanels()?this.map.getPanels().mapWrapper:null:null},i.toDataURL=function(e,t){return this.canvas?this.canvas.toDataURL(e,t):null},i.remove=function(){ye.webgl&&"undefined"!=typeof document&&(Wa.off(qa,this._thisDocDPRChange,this),Wa.off(Za,this._thisDocVisibilitychange,this),Wa.off(Xa,this._thisDocDragStart,this),Wa.off(Ya,this._thisDocDragEnd,this)),this._resizeInterval&&clearInterval(this._resizeInterval),this._resizeObserver&&this._resizeObserver.disconnect(),delete this.canvas,delete this.map,delete this._spatialRefChanged,this._cancelFrameLoop()},i.hitDetect=function(e){var t=this.map;if(t&&t.options.hitDetect&&!t.isInteracting()){var n=t._getLayers(),i="default",s=t.options.hitDetectLimit||0,o=0;e&&e._round&&e._round();for(var a=n.length-1;a>=0;a--){var l=n[a];if(!(!l.options.hitDetect||l.isEmpty&&l.isEmpty())&&l.options.geometryEvents){var h=l._getRenderer();if(h&&h.hitDetect&&(!h.isBlank||!h.isBlank())){if("default"!==l.options.cursor&&h.hitDetect(e)){i=l.options.cursor||"pointer";break}if(o++,s>0&&o>s)break}}}t._trySetCursor(i)}},i.initContainer=function(){var e=this.map.getPanels();function t(t,n,i,s){var o=pn("div",n);return i&&(o.style.cssText=i),e[t]=o,s||Pn(o),o}var n=this.map.getContainer();if(this._containerIsCanvas)this.createCanvas();else{n.innerHTML="";var i="position:absolute;top:0px;left:0px;",s=t("mapWrapper","maptalks-wrapper","position:absolute;overflow:hidden;",!0),o=t("allLayers","maptalks-all-layers",i+"padding:0px;margin:0px;z-index:0;overflow:visible;",!0),a=t("backStatic","maptalks-back-static",i+"z-index:0;",!0),l=t("back","maptalks-back",i+"z-index:1;"),h=t("backLayer","maptalks-back-layer",i),c=t("canvasContainer","maptalks-canvas-layer",i+"border:none;z-index:2;"),u=t("frontStatic","maptalks-front-static",i+"z-index:3;",!0),f=t("front","maptalks-front",i+"z-index:4;",!0),g=t("frontLayer","maptalks-front-layer",i+"z-index:0;"),m=t("ui","maptalks-ui",i+"border:none;z-index:1;",!0),A=t("control","maptalks-control","z-index:1",!0);n.appendChild(s),o.appendChild(a),l.appendChild(h),l.layerDOM=h,o.appendChild(l),o.appendChild(c),f.appendChild(g),f.layerDOM=g,f.uiDOM=m,o.appendChild(u),o.appendChild(f),f.appendChild(m),s.appendChild(o),s.appendChild(A),this.createCanvas(),this.resetContainer();var w=this.map._getContainerDomSize();this.updateMapSize(w)}},i.isViewChanged=function(){if(void 0!==this._isViewChanged)return this._isViewChanged;var e=this._mapview,t=this._getMapView();return this._isViewChanged=!e||!lt(e,t),this._isViewChanged},i._recordView=function(){var e=this.map;!e._onViewChange||e.isInteracting()||e.isAnimating()||lt(e.getView(),e._getCurrentView())||e._onViewChange(e.getView())},i.isSpatialReferenceChanged=function(){return this._spatialRefChanged},i._getMapView=function(){var e=this.map,t=e._getPrjCenter();return{x:t.x,y:t.y,zoom:e.getZoom(),pitch:e.getPitch(),bearing:e.getBearing(),width:e.width,height:e.height}},i._lockFrameRenderEnable=function(){var{maxFPS:e}=this.map.options||{};if(e<=0||o.maxFPS<=e)return!0;var t=Math.ceil(o.maxFPS/e);return this._frameCycleRenderCount>=t},i.onLoad=function(){this._frameLoop(0)},i._frameLoop=function(e){this.map?(this._bindFrameLoop||(this._bindFrameLoop=this._frameLoop.bind(this)),this.ready?(this._frameCycleRenderCount++,this._lockFrameRenderEnable()?(this._frameTimestamp=e=e||0,this._resizeCount=0,this.renderFrame(e),this._frameCycleRenderCount=0):this.map.options.debug&&console.log("skip framing, frameCycleRenderCount:",this._frameCycleRenderCount),this._animationFrame=ke(this._bindFrameLoop)):this._animationFrame=ke(this._bindFrameLoop)):this._cancelFrameLoop()},i._cancelFrameLoop=function(){delete this._bindFrameLoop,this._animationFrame&&Oe(this._animationFrame)},i._updateCanvasSize=function(){if(this.canvas&&!this._containerIsCanvas){var e=this.map,t=e.getSize(),n=this.canvas,i=e.getDevicePixelRatio(),{width:s,height:o,cssWidth:a,cssHeight:l}=yt(t,i);!n.style||n.style.width===a&&n.style.height===l||(n.style.width=a,n.style.height=l),s===n.width&&o===n.height||(n.width=s,n.height=o);var h=this.topLayer;!h||s===h.width&&o===h.height||(h.width=s,h.height=o,h.style.width=a,h.style.height=l)}},i.createCanvas=function(){var e=this;this._containerIsCanvas?this.canvas=this.map.getContainer():(this.canvas=pn("canvas"),this.map.getPanels().canvasContainer.appendChild(this.canvas),this._updateCanvasSize());this.createContext().then((function(){e.ready=!0}))},i.createContext=function(){return Cm(this,0,void 0,Me().mark((function e(){return Me().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))},i.clearLayerCanvasContext=function(e){},i.clearCanvas=function(){},i.createTopCanvas=function(){this.topLayer=pn("canvas"),this.map.getPanels().canvasContainer.insertBefore(this.topLayer,this.canvas),this.topCtx=this.topLayer.getContext("2d")},i.removeTopCanvas=function(){yn(this.topLayer),delete this.topLayer,delete this.topCtx},i._updateDomPosition=function(e){return void 0===this._checkPositionTime&&(this._checkPositionTime=0),Math.abs(e-this._checkPositionTime)>=500&&(En(this.map.getContainer()),this._checkPositionTime=e),this},i._handleResizeEventList=function(e){if(!this._resizeEventList)return this;var t=this._resizeEventList.length;return 0===t||this._resizeTime&&e-this._resizeTime<60||(this.map.setContainerDomRect(this._resizeEventList[t-1].contentRect),this._resizeEventList=[],this._checkSize(),this._resizeCount=this._resizeCount||0,this.renderFrame((this._frameTimestamp||0)+ ++this._resizeCount/100),this._resizeTime=e),this},i._checkSize=function(){this.map&&this.map.checkSize()},i._setCheckSizeInterval=function(e){var t=this;ye.resizeObserver?(this._resizeObserver&&this._resizeObserver.disconnect(),this.map&&(this._resizeObserver=new ResizeObserver((function(e){!t.map||t.map.isRemoved()?t._resizeObserver.disconnect():e.length&&(t._resizeEventList=t._resizeEventList||[],t._resizeEventList.push(e[0]))})),this._resizeObserver.observe(this.map.getContainer()))):(clearInterval(this._resizeInterval),this._checkSizeInterval=e,this._resizeInterval=setInterval((function(){!t.map||t.map.isRemoved()?clearInterval(t._resizeInterval):t._checkSize()}),this._checkSizeInterval))},i._registerEvents=function(){var e=this,t=this.map;t.options.checkSize&&!n&&"undefined"!=typeof window&&this._setCheckSizeInterval(t.options.checkSizeInterval),ye.mobile||t.on("_mousemove",this._onMapMouseMove,this),t.on("_dragrotatestart _dragrotating _dragrotateend _movestart _moving _moveend _zoomstart",(function(t){e._eventParam=t})),t.on("_zooming",(function(n){t.getPitch()||(e._zoomMatrix=n.matrix.container),e._eventParam=n})),t.on("_zoomend",(function(t){e._eventParam=t,delete e._zoomMatrix})),t.on("_spatialreferencechange",(function(){e._spatialRefChanged=!0})),ye.webgl&&"undefined"!=typeof document&&(Wa.on(qa,this._thisDocDPRChange,this),Wa.on(Za,this._thisDocVisibilitychange,this),Wa.on(Xa,this._thisDocDragStart,this),Wa.on(Ya,this._thisDocDragEnd,this))},i._onMapMouseMove=function(e){var t=this,n=this.map;!n.isInteracting()&&n.options.hitDetect&&(this._hitDetectFrame&&Oe(this._hitDetectFrame),this._hitDetectFrame=ke((function(){t.hitDetect(e.containerPoint)})))},i._getCanvasLayers=function(){return this.map._getLayers((function(e){return e.isCanvasRender()}))},i.addTopElement=function(e){this._tops||(this._tops=[]),this._tops.push(e)},i.removeTopElement=function(e){if(this._tops){var t=this._tops.indexOf(e);t>=0&&this._tops.splice(t,1)}},i.getTopElements=function(){return this._tops||[]},i.sortTopElements=function(){this._tops=this._tops.sort((function(e,t){return((t.options||{}).zIndex||0)-((e.options||{}).zIndex||0)}))},i.drawTops=function(){this.getTopElements().length?(this.topCtx||this.createTopCanvas(),this.drawTopElements()):this.topCtx&&this.removeTopCanvas()},i.drawTopElements=function(){var e=this.getTopElements();this.topCtx.clearRect(0,0,this.topLayer.width,this.topLayer.height);var t=Pm;t.clear(),this.map.fire("drawtopstart"),this.map.fire("drawtops");for(var n=!1,i=this.map.getDevicePixelRatio(),s=[],o=0;o<e.length;o++){var a=e[o];if(a.needCollision&&a.needCollision()){var l=a.getRenderBBOX(i);if(l){if(t.collides(l)){var h=a.target&&a.target._geometry;h&&-1===s.indexOf(h)&&(s.push(h),h.fire("handlecollision"));continue}t.insertBox(l)}}a.render(this.topCtx)&&(n=!0)}n&&this.context&&this.context.drawImage&&this.context.drawImage(this.topLayer,0,0),this.map.fire("drawtopsend")},i.isWebGPU=function(){return!1},t}(Mm),km=function(e){function t(){return e.apply(this,arguments)||this}Te(t,e);var n=t.prototype;return n.renderFrame=function(e){this._updateMapCurrentViewGLInfo();var t=this.map;if(!t||!t.options.renderable)return!1;if(this._handleResizeEventList(e),t.options.stopRenderOnOffscreen&&this._containerIsOffscreen())return!0;this._updateDomPosition(e),delete this._isViewChanged,t._fireEvent("framestart"),this.updateMapDOM(),t.clearCollisionIndex();var n=this._getAllLayerToRender();return this.drawLayers(n,e),this.drawLayerCanvas(n)&&(this.drawTops(),this._drawCenterCross(),t.options.debugSky&&this._debugSky()),this._needClear=!1,t._fireEvent("frameend"),this._recordView(),this._mapview=this._getMapView(),delete this._spatialRefChanged,this._fireLayerLoadEvents(),this.executeFrameCallbacks(),this._canvasUpdated=!1,t.uiCollides(),!0},n._needRedrawAllLayers=function(e){var t=this;if(this.isSpatialReferenceChanged())return!0;var n=[];e.forEach((function(e){if(e&&(e._toRedraw=t._checkLayerRedraw(e))){n.push(e);var i=e.getLayers&&e.getLayers();i&&Array.isArray(i)&&ze(n,i)}}));for(var i=0,s=n.length;i<s;i++){var o=n[i],a=o&&o.options;if(a&&a.collision&&"map"===a.collisionScope)return!0}return!1},n.drawLayers=function(e,t){for(var n=this._needRedrawAllLayers(e),i=this.map,s=i.isInteracting(),o=[],a=[],l=i.options.fpsOnInteracting||0,h=0===l?0:1e3/l,c=this.map.options.layerCanvasLimitOnInteracting,u=e.length,f=i.getBaseLayer(),g=0,m=0;m<u;m++){var A=e[m];if(A.isVisible()){var w=A.isCanvasRender();w&&o.push(A.getId());var T=A._getRenderer();if(T){var S=n||A._toRedraw;w&&T.isCanvasUpdated()&&(S||a.push(A.getId()),this.setLayerCanvasUpdated());var M=T.__zoomTransformMatrix;if(delete T.__zoomTransformMatrix,S){if(s&&w){if(c>0&&u-1-m>c&&A!==f){A._getRenderer().clearCanvas();continue}g+=this._drawCanvasLayerOnInteracting(A,g,h,t)}else s&&T.drawOnInteracting?(T.prepareRender&&T.prepareRender(),T.checkAndDraw?T.checkAndDraw(T.drawOnInteracting,this._eventParam,t):T.drawOnInteracting(this._eventParam,t)):(T.render(t),w&&M&&T.isLoadingResource()&&(T.__zoomTransformMatrix=M));w&&(a.push(A.getId()),this.setLayerCanvasUpdated())}else w&&s&&(i.isZooming()&&!i.getPitch()?(T.prepareRender(),T.__zoomTransformMatrix=this._zoomMatrix):(i.getPitch()||i.isRotating())&&T.clearCanvas())}}}var C=this._canvasIds||[],I=this._updatedIds||[];if(this._canvasIds=o,this._updatedIds=a,!this.isLayerCanvasUpdated()){var E="---";C.join(E)===o.join(E)&&I.join(E)===a.join(E)||this.setLayerCanvasUpdated()}return!0},n._drawCanvasLayerOnInteracting=function(e,t,n,i){var s=this.map,o=e._getRenderer(),a=o.getDrawTime(),l=0===n||n>0&&t+a<=n;if(o.mustRenderOnInteracting&&o.mustRenderOnInteracting())o.render(i);else{if(o.drawOnInteracting&&(e===s.getBaseLayer()||l||s.isZooming()&&e.options.forceRenderOnZooming||s.isMoving()&&e.options.forceRenderOnMoving||s.isRotating()&&e.options.forceRenderOnRotating))return o.prepareRender(),o.prepareCanvas(),o.checkAndDraw?o.checkAndDraw(o.drawOnInteracting,this._eventParam,i):o.drawOnInteracting(this._eventParam,i),a;!s.isZooming()||s.getPitch()||s.isRotating()?(s.getPitch()||s.isRotating())&&o.clearCanvas():(o.prepareRender(),o.__zoomTransformMatrix=this._zoomMatrix)}return o.drawOnInteracting&&!l&&o.onSkipDrawOnInteracting(this._eventParam,i),0},n._fireLayerLoadEvents=function(){if(this._updatedIds&&this._updatedIds.length>0){var e=this.map;this._updatedIds.reverse().forEach((function(t){var n=e.getLayer(t);if(n){var i=n._getRenderer();i&&i.isRenderComplete()&&n.fire("layerload")}}))}},n.isLayerCanvasUpdated=function(){return this._canvasUpdated},n.setLayerCanvasUpdated=function(){this._canvasUpdated=!0},n.drawLayerCanvas=function(e){var t=this.map;if(!t)return!1;if(!this.isLayerCanvasUpdated()&&!this.isViewChanged()&&!1===this._needClear)return!1;this.canvas||this.createCanvas(),t._fireEvent("renderstart",{context:this.context}),this._updateCanvasSize()||this.clearCanvas();for(var n,i=t.isInteracting(),s=t.options.layerCanvasLimitOnInteracting,o=e.length,a=[],l=0;l<o;l++){if(e[l].isVisible()&&e[l].isCanvasRender())if(e[l]._getRenderer()){var h=this._getLayerImage(e[l]);h&&h.image&&(e[l]===t.getBaseLayer()?n=[e[l],h]:a.push([e[l],h]))}}var c=this.canvas.width,u=this.canvas.height;n&&(this._drawLayerCanvasImage(n[0],n[1],c,u),this._drawFog()),o=a.length;for(var f=i&&s>=0&&o>s?o-s:0;f<o;f++)this._drawLayerCanvasImage(a[f][0],a[f][1],c,u);return t._fireEvent("renderend",{context:this.context}),!0},n.setToRedraw=function(){var e=this._getAllLayerToRender();this._needClear=!0;for(var t=0,n=e.length;t<n;t++){var i=e[t].getRenderer();i&&i.canvas&&i.setToRedraw&&i.setToRedraw()}},n.remove=function(){delete this.context,e.prototype.remove.call(this)},n.hitDetect=function(e){var t=this.map;if(t&&t.options.hitDetect&&!t.isInteracting()){var n=t._getLayers(),i="default",s=t.options.hitDetectLimit||0,o=0;e&&e._round&&e._round();for(var a=n.length-1;a>=0;a--){var l=n[a];if(!(!l.options.hitDetect||l.isEmpty&&l.isEmpty())&&l.options.geometryEvents){var h=l._getRenderer();if(h&&h.hitDetect&&(!h.isBlank||!h.isBlank())){if("default"!==l.options.cursor&&h.hitDetect(e)){i=l.options.cursor||"pointer";break}if(o++,s>0&&o>s)break}}}t._trySetCursor(i)}},n._getLayerImage=function(e){var t=e._getRenderer();return t.getCanvasImage?t.getCanvasImage():null},n._drawLayerCanvasImage=function(e,t,n,i){var s=this.context,o=t.point.round(),a=this.map.getDevicePixelRatio();1!==a&&o._multi(a);var l=t.image,h=l.width,u=l.height;if(!(o.x+h<=0||o.y+u<=0)){var f=e.options.opacity;if(c(f)||(f=1),!(f<=0)){var g=t.opacity;if(c(g)||(g=1),!(g<=0)){var m=s.globalAlpha;"canvas"===e.options.renderer&&(f<1&&(s.globalAlpha*=f),g<1&&(s.globalAlpha*=g)),e.options.cssFilter&&(s.filter=e.options.cssFilter);var A=e.getRenderer(),w=A.__zoomTransformMatrix,T=A.clipCanvas(this.context);w&&(s.save(),s.setTransform(...w)),s.drawImage(l,0,0,h,u,o.x,o.y,n,i),w&&s.restore(),T&&s.restore(),"none"!==s.filter&&(s.filter="none"),s.globalAlpha=m}}}},n._drawCenterCross=function(){var e=this.map.options.centerCross;if(e){var t=this.context,n=new Re(this.canvas.width/2,this.canvas.height/2);m(e)?e(t,n):Ea.drawCross(this.context,n.x,n.y,2,"#f00")}},n._drawContainerExtent=function(){var{cascadePitches:e}=this.map.options,t=this.map.height-this.map._getVisualHeight(e[0]),n=this.map.height-this.map._getVisualHeight(e[1]),i=this.map.getContainerExtent(),s=this.context;s.beginPath(),s.moveTo(0,i.ymin),s.lineTo(i.xmax,i.ymin),s.stroke(),s.beginPath(),s.moveTo(0,t),s.lineTo(i.xmax,t),s.stroke(),s.beginPath(),s.moveTo(0,n),s.lineTo(i.xmax,n),s.stroke()},n._drawFog=function(){var e=this.map;if(!(e.getPitch()<=e.options.maxVisualPitch)&&e.options.fog){var t=e.getDevicePixelRatio(),n=this.context,i=e.getContainerExtent(),s=(e.height-e._getVisualHeight(75))*t;s<0&&(s=0);var o=i.ymin*t,a=Math.ceil(o-s),l=e.options.fogColor.join(),h=n.createLinearGradient(0,s,0,o+30),c=1-30/(a+30);h.addColorStop(0,"rgba("+l+", 0)"),h.addColorStop(.3,"rgba("+l+", 0.3)"),h.addColorStop(c,"rgba("+l+", 1)"),h.addColorStop(1,"rgba("+l+", 0)"),n.beginPath(),n.fillStyle=h,n.fillRect(0,s,Math.ceil(i.getWidth())*t,Math.ceil(a+30))}},n._debugSky=function(){var e=this.map;if(!e)return this;var t=e.getContainerExtent().ymin;if(t<=0)return this;var n=this.context;return n.strokeStyle="red",n.strokeRect(0,0,e.width,t),this},n.clearCanvas=function(){this.canvas&&Ea.clearRect(this.context,0,0,this.canvas.width,this.canvas.height)},n._updateCanvasSize=function(){if(!this.canvas||this._containerIsCanvas)return!1;var e=this.map,t=e.getSize(),n=this.canvas,i=e.getDevicePixelRatio(),{width:s,height:o,cssWidth:a,cssHeight:l}=yt(t,i);return!n.style||n.style.width===a&&n.style.height===l||(n.style.width=a,n.style.height=l),(s!==n.width||o!==n.height)&&(n.height=o,n.width=s,this.topLayer.width=n.width,this.topLayer.height=n.height,!0)},n.createCanvas=function(){this.topLayer=pn("canvas"),this.topCtx=this.topLayer.getContext("2d"),this._containerIsCanvas?this.canvas=this.map.getContainer():(this.canvas=pn("canvas"),this._updateCanvasSize(),this.map.getPanels().canvasContainer.appendChild(this.canvas)),this.context=this.canvas.getContext("2d"),this.ready=!0},n.drawTops=function(){e.prototype.drawTopElements.call(this)},t}(Im);zu.registerRenderer("canvas",km),zu.mergeOptions({fog:!1,fogColor:[233,233,233]});var Om=Object.freeze({__proto__:null,CanvasLayerRenderer:Cg,CanvasRenderer:gg,CanvasTileLayerCanvasRenderer:um,CanvasTileLayerGLRenderer:fm,ImageGLRenderable:fg,ImageLayerCanvasRenderer:bg,ImageLayerGLRenderer:wg,ImageLayerRenderable:xg,LayerAbstractRenderer:Eu,MapAbstractRenderer:Im,MapCanvasRenderer:km,MapRenderer:Mm,OverlayLayerCanvasRenderer:Am,OverlayLayerGLRenderer:ym,QuadStencil:pm,Renderable:wh,ResourceCache:Cs,TileLayerCanvasRenderer:om,TileLayerGLRenderer:hm,TileLayerRendererable:tm,VectorLayerCanvasRenderer:Sm}),Em={_getRenderPoints:function(){return[[this._getCenter2DPoint(this.getMap().getGLRes())],null]}};mf.include(Em),Ff.include(Em),Lf.include(Em),Nf.include(Em),Hf.include({_getRenderPoints:function(e){var t=this.getMap(),n=t.getGLRes();if("vertex"===e){for(var i=this._trimRing(this.getShell()),s=[],o=0,a=i.length;o<a;o++)s.push(t.coordToPointAtRes(i[o],n));return[s,null]}return[[t.coordToPointAtRes(this.getCenter(),n)],null]}});var Rm={_getRenderPoints:function(e){var t,n=this.getMap(),i=n.getGLRes(),s=null;if("point"===e)(t=this._getPath2DPoints(this._getPrjCoordinates(),!1,i))&&t.length>0&&Array.isArray(t[0])&&(t=t[0].concat(t[1]));else if("vertex"===e)if(s=[],(t=this._getPath2DPoints(this._getPrjCoordinates(),!1,i))&&t.length>0&&Array.isArray(t[0])){for(var o=0,a=t.length;o<a;o++)for(var l=0,h=t[o].length;l<h;l++)s.push(0===l?[t[o][l],t[o][l+1]]:[t[o][l-1],t[o][l]]);t=t[0].concat(t[1])}else for(var c=0,u=t.length;c<u;c++)s.push(0===c?[t[c],t[c+1]]:[t[c-1],t[c]]);else if("line"===e){t=[],s=[];var f=this._getPath2DPoints(this._getPrjCoordinates(),!1,i);if(f.length>0&&Array.isArray(f[0]))for(var g,m=1,A=f.length;m<A;m++){g=f[m],this instanceof df&&g.length>0&&!g[0].equals(g[g.length-1])&&g.push(g[0]);for(var w=1,T=g.length;w<T;w++)t.push(g[w].add(g[w-1])._multi(.5)),s.push([g[w-1],g[w]])}else{this instanceof df&&f.length>0&&!f[0].equals(f[f.length-1])&&f.push(f[0]);for(var S=1,M=f.length;S<M;S++)t.push(f[S].add(f[S-1])._multi(.5)),s.push([f[S-1],f[S]])}}else if("vertex-first"===e){var C=this._getPrjCoordinates(),I=C.length,E=I?n._prjToPointAtRes(C[0],i):null;t=I?[E]:[],s=I?[[E,C[1]?n._prjToPointAtRes(C[1],i):E]]:[]}else if("vertex-last"===e){var D=this._getPrjCoordinates(),H=D.length,N=H?n._prjToPointAtRes(D[H-1],i):null;t=H?[N]:[];var B=H>1?H-2:H-1;s=H?[[D[B]?n._prjToPointAtRes(D[B],i):N,N]]:[]}else if("vertex-firstlast"===e){t=[],s=[];var z=this._getPrjCoordinates(),U=z.length;if(U){var j=n._prjToPointAtRes(z[0],i);if(t=[j],U>1){s=[[j,n._prjToPointAtRes(z[1],i)]];var W=n._prjToPointAtRes(z[U-1],i);t.push(W),s.push([n._prjToPointAtRes(z[U>1?U-2:U-1],i),W])}}}else{var q=this.getCenter();if(q){var Z=this._getProjection().project(q);t=[n._prjToPointAtRes(Z,i)]}else t=[]}return[t,s]}};yf.include(Rm),df.include(Rm);var Lm={within:!1,center:[0,0]};function Dm(e){if(e&&e._containerBbox){Lm.within=!1;var{minx:t,miny:n,maxx:i,maxy:s}=e._containerBbox,o=Math.abs(i-t),a=Math.abs(s-n);o<=1&&a<=1&&(Lm.within=!0,Lm.center[0]=(t+i)/2,Lm.center[1]=(n+s)/2),delete e._containerBbox}else Lm.within=!1;return Lm}function Fm(){var e=this._getPrjShell(),t=hs();ps(e,t);var[n,i,s,o]=t;return new Ml(n,i,s,o)}function Hm(){var e=this._getPrjShell();if(!e||!Array.isArray(e))return[];var t=this._getProjection(),n=this.getCoordinates()||{};return e.map((function(e){var i=t.unproject(e);return i.z=n.z||0,i}))}gu.include({_redrawWhenPitch:function(){return!1},_redrawWhenRotate:function(){return!1},_getRenderBBOX:function(e,t){return e.isHitTesting?null:(ds(fs),ps(t,fs),fs)}});var Nm={_redrawWhenPitch:function(){return!0},_redrawWhenRotate:function(){return this instanceof Ff||this instanceof Nf},_computeRotatedPrjExtent:Fm,getRotatedShell:Hm,_paintAsPath:function(){if(this.isRotated())return!0;var e=this.getMap();return this._getAltitude()>0||e.getPitch()||this instanceof Ff&&e.getBearing()},_getPaintParams:function(){var e=this.getMap();if(this._paintAsPath())return df.prototype._getPaintParams.call(this,!0);var t=this._getPrjCoordinates(),n=e._prjToPointAtRes(t,e.getGLRes());return[n,...this._getRenderSize(n)]},_paintOn:function(...e){return this._paintAsPath()?Ea.polygon(...e):Ea.ellipse(...e)},_getRenderSize:function(e){var t=this.getMap(),n=t.getGLRes(),i=this._getPrjExtent(),s=t._prjToPointAtRes(i.getMin(),n),o=t._prjToPointAtRes(i.getMax(),n);return[Math.abs(o.x-s.x)/2,Math.abs(o.y-e.y),Math.abs(e.y-s.y)]}};Ff.include(Nm),Lf.include(Nm),Hf.include({_getPaintParams:function(){var e=this.getMap(),t=this._getPrjShell();return[this._getPath2DPoints(t,!1,e.getGLRes())]},_paintOn:Ea.polygon,_computeRotatedPrjExtent:Fm,getRotatedShell:Hm});var Bm={_redrawWhenPitch:function(){return!0},_getPaintParams:function(){if(this._paintAsPath())return df.prototype._getPaintParams.call(this,!0);var e=this.getMap(),t=e._prjToPointAtRes(this._getPrjCoordinates(),e.getGLRes()),n=this._getRenderSize(t),[i,s]=this._correctAngles();return[t,n[0],[i,s]]},_paintOn:function(...e){if(this._paintAsPath())return Ea.polygon(...e);var t=this.getMap().getBearing();return t&&(e[3]=e[3].slice(0),e[3][0]+=t,e[3][1]+=t),Ea.sector(...e)}};Nf.include(Nm,Bm),uf.include({_paintAsPath:function(){return!0}});var zm={arrowStyles:{classic:[3,4]},_getArrowShape:function(e,t,n,i,s){if(!e||!t||e.equals(t))return null;s||(s=0);var o,a=n*i[1]+s,l=n*i[0]/2+s;(o=t.sub(t.nextCtrlPoint||t.prevCtrlPoint?new Re(t.prevCtrlPoint?t.prevCtrlPoint:t.nextCtrlPoint):e))._unit();var h=t.sub(o.multi(a));o._perp();var c=h.add(o.multi(l));return o._multi(-1),[c,t,h.add(o.multi(l)),c]},_getPaintParams:function(){var e=this._getPrjCoordinates();return[this._getPath2DPoints(e,!1,this.getMap().getGLRes())]},_paintOn:function(e,t,n,i,s,o){var a=Dm(this._painter);return a.within?Ea.pixelRect(e,a.center,n,i):this.options.smoothness?Ea.paintSmoothLine(e,t,n,this.options.smoothness,!1,this._animIdx,this._animTailRatio):(e.lineColorIn=o,Ea.path(e,t,n,null,s)),this._paintArrow(e,t,n),this._getRenderBBOX(e,t)},_getArrowPlacement:function(){return this.options.arrowPlacement},_getArrowStyle:function(){var e=this.options.arrowStyle;return e?Array.isArray(e)?e:this.arrowStyles[e]:null},_getArrows:function(e,t,n){var i=this,s=this._getArrowStyle();if(!s||e.length<2)return[];for(var o,a,l=e.length>0&&Array.isArray(e[0])?e:[e],h=this._getArrowPlacement(),c=[],u=function(){if(o&&a){var e=i._getArrowShape(o,a,t,s,n);e&&c.push(e)}},f=l.length-1;f>=0;f--){var g=l[f],m=g.length,A=g[0],w=g[m-1];"vertex-first"===h?(o=A.arrowNextPoint||g[1],a=A):"vertex-last"===h&&(o=w.arrowPrePoint||g[m-2],a=w),u(),"vertex-firstlast"===h&&(o=A.arrowNextPoint||g[1],a=A,u(),o=w.arrowPrePoint||g[m-2],a=w,u()),"point"===h&&this._getArrowPoints(c,g,t,s,n)}return c},_getArrowPoints:function(e,t,n,i,s){for(var o=0,a=t.length-1;o<a;o++){var l=t[o+1],h=this._getArrowShape(l.arrowPrePoint||t[o],l,n,i,s);h&&e.push(h)}},_paintArrow:function(e,t,n){var i=this._getInternalSymbol().lineWidth;(!c(i)||i<3)&&(i=3);var s=this._getArrows(t,i);if(s.length){e.setLineDash&&e.setLineDash([]);for(var o=s.length-1;o>=0;o--)e.fillStyle=e.strokeStyle,Ea.polygon(e,s[o],n,n)}}};yf.include(zm);var Gm={_getPaintParams:function(e){var t=this.getMap().getGLRes(),n=this._getPrjShell(),i=this._getPath2DPoints(n,e,t),s=i.length>0&&Array.isArray(i[0]);s&&(i=[[i[0]],[i[1]]]);var o=this._getPrjHoles(),a=[];if(o&&o.length>0){for(var l=this._simplified,h=0;h<o.length;h++){var c=this._getPath2DPoints(o[h],e,t);Array.isArray(c)&&s?Array.isArray(c[0])?(i[0].push(c[0]),i[1].push(c[1])):i[0].push(c):a.push(c)}l&&(this._simplified=l)}return s||ze(i=[i],a),[i]},_paintOn:function(e,t,n,i,s,o){var a=Dm(this._painter);return a.within?Ea.pixelRect(e,a.center,n,i):(e.lineColorIn=o,Ea.polygon(e,t,n,i,s,this.options.smoothness)),this._getRenderBBOX(e,t)}};df.include(Gm),zu.VERSION=t;var Um={Actor:Mu};s(t);"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function Vm(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var jm={exports:{}};!function(e,t){e.exports=function(){function e(e,t){this.id=me++,this.type=e,this.data=t}function t(e){if(0===e.length)return[];var n=e.charAt(0),i=e.charAt(e.length-1);if(1<e.length&&n===i&&('"'===n||"'"===n))return['"'+e.substr(1,e.length-2).replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'];if(n=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(e))return t(e.substr(0,n.index)).concat(t(n[1])).concat(t(e.substr(n.index+n[0].length)));if(1===(n=e.split(".")).length)return['"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'];for(e=[],i=0;i<n.length;++i)e=e.concat(t(n[i]));return e}function n(e){return"["+t(e).join("][")+"]"}function i(t,n){return"function"==typeof t?new e(0,t):"number"==typeof t||"boolean"==typeof t?new e(5,t):Array.isArray(t)?new e(6,t.map((function(e,t){return i(e)}))):t instanceof e?t:void 0}function s(){var e={"":0},t=[""];return{id:function(n){var i=e[n];return i||(i=e[n]=t.length,t.push(n),i)},str:function(e){return t[e]}}}function o(e,t,n){function i(){var t=window.innerWidth,i=window.innerHeight;e!==document.body&&(t=(i=e.getBoundingClientRect()).right-i.left,i=i.bottom-i.top),o.width=n*t,o.height=n*i,pe(o.style,{width:t+"px",height:i+"px"})}var s,o=document.createElement("canvas");return pe(o.style,{border:0,margin:0,padding:0,top:0,left:0}),e.appendChild(o),e===document.body&&(o.style.position="absolute",pe(e.style,{margin:0,padding:0})),e!==document.body&&"function"==typeof ResizeObserver?(s=new ResizeObserver((function(){setTimeout(i)}))).observe(e):window.addEventListener("resize",i,!1),i(),{canvas:o,onDestroy:function(){s?s.disconnect():window.removeEventListener("resize",i),e.removeChild(o)}}}function a(e,t){function n(n){try{return e.getContext(n,t)}catch(e){return null}}return n("webgl")||n("experimental-webgl")||n("webgl-experimental")}function l(e){return"string"==typeof e?e.split():e}function h(e){return"string"==typeof e?document.querySelector(e):e}function c(e){var t,n,i,s,c=e||{};e={};var u=[],f=[],g="undefined"==typeof window?1:window.devicePixelRatio,m=!1,A=function(e){},w=function(){};if("string"==typeof c?t=document.querySelector(c):"object"==typeof c&&("string"==typeof c.nodeName&&"function"==typeof c.appendChild&&"function"==typeof c.getBoundingClientRect?t=c:"function"==typeof c.drawArrays||"function"==typeof c.drawElements?i=(s=c).canvas:("gl"in c?s=c.gl:"canvas"in c?i=h(c.canvas):"container"in c&&(n=h(c.container)),"attributes"in c&&(e=c.attributes),"extensions"in c&&(u=l(c.extensions)),"optionalExtensions"in c&&(f=l(c.optionalExtensions)),"onDone"in c&&(A=c.onDone),"profile"in c&&(m=!!c.profile),"pixelRatio"in c&&(g=+c.pixelRatio))),t&&("canvas"===t.nodeName.toLowerCase()?i=t:n=t),!s){if(!i){if(!(t=o(n||document.body,A,g)))return null;i=t.canvas,w=t.onDestroy}void 0===e.premultipliedAlpha&&(e.premultipliedAlpha=!0),s=a(i,e)}return s?{gl:s,canvas:i,container:n,extensions:u,optionalExtensions:f,pixelRatio:g,profile:m,onDone:A,onDestroy:w}:(w(),A("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function u(e,t){function n(t){var n;t=t.toLowerCase();try{n=i[t]=e.getExtension(t)}catch(e){}return!!n}for(var i={},s=0;s<t.extensions.length;++s){var o=t.extensions[s];if(!n(o))return t.onDestroy(),t.onDone('"'+o+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return t.optionalExtensions.forEach(n),{extensions:i,restore:function(){Object.keys(i).forEach((function(e){if(i[e]&&!n(e))throw Error("(regl): error restoring extension "+e)}))}}}function f(e,t){for(var n=Array(e),i=0;i<e;++i)n[i]=t(i);return n}function g(e){var t,n;return t=(65535<e)<<4,t|=n=(255<(e>>>=t))<<3,(t|=n=(15<(e>>>=n))<<2)|(n=(3<(e>>>=n))<<1)|e>>>n>>1}function m(){function e(e){e:{for(var t=16;268435456>=t;t*=16)if(e<=t){e=t;break e}e=0}return 0<(t=n[g(e)>>2]).length?t.pop():new ArrayBuffer(e)}function t(e){n[g(e.byteLength)>>2].push(e)}var n=f(8,(function(){return[]}));return{alloc:e,free:t,allocType:function(t,n){var i=null;switch(t){case 5120:i=new Int8Array(e(n),0,n);break;case 5121:i=new Uint8Array(e(n),0,n);break;case 5122:i=new Int16Array(e(2*n),0,n);break;case 5123:i=new Uint16Array(e(2*n),0,n);break;case 5124:i=new Int32Array(e(4*n),0,n);break;case 5125:i=new Uint32Array(e(4*n),0,n);break;case 5126:i=new Float32Array(e(4*n),0,n);break;default:return null}return i.length!==n?i.subarray(0,n):i},freeType:function(e){t(e.buffer)}}}function A(e){return!!e&&"object"==typeof e&&Array.isArray(e.shape)&&Array.isArray(e.stride)&&"number"==typeof e.offset&&e.shape.length===e.stride.length&&(Array.isArray(e.data)||be(e.data))}function w(e,t,n,i,s,o){for(var a=0;a<t;++a)for(var l=e[a],h=0;h<n;++h)for(var c=l[h],u=0;u<i;++u)s[o++]=c[u]}function T(e,t,n,i,s){for(var o=1,a=n+1;a<t.length;++a)o*=t[a];var l=t[n];if(4==t.length-n){var h=t[n+1],c=t[n+2];for(t=t[n+3],a=0;a<l;++a)w(e[a],h,c,t,i,s),s+=o}else for(a=0;a<l;++a)T(e[a],t,n+1,i,s),s+=o}function S(e){return 0|Se[Object.prototype.toString.call(e)]}function M(e,t){for(var n=0;n<t.length;++n)e[n]=t[n]}function C(e,t,n,i,s,o,a){for(var l=0,h=0;h<n;++h)for(var c=0;c<i;++c)e[l++]=t[s*h+o*c+a]}function I(e,t,n,i){function s(t){this.id=h++,this.buffer=e.createBuffer(),this.type=t,this.usage=35044,this.byteLength=0,this.dimension=1,this.dtype=5121,this.persistentData=null,n.profile&&(this.stats={size:0})}function o(t,n,i){t.byteLength=n.byteLength,e.bufferData(t.type,n,i)}function a(e,t,n,i,s,a){if(e.usage=n,Array.isArray(t)){if(e.dtype=i||5126,0<t.length)if(Array.isArray(t[0])){s=Ie(t);for(var l=i=1;l<s.length;++l)i*=s[l];e.dimension=i,o(e,t=Pe(t,s,e.dtype),n),a?e.persistentData=t:ve.freeType(t)}else"number"==typeof t[0]?(e.dimension=s,M(s=ve.allocType(e.dtype,t.length),t),o(e,s,n),a?e.persistentData=s:ve.freeType(s)):be(t[0])&&(e.dimension=t[0].length,e.dtype=i||S(t[0])||5126,o(e,t=Pe(t,[t.length,t[0].length],e.dtype),n),a?e.persistentData=t:ve.freeType(t))}else if(be(t))e.dtype=i||S(t),e.dimension=s,o(e,t,n),a&&(e.persistentData=new Uint8Array(new Uint8Array(t.buffer)));else if(A(t)){var h=t.stride,c=(l=t.offset,0),u=0,f=0,g=0;1===(s=t.shape).length?(c=s[0],u=1,f=h[0],g=0):2===s.length&&(c=s[0],u=s[1],f=h[0],g=h[1]),e.dtype=i||S(t.data)||5126,e.dimension=u,C(s=ve.allocType(e.dtype,c*u),t.data,c,u,f,g,l),o(e,s,n),a?e.persistentData=s:ve.freeType(s)}else t instanceof ArrayBuffer&&(e.dtype=5121,e.dimension=s,o(e,t,n),a&&(e.persistentData=new Uint8Array(new Uint8Array(t))))}function l(n){t.bufferCount--,i(n),e.deleteBuffer(n.buffer),n.buffer=null,delete c[n.id]}var h=0,c={};s.prototype.bind=function(){e.bindBuffer(this.type,this.buffer)},s.prototype.destroy=function(){l(this)};var u=[];return n.profile&&(t.getTotalBufferSize=function(){var e=0;return Object.keys(c).forEach((function(t){e+=c[t].stats.size})),e}),{create:function(i,o,h,u){function f(t){var i=35044,s=null,o=0,l=0,h=g&&g.dimension||1;return Array.isArray(t)||be(t)||A(t)||t instanceof ArrayBuffer?s=t:"number"==typeof t?o=0|t:t&&("data"in t&&(s=t.data),"usage"in t&&(i=Ce[t.usage]),"type"in t&&(l=Me[t.type]),"dimension"in t&&(h=0|t.dimension),"length"in t&&(o=0|t.length)),g.bind(),s?a(g,s,i,l,h,u):(o&&e.bufferData(g.type,o,i),g.dtype=l||5121,g.usage=i,g.dimension=h,g.byteLength=o),n.profile&&(g.stats.size=g.byteLength*ke[g.dtype]),f}t.bufferCount++;var g=new s(o);return c[g.id]=g,h||f(i),f._reglType="buffer",f._buffer=g,f.subdata=function(t,n){var i,s=0|(n||0);if(g.bind(),be(t)||t instanceof ArrayBuffer)e.bufferSubData(g.type,s,t);else if(Array.isArray(t)){if(0<t.length)if("number"==typeof t[0]){var o=ve.allocType(g.dtype,t.length);M(o,t),e.bufferSubData(g.type,s,o),ve.freeType(o)}else(Array.isArray(t[0])||be(t[0]))&&(i=Ie(t),o=Pe(t,i,g.dtype),e.bufferSubData(g.type,s,o),ve.freeType(o))}else if(A(t)){var a=t.stride,l=o=0,h=0,c=0;1===(i=t.shape).length?(o=i[0],l=1,h=a[0],c=0):2===i.length&&(o=i[0],l=i[1],h=a[0],c=a[1]),i=Array.isArray(t.data)?g.dtype:S(t.data),C(i=ve.allocType(i,o*l),t.data,o,l,h,c,t.offset),e.bufferSubData(g.type,s,i),ve.freeType(i)}return f},n.profile&&(f.stats=g.stats),f.destroy=function(){l(g)},f},createStream:function(e,t){var n=u.pop();return n||(n=new s(e)),n.bind(),a(n,t,35040,0,1,!1),n},destroyStream:function(e){u.push(e)},clear:function(){we(c).forEach(l),u.forEach(l)},getBuffer:function(e){return e&&e._buffer instanceof s?e._buffer:null},restore:function(){we(c).forEach((function(t){t.buffer=e.createBuffer(),e.bindBuffer(t.type,t.buffer),e.bufferData(t.type,t.persistentData||t.byteLength,t.usage)}))},_initBuffer:a}}function E(e,t,n,i){function s(e){this.id=h++,l[this.id]=this,this.buffer=e,this.primType=4,this.type=this.vertCount=0}function o(i,s,o,a,l,h,c){var u;if(i.buffer.bind(),s?((u=c)||be(s)&&(!A(s)||be(s.data))||(u=t.oes_element_index_uint?5125:5123),n._initBuffer(i.buffer,s,o,u,3)):(e.bufferData(34963,h,o),i.buffer.dtype=u||5121,i.buffer.usage=o,i.buffer.dimension=3,i.buffer.byteLength=h),u=c,!c){switch(i.buffer.dtype){case 5121:case 5120:u=5121;break;case 5123:case 5122:u=5123;break;case 5125:case 5124:u=5125}i.buffer.dtype=u}i.type=u,0>(s=l)&&(s=i.buffer.byteLength,5123===u?s>>=1:5125===u&&(s>>=2)),i.vertCount=s,s=a,0>a&&(s=4,1===(a=i.buffer.dimension)&&(s=0),2===a&&(s=1),3===a&&(s=4)),i.primType=s}function a(e){i.elementsCount--,delete l[e.id],e.buffer.destroy(),e.buffer=null}var l={},h=0,c={uint8:5121,uint16:5123};t.oes_element_index_uint&&(c.uint32=5125),s.prototype.bind=function(){this.buffer.bind()};var u=[];return{create:function(e,t){function l(e){if(e)if("number"==typeof e)h(e),u.primType=4,u.vertCount=0|e,u.type=5121;else{var t=null,n=35044,i=-1,s=-1,a=0,f=0;Array.isArray(e)||be(e)||A(e)?t=e:("data"in e&&(t=e.data),"usage"in e&&(n=Ce[e.usage]),"primitive"in e&&(i=Oe[e.primitive]),"count"in e&&(s=0|e.count),"type"in e&&(f=c[e.type]),"length"in e?a=0|e.length:(a=s,5123===f||5122===f?a*=2:5125!==f&&5124!==f||(a*=4))),o(u,t,n,i,s,a,f)}else h(),u.primType=4,u.vertCount=0,u.type=5121;return l}var h=n.create(null,34963,!0),u=new s(h._buffer);return i.elementsCount++,l(e),l._reglType="elements",l._elements=u,l.subdata=function(e,t){return h.subdata(e,t),l},l.destroy=function(){a(u)},l},createStream:function(e){var t=u.pop();return t||(t=new s(n.create(null,34963,!0,!1)._buffer)),o(t,e,35040,-1,-1,0,0),t},destroyStream:function(e){u.push(e)},getElements:function(e){return"function"==typeof e&&e._elements instanceof s?e._elements:null},clear:function(){we(l).forEach(a)}}}function D(e){for(var t=ve.allocType(5123,e.length),n=0;n<e.length;++n)if(isNaN(e[n]))t[n]=65535;else if(1/0===e[n])t[n]=31744;else if(-1/0===e[n])t[n]=64512;else{Ee[0]=e[n];var i=(o=Re[0])>>>31<<15,s=(o<<1>>>24)-127,o=o>>13&1023;t[n]=-24>s?i:-14>s?i+(o+1024>>-14-s):15<s?i+31744:i+(s+15<<10)+o}return t}function H(e){return Array.isArray(e)||be(e)}function N(e){return"[object "+e+"]"}function B(e){return Array.isArray(e)&&(0===e.length||"number"==typeof e[0])}function z(e){return!(!Array.isArray(e)||0===e.length||!H(e[0]))}function U(e){return Object.prototype.toString.call(e)}function j(e){if(!e)return!1;var t=U(e);return 0<=Ve.indexOf(t)||B(e)||z(e)||A(e)}function W(e,t){36193===e.type?(e.data=D(t),ve.freeType(t)):e.data=t}function q(e,t,n,i,s,o){if(e=void 0!==We[e]?We[e]:Fe[e]*je[t],o&&(e*=6),s){for(i=0;1<=n;)i+=e*n*n,n/=2;return i}return e*n*i}function Z(e,t,n,i,s,o,a){function l(){this.format=this.internalformat=6408,this.type=5121,this.flipY=this.premultiplyAlpha=this.compressed=!1,this.unpackAlignment=1,this.colorSpace=37444,this.channels=this.height=this.width=0}function h(e,t){e.internalformat=t.internalformat,e.format=t.format,e.type=t.type,e.compressed=t.compressed,e.premultiplyAlpha=t.premultiplyAlpha,e.flipY=t.flipY,e.unpackAlignment=t.unpackAlignment,e.colorSpace=t.colorSpace,e.width=t.width,e.height=t.height,e.channels=t.channels}function c(e,t){if("object"==typeof t&&t){"premultiplyAlpha"in t&&(e.premultiplyAlpha=t.premultiplyAlpha),"flipY"in t&&(e.flipY=t.flipY),"alignment"in t&&(e.unpackAlignment=t.alignment),"colorSpace"in t&&(e.colorSpace=oe[t.colorSpace]),"type"in t&&(e.type=le[t.type]);var n=e.width,i=e.height,s=e.channels,o=!1;"shape"in t?(n=t.shape[0],i=t.shape[1],3===t.shape.length&&(s=t.shape[2],o=!0)):("radius"in t&&(n=i=t.radius),"width"in t&&(n=t.width),"height"in t&&(i=t.height),"channels"in t&&(s=t.channels,o=!0)),e.width=0|n,e.height=0|i,e.channels=0|s,n=!1,"format"in t&&(i=e.internalformat=he[n=t.format],e.format=Me[i],n in le&&!("type"in t)&&(e.type=le[n]),n in ue&&(e.compressed=!0),n=!0),!o&&n?e.channels=Fe[e.format]:o&&!n&&e.channels!==De[e.format]&&(e.format=e.internalformat=De[e.channels])}}function u(t){e.pixelStorei(37440,t.flipY),e.pixelStorei(37441,t.premultiplyAlpha),e.pixelStorei(37443,t.colorSpace),e.pixelStorei(3317,t.unpackAlignment)}function f(){l.call(this),this.yOffset=this.xOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function g(e,t){var n=null;if(j(t)?n=t:t&&(c(e,t),"x"in t&&(e.xOffset=0|t.x),"y"in t&&(e.yOffset=0|t.y),j(t.data)&&(n=t.data)),t.copy){var i=s.viewportWidth,o=s.viewportHeight;e.width=e.width||i-e.xOffset,e.height=e.height||o-e.yOffset,e.needsCopy=!0}else if(n){if(be(n))e.channels=e.channels||4,e.data=n,"type"in t||5121!==e.type||(e.type=0|Se[Object.prototype.toString.call(n)]);else if(B(n)){switch(e.channels=e.channels||4,o=(i=n).length,e.type){case 5121:case 5123:case 5125:case 5126:(o=ve.allocType(e.type,o)).set(i),e.data=o;break;case 36193:e.data=D(i)}e.alignment=1,e.needsFree=!0}else if(A(n)){i=n.data,Array.isArray(i)||5121!==e.type||(e.type=0|Se[Object.prototype.toString.call(i)]);var a,l,h,u,f=n.stride;3===(o=n.shape).length?(h=o[2],u=f[2]):u=h=1,a=o[0],l=o[1],o=f[0],f=f[1],e.alignment=1,e.width=a,e.height=l,e.channels=h,e.format=e.internalformat=De[h],e.needsFree=!0,a=u,n=n.offset;for(var g=ve.allocType(36193===e.type?5126:e.type,(h=e.width)*(u=e.height)*(l=e.channels)),m=0,w=0;w<u;++w)for(var T=0;T<h;++T)for(var S=0;S<l;++S)g[m++]=i[o*T+f*w+a*S+n];W(e,g)}else if(U(n)===He||U(n)===Ne||U(n)===Be)e.element=U(n)===He||U(n)===Ne?n:n.canvas,e.width=e.element.width,e.height=e.element.height,e.channels=4;else if(U(n)===ze)e.element=n,e.width=n.width,e.height=n.height,e.channels=4;else if(U(n)===Ge)e.element=n,e.width=n.naturalWidth,e.height=n.naturalHeight,e.channels=4;else if(U(n)===Ue)e.element=n,e.width=n.videoWidth,e.height=n.videoHeight,e.channels=4;else if(z(n)){for(i=e.width||n[0].length,o=e.height||n.length,f=e.channels,f=H(n[0][0])?f||n[0][0].length:f||1,a=Te.shape(n),h=1,u=0;u<a.length;++u)h*=a[u];h=ve.allocType(36193===e.type?5126:e.type,h),Te.flatten(n,a,"",h),W(e,h),e.alignment=1,e.width=i,e.height=o,e.channels=f,e.format=e.internalformat=De[f],e.needsFree=!0}}else e.width=e.width||1,e.height=e.height||1,e.channels=e.channels||4}function m(t,n,s,o,a){var l=t.element,h=t.data,c=t.internalformat,f=t.format,g=t.type,m=t.width,A=t.height;u(t),l?e.texSubImage2D(n,a,s,o,f,g,l):t.compressed?e.compressedTexSubImage2D(n,a,s,o,c,m,A,h):t.needsCopy?(i(),e.copyTexSubImage2D(n,a,s,o,t.xOffset,t.yOffset,m,A)):e.texSubImage2D(n,a,s,o,m,A,f,g,h)}function w(){return Ce.pop()||new f}function T(e){e.needsFree&&ve.freeType(e.data),f.call(e),Ce.push(e)}function S(){l.call(this),this.genMipmaps=!1,this.mipmapHint=4352,this.mipmask=0,this.images=Array(16)}function M(e,t,n){var i=e.images[0]=w();e.mipmask=1,i.width=e.width=t,i.height=e.height=n,i.channels=e.channels=4}function C(e,t){var n=null;if(j(t))h(n=e.images[0]=w(),e),g(n,t),e.mipmask=1;else if(c(e,t),Array.isArray(t.mipmap))for(var i=t.mipmap,s=0;s<i.length;++s)h(n=e.images[s]=w(),e),n.width>>=s,n.height>>=s,g(n,i[s]),e.mipmask|=1<<s;else h(n=e.images[0]=w(),e),g(n,t),e.mipmask=1;h(e,e.images[0])}function I(t,n){for(var s=t.images,o=0;o<s.length&&s[o];++o){var a=s[o],l=n,h=o,c=a.element,f=a.data,g=a.internalformat,m=a.format,A=a.type,w=a.width,T=a.height;u(a),c?e.texImage2D(l,h,m,m,A,c):a.compressed?e.compressedTexImage2D(l,h,g,Math.max(1,w),Math.max(1,T),0,f):a.needsCopy?(i(),e.copyTexImage2D(l,h,m,a.xOffset,a.yOffset,w,T,0)):e.texImage2D(l,h,m,w,T,0,m,A,f||null)}}function E(){var e=Pe.pop()||new S;l.call(e);for(var t=e.mipmask=0;16>t;++t)e.images[t]=null;return e}function N(e){for(var t=e.images,n=0;n<t.length;++n)t[n]&&T(t[n]),t[n]=null;Pe.push(e)}function Z(){this.magFilter=this.minFilter=9728,this.wrapT=this.wrapS=33071,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=4352}function X(e,t){"min"in t&&(e.minFilter=se[t.min],0<=Le.indexOf(e.minFilter)&&!("faces"in t)&&(e.genMipmaps=!0)),"mag"in t&&(e.magFilter=re[t.mag]);var n=e.wrapS,i=e.wrapT;if("wrap"in t){var s=t.wrap;"string"==typeof s?n=i=te[s]:Array.isArray(s)&&(n=te[s[0]],i=te[s[1]])}else"wrapS"in t&&(n=te[t.wrapS]),"wrapT"in t&&(i=te[t.wrapT]);if(e.wrapS=n,e.wrapT=i,"anisotropic"in t&&(e.anisotropic=t.anisotropic),"mipmap"in t){switch(n=!1,typeof t.mipmap){case"string":e.mipmapHint=ee[t.mipmap],n=e.genMipmaps=!0;break;case"boolean":n=e.genMipmaps=t.mipmap;break;case"object":e.genMipmaps=!1,n=!0}!n||"min"in t||(e.minFilter=9984)}}function Y(n,i){e.texParameteri(i,10241,n.minFilter),e.texParameteri(i,10240,n.magFilter),e.texParameteri(i,10242,n.wrapS),e.texParameteri(i,10243,n.wrapT),t.ext_texture_filter_anisotropic&&e.texParameteri(i,34046,n.anisotropic),n.genMipmaps&&(e.hint(33170,n.mipmapHint),e.generateMipmap(i))}function J(t){l.call(this),this.mipmask=0,this.internalformat=6408,this.id=Ie++,this.refCount=1,this.target=t,this.texture=e.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new Z,a.profile&&(this.stats={size:0})}function Q(t){e.activeTexture(33984),e.bindTexture(t.target,t.texture)}function $(){var t=Ee[0];t?e.bindTexture(t.target,t.texture):e.bindTexture(3553,null)}function K(t){var n=t.texture,i=t.unit,s=t.target;0<=i&&(e.activeTexture(33984+i),e.bindTexture(s,null),Ee[i]=null),e.deleteTexture(n),t.texture=null,t.params=null,t.pixels=null,t.refCount=0,delete ke[t.id],o.textureCount--}var ee={"don't care":4352,"dont care":4352,nice:4354,fast:4353},te={repeat:10497,clamp:33071,mirror:33648},re={nearest:9728,linear:9729},se=pe({mipmap:9987,"nearest mipmap nearest":9984,"linear mipmap nearest":9985,"nearest mipmap linear":9986,"linear mipmap linear":9987},re),oe={none:0,browser:37444},le={uint8:5121,rgba4:32819,rgb565:33635,"rgb5 a1":32820},he={alpha:6406,luminance:6409,"luminance alpha":6410,rgb:6407,rgba:6408,rgba4:32854,"rgb5 a1":32855,rgb565:36194},ue={};t.ext_srgb&&(he.srgb=35904,he.srgba=35906),t.oes_texture_float&&(le.float32=le.float=5126),t.oes_texture_half_float&&(le.float16=le["half float"]=36193),t.webgl_depth_texture&&(pe(he,{depth:6402,"depth stencil":34041}),pe(le,{uint16:5123,uint32:5125,"depth stencil":34042})),t.webgl_compressed_texture_s3tc&&pe(ue,{"rgb s3tc dxt1":33776,"rgba s3tc dxt1":33777,"rgba s3tc dxt3":33778,"rgba s3tc dxt5":33779}),t.webgl_compressed_texture_atc&&pe(ue,{"rgb atc":35986,"rgba atc explicit alpha":35987,"rgba atc interpolated alpha":34798}),t.webgl_compressed_texture_pvrtc&&pe(ue,{"rgb pvrtc 4bppv1":35840,"rgb pvrtc 2bppv1":35841,"rgba pvrtc 4bppv1":35842,"rgba pvrtc 2bppv1":35843}),t.webgl_compressed_texture_etc1&&(ue["rgb etc1"]=36196,ue["rgb etc2"]=37492);var fe=Array.prototype.slice.call(e.getParameter(34467));Object.keys(ue).forEach((function(e){var t=ue[e];0<=fe.indexOf(t)&&(he[e]=t)}));var de=Object.keys(he);n.textureFormats=de;var me=[];Object.keys(he).forEach((function(e){me[he[e]]=e}));var Ae=[];Object.keys(le).forEach((function(e){Ae[le[e]]=e}));var ye=[];Object.keys(re).forEach((function(e){ye[re[e]]=e}));var _e=[];Object.keys(se).forEach((function(e){_e[se[e]]=e}));var xe=[];Object.keys(te).forEach((function(e){xe[te[e]]=e}));var Me=de.reduce((function(e,n){var i=he[n];return e[i]=6409===i||6406===i||6409===i||6410===i||6402===i||34041===i||t.ext_srgb&&(35904===i||35906===i)?i:32855===i||0<=n.indexOf("rgba")?6408:6407,e}),{}),Ce=[],Pe=[],Ie=0,ke={},Oe=n.maxTextureUnits,Ee=Array(Oe).map((function(){return null}));return pe(J.prototype,{bind:function(){this.bindCount+=1;var t=this.unit;if(0>t){for(var n=0;n<Oe;++n){var i=Ee[n];if(i){if(0<i.bindCount)continue;i.unit=-1}Ee[n]=this,t=n;break}a.profile&&o.maxTextureUnits<t+1&&(o.maxTextureUnits=t+1),this.unit=t,e.activeTexture(33984+t),e.bindTexture(this.target,this.texture)}return t},unbind:function(){--this.bindCount},decRef:function(){0>=--this.refCount&&K(this)}}),a.profile&&(o.getTotalTextureSize=function(){var e=0;return Object.keys(ke).forEach((function(t){e+=ke[t].stats.size})),e}),{create2D:function(t,n){function i(t,n){var o=s.texInfo;Z.call(o),o.version=e instanceof WebGL2RenderingContext?2:1;var l=E();return"number"==typeof t?M(l,0|t,"number"==typeof n?0|n:0|t):t?(X(o,t),C(l,t)):M(l,1,1),o.genMipmaps&&(l.mipmask=(Math.max(l.width,l.height)<<1)-1),s.mipmask=l.mipmask,h(s,l),s.internalformat=l.internalformat,i.width=l.width,i.height=l.height,Q(s),I(l,3553),Y(o,3553),$(),N(l),a.profile&&(s.stats.size=q(s.internalformat,s.type,l.width,l.height,o.genMipmaps,!1)),i.format=me[s.internalformat],i.type=Ae[s.type],i.mag=ye[o.magFilter],i.min=_e[o.minFilter],i.wrapS=xe[o.wrapS],i.wrapT=xe[o.wrapT],i}var s=new J(3553);return ke[s.id]=s,o.textureCount++,i(t,n),i.subimage=function(e,t,n,o){t|=0,n|=0,o|=0;var a=w();return h(a,s),a.width=0,a.height=0,g(a,e),a.width=a.width||(s.width>>o)-t,a.height=a.height||(s.height>>o)-n,Q(s),m(a,3553,t,n,o),$(),T(a),i},i.resize=function(t,n){var o=0|t,l=0|n||o;if(o===s.width&&l===s.height)return i;i.width=s.width=o,i.height=s.height=l,Q(s);for(var h=0;s.mipmask>>h;++h){var c=o>>h,u=l>>h;if(!c||!u)break;e.texImage2D(3553,h,s.format,c,u,0,s.format,s.type,null)}return $(),a.profile&&(s.stats.size=q(s.internalformat,s.type,o,l,!1,!1)),i},i.texParameteri=function(t,n){Q(s);var i=e.texParameteri(3553,t,n);return $(),i},i._reglType="texture2d",i._texture=s,a.profile&&(i.stats=s.stats),i.destroy=function(){s.decRef()},i},createCube:function(t,n,i,s,l,u){function f(e,t,n,i,s,o){var l,u=A.texInfo;for(Z.call(u),l=0;6>l;++l)S[l]=E();if("number"!=typeof e&&e){if("object"==typeof e)if(t)C(S[0],e),C(S[1],t),C(S[2],n),C(S[3],i),C(S[4],s),C(S[5],o);else if(X(u,e),c(A,e),"faces"in e)for(e=e.faces,l=0;6>l;++l)h(S[l],A),C(S[l],e[l]);else for(l=0;6>l;++l)C(S[l],e)}else for(e=0|e||1,l=0;6>l;++l)M(S[l],e,e);for(h(A,S[0]),A.mipmask=u.genMipmaps?(Math.max(S[0].width,S[0].height)<<1)-1:S[0].mipmask,A.internalformat=S[0].internalformat,f.width=S[0].width,f.height=S[0].height,Q(A),l=0;6>l;++l)I(S[l],34069+l);for(Y(u,34067),$(),a.profile&&(A.stats.size=q(A.internalformat,A.type,f.width,f.height,u.genMipmaps,!0)),f.format=me[A.internalformat],f.type=Ae[A.type],f.mag=ye[u.magFilter],f.min=_e[u.minFilter],f.wrapS=xe[u.wrapS],f.wrapT=xe[u.wrapT],l=0;6>l;++l)N(S[l]);return f}var A=new J(34067);ke[A.id]=A,o.cubeCount++;var S=Array(6);return f(t,n,i,s,l,u),f.subimage=function(e,t,n,i,s){n|=0,i|=0,s|=0;var o=w();return h(o,A),o.width=0,o.height=0,g(o,t),o.width=o.width||(A.width>>s)-n,o.height=o.height||(A.height>>s)-i,Q(A),m(o,34069+e,n,i,s),$(),T(o),f},f.resize=function(t){if((t|=0)!==A.width){f.width=A.width=t,f.height=A.height=t,Q(A);for(var n=0;6>n;++n)for(var i=0;A.mipmask>>i;++i)e.texImage2D(34069+n,i,A.format,t>>i,t>>i,0,A.format,A.type,null);return $(),a.profile&&(A.stats.size=q(A.internalformat,A.type,f.width,f.height,!1,!0)),f}},f._reglType="textureCube",f._texture=A,a.profile&&(f.stats=A.stats),f.destroy=function(){A.decRef()},f},clear:function(){for(var t=0;t<Oe;++t)e.activeTexture(33984+t),e.bindTexture(3553,null),Ee[t]=null;we(ke).forEach(K),o.cubeCount=0,o.textureCount=0},getTexture:function(e){return null},restore:function(){for(var t=0;t<Oe;++t){var n=Ee[t];n&&(n.bindCount=0,n.unit=-1,Ee[t]=null)}we(ke).forEach((function(t){t.texture=e.createTexture(),e.bindTexture(t.target,t.texture);for(var n=0;32>n;++n)if(t.mipmask&1<<n)if(3553===t.target)e.texImage2D(3553,n,t.internalformat,t.width>>n,t.height>>n,0,t.internalformat,t.type,null);else for(var i=0;6>i;++i)e.texImage2D(34069+i,n,t.internalformat,t.width>>n,t.height>>n,0,t.internalformat,t.type,null);Y(t.texInfo,t.target)}))},refresh:function(){for(var t=0;t<Oe;++t){var n=Ee[t];n&&(n.bindCount=0,n.unit=-1,Ee[t]=null),e.activeTexture(33984+t),e.bindTexture(3553,null),e.bindTexture(34067,null)}}}}function X(e,t,n,i,s,o){function a(e,t,n){this.target=e,this.texture=t,this.renderbuffer=n;var i=e=0;t?(e=t.width,i=t.height):n&&(e=n.width,i=n.height),this.width=e,this.height=i}function l(e){e&&(e.texture&&e.texture._texture.decRef(),e.renderbuffer&&e.renderbuffer._renderbuffer.decRef())}function h(e,t,n){e&&(e.texture?e.texture._texture.refCount+=1:e.renderbuffer._renderbuffer.refCount+=1)}function c(t,n){n&&(n.texture?e.framebufferTexture2D(36160,t,n.target,n.texture._texture.texture,0):e.framebufferRenderbuffer(36160,t,36161,n.renderbuffer._renderbuffer.renderbuffer))}function u(e){var t=3553,n=null,i=null,s=e;return"object"==typeof e&&(s=e.data,"target"in e&&(t=0|e.target)),"texture2d"===(e=s._reglType)||"textureCube"===e?n=s:"renderbuffer"===e&&(i=s,t=36161),new a(t,n,i)}function f(e,t,n,o,l){return n?((e=i.create2D({width:e,height:t,format:o,type:l}))._texture.refCount=0,new a(3553,e,null)):((e=s.create({width:e,height:t,format:o}))._renderbuffer.refCount=0,new a(36161,null,e))}function g(e){return e&&(e.texture||e.renderbuffer)}function m(e,t,n){e&&(e.texture?e.texture.resize(t,n):e.renderbuffer&&e.renderbuffer.resize(t,n),e.width=t,e.height=n)}function A(){this.id=H++,N[this.id]=this,this.framebuffer=e.createFramebuffer(),this.height=this.width=0,this.colorAttachments=[],this.depthStencilAttachment=this.stencilAttachment=this.depthAttachment=null}function w(e){e.colorAttachments.forEach(l),l(e.depthAttachment),l(e.stencilAttachment),l(e.depthStencilAttachment)}function T(t){e.deleteFramebuffer(t.framebuffer),t.framebuffer=null,o.framebufferCount--,delete N[t.id]}function S(t,i){var s;e.bindFramebuffer(36160,t.framebuffer);var o=t.colorAttachments;for(s=0;s<o.length;++s)c(36064+s,o[s]);for(s=o.length;s<n.maxColorAttachments;++s)e.framebufferTexture2D(36160,36064+s,3553,null,0);e.framebufferTexture2D(36160,33306,3553,null,0),e.framebufferTexture2D(36160,36096,3553,null,0),e.framebufferTexture2D(36160,36128,3553,null,0),c(36096,t.depthAttachment),c(36128,t.stencilAttachment),c(33306,t.depthStencilAttachment),i||(e.checkFramebufferStatus(36160),e.isContextLost()),e.bindFramebuffer(36160,C.next?C.next.framebuffer:null),C.cur=C.next,i||e.getError()}function M(t,n){function i(e,t){var n,o=0,a=0,l=!0,c=!0;n=null;var m=!0,A="rgba",T="uint8",M=1,C=null,D=null,H=null,N=!1;if("number"==typeof e)o=0|e,a=0|t||o;else if(e){var B=e;"shape"in B?(o=(a=B.shape)[0],a=a[1]):("radius"in B&&(o=a=B.radius),"width"in B&&(o=B.width),"height"in B&&(a=B.height)),("color"in B||"colors"in B)&&(n=B.color||B.colors),n||("colorCount"in B&&(M=0|B.colorCount),"colorTexture"in B&&(m=!!B.colorTexture,A="rgba4"),"colorType"in B&&(T=B.colorType,!m)&&("half float"===T||"float16"===T?A="rgba16f":"float"!==T&&"float32"!==T||(A="rgba32f")),"colorFormat"in B&&(0<=I.indexOf(A=B.colorFormat)?m=!0:0<=E.indexOf(A)&&(m=!1))),("depthTexture"in B||"depthStencilTexture"in B)&&(N=!(!B.depthTexture&&!B.depthStencilTexture)),"depth"in B&&("boolean"==typeof B.depth?l=B.depth:(C=B.depth,c=!1)),"stencil"in B&&("boolean"==typeof B.stencil?c=B.stencil:(D=B.stencil,l=!1)),"depthStencil"in B&&("boolean"==typeof B.depthStencil?l=c=B.depthStencil:(H=B.depthStencil,c=l=!1))}else o=a=1;var z=null,U=null,j=null,W=null;if(Array.isArray(n))z=n.map(u);else if(n)z=[u(n)];else for(z=Array(M),n=0;n<M;++n)z[n]=f(o,a,m,A,T);for(o=o||z[0].width,a=a||z[0].height,C?U=u(C):l&&!c&&(U=f(o,a,N,"depth","uint32")),D?j=u(D):c&&!l&&(j=f(o,a,!1,"stencil","uint8")),H?W=u(H):!C&&!D&&c&&l&&(W=f(o,a,N,"depth stencil","depth stencil")),l=null,n=0;n<z.length;++n)h(z[n]),z[n]&&z[n].texture&&(c=Xe[z[n].texture._texture.format]*Ye[z[n].texture._texture.type],null===l&&(l=c));return h(U),h(j),h(W),w(s),s.width=o,s.height=a,s.colorAttachments=z,s.depthAttachment=U,s.stencilAttachment=j,s.depthStencilAttachment=W,i.color=z.map(g),i.depth=g(U),i.stencil=g(j),i.depthStencil=g(W),i.width=s.width,i.height=s.height,S(s,B&&B.ignoreStatusCheck),i}var s=new A;return o.framebufferCount++,i(t,n),pe(i,{resize:function(e,t){var n=Math.max(0|e,1),o=Math.max(0|t||n,1);if(n===s.width&&o===s.height)return i;for(var a=s.colorAttachments,l=0;l<a.length;++l)m(a[l],n,o);return m(s.depthAttachment,n,o),m(s.stencilAttachment,n,o),m(s.depthStencilAttachment,n,o),s.width=i.width=n,s.height=i.height=o,S(s),i},blit:function(t,n,i){e.bindFramebuffer(36008,t._framebuffer.framebuffer),e.bindFramebuffer(36009,s.framebuffer),n||(n=16384),e.blitFramebuffer(0,0,t.width,t.height,0,0,s.width,s.height,n,"linear"===i?9729:9728),e.bindFramebuffer(36008,null),e.bindFramebuffer(36009,null)},_reglType:"framebuffer",_framebuffer:s,destroy:function(){T(s),w(s)},use:function(e){C.setFBO({framebuffer:i},e)}})}var C={cur:null,next:null,dirty:!1,setFBO:null},I=["rgba"],E=["rgba4","rgb565","rgb5 a1"];t.ext_srgb&&E.push("srgba"),t.ext_color_buffer_half_float&&E.push("rgba16f","rgb16f"),t.webgl_color_buffer_float&&E.push("rgba32f");var D=["uint8"];t.oes_texture_half_float&&D.push("half float","float16"),t.oes_texture_float&&D.push("float","float32");var H=0,N={};return pe(C,{getFramebuffer:function(e){return"function"==typeof e&&"framebuffer"===e._reglType&&(e=e._framebuffer)instanceof A?e:null},create:M,createCube:function(e){function t(e){var s,o={color:null},a=0,l=null;s="rgba";var h="uint8",c=1;if("number"==typeof e?a=0|e:e?("shape"in e?a=e.shape[0]:("radius"in e&&(a=0|e.radius),"width"in e?a=0|e.width:"height"in e&&(a=0|e.height)),("color"in e||"colors"in e)&&(l=e.color||e.colors),l||("colorCount"in e&&(c=0|e.colorCount),"colorType"in e&&(h=e.colorType),"colorFormat"in e&&(s=e.colorFormat)),"depth"in e&&(o.depth=e.depth),"stencil"in e&&(o.stencil=e.stencil),"depthStencil"in e&&(o.depthStencil=e.depthStencil)):a=1,l)if(Array.isArray(l))for(e=[],s=0;s<l.length;++s)e[s]=l[s];else e=[l];else for(e=Array(c),l={radius:a,format:s,type:h},s=0;s<c;++s)e[s]=i.createCube(l);for(o.color=Array(e.length),s=0;s<e.length;++s)c=e[s],a=a||c.width,o.color[s]={target:34069,data:e[s]};for(s=0;6>s;++s){for(c=0;c<e.length;++c)o.color[c].target=34069+s;0<s&&(o.depth=n[0].depth,o.stencil=n[0].stencil,o.depthStencil=n[0].depthStencil),n[s]?n[s](o):n[s]=M(o)}return pe(t,{width:a,height:a,color:e})}var n=Array(6);return t(e),pe(t,{faces:n,resize:function(e){var i=0|e;if(i===t.width)return t;var s=t.color;for(e=0;e<s.length;++e)s[e].resize(i);for(e=0;6>e;++e)n[e].resize(i);return t.width=t.height=i,t},_reglType:"framebufferCube",destroy:function(){n.forEach((function(e){e.destroy()}))}})},clear:function(){we(N).forEach(T)},restore:function(){C.cur=null,C.next=null,C.dirty=!0,we(N).forEach((function(t){t.framebuffer=e.createFramebuffer(),S(t)}))}})}function Y(){this.w=this.z=this.y=this.x=this.state=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=5126,this.divisor=this.stride=this.offset=0}function J(e,t,n,i,s,o,a){function l(e){if(e!==S.currentVAO){var n=t.oes_vertex_array_object;n.bindVertexArrayOES(e?e.vao:null),S.currentVAO=e}}function h(n){if(n!==S.currentVAO){if(n)n.bindAttrs();else{for(var i=t.angle_instanced_arrays,s=0;s<m.length;++s){var o=m[s];o.buffer?(e.enableVertexAttribArray(s),o.buffer.bind(),e.vertexAttribPointer(s,o.size,o.type,o.normalized,o.stride,o.offfset),i&&o.divisor&&i.vertexAttribDivisorANGLE(s,o.divisor)):(e.disableVertexAttribArray(s),e.vertexAttrib4f(s,o.x,o.y,o.z,o.w))}e.bindBuffer(34963,a.elements?a.elements.buffer.buffer:null)}S.currentVAO=n}}function c(){we(T).forEach((function(e){e.destroy()}))}function u(){this.id=++w,this.attributes=[],this.elements=null,this.ownsElements=!1,this.offset=this.count=0,this.instances=-1,this.primitive=4;var e=t.oes_vertex_array_object;this.vao=e?e.createVertexArrayOES():null,T[this.id]=this,this.buffers=[]}function f(){t.oes_vertex_array_object&&we(T).forEach((function(e){e.refresh()}))}var g=n.maxAttributes,m=Array(g);for(n=0;n<g;++n)m[n]=new Y;var w=0,T={},S={Record:Y,scope:{},state:m,currentVAO:null,targetVAO:null,restore:t.oes_vertex_array_object?f:function(){},createVAO:function(e){function t(e){var i;Array.isArray(e)?(i=e,n.elements&&n.ownsElements&&n.elements.destroy(),n.elements=null,n.ownsElements=!1,n.offset=0,n.count=0,n.instances=-1,n.primitive=4):(e.elements?(i=e.elements,n.ownsElements?("function"==typeof i&&"elements"===i._reglType?n.elements.destroy():n.elements(i),n.ownsElements=!1):o.getElements(e.elements)?(n.elements=e.elements,n.ownsElements=!1):(n.elements=o.create(e.elements),n.ownsElements=!0)):(n.elements=null,n.ownsElements=!1),i=e.attributes,n.offset=0,n.count=-1,n.instances=-1,n.primitive=4,n.elements&&(n.count=n.elements._elements.vertCount,n.primitive=n.elements._elements.primType),"offset"in e&&(n.offset=0|e.offset),"count"in e&&(n.count=0|e.count),"instances"in e&&(n.instances=0|e.instances),"primitive"in e&&(n.primitive=Oe[e.primitive])),e={};var a=n.attributes;a.length=i.length;for(var l=0;l<i.length;++l){var h,c=i[l],u=a[l]=new Y,f=c.data||c;Array.isArray(f)||be(f)||A(f)?(n.buffers[l]&&(h=n.buffers[l],be(f)&&h._buffer.byteLength>=f.byteLength?h.subdata(f):(h.destroy(),n.buffers[l]=null)),n.buffers[l]||(h=n.buffers[l]=s.create(c,34962,!1,!0)),u.buffer=s.getBuffer(h),u.size=0|u.buffer.dimension,u.normalized=!1,u.type=u.buffer.dtype,u.offset=0,u.stride=0,u.divisor=0,u.state=1,e[l]=1):s.getBuffer(c)?(u.buffer=s.getBuffer(c),u.size=0|u.buffer.dimension,u.normalized=!1,u.type=u.buffer.dtype,u.offset=0,u.stride=0,u.divisor=0,u.state=1):s.getBuffer(c.buffer)?(u.buffer=s.getBuffer(c.buffer),u.size=0|(+c.size||u.buffer.dimension),u.normalized=!!c.normalized||!1,u.type="type"in c?Me[c.type]:u.buffer.dtype,u.offset=0|(c.offset||0),u.stride=0|(c.stride||0),u.divisor=0|(c.divisor||0),u.state=1):"x"in c&&(u.x=+c.x||0,u.y=+c.y||0,u.z=+c.z||0,u.w=+c.w||0,u.state=2)}for(h=0;h<n.buffers.length;++h)!e[h]&&n.buffers[h]&&(n.buffers[h].destroy(),n.buffers[h]=null);return n.refresh(),t}var n=new u;return i.vaoCount+=1,t.destroy=function(){for(var e=0;e<n.buffers.length;++e)n.buffers[e]&&n.buffers[e].destroy();n.buffers.length=0,n.ownsElements&&(n.elements.destroy(),n.elements=null,n.ownsElements=!1),n.destroy()},t._vao=n,t._reglType="vao",t(e)},getVAO:function(e){return"function"==typeof e&&e._vao?e._vao:null},destroyBuffer:function(t){for(var n=0;n<m.length;++n){var i=m[n];i.buffer===t&&(e.disableVertexAttribArray(n),i.buffer=null)}},setVAO:t.oes_vertex_array_object?l:h,clear:t.oes_vertex_array_object?c:function(){}};return u.prototype.bindAttrs=function(){for(var n=t.angle_instanced_arrays,i=this.attributes,s=0;s<i.length;++s){var a=i[s];a.buffer?(e.enableVertexAttribArray(s),e.bindBuffer(34962,a.buffer.buffer),e.vertexAttribPointer(s,a.size,a.type,a.normalized,a.stride,a.offset),n&&a.divisor&&n.vertexAttribDivisorANGLE(s,a.divisor)):(e.disableVertexAttribArray(s),e.vertexAttrib4f(s,a.x,a.y,a.z,a.w))}for(n=i.length;n<g;++n)e.disableVertexAttribArray(n);(n=o.getElements(this.elements))?e.bindBuffer(34963,n.buffer.buffer):e.bindBuffer(34963,null)},u.prototype.refresh=function(){var e=t.oes_vertex_array_object;e&&(e.bindVertexArrayOES(this.vao),this.bindAttrs(),S.currentVAO=null,e.bindVertexArrayOES(null))},u.prototype.destroy=function(){if(this.vao){var e=t.oes_vertex_array_object;this===S.currentVAO&&(S.currentVAO=null,e.bindVertexArrayOES(null)),e.deleteVertexArrayOES(this.vao),this.vao=null}this.ownsElements&&(this.elements.destroy(),this.elements=null,this.ownsElements=!1),T[this.id]&&(delete T[this.id],--i.vaoCount)},S}function Q(e,t,n,i){function s(e,t,n,i){this.name=e,this.id=t,this.location=n,this.info=i}function o(e,t){for(var n=0;n<e.length;++n)if(e[n].id===t.id)return void(e[n].location=t.location);e.push(t)}function a(n,i,s){if(!(a=(s=35632===n?c:u)[i])){var o=t.str(i),a=e.createShader(n);e.shaderSource(a,o),e.compileShader(a),s[i]=a}return a}function l(e,t){this.id=m++,this.fragId=e,this.vertId=t,this.program=null,this.uniforms=[],this.attributes=[],this.refCount=1,i.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function h(n,l,h){var c;c=a(35632,n.fragId);var u=a(35633,n.vertId);if(l=n.program=e.createProgram(),e.attachShader(l,c),e.attachShader(l,u),h)for(c=0;c<h.length;++c)e.bindAttribLocation(l,(u=h[c])[0],u[1]);e.linkProgram(l),u=e.getProgramParameter(l,35718),i.profile&&(n.stats.uniformsCount=u);var f=n.uniforms;for(c=0;c<u;++c)if(h=e.getActiveUniform(l,c)){if(1<h.size)for(var g=0;g<h.size;++g){var m=h.name.replace("[0]","["+g+"]");o(f,new s(m,t.id(m),e.getUniformLocation(l,m),h))}g=h.name,1<h.size&&(g=g.replace("[0]","")),o(f,new s(g,t.id(g),e.getUniformLocation(l,g),h))}for(u=e.getProgramParameter(l,35721),i.profile&&(n.stats.attributesCount=u),n=n.attributes,c=0;c<u;++c)(h=e.getActiveAttrib(l,c))&&o(n,new s(h.name,t.id(h.name),e.getAttribLocation(l,h.name),h))}var c={},u={},f={},g=[],m=0;return i.profile&&(n.getMaxUniformsCount=function(){var e=0;return g.forEach((function(t){t.stats.uniformsCount>e&&(e=t.stats.uniformsCount)})),e},n.getMaxAttributesCount=function(){var e=0;return g.forEach((function(t){t.stats.attributesCount>e&&(e=t.stats.attributesCount)})),e}),{clear:function(){var t=e.deleteShader.bind(e);we(c).forEach(t),c={},we(u).forEach(t),u={},g.forEach((function(t){e.deleteProgram(t.program)})),g.length=0,f={},n.shaderCount=0},program:function(t,i,s,o){var a=f[i];a||(a=f[i]={});var m=a[t];if(m&&(m.refCount++,!o))return m;var A=new l(i,t);return n.shaderCount++,h(A,s,o),m||(a[t]=A),g.push(A),pe(A,{destroy:function(){if(A.refCount--,0>=A.refCount){e.deleteProgram(A.program);var t=g.indexOf(A);g.splice(t,1),n.shaderCount--}0>=a[A.vertId].refCount&&(e.deleteShader(u[A.vertId]),delete u[A.vertId],delete f[A.fragId][A.vertId]),Object.keys(f[A.fragId]).length||(e.deleteShader(c[A.fragId]),delete c[A.fragId],delete f[A.fragId])}})},restore:function(){c={},u={};for(var e=0;e<g.length;++e)h(g[e],null,g[e].attributes.map((function(e){return[e.location,e.name]})))},shader:a,frag:-1,vert:-1}}function $(e,t,n,i,s,o,a){function l(s){var o;o=null===t.next?5121:t.next.colorAttachments[0].texture._texture.type;var a=0,l=0,h=i.framebufferWidth,c=i.framebufferHeight,u=null;return be(s)?u=s:s&&(a=0|s.x,l=0|s.y,h=0|(s.width||i.framebufferWidth-a),c=0|(s.height||i.framebufferHeight-l),u=s.data||null),n(),s=h*c*4,u||(5121===o?u=new Uint8Array(s):5126===o&&(u=u||new Float32Array(s))),e.pixelStorei(3333,4),e.readPixels(a,l,h,c,6408,o,u),u}function h(e){var n;return t.setFBO({framebuffer:e.framebuffer},(function(){n=l(e)})),n}return function(e){return e&&"framebuffer"in e?h(e):l(e)}}function K(e){return Array.prototype.slice.call(e)}function ee(e){return K(e).join("")}function te(){function e(){var e=[],t=[];return pe((function(){e.push.apply(e,K(arguments))}),{def:function(){var i="v"+n++;return t.push(i),0<arguments.length&&(e.push(i,"="),e.push.apply(e,K(arguments)),e.push(";")),i},toString:function(){return ee([0<t.length?"var "+t.join(",")+";":"",ee(e)])}})}function t(){function t(e,t){i(e,t,"=",n.def(e,t),";")}var n=e(),i=e(),s=n.toString,o=i.toString;return pe((function(){n.apply(n,K(arguments))}),{def:n.def,entry:n,exit:i,save:t,set:function(e,i,s){t(e,i),n(e,i,"=",s,";")},toString:function(){return s()+o()}})}var n=0,i=[],s=[],o=e(),a={};return{global:o,link:function(e){for(var t=0;t<s.length;++t)if(s[t]===e)return i[t];return t="g"+n++,i.push(t),s.push(e),t},block:e,proc:function(e,n){function i(){var e="a"+s.length;return s.push(e),e}var s=[];n=n||0;for(var o=0;o<n;++o)i();var l=(o=t()).toString;return a[e]=pe(o,{arg:i,toString:function(){return ee(["function(",s.join(),"){",l(),"}"])}})},scope:t,cond:function(){var e=ee(arguments),n=t(),i=t(),s=n.toString,o=i.toString;return pe(n,{then:function(){return n.apply(n,K(arguments)),this},else:function(){return i.apply(i,K(arguments)),this},toString:function(){var t=o();return t&&(t="else{"+t+"}"),ee(["if(",e,"){",s(),"}",t])}})},compile:function(){var e=['"use strict";',o,"return {"];Object.keys(a).forEach((function(t){e.push('"',t,'":',a[t].toString(),",")})),e.push("}");var t=ee(e).replace(/;/g,";\n").replace(/}/g,"}\n").replace(/{/g,"{\n");return Function.apply(null,i.concat(t)).apply(null,s)}}}function re(e){return Array.isArray(e)||be(e)||A(e)}function se(e){return e.sort((function(e,t){return"viewport"===e?-1:"viewport"===t?1:e<t?-1:1}))}function oe(e,t,n,i){this.thisDep=e,this.contextDep=t,this.propDep=n,this.append=i}function le(e){return e&&!(e.thisDep||e.contextDep||e.propDep)}function he(e){return new oe(!1,!1,!1,e)}function ue(e,t){var n=e.type;if(0===n)return new oe(!0,1<=(n=e.data.length),2<=n,t);if(4===n)return new oe((n=e.data).thisDep,n.contextDep,n.propDep,t);if(5===n)return new oe(!1,!1,!1,t);if(6===n){for(var i=n=!1,s=!1,o=0;o<e.data.length;++o){var a=e.data[o];1===a.type?s=!0:2===a.type?i=!0:3===a.type?n=!0:0===a.type?(n=!0,1<=(a=a.data)&&(i=!0),2<=a&&(s=!0)):4===a.type&&(n=n||a.data.thisDep,i=i||a.data.contextDep,s=s||a.data.propDep)}return new oe(n,i,s,t)}return new oe(3===n,2===n,1===n,t)}function fe(e,t,n,i,s,o,a,l,h,c,u,g,m,A,w){function T(e){return e.replace(".","_")}function S(e,t,n){var i=T(e);De.push(e),Le[i]=Re[i]=!!n,Fe[i]=t}function M(e,t,n){var i=T(e);De.push(e),Array.isArray(n)?(Re[i]=n.slice(),Le[i]=n.slice()):Re[i]=Le[i]=n,He[i]=t}function C(){var e=te(),n=e.link,i=e.global;e.id=ze++,e.batchId="0";var s=n(Ne),o=e.shared={props:"a0"};Object.keys(Ne).forEach((function(e){o[e]=i.def(s,".",e)}));var a=e.next={},l=e.current={};Object.keys(He).forEach((function(e){Array.isArray(Re[e])&&(a[e]=i.def(o.next,".",e),l[e]=i.def(o.current,".",e))}));var h=e.constants={};Object.keys(Be).forEach((function(e){h[e]=i.def(JSON.stringify(Be[e]))})),e.invoke=function(t,i){switch(i.type){case 0:var s=["this",o.context,o.props,e.batchId];return t.def(n(i.data),".call(",s.slice(0,Math.max(i.data.length+1,4)),")");case 1:return t.def(o.props,i.data);case 2:return t.def(o.context,i.data);case 3:return t.def("this",i.data);case 4:return i.data.append(e,t),i.data.ref;case 5:return i.data.toString();case 6:return i.data.map((function(n){return e.invoke(t,n)}))}},e.attribCache={};var u={};return e.scopeAttrib=function(e){if((e=t.id(e))in u)return u[e];var i=c.scope[e];return i||(i=c.scope[e]=new Ce),u[e]=n(i)},e}function I(e){var t,n=e.static;if(e=e.dynamic,"profile"in n){var i=!!n.profile;(t=he((function(e,t){return i}))).enable=i}else if("profile"in e){var s=e.profile;t=ue(s,(function(e,t){return e.invoke(t,s)}))}return t}function E(e,t){var n=e.static,i=e.dynamic;if("framebuffer"in n){var s=n.framebuffer;return s?(s=l.getFramebuffer(s),he((function(e,t){var n=e.link(s),i=e.shared;return t.set(i.framebuffer,".next",n),t.set(i=i.context,".framebufferWidth",n+".width"),t.set(i,".framebufferHeight",n+".height"),n}))):he((function(e,t){var n=e.shared;return t.set(n.framebuffer,".next","null"),t.set(n=n.context,".framebufferWidth",n+".drawingBufferWidth"),t.set(n,".framebufferHeight",n+".drawingBufferHeight"),"null"}))}if("framebuffer"in i){var o=i.framebuffer;return ue(o,(function(e,t){var n=e.invoke(t,o),i=e.shared,s=i.framebuffer;return n=t.def(s,".getFramebuffer(",n,")"),t.set(s,".next",n),t.set(i=i.context,".framebufferWidth",n+"?"+n+".width:"+i+".drawingBufferWidth"),t.set(i,".framebufferHeight",n+"?"+n+".height:"+i+".drawingBufferHeight"),n}))}return null}function D(e,t,n){function i(e){if(e in s){var n=s[e];e=!0;var i,a,l=0|n.x,h=0|n.y;return"width"in n?i=0|n.width:e=!1,"height"in n?a=0|n.height:e=!1,new oe(!e&&t&&t.thisDep,!e&&t&&t.contextDep,!e&&t&&t.propDep,(function(e,t){var s=e.shared.context,o=i;"width"in n||(o=t.def(s,".","framebufferWidth","-",l));var c=a;return"height"in n||(c=t.def(s,".","framebufferHeight","-",h)),[l,h,o,c]}))}if(e in o){var c=o[e];return e=ue(c,(function(e,t){var n=e.invoke(t,c),i=e.shared.context,s=t.def(n,".x|0"),o=t.def(n,".y|0");return[s,o,t.def('"width" in ',n,"?",n,".width|0:","(",i,".","framebufferWidth","-",s,")"),n=t.def('"height" in ',n,"?",n,".height|0:","(",i,".","framebufferHeight","-",o,")")]})),t&&(e.thisDep=e.thisDep||t.thisDep,e.contextDep=e.contextDep||t.contextDep,e.propDep=e.propDep||t.propDep),e}return t?new oe(t.thisDep,t.contextDep,t.propDep,(function(e,t){var n=e.shared.context;return[0,0,t.def(n,".","framebufferWidth"),t.def(n,".","framebufferHeight")]})):null}var s=e.static,o=e.dynamic;if(e=i("viewport")){var a=e;e=new oe(e.thisDep,e.contextDep,e.propDep,(function(e,t){var n=a.append(e,t),i=e.shared.context;return t.set(i,".viewportWidth",n[2]),t.set(i,".viewportHeight",n[3]),n}))}return{viewport:e,scissor_box:i("scissor.box")}}function N(e,t){if("string"==typeof(n=e.static).frag&&"string"==typeof n.vert){if(0<Object.keys(t.dynamic).length)return null;var n=t.static,i=Object.keys(n);if(0<i.length&&"number"==typeof n[i[0]]){for(var s=[],o=0;o<i.length;++o)s.push([0|n[i[o]],i[o]]);return s}}return null}function B(e,n,i){function s(e){if(e in o){var n=t.id(o[e]);return(e=he((function(){return n}))).id=n,e}if(e in a){var i=a[e];return ue(i,(function(e,t){var n=e.invoke(t,i);return t.def(e.shared.strings,".id(",n,")")}))}return null}var o=e.static,a=e.dynamic,l=s("frag"),h=s("vert"),c=null;return le(l)&&le(h)?(c=u.program(h.id,l.id,null,i),e=he((function(e,t){return e.link(c)}))):e=new oe(l&&l.thisDep||h&&h.thisDep,l&&l.contextDep||h&&h.contextDep,l&&l.propDep||h&&h.propDep,(function(e,t){var n,i,s=e.shared.shader;return n=l?l.append(e,t):t.def(s,".","frag"),i=h?h.append(e,t):t.def(s,".","vert"),t.def(s+".program("+i+","+n+")")})),{frag:l,vert:h,progVar:e,program:c}}function z(e,t){function n(e,t){if(e in i){var n=0|i[e];return t?a.offset=n:a.instances=n,he((function(e,i){return t&&(e.OFFSET=n),n}))}if(e in s){var o=s[e];return ue(o,(function(e,n){var i=e.invoke(n,o);return t&&(e.OFFSET=i),i}))}if(t){if(u)return he((function(e,t){return e.OFFSET=0}));if(l)return new oe(h.thisDep,h.contextDep,h.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.offset:0")}))}else if(l)return new oe(h.thisDep,h.contextDep,h.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.instances:-1")}));return null}var i=e.static,s=e.dynamic,a={},l=!1,h=function(){if("vao"in i){var e=i.vao;return null!==e&&null===c.getVAO(e)&&(e=c.createVAO(e)),l=!0,a.vao=e,he((function(t){var n=c.getVAO(e);return n?t.link(n):"null"}))}if("vao"in s){l=!0;var t=s.vao;return ue(t,(function(e,n){var i=e.invoke(n,t);return n.def(e.shared.vao+".getVAO("+i+")")}))}return null}(),u=!1,f=function(){if("elements"in i){if(a.elements=t=i.elements,re(t)){var e=a.elements=o.create(t,!0),t=o.getElements(e);u=!0}else t&&(t=o.getElements(t),u=!0);return e=he((function(e,n){if(t){var i=e.link(t);return e.ELEMENTS=i}return e.ELEMENTS=null})),e.value=t,e}if("elements"in s){u=!0;var n=s.elements;return ue(n,(function(e,t){var i=(s=e.shared).isBufferArgs,s=s.elements,o=e.invoke(t,n),a=t.def("null");return i=t.def(i,"(",o,")"),o=e.cond(i).then(a,"=",s,".createStream(",o,");").else(a,"=",s,".getElements(",o,");"),t.entry(o),t.exit(e.cond(i).then(s,".destroyStream(",a,");")),e.ELEMENTS=a}))}return l?new oe(h.thisDep,h.contextDep,h.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.elements+".getElements("+e.shared.vao+".currentVAO.elements):null")})):null}(),g=n("offset",!0),m=function(){if("primitive"in i){var e=i.primitive;return a.primitive=e,he((function(t,n){return Oe[e]}))}if("primitive"in s){var t=s.primitive;return ue(t,(function(e,n){var i=e.constants.primTypes,s=e.invoke(n,t);return n.def(i,"[",s,"]")}))}return u?le(f)?he(f.value?function(e,t){return t.def(e.ELEMENTS,".primType")}:function(){return 4}):new oe(f.thisDep,f.contextDep,f.propDep,(function(e,t){var n=e.ELEMENTS;return t.def(n,"?",n,".primType:",4)})):l?new oe(h.thisDep,h.contextDep,h.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.primitive:4")})):null}(),A=function(){if("count"in i){var e=0|i.count;return a.count=e,he((function(){return e}))}if("count"in s){var t=s.count;return ue(t,(function(e,n){return e.invoke(n,t)}))}return u?le(f)?f?g?new oe(g.thisDep,g.contextDep,g.propDep,(function(e,t){return t.def(e.ELEMENTS,".vertCount-",e.OFFSET)})):he((function(e,t){return t.def(e.ELEMENTS,".vertCount")})):he((function(){return-1})):new oe(f.thisDep||g.thisDep,f.contextDep||g.contextDep,f.propDep||g.propDep,(function(e,t){var n=e.ELEMENTS;return e.OFFSET?t.def(n,"?",n,".vertCount-",e.OFFSET,":-1"):t.def(n,"?",n,".vertCount:-1")})):l?new oe(h.thisDep,h.contextDep,h.propDep,(function(e,t){return t.def(e.shared.vao,".currentVAO?",e.shared.vao,".currentVAO.count:-1")})):null}(),w=n("instances",!1);return{elements:f,primitive:m,count:A,instances:w,offset:g,vao:h,vaoActive:l,elementsActive:u,static:a}}function U(e,t){var n=e.static,i=e.dynamic,s={};return De.forEach((function(e){function t(t,a){if(e in n){var l=t(n[e]);s[o]=he((function(){return l}))}else if(e in i){var h=i[e];s[o]=ue(h,(function(e,t){return a(e,t,e.invoke(t,h))}))}}var o=T(e);switch(e){case"cull.enable":case"blend.enable":case"dither":case"stencil.enable":case"depth.enable":case"scissor.enable":case"polygonOffset.enable":case"sample.alpha":case"sample.enable":case"depth.mask":case"lineWidth":return t((function(e){return e}),(function(e,t,n){return n}));case"depth.func":return t((function(e){return et[e]}),(function(e,t,n){return t.def(e.constants.compareFuncs,"[",n,"]")}));case"depth.range":return t((function(e){return e}),(function(e,t,n){return[t.def("+",n,"[0]"),t=t.def("+",n,"[1]")]}));case"blend.func":return t((function(e){return[Ke["srcRGB"in e?e.srcRGB:e.src],Ke["dstRGB"in e?e.dstRGB:e.dst],Ke["srcAlpha"in e?e.srcAlpha:e.src],Ke["dstAlpha"in e?e.dstAlpha:e.dst]]}),(function(e,t,n){function i(e,i){return t.def('"',e,i,'" in ',n,"?",n,".",e,i,":",n,".",e)}e=e.constants.blendFuncs;var s=i("src","RGB"),o=i("dst","RGB"),a=(s=t.def(e,"[",s,"]"),t.def(e,"[",i("src","Alpha"),"]"));return[s,o=t.def(e,"[",o,"]"),a,e=t.def(e,"[",i("dst","Alpha"),"]")]}));case"blend.equation":return t((function(e){return"string"==typeof e?[Pe[e],Pe[e]]:"object"==typeof e?[Pe[e.rgb],Pe[e.alpha]]:void 0}),(function(e,t,n){var i=e.constants.blendEquations,s=t.def(),o=t.def();return(e=e.cond("typeof ",n,'==="string"')).then(s,"=",o,"=",i,"[",n,"];"),e.else(s,"=",i,"[",n,".rgb];",o,"=",i,"[",n,".alpha];"),t(e),[s,o]}));case"blend.color":return t((function(e){return f(4,(function(t){return+e[t]}))}),(function(e,t,n){return f(4,(function(e){return t.def("+",n,"[",e,"]")}))}));case"stencil.mask":return t((function(e){return 0|e}),(function(e,t,n){return t.def(n,"|0")}));case"stencil.func":return t((function(e){return[et[e.cmp||"keep"],e.ref||0,"mask"in e?e.mask:-1]}),(function(e,t,n){return[e=t.def('"cmp" in ',n,"?",e.constants.compareFuncs,"[",n,".cmp]",":",7680),t.def(n,".ref|0"),t=t.def('"mask" in ',n,"?",n,".mask|0:-1")]}));case"stencil.opFront":case"stencil.opBack":return t((function(t){return["stencil.opBack"===e?1029:1028,tt[t.fail||"keep"],tt[t.zfail||"keep"],tt[t.zpass||"keep"]]}),(function(t,n,i){function s(e){return n.def('"',e,'" in ',i,"?",o,"[",i,".",e,"]:",7680)}var o=t.constants.stencilOps;return["stencil.opBack"===e?1029:1028,s("fail"),s("zfail"),s("zpass")]}));case"polygonOffset.offset":return t((function(e){return[0|e.factor,0|e.units]}),(function(e,t,n){return[t.def(n,".factor|0"),t=t.def(n,".units|0")]}));case"cull.face":return t((function(e){var t=0;return"front"===e?t=1028:"back"===e&&(t=1029),t}),(function(e,t,n){return t.def(n,'==="front"?',1028,":",1029)}));case"frontFace":return t((function(e){return nt[e]}),(function(e,t,n){return t.def(n+'==="cw"?2304:2305')}));case"colorMask":return t((function(e){return e.map((function(e){return!!e}))}),(function(e,t,n){return f(4,(function(e){return"!!"+n+"["+e+"]"}))}));case"sample.coverage":return t((function(e){return["value"in e?e.value:1,!!e.invert]}),(function(e,t,n){return[t.def('"value" in ',n,"?+",n,".value:1"),t=t.def("!!",n,".invert")]}))}})),s}function j(e,t){var n=e.static,i=e.dynamic,s={};return Object.keys(n).forEach((function(e){var t,i=n[e];if("number"==typeof i||"boolean"==typeof i)t=he((function(){return i}));else if("function"==typeof i){var o=i._reglType;"texture2d"===o||"textureCube"===o?t=he((function(e){return e.link(i)})):"framebuffer"!==o&&"framebufferCube"!==o||(t=he((function(e){return e.link(i.color[0])})))}else H(i)&&(t=he((function(e){return e.global.def("[",f(i.length,(function(e){return i[e]})),"]")})));t.value=i,s[e]=t})),Object.keys(i).forEach((function(e){var t=i[e];s[e]=ue(t,(function(e,n){return e.invoke(n,t)}))})),s}function W(e,n){var i=e.static,o=e.dynamic,a={};return Object.keys(i).forEach((function(e){var n=i[e],o=t.id(e),l=new Ce;if(re(n))l.state=1,l.buffer=s.getBuffer(s.create(n,34962,!1,!0)),l.type=0;else if(c=s.getBuffer(n))l.state=1,l.buffer=c,l.type=0;else if("constant"in n){var h=n.constant;l.buffer="null",l.state=2,"number"==typeof h?l.x=h:Je.forEach((function(e,t){t<h.length&&(l[e]=h[t])}))}else{var c=re(n.buffer)?s.getBuffer(s.create(n.buffer,34962,!1,!0)):s.getBuffer(n.buffer),u=0|n.offset,f=0|n.stride,g=0|n.size,m=!!n.normalized,A=0;"type"in n&&(A=Me[n.type]),n=0|n.divisor,l.buffer=c,l.state=1,l.size=g,l.normalized=m,l.type=A||c.dtype,l.offset=u,l.stride=f,l.divisor=n}a[e]=he((function(e,t){var n=e.attribCache;if(o in n)return n[o];var i={isStream:!1};return Object.keys(l).forEach((function(e){i[e]=l[e]})),l.buffer&&(i.buffer=e.link(l.buffer),i.type=i.type||i.buffer+".dtype"),n[o]=i}))})),Object.keys(o).forEach((function(e){var t=o[e];a[e]=ue(t,(function(e,n){function i(e){n(h[e],"=",s,".",e,"|0;")}var s=e.invoke(n,t),o=e.constants,a=(l=e.shared).isBufferArgs,l=l.buffer,h={isStream:n.def(!1)},c=new Ce;c.state=1,Object.keys(c).forEach((function(e){h[e]=n.def(""+c[e])}));var u=h.buffer,f=h.type;return n("if(",a,"(",s,")){",h.isStream,"=true;",u,"=",l,".createStream(",34962,",",s,");",f,"=",u,".dtype;","}else{",u,"=",l,".getBuffer(",s,");","if(",u,"){",f,"=",u,".dtype;",'}else if("constant" in ',s,"){",h.state,"=",2,";","if(typeof "+s+'.constant === "number"){',h[Je[0]],"=",s,".constant;",Je.slice(1).map((function(e){return h[e]})).join("="),"=0;","}else{",Je.map((function(e,t){return h[e]+"="+s+".constant.length>"+t+"?"+s+".constant["+t+"]:0;"})).join(""),"}}else{","if(",a,"(",s,".buffer)){",u,"=",l,".createStream(",34962,",",s,".buffer);","}else{",u,"=",l,".getBuffer(",s,".buffer);","}",f,'="type" in ',s,"?",o.glTypes,"[",s,".type]:",u,".dtype;",h.normalized,"=!!",s,".normalized;"),i("size"),i("offset"),i("stride"),i("divisor"),n("}}"),n.exit("if(",h.isStream,"){",l,".destroyStream(",u,");","}"),h}))})),a}function q(e){var t=e.static,n=e.dynamic,i={};return Object.keys(t).forEach((function(e){var n=t[e];i[e]=he((function(e,t){return"number"==typeof n||"boolean"==typeof n?""+n:e.link(n)}))})),Object.keys(n).forEach((function(e){var t=n[e];i[e]=ue(t,(function(e,n){return e.invoke(n,t)}))})),i}function Z(e,t,i,s,o){function a(e){var t=h[e];t&&(f[e]=t)}var l=N(e,t),h=D(e,m=E(e)),u=z(e),f=U(e),g=B(e,o,l);a("viewport"),a(T("scissor.box"));var m,A=0<Object.keys(f).length;if((m={framebuffer:m,draw:u,shader:g,state:f,dirty:A,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}}).profile=I(e),m.uniforms=j(i),m.drawVAO=m.scopeVAO=u.vao,!m.drawVAO&&g.program&&!l&&n.angle_instanced_arrays&&u.static.elements){var w=!0;if(e=g.program.attributes.map((function(e){return e=t.static[e],w=w&&!!e,e})),w&&0<e.length){var S=c.getVAO(c.createVAO({attributes:e,elements:u.static.elements}));m.drawVAO=new oe(null,null,null,(function(e,t){return e.link(S)})),m.useVAO=!0}}return l?m.useVAO=!0:m.attributes=W(t),m.context=q(s),m}function X(e,t,n){var i=e.shared.context,s=e.scope();Object.keys(n).forEach((function(o){t.save(i,"."+o);var a=n[o].append(e,t);Array.isArray(a)?s(i,".",o,"=[",a.join(),"];"):s(i,".",o,"=",a,";")})),t(s)}function Y(e,t,n,i){var s,o=(l=e.shared).gl,a=l.framebuffer;ke&&(s=t.def(l.extensions,".webgl_draw_buffers"));var l=(h=e.constants).drawBuffer,h=h.backBuffer;e=n?n.append(e,t):t.def(a,".next"),i||t("if(",e,"!==",a,".cur){"),t("if(",e,"){",o,".bindFramebuffer(",36160,",",e,".framebuffer);"),ke&&t(s,".drawBuffersWEBGL(",l,"[",e,".colorAttachments.length]);"),t("}else{",o,".bindFramebuffer(",36160,",null);"),ke&&t(s,".drawBuffersWEBGL(",h,");"),t("}",a,".cur=",e,";"),i||t("}")}function J(e,t,n){var i=e.shared,s=i.gl,o=e.current,a=e.next,l=i.current,h=i.next,c=e.cond(l,".dirty");De.forEach((function(t){var i,u;if(!((t=T(t))in n.state))if(t in a){i=a[t],u=o[t];var g=f(Re[t].length,(function(e){return c.def(i,"[",e,"]")}));c(e.cond(g.map((function(e,t){return e+"!=="+u+"["+t+"]"})).join("||")).then(s,".",He[t],"(",g,");",g.map((function(e,t){return u+"["+t+"]="+e})).join(";"),";"))}else i=c.def(h,".",t),g=e.cond(i,"!==",l,".",t),c(g),t in Fe?g(e.cond(i).then(s,".enable(",Fe[t],");").else(s,".disable(",Fe[t],");"),l,".",t,"=",i,";"):g(s,".",He[t],"(",i,");",l,".",t,"=",i,";")})),0===Object.keys(n.state).length&&c(l,".dirty=false;"),t(c)}function Q(e,t,n,i){var s=e.shared,o=e.current,a=s.current,l=s.gl;se(Object.keys(n)).forEach((function(s){var h=n[s];if(!i||i(h)){var c=h.append(e,t);if(Fe[s]){var u=Fe[s];le(h)?t(l,c?".enable(":".disable(",u,");"):t(e.cond(c).then(l,".enable(",u,");").else(l,".disable(",u,");")),t(a,".",s,"=",c,";")}else if(H(c)){var f=o[s];t(l,".",He[s],"(",c,");",c.map((function(e,t){return f+"["+t+"]="+e})).join(";"),";")}else t(l,".",He[s],"(",c,");",a,".",s,"=",c,";")}}))}function $(e,t){Ie&&(e.instancing=t.def(e.shared.extensions,".angle_instanced_arrays"))}function K(e,t,n,i,s){function o(){return"undefined"==typeof performance?"Date.now()":"performance.now()"}function a(e){e(c=t.def(),"=",o(),";"),"string"==typeof s?e(g,".count+=",s,";"):e(g,".count++;"),A&&(i?e(u=t.def(),"=",w,".getNumPendingQueries();"):e(w,".beginQuery(",g,");"))}function l(e){e(g,".cpuTime+=",o(),"-",c,";"),A&&(i?e(w,".pushScopeStats(",u,",",w,".getNumPendingQueries(),",g,");"):e(w,".endQuery();"))}function h(e){var n=t.def(m,".profile");t(m,".profile=",e,";"),t.exit(m,".profile=",n,";")}var c,u,f=e.shared,g=e.stats,m=f.current,w=f.timer;if(n=n.profile){if(le(n))return void(n.enable?(a(t),l(t.exit),h("true")):h("false"));h(n=n.append(e,t))}else n=t.def(m,".profile");a(f=e.block()),t("if(",n,"){",f,"}"),l(e=e.block()),t.exit("if(",n,"){",e,"}")}function ee(e,t,n,i,s){function o(e){switch(e){case 35664:case 35667:case 35671:return 2;case 35665:case 35668:case 35672:return 3;case 35666:case 35669:case 35673:return 4;default:return 1}}function a(n,i,s){function o(){t(h,".enableVertexAttribArray(",c,");");var n,o=s.type;n=s.size?t.def(s.size,"||",i):i,t(h,".bindBuffer(",34962,",",f,".buffer);",h,".vertexAttribPointer(",[c,n,o,s.normalized,s.stride,s.offset],");",u,".type=",o,";",u,".size=",n,";",m.map((function(e){return u+"."+e+"="+s[e]+";"})).join("")),Ie&&t("if(",u,".divisor!==",o=s.divisor,"){",e.instancing,".vertexAttribDivisorANGLE(",[c,o],");",u,".divisor=",o,";}")}function a(){t("if(",u,".buffer){",h,".disableVertexAttribArray(",c,");",u,".buffer=null;","}if(",Je.map((function(e,t){return u+"."+e+"!=="+g[t]})).join("||"),"){",h,".vertexAttrib4f(",c,",",g,");",Je.map((function(e,t){return u+"."+e+"="+g[t]+";"})).join(""),"}")}var h=l.gl,c=t.def(n,".location"),u=t.def(l.attributes,"[",c,"]"),f=s.buffer,g=[s.x,s.y,s.z,s.w],m=["buffer","normalized","offset","stride"];1===(n=s.state)?o():2===n?a():(t("if(",n,"===",1,"){"),o(),t("}else{"),a(),t("}"))}var l=e.shared;i.forEach((function(i){var l,h=i.name,c=n.attributes[h];if(c){if(!s(c))return;l=c.append(e,t)}else{if(!s(rt))return;var u=e.scopeAttrib(h);l={},Object.keys(new Ce).forEach((function(e){l[e]=t.def(u,".",e)}))}a(e.link(i),o(i.info.type),l)}))}function fe(e,n,i,s,o,a){for(var l,h=e.shared,c=h.gl,u={},g=0;g<s.length;++g){var m=(M=s[g]).name,A=M.info.type,w=i.uniforms[m];if(1<(E=M.info.size)){if(!w)continue;var T=m.replace("[0]","");if(u[T])continue;u[T]=1}var S,M=e.link(M)+".location";if(w){if(!o(w))continue;if(le(w)){if(m=w.value,35678===A||35680===A)n(c,".uniform1i(",M,",",(A=e.link(m._texture||m.color[0]._texture))+".bind());"),n.exit(A,".unbind();");else if(35674===A||35675===A||35676===A)E=e.global.def("new Float32Array(["+Array.prototype.slice.call(m)+"])"),m=2,35675===A?m=3:35676===A&&(m=4),n(c,".uniformMatrix",m,"fv(",M,",false,",E,");");else{switch(A){case 5126:l="1f";break;case 35664:l="2f";break;case 35665:l="3f";break;case 35666:l="4f";break;case 35670:case 5124:l="1i";break;case 35671:case 35667:l="2i";break;case 35672:case 35668:l="3i";break;case 35673:case 35669:l="4i"}1<E?(l+="v",m=e.global.def("["+Array.prototype.slice.call(m)+"]")):m=H(m)?Array.prototype.slice.call(m):m,n(c,".uniform",l,"(",M,",",m,");")}continue}S=w.append(e,n)}else{if(!o(rt))continue;S=n.def(h.uniforms,"[",t.id(m),"]")}switch(35678===A?n("if(",S,"&&",S,'._reglType==="framebuffer"){',S,"=",S,".color[0];","}"):35680===A&&n("if(",S,"&&",S,'._reglType==="framebufferCube"){',S,"=",S,".color[0];","}"),m=1,A){case 35678:case 35680:A=n.def(S,"._texture"),n(c,".uniform1i(",M,",",A,".bind());"),n.exit(A,".unbind();");continue;case 5124:case 35670:l="1i";break;case 35667:case 35671:l="2i",m=2;break;case 35668:case 35672:l="3i",m=3;break;case 35669:case 35673:l="4i",m=4;break;case 5126:l="1f";break;case 35664:l="2f",m=2;break;case 35665:l="3f",m=3;break;case 35666:l="4f",m=4;break;case 35674:l="Matrix2fv";break;case 35675:l="Matrix3fv";break;case 35676:l="Matrix4fv"}if(-1===l.indexOf("Matrix")&&1<E&&(l+="v",m=1),"M"===l.charAt(0)){n(c,".uniform",l,"(",M,","),M=Math.pow(A-35674+2,2);var C=e.global.def("new Float32Array(",M,")");Array.isArray(S)?n("false,(",f(M,(function(e){return C+"["+e+"]="+S[e]})),",",C,")"):n("false,(Array.isArray(",S,")||",S," instanceof Float32Array)?",S,":(",f(M,(function(e){return C+"["+e+"]="+S+"["+e+"]"})),",",C,")"),n(");")}else{if(1<m){A=[];for(var I=[],E=0;E<m;++E)Array.isArray(S)?I.push(S[E]):I.push(n.def(S+"["+E+"]")),a&&A.push(n.def());a&&n("if(!",e.batchId,"||",A.map((function(e,t){return e+"!=="+I[t]})).join("||"),"){",A.map((function(e,t){return e+"="+I[t]+";"})).join("")),n(c,".uniform",l,"(",M,",",I.join(","),");")}else a&&(A=n.def(),n("if(!",e.batchId,"||",A,"!==",S,"){",A,"=",S,";")),n(c,".uniform",l,"(",M,",",S,");");a&&n("}")}}}function de(e,t,n,i){function s(s){var o=g[s];return o?o.append(e,o.contextDep&&i.contextDynamic||o.propDep?n:t):t.def(f,".",s)}function o(){function e(){n(h,".drawElementsInstancedANGLE(",[A,T,S,w+"<<(("+S+"-5121)>>1)",l],");")}function t(){n(h,".drawArraysInstancedANGLE(",[A,w,T,l],");")}m&&"null"!==m?M?e():(n("if(",m,"){"),e(),n("}else{"),t(),n("}")):t()}function a(){function e(){n(u+".drawElements("+[A,T,S,w+"<<(("+S+"-5121)>>1)"]+");")}function t(){n(u+".drawArrays("+[A,w,T]+");")}m&&"null"!==m?M?e():(n("if(",m,"){"),e(),n("}else{"),t(),n("}")):t()}var l,h,c=e.shared,u=c.gl,f=c.draw,g=i.draw,m=function(){var s=g.elements,o=t;return s?((s.contextDep&&i.contextDynamic||s.propDep)&&(o=n),s=s.append(e,o),g.elementsActive&&o("if("+s+")"+u+".bindBuffer(34963,"+s+".buffer.buffer);")):(s=o.def(),o(s,"=",f,".","elements",";","if(",s,"){",u,".bindBuffer(",34963,",",s,".buffer.buffer);}","else if(",c.vao,".currentVAO){",s,"=",e.shared.elements+".getElements("+c.vao,".currentVAO.elements);",Ee?"":"if("+s+")"+u+".bindBuffer(34963,"+s+".buffer.buffer);","}")),s}(),A=s("primitive"),w=s("offset"),T=function(){var s=g.count,o=t;return s?((s.contextDep&&i.contextDynamic||s.propDep)&&(o=n),s=s.append(e,o)):s=o.def(f,".","count"),s}();if("number"==typeof T){if(0===T)return}else n("if(",T,"){"),n.exit("}");Ie&&(l=s("instances"),h=e.instancing);var S=m+".type",M=g.elements&&le(g.elements)&&!g.vaoActive;Ie&&("number"!=typeof l||0<=l)?"string"==typeof l?(n("if(",l,">0){"),o(),n("}else if(",l,"<0){"),a(),n("}")):o():a()}function me(e,t,n,i,s){return s=(t=C()).proc("body",s),Ie&&(t.instancing=s.def(t.shared.extensions,".angle_instanced_arrays")),e(t,s,n,i),t.compile().body}function ye(e,t,n,i){$(e,t),n.useVAO?n.drawVAO?t(e.shared.vao,".setVAO(",n.drawVAO.append(e,t),");"):t(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(t(e.shared.vao,".setVAO(null);"),ee(e,t,n,i.attributes,(function(){return!0}))),fe(e,t,n,i.uniforms,(function(){return!0}),!1),de(e,t,t,n)}function _e(e,t){var n=e.proc("draw",1);$(e,n),X(e,n,t.context),Y(e,n,t.framebuffer),J(e,n,t),Q(e,n,t.state),K(e,n,t,!1,!0);var i=t.shader.progVar.append(e,n);if(n(e.shared.gl,".useProgram(",i,".program);"),t.shader.program)ye(e,n,t,t.shader.program);else{n(e.shared.vao,".setVAO(null);");var s=e.global.def("{}"),o=n.def(i,".id"),a=n.def(s,"[",o,"]");n(e.cond(a).then(a,".call(this,a0);").else(a,"=",s,"[",o,"]=",e.link((function(n){return me(ye,e,t,n,1)})),"(",i,");",a,".call(this,a0);"))}0<Object.keys(t.state).length&&n(e.shared.current,".dirty=true;"),e.shared.vao&&n(e.shared.vao,".setVAO(null);")}function ve(e,t,n,i){function s(){return!0}e.batchId="a1",$(e,t),ee(e,t,n,i.attributes,s),fe(e,t,n,i.uniforms,s,!1),de(e,t,t,n)}function xe(e,t,n,i){function s(e){return e.contextDep&&a||e.propDep}function o(e){return!s(e)}$(e,t);var a=n.contextDep,l=t.def(),h=t.def();e.shared.props=h,e.batchId=l;var c=e.scope(),u=e.scope();t(c.entry,"for(",l,"=0;",l,"<","a1",";++",l,"){",h,"=","a0","[",l,"];",u,"}",c.exit),n.needsContext&&X(e,u,n.context),n.needsFramebuffer&&Y(e,u,n.framebuffer),Q(e,u,n.state,s),n.profile&&s(n.profile)&&K(e,u,n,!1,!0),i?(n.useVAO?n.drawVAO?s(n.drawVAO)?u(e.shared.vao,".setVAO(",n.drawVAO.append(e,u),");"):c(e.shared.vao,".setVAO(",n.drawVAO.append(e,c),");"):c(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(c(e.shared.vao,".setVAO(null);"),ee(e,c,n,i.attributes,o),ee(e,u,n,i.attributes,s)),fe(e,c,n,i.uniforms,o,!1),fe(e,u,n,i.uniforms,s,!0),de(e,c,u,n)):(t=e.global.def("{}"),i=n.shader.progVar.append(e,u),h=u.def(i,".id"),c=u.def(t,"[",h,"]"),u(e.shared.gl,".useProgram(",i,".program);","if(!",c,"){",c,"=",t,"[",h,"]=",e.link((function(t){return me(ve,e,n,t,2)})),"(",i,");}",c,".call(this,a0[",l,"],",l,");"))}function be(e,t){function n(e){return e.contextDep&&s||e.propDep}var i=e.proc("batch",2);e.batchId="0",$(e,i);var s=!1,o=!0;Object.keys(t.context).forEach((function(e){s=s||t.context[e].propDep})),s||(X(e,i,t.context),o=!1);var a=!1;if((l=t.framebuffer)?(l.propDep?s=a=!0:l.contextDep&&s&&(a=!0),a||Y(e,i,l)):Y(e,i,null),t.state.viewport&&t.state.viewport.propDep&&(s=!0),J(e,i,t),Q(e,i,t.state,(function(e){return!n(e)})),t.profile&&n(t.profile)||K(e,i,t,!1,"a1"),t.contextDep=s,t.needsContext=o,t.needsFramebuffer=a,(o=t.shader.progVar).contextDep&&s||o.propDep)xe(e,i,t,null);else if(o=o.append(e,i),i(e.shared.gl,".useProgram(",o,".program);"),t.shader.program)xe(e,i,t,t.shader.program);else{i(e.shared.vao,".setVAO(null);");var l=e.global.def("{}"),h=(a=i.def(o,".id"),i.def(l,"[",a,"]"));i(e.cond(h).then(h,".call(this,a0,a1);").else(h,"=",l,"[",a,"]=",e.link((function(n){return me(xe,e,t,n,2)})),"(",o,");",h,".call(this,a0,a1);"))}0<Object.keys(t.state).length&&i(e.shared.current,".dirty=true;"),e.shared.vao&&i(e.shared.vao,".setVAO(null);")}function we(e,n){function i(t){var i=n.shader[t];i&&s.set(o.shader,"."+t,i.append(e,s))}var s=e.proc("scope",3);e.batchId="a2";var o=e.shared,a=o.current;X(e,s,n.context),n.framebuffer&&n.framebuffer.append(e,s),se(Object.keys(n.state)).forEach((function(t){var i=n.state[t].append(e,s);H(i)?i.forEach((function(n,i){s.set(e.next[t],"["+i+"]",n)})):s.set(o.next,"."+t,i)})),K(e,s,n,!0,!0),["elements","offset","count","instances","primitive"].forEach((function(t){var i=n.draw[t];i&&s.set(o.draw,"."+t,""+i.append(e,s))})),Object.keys(n.uniforms).forEach((function(i){var a=n.uniforms[i].append(e,s);Array.isArray(a)&&(a="["+a.join()+"]"),s.set(o.uniforms,"["+t.id(i)+"]",a)})),Object.keys(n.attributes).forEach((function(t){var i=n.attributes[t].append(e,s),o=e.scopeAttrib(t);Object.keys(new Ce).forEach((function(e){s.set(o,"."+e,i[e])}))})),n.scopeVAO&&s.set(o.vao,".targetVAO",n.scopeVAO.append(e,s)),i("vert"),i("frag"),0<Object.keys(n.state).length&&(s(a,".dirty=true;"),s.exit(a,".dirty=true;")),s("a1(",e.shared.context,",a0,",e.batchId,");")}function Te(e){if("object"==typeof e&&!H(e)){for(var t=Object.keys(e),n=0;n<t.length;++n)if(Ae.isDynamic(e[t[n]]))return!0;return!1}}function Se(e,t,n){function i(e,t){a.forEach((function(n){var i=s[n];Ae.isDynamic(i)&&(i=e.invoke(t,i),t(u,".",n,"=",i,";"))}))}var s=t.static[n];if(s&&Te(s)){var o=e.global,a=Object.keys(s),l=!1,h=!1,c=!1,u=e.global.def("{}");a.forEach((function(t){var n=s[t];if(Ae.isDynamic(n))"function"==typeof n&&(n=s[t]=Ae.unbox(n)),t=ue(n,null),l=l||t.thisDep,c=c||t.propDep,h=h||t.contextDep;else{switch(o(u,".",t,"="),typeof n){case"number":o(n);break;case"string":o('"',n,'"');break;case"object":Array.isArray(n)&&o("[",n.join(),"]");break;default:o(e.link(n))}o(";")}})),t.dynamic[n]=new Ae.DynamicVariable(4,{thisDep:l,contextDep:h,propDep:c,ref:u,append:i}),delete t.static[n]}}var Ce=c.Record,Pe={add:32774,subtract:32778,"reverse subtract":32779};n.ext_blend_minmax&&(Pe.min=32775,Pe.max=32776);var Ie=n.angle_instanced_arrays,ke=n.webgl_draw_buffers,Ee=n.oes_vertex_array_object,Re={dirty:!0,profile:w.profile},Le={},De=[],Fe={},He={};S("dither",3024),S("blend.enable",3042),M("blend.color","blendColor",[0,0,0,0]),M("blend.equation","blendEquationSeparate",[32774,32774]),M("blend.func","blendFuncSeparate",[1,0,1,0]),S("depth.enable",2929,!0),M("depth.func","depthFunc",513),M("depth.range","depthRange",[0,1]),M("depth.mask","depthMask",!0),M("colorMask","colorMask",[!0,!0,!0,!0]),S("cull.enable",2884),M("cull.face","cullFace",1029),M("frontFace","frontFace",2305),M("lineWidth","lineWidth",1),S("polygonOffset.enable",32823),M("polygonOffset.offset","polygonOffset",[0,0]),S("sample.alpha",32926),S("sample.enable",32928),M("sample.coverage","sampleCoverage",[1,!1]),S("stencil.enable",2960),M("stencil.mask","stencilMask",-1),M("stencil.func","stencilFunc",[519,0,-1]),M("stencil.opFront","stencilOpSeparate",[1028,7680,7680,7680]),M("stencil.opBack","stencilOpSeparate",[1029,7680,7680,7680]),S("scissor.enable",3089),M("scissor.box","scissor",[0,0,e.drawingBufferWidth,e.drawingBufferHeight]),M("viewport","viewport",[0,0,e.drawingBufferWidth,e.drawingBufferHeight]);var Ne={gl:e,context:m,strings:t,next:Le,current:Re,draw:g,elements:o,buffer:s,shader:u,attributes:c.state,vao:c,uniforms:h,framebuffer:l,extensions:n,timer:A,isBufferArgs:re},Be={primTypes:Oe,compareFuncs:et,blendFuncs:Ke,blendEquations:Pe,stencilOps:tt,glTypes:Me,orientationType:nt};ke&&(Be.backBuffer=[1029],Be.drawBuffer=f(i.maxDrawbuffers,(function(e){return 0===e?[0]:f(e,(function(e){return 36064+e}))})));var ze=0;return{next:Le,current:Re,procs:function(){var e=C(),t=e.proc("poll"),s=e.proc("refresh"),o=e.block();t(o),s(o);var a,l=e.shared,h=l.gl,c=l.next,u=l.current;o(u,".dirty=false;"),Y(e,t),Y(e,s,null,!0),Ie&&(a=e.link(Ie)),n.oes_vertex_array_object&&s(e.link(n.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var g=0;g<i.maxAttributes;++g){var m=s.def(l.attributes,"[",g,"]"),A=e.cond(m,".buffer");A.then(h,".enableVertexAttribArray(",g,");",h,".bindBuffer(",34962,",",m,".buffer.buffer);",h,".vertexAttribPointer(",g,",",m,".size,",m,".type,",m,".normalized,",m,".stride,",m,".offset);").else(h,".disableVertexAttribArray(",g,");",h,".vertexAttrib4f(",g,",",m,".x,",m,".y,",m,".z,",m,".w);",m,".buffer=null;"),s(A),Ie&&s(a,".vertexAttribDivisorANGLE(",g,",",m,".divisor);")}return s(e.shared.vao,".currentVAO=null;",e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"),Object.keys(Fe).forEach((function(n){var i=Fe[n],a=o.def(c,".",n),l=e.block();l("if(",a,"){",h,".enable(",i,")}else{",h,".disable(",i,")}",u,".",n,"=",a,";"),s(l),t("if(",a,"!==",u,".",n,"){",l,"}")})),Object.keys(He).forEach((function(n){var i,a,l=He[n],g=Re[n],m=e.block();m(h,".",l,"("),H(g)?(l=g.length,i=e.global.def(c,".",n),a=e.global.def(u,".",n),m(f(l,(function(e){return i+"["+e+"]"})),");",f(l,(function(e){return a+"["+e+"]="+i+"["+e+"];"})).join("")),t("if(",f(l,(function(e){return i+"["+e+"]!=="+a+"["+e+"]"})).join("||"),"){",m,"}")):(i=o.def(c,".",n),a=o.def(u,".",n),m(i,");",u,".",n,"=",i,";"),t("if(",i,"!==",a,"){",m,"}")),s(m)})),e.compile()}(),compile:function(e,t,n,i,s){var o=C();o.stats=o.link(s),Object.keys(t.static).forEach((function(e){Se(o,t,e)})),$e.forEach((function(t){Se(o,e,t)}));var a=Z(e,t,n,i,o);return _e(o,a),we(o,a),be(o,a),pe(o.compile(),{destroy:function(){a.shader.program.destroy()}})}}}function de(e,t){for(var n=0;n<e.length;++n)if(e[n]===t)return n;return-1}var pe=function(e,t){for(var n=Object.keys(t),i=0;i<n.length;++i)e[n[i]]=t[n[i]];return e},me=0,Ae={DynamicVariable:e,define:function(t,i){return new e(t,n(i+""))},isDynamic:function(t){return"function"==typeof t&&!t._reglType||t instanceof e},unbox:i,accessor:n},ye={next:"function"==typeof requestAnimationFrame?function(e){return requestAnimationFrame(e)}:function(e){return setTimeout(e,16)},cancel:"function"==typeof cancelAnimationFrame?function(e){return cancelAnimationFrame(e)}:clearTimeout},_e="undefined"!=typeof performance&&performance.now?function(){return performance.now()}:function(){return+new Date},ve=m();ve.zero=m();var xe=function(e,t){var n=1;t.ext_texture_filter_anisotropic&&(n=e.getParameter(34047));var i=1,s=1;t.webgl_draw_buffers&&(i=e.getParameter(34852),s=e.getParameter(36063));var o=!!t.oes_texture_float;if(o){o=e.createTexture(),e.bindTexture(3553,o),e.texImage2D(3553,0,6408,1,1,0,6408,5126,null);var a=e.createFramebuffer();if(e.bindFramebuffer(36160,a),e.framebufferTexture2D(36160,36064,3553,o,0),e.bindTexture(3553,null),36053!==e.checkFramebufferStatus(36160))o=!1;else{e.viewport(0,0,1,1),e.clearColor(1,0,0,1),e.clear(16384);var l=ve.allocType(5126,4);e.readPixels(0,0,1,1,6408,5126,l),e.getError()?o=!1:(e.deleteFramebuffer(a),e.deleteTexture(o),o=1===l[0]),ve.freeType(l)}}return l=!0,"undefined"!=typeof navigator&&(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent))||(l=e.createTexture(),a=ve.allocType(5121,36),e.activeTexture(33984),e.bindTexture(34067,l),e.texImage2D(34069,0,6408,3,3,0,6408,5121,a),ve.freeType(a),e.bindTexture(34067,null),e.deleteTexture(l),l=!e.getError()),{colorBits:[e.getParameter(3410),e.getParameter(3411),e.getParameter(3412),e.getParameter(3413)],depthBits:e.getParameter(3414),stencilBits:e.getParameter(3415),subpixelBits:e.getParameter(3408),extensions:Object.keys(t).filter((function(e){return!!t[e]})),maxAnisotropic:n,maxDrawbuffers:i,maxColorAttachments:s,pointSizeDims:e.getParameter(33901),lineWidthDims:e.getParameter(33902),maxViewportDims:e.getParameter(3386),maxCombinedTextureUnits:e.getParameter(35661),maxCubeMapSize:e.getParameter(34076),maxRenderbufferSize:e.getParameter(34024),maxTextureUnits:e.getParameter(34930),maxTextureSize:e.getParameter(3379),maxAttributes:e.getParameter(34921),maxVertexUniforms:e.getParameter(36347),maxVertexTextureUnits:e.getParameter(35660),maxVaryingVectors:e.getParameter(36348),maxFragmentUniforms:e.getParameter(36349),glsl:e.getParameter(35724),renderer:e.getParameter(7937),vendor:e.getParameter(7936),version:e.getParameter(7938),readFloat:o,npotTextureCube:l}},be=function(e){return e instanceof Uint8Array||e instanceof Uint16Array||e instanceof Uint32Array||e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Float32Array||e instanceof Float64Array||e instanceof Uint8ClampedArray},we=function(e){return Object.keys(e).map((function(t){return e[t]}))},Te={shape:function(e){for(var t=[];e.length;e=e[0])t.push(e.length);return t},flatten:function(e,t,n,i){var s=1;if(t.length)for(var o=0;o<t.length;++o)s*=t[o];else s=0;switch(n=i||ve.allocType(n,s),t.length){case 0:break;case 1:for(i=t[0],t=0;t<i;++t)n[t]=e[t];break;case 2:for(i=t[0],t=t[1],o=s=0;o<i;++o)for(var a=e[o],l=0;l<t;++l)n[s++]=a[l];break;case 3:w(e,t[0],t[1],t[2],n,0);break;default:T(e,t,0,n,0)}return n}},Se={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},Me={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126},Ce={dynamic:35048,stream:35040,static:35044},Pe=Te.flatten,Ie=Te.shape,ke=[];ke[5120]=1,ke[5122]=2,ke[5124]=4,ke[5121]=1,ke[5123]=2,ke[5125]=4,ke[5126]=4;var Oe={points:0,point:0,lines:1,line:1,triangles:4,triangle:4,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},Ee=new Float32Array(1),Re=new Uint32Array(Ee.buffer),Le=[9984,9986,9985,9987],De=[0,6409,6410,6407,6408],Fe={};Fe[6409]=Fe[6406]=Fe[6402]=1,Fe[34041]=Fe[6410]=2,Fe[6407]=Fe[35904]=3,Fe[6408]=Fe[35906]=4;var He=N("HTMLCanvasElement"),Ne=N("OffscreenCanvas"),Be=N("CanvasRenderingContext2D"),ze=N("ImageBitmap"),Ge=N("HTMLImageElement"),Ue=N("HTMLVideoElement"),Ve=Object.keys(Se).concat([He,Ne,Be,ze,Ge,Ue]),je=[];je[5121]=1,je[5126]=4,je[36193]=2,je[5123]=2,je[5125]=4;var We=[];We[32854]=2,We[32855]=2,We[36194]=2,We[34041]=4,We[33776]=.5,We[33777]=.5,We[33778]=1,We[33779]=1,We[35986]=.5,We[35987]=1,We[34798]=1,We[35840]=.5,We[35841]=.25,We[35842]=.5,We[35843]=.25,We[36196]=.5;var qe=[];qe[32854]=2,qe[32855]=2,qe[36194]=2,qe[33189]=2,qe[36168]=1,qe[34041]=4,qe[35056]=4,qe[35907]=4,qe[34836]=16,qe[34842]=8,qe[34843]=6;var Ze=function(e,t,n,i,s){function o(e){this.id=c++,this.refCount=1,this.renderbuffer=e,this.format=32854,this.height=this.width=0,s.profile&&(this.stats={size:0})}function a(t){var n=t.renderbuffer;e.bindRenderbuffer(36161,null),e.deleteRenderbuffer(n),t.renderbuffer=null,t.refCount=0,delete u[t.id],i.renderbufferCount--}var l={rgba4:32854,rgba8:32856,rgb565:36194,"rgb5 a1":32855,depth:33189,stencil:36168,"depth stencil":34041,"depth24 stencil8":35056};t.ext_srgb&&(l.srgba=35907),t.ext_color_buffer_half_float&&(l.rgba16f=34842,l.rgb16f=34843),t.webgl_color_buffer_float&&(l.rgba32f=34836);var h=[];Object.keys(l).forEach((function(e){h[l[e]]=e}));var c=0,u={};return o.prototype.decRef=function(){0>=--this.refCount&&a(this)},s.profile&&(i.getTotalRenderbufferSize=function(){var e=0;return Object.keys(u).forEach((function(t){e+=u[t].stats.size})),e}),{create:function(t,n){function a(t,n){var i=0,o=0,u=32854,f=0;if("object"==typeof t&&t?("shape"in t?(i=0|(o=t.shape)[0],o=0|o[1]):("radius"in t&&(i=o=0|t.radius),"width"in t&&(i=0|t.width),"height"in t&&(o=0|t.height)),"format"in t&&(u=l[t.format]),"samples"in t&&(f=t.samples)):"number"==typeof t?(i=0|t,o="number"==typeof n?0|n:i):t||(i=o=1),i!==c.width||o!==c.height||u!==c.format)return a.width=c.width=i,a.height=c.height=o,a.samples=f,c.format=u,c.samples=f,e.bindRenderbuffer(36161,c.renderbuffer),f&&e.renderbufferStorageMultisample?e.renderbufferStorageMultisample(36161,f,u,i,o):e.renderbufferStorage(36161,u,i,o),s.profile&&(c.stats.size=qe[c.format]*c.width*c.height),a.format=h[c.format],a}var c=new o(e.createRenderbuffer());return u[c.id]=c,i.renderbufferCount++,a(t,n),a.resize=function(t,n){var i=0|t,o=0|n||i;if(i===c.width&&o===c.height)return a;a.width=c.width=i,a.height=c.height=o;var l=a.samples;return e.bindRenderbuffer(36161,c.renderbuffer),l&&e.renderbufferStorageMultisample?e.renderbufferStorageMultisample(36161,l,c.format,i,o):e.renderbufferStorage(36161,c.format,i,o),s.profile&&(c.stats.size=qe[c.format]*c.width*c.height),a},a._reglType="renderbuffer",a._renderbuffer=c,s.profile&&(a.stats=c.stats),a.destroy=function(){c.decRef()},a},clear:function(){we(u).forEach(a)},restore:function(){we(u).forEach((function(t){t.renderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(36161,t.renderbuffer),t.samples&&e.renderbufferStorageMultisample?e.renderbufferStorageMultisample(36161,t.samples,t.format,t.width,t.height):e.renderbufferStorage(36161,t.format,t.width,t.height)})),e.bindRenderbuffer(36161,null)}}},Xe=[];Xe[6408]=4,Xe[6407]=3;var Ye=[];Ye[5121]=1,Ye[5126]=4,Ye[36193]=2;var Je=["x","y","z","w"],$e="blend.func blend.equation stencil.func stencil.opFront stencil.opBack sample.coverage viewport scissor.box polygonOffset.offset".split(" "),Ke={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},et={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},tt={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},nt={cw:2304,ccw:2305},rt=new oe(!1,!1,!1,(function(){})),it=function(e,t){function n(){this.endQueryIndex=this.startQueryIndex=-1,this.sum=0,this.stats=null}function i(e,t,i){var s=a.pop()||new n;s.startQueryIndex=e,s.endQueryIndex=t,s.sum=0,s.stats=i,l.push(s)}if(!t.ext_disjoint_timer_query)return null;var s=[],o=[],a=[],l=[],h=[],c=[];return{beginQuery:function(e){var n=s.pop()||t.ext_disjoint_timer_query.createQueryEXT();t.ext_disjoint_timer_query.beginQueryEXT(35007,n),o.push(n),i(o.length-1,o.length,e)},endQuery:function(){t.ext_disjoint_timer_query.endQueryEXT(35007)},pushScopeStats:i,update:function(){var e,n;if(0!==(e=o.length)){c.length=Math.max(c.length,e+1),h.length=Math.max(h.length,e+1),h[0]=0;var i=c[0]=0;for(n=e=0;n<o.length;++n)t.ext_disjoint_timer_query.getQueryObjectEXT(u=o[n],34919)?(i+=t.ext_disjoint_timer_query.getQueryObjectEXT(u,34918),s.push(u)):o[e++]=u,h[n+1]=i,c[n+1]=e;for(o.length=e,n=e=0;n<l.length;++n){var u,f=(i=l[n]).startQueryIndex;i.sum+=h[u=i.endQueryIndex]-h[f],(u=c[u])===(f=c[f])?(i.stats.gpuTime+=i.sum/1e6,a.push(i)):(i.startQueryIndex=f,i.endQueryIndex=u,l[e++]=i)}l.length=e}},getNumPendingQueries:function(){return o.length},clear:function(){s.push.apply(s,o);for(var e=0;e<s.length;e++)t.ext_disjoint_timer_query.deleteQueryEXT(s[e]);o.length=0,s.length=0},restore:function(){o.length=0,s.length=0}}};return function(e){function t(){if(0===ue.length)N&&N.update(),we=null;else{we=ye.next(t),m();for(var e=ue.length-1;0<=e;--e){var n=ue[e];n&&n(U,null,0)}T.flush(),N&&N.update()}}function n(){!we&&0<ue.length&&(we=ye.next(t))}function i(){we&&(ye.cancel(t),we=null)}function o(e){e.preventDefault(),i(),me.forEach((function(e){e()}))}function a(e){T.getError(),M.restore(),ee.restore(),q.restore(),te.restore(),re.restore(),se.restore(),K.restore(),N&&N.restore(),oe.procs.refresh(),n(),ve.forEach((function(e){e()}))}function l(e){function t(e,t){var n={},i={};return Object.keys(e).forEach((function(s){var o=e[s];if(Ae.isDynamic(o))i[s]=Ae.unbox(o,s);else{if(t&&Array.isArray(o))for(var a=0;a<o.length;++a)if(Ae.isDynamic(o[a]))return void(i[s]=Ae.unbox(o,s));n[s]=o}})),{dynamic:i,static:n}}function n(e){for(;f.length<e;)f.push(null);return f}var i=t(e.context||{},!0),s=t(e.uniforms||{},!0),o=t(e.attributes||{},!1);e=t(function(e){function t(e){if(e in n){var t=n[e];delete n[e],Object.keys(t).forEach((function(i){n[e+"."+i]=t[i]}))}}var n=pe({},e);return delete n.uniforms,delete n.attributes,delete n.context,delete n.vao,"stencil"in n&&n.stencil.op&&(n.stencil.opBack=n.stencil.opFront=n.stencil.op,delete n.stencil.op),t("blend"),t("depth"),t("cull"),t("stencil"),t("polygonOffset"),t("scissor"),t("sample"),"vao"in e&&(n.vao=e.vao),n}(e),!1);var a={gpuTime:0,cpuTime:0,count:0},l=oe.compile(e,o,s,i,a),h=l.draw,c=l.batch,u=l.scope,f=[];return pe((function(e,t){var i;if("function"==typeof e)return u.call(this,null,e,0);if("function"==typeof t)if("number"==typeof e)for(i=0;i<e;++i)u.call(this,null,t,i);else{if(!Array.isArray(e))return u.call(this,e,t,0);for(i=0;i<e.length;++i)u.call(this,e[i],t,i)}else if("number"==typeof e){if(0<e)return c.call(this,n(0|e),0|e)}else{if(!Array.isArray(e))return h.call(this,e);if(e.length)return c.call(this,e,e.length)}}),{stats:a,destroy:function(){l.destroy()}})}function h(e,t){var n=0;oe.procs.poll();var i=t.color;i&&(T.clearColor(+i[0]||0,+i[1]||0,+i[2]||0,+i[3]||0),n|=16384),"depth"in t&&(T.clearDepth(+t.depth),n|=256),"stencil"in t&&(T.clearStencil(0|t.stencil),n|=1024),T.clear(n)}function f(e){return ue.push(e),n(),{cancel:function(){function t(){var e=de(ue,t);ue[e]=ue[ue.length-1],--ue.length,0>=ue.length&&i()}var n=de(ue,e);ue[n]=t}}}function g(){var e=le.viewport,t=le.scissor_box;e[0]=e[1]=t[0]=t[1]=0,U.viewportWidth=U.framebufferWidth=U.drawingBufferWidth=e[2]=t[2]=T.drawingBufferWidth,U.viewportHeight=U.framebufferHeight=U.drawingBufferHeight=e[3]=t[3]=T.drawingBufferHeight}function m(){U.tick+=1,U.time=w(),g(),oe.procs.poll()}function A(){te.refresh(),g(),oe.procs.refresh(),N&&N.update()}function w(){return(_e()-B)/1e3}if(!(e=c(e)))return null;var T=e.gl,S=T.getContextAttributes();T.isContextLost();var M=u(T,e);if(!M)return null;var C=s(),D={vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0},H=M.extensions,N=it(T,H),B=_e(),z=T.drawingBufferHeight,U={tick:0,time:0,viewportWidth:j=T.drawingBufferWidth,viewportHeight:z,framebufferWidth:j,framebufferHeight:z,drawingBufferWidth:j,drawingBufferHeight:z,pixelRatio:e.pixelRatio},j={elements:null,primitive:4,count:-1,offset:0,instances:-1},W=xe(T,H),q=I(T,D,e,(function(e){return K.destroyBuffer(e)})),Y=E(T,H,q,D),K=J(T,H,W,D,q,Y,j),ee=Q(T,C,D,e),te=Z(T,H,W,(function(){oe.procs.poll()}),U,D,e),re=Ze(T,H,W,D,e),se=X(T,H,W,te,re,D),oe=fe(T,C,H,W,q,Y,te,se,{},K,ee,j,U,N,e),le=(C=$(T,se,oe.procs.poll,U),oe.next),he=T.canvas,ue=[],me=[],ve=[],be=[e.onDestroy],we=null;he&&(he.addEventListener("webglcontextlost",o,!1),he.addEventListener("webglcontextrestored",a,!1));var Te=se.setFBO=l({framebuffer:Ae.define.call(null,1,"framebuffer")});return A(),S=pe(l,{clear:function(e){if("framebuffer"in e)if(e.framebuffer&&"framebufferCube"===e.framebuffer_reglType)for(var t=0;6>t;++t)Te(pe({framebuffer:e.framebuffer.faces[t]},e),h);else Te(e,h);else h(null,e)},prop:Ae.define.bind(null,1),context:Ae.define.bind(null,2),this:Ae.define.bind(null,3),draw:l({}),buffer:function(e){return q.create(e,34962,!1,!1)},elements:function(e){return Y.create(e,!1)},texture:te.create2D,cube:te.createCube,renderbuffer:re.create,framebuffer:se.create,framebufferCube:se.createCube,vao:K.createVAO,attributes:S,frame:f,on:function(e,t){var n;switch(e){case"frame":return f(t);case"lost":n=me;break;case"restore":n=ve;break;case"destroy":n=be}return n.push(t),{cancel:function(){for(var e=0;e<n.length;++e)if(n[e]===t){n[e]=n[n.length-1],n.pop();break}}}},limits:W,hasExtension:function(e){return 0<=W.extensions.indexOf(e.toLowerCase())},read:C,destroy:function(){ue.length=0,i(),he&&(he.removeEventListener("webglcontextlost",o),he.removeEventListener("webglcontextrestored",a)),ee.clear(),se.clear(),re.clear(),K.clear(),te.clear(),Y.clear(),q.clear(),N&&N.clear(),be.forEach((function(e){e()}))},_gl:T,_refresh:A,poll:function(){m(),N&&N.update()},now:w,stats:D,blit:se.blit}),e.onDone(null,S),S}}()}(jm);var Wm=Vm(jm.exports),qm=1e-6,Zm="undefined"!=typeof Float32Array?Float32Array:Array,Xm=Math.random;var Ym=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var Jm=Object.freeze({__proto__:null,get ARRAY_TYPE(){return Zm},EPSILON:qm,RANDOM:Xm,equals:function(e,t){return Math.abs(e-t)<=qm*Math.max(1,Math.abs(e),Math.abs(t))},setMatrixArrayType:function(e){Zm=e},toRadian:function(e){return e*Ym}});function Qm(e,t,n,i,s){return e[0]=t,e[1]=n,e[2]=i,e[3]=s,e}function $m(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3],l=n[0],h=n[1],c=n[2],u=n[3];return e[0]=i*l+o*h,e[1]=s*l+a*h,e[2]=i*c+o*u,e[3]=s*c+a*u,e}function Km(e,t){var n=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=n,e[2]=-n,e[3]=i,e}function eA(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e}var tA=Object.freeze({__proto__:null,LDU:function(e,t,n,i){return e[2]=i[2]/i[0],n[0]=i[0],n[1]=i[1],n[3]=i[3]-e[2]*n[1],[e,t,n]},add:function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e},adjoint:function(e,t){var n=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=n,e},clone:function(e){var t=new Zm(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},create:function(){var e=new Zm(4);return Zm!=Float32Array&&(e[1]=0,e[2]=0),e[0]=1,e[3]=1,e},determinant:function(e){return e[0]*e[3]-e[2]*e[1]},equals:function(e,t){var n=e[0],i=e[1],s=e[2],o=e[3],a=t[0],l=t[1],h=t[2],c=t[3];return Math.abs(n-a)<=qm*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(i-l)<=qm*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(s-h)<=qm*Math.max(1,Math.abs(s),Math.abs(h))&&Math.abs(o-c)<=qm*Math.max(1,Math.abs(o),Math.abs(c))},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},frob:function(e){return Math.hypot(e[0],e[1],e[2],e[3])},fromRotation:Km,fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},fromValues:function(e,t,n,i){var s=new Zm(4);return s[0]=e,s[1]=t,s[2]=n,s[3]=i,s},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},invert:function(e,t){var n=t[0],i=t[1],s=t[2],o=t[3],a=n*o-s*i;return a?(e[0]=o*(a=1/a),e[1]=-i*a,e[2]=-s*a,e[3]=n*a,e):null},mul:$m,multiply:$m,multiplyScalar:function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e},multiplyScalarAndAdd:function(e,t,n,i){return e[0]=t[0]+n[0]*i,e[1]=t[1]+n[1]*i,e[2]=t[2]+n[2]*i,e[3]=t[3]+n[3]*i,e},rotate:function(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3],l=Math.sin(n),h=Math.cos(n);return e[0]=i*h+o*l,e[1]=s*h+a*l,e[2]=i*-l+o*h,e[3]=s*-l+a*h,e},scale:function(e,t,n){var i=t[1],s=t[2],o=t[3],a=n[0],l=n[1];return e[0]=t[0]*a,e[1]=i*a,e[2]=s*l,e[3]=o*l,e},set:Qm,str:function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},sub:eA,subtract:eA,transpose:function(e,t){if(e===t){var n=t[1];e[1]=t[2],e[2]=n}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e}});function nA(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3],l=t[4],h=t[5],c=n[0],u=n[1],f=n[2],g=n[3],m=n[4],A=n[5];return e[0]=i*c+o*u,e[1]=s*c+a*u,e[2]=i*f+o*g,e[3]=s*f+a*g,e[4]=i*m+o*A+l,e[5]=s*m+a*A+h,e}function rA(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e[4]=t[4]-n[4],e[5]=t[5]-n[5],e}var iA=Object.freeze({__proto__:null,add:function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e[4]=t[4]+n[4],e[5]=t[5]+n[5],e},clone:function(e){var t=new Zm(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},create:function(){var e=new Zm(6);return Zm!=Float32Array&&(e[1]=0,e[2]=0,e[4]=0,e[5]=0),e[0]=1,e[3]=1,e},determinant:function(e){return e[0]*e[3]-e[1]*e[2]},equals:function(e,t){var n=e[0],i=e[1],s=e[2],o=e[3],a=e[4],l=e[5],h=t[0],c=t[1],u=t[2],f=t[3],g=t[4],m=t[5];return Math.abs(n-h)<=qm*Math.max(1,Math.abs(n),Math.abs(h))&&Math.abs(i-c)<=qm*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(s-u)<=qm*Math.max(1,Math.abs(s),Math.abs(u))&&Math.abs(o-f)<=qm*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(a-g)<=qm*Math.max(1,Math.abs(a),Math.abs(g))&&Math.abs(l-m)<=qm*Math.max(1,Math.abs(l),Math.abs(m))},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]},frob:function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],1)},fromRotation:function(e,t){var n=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=n,e[2]=-n,e[3]=i,e[4]=0,e[5]=0,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e[4]=0,e[5]=0,e},fromTranslation:function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=t[0],e[5]=t[1],e},fromValues:function(e,t,n,i,s,o){var a=new Zm(6);return a[0]=e,a[1]=t,a[2]=n,a[3]=i,a[4]=s,a[5]=o,a},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},invert:function(e,t){var n=t[0],i=t[1],s=t[2],o=t[3],a=t[4],l=t[5],h=n*o-i*s;return h?(e[0]=o*(h=1/h),e[1]=-i*h,e[2]=-s*h,e[3]=n*h,e[4]=(s*l-o*a)*h,e[5]=(i*a-n*l)*h,e):null},mul:nA,multiply:nA,multiplyScalar:function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e},multiplyScalarAndAdd:function(e,t,n,i){return e[0]=t[0]+n[0]*i,e[1]=t[1]+n[1]*i,e[2]=t[2]+n[2]*i,e[3]=t[3]+n[3]*i,e[4]=t[4]+n[4]*i,e[5]=t[5]+n[5]*i,e},rotate:function(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3],l=t[4],h=t[5],c=Math.sin(n),u=Math.cos(n);return e[0]=i*u+o*c,e[1]=s*u+a*c,e[2]=i*-c+o*u,e[3]=s*-c+a*u,e[4]=l,e[5]=h,e},scale:function(e,t,n){var i=t[1],s=t[2],o=t[3],a=t[4],l=t[5],h=n[0],c=n[1];return e[0]=t[0]*h,e[1]=i*h,e[2]=s*c,e[3]=o*c,e[4]=a,e[5]=l,e},set:function(e,t,n,i,s,o,a){return e[0]=t,e[1]=n,e[2]=i,e[3]=s,e[4]=o,e[5]=a,e},str:function(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},sub:rA,subtract:rA,translate:function(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3],l=t[4],h=t[5],c=n[0],u=n[1];return e[0]=i,e[1]=s,e[2]=o,e[3]=a,e[4]=i*c+o*u+l,e[5]=s*c+a*u+h,e}});function sA(){var e=new Zm(9);return Zm!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function oA(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e}function aA(e,t,n,i,s,o,a,l,h,c){return e[0]=t,e[1]=n,e[2]=i,e[3]=s,e[4]=o,e[5]=a,e[6]=l,e[7]=h,e[8]=c,e}function lA(e,t){if(e===t){var n=t[1],i=t[2],s=t[5];e[1]=t[3],e[2]=t[6],e[3]=n,e[5]=t[7],e[6]=i,e[7]=s}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e}function hA(e,t){var n=t[0],i=t[1],s=t[2],o=t[3],a=t[4],l=t[5],h=t[6],c=t[7],u=t[8],f=u*a-l*c,g=-u*o+l*h,m=c*o-a*h,A=n*f+i*g+s*m;return A?(e[0]=f*(A=1/A),e[1]=(-u*i+s*c)*A,e[2]=(l*i-s*a)*A,e[3]=g*A,e[4]=(u*n-s*h)*A,e[5]=(-l*n+s*o)*A,e[6]=m*A,e[7]=(-c*n+i*h)*A,e[8]=(a*n-i*o)*A,e):null}function cA(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3],l=t[4],h=t[5],c=t[6],u=t[7],f=t[8],g=n[0],m=n[1],A=n[2],w=n[3],T=n[4],S=n[5],M=n[6],C=n[7],I=n[8];return e[0]=g*i+m*a+A*c,e[1]=g*s+m*l+A*u,e[2]=g*o+m*h+A*f,e[3]=w*i+T*a+S*c,e[4]=w*s+T*l+S*u,e[5]=w*o+T*h+S*f,e[6]=M*i+C*a+I*c,e[7]=M*s+C*l+I*u,e[8]=M*o+C*h+I*f,e}function uA(e,t){var n=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=n,e[2]=0,e[3]=-n,e[4]=i,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function fA(e,t){var n=t[0],i=t[1],s=t[2],o=t[3],a=n+n,l=i+i,h=s+s,c=n*a,u=i*a,f=i*l,g=s*a,m=s*l,A=s*h,w=o*a,T=o*l,S=o*h;return e[0]=1-f-A,e[3]=u-S,e[6]=g+T,e[1]=u+S,e[4]=1-c-A,e[7]=m-w,e[2]=g-T,e[5]=m+w,e[8]=1-c-f,e}function dA(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e[4]=t[4]-n[4],e[5]=t[5]-n[5],e[6]=t[6]-n[6],e[7]=t[7]-n[7],e[8]=t[8]-n[8],e}var pA=Object.freeze({__proto__:null,add:function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e[4]=t[4]+n[4],e[5]=t[5]+n[5],e[6]=t[6]+n[6],e[7]=t[7]+n[7],e[8]=t[8]+n[8],e},adjoint:function(e,t){var n=t[0],i=t[1],s=t[2],o=t[3],a=t[4],l=t[5],h=t[6],c=t[7],u=t[8];return e[0]=a*u-l*c,e[1]=s*c-i*u,e[2]=i*l-s*a,e[3]=l*h-o*u,e[4]=n*u-s*h,e[5]=s*o-n*l,e[6]=o*c-a*h,e[7]=i*h-n*c,e[8]=n*a-i*o,e},clone:function(e){var t=new Zm(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},create:sA,determinant:function(e){var t=e[3],n=e[4],i=e[5],s=e[6],o=e[7],a=e[8];return e[0]*(a*n-i*o)+e[1]*(-a*t+i*s)+e[2]*(o*t-n*s)},equals:function(e,t){var n=e[0],i=e[1],s=e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],f=t[0],g=t[1],m=t[2],A=t[3],w=t[4],T=t[5],S=t[6],M=t[7],C=t[8];return Math.abs(n-f)<=qm*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(i-g)<=qm*Math.max(1,Math.abs(i),Math.abs(g))&&Math.abs(s-m)<=qm*Math.max(1,Math.abs(s),Math.abs(m))&&Math.abs(o-A)<=qm*Math.max(1,Math.abs(o),Math.abs(A))&&Math.abs(a-w)<=qm*Math.max(1,Math.abs(a),Math.abs(w))&&Math.abs(l-T)<=qm*Math.max(1,Math.abs(l),Math.abs(T))&&Math.abs(h-S)<=qm*Math.max(1,Math.abs(h),Math.abs(S))&&Math.abs(c-M)<=qm*Math.max(1,Math.abs(c),Math.abs(M))&&Math.abs(u-C)<=qm*Math.max(1,Math.abs(u),Math.abs(C))},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]},frob:function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])},fromMat2d:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},fromMat4:oA,fromQuat:fA,fromRotation:uA,fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},fromTranslation:function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e},fromValues:function(e,t,n,i,s,o,a,l,h){var c=new Zm(9);return c[0]=e,c[1]=t,c[2]=n,c[3]=i,c[4]=s,c[5]=o,c[6]=a,c[7]=l,c[8]=h,c},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},invert:hA,mul:cA,multiply:cA,multiplyScalar:function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*n,e},multiplyScalarAndAdd:function(e,t,n,i){return e[0]=t[0]+n[0]*i,e[1]=t[1]+n[1]*i,e[2]=t[2]+n[2]*i,e[3]=t[3]+n[3]*i,e[4]=t[4]+n[4]*i,e[5]=t[5]+n[5]*i,e[6]=t[6]+n[6]*i,e[7]=t[7]+n[7]*i,e[8]=t[8]+n[8]*i,e},normalFromMat4:function(e,t){var n=t[0],i=t[1],s=t[2],o=t[3],a=t[4],l=t[5],h=t[6],c=t[7],u=t[8],f=t[9],g=t[10],m=t[11],A=t[12],w=t[13],T=t[14],S=t[15],M=n*l-i*a,C=n*h-s*a,I=n*c-o*a,E=i*h-s*l,D=i*c-o*l,H=s*c-o*h,N=u*w-f*A,B=u*T-g*A,z=u*S-m*A,U=f*T-g*w,j=f*S-m*w,W=g*S-m*T,q=M*W-C*j+I*U+E*z-D*B+H*N;return q?(e[0]=(l*W-h*j+c*U)*(q=1/q),e[1]=(h*z-a*W-c*B)*q,e[2]=(a*j-l*z+c*N)*q,e[3]=(s*j-i*W-o*U)*q,e[4]=(n*W-s*z+o*B)*q,e[5]=(i*z-n*j-o*N)*q,e[6]=(w*H-T*D+S*E)*q,e[7]=(T*I-A*H-S*C)*q,e[8]=(A*D-w*I+S*M)*q,e):null},projection:function(e,t,n){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/n,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e},rotate:function(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3],l=t[4],h=t[5],c=t[6],u=t[7],f=t[8],g=Math.sin(n),m=Math.cos(n);return e[0]=m*i+g*a,e[1]=m*s+g*l,e[2]=m*o+g*h,e[3]=m*a-g*i,e[4]=m*l-g*s,e[5]=m*h-g*o,e[6]=c,e[7]=u,e[8]=f,e},scale:function(e,t,n){var i=n[0],s=n[1];return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=s*t[3],e[4]=s*t[4],e[5]=s*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},set:aA,str:function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},sub:dA,subtract:dA,translate:function(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3],l=t[4],h=t[5],c=t[6],u=t[7],f=t[8],g=n[0],m=n[1];return e[0]=i,e[1]=s,e[2]=o,e[3]=a,e[4]=l,e[5]=h,e[6]=g*i+m*a+c,e[7]=g*s+m*l+u,e[8]=g*o+m*h+f,e},transpose:lA});function gA(){var e=new Zm(16);return Zm!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function mA(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function AA(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function yA(e,t){if(e===t){var n=t[1],i=t[2],s=t[3],o=t[6],a=t[7],l=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=n,e[6]=t[9],e[7]=t[13],e[8]=i,e[9]=o,e[11]=t[14],e[12]=s,e[13]=a,e[14]=l}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}function _A(e,t){var n=t[0],i=t[1],s=t[2],o=t[3],a=t[4],l=t[5],h=t[6],c=t[7],u=t[8],f=t[9],g=t[10],m=t[11],A=t[12],w=t[13],T=t[14],S=t[15],M=n*l-i*a,C=n*h-s*a,I=n*c-o*a,E=i*h-s*l,D=i*c-o*l,H=s*c-o*h,N=u*w-f*A,B=u*T-g*A,z=u*S-m*A,U=f*T-g*w,j=f*S-m*w,W=g*S-m*T,q=M*W-C*j+I*U+E*z-D*B+H*N;return q?(e[0]=(l*W-h*j+c*U)*(q=1/q),e[1]=(s*j-i*W-o*U)*q,e[2]=(w*H-T*D+S*E)*q,e[3]=(g*D-f*H-m*E)*q,e[4]=(h*z-a*W-c*B)*q,e[5]=(n*W-s*z+o*B)*q,e[6]=(T*I-A*H-S*C)*q,e[7]=(u*H-g*I+m*C)*q,e[8]=(a*j-l*z+c*N)*q,e[9]=(i*z-n*j-o*N)*q,e[10]=(A*D-w*I+S*M)*q,e[11]=(f*I-u*D-m*M)*q,e[12]=(l*B-a*U-h*N)*q,e[13]=(n*U-i*B+s*N)*q,e[14]=(w*C-A*E-T*M)*q,e[15]=(u*E-f*C+g*M)*q,e):null}function vA(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3],l=t[4],h=t[5],c=t[6],u=t[7],f=t[8],g=t[9],m=t[10],A=t[11],w=t[12],T=t[13],S=t[14],M=t[15],C=n[0],I=n[1],E=n[2],D=n[3];return e[0]=C*i+I*l+E*f+D*w,e[1]=C*s+I*h+E*g+D*T,e[2]=C*o+I*c+E*m+D*S,e[3]=C*a+I*u+E*A+D*M,e[4]=(C=n[4])*i+(I=n[5])*l+(E=n[6])*f+(D=n[7])*w,e[5]=C*s+I*h+E*g+D*T,e[6]=C*o+I*c+E*m+D*S,e[7]=C*a+I*u+E*A+D*M,e[8]=(C=n[8])*i+(I=n[9])*l+(E=n[10])*f+(D=n[11])*w,e[9]=C*s+I*h+E*g+D*T,e[10]=C*o+I*c+E*m+D*S,e[11]=C*a+I*u+E*A+D*M,e[12]=(C=n[12])*i+(I=n[13])*l+(E=n[14])*f+(D=n[15])*w,e[13]=C*s+I*h+E*g+D*T,e[14]=C*o+I*c+E*m+D*S,e[15]=C*a+I*u+E*A+D*M,e}function xA(e,t,n){var i,s,o,a,l,h,c,u,f,g,m,A,w=n[0],T=n[1],S=n[2];return t===e?(e[12]=t[0]*w+t[4]*T+t[8]*S+t[12],e[13]=t[1]*w+t[5]*T+t[9]*S+t[13],e[14]=t[2]*w+t[6]*T+t[10]*S+t[14],e[15]=t[3]*w+t[7]*T+t[11]*S+t[15]):(s=t[1],o=t[2],a=t[3],l=t[4],h=t[5],c=t[6],u=t[7],f=t[8],g=t[9],m=t[10],A=t[11],e[0]=i=t[0],e[1]=s,e[2]=o,e[3]=a,e[4]=l,e[5]=h,e[6]=c,e[7]=u,e[8]=f,e[9]=g,e[10]=m,e[11]=A,e[12]=i*w+l*T+f*S+t[12],e[13]=s*w+h*T+g*S+t[13],e[14]=o*w+c*T+m*S+t[14],e[15]=a*w+u*T+A*S+t[15]),e}function bA(e,t,n){var i=n[0],s=n[1],o=n[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function wA(e,t,n,i){var s,o,a,l,h,c,u,f,g,m,A,w,T,S,M,C,I,E,D,H,N,B,z,U,j=i[0],W=i[1],q=i[2],Z=Math.hypot(j,W,q);return Z<qm?null:(j*=Z=1/Z,W*=Z,q*=Z,s=Math.sin(n),o=Math.cos(n),h=t[1],c=t[2],u=t[3],g=t[5],m=t[6],A=t[7],T=t[9],S=t[10],M=t[11],D=j*W*(a=1-o)-q*s,H=W*W*a+o,N=q*W*a+j*s,B=j*q*a+W*s,z=W*q*a-j*s,U=q*q*a+o,e[0]=(l=t[0])*(C=j*j*a+o)+(f=t[4])*(I=W*j*a+q*s)+(w=t[8])*(E=q*j*a-W*s),e[1]=h*C+g*I+T*E,e[2]=c*C+m*I+S*E,e[3]=u*C+A*I+M*E,e[4]=l*D+f*H+w*N,e[5]=h*D+g*H+T*N,e[6]=c*D+m*H+S*N,e[7]=u*D+A*H+M*N,e[8]=l*B+f*z+w*U,e[9]=h*B+g*z+T*U,e[10]=c*B+m*z+S*U,e[11]=u*B+A*z+M*U,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)}function TA(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function SA(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function MA(e,t,n){var i,s,o,a=n[0],l=n[1],h=n[2],c=Math.hypot(a,l,h);return c<qm?null:(a*=c=1/c,l*=c,h*=c,i=Math.sin(t),s=Math.cos(t),e[0]=a*a*(o=1-s)+s,e[1]=l*a*o+h*i,e[2]=h*a*o-l*i,e[3]=0,e[4]=a*l*o-h*i,e[5]=l*l*o+s,e[6]=h*l*o+a*i,e[7]=0,e[8]=a*h*o+l*i,e[9]=l*h*o-a*i,e[10]=h*h*o+s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function CA(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3],l=i+i,h=s+s,c=o+o,u=i*l,f=i*h,g=i*c,m=s*h,A=s*c,w=o*c,T=a*l,S=a*h,M=a*c;return e[0]=1-(m+w),e[1]=f+M,e[2]=g-S,e[3]=0,e[4]=f-M,e[5]=1-(u+w),e[6]=A+T,e[7]=0,e[8]=g+S,e[9]=A-T,e[10]=1-(u+m),e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e}function PA(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function kA(e,t){var n=t[4],i=t[5],s=t[6],o=t[8],a=t[9],l=t[10];return e[0]=Math.hypot(t[0],t[1],t[2]),e[1]=Math.hypot(n,i,s),e[2]=Math.hypot(o,a,l),e}function OA(e,t){var n=new Zm(3);kA(n,t);var i=1/n[0],s=1/n[1],o=1/n[2],a=t[0]*i,l=t[1]*s,h=t[2]*o,c=t[4]*i,u=t[5]*s,f=t[6]*o,g=t[8]*i,m=t[9]*s,A=t[10]*o,w=a+u+A,T=0;return w>0?(T=2*Math.sqrt(w+1),e[3]=.25*T,e[0]=(f-m)/T,e[1]=(g-h)/T,e[2]=(l-c)/T):a>u&&a>A?(T=2*Math.sqrt(1+a-u-A),e[3]=(f-m)/T,e[0]=.25*T,e[1]=(l+c)/T,e[2]=(g+h)/T):u>A?(T=2*Math.sqrt(1+u-a-A),e[3]=(g-h)/T,e[0]=(l+c)/T,e[1]=.25*T,e[2]=(f+m)/T):(T=2*Math.sqrt(1+A-a-u),e[3]=(l-c)/T,e[0]=(g+h)/T,e[1]=(f+m)/T,e[2]=.25*T),e}function EA(e,t,n,i){var s=t[0],o=t[1],a=t[2],l=t[3],h=s+s,c=o+o,u=a+a,f=s*h,g=s*c,m=s*u,A=o*c,w=o*u,T=a*u,S=l*h,M=l*c,C=l*u,I=i[0],E=i[1],D=i[2];return e[0]=(1-(A+T))*I,e[1]=(g+C)*I,e[2]=(m-M)*I,e[3]=0,e[4]=(g-C)*E,e[5]=(1-(f+T))*E,e[6]=(w+S)*E,e[7]=0,e[8]=(m+M)*D,e[9]=(w-S)*D,e[10]=(1-(f+A))*D,e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e}function RA(e,t){var n=t[0],i=t[1],s=t[2],o=t[3],a=n+n,l=i+i,h=s+s,c=n*a,u=i*a,f=i*l,g=s*a,m=s*l,A=s*h,w=o*a,T=o*l,S=o*h;return e[0]=1-f-A,e[1]=u+S,e[2]=g-T,e[3]=0,e[4]=u-S,e[5]=1-c-A,e[6]=m+w,e[7]=0,e[8]=g+T,e[9]=m-w,e[10]=1-c-f,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function LA(e,t,n,i,s){var o,a=1/Math.tan(t/2);return e[0]=a/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=s&&s!==1/0?(e[10]=(s+i)*(o=1/(i-s)),e[14]=2*s*i*o):(e[10]=-1,e[14]=-2*i),e}var DA=LA;function FA(e,t,n,i,s,o,a){var l=1/(t-n),h=1/(i-s),c=1/(o-a);return e[0]=-2*l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*h,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+n)*l,e[13]=(s+i)*h,e[14]=(a+o)*c,e[15]=1,e}var HA=FA;function NA(e,t,n,i){var s,o,a,l,h,c,u,f,g,m,A=t[0],w=t[1],T=t[2],S=i[0],M=i[1],C=i[2],I=n[0],E=n[1],D=n[2];return Math.abs(A-I)<qm&&Math.abs(w-E)<qm&&Math.abs(T-D)<qm?AA(e):(u=A-I,f=w-E,g=T-D,s=M*(g*=m=1/Math.hypot(u,f,g))-C*(f*=m),o=C*(u*=m)-S*g,a=S*f-M*u,(m=Math.hypot(s,o,a))?(s*=m=1/m,o*=m,a*=m):(s=0,o=0,a=0),l=f*a-g*o,h=g*s-u*a,c=u*o-f*s,(m=Math.hypot(l,h,c))?(l*=m=1/m,h*=m,c*=m):(l=0,h=0,c=0),e[0]=s,e[1]=l,e[2]=u,e[3]=0,e[4]=o,e[5]=h,e[6]=f,e[7]=0,e[8]=a,e[9]=c,e[10]=g,e[11]=0,e[12]=-(s*A+o*w+a*T),e[13]=-(l*A+h*w+c*T),e[14]=-(u*A+f*w+g*T),e[15]=1,e)}function BA(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e[4]=t[4]-n[4],e[5]=t[5]-n[5],e[6]=t[6]-n[6],e[7]=t[7]-n[7],e[8]=t[8]-n[8],e[9]=t[9]-n[9],e[10]=t[10]-n[10],e[11]=t[11]-n[11],e[12]=t[12]-n[12],e[13]=t[13]-n[13],e[14]=t[14]-n[14],e[15]=t[15]-n[15],e}function zA(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]}var GA=vA,UA=Object.freeze({__proto__:null,add:function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e[4]=t[4]+n[4],e[5]=t[5]+n[5],e[6]=t[6]+n[6],e[7]=t[7]+n[7],e[8]=t[8]+n[8],e[9]=t[9]+n[9],e[10]=t[10]+n[10],e[11]=t[11]+n[11],e[12]=t[12]+n[12],e[13]=t[13]+n[13],e[14]=t[14]+n[14],e[15]=t[15]+n[15],e},adjoint:function(e,t){var n=t[0],i=t[1],s=t[2],o=t[3],a=t[4],l=t[5],h=t[6],c=t[7],u=t[8],f=t[9],g=t[10],m=t[11],A=t[12],w=t[13],T=t[14],S=t[15];return e[0]=l*(g*S-m*T)-f*(h*S-c*T)+w*(h*m-c*g),e[1]=-(i*(g*S-m*T)-f*(s*S-o*T)+w*(s*m-o*g)),e[2]=i*(h*S-c*T)-l*(s*S-o*T)+w*(s*c-o*h),e[3]=-(i*(h*m-c*g)-l*(s*m-o*g)+f*(s*c-o*h)),e[4]=-(a*(g*S-m*T)-u*(h*S-c*T)+A*(h*m-c*g)),e[5]=n*(g*S-m*T)-u*(s*S-o*T)+A*(s*m-o*g),e[6]=-(n*(h*S-c*T)-a*(s*S-o*T)+A*(s*c-o*h)),e[7]=n*(h*m-c*g)-a*(s*m-o*g)+u*(s*c-o*h),e[8]=a*(f*S-m*w)-u*(l*S-c*w)+A*(l*m-c*f),e[9]=-(n*(f*S-m*w)-u*(i*S-o*w)+A*(i*m-o*f)),e[10]=n*(l*S-c*w)-a*(i*S-o*w)+A*(i*c-o*l),e[11]=-(n*(l*m-c*f)-a*(i*m-o*f)+u*(i*c-o*l)),e[12]=-(a*(f*T-g*w)-u*(l*T-h*w)+A*(l*g-h*f)),e[13]=n*(f*T-g*w)-u*(i*T-s*w)+A*(i*g-s*f),e[14]=-(n*(l*T-h*w)-a*(i*T-s*w)+A*(i*h-s*l)),e[15]=n*(l*g-h*f)-a*(i*g-s*f)+u*(i*h-s*l),e},clone:function(e){var t=new Zm(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},copy:mA,create:gA,determinant:function(e){var t=e[0],n=e[1],i=e[2],s=e[3],o=e[4],a=e[5],l=e[6],h=e[7],c=e[8],u=e[9],f=e[10],g=e[11],m=e[12],A=e[13],w=e[14],T=e[15];return(t*a-n*o)*(f*T-g*w)-(t*l-i*o)*(u*T-g*A)+(t*h-s*o)*(u*w-f*A)+(n*l-i*a)*(c*T-g*m)-(n*h-s*a)*(c*w-f*m)+(i*h-s*l)*(c*A-u*m)},equals:function(e,t){var n=e[0],i=e[1],s=e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],f=e[9],g=e[10],m=e[11],A=e[12],w=e[13],T=e[14],S=e[15],M=t[0],C=t[1],I=t[2],E=t[3],D=t[4],H=t[5],N=t[6],B=t[7],z=t[8],U=t[9],j=t[10],W=t[11],q=t[12],Z=t[13],X=t[14],Y=t[15];return Math.abs(n-M)<=qm*Math.max(1,Math.abs(n),Math.abs(M))&&Math.abs(i-C)<=qm*Math.max(1,Math.abs(i),Math.abs(C))&&Math.abs(s-I)<=qm*Math.max(1,Math.abs(s),Math.abs(I))&&Math.abs(o-E)<=qm*Math.max(1,Math.abs(o),Math.abs(E))&&Math.abs(a-D)<=qm*Math.max(1,Math.abs(a),Math.abs(D))&&Math.abs(l-H)<=qm*Math.max(1,Math.abs(l),Math.abs(H))&&Math.abs(h-N)<=qm*Math.max(1,Math.abs(h),Math.abs(N))&&Math.abs(c-B)<=qm*Math.max(1,Math.abs(c),Math.abs(B))&&Math.abs(u-z)<=qm*Math.max(1,Math.abs(u),Math.abs(z))&&Math.abs(f-U)<=qm*Math.max(1,Math.abs(f),Math.abs(U))&&Math.abs(g-j)<=qm*Math.max(1,Math.abs(g),Math.abs(j))&&Math.abs(m-W)<=qm*Math.max(1,Math.abs(m),Math.abs(W))&&Math.abs(A-q)<=qm*Math.max(1,Math.abs(A),Math.abs(q))&&Math.abs(w-Z)<=qm*Math.max(1,Math.abs(w),Math.abs(Z))&&Math.abs(T-X)<=qm*Math.max(1,Math.abs(T),Math.abs(X))&&Math.abs(S-Y)<=qm*Math.max(1,Math.abs(S),Math.abs(Y))},exactEquals:zA,frob:function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])},fromQuat:RA,fromQuat2:function(e,t){var n=new Zm(3),i=-t[0],s=-t[1],o=-t[2],a=t[3],l=t[4],h=t[5],c=t[6],u=t[7],f=i*i+s*s+o*o+a*a;return f>0?(n[0]=2*(l*a+u*i+h*o-c*s)/f,n[1]=2*(h*a+u*s+c*i-l*o)/f,n[2]=2*(c*a+u*o+l*s-h*i)/f):(n[0]=2*(l*a+u*i+h*o-c*s),n[1]=2*(h*a+u*s+c*i-l*o),n[2]=2*(c*a+u*o+l*s-h*i)),CA(e,t,n),e},fromRotation:MA,fromRotationTranslation:CA,fromRotationTranslationScale:EA,fromRotationTranslationScaleOrigin:function(e,t,n,i,s){var o=t[0],a=t[1],l=t[2],h=t[3],c=o+o,u=a+a,f=l+l,g=o*c,m=o*u,A=o*f,w=a*u,T=a*f,S=l*f,M=h*c,C=h*u,I=h*f,E=i[0],D=i[1],H=i[2],N=s[0],B=s[1],z=s[2],U=(1-(w+S))*E,j=(m+I)*E,W=(A-C)*E,q=(m-I)*D,Z=(1-(g+S))*D,X=(T+M)*D,Y=(A+C)*H,J=(T-M)*H,Q=(1-(g+w))*H;return e[0]=U,e[1]=j,e[2]=W,e[3]=0,e[4]=q,e[5]=Z,e[6]=X,e[7]=0,e[8]=Y,e[9]=J,e[10]=Q,e[11]=0,e[12]=n[0]+N-(U*N+q*B+Y*z),e[13]=n[1]+B-(j*N+Z*B+J*z),e[14]=n[2]+z-(W*N+X*B+Q*z),e[15]=1,e},fromScaling:SA,fromTranslation:TA,fromValues:function(e,t,n,i,s,o,a,l,h,c,u,f,g,m,A,w){var T=new Zm(16);return T[0]=e,T[1]=t,T[2]=n,T[3]=i,T[4]=s,T[5]=o,T[6]=a,T[7]=l,T[8]=h,T[9]=c,T[10]=u,T[11]=f,T[12]=g,T[13]=m,T[14]=A,T[15]=w,T},fromXRotation:function(e,t){var n=Math.sin(t),i=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=i,e[6]=n,e[7]=0,e[8]=0,e[9]=-n,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromYRotation:function(e,t){var n=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=0,e[2]=-n,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=n,e[9]=0,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromZRotation:function(e,t){var n=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=n,e[2]=0,e[3]=0,e[4]=-n,e[5]=i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},frustum:function(e,t,n,i,s,o,a){var l=1/(n-t),h=1/(s-i),c=1/(o-a);return e[0]=2*o*l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*o*h,e[6]=0,e[7]=0,e[8]=(n+t)*l,e[9]=(s+i)*h,e[10]=(a+o)*c,e[11]=-1,e[12]=0,e[13]=0,e[14]=a*o*2*c,e[15]=0,e},getRotation:OA,getScaling:kA,getTranslation:PA,identity:AA,invert:_A,lookAt:NA,mul:GA,multiply:vA,multiplyScalar:function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12]*n,e[13]=t[13]*n,e[14]=t[14]*n,e[15]=t[15]*n,e},multiplyScalarAndAdd:function(e,t,n,i){return e[0]=t[0]+n[0]*i,e[1]=t[1]+n[1]*i,e[2]=t[2]+n[2]*i,e[3]=t[3]+n[3]*i,e[4]=t[4]+n[4]*i,e[5]=t[5]+n[5]*i,e[6]=t[6]+n[6]*i,e[7]=t[7]+n[7]*i,e[8]=t[8]+n[8]*i,e[9]=t[9]+n[9]*i,e[10]=t[10]+n[10]*i,e[11]=t[11]+n[11]*i,e[12]=t[12]+n[12]*i,e[13]=t[13]+n[13]*i,e[14]=t[14]+n[14]*i,e[15]=t[15]+n[15]*i,e},ortho:HA,orthoNO:FA,orthoZO:function(e,t,n,i,s,o,a){var l=1/(t-n),h=1/(i-s),c=1/(o-a);return e[0]=-2*l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*h,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=c,e[11]=0,e[12]=(t+n)*l,e[13]=(s+i)*h,e[14]=o*c,e[15]=1,e},perspective:DA,perspectiveFromFieldOfView:function(e,t,n,i){var s=Math.tan(t.upDegrees*Math.PI/180),o=Math.tan(t.downDegrees*Math.PI/180),a=Math.tan(t.leftDegrees*Math.PI/180),l=Math.tan(t.rightDegrees*Math.PI/180),h=2/(a+l),c=2/(s+o);return e[0]=h,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=c,e[6]=0,e[7]=0,e[8]=-(a-l)*h*.5,e[9]=(s-o)*c*.5,e[10]=i/(n-i),e[11]=-1,e[12]=0,e[13]=0,e[14]=i*n/(n-i),e[15]=0,e},perspectiveNO:LA,perspectiveZO:function(e,t,n,i,s){var o,a=1/Math.tan(t/2);return e[0]=a/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=s&&s!==1/0?(e[10]=s*(o=1/(i-s)),e[14]=s*i*o):(e[10]=-1,e[14]=-i),e},rotate:wA,rotateX:function(e,t,n){var i=Math.sin(n),s=Math.cos(n),o=t[4],a=t[5],l=t[6],h=t[7],c=t[8],u=t[9],f=t[10],g=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=o*s+c*i,e[5]=a*s+u*i,e[6]=l*s+f*i,e[7]=h*s+g*i,e[8]=c*s-o*i,e[9]=u*s-a*i,e[10]=f*s-l*i,e[11]=g*s-h*i,e},rotateY:function(e,t,n){var i=Math.sin(n),s=Math.cos(n),o=t[0],a=t[1],l=t[2],h=t[3],c=t[8],u=t[9],f=t[10],g=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*s-c*i,e[1]=a*s-u*i,e[2]=l*s-f*i,e[3]=h*s-g*i,e[8]=o*i+c*s,e[9]=a*i+u*s,e[10]=l*i+f*s,e[11]=h*i+g*s,e},rotateZ:function(e,t,n){var i=Math.sin(n),s=Math.cos(n),o=t[0],a=t[1],l=t[2],h=t[3],c=t[4],u=t[5],f=t[6],g=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*s+c*i,e[1]=a*s+u*i,e[2]=l*s+f*i,e[3]=h*s+g*i,e[4]=c*s-o*i,e[5]=u*s-a*i,e[6]=f*s-l*i,e[7]=g*s-h*i,e},scale:bA,set:function(e,t,n,i,s,o,a,l,h,c,u,f,g,m,A,w,T){return e[0]=t,e[1]=n,e[2]=i,e[3]=s,e[4]=o,e[5]=a,e[6]=l,e[7]=h,e[8]=c,e[9]=u,e[10]=f,e[11]=g,e[12]=m,e[13]=A,e[14]=w,e[15]=T,e},str:function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},sub:BA,subtract:BA,targetTo:function(e,t,n,i){var s=t[0],o=t[1],a=t[2],l=i[0],h=i[1],c=i[2],u=s-n[0],f=o-n[1],g=a-n[2],m=u*u+f*f+g*g;m>0&&(u*=m=1/Math.sqrt(m),f*=m,g*=m);var A=h*g-c*f,w=c*u-l*g,T=l*f-h*u;return(m=A*A+w*w+T*T)>0&&(A*=m=1/Math.sqrt(m),w*=m,T*=m),e[0]=A,e[1]=w,e[2]=T,e[3]=0,e[4]=f*T-g*w,e[5]=g*A-u*T,e[6]=u*w-f*A,e[7]=0,e[8]=u,e[9]=f,e[10]=g,e[11]=0,e[12]=s,e[13]=o,e[14]=a,e[15]=1,e},translate:xA,transpose:yA});function VA(){var e=new Zm(3);return Zm!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function jA(e){return Math.hypot(e[0],e[1],e[2])}function WA(e,t,n){var i=new Zm(3);return i[0]=e,i[1]=t,i[2]=n,i}function qA(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function ZA(e,t,n,i){return e[0]=t,e[1]=n,e[2]=i,e}function XA(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e}function YA(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}function JA(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e}function QA(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],e}function $A(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}function KA(e,t,n,i){return e[0]=t[0]+n[0]*i,e[1]=t[1]+n[1]*i,e[2]=t[2]+n[2]*i,e}function ey(e,t){return Math.hypot(t[0]-e[0],t[1]-e[1],t[2]-e[2])}function ty(e,t){var n=t[0]-e[0],i=t[1]-e[1],s=t[2]-e[2];return n*n+i*i+s*s}function ny(e){var t=e[0],n=e[1],i=e[2];return t*t+n*n+i*i}function ry(e,t){var n=t[0],i=t[1],s=t[2],o=n*n+i*i+s*s;return o>0&&(o=1/Math.sqrt(o)),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e}function iy(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function sy(e,t,n){var i=t[0],s=t[1],o=t[2],a=n[0],l=n[1],h=n[2];return e[0]=s*h-o*l,e[1]=o*a-i*h,e[2]=i*l-s*a,e}function oy(e,t,n){var i=t[0],s=t[1],o=t[2],a=n[3]*i+n[7]*s+n[11]*o+n[15];return e[0]=(n[0]*i+n[4]*s+n[8]*o+n[12])/(a=a||1),e[1]=(n[1]*i+n[5]*s+n[9]*o+n[13])/a,e[2]=(n[2]*i+n[6]*s+n[10]*o+n[14])/a,e}function ay(e,t,n,i){var s=[],o=[];return s[0]=t[0]-n[0],s[1]=t[1]-n[1],s[2]=t[2]-n[2],o[0]=s[0]*Math.cos(i)-s[1]*Math.sin(i),o[1]=s[0]*Math.sin(i)+s[1]*Math.cos(i),o[2]=s[2],e[0]=o[0]+n[0],e[1]=o[1]+n[1],e[2]=o[2]+n[2],e}function ly(e,t){var n=e[0],i=e[1],s=e[2],o=t[0],a=t[1],l=t[2],h=Math.sqrt(n*n+i*i+s*s)*Math.sqrt(o*o+a*a+l*l),c=h&&iy(e,t)/h;return Math.acos(Math.min(Math.max(c,-1),1))}function hy(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function cy(e,t){var n=e[0],i=e[1],s=e[2],o=t[0],a=t[1],l=t[2];return Math.abs(n-o)<=qm*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(i-a)<=qm*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(s-l)<=qm*Math.max(1,Math.abs(s),Math.abs(l))}var uy,fy=YA,dy=JA,py=QA,gy=ey,my=ty,Ay=jA,yy=ny,_y=(uy=VA(),function(e,t,n,i,s,o){var a,l;for(t||(t=3),n||(n=0),l=i?Math.min(i*t+n,e.length):e.length,a=n;a<l;a+=t)uy[0]=e[a],uy[1]=e[a+1],uy[2]=e[a+2],s(uy,uy,o),e[a]=uy[0],e[a+1]=uy[1],e[a+2]=uy[2];return e}),vy=Object.freeze({__proto__:null,add:XA,angle:ly,bezier:function(e,t,n,i,s,o){var a=1-o,l=a*a,h=o*o,c=l*a,u=3*o*l,f=3*h*a,g=h*o;return e[0]=t[0]*c+n[0]*u+i[0]*f+s[0]*g,e[1]=t[1]*c+n[1]*u+i[1]*f+s[1]*g,e[2]=t[2]*c+n[2]*u+i[2]*f+s[2]*g,e},ceil:function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e},clone:function(e){var t=new Zm(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},copy:qA,create:VA,cross:sy,dist:gy,distance:ey,div:py,divide:QA,dot:iy,equals:cy,exactEquals:hy,floor:function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e},forEach:_y,fromValues:WA,hermite:function(e,t,n,i,s,o){var a=o*o,l=a*(2*o-3)+1,h=a*(o-2)+o,c=a*(o-1),u=a*(3-2*o);return e[0]=t[0]*l+n[0]*h+i[0]*c+s[0]*u,e[1]=t[1]*l+n[1]*h+i[1]*c+s[1]*u,e[2]=t[2]*l+n[2]*h+i[2]*c+s[2]*u,e},inverse:function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e},len:Ay,length:jA,lerp:function(e,t,n,i){var s=t[0],o=t[1],a=t[2];return e[0]=s+i*(n[0]-s),e[1]=o+i*(n[1]-o),e[2]=a+i*(n[2]-a),e},max:function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e},min:function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e},mul:dy,multiply:JA,negate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},normalize:ry,random:function(e,t){t=t||1;var n=2*Xm()*Math.PI,i=2*Xm()-1,s=Math.sqrt(1-i*i)*t;return e[0]=Math.cos(n)*s,e[1]=Math.sin(n)*s,e[2]=i*t,e},rotateX:function(e,t,n,i){var s=[],o=[];return s[0]=t[0]-n[0],s[1]=t[1]-n[1],s[2]=t[2]-n[2],o[0]=s[0],o[1]=s[1]*Math.cos(i)-s[2]*Math.sin(i),o[2]=s[1]*Math.sin(i)+s[2]*Math.cos(i),e[0]=o[0]+n[0],e[1]=o[1]+n[1],e[2]=o[2]+n[2],e},rotateY:function(e,t,n,i){var s=[],o=[];return s[0]=t[0]-n[0],s[1]=t[1]-n[1],s[2]=t[2]-n[2],o[0]=s[2]*Math.sin(i)+s[0]*Math.cos(i),o[1]=s[1],o[2]=s[2]*Math.cos(i)-s[0]*Math.sin(i),e[0]=o[0]+n[0],e[1]=o[1]+n[1],e[2]=o[2]+n[2],e},rotateZ:ay,round:function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e},scale:$A,scaleAndAdd:KA,set:ZA,sqrDist:my,sqrLen:yy,squaredDistance:ty,squaredLength:ny,str:function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},sub:fy,subtract:YA,transformMat3:function(e,t,n){var i=t[0],s=t[1],o=t[2];return e[0]=i*n[0]+s*n[3]+o*n[6],e[1]=i*n[1]+s*n[4]+o*n[7],e[2]=i*n[2]+s*n[5]+o*n[8],e},transformMat4:oy,transformQuat:function(e,t,n){var i=n[0],s=n[1],o=n[2],a=t[0],l=t[1],h=t[2],c=s*h-o*l,u=o*a-i*h,f=i*l-s*a,g=s*f-o*u,m=o*c-i*f,A=i*u-s*c,w=2*n[3];return u*=w,f*=w,m*=2,A*=2,e[0]=a+(c*=w)+(g*=2),e[1]=l+u+m,e[2]=h+f+A,e},zero:function(e){return e[0]=0,e[1]=0,e[2]=0,e}});function xy(){var e=new Zm(4);return Zm!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function by(e){var t=new Zm(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function wy(e,t,n,i){var s=new Zm(4);return s[0]=e,s[1]=t,s[2]=n,s[3]=i,s}function Ty(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function Sy(e,t,n,i,s){return e[0]=t,e[1]=n,e[2]=i,e[3]=s,e}function My(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e}function Cy(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e}function Py(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e[3]=t[3]*n[3],e}function Iy(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],e[3]=t[3]/n[3],e}function ky(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e}function Oy(e,t){return Math.hypot(t[0]-e[0],t[1]-e[1],t[2]-e[2],t[3]-e[3])}function Ey(e,t){var n=t[0]-e[0],i=t[1]-e[1],s=t[2]-e[2],o=t[3]-e[3];return n*n+i*i+s*s+o*o}function Ry(e){return Math.hypot(e[0],e[1],e[2],e[3])}function Ly(e){var t=e[0],n=e[1],i=e[2],s=e[3];return t*t+n*n+i*i+s*s}function Dy(e,t){var n=t[0],i=t[1],s=t[2],o=t[3],a=n*n+i*i+s*s+o*o;return a>0&&(a=1/Math.sqrt(a)),e[0]=n*a,e[1]=i*a,e[2]=s*a,e[3]=o*a,e}function Fy(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function Hy(e,t,n,i){var s=t[0],o=t[1],a=t[2],l=t[3];return e[0]=s+i*(n[0]-s),e[1]=o+i*(n[1]-o),e[2]=a+i*(n[2]-a),e[3]=l+i*(n[3]-l),e}function Ny(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3];return e[0]=n[0]*i+n[4]*s+n[8]*o+n[12]*a,e[1]=n[1]*i+n[5]*s+n[9]*o+n[13]*a,e[2]=n[2]*i+n[6]*s+n[10]*o+n[14]*a,e[3]=n[3]*i+n[7]*s+n[11]*o+n[15]*a,e}function By(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function zy(e,t){var n=e[0],i=e[1],s=e[2],o=e[3],a=t[0],l=t[1],h=t[2],c=t[3];return Math.abs(n-a)<=qm*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(i-l)<=qm*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(s-h)<=qm*Math.max(1,Math.abs(s),Math.abs(h))&&Math.abs(o-c)<=qm*Math.max(1,Math.abs(o),Math.abs(c))}var Gy=Cy,Uy=Py,Vy=Iy,jy=Oy,Wy=Ey,qy=Ry,Zy=Ly,Xy=function(){var e=xy();return function(t,n,i,s,o,a){var l,h;for(n||(n=4),i||(i=0),h=s?Math.min(s*n+i,t.length):t.length,l=i;l<h;l+=n)e[0]=t[l],e[1]=t[l+1],e[2]=t[l+2],e[3]=t[l+3],o(e,e,a),t[l]=e[0],t[l+1]=e[1],t[l+2]=e[2],t[l+3]=e[3];return t}}(),Yy=Object.freeze({__proto__:null,add:My,ceil:function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e},clone:by,copy:Ty,create:xy,cross:function(e,t,n,i){var s=n[0]*i[1]-n[1]*i[0],o=n[0]*i[2]-n[2]*i[0],a=n[0]*i[3]-n[3]*i[0],l=n[1]*i[2]-n[2]*i[1],h=n[1]*i[3]-n[3]*i[1],c=n[2]*i[3]-n[3]*i[2],u=t[0],f=t[1],g=t[2],m=t[3];return e[0]=f*c-g*h+m*l,e[1]=-u*c+g*a-m*o,e[2]=u*h-f*a+m*s,e[3]=-u*l+f*o-g*s,e},dist:jy,distance:Oy,div:Vy,divide:Iy,dot:Fy,equals:zy,exactEquals:By,floor:function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e},forEach:Xy,fromValues:wy,inverse:function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e},len:qy,length:Ry,lerp:Hy,max:function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e[3]=Math.max(t[3],n[3]),e},min:function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e[3]=Math.min(t[3],n[3]),e},mul:Uy,multiply:Py,negate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},normalize:Dy,random:function(e,t){var n,i,s,o,a,l;t=t||1;do{a=(n=2*Xm()-1)*n+(i=2*Xm()-1)*i}while(a>=1);do{l=(s=2*Xm()-1)*s+(o=2*Xm()-1)*o}while(l>=1);var h=Math.sqrt((1-a)/l);return e[0]=t*n,e[1]=t*i,e[2]=t*s*h,e[3]=t*o*h,e},round:function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e},scale:ky,scaleAndAdd:function(e,t,n,i){return e[0]=t[0]+n[0]*i,e[1]=t[1]+n[1]*i,e[2]=t[2]+n[2]*i,e[3]=t[3]+n[3]*i,e},set:Sy,sqrDist:Wy,sqrLen:Zy,squaredDistance:Ey,squaredLength:Ly,str:function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},sub:Gy,subtract:Cy,transformMat4:Ny,transformQuat:function(e,t,n){var i=t[0],s=t[1],o=t[2],a=n[0],l=n[1],h=n[2],c=n[3],u=c*i+l*o-h*s,f=c*s+h*i-a*o,g=c*o+a*s-l*i,m=-a*i-l*s-h*o;return e[0]=u*c+m*-a+f*-h-g*-l,e[1]=f*c+m*-l+g*-a-u*-h,e[2]=g*c+m*-h+u*-l-f*-a,e[3]=t[3],e},zero:function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e}});function Jy(){var e=new Zm(4);return Zm!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function Qy(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}function $y(e,t,n){n*=.5;var i=Math.sin(n);return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=Math.cos(n),e}function Ky(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3],l=n[0],h=n[1],c=n[2],u=n[3];return e[0]=i*u+a*l+s*c-o*h,e[1]=s*u+a*h+o*l-i*c,e[2]=o*u+a*c+i*h-s*l,e[3]=a*u-i*l-s*h-o*c,e}function e_(e,t,n){n*=.5;var i=t[0],s=t[1],o=t[2],a=t[3],l=Math.sin(n),h=Math.cos(n);return e[0]=i*h+a*l,e[1]=s*h+o*l,e[2]=o*h-s*l,e[3]=a*h-i*l,e}function t_(e,t,n){n*=.5;var i=t[0],s=t[1],o=t[2],a=t[3],l=Math.sin(n),h=Math.cos(n);return e[0]=i*h-o*l,e[1]=s*h+a*l,e[2]=o*h+i*l,e[3]=a*h-s*l,e}function n_(e,t,n){n*=.5;var i=t[0],s=t[1],o=t[2],a=t[3],l=Math.sin(n),h=Math.cos(n);return e[0]=i*h+s*l,e[1]=s*h-i*l,e[2]=o*h+a*l,e[3]=a*h-o*l,e}function r_(e,t){var n=t[0],i=t[1],s=t[2],o=t[3],a=Math.sqrt(n*n+i*i+s*s),l=Math.exp(o),h=a>0?l*Math.sin(a)/a:0;return e[0]=n*h,e[1]=i*h,e[2]=s*h,e[3]=l*Math.cos(a),e}function i_(e,t){var n=t[0],i=t[1],s=t[2],o=t[3],a=Math.sqrt(n*n+i*i+s*s),l=a>0?Math.atan2(a,o)/a:0;return e[0]=n*l,e[1]=i*l,e[2]=s*l,e[3]=.5*Math.log(n*n+i*i+s*s+o*o),e}function s_(e,t,n,i){var s,o,a,l,h,c=t[0],u=t[1],f=t[2],g=t[3],m=n[0],A=n[1],w=n[2],T=n[3];return(o=c*m+u*A+f*w+g*T)<0&&(o=-o,m=-m,A=-A,w=-w,T=-T),1-o>qm?(s=Math.acos(o),a=Math.sin(s),l=Math.sin((1-i)*s)/a,h=Math.sin(i*s)/a):(l=1-i,h=i),e[0]=l*c+h*m,e[1]=l*u+h*A,e[2]=l*f+h*w,e[3]=l*g+h*T,e}function o_(e,t){var n,i=t[0]+t[4]+t[8];if(i>0)n=Math.sqrt(i+1),e[3]=.5*n,e[0]=(t[5]-t[7])*(n=.5/n),e[1]=(t[6]-t[2])*n,e[2]=(t[1]-t[3])*n;else{var s=0;t[4]>t[0]&&(s=1),t[8]>t[3*s+s]&&(s=2);var o=(s+1)%3,a=(s+2)%3;n=Math.sqrt(t[3*s+s]-t[3*o+o]-t[3*a+a]+1),e[s]=.5*n,e[3]=(t[3*o+a]-t[3*a+o])*(n=.5/n),e[o]=(t[3*o+s]+t[3*s+o])*n,e[a]=(t[3*a+s]+t[3*s+a])*n}return e}function a_(e,t,n,i){var s=.5*Math.PI/180;t*=s,n*=s,i*=s;var o=Math.sin(t),a=Math.cos(t),l=Math.sin(n),h=Math.cos(n),c=Math.sin(i),u=Math.cos(i);return e[0]=o*h*u-a*l*c,e[1]=a*l*u+o*h*c,e[2]=a*h*c-o*l*u,e[3]=a*h*u+o*l*c,e}var l_,h_,c_,u_,f_,d_,p_=by,g_=wy,m_=Ty,A_=Sy,y_=My,__=Ky,v_=ky,x_=Fy,b_=Hy,w_=Ry,T_=w_,S_=Ly,M_=S_,C_=Dy,P_=By,I_=zy,k_=(l_=VA(),h_=WA(1,0,0),c_=WA(0,1,0),function(e,t,n){var i=iy(t,n);return i<-.999999?(sy(l_,h_,t),Ay(l_)<1e-6&&sy(l_,c_,t),ry(l_,l_),$y(e,l_,Math.PI),e):i>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(sy(l_,t,n),e[0]=l_[0],e[1]=l_[1],e[2]=l_[2],e[3]=1+i,C_(e,e))}),O_=(u_=Jy(),f_=Jy(),function(e,t,n,i,s,o){return s_(u_,t,s,o),s_(f_,n,i,o),s_(e,u_,f_,2*o*(1-o)),e}),E_=(d_=sA(),function(e,t,n,i){return d_[0]=n[0],d_[3]=n[1],d_[6]=n[2],d_[1]=i[0],d_[4]=i[1],d_[7]=i[2],d_[2]=-t[0],d_[5]=-t[1],d_[8]=-t[2],C_(e,o_(e,d_))}),R_=Object.freeze({__proto__:null,add:y_,calculateW:function(e,t){var n=t[0],i=t[1],s=t[2];return e[0]=n,e[1]=i,e[2]=s,e[3]=Math.sqrt(Math.abs(1-n*n-i*i-s*s)),e},clone:p_,conjugate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},copy:m_,create:Jy,dot:x_,equals:I_,exactEquals:P_,exp:r_,fromEuler:a_,fromMat3:o_,fromValues:g_,getAngle:function(e,t){var n=x_(e,t);return Math.acos(2*n*n-1)},getAxisAngle:function(e,t){var n=2*Math.acos(t[3]),i=Math.sin(n/2);return i>qm?(e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i):(e[0]=1,e[1]=0,e[2]=0),n},identity:Qy,invert:function(e,t){var n=t[0],i=t[1],s=t[2],o=t[3],a=n*n+i*i+s*s+o*o,l=a?1/a:0;return e[0]=-n*l,e[1]=-i*l,e[2]=-s*l,e[3]=o*l,e},len:T_,length:w_,lerp:b_,ln:i_,mul:__,multiply:Ky,normalize:C_,pow:function(e,t,n){return i_(e,t),v_(e,e,n),r_(e,e),e},random:function(e){var t=Xm(),n=Xm(),i=Xm(),s=Math.sqrt(1-t),o=Math.sqrt(t);return e[0]=s*Math.sin(2*Math.PI*n),e[1]=s*Math.cos(2*Math.PI*n),e[2]=o*Math.sin(2*Math.PI*i),e[3]=o*Math.cos(2*Math.PI*i),e},rotateX:e_,rotateY:t_,rotateZ:n_,rotationTo:k_,scale:v_,set:A_,setAxes:E_,setAxisAngle:$y,slerp:s_,sqlerp:O_,sqrLen:M_,squaredLength:S_,str:function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}});function L_(e,t,n){var i=.5*n[0],s=.5*n[1],o=.5*n[2],a=t[0],l=t[1],h=t[2],c=t[3];return e[0]=a,e[1]=l,e[2]=h,e[3]=c,e[4]=i*c+s*h-o*l,e[5]=s*c+o*a-i*h,e[6]=o*c+i*l-s*a,e[7]=-i*a-s*l-o*h,e}function D_(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e}function F_(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3],l=n[4],h=n[5],c=n[6],u=n[7],f=t[4],g=t[5],m=t[6],A=t[7],w=n[0],T=n[1],S=n[2],M=n[3];return e[0]=i*M+a*w+s*S-o*T,e[1]=s*M+a*T+o*w-i*S,e[2]=o*M+a*S+i*T-s*w,e[3]=a*M-i*w-s*T-o*S,e[4]=i*u+a*l+s*c-o*h+f*M+A*w+g*S-m*T,e[5]=s*u+a*h+o*l-i*c+g*M+A*T+m*w-f*S,e[6]=o*u+a*c+i*h-s*l+m*M+A*S+f*T-g*w,e[7]=a*u-i*l-s*h-o*c+A*M-f*w-g*T-m*S,e}var H_=x_;var N_=S_;var B_=Object.freeze({__proto__:null,add:function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e[4]=t[4]+n[4],e[5]=t[5]+n[5],e[6]=t[6]+n[6],e[7]=t[7]+n[7],e},clone:function(e){var t=new Zm(8);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t},conjugate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=t[7],e},copy:D_,create:function(){var e=new Zm(8);return Zm!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0),e[3]=1,e},dot:H_,equals:function(e,t){var n=e[0],i=e[1],s=e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=t[0],f=t[1],g=t[2],m=t[3],A=t[4],w=t[5],T=t[6],S=t[7];return Math.abs(n-u)<=qm*Math.max(1,Math.abs(n),Math.abs(u))&&Math.abs(i-f)<=qm*Math.max(1,Math.abs(i),Math.abs(f))&&Math.abs(s-g)<=qm*Math.max(1,Math.abs(s),Math.abs(g))&&Math.abs(o-m)<=qm*Math.max(1,Math.abs(o),Math.abs(m))&&Math.abs(a-A)<=qm*Math.max(1,Math.abs(a),Math.abs(A))&&Math.abs(l-w)<=qm*Math.max(1,Math.abs(l),Math.abs(w))&&Math.abs(h-T)<=qm*Math.max(1,Math.abs(h),Math.abs(T))&&Math.abs(c-S)<=qm*Math.max(1,Math.abs(c),Math.abs(S))},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]},fromMat4:function(e,t){var n=Jy();OA(n,t);var i=new Zm(3);return PA(i,t),L_(e,n,i),e},fromRotation:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},fromRotationTranslation:L_,fromRotationTranslationValues:function(e,t,n,i,s,o,a){var l=new Zm(8);l[0]=e,l[1]=t,l[2]=n,l[3]=i;var h=.5*s,c=.5*o,u=.5*a;return l[4]=h*i+c*n-u*t,l[5]=c*i+u*e-h*n,l[6]=u*i+h*t-c*e,l[7]=-h*e-c*t-u*n,l},fromTranslation:function(e,t){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=.5*t[0],e[5]=.5*t[1],e[6]=.5*t[2],e[7]=0,e},fromValues:function(e,t,n,i,s,o,a,l){var h=new Zm(8);return h[0]=e,h[1]=t,h[2]=n,h[3]=i,h[4]=s,h[5]=o,h[6]=a,h[7]=l,h},getDual:function(e,t){return e[0]=t[4],e[1]=t[5],e[2]=t[6],e[3]=t[7],e},getReal:m_,getTranslation:function(e,t){var n=t[4],i=t[5],s=t[6],o=t[7],a=-t[0],l=-t[1],h=-t[2],c=t[3];return e[0]=2*(n*c+o*a+i*h-s*l),e[1]=2*(i*c+o*l+s*a-n*h),e[2]=2*(s*c+o*h+n*l-i*a),e},identity:function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},invert:function(e,t){var n=N_(t);return e[0]=-t[0]/n,e[1]=-t[1]/n,e[2]=-t[2]/n,e[3]=t[3]/n,e[4]=-t[4]/n,e[5]=-t[5]/n,e[6]=-t[6]/n,e[7]=t[7]/n,e},len:w_,length:w_,lerp:function(e,t,n,i){var s=1-i;return H_(t,n)<0&&(i=-i),e[0]=t[0]*s+n[0]*i,e[1]=t[1]*s+n[1]*i,e[2]=t[2]*s+n[2]*i,e[3]=t[3]*s+n[3]*i,e[4]=t[4]*s+n[4]*i,e[5]=t[5]*s+n[5]*i,e[6]=t[6]*s+n[6]*i,e[7]=t[7]*s+n[7]*i,e},mul:F_,multiply:F_,normalize:function(e,t){var n=N_(t);if(n>0){n=Math.sqrt(n);var i=t[0]/n,s=t[1]/n,o=t[2]/n,a=t[3]/n,l=t[4],h=t[5],c=t[6],u=t[7],f=i*l+s*h+o*c+a*u;e[0]=i,e[1]=s,e[2]=o,e[3]=a,e[4]=(l-i*f)/n,e[5]=(h-s*f)/n,e[6]=(c-o*f)/n,e[7]=(u-a*f)/n}return e},rotateAroundAxis:function(e,t,n,i){if(Math.abs(i)<qm)return D_(e,t);var s=Math.hypot(n[0],n[1],n[2]);i*=.5;var o=Math.sin(i),a=o*n[0]/s,l=o*n[1]/s,h=o*n[2]/s,c=Math.cos(i),u=t[0],f=t[1],g=t[2],m=t[3];e[0]=u*c+m*a+f*h-g*l,e[1]=f*c+m*l+g*a-u*h,e[2]=g*c+m*h+u*l-f*a,e[3]=m*c-u*a-f*l-g*h;var A=t[4],w=t[5],T=t[6],S=t[7];return e[4]=A*c+S*a+w*h-T*l,e[5]=w*c+S*l+T*a-A*h,e[6]=T*c+S*h+A*l-w*a,e[7]=S*c-A*a-w*l-T*h,e},rotateByQuatAppend:function(e,t,n){var i=n[0],s=n[1],o=n[2],a=n[3],l=t[0],h=t[1],c=t[2],u=t[3];return e[0]=l*a+u*i+h*o-c*s,e[1]=h*a+u*s+c*i-l*o,e[2]=c*a+u*o+l*s-h*i,e[3]=u*a-l*i-h*s-c*o,e[4]=(l=t[4])*a+(u=t[7])*i+(h=t[5])*o-(c=t[6])*s,e[5]=h*a+u*s+c*i-l*o,e[6]=c*a+u*o+l*s-h*i,e[7]=u*a-l*i-h*s-c*o,e},rotateByQuatPrepend:function(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3],l=n[0],h=n[1],c=n[2],u=n[3];return e[0]=i*u+a*l+s*c-o*h,e[1]=s*u+a*h+o*l-i*c,e[2]=o*u+a*c+i*h-s*l,e[3]=a*u-i*l-s*h-o*c,e[4]=i*(u=n[7])+a*(l=n[4])+s*(c=n[6])-o*(h=n[5]),e[5]=s*u+a*h+o*l-i*c,e[6]=o*u+a*c+i*h-s*l,e[7]=a*u-i*l-s*h-o*c,e},rotateX:function(e,t,n){var i=-t[0],s=-t[1],o=-t[2],a=t[3],l=t[4],h=t[5],c=t[6],u=t[7],f=l*a+u*i+h*o-c*s,g=h*a+u*s+c*i-l*o,m=c*a+u*o+l*s-h*i,A=u*a-l*i-h*s-c*o;return e_(e,t,n),e[4]=f*(a=e[3])+A*(i=e[0])+g*(o=e[2])-m*(s=e[1]),e[5]=g*a+A*s+m*i-f*o,e[6]=m*a+A*o+f*s-g*i,e[7]=A*a-f*i-g*s-m*o,e},rotateY:function(e,t,n){var i=-t[0],s=-t[1],o=-t[2],a=t[3],l=t[4],h=t[5],c=t[6],u=t[7],f=l*a+u*i+h*o-c*s,g=h*a+u*s+c*i-l*o,m=c*a+u*o+l*s-h*i,A=u*a-l*i-h*s-c*o;return t_(e,t,n),e[4]=f*(a=e[3])+A*(i=e[0])+g*(o=e[2])-m*(s=e[1]),e[5]=g*a+A*s+m*i-f*o,e[6]=m*a+A*o+f*s-g*i,e[7]=A*a-f*i-g*s-m*o,e},rotateZ:function(e,t,n){var i=-t[0],s=-t[1],o=-t[2],a=t[3],l=t[4],h=t[5],c=t[6],u=t[7],f=l*a+u*i+h*o-c*s,g=h*a+u*s+c*i-l*o,m=c*a+u*o+l*s-h*i,A=u*a-l*i-h*s-c*o;return n_(e,t,n),e[4]=f*(a=e[3])+A*(i=e[0])+g*(o=e[2])-m*(s=e[1]),e[5]=g*a+A*s+m*i-f*o,e[6]=m*a+A*o+f*s-g*i,e[7]=A*a-f*i-g*s-m*o,e},scale:function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e},set:function(e,t,n,i,s,o,a,l,h){return e[0]=t,e[1]=n,e[2]=i,e[3]=s,e[4]=o,e[5]=a,e[6]=l,e[7]=h,e},setDual:function(e,t){return e[4]=t[0],e[5]=t[1],e[6]=t[2],e[7]=t[3],e},setReal:m_,sqrLen:N_,squaredLength:N_,str:function(e){return"quat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+")"},translate:function(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3],l=.5*n[0],h=.5*n[1],c=.5*n[2],u=t[4],f=t[5],g=t[6],m=t[7];return e[0]=i,e[1]=s,e[2]=o,e[3]=a,e[4]=a*l+s*c-o*h+u,e[5]=a*h+o*l-i*c+f,e[6]=a*c+i*h-s*l+g,e[7]=-i*l-s*h-o*c+m,e}});function z_(){var e=new Zm(2);return Zm!=Float32Array&&(e[0]=0,e[1]=0),e}function G_(e,t){return e[0]=t[0],e[1]=t[1],e}function U_(e,t,n){return e[0]=t,e[1]=n,e}function V_(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e}function j_(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e}function W_(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e}function q_(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e}function Z_(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e}function X_(e,t){return Math.hypot(t[0]-e[0],t[1]-e[1])}function Y_(e,t){var n=t[0]-e[0],i=t[1]-e[1];return n*n+i*i}function J_(e){return Math.hypot(e[0],e[1])}function Q_(e){var t=e[0],n=e[1];return t*t+n*n}function $_(e,t,n){var i=t[0],s=t[1];return e[0]=n[0]*i+n[2]*s,e[1]=n[1]*i+n[3]*s,e}function K_(e,t,n,i){var s=t[0]-n[0],o=t[1]-n[1],a=Math.sin(i),l=Math.cos(i);return e[0]=s*l-o*a+n[0],e[1]=s*a+o*l+n[1],e}function ev(e,t){return e[0]===t[0]&&e[1]===t[1]}var tv=J_,nv=j_,rv=W_,iv=q_,sv=X_,ov=Y_,av=Q_,lv=function(){var e=z_();return function(t,n,i,s,o,a){var l,h;for(n||(n=2),i||(i=0),h=s?Math.min(s*n+i,t.length):t.length,l=i;l<h;l+=n)e[0]=t[l],e[1]=t[l+1],o(e,e,a),t[l]=e[0],t[l+1]=e[1];return t}}(),hv=Object.freeze({__proto__:null,add:V_,angle:function(e,t){var n=e[0],i=e[1],s=t[0],o=t[1],a=Math.sqrt(n*n+i*i)*Math.sqrt(s*s+o*o);return Math.acos(Math.min(Math.max(a&&(n*s+i*o)/a,-1),1))},ceil:function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e},clone:function(e){var t=new Zm(2);return t[0]=e[0],t[1]=e[1],t},copy:G_,create:z_,cross:function(e,t,n){var i=t[0]*n[1]-t[1]*n[0];return e[0]=e[1]=0,e[2]=i,e},dist:sv,distance:X_,div:iv,divide:q_,dot:function(e,t){return e[0]*t[0]+e[1]*t[1]},equals:function(e,t){var n=e[0],i=e[1],s=t[0],o=t[1];return Math.abs(n-s)<=qm*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(i-o)<=qm*Math.max(1,Math.abs(i),Math.abs(o))},exactEquals:ev,floor:function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e},forEach:lv,fromValues:function(e,t){var n=new Zm(2);return n[0]=e,n[1]=t,n},inverse:function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e},len:tv,length:J_,lerp:function(e,t,n,i){var s=t[0],o=t[1];return e[0]=s+i*(n[0]-s),e[1]=o+i*(n[1]-o),e},max:function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e},min:function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e},mul:rv,multiply:W_,negate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e},normalize:function(e,t){var n=t[0],i=t[1],s=n*n+i*i;return s>0&&(s=1/Math.sqrt(s)),e[0]=t[0]*s,e[1]=t[1]*s,e},random:function(e,t){t=t||1;var n=2*Xm()*Math.PI;return e[0]=Math.cos(n)*t,e[1]=Math.sin(n)*t,e},rotate:K_,round:function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e},scale:Z_,scaleAndAdd:function(e,t,n,i){return e[0]=t[0]+n[0]*i,e[1]=t[1]+n[1]*i,e},set:U_,sqrDist:ov,sqrLen:av,squaredDistance:Y_,squaredLength:Q_,str:function(e){return"vec2("+e[0]+", "+e[1]+")"},sub:nv,subtract:j_,transformMat2:$_,transformMat2d:function(e,t,n){var i=t[0],s=t[1];return e[0]=n[0]*i+n[2]*s+n[4],e[1]=n[1]*i+n[3]*s+n[5],e},transformMat3:function(e,t,n){var i=t[0],s=t[1];return e[0]=n[0]*i+n[3]*s+n[6],e[1]=n[1]*i+n[4]*s+n[7],e},transformMat4:function(e,t,n){var i=t[0],s=t[1];return e[0]=n[0]*i+n[4]*s+n[12],e[1]=n[1]*i+n[5]*s+n[13],e},zero:function(e){return e[0]=0,e[1]=0,e}}),cv="undefined"!=typeof Float32Array?Float32Array:Array;function uv(){var e=new cv(3);return cv!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function fv(e,t,n){var i=new cv(3);return i[0]=e,i[1]=t,i[2]=n,i}function dv(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function pv(e,t,n,i){return e[0]=t,e[1]=n,e[2]=i,e}function gv(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e}function mv(e,t){var n=t[0],i=t[1],s=t[2],o=n*n+i*i+s*s;return o>0&&(o=1/Math.sqrt(o),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o),e}function Av(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function yv(e,t,n){var i=t[0],s=t[1],o=t[2],a=n[0],l=n[1],h=n[2];return e[0]=s*h-o*l,e[1]=o*a-i*h,e[2]=i*l-s*a,e}var _v=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e};function vv(){var e=new cv(4);return cv!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function xv(e,t){var n=t[0]+t[4]+t[8],i=void 0;if(n>0)i=Math.sqrt(n+1),e[3]=.5*i,e[0]=(t[5]-t[7])*(i=.5/i),e[1]=(t[6]-t[2])*i,e[2]=(t[1]-t[3])*i;else{var s=0;t[4]>t[0]&&(s=1),t[8]>t[3*s+s]&&(s=2);var o=(s+1)%3,a=(s+2)%3;i=Math.sqrt(t[3*s+s]-t[3*o+o]-t[3*a+a]+1),e[s]=.5*i,e[3]=(t[3*o+a]-t[3*a+o])*(i=.5/i),e[o]=(t[3*o+s]+t[3*s+o])*i,e[a]=(t[3*a+s]+t[3*s+a])*i}return e}!function(){var e=uv()}(),function(){var e,t=(e=new cv(4),cv!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e)}();var bv=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e},wv=function(e,t){var n=t[0],i=t[1],s=t[2],o=t[3],a=n*n+i*i+s*s+o*o;return a>0&&(a=1/Math.sqrt(a),e[0]=n*a,e[1]=i*a,e[2]=s*a,e[3]=o*a),e};!function(){var e=uv(),t=fv(1,0,0),n=fv(0,1,0)}(),function(){var e=vv(),t=vv()}(),function(){var e,t=(e=new cv(9),cv!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e)}();
/*!
   * Contains code from google filament
   * https://github.com/google/filament/
   * License Apache-2.0
   */
const Tv=8,Sv=[],Mv=[],Cv=[],Pv=[];function Iv(e,t,n){const i=yv(Mv,t,n);e=xv(e,function(e,t,n,i,s,o,a,l,h,c){return e[0]=t,e[1]=n,e[2]=i,e[3]=s,e[4]=o,e[5]=a,e[6]=l,e[7]=h,e[8]=c,e}(Sv,n[0],n[1],n[2],...i,...t)),e=function(e){return e[3]<0?bv(e,e,-1):e}(e=wv(e,e));const s=1/((1<<2*Tv-1)-1);if(e[3]<s){e[3]=s;const t=Math.sqrt(1-s*s);e[0]*=t,e[1]*=t,e[2]*=t}const o=n[3]>0?yv(Cv,n,t):yv(Cv,t,n);return Av(yv(Pv,n,t),o)<0&&bv(e,e,-1),e}const kv=[];function Ov(e,t,n){const i=n||[];i.setLength&&i.setLength(e.length);const s=kv;s.length<e.length/3&&(s.length=e.length/3),s.fill(0,0,e.length/3);const o=void 0===t.length?t:t.length;for(let n=0;n<o/3;n++)void 0===t.length?Bv(e,3*n,3*n+1,3*n+2,i,s):Bv(e,t[3*n],t[3*n+1],t[3*n+2],i,s);for(let e=0;e<i.length;e+=3){const t=s[e/3];0!==t?(i[e]/=t,i[e+1]/=t,i[e+2]/=t):(i[e]=0,i[e+1]=0,i[e+2]=0)}return i}const Ev=[],Rv=[],Lv=[],Dv=[],Fv=[],Hv=[],Nv=[];function Bv(e,t,n,i,s,o){pv(Dv,e[3*t],e[3*t+1],e[3*t+2]),pv(Fv,e[3*n],e[3*n+1],e[3*n+2]),pv(Hv,e[3*i],e[3*i+1],e[3*i+2]);const a=_v(Ev,Hv,Fv),l=_v(Rv,Dv,Fv),h=yv(Lv,a,l);mv(Nv,h),s[3*t]=s[3*t]||0,s[3*n]=s[3*n]||0,s[3*i]=s[3*i]||0,s[3*t+1]=s[3*t+1]||0,s[3*n+1]=s[3*n+1]||0,s[3*i+1]=s[3*i+1]||0,s[3*t+2]=s[3*t+2]||0,s[3*n+2]=s[3*n+2]||0,s[3*i+2]=s[3*i+2]||0,s[3*t]+=Nv[0],s[3*n]+=Nv[0],s[3*i]+=Nv[0],s[3*t+1]+=Nv[1],s[3*n+1]+=Nv[1],s[3*i+1]+=Nv[1],s[3*t+2]+=Nv[2],s[3*n+2]+=Nv[2],s[3*i+2]+=Nv[2],o[t]+=1,o[n]+=1,o[i]+=1}
/*!
   * Contains code from THREE.JS
   * https://github.com/mrdoob/three.js/
   * License MIT
   * 
   * Generate tangents per vertex.
   */function zv(e,t,n,i,s){const o=e.length/3,a=s||new Array(4*o),l=[],h=[];for(let e=0;e<o;e++)l[e]=[0,0,0],h[e]=[0,0,0];const c=[0,0,0],u=[0,0,0],f=[0,0,0],g=[0,0],m=[0,0],A=[0,0],w=[0,0,0],T=[0,0,0];function S(t,i,s){Gv(c,e,3*t),Gv(u,e,3*i),Gv(f,e,3*s),Uv(g,n,2*t),Uv(m,n,2*i),Uv(A,n,2*s);const o=u[0]-c[0],a=f[0]-c[0],S=u[1]-c[1],M=f[1]-c[1],C=u[2]-c[2],I=f[2]-c[2],E=m[0]-g[0],D=A[0]-g[0],H=m[1]-g[1],N=A[1]-g[1],B=1/(E*N-D*H);pv(w,(N*o-H*a)*B,(N*S-H*M)*B,(N*C-H*I)*B),pv(T,(E*a-D*o)*B,(E*M-D*S)*B,(E*I-D*C)*B),gv(l[t],l[t],w),gv(l[i],l[i],w),gv(l[s],l[s],w),gv(h[t],h[t],T),gv(h[i],h[i],T),gv(h[s],h[s],T)}for(let e=0,t=i.length;e<t;e+=3)S(i[e+0],i[e+1],i[e+2]);const M=[],C=[],I=[],E=[];let D,H,N;function B(e){Gv(I,t,3*e),dv(E,I),H=l[e],dv(M,H),_v(M,M,function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}(I,I,Av(I,H))),mv(M,M),yv(C,E,H),N=Av(C,h[e]),D=N<0?-1:1,a[4*e]=M[0],a[4*e+1]=M[1],a[4*e+2]=M[2],a[4*e+3]=D}for(let e=0,t=i.length;e<t;e+=3)B(i[e+0]),B(i[e+1]),B(i[e+2]);return a}function Gv(e,t,n){return e[0]=t[n],e[1]=t[n+1],e[2]=t[n+2],e}function Uv(e,t,n){return e[0]=t[n],e[1]=t[n+1],e}var Vv=Array.isArray,jv=Object.keys,Wv=Object.prototype.hasOwnProperty,qv=function e(t,n){if(t===n)return!0;if(t&&n&&"object"==typeof t&&"object"==typeof n){var i,s,o,a=Vv(t),l=Vv(n);if(a&&l){if((s=t.length)!=n.length)return!1;for(i=s;0!=i--;)if(!e(t[i],n[i]))return!1;return!0}if(a!=l)return!1;var h=t instanceof Date,c=n instanceof Date;if(h!=c)return!1;if(h&&c)return t.getTime()==n.getTime();var u=t instanceof RegExp,f=n instanceof RegExp;if(u!=f)return!1;if(u&&f)return t.toString()==n.toString();var g=jv(t);if((s=g.length)!==jv(n).length)return!1;for(i=s;0!=i--;)if(!Wv.call(n,g[i]))return!1;for(i=s;0!=i--;)if(!e(t[o=g[i]],n[o]))return!1;return!0}return t!=t&&n!=n},Zv=Vm(qv);
/*!
   * @maptalks/fusiongl v0.10.1
   * LICENSE : UNLICENSED
   * (c) 2016-2025 maptalks.com
   */
function Xv(e){for(let t=1;t<arguments.length;t++){const n=arguments[t];for(const t in n)e[t]=n[t]}return e}function Yv(e,...t){for(let n=0;n<t.length;n++)Xv(e,t[n])}class DrawBuffersExt{constructor(e){this.context=e,this.COLOR_ATTACHMENT0_WEBGL=36064,this.COLOR_ATTACHMENT1_WEBGL=36065,this.COLOR_ATTACHMENT2_WEBGL=36066,this.COLOR_ATTACHMENT3_WEBGL=36067,this.COLOR_ATTACHMENT4_WEBGL=36068,this.COLOR_ATTACHMENT5_WEBGL=36069,this.COLOR_ATTACHMENT6_WEBGL=36070,this.COLOR_ATTACHMENT7_WEBGL=36071,this.COLOR_ATTACHMENT8_WEBGL=36072,this.COLOR_ATTACHMENT9_WEBGL=36073,this.COLOR_ATTACHMENT10_WEBGL=577040,this.COLOR_ATTACHMENT11_WEBGL=577041,this.COLOR_ATTACHMENT12_WEBGL=577042,this.COLOR_ATTACHMENT13_WEBGL=577043,this.COLOR_ATTACHMENT14_WEBGL=577044,this.COLOR_ATTACHMENT15_WEBGL=577045,this.DRAW_BUFFER0_WEBGL=34853,this.DRAW_BUFFER1_WEBGL=34854,this.DRAW_BUFFER2_WEBGL=34855,this.DRAW_BUFFER3_WEBGL=34856,this.DRAW_BUFFER4_WEBGL=34857,this.DRAW_BUFFER5_WEBGL=34858,this.DRAW_BUFFER6_WEBGL=34859,this.DRAW_BUFFER7_WEBGL=34860,this.DRAW_BUFFER8_WEBGL=34861,this.DRAW_BUFFER9_WEBGL=34862,this.DRAW_BUFFER10_WEBGL=34863,this.DRAW_BUFFER11_WEBGL=34864,this.DRAW_BUFFER12_WEBGL=34865,this.DRAW_BUFFER13_WEBGL=34866,this.DRAW_BUFFER14_WEBGL=34867,this.DRAW_BUFFER15_WEBGL=34868,this.MAX_COLOR_ATTACHMENTS_WEBGL=36063,this.MAX_DRAW_BUFFERS_WEBGL=2178}drawBuffersWEBGL(){return this.context.drawBuffers.apply(this.context,arguments)}}class VertexArrayObjectExt{constructor(e){this.context=e,this.VERTEX_ARRAY_BINDING_OES=34229}createVertexArrayOES(){return this.context.createVertexArray()}deleteVertexArrayOES(){return this.context.deleteVertexArray.apply(this.context,arguments)}isVertexArrayOES(){return this.context.isVertexArray.apply(this.context,arguments)}bindVertexArrayOES(){return this.context.bindVertexArray.apply(this.context,arguments)}}class AngleInstancedArrayExt{constructor(e){this.context=e,this.VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE=35070}drawArraysInstancedANGLE(){return this.context.drawArraysInstanced.apply(this.context,arguments)}drawElementsInstancedANGLE(){return this.context.drawElementsInstanced.apply(this.context,arguments)}vertexAttribDivisorANGLE(){return this.context.vertexAttribDivisor.apply(this.context,arguments)}}const Jv=36193,Qv={webgl_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},oes_element_index_uint:{},oes_texture_float:{},oes_texture_half_float:{HALF_FLOAT_OES:36193},ext_color_buffer_float:{},oes_standard_derivatives:{},ext_frag_depth:{},ext_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},ext_shader_texture_lod:{}},$v={has(e,t){const n=e.t;return!(!n&&!e.i.getExtension(t))&&(t=t.toLowerCase(),n&&Qv[t]||"webgl_draw_buffers"===t||"oes_vertex_array_object"===t||"angle_instanced_arrays"===t)},mock:(e,t)=>(t=t.toLowerCase(),Qv[t]?e.t?("oes_texture_float"!==t&&"oes_texture_half_float"!==t||e.i.getExtension("EXT_color_buffer_float"),Qv[t]):e.i.getExtension(t):"webgl_draw_buffers"===t?new DrawBuffersExt(e):"oes_vertex_array_object"===t?new VertexArrayObjectExt(e):"angle_instanced_arrays"===t?new AngleInstancedArrayExt(e):null),getInternalFormat:(e,t,n)=>6402===t?33190:34041===t?35056:n===Jv&&t===e.RGBA?34842:n===Jv&&t===e.RGB?34843:n===e.FLOAT&&t===e.RGBA?34836:n===e.FLOAT&&t===e.RGB?34837:t,getTextureType:(e,t)=>t===Jv?e.HALF_FLOAT:t};let Kv=1,ex=class WebGL2RenderingContext{constructor(e){this.uid=Kv++,this.states=function(e){return{scissor:[0,0,e.canvas.width,e.canvas.height],viewport:[0,0,e.canvas.width,e.canvas.height],blendColor:[0,0,0,0],blendEquationSeparate:[e.FUNC_ADD,e.FUNC_ADD],blendFuncSeparate:[e.ONE,e.ZERO,e.ONE,e.ZERO],clearColor:[0,0,0,0],clearDepth:[1],clearStencil:[0],colorMask:[!0,!0,!0,!0],cullFace:[e.BACK],depthFunc:[e.LESS],depthMask:[!0],depthRange:[0,1],capabilities:{3042:!1,2884:!1,2929:!1,3024:!1,32823:!1,32926:!1,32928:!1,3089:!1,2960:!1},frontFace:[e.CCW],hint:{33170:[e.DONT_CARE],35723:[e.DONT_CARE]},lineWidth:[1],pixelStorei:{3333:[4],3317:[4],37440:[!1],37441:[!1],37443:[e.BROWSER_DEFAULT_WEBGL]},polygonOffset:[0,0],sampleCoverage:[1,!1],stencilFuncSeparate:{1028:[e.ALWAYS,0,4294967295],1029:[e.ALWAYS,0,4294967295]},stencilMaskSeparate:{1028:[4294967295],1029:[4294967295]},stencilOpSeparate:{1028:[e.KEEP,e.KEEP,e.KEEP],1029:[e.KEEP,e.KEEP,e.KEEP]},program:null,framebuffer:{36160:null,36008:null,36009:null},renderbuffer:{36161:null},textures:{active:-1,units:function(){const t=[],n=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS);for(let e=0;e<n;e++)t.push({3553:null,34067:null});return t[-1]={3553:null,34067:null},t}()},attributes:{},arrayBuffer:null,elementArrayBuffer:null}}(e),this.i=e,this.i._fusiongl_drawCalls=0,this.t=void 0!==window.WebGL2RenderingContext&&this.i instanceof window.WebGL2RenderingContext;const t=Object.getPrototypeOf(this);Object.setPrototypeOf(t,this.t?window.WebGL2RenderingContext.prototype:WebGLRenderingContext.prototype),this.h=e.getParameter(e.MAX_VERTEX_ATTRIBS)}get canvas(){return this.i.canvas}get drawingBufferWidth(){return this.i.drawingBufferWidth}get drawingBufferHeight(){return this.i.drawingBufferHeight}get drawingBufferColorSpace(){return this.i.drawingBufferColorSpace}set drawingBufferColorSpace(e){this.i.drawingBufferColorSpace=e}get gl(){return this.i}get buffersOES(){return this.u||(this.u=this.i.getExtension("WEBGL_draw_buffers")),this.u}get vaoOES(){return this.o||(this.o=this.i.getExtension("OES_vertex_array_object")),this.o}get angleOES(){return this.l||(this.l=this.i.getExtension("ANGLE_instanced_arrays")),this.l}get standOES(){return this.m||(this.m=this.i.getExtension("OES_standard_derivatives")),this.m}attachShader(e,t){return this.i.attachShader(e,t)}shaderSource(e,t){return this.i.shaderSource(e,t)}compileShader(e){return this.i.compileShader(e)}createShader(e){return this.i.createShader(e)}createProgram(){return this.i.createProgram()}deleteProgram(e){return this.states.program===e&&(this.states.program=null),this.i.deleteProgram(e)}deleteShader(e){return this.i.deleteShader(e)}detachShader(e,t){return this.i.detachShader(e,t)}getAttachedShaders(e){return this.i.getAttachedShaders(e)}linkProgram(e){return this.i.linkProgram(e)}makeXRCompatible(){return this.i.makeXRCompatible()}getShaderParameter(e,t){return this.i.getShaderParameter(e,t)}getShaderPrecisionFormat(e,t){return this.i.getShaderPrecisionFormat(e,t)}getShaderInfoLog(e){return this.i.getShaderInfoLog(e)}getShaderSource(e){return this.i.getShaderSource(e)}getProgramInfoLog(e){return this.i.getProgramInfoLog(e)}getProgramParameter(e,t){return this.i.getProgramParameter(e,t)}getError(){return this.i.getError()}getContextAttributes(){return this.i.getContextAttributes()}getExtension(e){return $v.has(this,e)?$v.mock(this,e):this.i.getExtension(e)}getSupportedExtensions(){return this.i.getSupportedExtensions()}getParameter(e){return this.i.getParameter(e)}isEnabled(e){return this.i.isEnabled(e)}isProgram(e){return this.i.isProgram(e)}isShader(e){return this.i.isShader(e)}validateProgram(e){return this.i.validateProgram(e)}clear(e){return this.v(),this.i.clear(e)}drawArrays(e,t,n){return this.v(),this._(),this.i.drawArrays(e,t,n)}drawElements(e,t,n,i){return this.v(),this._(),this.i.drawElements(e,t,n,i)}drawBuffers(e){return this.v(),this._(),this.t?this.i.drawBuffers(e):this.buffersOES.drawBuffersWEBGL(e)}_(){this.i._fusiongl_drawCalls++}resetDrawCalls(){this.i._fusiongl_drawCalls=0}getDrawCalls(){return this.i._fusiongl_drawCalls}S(){const e=this.i,t=e.getParameter(e.CURRENT_PROGRAM),n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),i=[];for(let t=0;t<n;t++)i.push(e.getVertexAttrib(t,e.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING));this.A={buffers:i,elements:e.getParameter(e.ELEMENT_ARRAY_BUFFER_BINDING),framebuffer:e.getParameter(e.FRAMEBUFFER_BINDING)},window.DEBUGGING&&(console.log(this.uid,this.A),console.log(this.uid,this.states.attributes),console.log(this.states.attributes[0].buffer===this.A.buffers[0]),console.log(this.states.attributes[1].buffer===this.A.buffers[1]),console.log(this.states.attributes[2].buffer===this.A.buffers[2]))}finish(){return this.i.finish()}flush(){return this.v(),this.i.flush()}commit(){return this.v(),this.i.commit()}isContextLost(){return this.i.isContextLost()}getFragDataLocation(e,t){return this.i.getFragDataLocation(e,t)}createSampler(){return this.i.createSampler()}deleteSampler(){return this.i.deleteSampler()}bindSampler(){return this.i.bindSampler()}isSampler(){return this.i.isSampler()}getSamplerParameter(){return this.i.getSamplerParameter()}isQuery(e){return this.i.beginQuery(e)}beginQuery(e,t){return this.i.beginQuery(e,t)}deleteQuery(e){return this.i.query(e)}isTransformFeedback(e){return this.i.isTransformFeedback(e)}beginTransformFeedback(e){return this.i.beginTransformFeedback(e)}deleteTransformFeedback(e){return this.i.deleteTransformFeedback(e)}pauseTransformFeedback(){return this.i.pauseTransformFeedback()}resumeTransformFeedback(){return this.i.resumeTransformFeedback()}transformFeedbackVaryings(e,t,n){return this.i.transformFeedbackVaryings(e,t,n)}bindBufferBase(e,t,n){return this.i.bbindBufferBase(e,t,n)}bindBufferRange(e,t,n,i,s){return this.i.bindBufferRange(e,t,n,i,s)}bindTransformFeedback(e,t){return this.i.bindTransformFeedback(e,t)}fenceSync(e,t){return this.i.fenceSync(e,t)}isSync(e){return this.i.isSync(e)}deleteSync(e){return this.i.deleteSync(e)}clientWaitSync(e,t,n){return this.i.clientWaitSync(e,t,n)}waitSync(e,t,n){return this.i.waitSync(e,t,n)}getSyncParameter(e,t){return this.i.getSyncParameter(e,t)}getIndexedParameter(e,t){return this.i.getIndexedParameter(e,t)}};Yv(ex.prototype,{bufferData(...e){return this.v(),this.i.bufferData(...e)},bufferSubData(...e){return this.v(),this.i.bufferSubData(...e)},createBuffer(){return this.i.createBuffer()},deleteBuffer(e){const t=this.states;t.arrayBuffer===e?t.arrayBuffer=null:t.elementArrayBuffer===e&&(t.elementArrayBuffer=null);const n=t.attributes;for(const t in n)n[t].buffer===e&&(n[t].buffer=null);return this.i.deleteBuffer(e)},getBufferParameter(e,t){return this.v(),this.i.getBufferParameter(e,t)},isBuffer(e){return this.i.isBuffer(e)},copyBufferSubData(e,t,n,i,s){return this.i.isBuffer(e,t,n,i,s)},readBuffer(e){return this.i.readBuffer(e)}}),Yv(ex.prototype,{checkFramebufferStatus(e){return this.i.checkFramebufferStatus(e)},createFramebuffer(){return this.i.createFramebuffer()},deleteFramebuffer(e){const t=this.states.framebuffer;for(const n in t)t[n]===e&&(t[n]=null);return this.i.deleteFramebuffer(e)},framebufferRenderbuffer(e,t,n,i){return this.v(),this.i.framebufferRenderbuffer(e,t,n,i)},framebufferTexture2D(e,t,n,i,s){return this.v(),this.i.framebufferTexture2D(e,t,n,i,s)},getFramebufferAttachmentParameter(e,t,n){return this.v(),this.i.getFramebufferAttachmentParameter(e,t,n)},isFramebuffer(e){return this.i.isFramebuffer(e)},readPixels(e,t,n,i,s,o,a){return this.v(),this.i.readPixels(e,t,n,i,s,o,a)},blitFramebuffer(e,t,n,i,s,o,a,l,h,c){return this.v(),this.i.blitFramebuffer(e,t,n,i,s,o,a,l,h,c)}}),Yv(ex.prototype,{createRenderbuffer(){return this.i.createRenderbuffer()},deleteRenderbuffer(e){const t=this.states.renderbuffer;for(const n in t)t[n]===e&&(t[n]=null);return this.i.deleteRenderbuffer(e)},getRenderbufferParameter(e,t){return this.v(),this.i.getRenderbufferParameter(e,t)},isRenderbuffer(e){return this.i.isRenderbuffer(e)},renderbufferStorage(e,t,n,i){return this.v(),this.i.renderbufferStorage(e,t,n,i)},renderbufferStorageMultisample(e,t,n,i,s){return this.v(),this.i.renderbufferStorageMultisample(e,t,n,i,s)}});const tx="_fusion_context";Yv(ex.prototype,{scissor(e,t,n,i){this.v();const s=this.states.scissor;s[0]===e&&s[1]===t&&s[2]===n&&s[3]===i||(s[0]=e,s[1]=t,s[2]=n,s[3]=i,this.i.scissor(e,t,n,i))},viewport(e,t,n,i){this.v();const s=this.states.viewport;s[0]===e&&s[1]===t&&s[2]===n&&s[3]===i||(s[0]=e,s[1]=t,s[2]=n,s[3]=i,this.i.viewport(e,t,n,i))},blendColor(e,t,n,i){this.v();const s=this.states.blendColor;s[0]===e&&s[1]===t&&s[2]===n&&s[3]===i||(s[0]=e,s[1]=t,s[2]=n,s[3]=i,this.i.blendColor(e,t,n,i))},blendEquation(e){this.v();const t=this.states.blendEquationSeparate;t[0]===e&&t[1]===e||(t[0]=e,t[1]=e,this.i.blendEquation(e))},blendEquationSeparate(e,t){this.v();const n=this.states.blendEquationSeparate;n[0]===e&&n[1]===t||(n[0]=e,n[1]=t,this.i.blendEquationSeparate(e,t))},blendFunc(e,t){this.v();const n=this.states.blendFuncSeparate;n[0]===e&&n[2]===e&&n[1]===t&&n[3]===t||(n[0]=e,n[1]=t,n[2]=e,n[3]=t,this.i.blendFunc(e,t))},blendFuncSeparate(e,t,n,i){this.v();const s=this.states.blendFuncSeparate;s[0]===e&&s[1]===t&&s[2]===n&&s[3]===i||(s[0]=e,s[1]=t,s[2]=n,s[3]=i,this.i.blendFuncSeparate(e,t,n,i))},clearColor(e,t,n,i){this.v();const s=this.states.clearColor;s[0]===e&&s[1]===t&&s[2]===n&&s[3]===i||(s[0]=e,s[1]=t,s[2]=n,s[3]=i,this.i.clearColor(e,t,n,i))},clearDepth(e){this.v();const t=this.states.clearDepth;t[0]!==e&&(t[0]=e,this.i.clearDepth(e))},clearStencil(e){this.v();const t=this.states.clearStencil;t[0]!==e&&(t[0]=e,this.i.clearStencil(e))},colorMask(e,t,n,i){this.v();const s=this.states.colorMask;s[0]===e&&s[1]===t&&s[2]===n&&s[3]===i||(s[0]=e,s[1]=t,s[2]=n,s[3]=i,this.i.colorMask(e,t,n,i))},cullFace(e){this.v();const t=this.states.cullFace;t[0]!==e&&(t[0]=e,this.i.cullFace(e))},depthFunc(e){this.v();const t=this.states.depthFunc;t[0]!==e&&(t[0]=e,this.i.depthFunc(e))},depthMask(e){this.v();const t=this.states.depthMask;t[0]!==e&&(t[0]=e,this.i.depthMask(e))},depthRange(e,t){this.v();const n=this.states.depthRange;n[0]===e&&n[1]===t||(n[0]=e,n[1]=t,this.i.depthRange(e,t))},disable(e){this.v();const t=this.states.capabilities;t[e]&&(t[e]=!1,this.i.disable(e))},enable(e){this.v();const t=this.states.capabilities;t[e]||(t[e]=!0,this.i.enable(e))},frontFace(e){this.v();const t=this.states.frontFace;t[0]!==e&&(t[0]=e,this.i.frontFace(e))},hint(e,t){this.v();const n=this.states.hint;n[e][0]!==t&&(n[e][0]=t,this.i.hint(e,t))},lineWidth(e){this.v();const t=this.states.lineWidth;t[0]!==e&&(t[0]=e,this.i.lineWidth(e))},pixelStorei(e,t){this.v();const n=this.states.pixelStorei;n[e]!==t&&(n[e]&&(n[e][0]=t),this.i.pixelStorei(e,t))},polygonOffset(e,t){this.v();const n=this.states.polygonOffset;n[0]===e&&n[1]===t||(n[0]=e,n[1]=t,this.i.polygonOffset(e,t))},sampleCoverage(e,t){this.v();const n=this.states.sampleCoverage;n[0]===e&&n[1]===t||(n[0]=e,n[1]=t,this.i.sampleCoverage(e,t))},stencilFunc(e,t,n){this.v();const i=this.states.stencilFuncSeparate,s=this.i;i[s.FRONT][0]===e&&i[s.FRONT][1]===t&&i[s.FRONT][2]===n&&i[s.BACK][0]===e&&i[s.BACK][1]===t&&i[s.BACK][2]===n||(i[s.FRONT][0]=i[s.BACK][0]=e,i[s.FRONT][1]=i[s.BACK][1]=t,i[s.FRONT][2]=i[s.BACK][2]=n,this.i.stencilFunc(e,t,n))},stencilFuncSeparate(e,t,n,i){if(this.v(),e===this.i.FRONT_AND_BACK)return void this.stencilFunc(t,n,i);const s=this.states.stencilFuncSeparate;s[e][0]===t&&s[e][1]===n&&s[e][2]===i||(s[e][0]=t,s[e][1]=n,s[e][2]=i,this.i.stencilFuncSeparate(e,t,n,i))},stencilMask(e){this.v();const t=this.i,n=this.states.stencilMaskSeparate;n[t.FRONT][0]===e&&n[t.BACK][0]===e||(n[t.FRONT][0]=e,n[t.BACK][0]=e,this.i.stencilMask(e))},stencilMaskSeparate(e,t){if(this.v(),e===this.i.FRONT_AND_BACK)return void this.stencilMask(t);const n=this.states.stencilMaskSeparate;n[e][0]!==t&&(n[e][0]=t,this.i.stencilMaskSeparate(e,t))},stencilOp(e,t,n){this.v();const i=this.states.stencilOpSeparate,s=this.i;i[s.FRONT][0]===e&&i[s.FRONT][1]===t&&i[s.FRONT][2]===n&&i[s.BACK][0]===e&&i[s.BACK][1]===t&&i[s.BACK][2]===n||(i[s.FRONT][0]=i[s.BACK][0]=e,i[s.FRONT][1]=i[s.BACK][1]=t,i[s.FRONT][2]=i[s.BACK][2]=n,this.i.stencilOp(e,t,n))},stencilOpSeparate(e,t,n,i){if(this.v(),e===this.i.FRONT_AND_BACK)return void this.stencilOp(t,n,i);const s=this.states.stencilOpSeparate;s[e][0]===t&&s[e][1]===n&&s[e][2]===i||(s[e][0]=t,s[e][1]=n,s[e][2]=i,this.i.stencilOpSeparate(e,t,n,i))},bindFramebuffer(e,t){this.v();const n=this.states.framebuffer;n[e]!==t&&(n[e]=t,this.i.bindFramebuffer(e,t))},bindRenderbuffer(e,t){this.v();const n=this.states.renderbuffer;n[e]!==t&&(n[e]=t,this.i.bindRenderbuffer(e,t))},bindTexture(e,t){this.v();const n=this.states.textures;n.units[-1!==n.active?n.active-33984:-1][e]=t,this.i.bindTexture(e,t)},activeTexture(e){this.v();const t=this.i,n=this.states.textures,i=n.active;n.active=e,this.activeUnit!==e&&(t.activeTexture(e),this.activeUnit=e),-1===i&&(n.units[e-33984][t.TEXTURE_2D]=n.units[-1][t.TEXTURE_2D],n.units[e-33984][t.TEXTURE_CUBE_MAP]=n.units[-1][t.TEXTURE_CUBE_MAP],n.units[-1][t.TEXTURE_2D]=null,n.units[-1][t.TEXTURE_CUBE_MAP]=null)},useProgram(e){this.v();const t=this.states;t.program!==e&&(this.states.activeAttribType=0,t.program=e,void 0===e.fid&&(e.fid=0),this.p(),this.i.useProgram(e))},p(){const e=this.states.program;if(!e)return;const t=e.cachedUniforms=e.cachedUniforms||{};for(const e in t)Array.isArray(t[e])?t[e].fill(null):t[e]=null},bindBuffer(e,t){this.v();const n=this.i,i=this.states;e===n.ELEMENT_ARRAY_BUFFER?i.elementArrayBuffer=t:i.arrayBuffer=t,n.bindBuffer(e,t)},bindVertexArray(e){this.v(),this.states.activeAttribType=1;const t=this.i,n=this.states;n.vao!==e&&(n.vao=e,this.t?t.bindVertexArray(e):this.vaoOES.bindVertexArrayOES(e))},vertexAttribPointer(e,t,n,i,s,o){this.v(),this.states.attributes[e]||(this.states.attributes[e]={enable:!0});const a=this.states.attributes[e];return a.buffer=this.states.arrayBuffer,a.args?(a.args[0]=e,a.args[1]=t,a.args[2]=n,a.args[3]=i,a.args[4]=s,a.args[5]=o):a.args=[e,t,n,i,s,o],this.i.vertexAttribPointer(e,t,n,i,s,o)},vertexAttribDivisor(e,t){return this.v(),this.states.attributes[e].divisor=t,this.t?this.i.vertexAttribDivisor(e,t):this.angleOES.vertexAttribDivisorANGLE(e,t)}},{v(){const e=this.i;if(e[tx]!==this)if(e[tx]){this.N(e[tx].states),e[tx]=this}else e[tx]=this},N(e){if(!e)return;delete this.activeUnit;const t=this.states,n=this.i;let i=0;for(const s in t)if("capabilities"!==s&&"textures"!==s&&"attributes"!==s&&"arrayBuffer"!==s&&"elementArrayBuffer"!==s&&"vao"!==s)if("program"===s)t.program!==e.program&&(n.useProgram(t.program),t.program&&(i=n.getProgramParameter(t.program,n.ACTIVE_ATTRIBUTES)));else if("framebuffer"===s)for(const i in t[s])t[s][i]!==e[s][i]&&n.bindFramebuffer(+i,t[s][i]);else if("renderbuffer"===s)for(const i in t[s])t[s][i]!==e[s][i]&&n.bindRenderbuffer(+i,t[s][i]);else if(!Zv(t[s],e[s]))if(Array.isArray(e[s]))n[s](...t[s]);else if(e[s])for(const i in t[s])Zv(t[s][i],e[s][i])||n[s](+i,...t[s][i]);this.p();for(const i in t.capabilities)t.capabilities[i]!==e.capabilities[i]&&n[t.capabilities[i]?"enable":"disable"](+i);const s=t.textures,o=s.units,a=e.textures.units,l=s.active-n.TEXTURE0;for(let e=0;e<o.length;e++)e===l||o[e][n.TEXTURE_2D]===a[e][n.TEXTURE_2D]&&o[e][n.TEXTURE_CUBE_MAP]===a[e][n.TEXTURE_CUBE_MAP]||(n.activeTexture(n.TEXTURE0+e),n.bindTexture(n.TEXTURE_2D,o[e][n.TEXTURE_2D]),n.bindTexture(n.TEXTURE_CUBE_MAP,o[e][n.TEXTURE_CUBE_MAP]));if(s.active>-1){const e=o[l];e[n.TEXTURE_2D]===a[l][n.TEXTURE_2D]&&e[n.TEXTURE_CUBE_MAP]===a[l][n.TEXTURE_CUBE_MAP]||(n.activeTexture(s.active),n.bindTexture(n.TEXTURE_2D,e[n.TEXTURE_2D]),n.bindTexture(n.TEXTURE_CUBE_MAP,e[n.TEXTURE_CUBE_MAP]))}this.t?n.bindVertexArray(null):this.o&&this.o.bindVertexArrayOES(null);const h=this.h;if(this.t||this.angleOES)for(let e=0;e<h;e++)this.t?n.vertexAttribDivisor(e,0):this.angleOES.vertexAttribDivisorANGLE(e,0);n.bindBuffer(n.ARRAY_BUFFER,t.arrayBuffer),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.elementArrayBuffer),1===t.activeAttribType?this.F(t,n):this.L(t,n,i)},F(e,t){const n=e.vao;n&&(this.t?t.bindVertexArray(n||null):this.o&&this.o.bindVertexArrayOES(n||null))},L(e,t,n){const i=this.h,s=e.attributes;let o=0;for(let e=0;e<i;e++){const i=s[e];if(o<n&&i){if(i.buffer){if(t.bindBuffer(t.ARRAY_BUFFER,i.buffer),t.vertexAttribPointer(...i.args),i.divisor&&(this.t?t.vertexAttribDivisor(e,i.divisor):this.angleOES.vertexAttribDivisorANGLE(e,i.divisor)),i.enable){t.enableVertexAttribArray(e),o++;continue}t.disableVertexAttribArray(e)}t.disableVertexAttribArray(e)}else t.disableVertexAttribArray(e)}}}),Yv(ex.prototype,{compressedTexImage2D(e,t,n,i,s,o,a){return this.v(),this.i.compressedTexImage2D(e,t,n,i,s,o,a)},copyTexImage2D(e,t,n,i,s,o,a,l){return this.v(),this.i.copyTexImage2D(e,t,n,i,s,o,a,l)},copyTexSubImage2D(e,t,n,i,s,o,a,l){return this.v(),this.i.copyTexSubImage2D(e,t,n,i,s,o,a,l)},createTexture(){return this.i.createTexture()},deleteTexture(e){const t=this.states.textures.units;for(let n=0;n<t.length;n++)for(const i in t[n])t[n][i]===e&&(t[n][i]=null);return this.i.deleteTexture(e)},generateMipmap(e){return this.v(),this.i.generateMipmap(e)},getTexParameter(e,t){return this.v(),this.i.getTexParameter(e,t)},isTexture(e){return this.i.isTexture(e)},texImage2D(...e){if(this.v(),this.t){const t=e[e.length-2],n=$v.getInternalFormat(this.i,e[2],t);n!==e[2]&&(e[2]=n);const i=$v.getTextureType(this.i,t);i!==t&&(e[e.length-2]=i)}return this.i.texImage2D(...e)},texSubImage2D(...e){if(this.v(),this.t){const t=e[e.length-2],n=$v.getTextureType(this.i,t);n!==t&&(e[e.length-2]=n)}return this.i.texSubImage2D(...e)},texParameterf(e,t,n){return this.v(),this.i.texParameterf(e,t,n)},texParameteri(e,t,n){return this.v(),this.i.texParameteri(e,t,n)},texStorage2D(e,t,n,i,s){return this.v(),this.i.texStorage2D(e,t,n,i,s)},texImage3D(e,t,n,i,s,o,a,l,h,c){return this.v(),this.i.texImage3D(e,t,n,i,s,o,a,l,h,c)},texStorage3D(e,t,n,i,s,o){return this.v(),this.i.texStorage3D(e,t,n,i,s,o)},texSubImage3D(e,t,n,i,s,o,a,l,h,c,u){return this.v(),this.i.texSubImage3D(e,t,n,i,s,o,a,l,h,c,u)},copyTexSubImage3D(e,t,n,i,s,o,a,l,h){return this.v(),this.i.copyTexSubImage3D(e,t,n,i,s,o,a,l,h)},compressedTexSubImage3D(e,t,n,i,s,o,a,l,h,c,u){return this.v(),this.i.compressedTexSubImage3D(e,t,n,i,s,o,a,l,h,c,u)}});const nx=[];function rx(e,t){const n=t.length;for(let i=0;i<n;i++)e[i]=t[i];return e}Yv(ex.prototype,{bindAttribLocation(e,t,n){return this.i.bindAttribLocation(e,t,n)},enableVertexAttribArray(e){return this.v(),this.states.attributes[e]||(this.states.attributes[e]={}),this.states.attributes[e].enable=!0,this.i.enableVertexAttribArray(e)},disableVertexAttribArray(e){return this.v(),this.states.attributes[e]||(this.states.attributes[e]={}),this.states.attributes[e].enable=!1,this.i.disableVertexAttribArray(e)},getActiveAttrib(e,t){return this.i.getActiveAttrib(e,t)},getActiveUniform(e,t){return this.i.getActiveUniform(e,t)},getAttribLocation(e,t){return this.i.getAttribLocation(e,t)},getUniformLocation(e,t){return this.i.getUniformLocation(e,t)},getVertexAttrib(e,t){return this.v(),this.i.getVertexAttrib(e,t)},getVertexAttribOffset(e,t){return this.v(),this.i.getVertexAttribOffset(e,t)},uniformBlockBinding(e,t,n){return this.v(),this.i.uniformBlockBinding(e,t,n)},B(e,...t){const n=this.states.program;if(!n)return!1;let i=e.fid;void 0===i&&(i=e.fid=n.fid++);const s=n.cachedUniforms[i];return!!function(e,t){if(!e)return!1;const n=t.length;for(let i=0;i<n;i++)if(e[i]&&void 0!==e[i].length){const n=e[i].length;for(let s=0;s<n;s++)if(e[i][s]!==t[i][s])return!1}else if(e[i]!==t[i])return!1;return!0}(s,t)||(n.cachedUniforms[i]=function(e,t){e=e||new Array(t.length);const n=t.length;for(let i=0;i<n;i++)e[i]=void 0!==t[i].length?rx(e[i]||[],t[i]):t[i];return e}(s,t),!1)},uniformMatrix2fv(e,t,n){this.B(e,t,n)||(this.v(),this.i.uniformMatrix2fv(e,t,n))},uniformMatrix3fv(e,t,n){this.B(e,t,n)||(this.v(),this.i.uniformMatrix3fv(e,t,n))},uniformMatrix4fv(e,t,n){e?(n=this.C(n),this.B(e,t,n)||this.i.uniformMatrix4fv(e,t,n)):console.warn("UniformLocation invalid, null value encountered in browser:",navigator.userAgent)},C:e=>e?(nx[0]=isNaN(e[0])?-1e30:e[0],nx[1]=isNaN(e[1])?-1e30:e[1],nx[2]=isNaN(e[2])?-1e30:e[2],nx[3]=isNaN(e[3])?-1e30:e[3],nx[4]=isNaN(e[4])?-1e30:e[4],nx[5]=isNaN(e[5])?-1e30:e[5],nx[6]=isNaN(e[6])?-1e30:e[6],nx[7]=isNaN(e[7])?-1e30:e[7],nx[8]=isNaN(e[8])?-1e30:e[8],nx[9]=isNaN(e[9])?-1e30:e[9],nx[10]=isNaN(e[10])?-1e30:e[10],nx[11]=isNaN(e[11])?-1e30:e[11],nx[12]=isNaN(e[12])?-1e30:e[12],nx[13]=isNaN(e[13])?-1e30:e[13],nx[14]=isNaN(e[14])?-1e30:e[14],nx[15]=isNaN(e[15])?-1e30:e[15],nx):e,uniform1f(e,t){return this.v(),this.i.uniform1f(e,t)},uniform1i(e,t){return this.v(),this.i.uniform1i(e,t)},uniform2f(e,t,n){return this.v(),this.i.uniform2f(e,t,n)},uniform2i(e,t,n){return this.v(),this.i.uniform2i(e,t,n)},uniform3f(e,t,n,i){return this.v(),this.i.uniform3f(e,t,n,i)},uniform3i(e,t,n,i){return this.v(),this.i.uniform3i(e,t,n,i)},uniform4f(e,t,n,i,s){return this.v(),this.i.uniform4f(e,t,n,i,s)},uniform4i(e,t,n,i,s){return this.v(),this.i.uniform4i(e,t,n,i,s)},uniform1ui(e,t){return this.v(),this.i.uniform1ui(e,t)},uniform2ui(e,t,n){return this.v(),this.i.uniform2ui(e,t,n)},uniform3ui(e,t,n,i){return this.v(),this.i.uniform3ui(e,t,n,i)},uniform4ui(e,t,n,i,s){return this.v(),this.i.uniform4ui(e,t,n,i,s)},uniform1fv(e,t,n,i){this.v(),void 0!==i?this.i.uniform1fv(e,t,n,i):void 0!==n?this.i.uniform1fv(e,t,n):this.i.uniform1fv(e,t)},uniform2fv(e,t,n,i){this.v(),void 0!==i?this.i.uniform2fv(e,t,n,i):void 0!==n?this.i.uniform2fv(e,t,n):this.i.uniform2fv(e,t)},uniform3fv(e,t,n,i){this.v(),void 0!==i?this.i.uniform3fv(e,t,n,i):void 0!==n?this.i.uniform3fv(e,t,n):this.i.uniform3fv(e,t)},uniform4fv(e,t,n,i){this.v(),void 0!==i?this.i.uniform4fv(e,t,n,i):void 0!==n?this.i.uniform4fv(e,t,n):this.i.uniform4fv(e,t)},uniform1iv(e,t,n,i){this.v(),void 0!==i?this.i.uniform1iv(e,t,n,i):void 0!==n?this.i.uniform1iv(e,t,n):this.i.uniform1iv(e,t)},uniform2iv(e,t,n,i){this.v(),void 0!==i?this.i.uniform2iv(e,t,n,i):void 0!==n?this.i.uniform2iv(e,t,n):this.i.uniform2iv(e,t)},uniform3iv(e,t,n,i){this.v(),void 0!==i?this.i.uniform3iv(e,t,n,i):void 0!==n?this.i.uniform3iv(e,t,n):this.i.uniform3iv(e,t)},uniform4iv(e,t,n,i){this.v(),void 0!==i?this.i.uniform4iv(e,t,n,i):void 0!==n?this.i.uniform4iv(e,t,n):this.i.uniform4iv(e,t)},uniform1uiv(e,t,n,i){this.v(),void 0!==i?this.i.uniform1uiv(e,t,n,i):void 0!==n?this.i.uniform1uiv(e,t,n):this.i.uniform1uiv(e,t)},uniform2uiv(e,t,n,i){this.v(),void 0!==i?this.i.uniform2uiv(e,t,n,i):void 0!==n?this.i.uniform2uiv(e,t,n):this.i.uniform2uiv(e,t)},uniform3uiv(e,t,n,i){this.v(),void 0!==i?this.i.uniform3uiv(e,t,n,i):void 0!==n?this.i.uniform3uiv(e,t,n):this.i.uniform3uiv(e,t)},uniform4uiv(e,t,n,i){this.v(),void 0!==i?this.i.uniform4uiv(e,t,n,i):void 0!==n?this.i.uniform4uiv(e,t,n):this.i.uniform4uiv(e,t)},vertexAttrib1f(e,t){return this.v(),this.i.vertexAttrib1f(e,t)},vertexAttrib2f(e,t,n){return this.v(),this.i.vertexAttrib2f(e,t,n)},vertexAttrib3f(e,t,n,i){return this.v(),this.i.vertexAttrib3f(e,t,n,i)},vertexAttrib4f(e,t,n,i,s){return this.v(),this.i.vertexAttrib4f(e,t,n,i,s)},vertexAttrib1fv(e,t){return this.v(),this.i.vertexAttrib1fv(e,t)},vertexAttrib2fv(e,t){return this.v(),this.i.vertexAttrib2fv(e,t)},vertexAttrib3fv(e,t){return this.v(),this.i.vertexAttrib3fv(e,t)},vertexAttrib4fv(e,t){return this.v(),this.i.vertexAttrib4fv(e,t)},vertexAttribI4i(e,t,n,i,s){return this.v(),this.i.vertexAttribI4i(e,t,n,i,s)},vertexAttribI4ui(e,t,n,i,s){return this.v(),this.i.vertexAttribI4ui(e,t,n,i,s)},vertexAttribI4iv(e,t){return this.v(),this.i.vertexAttribI4iv(e,t)},vertexAttribI4uiv(e,t){return this.v(),this.i.vertexAttribI4uiv(e,t)}}),Yv(ex.prototype,{createVertexArray(){return this.t?this.i.createVertexArray():this.vaoOES.createVertexArrayOES()},deleteVertexArray(e){const t=this.states;return t.vao===e&&(t.vao=null),this.t?this.i.deleteVertexArray(e):this.vaoOES.deleteVertexArrayOES(e)},isVertexArray(e){return this.t?this.i.isVertexArray(e):this.vaoOES.isVertexArrayOES(e)}}),Yv(ex.prototype,{drawArraysInstanced(e,t,n,i){return this.v(),this._(),this.t?this.i.drawArraysInstanced(e,t,n,i):this.angleOES.drawArraysInstancedANGLE(e,t,n,i)},drawElementsInstanced(e,t,n,i,s){return this.v(),this._(),this.t?this.i.drawElementsInstanced(e,t,n,i,s):this.angleOES.drawElementsInstancedANGLE(e,t,n,i,s)}});
/*!
   * @maptalks/gl v0.110.0
   * LICENSE : UNLICENSED
   * (c) 2016-2025 maptalks.com
   */
const ix=function(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")},sx=ix(),ox=sx.gl_trans__coders=sx.gl_trans__coders||{};function ax(e){var t=function(){return"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:void 0};if(t().maptalks_gltf_loader)return;
/*!
  	 * @maptalks/gltf-loader v0.103.0
  	 * LICENSE : UNLICENSED
  	 * (c) 2016-2025 maptalks.org
  	 */var n="undefined"!=typeof Float32Array?Float32Array:Array;function i(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3],l=t[4],h=t[5],c=t[6],u=t[7],f=t[8],g=t[9],m=t[10],A=t[11],w=t[12],T=t[13],S=t[14],M=t[15],C=n[0],I=n[1],E=n[2],D=n[3];return e[0]=C*i+I*l+E*f+D*w,e[1]=C*s+I*h+E*g+D*T,e[2]=C*o+I*c+E*m+D*S,e[3]=C*a+I*u+E*A+D*M,e[4]=(C=n[4])*i+(I=n[5])*l+(E=n[6])*f+(D=n[7])*w,e[5]=C*s+I*h+E*g+D*T,e[6]=C*o+I*c+E*m+D*S,e[7]=C*a+I*u+E*A+D*M,e[8]=(C=n[8])*i+(I=n[9])*l+(E=n[10])*f+(D=n[11])*w,e[9]=C*s+I*h+E*g+D*T,e[10]=C*o+I*c+E*m+D*S,e[11]=C*a+I*u+E*A+D*M,e[12]=(C=n[12])*i+(I=n[13])*l+(E=n[14])*f+(D=n[15])*w,e[13]=C*s+I*h+E*g+D*T,e[14]=C*o+I*c+E*m+D*S,e[15]=C*a+I*u+E*A+D*M,e}function s(){var e=new n(3);return n!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function o(e,t,i){var s=new n(3);return s[0]=e,s[1]=t,s[2]=i,s}function a(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function l(e,t,n,i){return e[0]=t,e[1]=n,e[2]=i,e}function h(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e}function c(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}function u(e,t,n,i,s){return e[0]=t,e[1]=n,e[2]=i,e[3]=s,e}function f(e,t,n){var i=t[0],s=t[1],o=t[2],a=t[3];return e[0]=n[0]*i+n[4]*s+n[8]*o+n[12]*a,e[1]=n[1]*i+n[5]*s+n[9]*o+n[13]*a,e[2]=n[2]*i+n[6]*s+n[10]*o+n[14]*a,e[3]=n[3]*i+n[7]*s+n[11]*o+n[15]*a,e}function g(){var e=new n(4);return n!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),s(),function(){var e;e=new n(4),n!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0)}();var m,A=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e};s(),o(1,0,0),o(0,1,0),g(),g(),m=new n(9),n!=Float32Array&&(m[1]=0,m[2]=0,m[3]=0,m[5]=0,m[6]=0,m[7]=0),m[0]=1,m[4]=1,m[8]=1;let w=0;function T(e){return null==e}function S(e){return!T(e)}function M(e){return!T(e)&&("string"==typeof e||null!==e.constructor&&e.constructor===String)}function C(e){for(let t=1;t<arguments.length;t++){const n=arguments[t];for(const t in n)e[t]=n[t]}return e}function I(e){switch(e){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array}throw new Error("unsupported bufferView's component type: "+e)}function E(e){return 0===e.indexOf("data:")&&e.indexOf("base64,")>0}function D(e){const t=function(e){return"undefined"!=typeof self?self.atob(e):window.atob(e)}(e.substring(e.indexOf(",")+1)),n=t.length,i=new Uint8Array(n);for(let e=0;e<n;e++)i[e]=t.charCodeAt(e);return i.buffer}const H=[],N=[],B=[],z=[0,0,0],U=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}([]),j=[1,1,1];function W(e,t,n,i,s,o,a){const l=I(a),h=l.BYTES_PER_ELEMENT;if((0===s||s===i*h)&&o%h==0){const s=new l(t,o,n*i);return e.set(s),e}0===s&&(s=i*h);const c=new Uint8Array(i*h);for(let a=0;a<n;a++){let n=null;const u=new Uint8Array(t,s*a+o,i*h);c.set(u),n=new l(c.buffer,0,i);for(let t=0;t<i;t++)e[a*i+t]=n[t]}return e}const q="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function Z(e,t,n){const i=new Uint8Array(e,t,n);return q.decode(i)}const X={get:function(e,t={},n){t||(t={});const i=new AbortController,s=i.signal,o=C({},t);o.signal=s,o.method||(o.method="GET"),o.referrerPolicy=o.referrerPolicy||"origin","undefined"==typeof window||o.referrer||(o.referrer=window.location.href),n&&(e=n(e));const a=fetch(e,o).then((e=>{const n=this.t(e,t.responseType);return n.message?n:n.then((n=>"arraybuffer"===t.responseType?{data:n,cacheControl:e.headers.get("Cache-Control"),expires:e.headers.get("Expires"),contentType:e.headers.get("Content-Type")}:n)).catch((e=>{if(!e.code||e.code!==DOMException.ABORT_ERR)throw e}))})).catch((e=>{if(!e.code||e.code!==DOMException.ABORT_ERR)throw e}));return a.xhr=i,a},t:(e,t)=>200!==e.status?{status:e.status,statusText:e.statusText,message:`incorrect http request with status code(${e.status}): ${e.statusText}`}:"arraybuffer"===t?e.arrayBuffer():"json"===t?e.json():e.text(),getArrayBuffer:(e,t={},n)=>(t||(t={}),t.responseType="arraybuffer",X.get(e,t,n)),getJSON:function(e,t={},n){return t&&t.jsonp?X.jsonp(e):((t=t||{}).responseType="json",X.get(e,t,n))},jsonp:function(e){const t="_maptalks_jsonp_"+w++;e.match(/\?/)?e+="&callback="+t:e+="?callback="+t;let n=document.createElement("script");return n.type="text/javascript",n.src=e,new Promise((e=>{window[t]=function(i){document.getElementsByTagName("head")[0].removeChild(n),n=null,delete window[t],e(i)},document.getElementsByTagName("head")[0].appendChild(n)}))}};class R{constructor(e,t,n,i,s){this.i=e,this.decoders=t,this.o=n,this.images={},this.h={},this.u=i||{},this.l=s}requestImageFromBufferURI(e,t,n){if(this.buffers[e.id]){const i=this.m(t,this.buffers[e.id]);return this.getImageByBuffer(i,n)}if(this.h[e.id])return this.h[e.id].then((()=>{const i=this.m(t,this.buffers[e.id]);return this.getImageByBuffer(i,n)}));if(E(e.uri)){const i=this.buffers[e.id]=D(e.uri),s=this.m(t,i);return this.getImageByBuffer(s,n)}let i;const s=e.uri.indexOf("blob:")>=0;return i=e.uri.indexOf("://")>0||s?e.uri:this.rootPath+"/"+e.uri,this.h[e.id]=X.getArrayBuffer(i,this.u,this.l).then((i=>{const s=this.buffers[e.id]=i.data,o=this.m(t,s);return this.getImageByBuffer(o,n)}))}getImageByBuffer(e,t){if(this.images[t.id])return Promise.resolve(this.images[t.id]);const n=this.decoders;if(n[t.mimeType])return n[t.mimeType](e,{supportedFormats:this.o});if("image/crn"===t.mimeType||"image/ktx2"===t.mimeType||"image/cttf"===t.mimeType)throw new Error("missing transcoder for "+t.mimeType,"");return this.p(t.id,e)}requestExternalImage(e){if(this.images[e.id])return Promise.resolve(this.images[e.id]);const t=0===e.uri.indexOf("data:image/")?e.uri:this.rootPath+"/"+e.uri;return this.h[e.id]?this.h[e.id].then((()=>this.images[e.id])):this.h[e.id]=this.p(e.id,t)}p(e,t){return new Promise(((n,i)=>{let s=t;this.l&&(s=this.l(t)),this.i(s,this.u,((s,o)=>{s?i(s):(URL.revokeObjectURL(t),this.images[e]=o,n(this.images[e]))}))}))}}const Y=["SCALAR",1,"VEC2",2,"VEC3",3,"VEC4",4,"MAT2",4,"MAT3",9,"MAT4",16],J=[];class k{constructor(e,t,n,i,s){this.rootPath=e,this.gltf=t,this._=!1,this.glbBuffer=n,this.buffers={},this.requests={},this.accessors={},this.A(),this.u=i,this.l=s}T(e,t){const n=this.gltf,i=n.accessors[t];if(void 0===i.bufferView)return this.accessors[i.id]=this.M(e,t,null,0),Promise.resolve(this.accessors[i.id]);if(i&&this.accessors[i.id])return Promise.resolve(this.accessors[i.id]);return this.I(n.bufferViews[i.bufferView]).then((n=>{const{buffer:s,byteOffset:o}=n;return this.accessors[i.id]=this.M(e,t,s,o)}))}I(e){const t=this.gltf.buffers[e.buffer];if(this.buffers[t.id]){return Promise.resolve({buffer:this.buffers[t.id],byteOffset:0})}if(this.requests[t.id])return this.requests[t.id].then((()=>Promise.resolve({buffer:this.buffers[t.id],byteOffset:0})));if("binary_glTF"!==e.buffer&&"KHR_binary_glTF"!==e.buffer&&t.uri){if(E(t.uri)){const e=this.buffers[t.id]=D(t.uri);return Promise.resolve({buffer:e,byteOffset:0})}let e;const n=t.uri.indexOf("blob:")>=0;return e=t.uri.indexOf("://")>0||n?t.uri:this.rootPath+"/"+t.uri,this.requests[t.id]=X.getArrayBuffer(e,this.u,!n&&this.l).then((i=>(n&&URL.revokeObjectURL(e),{buffer:this.buffers[t.id]=i.data,byteOffset:0})))}return Promise.resolve({buffer:this.glbBuffer.buffer,byteOffset:this.glbBuffer.byteOffset})}M(e,t,n,i=0){const s=this.gltf,o=s.accessors[t],a=void 0!==o.bufferView?s.bufferViews[o.bufferView]:{},l=(a.byteOffset||0)+i,h=this.v(o.type),c=I(o.componentType),u=a.byteStride||0,g={array:void 0,name:e,accessorName:t,byteLength:o.count*h*c.BYTES_PER_ELEMENT,componentType:o.componentType,count:o.count,type:o.type,itemSize:h,max:o.max,min:o.min,extensions:o.extensions};if(o.min&&(g.min=o.min),o.max&&(g.max=o.max),n)if(this._)g.byteStride=u,g.byteOffset=l+(o.byteOffset||0),!u||u===h*c.BYTES_PER_ELEMENT||"indices"===e||"input"===e||"output"===e||e.indexOf("morph")>=0?(g.array=this.P(n,o.count,h,l+(o.byteOffset||0),c),g.array.buffer.byteLength===g.byteLength&&(g.byteOffset=0)):g.array=new Uint8Array(n,l,a.byteLength);else if(o.interleaved){g.byteStride=0,g.byteOffset=0;const e=new c(o.count*h);if(g.array=W(e,n,o.count,h,u,l+(o.byteOffset||0),o.componentType),g.extensions&&g.extensions.WEB3D_quantized_attributes&&h>2){const e=new Float32Array(g.array.length),{decodeMatrix:t}=g.extensions.WEB3D_quantized_attributes;for(let n=0;n<g.array.length;n+=h){J[0]=g.array[n],J[1]=g.array[n+1],J[2]=g.array[n+2],J[3]=1;const i=f(J,J,t);e[n]=i[0],e[n+1]=i[1],e[n+2]=i[2]}g.componentType=5126,g.array=e}}else g.byteStride=0,g.array=this.P(n,o.count,h,l+(o.byteOffset||0),c),g.byteOffset=g.array.byteOffset;else{g.array=new c(o.count);const e=g.min||g.max;e&&(g.array[0]=e[0],g.array[1]=e[1],g.array[2]=e[2])}return g}A(){const e=this.gltf.accessors;if(Array.isArray(e))for(let t=0;t<e.length;t++)for(let n=0;n<e.length;n++)t!==n&&e[t].bufferView===e[n].bufferView&&(e[t].interleaved=e[n].interleaved=!0);else for(const t in e)for(const n in e)t!==n&&e[t].bufferView===e[n].bufferView&&(e[t].interleaved=e[n].interleaved=!0)}P(e,t,n,i,s){return i%s.BYTES_PER_ELEMENT!=0&&(e=e.slice(i,i+t*n*s.BYTES_PER_ELEMENT),i=0),new s(e,i,n*t)}v(e){const t=Y.indexOf(e);return Y[t+1]}requestKHRTechniquesWebgl(e){const{shaders:t}=e,n=t.map((e=>{if(void 0!==e.bufferView){const t=this.gltf.bufferViews[e.bufferView],{byteLength:n}=t;return this.I(t).then((i=>{const{buffer:s,byteOffset:o}=i,a=Z(s,o+(t.byteOffset||0),n);return e.content=a,e}))}if(e.uri){if(E(e.uri)){const t=D(e.uri),n=Z(t,0,t.byteLength);return e.content=n,Promise.resolve(e)}return X.get(this.rootPath+"/"+e.uri,this.u,this.l).then((t=>(e.content=t,e)))}return Promise.resolve(e)}));return Promise.all(n).then((()=>e))}}class L extends R{constructor(e,t,n,i,s,o,a,l){super(i,s,o,a,l),this.rootPath=e,this.gltf=t,this.requests={},this.buffers={},this.glbBuffer=n,this.accessor=new k(e,t,n,a,l)}iterate(e,t){const n=this.gltf[t];if(!n)return;let i=0;for(const t in n)e(t,n[t],i++)}createNode(e){const t={};if(S(e.name)&&(t.name=e.name),S(e.children)&&(t.children=e.children),S(e.jointName)&&(t.jointName=e.jointName),S(e.matrix)&&(t.matrix=e.matrix),S(e.rotation)&&(t.rotation=e.rotation),S(e.scale)&&(t.scale=e.scale),S(e.translation)&&(t.translation=e.translation),S(e.extras)&&(t.extras=e.extras),S(e.meshes)&&(t.mesh=e.meshes[0]),t.translation||t.rotation||t.scale){const e=function(e,t){if(t.matrix)return t.matrix;if(t.translation||t.scale||t.rotation){const n=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}(H,t.translation||z),s=function(e,t){var n=t[0],i=t[1],s=t[2],o=t[3],a=n+n,l=i+i,h=s+s,c=n*a,u=i*a,f=i*l,g=s*a,m=s*l,A=s*h,w=o*a,T=o*l,S=o*h;return e[0]=1-f-A,e[1]=u+S,e[2]=g-T,e[3]=0,e[4]=u-S,e[5]=1-c-A,e[6]=m+w,e[7]=0,e[8]=g+T,e[9]=m-w,e[10]=1-c-f,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}(N,t.rotation||U),o=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}(B,t.scale||j);return i(o,s,o),i(e,n,o)}return function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}(e)}([],t);delete t.translation,delete t.rotation,delete t.scale,t.matrix=e}return t}O(e){const t={};for(const n in e){const i=e[n];let s,o;i.instanceTechnique&&i.instanceTechnique.values?(s=i.instanceTechnique,o=s.values.diffuse):(s=i,o=s.values.tex||s.values.diffuseTex||s.values.diffuse);const a={baseColorTexture:{index:o}};i.name&&(a.name=i.name),i.extensions&&(a.extensions=i.extensions),i.extras&&(a.extras=i.extras),t[n]=a}return t}N(e){if(e.bufferView||e.extensions&&(e.extensions.KHR_binary_glTF||e.extensions.binary_glTF)){const t=e.bufferView?e:e.extensions.KHR_binary_glTF||e.extensions.binary_glTF;e.extensions&&(e.mimeType=t.mimeType,e.width=t.width,e.height=t.height);const n=this.gltf.bufferViews[t.bufferView],i=this.buffers[t.bufferView]=new Uint8Array(this.glbBuffer.buffer,(n.byteOffset||0)+this.glbBuffer.byteOffset,n.byteLength);return this.getImageByBuffer(i,e)}return this.requestExternalImage(e)}S(e){const t=this.gltf.textures[e];if(!t)return null;const n=this.gltf.images[t.source];return this.N(n).then((e=>({image:{array:e.data,width:e.width,height:e.height,index:t.source,mimeType:n.mimeType,name:n.name,extras:n.extras},sampler:this.gltf.samplers[t.sampler]})))}getBaseColorTexture(e){const t=this.gltf.materials[e];let n,i;if(t.instanceTechnique&&t.instanceTechnique.values?(n=t.instanceTechnique,i=n.values.diffuse):(n=t,i=n.values.tex||n.values.diffuseTex||n.values.diffuse),void 0===i||void 0===this.gltf.textures)return null;const s=this.gltf.textures[i];if(!s)return null;return{format:s.format||6408,internalFormat:s.internalFormat||6408,type:s.type||5121,sampler:this.gltf.samplers[s.sampler],source:this.gltf.images[s.source]}}getMaterial(){return null}getAnimations(){return null}}const Q=9729;class F extends R{constructor(e,t,n,i,s,o,a,l){super(i,s,o,a,l),this.rootPath=e,this.gltf=t,this.glbBuffer=n,this.buffers={},this.requests={},this.accessor=new k(e,t,n,a,l)}iterate(e,t){const n=this.gltf[t];if(n)for(let t=0;t<n.length;t++)e(t,n[t],t)}createNode(e){const t={};return C(t,e),!S(e.weights)&&this.gltf.meshes&&S(t.mesh)?t.weights=this.gltf.meshes[t.mesh].weights:e.weights&&(t.weights=e.weights),t}S(e){const t=this.gltf.textures[e];if(!t)return null;let n=t.source;if(t.extensions&&t.extensions.EXT_texture_webp?n=t.extensions.EXT_texture_webp.source:t.extensions&&t.extensions.KHR_texture_basisu&&(n=t.extensions.KHR_texture_basisu.source),!S(n))return null;const i=this.gltf.images[n];return this.N(i).then((e=>{if(!e)return null;const n={image:{array:e.data,mipmap:e.mipmap,width:e.width,height:e.height,index:t.source,mimeType:i.mimeType,name:i.name,extensions:i.extensions,extras:i.extras}};C(n,t);const s=S(t.sampler)?this.gltf.samplers[t.sampler]:void 0;if(s&&(n.sampler=s,n.sampler.magFilter=s.magFilter||Q,n.sampler.minFilter=s.minFilter||9987,n.sampler.wrapS=s.wrapS||10497,n.sampler.wrapT=s.wrapT||10497),"image/ktx2"===n.image.mimeType&&!n.image.mipmap&&n.sampler&&n.sampler.minFilter!==Q&&9728!==n.sampler.minFilter){const e=n.sampler.minFilter;n.sampler.minFilter=9984===e||9986===e?9728:Q}return e.format&&(n.format=e.format),n}))}N(e){if(!S(e.bufferView))return this.requestExternalImage(e);{const t=this.gltf.bufferViews[e.bufferView],n=this.gltf.buffers[t.buffer];if(n.uri)return this.requestImageFromBufferURI(n,t,e);if(this.glbBuffer)return this.B(t,e)}return null}B(e,t){const n=this.m(e,this.glbBuffer.buffer,this.glbBuffer.byteOffset);return this.getImageByBuffer(n,t)}m(e,t,n){n=n||0;return new Uint8Array(t,(e.byteOffset||0)+n,e.byteLength)}R(e,t){const n=new Array(e.byteLength);for(let t=0;t<e.byteLength;t++)n[t]=String.fromCharCode(e[t]);n.join("");const i="data:"+(t=t||"image/png")+";base64,"+function(e){return"undefined"!=typeof self?self.btoa(e):window.btoa(e)}(unescape(encodeURIComponent(n)));return i}getAnimations(e){const t=[];return e.forEach((e=>{t.push(this.getSamplers(e.samplers))})),Promise.all(t).then((t=>{for(let n=0;n<t.length;n++)e[n].samplers=t[n];return e}))}getSamplers(e){const t=[];for(let n=0;n<e.length;n++)(S(e[n].input)||S(e[n].output))&&(t.push(this.accessor.T("input",e[n].input)),t.push(this.accessor.T("output",e[n].output)));return Promise.all(t).then((t=>{for(let n=0;n<t.length/2;n++)e[n].input=t[2*n],e[n].output=t[2*n+1],e[n].interpolation||(e[n].interpolation="LINEAR");return e}))}}const $="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;class V{static read(e,t=0,n=0){n||(n=e.byteLength);const i=new DataView(e,t,n),s=i.getUint32(4,!0);if(1===s)return V.readV1(i,t);if(2===s)return V.readV2(e,t);throw new Error("Unsupported glb version : "+s)}static readV1(e,t){const n=e.getUint32(8,!0),i=e.getUint32(12,!0);if(n!==e.byteLength)throw new Error("Length in GLB header is inconsistent with glb's byte length.");const s=K(e.buffer,20+t,i);return{json:JSON.parse(s),glbBuffer:{byteOffset:20+t+i,buffer:e.buffer,byteLength:n}}}static readV2(e,t){let n,i,s;const o=new DataView(e,t+12);let a=0;for(;a+8<o.byteLength;){const l=o.getUint32(a,!0);a+=4;const h=o.getUint32(a,!0);if(a+=4,1313821514===h)n=K(e,t+12+a,l);else if(5130562===h){s=t+12+a,i=l;break}a+=l}return{json:JSON.parse(n),glbBuffer:{byteOffset:s,buffer:e,byteLength:i}}}}function K(e,t,n){if($){const i=new Uint8Array(e,t,n);return $.decode(i)}return function(e){const t=e.length;let n="";for(let i=0;i<t;){let s=e[i++];if(128&s){let n=ee[s>>3&7];if(!(64&s)||!n||i+n>t)return null;for(s&=63>>n;n>0;n-=1){const t=e[i++];if(128!=(192&t))return null;s=s<<6|63&t}}n+=String.fromCharCode(s)}return n}(new Uint8Array(e,t,n))}const ee=[1,1,1,1,2,2,3,0],te=[0,0,0],re=[0,0,0,1],se=[1,1,1],oe={TRANSLATION:[0,0,0],ROTATION:[0,0,0,1],SCALE:[1,1,1]},le={PREVIOUS:null,NEXT:null,PREINDEX:null,NEXTINDEX:null,INTERPOLATION:null},he={C(e,t,n,i,s,o,l,h){const c=S(e)?t.animations:[t.animations[0]],u={};for(let t=0;t<c.length;t++){const f=c[t],g=f.name||t;if(S(e)&&g!==e)continue;const m=f.channelsMap[n];if(m)for(let e=0;e<m.length;e++){const t=m[e];"translation"===t.target.path?(this.U(s,f.samplers[t.sampler],i,1),u.translation=a(te,s)):"rotation"===t.target.path?(this.k(o,f.samplers[t.sampler],i,1),u.rotation=A(re,o)):"scale"===t.target.path?(this.U(l,f.samplers[t.sampler],i,1),u.scale=a(se,l)):"weights"===t.target.path&&h&&(this.U(h,f.samplers[t.sampler],i,h.length),u.weights=h)}}return u},U(e,t,n,i){switch(t.interpolation){case"LINEAR":{const s=this.L(le,t,n,1*i);s&&(e=function(e,t,n,i){for(let s=0;s<e.length;s++)e[s]=t[s]+i*(n[s]-t[s]);return e}(e,s.PREVIOUS,s.NEXT,s.INTERPOLATION));break}case"STEP":{const s=this.L(le,t,n,1*i);s&&(e=function(e,t){for(let n=0;n<e.length;n++)e[n]=t[n];return e}(e,...s.PREVIOUS));break}case"CUBICSPLINE":{const s=this.L(le,t,n,3*i);s&&(e=this.q(e,s,t.input.array,3*i));break}}return e},k(e,t,n){switch(t.interpolation){case"LINEAR":{const i=this.L(le,t,n,1);i&&function(e,t,n,i){var s,o,a,l,h,c=t[0],u=t[1],f=t[2],g=t[3],m=n[0],A=n[1],w=n[2],T=n[3];(o=c*m+u*A+f*w+g*T)<0&&(o=-o,m=-m,A=-A,w=-w,T=-T),1-o>1e-6?(s=Math.acos(o),a=Math.sin(s),l=Math.sin((1-i)*s)/a,h=Math.sin(i*s)/a):(l=1-i,h=i),e[0]=l*c+h*m,e[1]=l*u+h*A,e[2]=l*f+h*w,e[3]=l*g+h*T}(e,i.PREVIOUS,i.NEXT,i.INTERPOLATION);break}case"STEP":{const i=this.L(le,t,n,1);i&&(e=u(e,...i.PREVIOUS));break}case"CUBICSPLINE":{const i=this.L(le,t,n,3);if(i){for(let e=0;e<i.PREVIOUS.length;e++)i.PREVIOUS[e]=Math.acos(i.PREVIOUS[e]),i.NEXT[e]=Math.acos(i.NEXT[e]);e=this.q(e,i,t.input.array,3);for(let t=0;t<e.length;t++)e[t]=Math.cos(e[t])}break}}return e},F(e,t){const n=e.length;let i,s,o,a=0,l=n-1,h=Math.floor((a+l)/2);for(;a<=n-1&&l>=0;){if(a===l)return null;if(e[h]<=t&&t<=e[h+1]){const n=e[h];return i=h,s=h+1,o=(t-n)/(e[h+1]-n),{preIndx:i,nextIndex:s,interpolation:o}}t<e[h]?(l=h,h=Math.floor((a+l)/2)):e[h+1]<t&&(a=h,h=Math.floor((a+l)/2))}return null},L(e,t,n,i){const s=t.input.array,o=t.output.array,a=t.output.itemSize;(n<s[0]||n>s[s.length-1])&&(n=Math.max(s[0],Math.min(s[s.length-1],n))),n===s[s.length-1]&&(n=s[0]);const l=this.F(s,n);if(!l||!l.nextIndex)return null;const{preIndx:h,nextIndex:c,interpolation:u}=l;e.PREINDEX=h,e.NEXTINDEX=c,e.INTERPOLATION=u;const f=a*i;return e.PREVIOUS=o.subarray(e.PREINDEX*f,(e.PREINDEX+1)*f),e.NEXT=o.subarray(e.NEXTINDEX*f,(e.NEXTINDEX+1)*f),e},q(e,t,n,i){const s=t.INTERPOLATION,o=n[t.PREINDEX],a=n[t.NEXTINDEX];for(let n=0;n<3;n++){const l=t.PREVIOUS[i+n],h=(a-o)*t.PREVIOUS[2*i+n],c=t.NEXT[3+n],u=(a-o)*t.NEXT[n],f=(2*Math.pow(s,3)-3*Math.pow(s,2)+1)*l+(Math.pow(s,3)-2*Math.pow(s,2)+s)*h+(2*-Math.pow(s,3)+3*Math.pow(s,2))*c+(Math.pow(s,3)-Math.pow(s,2))*u;e[n]=f}return e},getAnimationClip(e,t,n,i){const s=e.nodes[t]&&e.nodes[t].weights;return l(te,...oe.TRANSLATION),u(re,...oe.ROTATION),l(se,...oe.SCALE),this.C(i,e,t,n,te,re,se,s)},getTimeSpan(e){if(!e.animations)return null;if(e.timeSpan)return e.timeSpan;const t=e.animations;return e.timeSpan={},t.forEach(((t,n)=>{let i=-1/0,s=1/0;const o=t.channels;for(let e=0;e<o.length;e++){const n=t.samplers[o[e].sampler].input.array;n[n.length-1]>i&&(i=n[n.length-1]),n[0]<s&&(s=n[0])}e.timeSpan[t.name||n]={max:i,min:s}})),e.timeSpan},getTimeSpanByName(e,t){const n=this.getTimeSpan(e);return n?S(t)?n[t]:n[Object.keys(n)[0]]:null}};let ue=!1;if("undefined"!=typeof OffscreenCanvas){let e;try{e=new OffscreenCanvas(2,2).getContext("2d")}catch(n){}e&&"undefined"!=typeof createImageBitmap&&(ue=!0)}const fe="undefined"==typeof document?null:document.createElement("canvas");function de(e,t,n){const i=new Image;i.crossOrigin="",i.onload=()=>{if(!fe)return void n(new Error("There is no canvas to draw image!"));fe.width=i.width,fe.height=i.height;const e=fe.getContext("2d",{willReadFrequently:!0});e.drawImage(i,0,0,i.width,i.height);const t=e.getImageData(0,0,i.width,i.height),s={width:i.width,height:i.height,data:new Uint8Array(t.data)};n(null,s)},i.onerror=function(e){n(e)},i.src=e}const pe=[],me=[],Ae=30;let ye,_e;function ve(e,t,n){ye||(ye=new OffscreenCanvas(2,2),_e=ye.getContext("2d",{willReadFrequently:!0}));let i=null;if(M(e))this.options.urlModifier&&(e=this.options.urlModifier(e)),pe.push([e,t,n,this]),xe();else{const t=new Blob([e]);i=createImageBitmap(t),i.then(be.bind(this)).then((e=>{n(null,e)})).catch((e=>{console.warn(e),n(e)}))}}function xe(){if(!pe.length||me.length>Ae)return;const e=pe.shift(),[t,n,i,s]=e;me.push(e),fetch(t,n).then((e=>e.arrayBuffer())).then((e=>{const t=new Blob([new Uint8Array(e)]);return createImageBitmap(t)})).then(be.bind(s)).then((t=>{i.call(s,null,t);const n=me.indexOf(e);me.splice(n,1),xe()})).catch((t=>{console.warn(t),i.call(s,t);const n=me.indexOf(e);me.splice(n,1),xe()}))}function be(e){let{width:t,height:n}=e;we(t)||(t=Te(t)),we(n)||(n=Te(n));const i=this.options.maxTextureSize;i&&(t=Math.min(i,t),n=Math.min(i,n)),ye.width=t,ye.height=n,_e.drawImage(e,0,0,t,n),e.close();const s=_e.getImageData(0,0,t,n);return{width:t,height:n,data:new Uint8Array(s.data)}}function we(e){return!(e&e-1)&&0!==e}function Te(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))}function Se(e,t){for(const n in e)if(e[n]===t)return n;return t}e.Ajax=X,e.GLTFLoader=class{constructor(e,t,n){if(this.options=n||{},this.options.decoders||(this.options.decoders={}),this.u=this.options.fetchOptions||{},t.buffer instanceof ArrayBuffer){const{json:n,glbBuffer:i}=V.read(t.buffer,t.byteOffset,t.byteLength);this.D(e,n,i)}else this.D(e,t);this.V=new k(this.rootPath,this.gltf,this.glbBuffer,this.u,this.options.urlModifier),this.j()}j(){const e=this.gltf.extensionsRequired;if(e){if(e.indexOf("KHR_draco_mesh_compression")>=0&&!this.options.decoders.draco)throw new Error("KHR_draco_mesh_compression is required but @maptalks/transcoders.draco is not loaded");if(e.indexOf("KHR_texture_basisu")>=0&&!this.options.decoders["image/ktx2"])throw new Error("KHR_texture_basisu is required but @maptalks/transcoders.ktx2 is not loaded");if(e.indexOf("EXT_meshopt_compression")>=0)throw new Error("EXT_meshopt_compression extension is not supported yet.")}}K(){const e=this.gltf.extensions;return e&&e.KHR_techniques_webgl?this.V.requestKHRTechniquesWebgl(e.KHR_techniques_webgl).then((t=>(e.KHR_techniques_webgl=t,e))):Promise.resolve(e)}H(){if(!Array.isArray(this.gltf.programs))return;const e=this.gltf.materials;for(let t=0;t<e.length;t++)e[t]&&e[t].extensions&&e[t].extensions.KHR_technique_webgl&&(e[t].extensions.KHR_techniques_webgl=e[t].extensions.KHR_technique_webgl,delete e[t].extensions.KHR_technique_webgl);const t=this.gltf.extensions||{},n=this.gltf.techniques;t.KHR_techniques_webgl={programs:this.gltf.programs,shaders:this.gltf.shaders,techniques:n};for(let t=0;t<e.length;t++){const s=(i=e[t])&&i.extensions&&i.extensions.KHR_techniques_webgl;if(s){const{values:e,technique:t}=s,i=n[t];if(!i||!e)continue;const{uniforms:o,parameters:a}=i,l={};for(const t in e){const n=Se(o,t);l[n]=e[t],a[t]&&35678===a[t].type&&(l[n]={index:e[t]})}s.values=l}}var i;for(let e=0;e<n.length;e++){const t=n[e];if(!t)continue;const{attributes:i,uniforms:s,parameters:o}=t;if(i)for(const e in i){i[e]=o[i[e]]}if(s)for(const e in s){s[e]=o[s[e]]}delete t.parameters}return delete this.gltf.programs,delete this.gltf.shaders,delete this.gltf.techniques,this.gltf.extensions=t,t}load(e){e=e||{},this.H();const t=this.X(e),n=this.$(),i=this.G(),s=this.K();return Promise.all([t,n,i,s]).then((e=>(e[0].animations=e[1],e[0].textures=e[2],e[0].extensions=e[3],e[0].transferables=this.transferables||[],this.createChannelsMap(e[0]),e[0])))}createChannelsMap(e){const t=e.animations;if(t)for(let e=0;e<t.length;e++){const n=t[e];n.channelsMap={};for(let e=0;e<n.channels.length;e++){const t=n.channels[e];n.channelsMap[t.target.node]||(n.channelsMap[t.target.node]=[]),n.channelsMap[t.target.node].push(t)}}}getExternalResources(){const e=[];if(this.gltf){const{buffers:t,images:n}=this.gltf;for(let n=0;n<t.length;n++)t[n].uri&&t[n].uri.indexOf("data:application/octet-stream;base64")<0&&e.push({type:"buffer",uri:t[n].uri});for(let t=0;t<n.length;t++)n[t].uri&&n[t].uri.indexOf("data:image/")<0&&e.push({type:"image",uri:n[t].uri})}return e}static getAnimationClip(e,t,n,i){return he.getAnimationClip(e,t,n,i)}static getAnimationTimeSpan(e,t){return he.getTimeSpanByName(e,t)}static getTypedArrayCtor(e){return I(e)}static readInterleavedArray(e,t,n,i,s,o,a){return W(e,t,n,i,s,o,a)}D(e,t,n){this.gltf=t,this.glbBuffer=n,this.version=t.asset?+t.asset.version:1,this.rootPath=e,this.buffers={},this.requests={},this.options.requestImage=ue?ve.bind(this):this.options.requestImage||de,this.options.transferable&&(this.transferables=[]),2===this.version?(this.adapter=new F(e,t,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this.u,this.options.urlModifier),this.adapter.iterate(((e,t,n)=>{t.id="buffer_"+n}),"buffers"),this.adapter.iterate(((e,t,n)=>{t.id="image_"+n}),"images"),this.adapter.iterate(((e,t,n)=>{t.id="accessor_"+n}),"accessors")):(this.adapter=new L(e,t,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this.u,this.options.urlModifier),this.adapter.iterate(((e,t,n)=>{t.id="accessor_"+n}),"accessors"),this.adapter.iterate(((e,t,n)=>{t.id="image_"+n}),"images"))}J(e,t){if(e.children&&e.children.length>0){if(!("number"==typeof(n=e.children[0])&&isFinite(n)||M(e.children[0])))return e;const i=e.children.map((e=>{const n=t[e];return n.nodeIndex=e,this.J(n,t)}));e.children=i}var n;return e}X(e){return this.W(e).then((e=>{const t=this.scenes=[];let n;for(const t in e)e[t]=this.J(e[t],e),e[t].nodeIndex=Number(t)?Number(t):t;this.adapter.iterate(((i,s,o)=>{const a={};s.name&&(a.name=s.name),s.nodes&&(a.nodes=s.nodes.map((t=>e[t]))),this.gltf.scene===i&&(n=o),t.push(a)}),"scenes");const i={textures:this.gltf.textures,asset:this.gltf.asset,scene:n,scenes:t,nodes:e,meshes:this.meshes,materials:this.gltf.materials,skins:this.skins,extensionsRequired:this.gltf.extensionsRequired,extensionsUsed:this.gltf.extensionsUsed};if(this.gltf.extensions&&(i.extensions=this.gltf.extensions),1===this.version){const e=this.adapter.O(this.gltf.materials);i.materials=e}return delete this.gltf.buffers,i.json=this.gltf,i}))}W(e){return this.Y(e).then((()=>{const e=this.nodes={};return this.adapter.iterate(((t,n)=>{const i=this.adapter.createNode(n,this.meshes,this.skins);e[t]=i}),"nodes"),e}))}Z(){this.skins=[];const e=[];return this.adapter.iterate(((t,n,i)=>{e.push(this.tt(n).then((e=>{e.index=i,this.skins.push(e)})))}),"skins"),e}tt(e){return this.adapter.accessor.T("inverseBindMatrices",e.inverseBindMatrices).then((t=>(e.inverseBindMatrices=t,t&&t.buffer&&this.transferables&&this.transferables.indexOf(t.buffer)<0&&this.transferables.push(t.buffer),e)))}$(){const e=this.gltf.animations;return S(e)?this.adapter.getAnimations(e):null}Y(e){this.meshes={};let t=[];return this.adapter.iterate(((n,i,s)=>{t.push(this.et(i,e).then((e=>{e.index=s,this.meshes[n]=e})))}),"meshes"),t=t.concat(this.Z()),Promise.all(t)}et(e,t){const n=e.primitives.map((e=>this.nt(e,t))).filter((e=>!!e));return Promise.all(n).then((t=>{const n={};return C(n,e),n.primitives=t,n}))}G(){const e=this.gltf.textures;if(!e)return null;const t=[];for(const n in e)t.push(this.adapter.S(n));return Promise.all(t).then((t=>{if(this.transferables)for(let e=0;e<t.length;e++){const n=t[e]&&t[e].image.array;if(n){let e;e=n instanceof ImageBitmap?n:n.buffer,e&&this.transferables.indexOf(e)<0&&this.transferables.push(e)}}if(!Array.isArray(e)){const n={},i=Object.keys(e);for(let e=0;e<t.length;e++)t[e]&&(n[i[e]]=t[e]);return n}return t}))}nt(e,t){let n;const i=[],s=e.extensions;if(S(e.targets))for(let t=0;t<e.targets.length;t++){const n=e.targets[t];for(const e in n){const s=this.adapter.accessor.T(`morphTargets_${e}_${t}`,n[e]);s&&i.push(s)}}if(s&&s.KHR_draco_mesh_compression){if(!this.options.decoders.draco&&(!this.gltf.extensionsRequired||!this.gltf.extensionsRequired.indexOf("KHR_draco_mesh_compression")<0))return null;const e=this.options.decoders.draco,{bufferView:o,attributes:a}=s.KHR_draco_mesh_compression,l=this.gltf.bufferViews[o],h=this.V.I(l).then((n=>{const{buffer:i,byteOffset:s}=n;let{byteOffset:o}=l;o||(o=0);const h=new DataView(i,s+o,l.byteLength);return e(h,{attributes:a,useUniqueIDs:!1,skipAttributeTransform:t.skipAttributeTransform}).then((e=>{const t=Object.values(e.attributes);return e.indices&&t.push(e.indices),t}))}));i.push(h),n=Promise.all(i)}else{const t=e.attributes;for(const e in t){const n=this.adapter.accessor.T(e,t[e]);n&&i.push(n)}if(S(e.indices)){const t=this.adapter.accessor.T("indices",e.indices);t&&i.push(t)}n=Promise.all(i)}return n.then((t=>{if(s&&s.KHR_draco_mesh_compression){const n=e.targets?e.targets.length:0;t[n]=t[n].concat(t.slice(0,n)),t=t[n]}let n,i;const o={attributes:t.reduce(((e,t)=>{if("indices"===t.name)n=t;else if(t.name.indexOf("morphTargets_")>-1)i=i||{},i[t.name.slice(13)]=t;else{if(!("POSITION"!==t.name||t.min&&t.max)){const e=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0],{itemSize:i,array:s}=t,o=s.length/i;for(let t=0;t<o;t++)for(let o=0;o<i;o++){const a=t*i+o;s[a]<e[o]&&(e[o]=s[a]),s[a]>n[o]&&(n[o]=s[a])}if(t.quantization){const i=t.quantization,s=i.range/(1<<i.quantizationBits),o=i.minValues;c(e,e,s),h(e,e,o),c(n,n,s),h(n,n,o)}t.min=e,t.max=n}e[t.name]=t}return this.transferables&&t.array.buffer&&this.transferables.indexOf(t.array.buffer)<0&&this.transferables.push(t.array.buffer),e}),{}),material:e.material};return n&&(o.indices=n),i&&(o.morphTargets=i),o.mode=S(e.mode)?e.mode:4,S(e.extras)&&(o.extras=e.extras),o}))}},t().maptalks_gltf_loader=e}ox.inject=function(e){const t=e.toString(),n=t.indexOf("{")+1,i=t.substring(0,n),s=sx.gl_trans__coders=sx.gl_trans__coders||{};let o=`${i}\n    const _____getGlobal = ${ix.toString()};\n    const g___lobals = _____getGlobal()\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};`;for(const e in s)"inject"!==e&&"getTranscoder"!==e&&"registerTranscoder"!==e&&(o+='tran_____scoders["'+e+'"] ='+s[e].toString()+"\n;");return o+="\n("+ix().maptalks_gltf_loader_bundle.toString()+")({});\n",o+="\n"+t.substring(i.length),o},ox.registerTranscoder=function(e,t){ox[e]=t},ox.getTranscoder=function(e){return ox[e]},ax({});const lx=function(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;throw new Error("unable to locate global object")};function hx(){return lx().maptalks_gltf_loader}function cx(e){return!ux(e)&&("string"==typeof e||null!==e.constructor&&e.constructor===String)}function ux(e){return null==e}function fx(e){return!ux(e)}function dx(e){return!ux(e)&&("function"==typeof e||null!==e.constructor&&e.constructor===Function)}function px(e,...t){return Object.assign(e,...t),e}function gx(e,...t){for(let n=0;n<t.length;n++){const i=t[n];for(const t in i)null!=i[t]&&(e[t]=i[t])}return e}function mx(e){return"number"==typeof e&&!isNaN(e)}function Ax(e,t,n){return e*(1-n)+t*n}function yx(e){return Array.isArray(e)||e instanceof Uint8Array||e instanceof Int8Array||e instanceof Uint16Array||e instanceof Int16Array||e instanceof Uint32Array||e instanceof Int32Array||e instanceof Uint8ClampedArray||e instanceof Float32Array||e instanceof Float64Array}function _x(e){return Array.isArray(e)&&Array||e instanceof Uint8Array&&Uint8Array||e instanceof Int8Array&&Int8Array||e instanceof Uint16Array&&Uint16Array||e instanceof Int16Array&&Int16Array||e instanceof Uint32Array&&Uint32Array||e instanceof Int32Array&&Int32Array||e instanceof Uint8ClampedArray&&Uint8ClampedArray||e instanceof Float32Array&&Float32Array||e instanceof Float64Array&&Float64Array}function vx(e){return(e=Math.abs(e))<128?Int8Array:e<32768?Int16Array:Float32Array}function xx(e,t,n){return Math.min(n,Math.max(t,e))}function bx(e){return!globalThis.MAPTALKS_DISABLE_VAO&&(!e.wgpu&&(e&&e.hasExtension&&e.hasExtension("oes_vertex_array_object")))}function wx(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function Tx(e){if(e.data){if(e.data.BYTES_PER_ELEMENT)return e.data.length*e.data.BYTES_PER_ELEMENT;if(e.data.length)return 4*e.data.length}else{if(e.BYTES_PER_ELEMENT)return e.length*e.BYTES_PER_ELEMENT;if(e.length)return 4*e.length;if(e.buffer&&e.buffer.destroy){const t=e.buffer._buffer;return t?t.byteLength:e.buffer.size}}return 0}function Sx(e){return e.width*e.height*Cx(e.format)*Mx(e.type)*("textureCube"===e._reglType?6:1)}function Mx(e){return"uint8"===e?1:"uint16"===e||"float16"===e||"half float"===e?2:"uint32"===e||"float"===e||"float32"===e?4:0}function Cx(e){return"depth"===e||"alpha"===e||"luminance"===e?1:"luminance alpha"===e||"depth stencil"===e?2:"srgba"===e||"rgb5 a1"===e||"rgba"===e.substring(0,4)?4:"srgb"===e||"rgb"===e.substring(0,3)?3:1}function Px(e){if(!e.componentType)return!1;const t=hx().GLTFLoader.getTypedArrayCtor(e.componentType);return e.byteStride>0&&e.byteStride!==e.itemSize*t.BYTES_PER_ELEMENT}function Ix(e){return e&&(e.stride>0||Px(e))}function kx(e){const t=e.getExtension&&e,n=!t&&e,i="WEBGL_compressed_texture_",s="texture-compression-",o={etc:t?!!t.getExtension(i+"etc"):!!n.features.has(s+"etc2"),etc1:t?!!t.getExtension(i+"etc1"):!!n.features.has(s+"etc2"),s3tc:t?!!t.getExtension(i+"s3tc"):!!n.features.has(s+"bc"),pvrtc:!!t&&!!t.getExtension(i+"pvrtc"),astc:t?!!t.getExtension(i+"astc"):!!n.features.has(s+"astc"),bc7:t?!!t.getExtension("EXT_texture_compression_bptc"):!!n.features.has(s+"bc")};return o[i+"etc"]=o.etc,o[i+"etc1"]=o.etc1,o[i+"s3tc"]=o.s3tc,o[i+"pvrtc"]=o.pvrtc,o[i+"astc"]=o.astc,o[i+"bc7"]=o.bc7,o}function Ox(e){let t=0;const n=e&&e.length||0;if(!n)return t;let i;for(let s=0;s<n;s++)i=e.charCodeAt(s),t=(t<<5)-t+i,t|=0;return t}function Ex(e){return!(e&e-1)&&0!==e}function Rx(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))}function Lx(e,t,n){if(yx(e))return Ex(t)&&Ex(n)?e:function(e,t,n){let i=t,s=n;Ex(t)||(i=Rx(t)),Ex(n)||(s=Rx(n));const o=new ImageData(new Uint8ClampedArray(e),t,n),a=document.createElement("canvas");a.width=t,a.height=n,a.getContext("2d").putImageData(o,0,0);const l=document.createElement("canvas");l.width=i,l.height=s,l.getContext("2d").drawImage(a,0,0,t,n,0,0,s,s),console.warn(`Texture's size is not power of two, resize from (${t}, ${n}) to (${i}, ${s})`);let h=document.getElementById("_debug_resize_canvas");return h||(h=document.createElement("canvas"),h.id="_debug_resize_canvas",document.body.appendChild(h)),h.width=i,h.height=s,h.getContext("2d").drawImage(l,0,0),l}(e,t,n);if(Ex(e.width)&&Ex(e.height))return e;n=e.height,Ex(t=e.width)||(t=Rx(t)),Ex(n)||(n=Rx(n));const i=document.createElement("canvas");i.width=t,i.height=n,i.getContext("2d").drawImage(e,0,0,t,n);const s=e.src,o=s.lastIndexOf("/")+1,a=s.substring(o);return console.warn(`Texture(${a})'s size is not power of two, resize from (${e.width}, ${e.height}) to (${t}, ${n})`),i}function Dx(e){return!!e.wgpu||(!e._gl||e._gl instanceof WebGL2RenderingContext)}var Fx=Object.freeze({__proto__:null,clamp:xx,defined:fx,extend:px,extendWithoutNil:gx,getArrayCtor:_x,getBufferSize:Tx,getPosArrayType:vx,getSupportedFormats:kx,getTexMemorySize:Sx,getTextureByteWidth:Mx,getTextureChannels:Cx,hasOwn:wx,hashCode:Ox,interpolate:Ax,isArray:yx,isFunction:dx,isInStride:Px,isInterleaved:Ix,isNil:ux,isNumber:mx,isPowerOfTwo:Ex,isString:cx,isSupportVAO:bx,isTextureDestroyed:function(e){return e.device?!e.texture:!e._texture||!e._texture.texture},lerp:function(e,t,n,i){for(let s=0;s<e.length;s++)e[s]=t[s]+i*(n[s]-t[s]);return e},log2:function(e){return Math.log2(e)},normalize:function(e,t){let n=0;for(let e=0,i=t.length;e<i;e++)n+=t[e];for(let i=0,s=t.length;i<s;i++)e[i]=t[i]/n;return e},resizeToPowerOfTwo:Lx,set:function(e,t){for(let n=0;n<e.length;n++)e[n]=t[n];return e},supportNPOT:Dx});function Hx(e){return class EventableMixin extends e{on(e,t){return this._events||(this._events={type:[t]}),this._events[e]=this._events[e]||[],this._events[e].push(t),this}once(e,t){return this.on(e,this._wrapOnce(e,t))}off(e,t){return this._events&&this._events[e]?(this._events[e].splice(this._events[e].indexOf(t),1),this):this}fire(e,t={}){if(!this._events||!this._events[e])return this;t.target||(t.target=this);const n=this._events[e].slice(0);for(const e of n)e(t);return this}_wrapOnce(e,t){const n=this;let i=!1;return function s(o){i||(i=!0,t(o),n.off(e,s))}}}}const Nx="__reshader_disposed",Bx="not implemented";var zx=Object.freeze({__proto__:null,ERROR_NOT_IMPLEMENTED:Bx,KEY_DISPOSED:Nx,WEBGL_EXTENSIONS:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives"],WEBGL_OPTIONAL_EXTENSIONS:["OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","EXT_texture_filter_anisotropic"]});const Gx="_reshader_refCount";let Ux=class Base{};class AbstractTexture extends(Hx(Ux)){constructor(e,t){if(super(),dx(e)){this._texture=e,e=this.config={};for(const t in this._texture)wx(this._texture,t)&&(dx(this._texture[t])||(e[t]=this._texture[t]))}else if(this.config=e||{},this.resLoader=t,(e.url||e.promise)&&!e.data){this._loading=!0;const n=this;let i;if(e.promise)i=e.promise;else{let n;n=e.arrayBuffer?t.getArrayBuffer:t.get,i=n.call(t,e.url)}e.data=t.getDefaultTexture(e.url),this.promise=i,i.then((e=>(delete this.promise,n._loading=!1,n.config?(n.onLoad(e),Array.isArray(e)||(e=[e]),n.fire("complete",{target:this,resources:e}),e):e))).catch((e=>{console.error("error when loading texture image.",e),n.fire("error",{target:this,error:e})}))}}onLoad(e){}isReady(){return!this._loading}set(e,t){return this.config[e]=t,this.dirty=!0,this}get(e){return this.config[e]}createREGLTexture(e){return null}getREGLTexture(e){return this._texture||(this._texture=this.createREGLTexture(e),this.config.persistent||(this.config.data&&(this.config.data instanceof ImageBitmap||(this.config.data=[])),this.config.image&&(this.config.image.array=[]),this.config.mipmap&&delete this.config.mipmap)),this.dirty&&this._update(),this._texture}getMemorySize(){if(!this.config)return 0;const{width:e,height:t,type:n,format:i}=this.config;return e*t*Mx(n||"uint8")*Cx(i||"rgba")}_update(){throw new Error(Bx)}dispose(){this.config&&this.config.url&&(URL.revokeObjectURL(this.config.url),this.resLoader.disposeRes(this.config.url)),this.config&&this.config.data instanceof ImageBitmap&&(this.config.data.close(),this.config.data=[]),this._texture&&!this._texture[Nx]&&(this._texture[Gx]&&this._texture[Gx]--,this._texture[Gx]||(this._texture.destroy(),this._texture[Nx]=!0,delete this._texture)),delete this.resLoader,delete this._regl;const e=this.config&&this.config.url;delete this.config,e&&this.fire("disposed",{target:this,url:e})}}const Vx=AA([]),jx=AA([]);class BoundingBox{constructor(e,t){this.min=e||[1/0,1/0,1/0],this.max=t||[-1/0,-1/0,-1/0],this.updateVertex()}static copy(e,t){qA(e.min,t.min),qA(e.max,t.max);for(let n=0;n<t.vertex.length;n++)qA(e.vertex[n],t.vertex[n]);return e}combine(e){if(!e)return this;let t,n;return Array.isArray(e)?(t=e[0],n=e[1]):(t=e.min,n=e.max),t[0]<this.min[0]&&(this.min[0]=t[0],this._dirty=!0),t[1]<this.min[1]&&(this.min[1]=t[1],this._dirty=!0),t[2]<this.min[2]&&(this.min[2]=t[2],this._dirty=!0),n[0]>this.max[0]&&(this.max[0]=n[0],this._dirty=!0),n[1]>this.max[1]&&(this.max[1]=n[1],this._dirty=!0),n[2]>this.max[2]&&(this.max[2]=n[2],this._dirty=!0),this}dirty(){return this._dirty=!0,this}getCenter(){return this.center||(this.center=[0,0,0],this._dirty=!0),this._dirty&&(XA(this.center,this.min,this.max),$A(this.center,this.center,.5)),this._dirty=!1,this.center}containPoint(e){const t=this.min,n=this.max;return t[0]<=e[0]&&t[1]<=e[1]&&t[2]<=e[2]&&n[0]>=e[0]&&n[1]>=e[1]&&n[2]>=e[2]}isFinite(){const e=this.min,t=this.max;return isFinite(e[0])&&isFinite(e[1])&&isFinite(e[2])&&isFinite(t[0])&&isFinite(t[1])&&isFinite(t[2])}updateVertex(){if(!this.vertex){this.vertex=[];for(let e=0;e<8;e++)this.vertex.push([0,0,0])}return this.vertex[0][0]=this.min[0],this.vertex[0][1]=this.min[1],this.vertex[0][2]=this.min[2],this.vertex[1][0]=this.min[0],this.vertex[1][1]=this.min[1],this.vertex[1][2]=this.max[2],this.vertex[2][0]=this.min[0],this.vertex[2][1]=this.max[1],this.vertex[2][2]=this.max[2],this.vertex[3][0]=this.min[0],this.vertex[3][1]=this.max[1],this.vertex[3][2]=this.min[2],this.vertex[4][0]=this.max[0],this.vertex[4][1]=this.min[1],this.vertex[4][2]=this.min[2],this.vertex[5][0]=this.max[0],this.vertex[5][1]=this.min[1],this.vertex[5][2]=this.max[2],this.vertex[6][0]=this.max[0],this.vertex[6][1]=this.max[1],this.vertex[6][2]=this.max[2],this.vertex[7][0]=this.max[0],this.vertex[7][1]=this.max[1],this.vertex[7][2]=this.min[2],this.vertex}copy(e){return e?BoundingBox.copy(e,this):new BoundingBox(this.min.slice(),this.max.slice())}equals(e){if(!cy(this.min,e.min)||!cy(this.max,e.max))return!1;const t=e.vertex;for(let e=0;e<this.vertex.length;e++)if(!cy(t[e],this.vertex[e]))return!1;return!0}transform(e,t){if(e=e||jx,(t=t||jx)[1]||t[2]||t[4]||t[6]||t[8]||t[9]){const n=this.vertex,i=vA(Vx,t,e);for(let e=0;e<n.length;e++)oy(this.vertex[e],this.vertex[e],i);const s=this.vertex.map((e=>e[0])),o=this.vertex.map((e=>e[1])),a=this.vertex.map((e=>e[2])),l=Math.min(...s),h=Math.max(...s),c=Math.min(...o),u=Math.max(...o),f=Math.min(...a),g=Math.max(...a);ZA(this.min,l,c,f),ZA(this.max,h,u,g)}else{const n=vA(Vx,t,e);oy(this.min,this.min,n),oy(this.max,this.max,n)}return this}}function Wx(e,t,n=2){const i=t&&t.length,s=i?t[0]*n:e.length;let o=qx(e,0,s,n,!0);const a=[];if(!o||o.next===o.prev)return a;let l,h,c;if(i&&(o=function(e,t,n,i){const s=[];for(let n=0,o=t.length;n<o;n++){const a=qx(e,t[n]*i,n<o-1?t[n+1]*i:e.length,i,!1);a===a.next&&(a.steiner=!0),s.push(rb(a))}s.sort(Kx);for(let e=0;e<s.length;e++)n=eb(s[e],n);return n}(e,t,o,n)),e.length>80*n){l=1/0,h=1/0;let t=-1/0,i=-1/0;for(let o=n;o<s;o+=n){const n=e[o],s=e[o+1];n<l&&(l=n),s<h&&(h=s),n>t&&(t=n),s>i&&(i=s)}c=Math.max(t-l,i-h),c=0!==c?32767/c:0}return Xx(o,a,n,l,h,c,0),a}function qx(e,t,n,i,s){let o;if(s===function(e,t,n,i){let s=0;for(let o=t,a=n-i;o<n;o+=i)s+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return s}(e,t,n,i)>0)for(let s=t;s<n;s+=i)o=pb(s/i|0,e[s],e[s+1],o);else for(let s=n-i;s>=t;s-=i)o=pb(s/i|0,e[s],e[s+1],o);return o&&lb(o,o.next)&&(gb(o),o=o.next),o}function Zx(e,t){if(!e)return e;t||(t=e);let n,i=e;do{if(n=!1,i.steiner||!lb(i,i.next)&&0!==ab(i.prev,i,i.next))i=i.next;else{if(gb(i),i=t=i.prev,i===i.next)break;n=!0}}while(n||i!==t);return t}function Xx(e,t,n,i,s,o,a){if(!e)return;!a&&o&&function(e,t,n,i){let s=e;do{0===s.z&&(s.z=nb(s.x,s.y,t,n,i)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==e);s.prevZ.nextZ=null,s.prevZ=null,function(e){let t,n=1;do{let i,s=e;e=null;let o=null;for(t=0;s;){t++;let a=s,l=0;for(let e=0;e<n&&(l++,a=a.nextZ,a);e++);let h=n;for(;l>0||h>0&&a;)0!==l&&(0===h||!a||s.z<=a.z)?(i=s,s=s.nextZ,l--):(i=a,a=a.nextZ,h--),o?o.nextZ=i:e=i,i.prevZ=o,o=i;s=a}o.nextZ=null,n*=2}while(t>1)}(s)}(e,i,s,o);let l=e;for(;e.prev!==e.next;){const h=e.prev,c=e.next;if(o?Jx(e,i,s,o):Yx(e))t.push(h.i,e.i,c.i),gb(e),e=c.next,l=c.next;else if((e=c)===l){a?1===a?Xx(e=Qx(Zx(e),t),t,n,i,s,o,2):2===a&&$x(e,t,n,i,s,o):Xx(Zx(e),t,n,i,s,o,1);break}}}function Yx(e){const t=e.prev,n=e,i=e.next;if(ab(t,n,i)>=0)return!1;const s=t.x,o=n.x,a=i.x,l=t.y,h=n.y,c=i.y,u=Math.min(s,o,a),f=Math.min(l,h,c),g=Math.max(s,o,a),m=Math.max(l,h,c);let A=i.next;for(;A!==t;){if(A.x>=u&&A.x<=g&&A.y>=f&&A.y<=m&&sb(s,l,o,h,a,c,A.x,A.y)&&ab(A.prev,A,A.next)>=0)return!1;A=A.next}return!0}function Jx(e,t,n,i){const s=e.prev,o=e,a=e.next;if(ab(s,o,a)>=0)return!1;const l=s.x,h=o.x,c=a.x,u=s.y,f=o.y,g=a.y,m=Math.min(l,h,c),A=Math.min(u,f,g),w=Math.max(l,h,c),T=Math.max(u,f,g),S=nb(m,A,t,n,i),M=nb(w,T,t,n,i);let C=e.prevZ,I=e.nextZ;for(;C&&C.z>=S&&I&&I.z<=M;){if(C.x>=m&&C.x<=w&&C.y>=A&&C.y<=T&&C!==s&&C!==a&&sb(l,u,h,f,c,g,C.x,C.y)&&ab(C.prev,C,C.next)>=0)return!1;if(C=C.prevZ,I.x>=m&&I.x<=w&&I.y>=A&&I.y<=T&&I!==s&&I!==a&&sb(l,u,h,f,c,g,I.x,I.y)&&ab(I.prev,I,I.next)>=0)return!1;I=I.nextZ}for(;C&&C.z>=S;){if(C.x>=m&&C.x<=w&&C.y>=A&&C.y<=T&&C!==s&&C!==a&&sb(l,u,h,f,c,g,C.x,C.y)&&ab(C.prev,C,C.next)>=0)return!1;C=C.prevZ}for(;I&&I.z<=M;){if(I.x>=m&&I.x<=w&&I.y>=A&&I.y<=T&&I!==s&&I!==a&&sb(l,u,h,f,c,g,I.x,I.y)&&ab(I.prev,I,I.next)>=0)return!1;I=I.nextZ}return!0}function Qx(e,t){let n=e;do{const i=n.prev,s=n.next.next;!lb(i,s)&&hb(i,n,n.next,s)&&fb(i,s)&&fb(s,i)&&(t.push(i.i,n.i,s.i),gb(n),gb(n.next),n=e=s),n=n.next}while(n!==e);return Zx(n)}function $x(e,t,n,i,s,o){let a=e;do{let e=a.next.next;for(;e!==a.prev;){if(a.i!==e.i&&ob(a,e)){let l=db(a,e);return a=Zx(a,a.next),l=Zx(l,l.next),Xx(a,t,n,i,s,o,0),void Xx(l,t,n,i,s,o,0)}e=e.next}a=a.next}while(a!==e)}function Kx(e,t){let n=e.x-t.x;if(0===n&&(n=e.y-t.y,0===n)){n=(e.next.y-e.y)/(e.next.x-e.x)-(t.next.y-t.y)/(t.next.x-t.x)}return n}function eb(e,t){const n=function(e,t){let n=t;const i=e.x,s=e.y;let o,a=-1/0;if(lb(e,n))return n;do{if(lb(e,n.next))return n.next;if(s<=n.y&&s>=n.next.y&&n.next.y!==n.y){const e=n.x+(s-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(e<=i&&e>a&&(a=e,o=n.x<n.next.x?n:n.next,e===i))return o}n=n.next}while(n!==t);if(!o)return null;const l=o,h=o.x,c=o.y;let u=1/0;n=o;do{if(i>=n.x&&n.x>=h&&i!==n.x&&ib(s<c?i:a,s,h,c,s<c?a:i,s,n.x,n.y)){const t=Math.abs(s-n.y)/(i-n.x);fb(n,e)&&(t<u||t===u&&(n.x>o.x||n.x===o.x&&tb(o,n)))&&(o=n,u=t)}n=n.next}while(n!==l);return o}(e,t);if(!n)return t;const i=db(n,e);return Zx(i,i.next),Zx(n,n.next)}function tb(e,t){return ab(e.prev,e,t.prev)<0&&ab(t.next,e,e.next)<0}function nb(e,t,n,i,s){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*s|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*s|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function rb(e){let t=e,n=e;do{(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next}while(t!==e);return n}function ib(e,t,n,i,s,o,a,l){return(s-a)*(t-l)>=(e-a)*(o-l)&&(e-a)*(i-l)>=(n-a)*(t-l)&&(n-a)*(o-l)>=(s-a)*(i-l)}function sb(e,t,n,i,s,o,a,l){return!(e===a&&t===l)&&ib(e,t,n,i,s,o,a,l)}function ob(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){let n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&hb(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&(fb(e,t)&&fb(t,e)&&function(e,t){let n=e,i=!1;const s=(e.x+t.x)/2,o=(e.y+t.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&s<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==e);return i}(e,t)&&(ab(e.prev,e,t.prev)||ab(e,t.prev,t))||lb(e,t)&&ab(e.prev,e,e.next)>0&&ab(t.prev,t,t.next)>0)}function ab(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function lb(e,t){return e.x===t.x&&e.y===t.y}function hb(e,t,n,i){const s=ub(ab(e,t,n)),o=ub(ab(e,t,i)),a=ub(ab(n,i,e)),l=ub(ab(n,i,t));return s!==o&&a!==l||(!(0!==s||!cb(e,n,t))||(!(0!==o||!cb(e,i,t))||(!(0!==a||!cb(n,e,i))||!(0!==l||!cb(n,t,i)))))}function cb(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function ub(e){return e>0?1:e<0?-1:0}function fb(e,t){return ab(e.prev,e,e.next)<0?ab(e,t,e.next)>=0&&ab(e,e.prev,t)>=0:ab(e,t,e.prev)<0||ab(e,e.next,t)<0}function db(e,t){const n=mb(e.i,e.x,e.y),i=mb(t.i,t.x,t.y),s=e.next,o=t.prev;return e.next=t,t.prev=e,n.next=s,s.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function pb(e,t,n,i){const s=mb(e,t,n);return i?(s.next=i.next,s.prev=i,i.next.prev=s,i.next=s):(s.prev=s,s.next=s),s}function gb(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function mb(e,t,n){return{i:e,x:t,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Ab(e){const t=[],n=[],i=e[0][0].length;let s=0,o=0;for(const a of e){for(const e of a)for(let n=0;n<i;n++)t.push(e[n]);o&&(s+=o,n.push(s)),o=a.length}return{vertices:t,holes:n,dimensions:i}}function yb(e){let t;return Array.isArray(e)||e instanceof Float32Array?t="float32":e instanceof Uint32Array?t="uint32":e instanceof Int32Array?t="sint32":e instanceof Uint16Array?t="uint16":e instanceof Int16Array?t="sint16":e instanceof Uint8Array?t="uint8":e instanceof Int8Array&&(t="sint8"),t}const _b={5120:{name:"sint8",bytes:1},5122:{name:"sint16",bytes:2},5124:{name:"sint32",bytes:4},5121:{name:"uint8",bytes:1},5123:{name:"uint16",bytes:2},5125:{name:"uint32",bytes:4},5126:{name:"float32",bytes:4}};function vb(e,t){const n=_b[e].name;return t>1?n+"x"+t:n}const xb={mat2x3f:{pad:[3,1]},mat2x3h:{pad:[3,1]},mat3x3f:{pad:[3,1]},mat3x3h:{pad:[3,1]},mat4x3f:{pad:[3,1]},mat4x3h:{pad:[3,1]},mat3x4f:{pad:[3,1]},mat3x4h:{pad:[3,1]}};function bb(e,t){return 0===t?e:Math.ceil(e/t)*t}const wb=[],Tb={5120:"int8",5122:"int16",5124:"int32",5121:"uint8",5123:"uint16",5125:"uint32",5126:"float"},Sb={5120:1,5122:2,5124:4,5121:1,5123:2,5125:4,5126:4},Mb={positionSize:3,primitive:"triangles",positionAttribute:"aPosition",normalAttribute:"aNormal",uv0Attribute:"aTexCoord",uv1Attribute:"aTexCoord1",color0Attribute:"aColor0",tangentAttribute:"aTangent",pickingIdAttribute:"aPickingId",textureCoordMatrixAttribute:"aTextureCoordMatrix"};let Cb=1;const Pb="_reshader_refCount";class Geometry{static createElementBuffer(e,t){if(e.wgpu){if(Array.isArray(t)){t=new(Db(t))(t)}return Lb(e,t,GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST,"index buffer")}return e.elements(t)}static createBuffer(e,t,n){return e.wgpu?Lb(e,t,GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,n):e.buffer(t)}static padGPUBufferAlignment(e,t){const n=e.byteLength/t;if(n%4==0)return e;const i=e.constructor,s=e.length/t,o=Fb(s,n/s),a=new i(o*t);for(let n=0;n<t;n++)for(let t=0;t<s;t++)a[n*o+t]=e[n*s+t];return a}constructor(e,t,n,i){this._version=0,this.data=e,this.elements=t,this.desc=px({},Mb,i),this.semantic=function(e){const t={};for(const n in Mb)n.endsWith("Attribute")&&(t[e[n]]=Mb[n]);return t}(this.desc);const s=this._getPosAttribute();this.data[this.desc.positionAttribute]=s,n||(this.elements?n=Ib(this.elements):s&&s.length?n=s.length/this.desc.positionSize:s&&s.interleavedArray?n=s.interleavedArray.length/this.desc.positionSize:s&&s.array&&(n=s.array.length/this.desc.positionSize)),this.count=n,this.elements||(this.elements=n),this._isIndexed=!mx(this.elements),this.properties={},this._buffers={},this._vao={},this.getVertexCount(),this._prepareData(!0),this.updateBoundingBox()}set version(e){throw new Error("Geometry.version is read only.")}get version(){return this._version}_getPosAttribute(){return this.data[this.desc.positionAttribute]}_prepareData(e){if(!this.data)return;const t=this._buffers||{};for(const n in this.data){const i=this.data[n];if(i)if(i.buffer&&i.buffer.destroy){const t=i.buffer;t[Pb]||(t[Pb]=0),e&&t[Pb]++}else if(i&&i.array)if(Px(i)){let e=i.array.buffer.__id;e||(e=i.array.buffer.__id=Cb++),this.data[n]={buffer:e,offset:i.byteOffset,stride:i.byteStride,type:Tb[i.componentType],size:i.itemSize,count:i.count,componentType:i.componentType},t[e]||(t[e]={data:i.array.buffer})}else this.data[n]=i.array}this._buffers=t;const n=this.elements;n&&n.array&&(this.elements=n.array)}getBuffer(e){return this.data[e]&&this.data[e].buffer}getAttrData(e){const t=e.key,n=!this._reglData||!this._reglData[t];if(this._reglData||(this._reglData={}),n){const e=this._reglData[t]={},n=this.data,{positionAttribute:i,normalAttribute:s,uv0Attribute:o,uv1Attribute:a,tangentAttribute:l,color0Attribute:h,pickingIdAttribute:c,textureCoordMatrixAttribute:u}=this.desc;px(e,this.data),e.aPosition=n[i],n[s]&&(e.aNormal=n[s]),n[o]&&(e.aTexCoord=n[o]),n[a]&&(e.aTexCoord1=n[a]),n[l]&&(e.aTangent=n[l]),n[h]&&(e.aColor0=n[h]),n[c]&&(e.aPickingId=n[c]),n[u]&&(e.aTextureCoordMatrix=n[u])}return this._reglData[t]}getREGLData(e,t,n){if(this.getAttrData(t),bx(e)&&!n){const n=t&&t.key||"default";if(!this._vao[n]||(!this._reglData||!this._reglData[t.key])||this._vao[n].dirty){const i=this._reglData[t.key],s=this._vertexCount,o=[];for(let e=0;e<t.length;e++){const n=t[e].name,a=i[n]&&i[n].buffer;if(a&&a.destroy)o.push(void 0!==i[n].stride?i[n]:a);else{const e=i[n];if(!e){o.push(this.desc.fillEmptyDataInMissingAttribute?new Uint8Array(4*s):wb);continue}const t=(e.data&&yx(e.data)?e.data.length:e.length)/s;e.data?(e.dimension=t,o.push(e)):o.push({data:e,dimension:t})}}const a={attributes:o,primitive:this.getPrimitive()};if(this.elements&&!mx(this.elements))if(this.elements.destroy)a.elements=this.elements;else{a.elements={primitive:this.getPrimitive(),data:this.elements};const e=this.getElementsType(this.elements);e&&(a.elements.type=e)}this._vao[n]?this._vao[n].vao(a):this._vao[n]={vao:e.vao(a)}}return delete this._vao[n].dirty,this._vao[n]}return this._reglData[t.key]}_isAttrChanged(e){if(e===this._activeAttributes)return!1;if(e.length!==this._activeAttributes.length)return!0;for(let t=0;t<e.length;t++)if(e[t]!==this._activeAttributes[t])return!0;return!1}generateBuffers(e){const t=!!e.wgpu,n=this._buffers;for(const t in n)n[t].buffer||(n[t].buffer=Geometry.createBuffer(e,n[t].data,t)),delete n[t].data;const i=this.desc.positionAttribute,s=this.desc.altitudeAttribute,o=this.data,a=this._vertexCount,l={};for(const h in o)if(o[h]){if(Array.isArray(o[h])?o[h]=new Float32Array(o[h]):t&&yx(o[h])&&(o[h]=Geometry.padGPUBufferAlignment(o[h],a)),void 0===o[h].buffer||o[h].buffer instanceof ArrayBuffer){const t=o[h].data?o[h]:{data:o[h]};t.dimension=(o[h].data?o[h].data:o[h]).length/a;const n=Geometry.createBuffer(e,t,h);n[Pb]=1,l[h]={buffer:n},h!==i&&h!==s||(l[h].array=o[h])}else o[h].buffer.destroy?l[h]=o[h]:n[o[h].buffer]&&(l[h]=px({},o[h]),l[h].buffer=n[o[h].buffer].buffer);(this.desc.static||h!==i)&&delete o[h].array}if(this.data=l,delete this._reglData,this.elements&&!mx(this.elements)){if(this.getPrimitive(),this.getElementsType(this.elements),!this.desc.static&&!this.elements.destroy){const e=this.elements;let t;t=Array.isArray(this.elements)?Db(this.elements):this.elements.constructor,this.indices=new t(e.length);for(let t=0;t<e.length;t++)this.indices[t]=e[t]}this.elements=this.elements.destroy?this.elements:Geometry.createElementBuffer(e,this.elements);const t=this.elements;t[Pb]||(t[Pb]=0),t[Pb]++}}getVertexCount(){const{positionAttribute:e,positionSize:t,color0Attribute:n}=this.desc;let i=this.data[e];i.data&&(i=i.data),i.array&&(i=i.array),yx(i)?this._vertexCount=Math.ceil(i.length/t):i&&void 0!==i.count&&(this._vertexCount=i.count);const s=n;if(this.data[s]){const e=this.data[s].data||this.data[s].array||this.data[s];Array.isArray(e)?this._color0Size=e.length/this._vertexCount:this.data[s].buffer&&this.data[s].buffer.destroy?this._color0Size=this.data[s].buffer._buffer.dimension:e&&e.itemSize&&(this._color0Size=e.itemSize)}return this._vertexCount}getColor0Size(){return this._color0Size||0}deleteData(e){const t=this.data[e];return t?(this._incrVersion(),t.buffer&&t.buffer.destroy&&t.buffer.destroy(),delete this.data[e],delete this._reglData,this._markVAODirty(!1),this):this}updateData(e,t){const n=this.data[e];if(!n)return this;let i;return this._incrVersion(),this.data[e]=t,n.buffer&&n.buffer.destroy&&(i=n),e===this.desc.positionAttribute&&this.updateBoundingBox(),this.getVertexCount(),i&&(i.buffer.mapState?i.buffer=this._updateGPUBuffer(i.buffer,t):i.buffer(t),this.data[e]=i),this._prepareData(!1),this.desc.positionAttribute===e&&(this._posDirty=!0),delete this._reglData,this}_updateGPUBuffer(e,t){Array.isArray(t)&&(t=new Float32Array(t));const n=e.device;if(t.buffer.byteLength>e.size){const i=Lb(n,t,e.usage,e.label);return delete e.device,e.destroy(),i}return n.wgpu.queue.writeBuffer(e,0,t.buffer,0,t.buffer.byteLength),e}updateSubData(e,t,n){const i=this.data[e];if(!i)return this;let s;if(this._incrVersion(),i.buffer&&i.buffer.destroy&&(s=i),e===this.desc.positionAttribute&&this._updateSubBoundingBox(t),s){const e=Sb[s.buffer._buffer.dtype];if(t.BYTES_PER_ELEMENT!==e){const n=function(e,t){if(e instanceof Uint8Array||e instanceof Uint16Array||e instanceof Uint32Array||e instanceof Uint8ClampedArray)return 1===t?Uint8Array:2===t?Uint16Array:Uint32Array;if(e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array)return 1===t?Int8Array:2===t?Int16Array:Int32Array;if(e instanceof Float32Array||e instanceof Float64Array)return 4===t?Float32Array:Float64Array;return null}(t,e);t=new n(t)}s.buffer.subdata(t,n*e)}else{const i=this.data[e].data?this.data[e].data:this.data[e];for(let e=0;e<t.length;e++)i[n+e]=t[e]}return this._prepareData(!1),this.desc.positionAttribute===e&&(this._posDirty=!0),delete this._reglData,this}getPrimitive(){return this.desc.primitive}getElements(){return this.elements}setElements(e,t){if(!e)throw new Error("elements data is invalid");this._incrVersion();const n=this.elements;if(this.count=void 0===t?Ib(e):t,e&&e.destroy)this.elements=e;else if(n.destroy)if(n.mapState){if(Array.isArray(e)){e=new(Db(e))(e)}this.elements=this._updateGPUBuffer(n,e)}else this.elements=n(e);else this.elements=e;return this._markVAODirty(!0),this._isIndexed=!mx(e),this}isIndexedElements(){return this._isIndexed}deleteElements(){return this.elements&&0!==this.elements.length?(this._incrVersion(),this.elements&&this.elements.destroy&&!this.elements[Nx]&&(this.elements.destroy(),this.elements[Nx]=1),this.elements=[],this._markVAODirty(!0),this):this}_markVAODirty(e){if(this._vao){for(const t in this._vao)e?this._vao[t].vao.destroy():this._vao[t].dirty=!0;e&&(this._vao={})}}setDrawCount(e){return this._incrVersion(),this.count1=e,this}getDrawCount(){return this.count1>=0?this.count1:this.count}setDrawOffset(e){return this._incrVersion(),this.offset=e,this}getDrawOffset(){return this.offset||0}dispose(){if(this._deleteVAO(),this._forEachBuffer((e=>{if(!e[Nx]){let t=e[Pb];t&&t--,t<=0?(e[Nx]=!0,e.destroy()):e[Pb]=t}})),this.properties){const e=this.properties.oldElementsBeforeHighlight;e&&!e[Nx]&&e.destroy&&(e.destroy(),e[Nx]=!0),delete this.properties.oldElementsBeforeHighlight,delete this.properties.hasInvisible}this.data={},this._buffers={},delete this._reglData,this.count=0,this.elements=[],delete this._tempPosArray,this._disposed=!0}_deleteVAO(){for(const e in this._vao)this._vao[e].vao.destroy();this._vao={}}isDisposed(){return!!this._disposed}updateBoundingBox(){let e=this.boundingBox;e||(e=this.boundingBox=new BoundingBox);let t,n,i=this.data[this.desc.positionAttribute];if(yx(i)||(i.data?i=i.data:Ix(i)?i=this._getAttributeData(this.desc.positionAttribute):i.array&&(t=i.min,n=i.max,i=i.array)),i&&i.length){const s=e.min,o=e.max;if(t&&n)ZA(s,...t),ZA(o,...n);else{ZA(s,i[0],i[1],i[2]),ZA(o,i[0],i[1],i[2]);for(let e=3;e<i.length;){const t=i[e++],n=i[e++],a=i[e++];t<s[0]&&(s[0]=t),n<s[1]&&(s[1]=n),a<s[2]&&(s[2]=a),t>o[0]&&(o[0]=t),n>o[1]&&(o[1]=n),a>o[2]&&(o[2]=a)}}e.updateVertex(),e.dirty()}}_updateSubBoundingBox(e){const t=this.boundingBox,n=t.min,i=t.max,s=this.desc.positionSize;for(let t=0;t<e.length;){const o=e[t++],a=e[t++];let l=0;3===s&&(l=e[t++]),o<n[0]&&(n[0]=o),a<n[1]&&(n[1]=a),l<n[2]&&(n[2]=l),o>i[0]&&(i[0]=o),a>i[1]&&(i[1]=a),l>i[2]&&(i[2]=l)}t.updateVertex(),t.dirty()}_getAttributeData(e){const t=hx(),n=this.data[e]&&this.data[e].array?this.data[e].array:this.data[e],i=n.buffer;if(Ix(n)){const s=this._buffers[i]?this._buffers[i].data:n.array,{count:o,size:a,stride:l,offset:h,componentType:c}=n,u=t.GLTFLoader.getTypedArrayCtor(c);if((0===l||l===a*u.BYTES_PER_ELEMENT)&&h%u.BYTES_PER_ELEMENT==0)return new u(s,h,o*a);if(e===this.desc.positionAttribute)return!this._tempPosArray||this._tempPosArray&&this._tempPosArray.length<a*o?(this._tempPosArray=new u(a*o),t.GLTFLoader.readInterleavedArray(this._tempPosArray,s,o,a,l,h,c)):this._posDirty?(this._posDirty=!1,t.GLTFLoader.readInterleavedArray(this._tempPosArray,s,o,a,l,h,c)):this._tempPosArray;{const e=new u(a*o);return t.GLTFLoader.readInterleavedArray(e,s,o,a,l,h,c)}}return n}createTangent(e="aTangent"){this._incrVersion();const{normalAttribute:t,positionAttribute:n,uv0Attribute:i}=this.desc,s=this._getAttributeData(t),o=zv(this._getAttributeData(n),s,this.data[i],this.elements),a=this.data[e]=new Float32Array(o.length),l=[0,0,0,0],h=[0,0,0],c=[0,0,0,0];for(let e=0;e<o.length;e+=4){const t=e/4*3;ZA(h,s[t],s[t+1],s[t+2]),Sy(l,o[e],o[e+1],o[e+2],o[e+3]),Iv(c,h,l),Ty(a.subarray(e,e+4),c)}delete this._reglData}createNormal(e="aNormal"){this._incrVersion();const t=this._getAttributeData(this.desc.positionAttribute);this.data[e]=Ov(t.array||t,this.elements),delete this._reglData}createBarycentric(e="aBarycentric"){if("triangles"!==this.desc.primitive)throw new Error("Primitive must be triangles to create bary centric data");this._incrVersion();const t=new Uint8Array(3*this._vertexCount);for(let e=0,n=this.elements.length;e<n;)for(let n=0;n<3;n++){t[3*this.elements[e++]+n]=1}this.data[e]=t,delete this._reglData}buildUniqueVertex(){this._incrVersion();const e=this.data,t=this.elements;if(!yx(t))throw new Error("elements must be array to build unique vertex.");const n=Object.keys(e),i={};let s=e[this.desc.positionAttribute];if(s=s.length?s:s.array,!yx(s))throw new Error(this.desc.positionAttribute+" must be array to build unique vertex.");const o=this._vertexCount,a=t.length;for(let t=0;t<n.length;t++){const s=n[t],l=yx(e[s])?e[s]:e[s].array,h=l.length/o;if(!yx(l))throw new Error(s+" must be array to build unique vertex.");i[s]=l;const c=_x(l);e[s]=new c(a*h)}let l=0;for(let s=0;s<a;s++){const a=t[s];for(let t=0;t<n.length;t++){const s=n[t],h=e[s],c=i[s].length/o;for(let e=0;e<c;e++)h[l*c+e]=i[s][a*c+e]}t[s]=l++}s=this.data[this.desc.positionAttribute],this._vertexCount=Math.ceil(s.length/this.desc.positionSize),delete this._reglData}getMemorySize(){let e=0;for(const t in this.data)wx(this.data,t)&&(e+=Tx(this.data[t]));if(this.elements){const t=this.elements;t.destroy?e+=t._elements?t._elements.buffer.byteLength:t.size:t.BYTES_PER_ELEMENT?e+=t.length*t.BYTES_PER_ELEMENT:t.length&&(e+=4*t.length)}return e}_forEachBuffer(e){this.elements&&this.elements.destroy&&e(this.elements);for(const t in this.data)wx(this.data,t)&&this.data[t]&&this.data[t].buffer&&this.data[t].buffer.destroy&&e(this.data[t].buffer);for(const t in this._buffers)wx(this._buffers,t)&&this._buffers[t]&&this._buffers[t].buffer&&this._buffers[t].buffer.destroy&&e(this._buffers[t].buffer)}getElementsType(e){return e instanceof Uint8Array?"uint8":e instanceof Uint16Array?"uint16":e instanceof Uint32Array?"uint32":void 0}_incrVersion(){this._version++}getCommandKey(e){if(e&&e.wgpu){const e=[];for(const t in this.data){const n=this.data[t];e.push(n.byteStride?`${t}(${n.byteOffset}/${n.byteStride}})`:t)}return e.sort().join("-")}return""}getBufferDescriptor(e){const t=[];for(const n in e){const i=e[n];t[i.location]=i}const n=this.data,i=[],s={};for(let o=0;o<t.length;o++){if(!t[o])continue;const a=t[o].geoAttrName,l=n[a];if(!l)continue;const h=e[this.semantic[a]||a];if(!h)continue;const c=l.accessorName,u=l.byteStride;if(u&&c){const e=vb(l.componentType,l.itemSize);let t=s[c];t?t.attributes.push({shaderLocation:h.location,format:e,offset:l.byteOffset}):(t={arrayStride:u,attributes:[{shaderLocation:h.location,format:e,offset:l.byteOffset}]},s[c]=t,i[o]=t)}else{const e=kb(l,h);i[o]=e}}return i}}function Ib(e){if(mx(e))return e;if(void 0!==e.count)return e.count;if(e.destroy)return e._elements?e._elements.vertCount:e.itemCount;if(void 0!==e.length)return e.length;if(e.data)return e.data.length;throw new Error("invalid elements length")}function kb(e,t){const n=e.data||e.array||e;let i=t.itemSize;if(e.buffer&&!yx(e)){const n=e.buffer.bytesPerElement;i=Fb(i,n);const s=Eb(e,i);return{arrayStride:i*n,attributes:[{shaderLocation:t.location,format:s,offset:0}]}}if(yx(n)){let s,o;return e.componentType?(s=vb(e.componentType,e.itemSize),o=_b[e.componentType].bytes):(s=Eb(n,i),o=Ob(n)),i=Fb(i,o),{arrayStride:i*o,attributes:[{shaderLocation:t.location,format:s,offset:0}]}}}function Ob(e){const t=Rb(e);if(t.destroy)return t.bytesPerElement;if(t.BYTES_PER_ELEMENT)return t.BYTES_PER_ELEMENT;if(Array.isArray(t))return 4;{const e=t;return hx().GLTFLoader.getTypedArrayCtor(e.componentType).BYTES_PER_ELEMENT}}function Eb(e,t){const n=Rb(e);let i;return i=n.destroy?n.itemType:yb(n),t>1?i+"x"+t:i}function Rb(e){return e.data||e.buffer.destroy&&e.buffer||e}function Lb(e,t,n,i){t=t.data||t,Array.isArray(t[0])&&(t=Ab(t)),Array.isArray(t)&&(t=new Float32Array(t));const s=t.constructor,o=bb(t.byteLength,4),a=e.wgpu.createBuffer({label:i,size:o,usage:n,mappedAtCreation:!0});return a.device=e,new s(a.getMappedRange()).set(t),a.unmap(),a.itemCount=t.length,a.itemType=yb(t),a.bytesPerElement=Ob(t),a}function Db(e){let t=-1/0;for(let n=0;n<e.length;n++)e[n]>t&&(t=e[n]);return function(e){return e<65536?Uint16Array:Uint32Array}(t)}function Fb(e,t){const n=e*t;return n%4==0?e:e+(4-n%4)/t}const Hb=["points","lines","line strip","line loop","triangles","triangle strip","triangle fan"];function Nb(e){return Hb[e]}const Bb={5121:"uint8",5123:"uint16",5125:"uint32",5126:"float",36193:"half float"};function zb(e){return Bb[e]}function Gb(e){return e instanceof Uint8Array?"uint8":e instanceof Int8Array?"int8":e instanceof Uint16Array?"uint16":e instanceof Int16Array?"int16":"float"}const Ub={6406:"alpha",6407:"rgb",6408:"rgba",6409:"luminance",6410:"luminance alpha",33776:"rgb s3tc dxt1",33777:"rgba s3tc dxt1",33778:"rgba s3tc dxt3",33779:"rgba s3tc dxt5",35840:"rgb pvrtc 4bppv1",35841:"rgb pvrtc 2bppv1",35842:"rgba pvrtc 4bppv1",35843:"rgba pvrtc 2bppv1",35986:"rgb atc",35987:"rgba atc explicit alpha",34798:"rgba atc interpolated alpha",36196:"rgb etc1",37492:"rgb etc2"};function Vb(e){return Ub[e]}const jb={9729:"linear",9728:"nearest"};function Wb(e){return jb[e]}const qb={9729:"linear",9728:"nearest",9984:"nearest mipmap nearest",9985:"linear mipmap nearest",9986:"nearest mipmap linear",9987:"linear mipmap linear"};function Zb(e){return qb[e]}const Xb={10497:"repeat",33071:"clamp",33648:"mirror"};function Yb(e){return Xb[e]}const Jb="__reshader_webgl_buffer",Qb="__reshader_webgl_tex";function $b(e,t,n){let i;if(yx(t)?t.buffer&&void 0!==t.byteOffset&&(i=t):t.array&&t.array.buffer&&void 0!==t.array.byteOffset&&(i=t.array),!i)return null;const s=i.buffer,o=i.byteOffset;s[Jb]||(s[Jb]={});let a=s[Jb][o];if(!a){const t={};n&&px(t,n),t.data=i,t.type||(t.type=Gb(i)),a=e.buffer(t),s[Jb][o]=a}return a}function Kb(e,t){const n=t.data;if(!n||!n.buffer)return e.texture(t);const i=n.buffer,s=n.byteOffset;i[Qb]||(i[Qb]={});let o=i[Qb][s];return o||(o=e.texture(t),i[Qb][s]=o),o}var ew=Object.freeze({__proto__:null,getArrayType:Gb,getMaterialFormat:Vb,getMaterialType:zb,getPrimitive:Nb,getTextureMagFilter:Wb,getTextureMinFilter:Zb,getTextureWrap:Yb,getUniqueREGLBuffer:$b,getUniqueTexture:Kb});const tw=[0,0,0],nw=[0,0,0],rw=[0,0,0],iw=[],sw=[],ow=[],aw=["a","b","c"];class EdgeGeometry extends Geometry{constructor(e,t,n,i){super(e,t,n,{primitive:Nb(1),positionAttribute:i.positionAttribute})}_getPosAttribute(){const e=this.data[this.desc.positionAttribute];if(!e.length)return[];const t=Math.pow(10,4),n=Math.cos(Math.PI/180*.8),i=this.elements,s=e.length?e:e.array,o=i.length?i?i.length:s.length/3:i,a=[0,0,0],l=new Array(3),h={},c=[],u=new Triangle;for(let e=0;e<o;e+=3){i.length?(a[0]=i[e],a[1]=i[e+1],a[2]=i[e+2]):(a[0]=e,a[1]=e+1,a[2]=e+2),u.a=lw(iw,s,a[0]),u.b=lw(sw,s,a[1]),u.c=lw(ow,s,a[2]);const o=u.getNormal(),f=u.a,g=u.b,m=u.c;if(l[0]=`${Math.round(f[0]*t)},${Math.round(f[1]*t)},${Math.round(f[2]*t)}`,l[1]=`${Math.round(g[0]*t)},${Math.round(g[1]*t)},${Math.round(g[2]*t)}`,l[2]=`${Math.round(m[0]*t)},${Math.round(m[1]*t)},${Math.round(m[2]*t)}`,l[0]!==l[1]&&l[1]!==l[2]&&l[2]!==l[0])for(let e=0;e<3;e++)this._calEdgeData(e,a,u,h,l,n,o,c)}for(const e in h)if(h[e]){const{index0:t,index1:n}=h[e];c.push(s[3*t],s[3*t+1],s[3*t+2]),c.push(s[3*n],s[3*n+1],s[3*n+2])}return this.elements=this._createElements(c),c}_calEdgeData(e,t,n,i,s,o,a,l){const h=(e+1)%3,c=s[e],u=s[h],f=n[aw[e]],g=n[aw[h]],m=`${c}_${u}`,A=`${u}_${c}`;if(A in i&&i[A]){iy(a,i[A].normal)<=o&&(l.push(f[0],f[1],f[2]),l.push(g[0],g[1],g[2])),i[A]=null}else m in i||(i[m]={index0:t[e],index1:t[h],normal:qA([0,0,0],a)})}_createElements(e){const t=[],n=e.length/3;for(let e=0;e<n;e++)t.push(e);return t}}class Triangle{constructor(e=[0,0,0],t=[0,0,0],n=[0,0,0]){this.a=e,this.b=t,this.c=n}getNormal(){const e=fy(tw,this.a,this.b),t=fy(nw,this.a,this.c);sy(rw,e,t);const n=jA(rw);return ZA(rw,rw[0]/n,rw[1]/n,rw[2]/n)}}function lw(e,t,n){return ZA(e,t[3*n],t[3*n+1],t[3*n+2])}class Base{}class Material extends(Hx(Base)){constructor(e={},t){super(),this._version=0,this._propVerion=0,this.uniforms=gx({},t||{},e);for(const t in e){const n=Object.getOwnPropertyDescriptor(e,t).get;n&&Object.defineProperty(this.uniforms,t,{get:n})}this.unlit=!1,this._reglUniforms={},this.refCount=0,this._bindedOnTextureComplete=(...e)=>this._onTextureComplete.call(this,...e),this._genUniformKeys(),this._checkTextures()}set version(e){throw new Error("Material.version is read only.")}get version(){return this._version}get propVersion(){return this._propVerion}set doubleSided(e){this.uniforms.doubleSided=e}get doubleSided(){return!!this.uniforms.doubleSided}getUniforms(e){if(this._reglUniforms&&!this.isDirty())return this._reglUniforms;const t=this.uniforms,n={};for(const i in t)if(this.isTexture(i))Object.defineProperty(n,i,{enumerable:!0,configurable:!0,get:function(){return t[i].getREGLTexture(e)}});else{Object.getOwnPropertyDescriptor(t,i).get?Object.defineProperty(n,i,{enumerable:!0,configurable:!0,get:function(){return t[i]}}):n[i]=t[i]}return this._reglUniforms=n,this._uniformVer=this.version,n}getMemorySize(){const e=this.uniforms;let t=0;for(const n in e)this.isTexture(n)?t+=e[n].getMemorySize():this.uniforms[n]&&this.uniforms[n].destroy&&(t+=Sx(this.uniforms[n]));return t}isReady(){return this._loadingCount<=0}hasUniform(e){return Object.prototype.hasOwnProperty.call(this.uniforms,e)}setUniform(e,t){return this.set(e,t)}getUniform(e){return this.get(e)}set(e,t,n=!0){if(this.get(e)===t)return this;const i=ux(this.uniforms[e])&&!ux(t)||!ux(this.uniforms[e])&&ux(t);if(this.uniforms[e]&&this.isTexture(e)&&n&&this.uniforms[e].dispose(),ux(t))ux(this.uniforms[e])||delete this.uniforms[e];else if(this.uniforms[e]=t,this._reglUniforms){const n=Object.getOwnPropertyDescriptor(this._reglUniforms,e);n&&!n.get&&(this._propVerion++,this._reglUniforms[e]=t)}return this.isTexture(e)&&this._checkTextures(),i&&(this._genUniformKeys(),this._incrVersion()),this}setFunctionUniform(e,t){return this._genUniformKeys(),this._incrVersion(),Object.defineProperty(this.uniforms,e,{enumerable:!0,get:t}),this}hasFunctionUniform(e){return!!this.uniforms&&Object.prototype.hasOwnProperty.call(this.uniforms,e)}get(e){return this.uniforms[e]}isDirty(){return this._uniformVer!==this.version}appendDefines(e,t){const n=this.uniforms;return n?(n.jointTexture&&(e.HAS_SKIN=1),n.morphWeights1&&(e.HAS_MORPH=1),(n.khr_offset||n.khr_rotation||n.khr_scale)&&(e.HAS_KHR_TEXTURE_TRANSFORM=1),e):e}hasSkinAnimation(){return!!(this.uniforms&&this.uniforms.jointTexture&&this.uniforms.skinAnimation)}isTexture(e){return this.uniforms[e]instanceof AbstractTexture}dispose(){for(const e in this.uniforms){const t=this.uniforms[e];t&&(t.dispose?t.dispose():t.destroy&&!t[Nx]&&(t.destroy(),t[Nx]=!0))}delete this.uniforms,delete this._reglUniforms,delete this._bindedOnTextureComplete,this._disposed=!0}isDisposed(){return!!this._disposed}_checkTextures(){this._loadingCount=0;for(const e in this.uniforms)if(this.isTexture(e)){const t=this.uniforms[e];t.isReady()||(this._loadingCount++,t.on("complete",this._bindedOnTextureComplete))}}_onTextureComplete(){this._loadingCount--,this._incrVersion(),this._loadingCount<=0&&(this._disposed||this.fire("complete"))}getUniformKeys(){return this._uniformKeys}_genUniformKeys(){const e=[];for(const t in this.uniforms)wx(this.uniforms,t)&&!ux(this.uniforms[t])&&e.push(t);this._uniformKeys=e.join()}_incrVersion(){this._version++}}const hw={time:0,seeThrough:!0,thickness:.03,fill:[1,.5137254902,.98,1],stroke:[.7019607843,.9333333333,.2274509804,1],dashEnabled:!1,dashAnimate:!1,dashRepeats:1,dashLength:.8,dashOverlap:!0,insideAltColor:!1,squeeze:!1,squeezeMin:.5,squeezeMax:1,dualStroke:!1,secondThickness:.05,opacity:1,noiseEnable:!1};const cw={baseColorFactor:[1,1,1,1],materialShininess:32,environmentExposure:1,specularStrength:32,opacity:1,extrusionOpacity:0,extrusionOpacityRange:[0,1.8],baseColorTexture:null,normalTexture:null,emissiveTexture:null,occlusionTexture:null,uvScale:[1,1],uvOffset:[0,0],alphaTest:0};class PhongMaterial extends Material{constructor(e){super(e,cw)}static convertFrom(e){const t={};for(const n in cw)t[n]=e.get(n);return new PhongMaterial(t)}appendDefines(e,t){super.appendDefines(e,t);const n=this.uniforms;this.unlit&&(e.SHADING_MODEL_UNLIT=1),n.extrusionOpacity&&(e.HAS_EXTRUSION_OPACITY=1),t.data[t.desc.colorAttribute]&&(e.HAS_COLOR=1);return t.data[t.desc.color0Attribute]&&(e.HAS_COLOR0=1,e.COLOR0_SIZE=t.getColor0Size()),t.data.aVertexColorType&&(e.HAS_VERTEX_COLOR=1),t.data[t.desc.tangentAttribute]?e.HAS_TANGENT=1:t.data[t.desc.normalAttribute]&&(e.HAS_NORMAL=1),t.data[t.desc.uv0Attribute]?(n.baseColorTexture&&(e.HAS_BASECOLOR_MAP=1),n.occlusionTexture&&t.data[t.desc.uv1Attribute]&&(e.HAS_AO_MAP=1),n.emissiveTexture&&(e.HAS_EMISSIVE_MAP=1),n.normalTexture&&(e.HAS_NORMAL_MAP=1),(e.HAS_BASECOLOR_MAP||e.HAS_AO_MAP||e.HAS_EMISSIVE_MAP||e.HAS_NORMAL_MAP)&&(e.HAS_MAP=1),e):e}}const uw={baseColorFactor:[1,1,1,1],uvScale:[1,1],uvOffset:[0,0],opacity:1,envMapExposure:128,emissiveFactor:[.1,.1,.1],specularFactor:[0,0,0],envRotationSin:0,envRotationCos:1,reflectivity:.01,themingColor:[0,0,0,0],exposureBias:.6};const fw={diffuseFactor:[1,1,1,1],specularFactor:[1,1,1],glossinessFactor:1,diffuseTexture:null,specularGlossinessTexture:null,normalTexture:null,emissiveTexture:null,occlusionTexture:null};function dw(e){return class SpecularGlossinessMixin extends e{constructor(...e){let t=e[0];t=px({},fw,t||{}),super(t,e)}appendDefines(e,t){if(super.appendDefines(e,t),e.SHADING_MODEL_SPECULAR_GLOSSINESS=1,!t.data[t.desc.uv0Attribute])return e;const n=this.uniforms;return n.diffuseTexture&&(e.HAS_DIFFUSE_MAP=1),n.specularGlossinessTexture&&(e.HAS_SPECULARGLOSSINESS_MAP=1),(e.HAS_SPECULARGLOSSINESS_MAP||e.HAS_DIFFUSE_MAP)&&(e.HAS_MAP=1),e}}}class PhongSpecularGlossinessMaterial extends(dw(PhongMaterial)){}class ParseContext{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class Node{constructor(){}get isAstNode(){return!0}get astNodeType(){return""}evaluate(e){throw new Error("Cannot evaluate node")}evaluateString(e){return this.evaluate(e).toString()}search(e){}searchBlock(e,t){if(e){t(_BlockStart.instance);for(const n of e)n instanceof Array?this.searchBlock(n,t):n.search(t);t(_BlockEnd.instance)}}}class _BlockStart extends Node{}_BlockStart.instance=new _BlockStart;class _BlockEnd extends Node{}_BlockEnd.instance=new _BlockEnd;class Statement extends Node{constructor(){super()}}let pw=class Function extends Statement{constructor(e,t,n,i,s,o){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=n,this.body=i,this.startLine=s,this.endLine=o}get astNodeType(){return"function"}search(e){this.searchBlock(this.body,e)}};class StaticAssert extends Statement{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class While extends Statement{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Continuing extends Statement{constructor(e){super(),this.body=e}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class For extends Statement{constructor(e,t,n,i){super(),this.init=e,this.condition=t,this.increment=n,this.body=i}get astNodeType(){return"for"}search(e){var t,n,i;null===(t=this.init)||void 0===t||t.search(e),null===(n=this.condition)||void 0===n||n.search(e),null===(i=this.increment)||void 0===i||i.search(e),this.searchBlock(this.body,e)}}class Var extends Statement{constructor(e,t,n,i,s){super(),this.name=e,this.type=t,this.storage=n,this.access=i,this.value=s}get astNodeType(){return"var"}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}class Override extends Statement{constructor(e,t,n){super(),this.name=e,this.type=t,this.value=n}get astNodeType(){return"override"}search(e){var t;null===(t=this.value)||void 0===t||t.search(e)}}class Let extends Statement{constructor(e,t,n,i,s){super(),this.name=e,this.type=t,this.storage=n,this.access=i,this.value=s}get astNodeType(){return"let"}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}class Const extends Statement{constructor(e,t,n,i,s){super(),this.name=e,this.type=t,this.storage=n,this.access=i,this.value=s}get astNodeType(){return"const"}evaluate(e){return this.value.evaluate(e)}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}var gw,mw,Aw,yw,_w;!function(e){e.increment="++",e.decrement="--"}(gw||(gw={})),function(e){e.parse=function(t){const n=t;if("parse"==n)throw new Error("Invalid value for IncrementOperator");return e[n]}}(gw||(gw={}));class Increment extends Statement{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}!function(e){e.assign="=",e.addAssign="+=",e.subtractAssin="-=",e.multiplyAssign="*=",e.divideAssign="/=",e.moduloAssign="%=",e.andAssign="&=",e.orAssign="|=",e.xorAssign="^=",e.shiftLeftAssign="<<=",e.shiftRightAssign=">>="}(mw||(mw={})),function(e){e.parse=function(e){const t=e;if("parse"==t)throw new Error("Invalid value for AssignOperator");return t}}(mw||(mw={}));class Assign extends Statement{constructor(e,t,n){super(),this.operator=e,this.variable=t,this.value=n}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class Call extends Statement{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"call"}search(e){for(const t of this.args)t.search(e);e(this)}}class Loop extends Statement{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return"loop"}}class Switch extends Statement{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"body"}}class If extends Statement{constructor(e,t,n,i){super(),this.condition=e,this.body=t,this.elseif=n,this.else=i}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class Return extends Statement{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var t;null===(t=this.value)||void 0===t||t.search(e)}}class Enable extends Statement{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class Requires extends Statement{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class Diagnostic extends Statement{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return"diagnostic"}}class Alias extends Statement{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return"alias"}}class Discard extends Statement{constructor(){super()}get astNodeType(){return"discard"}}class Break extends Statement{constructor(){super()}get astNodeType(){return"break"}}class Continue extends Statement{constructor(){super()}get astNodeType(){return"continue"}}class Type extends Statement{constructor(e){super(),this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}}class Struct extends Type{constructor(e,t,n,i){super(e),this.members=t,this.startLine=n,this.endLine=i}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}}class TemplateType extends Type{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return"template"}}class PointerType extends Type{constructor(e,t,n,i){super(e),this.storage=t,this.type=n,this.access=i}get astNodeType(){return"pointer"}}class ArrayType extends Type{constructor(e,t,n,i){super(e),this.attributes=t,this.format=n,this.count=i}get astNodeType(){return"array"}get isArray(){return!0}}class SamplerType extends Type{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return"sampler"}}class Expression extends Node{constructor(){super()}}class StringExpr extends Expression{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}evaluateString(){return this.value}}class CreateExpr extends Expression{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"createExpr"}search(e){if(e(this),this.args)for(const t of this.args)t.search(e)}evaluate(e){return this.args[0].evaluate(e)}}class CallExpr extends Expression{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"callExpr"}evaluate(e){switch(this.name){case"abs":return Math.abs(this.args[0].evaluate(e));case"acos":return Math.acos(this.args[0].evaluate(e));case"acosh":return Math.acosh(this.args[0].evaluate(e));case"asin":return Math.asin(this.args[0].evaluate(e));case"asinh":return Math.asinh(this.args[0].evaluate(e));case"atan":return Math.atan(this.args[0].evaluate(e));case"atan2":return Math.atan2(this.args[0].evaluate(e),this.args[1].evaluate(e));case"atanh":return Math.atanh(this.args[0].evaluate(e));case"ceil":return Math.ceil(this.args[0].evaluate(e));case"clamp":return Math.min(Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e)),this.args[2].evaluate(e));case"cos":return Math.cos(this.args[0].evaluate(e));case"degrees":return 180*this.args[0].evaluate(e)/Math.PI;case"distance":return Math.sqrt(Math.pow(this.args[0].evaluate(e)-this.args[1].evaluate(e),2));case"dot":case"exp":return Math.exp(this.args[0].evaluate(e));case"exp2":return Math.pow(2,this.args[0].evaluate(e));case"floor":return Math.floor(this.args[0].evaluate(e));case"fma":return this.args[0].evaluate(e)*this.args[1].evaluate(e)+this.args[2].evaluate(e);case"fract":case"modf":return this.args[0].evaluate(e)-Math.floor(this.args[0].evaluate(e));case"inverseSqrt":return 1/Math.sqrt(this.args[0].evaluate(e));case"log":return Math.log(this.args[0].evaluate(e));case"log2":return Math.log2(this.args[0].evaluate(e));case"max":return Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e));case"min":return Math.min(this.args[0].evaluate(e),this.args[1].evaluate(e));case"mix":return this.args[0].evaluate(e)*(1-this.args[2].evaluate(e))+this.args[1].evaluate(e)*this.args[2].evaluate(e);case"pow":return Math.pow(this.args[0].evaluate(e),this.args[1].evaluate(e));case"radians":return this.args[0].evaluate(e)*Math.PI/180;case"round":return Math.round(this.args[0].evaluate(e));case"sign":return Math.sign(this.args[0].evaluate(e));case"sin":return Math.sin(this.args[0].evaluate(e));case"sinh":return Math.sinh(this.args[0].evaluate(e));case"saturate":return Math.min(Math.max(this.args[0].evaluate(e),0),1);case"smoothstep":return this.args[0].evaluate(e)*this.args[0].evaluate(e)*(3-2*this.args[0].evaluate(e));case"sqrt":return Math.sqrt(this.args[0].evaluate(e));case"step":return this.args[0].evaluate(e)<this.args[1].evaluate(e)?0:1;case"tan":return Math.tan(this.args[0].evaluate(e));case"tanh":return Math.tanh(this.args[0].evaluate(e));case"trunc":return Math.trunc(this.args[0].evaluate(e));default:throw new Error("Non const function: "+this.name)}}search(e){for(const t of this.args)t.search(e);e(this)}}class VariableExpr extends Expression{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}evaluate(e){const t=e.constants.get(this.name);if(!t)throw new Error("Cannot evaluate node");return t.evaluate(e)}}class ConstExpr extends Expression{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return"constExpr"}evaluate(e){var t,n;if(this.initializer instanceof CreateExpr){const i=null===(t=this.postfix)||void 0===t?void 0:t.evaluateString(e),s=null===(n=this.initializer.type)||void 0===n?void 0:n.name,o=e.structs.get(s),a=null==o?void 0:o.getMemberIndex(i);if(void 0!==a&&-1!=a){return this.initializer.args[a].evaluate(e)}return this.initializer.evaluate(e)}return this.initializer.evaluate(e)}search(e){this.initializer.search(e)}}class LiteralExpr extends Expression{constructor(e){super(),this.value=e}get astNodeType(){return"literalExpr"}evaluate(){return this.value}}class BitcastExpr extends Expression{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class GroupingExpr extends Expression{constructor(e){super(),this.contents=e}get astNodeType(){return"groupExpr"}evaluate(e){return this.contents[0].evaluate(e)}search(e){this.searchBlock(this.contents,e)}}class ArrayIndex extends Expression{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class Operator extends Expression{constructor(){super()}}class UnaryOperator extends Operator{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return"unaryOp"}evaluate(e){switch(this.operator){case"+":return this.right.evaluate(e);case"-":return-this.right.evaluate(e);case"!":return this.right.evaluate(e)?0:1;case"~":return~this.right.evaluate(e);default:throw new Error("Unknown unary operator: "+this.operator)}}search(e){this.right.search(e)}}class BinaryOperator extends Operator{constructor(e,t,n){super(),this.operator=e,this.left=t,this.right=n}get astNodeType(){return"binaryOp"}evaluate(e){switch(this.operator){case"+":return this.left.evaluate(e)+this.right.evaluate(e);case"-":return this.left.evaluate(e)-this.right.evaluate(e);case"*":return this.left.evaluate(e)*this.right.evaluate(e);case"/":return this.left.evaluate(e)/this.right.evaluate(e);case"%":return this.left.evaluate(e)%this.right.evaluate(e);case"==":return this.left.evaluate(e)==this.right.evaluate(e)?1:0;case"!=":return this.left.evaluate(e)!=this.right.evaluate(e)?1:0;case"<":return this.left.evaluate(e)<this.right.evaluate(e)?1:0;case">":return this.left.evaluate(e)>this.right.evaluate(e)?1:0;case"<=":return this.left.evaluate(e)<=this.right.evaluate(e)?1:0;case">=":return this.left.evaluate(e)>=this.right.evaluate(e)?1:0;case"&&":return this.left.evaluate(e)&&this.right.evaluate(e)?1:0;case"||":return this.left.evaluate(e)||this.right.evaluate(e)?1:0;default:throw new Error(`Unknown operator ${this.operator}`)}}search(e){this.left.search(e),this.right.search(e)}}class SwitchCase extends Node{constructor(){super()}}class Case extends SwitchCase{constructor(e,t){super(),this.selector=e,this.body=t}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class Default extends SwitchCase{constructor(e){super(),this.body=e}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class Argument extends Node{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return"argument"}}class ElseIf extends Node{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Member extends Node{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return"member"}}class Attribute extends Node{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return"attribute"}}!function(e){e[e.token=0]="token",e[e.keyword=1]="keyword",e[e.reserved=2]="reserved"}(yw||(yw={}));class TokenType{constructor(e,t,n){this.name=e,this.type=t,this.rule=n}toString(){return this.name}}class TokenTypes{}Aw=TokenTypes,TokenTypes.none=new TokenType("",yw.reserved,""),TokenTypes.eof=new TokenType("EOF",yw.token,""),TokenTypes.reserved={asm:new TokenType("asm",yw.reserved,"asm"),bf16:new TokenType("bf16",yw.reserved,"bf16"),do:new TokenType("do",yw.reserved,"do"),enum:new TokenType("enum",yw.reserved,"enum"),f16:new TokenType("f16",yw.reserved,"f16"),f64:new TokenType("f64",yw.reserved,"f64"),handle:new TokenType("handle",yw.reserved,"handle"),i8:new TokenType("i8",yw.reserved,"i8"),i16:new TokenType("i16",yw.reserved,"i16"),i64:new TokenType("i64",yw.reserved,"i64"),mat:new TokenType("mat",yw.reserved,"mat"),premerge:new TokenType("premerge",yw.reserved,"premerge"),regardless:new TokenType("regardless",yw.reserved,"regardless"),typedef:new TokenType("typedef",yw.reserved,"typedef"),u8:new TokenType("u8",yw.reserved,"u8"),u16:new TokenType("u16",yw.reserved,"u16"),u64:new TokenType("u64",yw.reserved,"u64"),unless:new TokenType("unless",yw.reserved,"unless"),using:new TokenType("using",yw.reserved,"using"),vec:new TokenType("vec",yw.reserved,"vec"),void:new TokenType("void",yw.reserved,"void")},TokenTypes.keywords={array:new TokenType("array",yw.keyword,"array"),atomic:new TokenType("atomic",yw.keyword,"atomic"),bool:new TokenType("bool",yw.keyword,"bool"),f32:new TokenType("f32",yw.keyword,"f32"),i32:new TokenType("i32",yw.keyword,"i32"),mat2x2:new TokenType("mat2x2",yw.keyword,"mat2x2"),mat2x3:new TokenType("mat2x3",yw.keyword,"mat2x3"),mat2x4:new TokenType("mat2x4",yw.keyword,"mat2x4"),mat3x2:new TokenType("mat3x2",yw.keyword,"mat3x2"),mat3x3:new TokenType("mat3x3",yw.keyword,"mat3x3"),mat3x4:new TokenType("mat3x4",yw.keyword,"mat3x4"),mat4x2:new TokenType("mat4x2",yw.keyword,"mat4x2"),mat4x3:new TokenType("mat4x3",yw.keyword,"mat4x3"),mat4x4:new TokenType("mat4x4",yw.keyword,"mat4x4"),ptr:new TokenType("ptr",yw.keyword,"ptr"),sampler:new TokenType("sampler",yw.keyword,"sampler"),sampler_comparison:new TokenType("sampler_comparison",yw.keyword,"sampler_comparison"),struct:new TokenType("struct",yw.keyword,"struct"),texture_1d:new TokenType("texture_1d",yw.keyword,"texture_1d"),texture_2d:new TokenType("texture_2d",yw.keyword,"texture_2d"),texture_2d_array:new TokenType("texture_2d_array",yw.keyword,"texture_2d_array"),texture_3d:new TokenType("texture_3d",yw.keyword,"texture_3d"),texture_cube:new TokenType("texture_cube",yw.keyword,"texture_cube"),texture_cube_array:new TokenType("texture_cube_array",yw.keyword,"texture_cube_array"),texture_multisampled_2d:new TokenType("texture_multisampled_2d",yw.keyword,"texture_multisampled_2d"),texture_storage_1d:new TokenType("texture_storage_1d",yw.keyword,"texture_storage_1d"),texture_storage_2d:new TokenType("texture_storage_2d",yw.keyword,"texture_storage_2d"),texture_storage_2d_array:new TokenType("texture_storage_2d_array",yw.keyword,"texture_storage_2d_array"),texture_storage_3d:new TokenType("texture_storage_3d",yw.keyword,"texture_storage_3d"),texture_depth_2d:new TokenType("texture_depth_2d",yw.keyword,"texture_depth_2d"),texture_depth_2d_array:new TokenType("texture_depth_2d_array",yw.keyword,"texture_depth_2d_array"),texture_depth_cube:new TokenType("texture_depth_cube",yw.keyword,"texture_depth_cube"),texture_depth_cube_array:new TokenType("texture_depth_cube_array",yw.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new TokenType("texture_depth_multisampled_2d",yw.keyword,"texture_depth_multisampled_2d"),texture_external:new TokenType("texture_external",yw.keyword,"texture_external"),u32:new TokenType("u32",yw.keyword,"u32"),vec2:new TokenType("vec2",yw.keyword,"vec2"),vec3:new TokenType("vec3",yw.keyword,"vec3"),vec4:new TokenType("vec4",yw.keyword,"vec4"),bitcast:new TokenType("bitcast",yw.keyword,"bitcast"),block:new TokenType("block",yw.keyword,"block"),break:new TokenType("break",yw.keyword,"break"),case:new TokenType("case",yw.keyword,"case"),continue:new TokenType("continue",yw.keyword,"continue"),continuing:new TokenType("continuing",yw.keyword,"continuing"),default:new TokenType("default",yw.keyword,"default"),diagnostic:new TokenType("diagnostic",yw.keyword,"diagnostic"),discard:new TokenType("discard",yw.keyword,"discard"),else:new TokenType("else",yw.keyword,"else"),enable:new TokenType("enable",yw.keyword,"enable"),fallthrough:new TokenType("fallthrough",yw.keyword,"fallthrough"),false:new TokenType("false",yw.keyword,"false"),fn:new TokenType("fn",yw.keyword,"fn"),for:new TokenType("for",yw.keyword,"for"),function:new TokenType("function",yw.keyword,"function"),if:new TokenType("if",yw.keyword,"if"),let:new TokenType("let",yw.keyword,"let"),const:new TokenType("const",yw.keyword,"const"),loop:new TokenType("loop",yw.keyword,"loop"),while:new TokenType("while",yw.keyword,"while"),private:new TokenType("private",yw.keyword,"private"),read:new TokenType("read",yw.keyword,"read"),read_write:new TokenType("read_write",yw.keyword,"read_write"),return:new TokenType("return",yw.keyword,"return"),requires:new TokenType("requires",yw.keyword,"requires"),storage:new TokenType("storage",yw.keyword,"storage"),switch:new TokenType("switch",yw.keyword,"switch"),true:new TokenType("true",yw.keyword,"true"),alias:new TokenType("alias",yw.keyword,"alias"),type:new TokenType("type",yw.keyword,"type"),uniform:new TokenType("uniform",yw.keyword,"uniform"),var:new TokenType("var",yw.keyword,"var"),override:new TokenType("override",yw.keyword,"override"),workgroup:new TokenType("workgroup",yw.keyword,"workgroup"),write:new TokenType("write",yw.keyword,"write"),r8unorm:new TokenType("r8unorm",yw.keyword,"r8unorm"),r8snorm:new TokenType("r8snorm",yw.keyword,"r8snorm"),r8uint:new TokenType("r8uint",yw.keyword,"r8uint"),r8sint:new TokenType("r8sint",yw.keyword,"r8sint"),r16uint:new TokenType("r16uint",yw.keyword,"r16uint"),r16sint:new TokenType("r16sint",yw.keyword,"r16sint"),r16float:new TokenType("r16float",yw.keyword,"r16float"),rg8unorm:new TokenType("rg8unorm",yw.keyword,"rg8unorm"),rg8snorm:new TokenType("rg8snorm",yw.keyword,"rg8snorm"),rg8uint:new TokenType("rg8uint",yw.keyword,"rg8uint"),rg8sint:new TokenType("rg8sint",yw.keyword,"rg8sint"),r32uint:new TokenType("r32uint",yw.keyword,"r32uint"),r32sint:new TokenType("r32sint",yw.keyword,"r32sint"),r32float:new TokenType("r32float",yw.keyword,"r32float"),rg16uint:new TokenType("rg16uint",yw.keyword,"rg16uint"),rg16sint:new TokenType("rg16sint",yw.keyword,"rg16sint"),rg16float:new TokenType("rg16float",yw.keyword,"rg16float"),rgba8unorm:new TokenType("rgba8unorm",yw.keyword,"rgba8unorm"),rgba8unorm_srgb:new TokenType("rgba8unorm_srgb",yw.keyword,"rgba8unorm_srgb"),rgba8snorm:new TokenType("rgba8snorm",yw.keyword,"rgba8snorm"),rgba8uint:new TokenType("rgba8uint",yw.keyword,"rgba8uint"),rgba8sint:new TokenType("rgba8sint",yw.keyword,"rgba8sint"),bgra8unorm:new TokenType("bgra8unorm",yw.keyword,"bgra8unorm"),bgra8unorm_srgb:new TokenType("bgra8unorm_srgb",yw.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new TokenType("rgb10a2unorm",yw.keyword,"rgb10a2unorm"),rg11b10float:new TokenType("rg11b10float",yw.keyword,"rg11b10float"),rg32uint:new TokenType("rg32uint",yw.keyword,"rg32uint"),rg32sint:new TokenType("rg32sint",yw.keyword,"rg32sint"),rg32float:new TokenType("rg32float",yw.keyword,"rg32float"),rgba16uint:new TokenType("rgba16uint",yw.keyword,"rgba16uint"),rgba16sint:new TokenType("rgba16sint",yw.keyword,"rgba16sint"),rgba16float:new TokenType("rgba16float",yw.keyword,"rgba16float"),rgba32uint:new TokenType("rgba32uint",yw.keyword,"rgba32uint"),rgba32sint:new TokenType("rgba32sint",yw.keyword,"rgba32sint"),rgba32float:new TokenType("rgba32float",yw.keyword,"rgba32float"),static_assert:new TokenType("static_assert",yw.keyword,"static_assert")},TokenTypes.tokens={decimal_float_literal:new TokenType("decimal_float_literal",yw.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?f?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+f?)|([0-9]+f)/),hex_float_literal:new TokenType("hex_float_literal",yw.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+f?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+f?))/),int_literal:new TokenType("int_literal",yw.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new TokenType("uint_literal",yw.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),ident:new TokenType("ident",yw.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new TokenType("and",yw.token,"&"),and_and:new TokenType("and_and",yw.token,"&&"),arrow:new TokenType("arrow ",yw.token,"->"),attr:new TokenType("attr",yw.token,"@"),forward_slash:new TokenType("forward_slash",yw.token,"/"),bang:new TokenType("bang",yw.token,"!"),bracket_left:new TokenType("bracket_left",yw.token,"["),bracket_right:new TokenType("bracket_right",yw.token,"]"),brace_left:new TokenType("brace_left",yw.token,"{"),brace_right:new TokenType("brace_right",yw.token,"}"),colon:new TokenType("colon",yw.token,":"),comma:new TokenType("comma",yw.token,","),equal:new TokenType("equal",yw.token,"="),equal_equal:new TokenType("equal_equal",yw.token,"=="),not_equal:new TokenType("not_equal",yw.token,"!="),greater_than:new TokenType("greater_than",yw.token,">"),greater_than_equal:new TokenType("greater_than_equal",yw.token,">="),shift_right:new TokenType("shift_right",yw.token,">>"),less_than:new TokenType("less_than",yw.token,"<"),less_than_equal:new TokenType("less_than_equal",yw.token,"<="),shift_left:new TokenType("shift_left",yw.token,"<<"),modulo:new TokenType("modulo",yw.token,"%"),minus:new TokenType("minus",yw.token,"-"),minus_minus:new TokenType("minus_minus",yw.token,"--"),period:new TokenType("period",yw.token,"."),plus:new TokenType("plus",yw.token,"+"),plus_plus:new TokenType("plus_plus",yw.token,"++"),or:new TokenType("or",yw.token,"|"),or_or:new TokenType("or_or",yw.token,"||"),paren_left:new TokenType("paren_left",yw.token,"("),paren_right:new TokenType("paren_right",yw.token,")"),semicolon:new TokenType("semicolon",yw.token,";"),star:new TokenType("star",yw.token,"*"),tilde:new TokenType("tilde",yw.token,"~"),underscore:new TokenType("underscore",yw.token,"_"),xor:new TokenType("xor",yw.token,"^"),plus_equal:new TokenType("plus_equal",yw.token,"+="),minus_equal:new TokenType("minus_equal",yw.token,"-="),times_equal:new TokenType("times_equal",yw.token,"*="),division_equal:new TokenType("division_equal",yw.token,"/="),modulo_equal:new TokenType("modulo_equal",yw.token,"%="),and_equal:new TokenType("and_equal",yw.token,"&="),or_equal:new TokenType("or_equal",yw.token,"|="),xor_equal:new TokenType("xor_equal",yw.token,"^="),shift_right_equal:new TokenType("shift_right_equal",yw.token,">>="),shift_left_equal:new TokenType("shift_left_equal",yw.token,"<<=")},TokenTypes.simpleTokens={"@":Aw.tokens.attr,"{":Aw.tokens.brace_left,"}":Aw.tokens.brace_right,":":Aw.tokens.colon,",":Aw.tokens.comma,"(":Aw.tokens.paren_left,")":Aw.tokens.paren_right,";":Aw.tokens.semicolon},TokenTypes.literalTokens={"&":Aw.tokens.and,"&&":Aw.tokens.and_and,"->":Aw.tokens.arrow,"/":Aw.tokens.forward_slash,"!":Aw.tokens.bang,"[":Aw.tokens.bracket_left,"]":Aw.tokens.bracket_right,"=":Aw.tokens.equal,"==":Aw.tokens.equal_equal,"!=":Aw.tokens.not_equal,">":Aw.tokens.greater_than,">=":Aw.tokens.greater_than_equal,">>":Aw.tokens.shift_right,"<":Aw.tokens.less_than,"<=":Aw.tokens.less_than_equal,"<<":Aw.tokens.shift_left,"%":Aw.tokens.modulo,"-":Aw.tokens.minus,"--":Aw.tokens.minus_minus,".":Aw.tokens.period,"+":Aw.tokens.plus,"++":Aw.tokens.plus_plus,"|":Aw.tokens.or,"||":Aw.tokens.or_or,"*":Aw.tokens.star,"~":Aw.tokens.tilde,_:Aw.tokens.underscore,"^":Aw.tokens.xor,"+=":Aw.tokens.plus_equal,"-=":Aw.tokens.minus_equal,"*=":Aw.tokens.times_equal,"/=":Aw.tokens.division_equal,"%=":Aw.tokens.modulo_equal,"&=":Aw.tokens.and_equal,"|=":Aw.tokens.or_equal,"^=":Aw.tokens.xor_equal,">>=":Aw.tokens.shift_right_equal,"<<=":Aw.tokens.shift_left_equal},TokenTypes.regexTokens={decimal_float_literal:Aw.tokens.decimal_float_literal,hex_float_literal:Aw.tokens.hex_float_literal,int_literal:Aw.tokens.int_literal,uint_literal:Aw.tokens.uint_literal,ident:Aw.tokens.ident},TokenTypes.storage_class=[Aw.keywords.function,Aw.keywords.private,Aw.keywords.workgroup,Aw.keywords.uniform,Aw.keywords.storage],TokenTypes.access_mode=[Aw.keywords.read,Aw.keywords.write,Aw.keywords.read_write],TokenTypes.sampler_type=[Aw.keywords.sampler,Aw.keywords.sampler_comparison],TokenTypes.sampled_texture_type=[Aw.keywords.texture_1d,Aw.keywords.texture_2d,Aw.keywords.texture_2d_array,Aw.keywords.texture_3d,Aw.keywords.texture_cube,Aw.keywords.texture_cube_array],TokenTypes.multisampled_texture_type=[Aw.keywords.texture_multisampled_2d],TokenTypes.storage_texture_type=[Aw.keywords.texture_storage_1d,Aw.keywords.texture_storage_2d,Aw.keywords.texture_storage_2d_array,Aw.keywords.texture_storage_3d],TokenTypes.depth_texture_type=[Aw.keywords.texture_depth_2d,Aw.keywords.texture_depth_2d_array,Aw.keywords.texture_depth_cube,Aw.keywords.texture_depth_cube_array,Aw.keywords.texture_depth_multisampled_2d],TokenTypes.texture_external_type=[Aw.keywords.texture_external],TokenTypes.any_texture_type=[...Aw.sampled_texture_type,...Aw.multisampled_texture_type,...Aw.storage_texture_type,...Aw.depth_texture_type,...Aw.texture_external_type],TokenTypes.texel_format=[Aw.keywords.r8unorm,Aw.keywords.r8snorm,Aw.keywords.r8uint,Aw.keywords.r8sint,Aw.keywords.r16uint,Aw.keywords.r16sint,Aw.keywords.r16float,Aw.keywords.rg8unorm,Aw.keywords.rg8snorm,Aw.keywords.rg8uint,Aw.keywords.rg8sint,Aw.keywords.r32uint,Aw.keywords.r32sint,Aw.keywords.r32float,Aw.keywords.rg16uint,Aw.keywords.rg16sint,Aw.keywords.rg16float,Aw.keywords.rgba8unorm,Aw.keywords.rgba8unorm_srgb,Aw.keywords.rgba8snorm,Aw.keywords.rgba8uint,Aw.keywords.rgba8sint,Aw.keywords.bgra8unorm,Aw.keywords.bgra8unorm_srgb,Aw.keywords.rgb10a2unorm,Aw.keywords.rg11b10float,Aw.keywords.rg32uint,Aw.keywords.rg32sint,Aw.keywords.rg32float,Aw.keywords.rgba16uint,Aw.keywords.rgba16sint,Aw.keywords.rgba16float,Aw.keywords.rgba32uint,Aw.keywords.rgba32sint,Aw.keywords.rgba32float],TokenTypes.const_literal=[Aw.tokens.int_literal,Aw.tokens.uint_literal,Aw.tokens.decimal_float_literal,Aw.tokens.hex_float_literal,Aw.keywords.true,Aw.keywords.false],TokenTypes.literal_or_ident=[Aw.tokens.ident,Aw.tokens.int_literal,Aw.tokens.uint_literal,Aw.tokens.decimal_float_literal,Aw.tokens.hex_float_literal],TokenTypes.element_count_expression=[Aw.tokens.int_literal,Aw.tokens.uint_literal,Aw.tokens.ident],TokenTypes.template_types=[Aw.keywords.vec2,Aw.keywords.vec3,Aw.keywords.vec4,Aw.keywords.mat2x2,Aw.keywords.mat2x3,Aw.keywords.mat2x4,Aw.keywords.mat3x2,Aw.keywords.mat3x3,Aw.keywords.mat3x4,Aw.keywords.mat4x2,Aw.keywords.mat4x3,Aw.keywords.mat4x4,Aw.keywords.atomic,Aw.keywords.bitcast,...Aw.any_texture_type],TokenTypes.attribute_name=[Aw.tokens.ident,Aw.keywords.block,Aw.keywords.diagnostic],TokenTypes.assignment_operators=[Aw.tokens.equal,Aw.tokens.plus_equal,Aw.tokens.minus_equal,Aw.tokens.times_equal,Aw.tokens.division_equal,Aw.tokens.modulo_equal,Aw.tokens.and_equal,Aw.tokens.or_equal,Aw.tokens.xor_equal,Aw.tokens.shift_right_equal,Aw.tokens.shift_left_equal],TokenTypes.increment_operators=[Aw.tokens.plus_plus,Aw.tokens.minus_minus];class Token{constructor(e,t,n){this.type=e,this.lexeme=t,this.line=n}toString(){return this.lexeme}isTemplateType(){return-1!=TokenTypes.template_types.indexOf(this.type)}isArrayType(){return this.type==TokenTypes.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class WgslScanner{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=null!=e?e:""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new Token(TokenTypes.eof,"",this._line)),this._tokens}scanToken(){let e=this._advance();if("\n"==e)return this._line++,!0;if(this._isWhitespace(e))return!0;if("/"==e){if("/"==this._peekAhead()){for(;"\n"!=e;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if("*"==this._peekAhead()){this._advance();let t=1;for(;t>0;){if(this._isAtEnd())return!0;if(e=this._advance(),"\n"==e)this._line++;else if("*"==e){if("/"==this._peekAhead()&&(this._advance(),t--,0==t))return!0}else"/"==e&&"*"==this._peekAhead()&&(this._advance(),t++)}return!0}}const t=TokenTypes.simpleTokens[e];if(t)return this._addToken(t),!0;let n=TokenTypes.none;const i=this._isAlpha(e),s="_"===e;if(this._isAlphaNumeric(e)){let t=this._peekAhead();for(;this._isAlphaNumeric(t);)e+=this._advance(),t=this._peekAhead()}if(i){const t=TokenTypes.keywords[e];if(t)return this._addToken(t),!0}if(i||s)return this._addToken(TokenTypes.tokens.ident),!0;for(;;){let t=this._findType(e);const i=this._peekAhead();if("-"==e&&this._tokens.length>0){if("="==i)return this._current++,e+=i,this._addToken(TokenTypes.tokens.minus_equal),!0;if("-"==i)return this._current++,e+=i,this._addToken(TokenTypes.tokens.minus_minus),!0;const n=this._tokens.length-1;if((-1!=TokenTypes.literal_or_ident.indexOf(this._tokens[n].type)||this._tokens[n].type==TokenTypes.tokens.paren_right)&&">"!=i)return this._addToken(t),!0}if(">"==e&&(">"==i||"="==i)){let e=!1,n=this._tokens.length-1;for(let t=0;t<5&&n>=0&&-1===TokenTypes.assignment_operators.indexOf(this._tokens[n].type);++t,--n)if(this._tokens[n].type===TokenTypes.tokens.less_than){n>0&&this._tokens[n-1].isArrayOrTemplateType()&&(e=!0);break}if(e)return this._addToken(t),!0}if(t===TokenTypes.none){let i=e,s=0;const o=2;for(let e=0;e<o;++e)if(i+=this._peekAhead(e),t=this._findType(i),t!==TokenTypes.none){s=e;break}if(t===TokenTypes.none)return n!==TokenTypes.none&&(this._current--,this._addToken(n),!0);e=i,this._current+=s+1}if(n=t,this._isAtEnd())break;e+=this._advance()}return n!==TokenTypes.none&&(this._addToken(n),!0)}_findType(e){for(const t in TokenTypes.regexTokens){const n=TokenTypes.regexTokens[t];if(this._match(e,n.rule))return n}const t=TokenTypes.literalTokens[e];return t||TokenTypes.none}_match(e,t){const n=t.exec(e);return n&&0==n.index&&n[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}_isAlphaNumeric(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||"_"==e||e>="0"&&e<="9"}_isWhitespace(e){return" "==e||"\t"==e||"\r"==e}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return this._current+(e=e||0)>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const t=this._source.substring(this._start,this._current);this._tokens.push(new Token(e,t,this._line))}}class WgslParser{constructor(){this._tokens=[],this._current=0,this._currentLine=0,this._context=new ParseContext,this._deferArrayCountEval=[]}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const t=[];for(;!this._isAtEnd();){const e=this._global_decl_or_directive();if(!e)break;t.push(e)}if(this._deferArrayCountEval.length>0){for(const e of this._deferArrayCountEval){const t=e.arrayType,n=e.countNode;if(n instanceof VariableExpr){const e=this._context.constants.get(n.name);if(e)try{const n=e.evaluate(this._context);t.count=n}catch(e){}}}this._deferArrayCountEval.length=0}return t}_initialize(e){if(e)if("string"==typeof e){const t=new WgslScanner(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_error(e,t){return{token:e,message:t,toString:function(){return`${t}`}}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==TokenTypes.eof}_match(e){if(e instanceof TokenType)return!!this._check(e)&&(this._advance(),!0);for(let t=0,n=e.length;t<n;++t){if(this._check(e[t]))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),t)}_check(e){if(this._isAtEnd())return!1;const t=this._peek();if(e instanceof Array){return-1!=e.indexOf(t.type)}return t.type==e}_advance(){var e,t;return this._currentLine=null!==(t=null===(e=this._peek())||void 0===e?void 0:e.line)&&void 0!==t?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(TokenTypes.tokens.semicolon)&&!this._isAtEnd(););if(this._match(TokenTypes.keywords.alias)){const e=this._type_alias();return this._consume(TokenTypes.tokens.semicolon,"Expected ';'"),e}if(this._match(TokenTypes.keywords.diagnostic)){const e=this._diagnostic();return this._consume(TokenTypes.tokens.semicolon,"Expected ';'"),e}if(this._match(TokenTypes.keywords.requires)){const e=this._requires_directive();return this._consume(TokenTypes.tokens.semicolon,"Expected ';'"),e}if(this._match(TokenTypes.keywords.enable)){const e=this._enable_directive();return this._consume(TokenTypes.tokens.semicolon,"Expected ';'"),e}const e=this._attribute();if(this._check(TokenTypes.keywords.var)){const t=this._global_variable_decl();return null!=t&&(t.attributes=e),this._consume(TokenTypes.tokens.semicolon,"Expected ';'."),t}if(this._check(TokenTypes.keywords.override)){const t=this._override_variable_decl();return null!=t&&(t.attributes=e),this._consume(TokenTypes.tokens.semicolon,"Expected ';'."),t}if(this._check(TokenTypes.keywords.let)){const t=this._global_let_decl();return null!=t&&(t.attributes=e),this._consume(TokenTypes.tokens.semicolon,"Expected ';'."),t}if(this._check(TokenTypes.keywords.const)){const t=this._global_const_decl();return null!=t&&(t.attributes=e),this._consume(TokenTypes.tokens.semicolon,"Expected ';'."),t}if(this._check(TokenTypes.keywords.struct)){const t=this._struct_decl();return null!=t&&(t.attributes=e),t}if(this._check(TokenTypes.keywords.fn)){const t=this._function_decl();return null!=t&&(t.attributes=e),t}return null}_function_decl(){if(!this._match(TokenTypes.keywords.fn))return null;const e=this._currentLine,t=this._consume(TokenTypes.tokens.ident,"Expected function name.").toString();this._consume(TokenTypes.tokens.paren_left,"Expected '(' for function arguments.");const n=[];if(!this._check(TokenTypes.tokens.paren_right))do{if(this._check(TokenTypes.tokens.paren_right))break;const e=this._attribute(),t=this._consume(TokenTypes.tokens.ident,"Expected argument name.").toString();this._consume(TokenTypes.tokens.colon,"Expected ':' for argument type.");const i=this._attribute(),s=this._type_decl();null!=s&&(s.attributes=i,n.push(new Argument(t,s,e)))}while(this._match(TokenTypes.tokens.comma));this._consume(TokenTypes.tokens.paren_right,"Expected ')' after function arguments.");let i=null;if(this._match(TokenTypes.tokens.arrow)){const e=this._attribute();i=this._type_decl(),null!=i&&(i.attributes=e)}const s=this._compound_statement();return new pw(t,n,i,s,e,this._currentLine)}_compound_statement(){const e=[];for(this._consume(TokenTypes.tokens.brace_left,"Expected '{' for block.");!this._check(TokenTypes.tokens.brace_right);){const t=this._statement();null!==t&&e.push(t)}return this._consume(TokenTypes.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(TokenTypes.tokens.semicolon)&&!this._isAtEnd(););if(this._check(TokenTypes.tokens.attr)&&this._attribute(),this._check(TokenTypes.keywords.if))return this._if_statement();if(this._check(TokenTypes.keywords.switch))return this._switch_statement();if(this._check(TokenTypes.keywords.loop))return this._loop_statement();if(this._check(TokenTypes.keywords.for))return this._for_statement();if(this._check(TokenTypes.keywords.while))return this._while_statement();if(this._check(TokenTypes.keywords.continuing))return this._continuing_statement();if(this._check(TokenTypes.keywords.static_assert))return this._static_assert_statement();if(this._check(TokenTypes.tokens.brace_left))return this._compound_statement();let e=null;return e=this._check(TokenTypes.keywords.return)?this._return_statement():this._check([TokenTypes.keywords.var,TokenTypes.keywords.let,TokenTypes.keywords.const])?this._variable_statement():this._match(TokenTypes.keywords.discard)?new Discard:this._match(TokenTypes.keywords.break)?new Break:this._match(TokenTypes.keywords.continue)?new Continue:this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement(),null!=e&&this._consume(TokenTypes.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(TokenTypes.keywords.static_assert))return null;const e=this._optional_paren_expression();return new StaticAssert(e)}_while_statement(){if(!this._match(TokenTypes.keywords.while))return null;const e=this._optional_paren_expression();this._check(TokenTypes.tokens.attr)&&this._attribute();const t=this._compound_statement();return new While(e,t)}_continuing_statement(){if(!this._match(TokenTypes.keywords.continuing))return null;const e=this._compound_statement();return new Continuing(e)}_for_statement(){if(!this._match(TokenTypes.keywords.for))return null;this._consume(TokenTypes.tokens.paren_left,"Expected '('.");const e=this._check(TokenTypes.tokens.semicolon)?null:this._for_init();this._consume(TokenTypes.tokens.semicolon,"Expected ';'.");const t=this._check(TokenTypes.tokens.semicolon)?null:this._short_circuit_or_expression();this._consume(TokenTypes.tokens.semicolon,"Expected ';'.");const n=this._check(TokenTypes.tokens.paren_right)?null:this._for_increment();this._consume(TokenTypes.tokens.paren_right,"Expected ')'."),this._check(TokenTypes.tokens.attr)&&this._attribute();const i=this._compound_statement();return new For(e,t,n,i)}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(TokenTypes.keywords.var)){const e=this._variable_decl();if(null===e)throw this._error(this._peek(),"Variable declaration expected.");let t=null;return this._match(TokenTypes.tokens.equal)&&(t=this._short_circuit_or_expression()),new Var(e.name,e.type,e.storage,e.access,t)}if(this._match(TokenTypes.keywords.let)){const e=this._consume(TokenTypes.tokens.ident,"Expected name for let.").toString();let t=null;if(this._match(TokenTypes.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}this._consume(TokenTypes.tokens.equal,"Expected '=' for let.");const n=this._short_circuit_or_expression();return new Let(e,t,null,null,n)}if(this._match(TokenTypes.keywords.const)){const e=this._consume(TokenTypes.tokens.ident,"Expected name for const.").toString();let t=null;if(this._match(TokenTypes.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}this._consume(TokenTypes.tokens.equal,"Expected '=' for const.");const n=this._short_circuit_or_expression();return new Const(e,t,null,null,n)}return null}_increment_decrement_statement(){const e=this._current,t=this._unary_expression();if(null==t)return null;if(!this._check(TokenTypes.increment_operators))return this._current=e,null;const n=this._consume(TokenTypes.increment_operators,"Expected increment operator");return new Increment(n.type===TokenTypes.tokens.plus_plus?gw.increment:gw.decrement,t)}_assignment_statement(){let e=null;if(this._check(TokenTypes.tokens.brace_right))return null;let t=this._match(TokenTypes.tokens.underscore);if(t||(e=this._unary_expression()),!t&&null==e)return null;const n=this._consume(TokenTypes.assignment_operators,"Expected assignment operator."),i=this._short_circuit_or_expression();return new Assign(mw.parse(n.lexeme),e,i)}_func_call_statement(){if(!this._check(TokenTypes.tokens.ident))return null;const e=this._current,t=this._consume(TokenTypes.tokens.ident,"Expected function name."),n=this._argument_expression_list();return null===n?(this._current=e,null):new Call(t.lexeme,n)}_loop_statement(){if(!this._match(TokenTypes.keywords.loop))return null;this._check(TokenTypes.tokens.attr)&&this._attribute(),this._consume(TokenTypes.tokens.brace_left,"Expected '{' for loop.");const e=[];let t=this._statement();for(;null!==t;){if(Array.isArray(t))for(let n of t)e.push(n);else e.push(t);t=this._statement()}let n=null;return this._match(TokenTypes.keywords.continuing)&&(n=this._compound_statement()),this._consume(TokenTypes.tokens.brace_right,"Expected '}' for loop."),new Loop(e,n)}_switch_statement(){if(!this._match(TokenTypes.keywords.switch))return null;const e=this._optional_paren_expression();this._check(TokenTypes.tokens.attr)&&this._attribute(),this._consume(TokenTypes.tokens.brace_left,"Expected '{' for switch.");const t=this._switch_body();if(null==t||0==t.length)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(TokenTypes.tokens.brace_right,"Expected '}' for switch."),new Switch(e,t)}_switch_body(){const e=[];if(this._match(TokenTypes.keywords.case)){const t=this._case_selectors();this._match(TokenTypes.tokens.colon),this._check(TokenTypes.tokens.attr)&&this._attribute(),this._consume(TokenTypes.tokens.brace_left,"Exected '{' for switch case.");const n=this._case_body();this._consume(TokenTypes.tokens.brace_right,"Exected '}' for switch case."),e.push(new Case(t,n))}if(this._match(TokenTypes.keywords.default)){this._match(TokenTypes.tokens.colon),this._check(TokenTypes.tokens.attr)&&this._attribute(),this._consume(TokenTypes.tokens.brace_left,"Exected '{' for switch default.");const t=this._case_body();this._consume(TokenTypes.tokens.brace_right,"Exected '}' for switch default."),e.push(new Default(t))}if(this._check([TokenTypes.keywords.default,TokenTypes.keywords.case])){const t=this._switch_body();e.push(t[0])}return e}_case_selectors(){const e=[this._shift_expression()];for(;this._match(TokenTypes.tokens.comma);)e.push(this._shift_expression());return e}_case_body(){if(this._match(TokenTypes.keywords.fallthrough))return this._consume(TokenTypes.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(null==e)return[];e instanceof Array||(e=[e]);const t=this._case_body();return 0==t.length?e:[...e,t[0]]}_if_statement(){if(!this._match(TokenTypes.keywords.if))return null;const e=this._optional_paren_expression();this._check(TokenTypes.tokens.attr)&&this._attribute();const t=this._compound_statement();let n=[];this._match_elseif()&&(this._check(TokenTypes.tokens.attr)&&this._attribute(),n=this._elseif_statement(n));let i=null;return this._match(TokenTypes.keywords.else)&&(this._check(TokenTypes.tokens.attr)&&this._attribute(),i=this._compound_statement()),new If(e,t,n,i)}_match_elseif(){return this._tokens[this._current].type===TokenTypes.keywords.else&&this._tokens[this._current+1].type===TokenTypes.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){const t=this._optional_paren_expression(),n=this._compound_statement();return e.push(new ElseIf(t,n)),this._match_elseif()&&(this._check(TokenTypes.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(TokenTypes.keywords.return))return null;const e=this._short_circuit_or_expression();return new Return(e)}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(TokenTypes.tokens.or_or);)e=new BinaryOperator(this._previous().toString(),e,this._short_circuit_and_expr());return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(TokenTypes.tokens.and_and);)e=new BinaryOperator(this._previous().toString(),e,this._inclusive_or_expression());return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(TokenTypes.tokens.or);)e=new BinaryOperator(this._previous().toString(),e,this._exclusive_or_expression());return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(TokenTypes.tokens.xor);)e=new BinaryOperator(this._previous().toString(),e,this._and_expression());return e}_and_expression(){let e=this._equality_expression();for(;this._match(TokenTypes.tokens.and);)e=new BinaryOperator(this._previous().toString(),e,this._equality_expression());return e}_equality_expression(){const e=this._relational_expression();return this._match([TokenTypes.tokens.equal_equal,TokenTypes.tokens.not_equal])?new BinaryOperator(this._previous().toString(),e,this._relational_expression()):e}_relational_expression(){let e=this._shift_expression();for(;this._match([TokenTypes.tokens.less_than,TokenTypes.tokens.greater_than,TokenTypes.tokens.less_than_equal,TokenTypes.tokens.greater_than_equal]);)e=new BinaryOperator(this._previous().toString(),e,this._shift_expression());return e}_shift_expression(){let e=this._additive_expression();for(;this._match([TokenTypes.tokens.shift_left,TokenTypes.tokens.shift_right]);)e=new BinaryOperator(this._previous().toString(),e,this._additive_expression());return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([TokenTypes.tokens.plus,TokenTypes.tokens.minus]);)e=new BinaryOperator(this._previous().toString(),e,this._multiplicative_expression());return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([TokenTypes.tokens.star,TokenTypes.tokens.forward_slash,TokenTypes.tokens.modulo]);)e=new BinaryOperator(this._previous().toString(),e,this._unary_expression());return e}_unary_expression(){return this._match([TokenTypes.tokens.minus,TokenTypes.tokens.bang,TokenTypes.tokens.tilde,TokenTypes.tokens.star,TokenTypes.tokens.and])?new UnaryOperator(this._previous().toString(),this._unary_expression()):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(TokenTypes.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(TokenTypes.tokens.bracket_right,"Expected ']'.");const t=new ArrayIndex(e),n=this._postfix_expression();return n&&(t.postfix=n),t}if(this._match(TokenTypes.tokens.period)){const e=this._consume(TokenTypes.tokens.ident,"Expected member name."),t=this._postfix_expression(),n=new StringExpr(e.lexeme);return t&&(n.postfix=t),n}return null}_getStruct(e){if(this._context.aliases.has(e)){return this._context.aliases.get(e).type}if(this._context.structs.has(e)){return this._context.structs.get(e)}return null}_primary_expression(){if(this._match(TokenTypes.tokens.ident)){const e=this._previous().toString();if(this._check(TokenTypes.tokens.paren_left)){const t=this._argument_expression_list(),n=this._getStruct(e);return null!=n?new CreateExpr(n,t):new CallExpr(e,t)}if(this._context.constants.has(e)){const t=this._context.constants.get(e);return new ConstExpr(e,t.value)}return new VariableExpr(e)}if(this._match(TokenTypes.const_literal))return new LiteralExpr(parseFloat(this._previous().toString()));if(this._check(TokenTypes.tokens.paren_left))return this._paren_expression();if(this._match(TokenTypes.keywords.bitcast)){this._consume(TokenTypes.tokens.less_than,"Expected '<'.");const e=this._type_decl();this._consume(TokenTypes.tokens.greater_than,"Expected '>'.");const t=this._paren_expression();return new BitcastExpr(e,t)}const e=this._type_decl(),t=this._argument_expression_list();return new CreateExpr(e,t)}_argument_expression_list(){if(!this._match(TokenTypes.tokens.paren_left))return null;const e=[];do{if(this._check(TokenTypes.tokens.paren_right))break;const t=this._short_circuit_or_expression();e.push(t)}while(this._match(TokenTypes.tokens.comma));return this._consume(TokenTypes.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(TokenTypes.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(TokenTypes.tokens.paren_right),new GroupingExpr([e])}_paren_expression(){this._consume(TokenTypes.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(TokenTypes.tokens.paren_right,"Expected ')'."),new GroupingExpr([e])}_struct_decl(){if(!this._match(TokenTypes.keywords.struct))return null;const e=this._currentLine,t=this._consume(TokenTypes.tokens.ident,"Expected name for struct.").toString();this._consume(TokenTypes.tokens.brace_left,"Expected '{' for struct body.");const n=[];for(;!this._check(TokenTypes.tokens.brace_right);){const e=this._attribute(),t=this._consume(TokenTypes.tokens.ident,"Expected variable name.").toString();this._consume(TokenTypes.tokens.colon,"Expected ':' for struct member type.");const i=this._attribute(),s=this._type_decl();null!=s&&(s.attributes=i),this._check(TokenTypes.tokens.brace_right)?this._match(TokenTypes.tokens.comma):this._consume(TokenTypes.tokens.comma,"Expected ',' for struct member."),n.push(new Member(t,s,e))}this._consume(TokenTypes.tokens.brace_right,"Expected '}' after struct body.");const i=new Struct(t,n,e,this._currentLine);return this._context.structs.set(t,i),i}_global_variable_decl(){const e=this._variable_decl();return e&&this._match(TokenTypes.tokens.equal)&&(e.value=this._const_expression()),e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(TokenTypes.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){if(!this._match(TokenTypes.keywords.const))return null;const e=this._consume(TokenTypes.tokens.ident,"Expected variable name");let t=null;if(this._match(TokenTypes.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}let n=null;if(this._match(TokenTypes.tokens.equal)){const e=this._short_circuit_or_expression();if(e instanceof CreateExpr)n=e;else if(e instanceof ConstExpr&&e.initializer instanceof CreateExpr)n=e.initializer;else try{const t=e.evaluate(this._context);n=new LiteralExpr(t)}catch(t){n=e}}const i=new Const(e.toString(),t,"","",n);return this._context.constants.set(i.name,i),i}_global_let_decl(){if(!this._match(TokenTypes.keywords.let))return null;const e=this._consume(TokenTypes.tokens.ident,"Expected variable name");let t=null;if(this._match(TokenTypes.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}let n=null;return this._match(TokenTypes.tokens.equal)&&(n=this._const_expression()),new Let(e.toString(),t,"","",n)}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(TokenTypes.keywords.var))return null;let e="",t="";this._match(TokenTypes.tokens.less_than)&&(e=this._consume(TokenTypes.storage_class,"Expected storage_class.").toString(),this._match(TokenTypes.tokens.comma)&&(t=this._consume(TokenTypes.access_mode,"Expected access_mode.").toString()),this._consume(TokenTypes.tokens.greater_than,"Expected '>'."));const n=this._consume(TokenTypes.tokens.ident,"Expected variable name");let i=null;if(this._match(TokenTypes.tokens.colon)){const e=this._attribute();i=this._type_decl(),null!=i&&(i.attributes=e)}return new Var(n.toString(),i,e,t,null)}_override_decl(){if(!this._match(TokenTypes.keywords.override))return null;const e=this._consume(TokenTypes.tokens.ident,"Expected variable name");let t=null;if(this._match(TokenTypes.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}return new Override(e.toString(),t,null)}_diagnostic(){this._consume(TokenTypes.tokens.paren_left,"Expected '('");const e=this._consume(TokenTypes.tokens.ident,"Expected severity control name.");this._consume(TokenTypes.tokens.comma,"Expected ','");const t=this._consume(TokenTypes.tokens.ident,"Expected diagnostic rule name.");return this._consume(TokenTypes.tokens.paren_right,"Expected ')'"),new Diagnostic(e.toString(),t.toString())}_enable_directive(){const e=this._consume(TokenTypes.tokens.ident,"identity expected.");return new Enable(e.toString())}_requires_directive(){const e=[this._consume(TokenTypes.tokens.ident,"identity expected.").toString()];for(;this._match(TokenTypes.tokens.comma);){const t=this._consume(TokenTypes.tokens.ident,"identity expected.");e.push(t.toString())}return new Requires(e)}_type_alias(){const e=this._consume(TokenTypes.tokens.ident,"identity expected.");this._consume(TokenTypes.tokens.equal,"Expected '=' for type alias.");let t=this._type_decl();if(null===t)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);const n=new Alias(e.toString(),t);return this._context.aliases.set(n.name,n),n}_type_decl(){if(this._check([TokenTypes.tokens.ident,...TokenTypes.texel_format,TokenTypes.keywords.bool,TokenTypes.keywords.f32,TokenTypes.keywords.i32,TokenTypes.keywords.u32])){const e=this._advance(),t=e.toString();return this._context.structs.has(t)?this._context.structs.get(t):this._context.aliases.has(t)?this._context.aliases.get(t).type:new Type(e.toString())}let e=this._texture_sampler_types();if(e)return e;if(this._check(TokenTypes.template_types)){let e=this._advance().toString(),t=null,n=null;return this._match(TokenTypes.tokens.less_than)&&(t=this._type_decl(),n=null,this._match(TokenTypes.tokens.comma)&&(n=this._consume(TokenTypes.access_mode,"Expected access_mode for pointer").toString()),this._consume(TokenTypes.tokens.greater_than,"Expected '>' for type.")),new TemplateType(e,t,n)}if(this._match(TokenTypes.keywords.ptr)){let e=this._previous().toString();this._consume(TokenTypes.tokens.less_than,"Expected '<' for pointer.");const t=this._consume(TokenTypes.storage_class,"Expected storage_class for pointer");this._consume(TokenTypes.tokens.comma,"Expected ',' for pointer.");const n=this._type_decl();let i=null;return this._match(TokenTypes.tokens.comma)&&(i=this._consume(TokenTypes.access_mode,"Expected access_mode for pointer").toString()),this._consume(TokenTypes.tokens.greater_than,"Expected '>' for pointer."),new PointerType(e,t.toString(),n,i)}const t=this._attribute();if(this._match(TokenTypes.keywords.array)){let e=null,n=-1;const i=this._previous();let s=null;if(this._match(TokenTypes.tokens.less_than)){e=this._type_decl(),this._context.aliases.has(e.name)&&(e=this._context.aliases.get(e.name).type);let t="";if(this._match(TokenTypes.tokens.comma)){s=this._shift_expression();try{t=s.evaluate(this._context).toString(),s=null}catch(e){t="1"}}this._consume(TokenTypes.tokens.greater_than,"Expected '>' for array."),n=t?parseInt(t):0}const o=new ArrayType(i.toString(),t,e,n);return s&&this._deferArrayCountEval.push({arrayType:o,countNode:s}),o}return null}_texture_sampler_types(){if(this._match(TokenTypes.sampler_type))return new SamplerType(this._previous().toString(),null,null);if(this._match(TokenTypes.depth_texture_type))return new SamplerType(this._previous().toString(),null,null);if(this._match(TokenTypes.sampled_texture_type)||this._match(TokenTypes.multisampled_texture_type)){const e=this._previous();this._consume(TokenTypes.tokens.less_than,"Expected '<' for sampler type.");const t=this._type_decl();return this._consume(TokenTypes.tokens.greater_than,"Expected '>' for sampler type."),new SamplerType(e.toString(),t,null)}if(this._match(TokenTypes.storage_texture_type)){const e=this._previous();this._consume(TokenTypes.tokens.less_than,"Expected '<' for sampler type.");const t=this._consume(TokenTypes.texel_format,"Invalid texel format.").toString();this._consume(TokenTypes.tokens.comma,"Expected ',' after texel format.");const n=this._consume(TokenTypes.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(TokenTypes.tokens.greater_than,"Expected '>' for sampler type."),new SamplerType(e.toString(),t,n)}return null}_attribute(){let e=[];for(;this._match(TokenTypes.tokens.attr);){const t=this._consume(TokenTypes.attribute_name,"Expected attribute name"),n=new Attribute(t.toString(),null);if(this._match(TokenTypes.tokens.paren_left)){if(n.value=this._consume(TokenTypes.literal_or_ident,"Expected attribute value").toString(),this._check(TokenTypes.tokens.comma)){this._advance();do{const e=this._consume(TokenTypes.literal_or_ident,"Expected attribute value").toString();n.value instanceof Array||(n.value=[n.value]),n.value.push(e)}while(this._match(TokenTypes.tokens.comma))}this._consume(TokenTypes.tokens.paren_right,"Expected ')'")}e.push(n)}return 0==e.length?null:e}}class TypeInfo{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}}class MemberInfo{constructor(e,t,n){this.name=e,this.type=t,this.attributes=n,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class StructInfo extends TypeInfo{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class ArrayInfo extends TypeInfo{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}}class TemplateInfo extends TypeInfo{constructor(e,t,n,i){super(e,n),this.format=t,this.access=i}get isTemplate(){return!0}}!function(e){e[e.Uniform=0]="Uniform",e[e.Storage=1]="Storage",e[e.Texture=2]="Texture",e[e.Sampler=3]="Sampler",e[e.StorageTexture=4]="StorageTexture"}(_w||(_w={}));class VariableInfo{constructor(e,t,n,i,s,o,a){this.name=e,this.type=t,this.group=n,this.binding=i,this.attributes=s,this.resourceType=o,this.access=a}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class AliasInfo{constructor(e,t){this.name=e,this.type=t}}class _TypeSize{constructor(e,t){this.align=e,this.size=t}}class InputInfo{constructor(e,t,n,i){this.name=e,this.type=t,this.locationType=n,this.location=i,this.interpolation=null}}class OutputInfo{constructor(e,t,n,i){this.name=e,this.type=t,this.locationType=n,this.location=i}}class OverrideInfo{constructor(e,t,n,i){this.name=e,this.type=t,this.attributes=n,this.id=i}}class ArgumentInfo{constructor(e,t){this.name=e,this.type=t}}class FunctionInfo{constructor(e,t=null){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t}}class EntryFunctions{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}class _FunctionResources{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class WgslReflect{constructor(e){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new EntryFunctions,this.functions=[],this._types=new Map,this._functions=new Map,e&&this.update(e)}_isStorageTexture(e){return"texture_storage_1d"==e.name||"texture_storage_2d"==e.name||"texture_storage_2d_array"==e.name||"texture_storage_3d"==e.name}update(e){const t=(new WgslParser).parse(e);for(const e of t)e instanceof pw&&this._functions.set(e.name,new _FunctionResources(e));for(const e of t)if(e instanceof Struct){const t=this._getTypeInfo(e,null);t instanceof StructInfo&&this.structs.push(t)}for(const e of t)if(e instanceof Alias)this.aliases.push(this._getAliasInfo(e));else if(e instanceof Override){const t=e,n=this._getAttributeNum(t.attributes,"id",0),i=null!=t.type?this._getTypeInfo(t.type,t.attributes):null;this.overrides.push(new OverrideInfo(t.name,i,t.attributes,n))}else if(this._isUniformVar(e)){const t=e,n=this._getAttributeNum(t.attributes,"group",0),i=this._getAttributeNum(t.attributes,"binding",0),s=this._getTypeInfo(t.type,t.attributes),o=new VariableInfo(t.name,s,n,i,t.attributes,_w.Uniform,t.access);this.uniforms.push(o)}else if(this._isStorageVar(e)){const t=e,n=this._getAttributeNum(t.attributes,"group",0),i=this._getAttributeNum(t.attributes,"binding",0),s=this._getTypeInfo(t.type,t.attributes),o=this._isStorageTexture(s),a=new VariableInfo(t.name,s,n,i,t.attributes,o?_w.StorageTexture:_w.Storage,t.access);this.storage.push(a)}else if(this._isTextureVar(e)){const t=e,n=this._getAttributeNum(t.attributes,"group",0),i=this._getAttributeNum(t.attributes,"binding",0),s=this._getTypeInfo(t.type,t.attributes),o=this._isStorageTexture(s),a=new VariableInfo(t.name,s,n,i,t.attributes,o?_w.StorageTexture:_w.Texture,t.access);o?this.storage.push(a):this.textures.push(a)}else if(this._isSamplerVar(e)){const t=e,n=this._getAttributeNum(t.attributes,"group",0),i=this._getAttributeNum(t.attributes,"binding",0),s=this._getTypeInfo(t.type,t.attributes),o=new VariableInfo(t.name,s,n,i,t.attributes,_w.Sampler,t.access);this.samplers.push(o)}else if(e instanceof pw){const t=this._getAttribute(e,"vertex"),n=this._getAttribute(e,"fragment"),i=this._getAttribute(e,"compute"),s=t||n||i,o=new FunctionInfo(e.name,null==s?void 0:s.name);o.startLine=e.startLine,o.endLine=e.endLine,this.functions.push(o),this._functions.get(e.name).info=o,s?(this._functions.get(e.name).inUse=!0,o.inUse=!0,o.resources=this._findResources(e,!!s),o.inputs=this._getInputs(e.args),o.outputs=this._getOutputs(e.returnType),this.entry[s.name].push(o)):(o.arguments=e.args.map((e=>new ArgumentInfo(e.name,this._getTypeInfo(e.type,e.attributes)))),o.returnType=e.returnType?this._getTypeInfo(e.returnType,e.attributes):null)}else;for(const e of this._functions.values())e.info&&(e.info.inUse=e.inUse,this._addCalls(e.node,e.info.calls));for(const e of this._functions.values())e.node.search((t=>{var n;if("varExpr"===t.astNodeType){const i=t;for(const t of this.overrides)i.name==t.name&&(null===(n=e.info)||void 0===n||n.overrides.push(t))}}));for(const e of this.uniforms)this._markStructsInUse(e.type);for(const e of this.storage)this._markStructsInUse(e.type)}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(const t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{const t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var n;for(const i of e.calls){const e=null===(n=this._functions.get(i.name))||void 0===n?void 0:n.info;e&&t.add(e)}}findResource(e,t){for(const n of this.uniforms)if(n.group==e&&n.binding==t)return n;for(const n of this.storage)if(n.group==e&&n.binding==t)return n;for(const n of this.textures)if(n.group==e&&n.binding==t)return n;for(const n of this.samplers)if(n.group==e&&n.binding==t)return n;return null}_findResource(e){for(const t of this.uniforms)if(t.name==e)return t;for(const t of this.storage)if(t.name==e)return t;for(const t of this.textures)if(t.name==e)return t;for(const t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){const t=this._getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){const n=[],i=this,s=[];return e.search((o=>{if(o instanceof _BlockStart)s.push({});else if(o instanceof _BlockEnd)s.pop();else if(o instanceof Var){const e=o;t&&null!==e.type&&this._markStructsFromAST(e.type),s.length>0&&(s[s.length-1][e.name]=e)}else if(o instanceof CreateExpr){t&&null!==o.type&&this._markStructsFromAST(o.type)}else if(o instanceof Let){const e=o;t&&null!==e.type&&this._markStructsFromAST(e.type),s.length>0&&(s[s.length-1][e.name]=e)}else if(o instanceof VariableExpr){if(s.length>0){if(s[s.length-1][o.name])return}const e=i._findResource(o.name);e&&n.push(e)}else if(o instanceof CallExpr){const s=i._functions.get(o.name);s&&(t&&(s.inUse=!0),e.calls.add(s.node),null===s.resources&&(s.resources=i._findResources(s.node,t)),n.push(...s.resources))}else if(o instanceof Call){const s=i._functions.get(o.name);s&&(t&&(s.inUse=!0),e.calls.add(s.node),null===s.resources&&(s.resources=i._findResources(s.node,t)),n.push(...s.resources))}})),[...new Map(n.map((e=>[e.name,e]))).values()]}getBindGroups(){const e=[];function t(t,n){t>=e.length&&(e.length=t+1),void 0===e[t]&&(e[t]=[]),n>=e[t].length&&(e[t].length=n+1)}for(const n of this.uniforms){t(n.group,n.binding);e[n.group][n.binding]=n}for(const n of this.storage){t(n.group,n.binding);e[n.group][n.binding]=n}for(const n of this.textures){t(n.group,n.binding);e[n.group][n.binding]=n}for(const n of this.samplers){t(n.group,n.binding);e[n.group][n.binding]=n}return e}_getOutputs(e,t=void 0){if(void 0===t&&(t=[]),e instanceof Struct)this._getStructOutputs(e,t);else{const n=this._getOutputInfo(e);null!==n&&t.push(n)}return t}_getStructOutputs(e,t){for(const n of e.members)if(n.type instanceof Struct)this._getStructOutputs(n.type,t);else{const e=this._getAttribute(n,"location")||this._getAttribute(n,"builtin");if(null!==e){const i=this._getTypeInfo(n.type,n.type.attributes),s=this._parseInt(e.value),o=new OutputInfo(n.name,i,e.name,s);t.push(o)}}}_getOutputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(null!==t){const n=this._getTypeInfo(e,e.attributes),i=this._parseInt(t.value);return new OutputInfo("",n,t.name,i)}return null}_getInputs(e,t=void 0){void 0===t&&(t=[]);for(const n of e)if(n.type instanceof Struct)this._getStructInputs(n.type,t);else{const e=this._getInputInfo(n);null!==e&&t.push(e)}return t}_getStructInputs(e,t){for(const n of e.members)if(n.type instanceof Struct)this._getStructInputs(n.type,t);else{const e=this._getInputInfo(n);null!==e&&t.push(e)}}_getInputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(null!==t){const n=this._getAttribute(e,"interpolation"),i=this._getTypeInfo(e.type,e.attributes),s=this._parseInt(t.value),o=new InputInfo(e.name,i,t.name,s);return null!==n&&(o.interpolation=this._parseString(n.value)),o}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(const t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new AliasInfo(e.name,this._getTypeInfo(e.type,null))}_getTypeInfo(e,t){if(this._types.has(e))return this._types.get(e);if(e instanceof ArrayType){const n=e,i=n.format?this._getTypeInfo(n.format,n.attributes):null,s=new ArrayInfo(n.name,t);return s.format=i,s.count=n.count,this._types.set(e,s),this._updateTypeInfo(s),s}if(e instanceof Struct){const n=e,i=new StructInfo(n.name,t);i.startLine=n.startLine,i.endLine=n.endLine;for(const e of n.members){const t=this._getTypeInfo(e.type,e.attributes);i.members.push(new MemberInfo(e.name,t,e.attributes))}return this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof SamplerType){const n=e,i=n.format?n.format instanceof Type?this._getTypeInfo(n.format,null):new TypeInfo(n.format,null):null,s=new TemplateInfo(n.name,i,t,n.access);return this._types.set(e,s),this._updateTypeInfo(s),s}if(e instanceof TemplateType){const n=e,i=n.format?this._getTypeInfo(n.format,null):null,s=new TemplateInfo(n.name,i,t,n.access);return this._types.set(e,s),this._updateTypeInfo(s),s}const n=new TypeInfo(e.name,t);return this._types.set(e,n),this._updateTypeInfo(n),n}_updateTypeInfo(e){var t,n;const i=this._getTypeSize(e);if(e.size=null!==(t=null==i?void 0:i.size)&&void 0!==t?t:0,e instanceof ArrayInfo&&e.format){const t=this._getTypeSize(e.format);e.stride=null!==(n=null==t?void 0:t.size)&&void 0!==n?n:0,this._updateTypeInfo(e.format)}e instanceof StructInfo&&this._updateStructInfo(e)}_updateStructInfo(e){let t=0,n=0,i=0,s=0;for(let o=0,a=e.members.length;o<a;++o){const a=e.members[o],l=this._getTypeSize(a);if(!l)continue;this._getAlias(a.type.name);const h=l.align,c=l.size;t=this._roundUp(h,t+n),n=c,i=t,s=Math.max(s,h),a.offset=t,a.size=c,this._updateTypeInfo(a.type)}e.size=this._roundUp(s,i+n),e.align=s}_getTypeSize(e){var t,n;if(null==e)return null;const i=this._getAttributeNum(e.attributes,"size",0),s=this._getAttributeNum(e.attributes,"align",0);if(e instanceof MemberInfo&&(e=e.type),e instanceof TypeInfo){const t=this._getAlias(e.name);null!==t&&(e=t)}{const n=WgslReflect._typeInfo[e.name];if(void 0!==n){const o="f16"===(null===(t=e.format)||void 0===t?void 0:t.name)?2:1;return new _TypeSize(Math.max(s,n.align/o),Math.max(i,n.size/o))}}{const t=WgslReflect._typeInfo[e.name.substring(0,e.name.length-1)];if(t){const n="h"===e.name[e.name.length-1]?2:1;return new _TypeSize(Math.max(s,t.align/n),Math.max(i,t.size/n))}}if(e instanceof ArrayInfo){let t=e,o=8,a=8;const l=this._getTypeSize(t.format);null!==l&&(a=l.size,o=l.align);return a=t.count*this._getAttributeNum(null!==(n=null==e?void 0:e.attributes)&&void 0!==n?n:null,"stride",this._roundUp(o,a)),i&&(a=i),new _TypeSize(Math.max(s,o),Math.max(i,a))}if(e instanceof StructInfo){let t=0,n=0,o=0,a=0,l=0;for(const n of e.members){const e=this._getTypeSize(n.type);null!==e&&(t=Math.max(e.align,t),o=this._roundUp(e.align,o+a),a=e.size,l=o)}return n=this._roundUp(t,l+a),new _TypeSize(Math.max(s,t),Math.max(i,n))}return null}_isUniformVar(e){return e instanceof Var&&"uniform"==e.storage}_isStorageVar(e){return e instanceof Var&&"storage"==e.storage}_isTextureVar(e){return e instanceof Var&&null!==e.type&&-1!=WgslReflect._textureTypes.indexOf(e.type.name)}_isSamplerVar(e){return e instanceof Var&&null!==e.type&&-1!=WgslReflect._samplerTypes.indexOf(e.type.name)}_getAttribute(e,t){if(!e||!e.attributes)return null;const n=e.attributes;for(let e of n)if(e.name==t)return e;return null}_getAttributeNum(e,t,n){if(null===e)return n;for(let i of e)if(i.name==t){let e=null!==i&&null!==i.value?i.value:n;return e instanceof Array&&(e=e[0]),"number"==typeof e?e:"string"==typeof e?parseInt(e):n}return n}_roundUp(e,t){return Math.ceil(t/e)*e}}WgslReflect._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},WgslReflect._textureTypes=TokenTypes.any_texture_type.map((e=>e.name)),WgslReflect._samplerTypes=TokenTypes.sampler_type.map((e=>e.name));class DynamicBuffer{constructor(e,t){this.version=0,this.bindgroupMapping=e,this.pool=t,this.allocation={}}writeBuffer(e,t){const n=this.bindgroupMapping,i=this.allocation.gpuBuffer,s=this.pool.bufferAlignment;this.pool.alloc(this.allocation,n.totalSize),i!==this.allocation.gpuBuffer&&this.version++;let o=this.allocation.offset;const a=this.allocation.storage;for(let i=0;i<n.length;i++){const l=n[i],h=l.binding,c=l.members;if(c){t.addItem(h,o);for(let t=0;t<c.length;t++){const n=c[t],i=e[n.name];void 0===i&&console.warn(`Uniform value ${n.name} is not provided`);this._fillValue(n.type,a,o+n.offset,n.size,i)}o+=bb(l.size,s)}else if(l.resourceType===_w.Uniform){t.addItem(h,o);const n=e[l.name],i=dx(l.size)?l.size():l.size;this._fillValue(l.type,a,o,i,n),o+=bb(i,s)}}}_fillValue(e,t,n,i,s){const o=new Float32Array(t,n,i/4);if(yx(s)){const t=function(e){return xb[e.name]}(e);if(!t)return void o.set(s);for(let e=0;e<s.length;e++){o[4*Math.floor(e/3)+e%3]=s[e]}}else o[0]=s}dispose(){delete this.pool,delete this.allocation}}const vw=new Array(16);let xw=0;class Mesh{constructor(e,t,n={}){this._version=0,this._geometry=e,this._material=t,this.transparent=!!n.transparent,this.bloom=!!n.bloom,this.ssr=!!n.ssr,this._castShadow=ux(n.castShadow)||n.castShadow,this.needUpdateShadow=!1,this.picking=!!n.picking,this.disableVAO=!!n.disableVAO,this.uniforms={},this._localTransform=AA(new Array(16)),this._positionMatrix=AA(new Array(16)),this.properties={},this._dirtyUniforms=!0,this._dirtyGeometry=!0,Object.defineProperty(this,"uuid",{value:xw++}),xw>Number.MAX_VALUE-10&&(xw=0)}set material(e){this._material!==e&&this.setMaterial(e)}get material(){return this._material}set version(e){throw new Error("Mesh.version is read only.")}get version(){return this._version}get geometry(){return this._geometry}set geometry(e){this._geometry!==e&&(this._incrVersion(),this._dirtyGeometry=!0),this._geometry=e}set localTransform(e){this._prevTMat||(this._prevTMat=new Array(16)),Array.isArray(e)&&!zA(this._prevTMat,e)&&(this._incrVersion(),this._prevTMat=mA(this._prevTMat,e)),this._localTransform=e}get localTransform(){return dx(this._localTransform)?this._localTransform():this._localTransform}set positionMatrix(e){this._prevPMat||(this._prevPMat=new Array(16)),Array.isArray(e)&&!zA(this._prevPMat,e)&&(this._incrVersion(),this._prevPMat=mA(this._prevPMat,e)),this._positionMatrix=e}get positionMatrix(){return dx(this._positionMatrix)?this._positionMatrix():this._positionMatrix}get config(){return this._options||(this._options={}),this._options.transparent=this.transparent,this._options.castShadow=this.castShadow,this._options.bloom=this.bloom,this._options.ssr=this.ssr,this._options.picking=this.picking,this._options}get defines(){return this._getDefines()}set defines(e){this.setDefines(e)}get castShadow(){return this._castShadow&&(!this.material||!this.material.unlit)}set castShadow(e){this._castShadow=e}setMaterial(e){return this._material=e,this._dirtyUniforms=!0,delete this._materialVer,this.dirtyDefines=!0,this}setParent(e){return this.parent=e,this}setLocalTransform(e){return this.localTransform=e,this}setPositionMatrix(e){this.positionMatrix=e}setUniform(e,t){return this.uniforms[e]===t||(this._updateUniformState(e),this.uniforms[e]=t),this}setFunctionUniform(e,t){return this._updateUniformState(e),Object.defineProperty(this.uniforms,e,{enumerable:!0,get:t}),this}hasFunctionUniform(e){return!!this.uniforms&&Object.prototype.hasOwnProperty.call(this.uniforms,e)}_updateUniformState(e){void 0===this.uniforms[e]?this._dirtyUniforms=!0:(this._dirtyProps=this._dirtyProps||[],this._dirtyProps.push(e))}hasUniform(e){return void 0!==this.uniforms[e]}getUniform(e){return this.uniforms[e]}getDefines(){const e={};return px(e,this._getDefines()),this._material&&this._geometry&&this._material.appendDefines(e,this._geometry),e}_getDefines(){this._defines||(this._defines={});const e=this._geometry,t=e.data[e.desc.positionAttribute],n=e.data[e.desc.uv0Attribute],i=e.data[e.desc.normalAttribute];return t&&t.quantization&&(this._defines.HAS_DRACO_POSITION=1),n&&n.quantization&&(this._defines.HAS_DRACO_TEXCOORD=1),i&&i.quantization&&(this._defines.HAS_DRACO_NORMAL=1),this._defines}setDefines(e){const t=this._bakDefines;return this._defines=e,this.dirtyDefines=!!t!=!!e||!function(e,t){if(!e&&!t)return!0;const n=Object.getOwnPropertyNames(e),i=Object.getOwnPropertyNames(t);if(n.length!==i.length)return!1;for(let i=0;i<n.length;i++)if(e[n[i]]!==t[n[i]])return!1;return!0}(t,e),this}hasSkinAnimation(){return this._material&&this._material.hasSkinAnimation()}_getDefinesKey(){return this._bakDefines=px({},this._defines),this.dirtyDefines=!1,this._createDefinesKey(this.getDefines())}getCommandKey(e){if(!this._commandKey||this.dirtyDefines||this._material&&this._materialKeys!==this._material.getUniformKeys()){let t=this.geometry.getCommandKey(e)+"_"+this._getDefinesKey();t+="_"+(mx(this.getElements())?"count":"elements"),t+="_"+ +!!this.disableVAO,this._material&&(t+="_"+ +!!this._material.doubleSided),this._commandKey=t,this._material&&(this._materialKeys=this._material.getUniformKeys())}return this._commandKey}getRenderProps(e){const t=this.getUniforms(e);return t.meshProperties=this.properties,t.geometryProperties=this._geometry.properties,t.meshConfig=this.config,t.count=this._geometry.getDrawCount(),t.offset=this._geometry.getDrawOffset(),t.primitive=this._geometry.getPrimitive(),t}_getGeometryAttributes(e,t){return this._geometry.getREGLData(e,t,this.disableVAO)}appendGeoAttributes(e,t,n){px(e,this._getGeometryAttributes(t,n)),bx(t)&&!this.disableVAO||(e.elements=this._geometry.getElements())}getUniforms(e){if(this._dirtyUniforms||this._dirtyGeometry||this._material&&this._materialVer!==this._material.version){this._uniformDescriptors=new Set,this._realUniforms={},this._prepareUniformsForDraco();const t=this.uniforms;for(const e in this.uniforms)if(wx(this.uniforms,e)){Object.getOwnPropertyDescriptor(t,e).get?(this._uniformDescriptors.add(e),Object.defineProperty(this._realUniforms,e,{enumerable:!0,configurable:!0,get:function(){return t[e]}})):this._realUniforms[e]=t[e]}if(this._material){const t=this._material.getUniforms(e);for(const e in t)if(wx(t,e)&&!wx(this._realUniforms,e)){Object.getOwnPropertyDescriptor(t,e).get?(this._uniformDescriptors.add(e),Object.defineProperty(this._realUniforms,e,{enumerable:!0,configurable:!0,get:function(){return t[e]}})):void 0===this._realUniforms[e]&&(this._realUniforms[e]=t[e])}}this._dirtyUniforms=!1,this._dirtyGeometry=!1,this._materialVer=this._material&&this._material.version,this._materialPropVer=this._material&&this._material.propVersion,this._dirtyProps=null}else if(this._dirtyProps||this._material&&this._material.propVersion!==this._materialPropVer){if(this._dirtyProps)for(const e of this._dirtyProps)this._realUniforms[e]=this.uniforms[e];if(this._material&&this._material.propVersion!==this._materialPropVer){const t=this._material.getUniforms(e);for(const e in t)if(wx(t,e)&&!this._uniformDescriptors.has(e)){Object.getOwnPropertyDescriptor(t,e).get||this._realUniforms[e]===t[e]||(this._realUniforms[e]=t[e])}this._materialPropVer=this._material.propVersion}this._dirtyProps=null}return this._realUniforms.modelMatrix=this.localTransform,this._realUniforms.positionMatrix=this.positionMatrix,this._realUniforms}_prepareUniformsForDraco(){const e=this._geometry,t=e.data[e.desc.positionAttribute],n=e.data[e.desc.uv0Attribute],i=e.data[e.desc.normalAttribute];if(t&&t.quantization){const e=t.quantization,n=e.range/(1<<e.quantizationBits);this._realUniforms.minValues_pos=e.minValues,this._realUniforms.gltf_u_dec_position_normConstant=n}if(n&&n.quantization){const e=n.quantization;this._realUniforms.minValues_tex=e.minValues;this._realUniforms.gltf_u_dec_texcoord_0_normConstant=e.range/(1<<e.quantizationBits)}if(i&&i.quantization){this._realUniforms.gltf_u_dec_normal_rangeConstant=(1<<i.quantization.quantizationBits)-1}}getMaterial(){return this._material}getElements(){return this._geometry.getElements()}dispose(){if(delete this._geometry,delete this._material,delete this._bindGroupCache,delete this._commandKeyCache,this.uniforms=null,this._meshBuffer){for(const e in this._meshBuffer)this._meshBuffer[e].dispose();delete this._meshBuffer}return this}isValid(){return this._geometry&&!this._geometry.isDisposed()&&(!this._material||!this._material.isDisposed())}getBoundingBox(){return this._geometry?(this._bbox||this.updateBoundingBox(),vA(vw,this.localTransform,this.positionMatrix),zA(vw,this._currentTransform)&&this._geometry.boundingBox.equals(this._geoBox)||this.updateBoundingBox(),this._bboxArr):null}updateBoundingBox(){const e=this._geometry.boundingBox;this._bbox||(this._bbox=new BoundingBox),this._bboxArr||(this._bboxArr=[[0,0,0],[0,0,0]]),this._geoBox||(this._geoBox=new BoundingBox),BoundingBox.copy(this._bbox,e),this._bbox.updateVertex(),"InstancedMesh"===this.constructor.name?(this._bbox.transform(this.localTransform,this.positionMatrix),this._currentTransform=vA(this._currentTransform||new Array(16),this.positionMatrix,this.localTransform)):(this._bbox.transform(this.positionMatrix,this.localTransform),this._currentTransform=vA(this._currentTransform||new Array(16),this.localTransform,this.positionMatrix)),BoundingBox.copy(this._geoBox,e),qA(this._bboxArr[0],this._bbox.min),qA(this._bboxArr[1],this._bbox.max)}_createDefinesKey(e){const t=[];for(const n in e)t.push(n,e[n]);return t.join(",")}_incrVersion(){this._version++}getMemorySize(){return(this.geometry&&this.geometry.getMemorySize()||0)+(this.material&&this.material.getMemorySize()||0)}getWorldTransform(){const e=this.parent;return e?vA(new Array(16),e.getWorldTransform(),this.localTransform):this.localTransform}writeDynamicBuffer(e,t,n,i,s){this._meshBuffer||(this._meshBuffer={});let o=this._meshBuffer[e];return o||(o=this._meshBuffer[e]=new DynamicBuffer(n,i)),o.writeBuffer(t,s),o}getBindGroup(e){return this._bindGroupCache||(this._bindGroupCache={}),this._bindGroupCache[e]}setBindGroup(e,t){return this._bindGroupCache[e]=t,this}getShaderFnValues(e){return this._commandKeyCache?this._commandKeyCache[e]:null}setShaderFnValues(e,t){return this._commandKeyCache||(this._commandKeyCache={}),this._commandKeyCache[e]=t,this}}class InstancedMesh extends Mesh{constructor(e,t,n,i,s={}){super(n,i,s),this._instanceCount=t,this.instancedData=e||{},this._checkInstancedProp(),this._vao={}}get instanceCount(){return this._instanceCount}set instanceCount(e){this._incrVersion(),this._instanceCount=e}getMemorySize(){return super.getMemorySize()+this._getInstanceMemorySize()}_getInstanceMemorySize(){let e=0;for(const t in this.instancedData)wx(this.instancedData,t)&&(e+=Tx(this.instancedData[t]));return e}_checkInstancedProp(){for(const e in this.instancedData)if(this.geometry.data[e])throw new Error(`Duplicate attribute ${e} defined in geometry and instanced data`)}appendGeoAttributes(e,t,n){const i=this.geometry.getAttrData(n);if(bx(t)){const s=n.key;if(!this._vao[s]||this._vao[s].dirty){const e=n.map((e=>e.name)),o=[];for(let t=0;t<e.length;t++){const n=i[e[t]];o.push(n&&n.buffer||this.instancedData[e[t]])}const a={attributes:o,primitive:this.geometry.getPrimitive()};this._vao[s]?this._vao[s].vao(a):this._vao[s]={vao:t.vao(a)},delete this._vao[s].dirty}px(e,this._vao[s])}else px(e,i)}getDefines(){const e=super.getDefines();return e.HAS_INSTANCE=1,e}getCommandKey(e){return"i_"+super.getCommandKey(e)}updateInstancedData(e,t){const n=this.instancedData[e];if(this._incrVersion(),this.instancedData[e]=t,n&&n.buffer&&n.buffer.destroy&&n.buffer.destroy(),this._vao)for(const e in this._vao)this._vao[e].dirty=!0;return this}getInstancedBuffer(e){return this.instancedData[e]&&this.instancedData[e].buffer}generateInstancedBuffers(e){const t=!!e&&e.wgpu,n=this.instancedData,i=this.instanceCount,s={};for(const o in n){if(!n[o])continue;Array.isArray(n[o])?n[o]=new Float32Array(n[o]):t&&yx(n[o])&&(n[o]=Geometry.padGPUBufferAlignment(n[o],i));const a=n[o];if(void 0!==a.buffer&&a.buffer.destroy)s[o]=a,s[o].divisor&&(s[o].divisor=1);else if(n[o].destroy)s[o]={buffer:n[o],divisor:1};else{s[o]={buffer:Geometry.createBuffer(e,{data:n[o],dimension:n[o].length/this._instanceCount},o),divisor:1}}}return this.instancedData=s,this}getRenderProps(e){const t=super.getRenderProps(e);return bx(e)||px(t,this.instancedData),t.elements=this.geometry.getElements(),t.instances=this._instanceCount,t}disposeInstancedData(){const e=this.instancedData;if(e)for(const t in e){if(!e[t])continue;const n=e[t].destroy?e[t]:e[t].buffer;n.destroy&&!n[Nx]&&(n[Nx]=1,n.destroy())}this.instancedData={};for(const e in this._vao)this._vao[e].vao.destroy();this._vao={}}getBufferDescriptor(e){const t=[];for(const n in e){const i=e[n];t[i.location]=i}const n=this.instancedData,i=[];for(let s=0;s<t.length;s++){if(!t[s])continue;const o=t[s].geoAttrName,a=n[o];if(!a)continue;const l=kb(a,e[o]);l.stepMode="instance",i[s]=l}return i}}const bw={};class Renderer{constructor(e){this.device=e}render(e,t,n,i){e.setUniforms(t||bw),e.setFramebuffer(i);let s=0;if(n){const{opaques:t,transparents:i}=n.getSortedMeshes();s+=e.draw(this.device,t),s+=e.draw(this.device,i)}else s+=e.draw(this.device);return s}clear(e){this.device.clear(e)}}const ww={getArrayBuffer:(e,t)=>ww.get(e,{responseType:"arraybuffer"},t),get:function(e,t,n){const i=ww._getClient(n);if(i.open("GET",e,!0),t){for(const e in t.headers)i.setRequestHeader(e,t.headers[e]);i.withCredentials="include"===t.credentials,t.responseType&&(i.responseType=t.responseType)}return i.send(null),i},_wrapCallback:function(e,t){return function(){if(4===e.readyState)if(200===e.status)if("arraybuffer"===e.responseType){0===e.response.byteLength?t(new Error("http status 200 returned without content.")):t(null,{data:e.response,cacheControl:e.getResponseHeader("Cache-Control"),expires:e.getResponseHeader("Expires"),contentType:e.getResponseHeader("Content-Type")})}else t(null,e.responseText);else t(new Error(e.statusText+","+e.status))}},_getClient:function(e){let t;try{t=new XMLHttpRequest}catch(e){try{t=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{t=new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}}return t.onreadystatechange=ww._wrapCallback(t,e),t}};class InnerResourceLoader{constructor(e,t){this.defaultTexture=e,this.defaultCubeTexture=new Array(6),this.urlModifier=t,this.resources={}}setURLModifier(e){this.urlModifier=e}get(e){return Array.isArray(e)?this._loadImages(e):this._loadImage(e)}getArrayBuffer(e){if(Array.isArray(e)){const t=e.map((e=>this.getArrayBuffer(e)));return Promise.all(t)}return new Promise(((t,n)=>{let i=e;this.urlModifier&&(i=this.urlModifier(e)),ww.getArrayBuffer(i,((i,s)=>{i?n(i):t({url:e,data:s})}))}))}disposeRes(e){return Array.isArray(e)?e.forEach((e=>this._disposeOne(e))):this._disposeOne(e),this}isLoading(){return this._count&&this._count>0}getDefaultTexture(e){return Array.isArray(e)?this._getBlankTextures(e.length):this.defaultTexture}_disposeOne(e){const t=this.resources;t[e]&&(t[e].count--,t[e].count<=0&&delete t[e])}_loadImage(e){const t=this.resources;if(t[e])return Promise.resolve({url:e,data:t[e].image});return new Promise(((n,i)=>{const s=new Image;s.crossOrigin="anonymous",s.onload=function(){t[e]={image:s,count:1},n({url:e,data:s})},s.onerror=function(e){i(e)},s.onabort=function(){i(`image(${e}) loading aborted.`)},s.src=this.urlModifier?this.urlModifier(e):e}))}_loadImages(e){const t=e.map((e=>this._loadImage(e)));return Promise.all(t)}_getBlankTextures(e){const t=new Array(e);for(let e=0;e<6;e++)t.push(this.defaultTexture);return t}}class ResourceLoader extends(Hx(InnerResourceLoader)){}const Tw=[0,0,0],Sw=[0,0,0];let Mw,Cw=0;function Pw(e,t){return oy(Tw,e.geometry.boundingBox.getCenter(),e.localTransform),oy(Sw,t.geometry.boundingBox.getCenter(),t.localTransform),gy(Sw,Mw)-gy(Tw,Mw)}class Scene{constructor(e){this._id=Cw++,this.sortedMeshes={},this.setMeshes(e),this.dirty()}setMeshes(e){if(this.clear(),!e||Array.isArray(e)&&!e.length||e===this.meshes)return this;e=Array.isArray(e)?e:[e],this.meshes=[];for(let t=0;t<e.length;t++){const n=e[t];n&&(n._scenes=n._scenes||{},n._scenes[this._id]=1,this.meshes.push(n))}return this.dirty(),this}addMesh(e){if(!e||Array.isArray(e)&&!e.length)return this;if(Array.isArray(e))e.forEach((e=>{const t=e._scenes=e._scenes||{};t[this._id]||(t[this._id]=1,this.meshes.push(e),this.dirty())}));else{const t=e._scenes=e._scenes||{};t[this._id]||(t[this._id]=1,this.meshes.push(e),this.dirty())}return this}removeMesh(e){if(!e||Array.isArray(e)&&!e.length)return this;if(Array.isArray(e)){let t=!1;for(let n=0;n<e.length;n++){const i=e[n]._scenes;i&&i[this._id]&&(t=!0,this.dirty(),delete i[this._id])}t&&(this.meshes=this.meshes.filter((t=>e.indexOf(t)<0)))}else{const t=e._scenes;if(!t||!t[this._id])return this;const n=this.meshes.indexOf(e);n>=0&&this.meshes.splice(n,1),delete t[this._id],this.dirty()}return this}getMeshes(){return this.meshes||[]}clear(){if(this.meshes)for(let e=0;e<this.meshes.length;e++)delete this.meshes[e]._scenes[this._id];return this.meshes=[],this.sortedMeshes.opaques=[],this.sortedMeshes.transparents=[],this}dirty(){return this._dirty=!0,this}sortMeshes(e){const t=this.meshes;this.sortFunction&&t.sort(this.sortFunction);let n=this.sortedMeshes.transparents;if(this._dirty){const e=this.sortedMeshes.opaques=[];n=this.sortedMeshes.transparents=[];for(let i=0,s=t.length;i<s;i++)t[i].transparent?n.push(t[i]):e.push(t[i])}e&&n.length>1&&(Mw=e,n.sort(Pw)),this._dirty=!1}getSortedMeshes(){return this._dirty&&this.sortMeshes(),this.sortedMeshes||{}}}const Iw=String.fromCharCode,kw=8,Ow=32767;function Ew(e,t,n,i){if(e[3]>0){const s=Math.pow(2,e[3]-128-8+i);t[n+0]=e[0]*s,t[n+1]=e[1]*s,t[n+2]=e[2]*s}else t[n+0]=0,t[n+1]=0,t[n+2]=0;return t[n+3]=1,t}function Rw(e,t){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]}function Lw(e,t,n,i){let s=0,o=0,a=i;for(;a>0;)if(e[o][0]=t[n++],e[o][1]=t[n++],e[o][2]=t[n++],e[o][3]=t[n++],1===e[o][0]&&1===e[o][1]&&1===e[o][2]){for(let t=e[o][3]<<s>>>0;t>0;t--)Rw(e[o-1],e[o]),o++,a--;s+=8}else o++,a--,s=0;return n}function Dw(e,t,n,i){if(i<kw|i>Ow)return Lw(e,t,n,i);let s=t[n++];if(2!==s)return Lw(e,t,n-1,i);if(e[0][1]=t[n++],e[0][2]=t[n++],s=t[n++],(e[0][2]<<8>>>0|s)>>>0!==i)return null;for(let s=0;s<4;s++)for(let o=0;o<i;){let i=t[n++];if(i>128){i=(127&i)>>>0;const a=t[n++];for(;i--;)e[o++][s]=a}else for(;i--;)e[o++][s]=t[n++]}return n}function Fw(e,t=0){const n=new Uint8Array(e),i=n.length;if("#?"!==function(e,t,n){let i="";for(let s=t;s<n;s++)i+=Iw(e[s]);return i}(n,0,2))return null;for(var s=2;s<i&&("\n"!==Iw(n[s])||"\n"!==Iw(n[s+1]));s++);if(s>=i)return null;s+=2;let o="";for(;s<i;s++){const e=Iw(n[s]);if("\n"===e)break;o+=e}const a=o.split(" "),l=parseInt(a[1]),h=parseInt(a[3]);if(!h||!l)return null;let c=s+1;const u=[];for(let e=0;e<h;e++){u[e]=[];for(let t=0;t<4;t++)u[e][t]=0}const f=new Float32Array(h*l*4);let g=0;for(let e=0;e<l;e++){if(c=Dw(u,n,c,h),!c)return null;for(let e=0;e<h;e++)Ew(u[e],f,g,t),g+=4}return{width:h,height:l,pixels:f}}const Hw=Nw();function Nw(){const e=new ArrayBuffer(4),t=new Float32Array(e),n=new Uint32Array(e),i=new Uint32Array(512),s=new Uint32Array(512);for(let e=0;e<256;++e){const t=e-127;t<-27?(i[e]=0,i[256|e]=32768,s[e]=24,s[256|e]=24):t<-14?(i[e]=1024>>-t-14,i[256|e]=1024>>-t-14|32768,s[e]=-t-1,s[256|e]=-t-1):t<=15?(i[e]=t+15<<10,i[256|e]=t+15<<10|32768,s[e]=13,s[256|e]=13):t<128?(i[e]=31744,i[256|e]=64512,s[e]=24,s[256|e]=24):(i[e]=31744,i[256|e]=64512,s[e]=13,s[256|e]=13)}const o=new Uint32Array(2048),a=new Uint32Array(64),l=new Uint32Array(64);for(let e=1;e<1024;++e){let t=e<<13,n=0;for(;!(8388608&t);)t<<=1,n-=8388608;t&=-8388609,n+=947912704,o[e]=t|n}for(let e=1024;e<2048;++e)o[e]=939524096+(e-1024<<13);for(let e=1;e<31;++e)a[e]=e<<23;a[31]=1199570944,a[32]=2147483648;for(let e=33;e<63;++e)a[e]=2147483648+(e-32<<23);a[63]=3347054592;for(let e=1;e<64;++e)32!==e&&(l[e]=1024);return{floatView:t,uint32View:n,baseTable:i,shiftTable:s,mantissaTable:o,exponentTable:a,offsetTable:l}}const Bw={toHalfFloat:function(e){Math.abs(e)>65504&&console.warn("THREE.DataUtils.toHalfFloat(): Value out of range."),e=xx(e,-65504,65504),Hw.floatView[0]=e;const t=Hw.uint32View[0],n=t>>23&511;return Hw.baseTable[n]+((8388607&t)>>Hw.shiftTable[n])},fromHalfFloat:function(e){const t=e>>10;return Hw.uint32View[0]=Hw.mantissaTable[Hw.offsetTable[t]+(1023&e)]+Hw.exponentTable[t],Hw.floatView[0]}},zw=9728,Gw=9729,Uw=9987;var Vw=Object.freeze({__proto__:null,GL_LINEAR:Gw,GL_LINEAR_MIPMAP_LINEAR:Uw,GL_NEAREST:zw,MAG_FILTER:10240,MIN_FILTER:10241});class Texture2D extends AbstractTexture{constructor(){super(...arguments),this._version=0}get version(){return this._version}set version(e){throw new Error("Texture2D.version is read only.")}onLoad({data:e}){const t=this.config;if(t){if(t.hdr){if(!(e=Fw(e.data,0)))throw new Error("Invalid hdr data"+(t.url?":"+t.url:""));{const n=new Uint16Array(e.pixels.length);for(let t=0;t<e.pixels.length;t++)n[t]=Math.min(Bw.toHalfFloat(e.pixels[t]),65504);t.data=n,t.type="float16",t.colorSpace="browser",t.min="linear",t.mag="linear"}}else t.data=e;t.width=t.width||e.width,t.height=t.height||e.height,this._regl&&this._checkNPOT(this._regl),this._update()}}setConfig(e){const t=e.data;e.image=t,e.width=e.width||t.width,e.height=e.height||t.height,this.config=e,this.dirty=!!this._texture}_update(){this._texture&&!this._texture[Nx]&&(this._version++,dx(this._texture)?this._texture(this.config):this._texture.update(this.config)),this.dirty=!1}setMinFilter(e){this.config.min=Zb(e),this._texture&&this._texture.updateFilter&&this._texture.updateFilter(),this._texture&&this._texture.texParameteri&&this._texture.texParameteri(10241,e)}setMagFilter(e){this.config.mag=Wb(e),this._texture&&this._texture.updateFilter&&this._texture.updateFilter(),this._texture&&this._texture.texParameteri&&this._texture.texParameteri(10240,e)}createREGLTexture(e){if(this._regl=e,this._checkNPOT(e),yx(this.config.data)||yx(this.config.mipmap)){const t=Kb(e,this.config);return t[Gx]||(t[Gx]=0),t[Gx]++,t}return e.texture(this.config)}_checkNPOT(e){const t=this.config;t.data&&this._needPowerOf2(e)&&(t.data instanceof Image?(t.data=Lx(t.data),t.width=t.data.width,t.height=t.data.height):t.hdr||!yx(t.data)||Ex(t.width)&&Ex(t.height)||(t.data=Lx(t.data,t.width,t.height),t.width=t.data.width,t.height=t.data.height))}_needPowerOf2(e){if(Dx(e))return!1;const t=this.config;return t.wrap&&"clamp"!==t.wrap||t.wrapS&&"clamp"!==t.wrapS||t.wrapT&&"clamp"!==t.wrapT||t.min&&"nearest"!==t.min&&"linear"!==t.min}}class Plane extends Geometry{constructor(e){super({aPosition:new(vx(e=e||0))([-1,-1,e,1,-1,e,-1,1,e,1,1,e]),aNormal:new Int8Array([0,0,1,0,0,1,0,0,1,0,0,1])},new Uint16Array([0,1,3,3,2,0]))}}const jw={vsm_shadow_vert:"\nuniform mat4 shadow_lightProjViewModelMatrix;\nvarying vec4 shadow_vLightSpacePos;\nvoid shadow_computeShadowPars(vec4 position) {\n    shadow_vLightSpacePos = shadow_lightProjViewModelMatrix * position;\n}",vsm_shadow_frag:"\nuniform sampler2D shadow_shadowMap;\nuniform float shadow_opacity;\nuniform vec3 shadow_color;\n#if defined(USE_ESM)\n    uniform float esm_shadow_threshold;\n#endif\nvarying vec4 shadow_vLightSpacePos;\n#ifdef PACK_FLOAT\n    #include <common_pack_float>\n#endif\n#if defined(USE_ESM)\nfloat esm(vec3 projCoords, vec4 shadowTexel) {\n    float compare = projCoords.z;\n    float c = 120.0;\n    #ifdef PACK_FLOAT\n        float depth = common_decodeDepth(shadowTexel);\n        if (depth >= 1.0 - 1E-6 || compare <= depth) {\n            return 1.0;\n        }\n    #else\n        float depth = shadowTexel.r;\n    #endif\n    depth = exp(-c * min(compare - depth, 0.05));\n    return clamp(depth, esm_shadow_threshold, 1.0);\n}\n#endif\nfloat shadow_computeShadow_coeff(sampler2D shadowMap, vec3 projCoords) {\n    vec2 uv = projCoords.xy;\n    vec4 shadowTexel = texture2D(shadowMap, uv);\n    #if defined(USE_ESM)\n        float esm_coeff = esm(projCoords, shadowTexel);\n        float coeff = esm_coeff * esm_coeff;\n    #endif\n    return 1.0 - (1.0 - coeff) * shadow_opacity;\n}\nfloat shadow_computeShadow() {\n    vec3 projCoords = shadow_vLightSpacePos.xyz / shadow_vLightSpacePos.w;\n    projCoords = projCoords * 0.5 + 0.5;\n    if(projCoords.z >= 1.0 || projCoords.x < 0.0 || projCoords.x > 1.0 || projCoords.y < 0.0 || projCoords.y > 1.0) return 1.0;\n    return shadow_computeShadow_coeff(shadow_shadowMap, projCoords);\n}\nvec3 shadow_blend(vec3 color, float coeff) {\n    color = color * coeff + shadow_color * shadow_opacity * (1.0 - coeff);\n    return color;\n}",fbo_picking_vert:"\n#ifdef ENABLE_PICKING\n#if HAS_PICKING_ID == 1\n    attribute float aPickingId;\n#elif HAS_PICKING_ID == 2\n    uniform float uPickingId;\n#endif\n    varying float vPickingId;\n    varying float vFbo_picking_viewZ;\n    varying float vFbo_picking_visible;\n#endif\n    varying float vFbo_picking_fragDepth;\nvoid fbo_picking_setData(float viewPosZ, bool visible) {\n    #ifdef ENABLE_PICKING\n    #if HAS_PICKING_ID == 1\n        vPickingId = aPickingId;\n    #elif HAS_PICKING_ID == 2\n        vPickingId = uPickingId;\n    #endif\n        vFbo_picking_viewZ = viewPosZ;\n        vFbo_picking_visible = visible ? 1.0 : 0.0;\n    #endif\n    vFbo_picking_fragDepth = viewPosZ + 1.0;\n}",common_pack_float:"const float COMMON_FLOAT_MAX =  1.70141184e38;\nconst float COMMON_FLOAT_MIN = 1.17549435e-38;\nvec4 common_unpackFloat(highp float v) {\n    highp float av = abs(v);\n    if(av < COMMON_FLOAT_MIN) {\n        return vec4(0.0, 0.0, 0.0, 0.0);\n    } else if(v > COMMON_FLOAT_MAX) {\n        return vec4(127.0, 128.0, 0.0, 0.0) / 255.0;\n    } else if(v < -COMMON_FLOAT_MAX) {\n        return vec4(255.0, 128.0, 0.0, 0.0) / 255.0;\n    }\n    highp vec4 c = vec4(0,0,0,0);\n    highp float e = floor(log2(av));\n    highp float m = av * pow(2.0, -e) - 1.0;\n    c[1] = floor(128.0 * m);\n    m -= c[1] / 128.0;\n    c[2] = floor(32768.0 * m);\n    m -= c[2] / 32768.0;\n    c[3] = floor(8388608.0 * m);\n    highp float ebias = e + 127.0;\n    c[0] = floor(ebias / 2.0);\n    ebias -= c[0] * 2.0;\n    c[1] += floor(ebias) * 128.0;\n    c[0] += 128.0 * step(0.0, -v);\n    return c / 255.0;\n}\nvec4 common_encodeDepth(const in float depth) {\n    float alpha = 1.0;\n    vec4 pack = vec4(0.0);\n    pack.a = alpha;\n    const vec3 code = vec3(1.0, 255.0, 65025.0);\n    pack.rgb = vec3(code * depth);\n    pack.gb = fract(pack.gb);\n    pack.rg -= pack.gb * (1.0 / 256.0);\n    pack.b -= mod(pack.b, 4.0 / 255.0);\n    return pack;\n}\nfloat common_decodeDepth(const in vec4 pack) {\n    return pack.r + pack.g / 255.0;\n}\nvec4 encodeFloat32(float f) {\n    float e =5.0;\n    float F = abs(f);\n    float Sign = step(0.0,-f);\n    float Exponent = floor(log2(F));\n    float Mantissa = (exp2(- Exponent) * F);\n    Exponent = floor(log2(F) + 127.0) + floor(log2(Mantissa));\n    vec4 rgba;\n    rgba[0] = 128.0 * Sign  + floor(Exponent*exp2(-1.0));\n    rgba[1] = 128.0 * mod(Exponent,2.0) + mod(floor(Mantissa*128.0),128.0);\n    rgba[2] = floor(mod(floor(Mantissa*exp2(23.0 -8.0)),exp2(8.0)));\n    rgba[3] = floor(exp2(23.0)*mod(Mantissa,exp2(-15.0)));\n    return rgba / 255.0;\n}\nfloat decodeFloat32(vec4 rgba) {\n    rgba *= 255.0;\n    float Sign = 1.0 - step(128.0,rgba[0])*2.0;\n    float Exponent = 2.0 * mod(rgba[0],128.0) + step(128.0,rgba[1]) - 127.0;\n    float Mantissa = mod(rgba[1],128.0)*65536.0 + rgba[2]*256.0 +rgba[3] + float(0x800000);\n    float Result =  Sign * exp2(Exponent) * (Mantissa * exp2(-23.0 ));\n    return Result;\n}",invert_matrix:"mat4 invert_matrix(mat4 matrix) {\n    #if __VERSION__ == 300\n        return inverse(matrix);\n    #else\n        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];\n        float a00 = vector1.x, a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;\n        float a10 = vector2.x, a11 = vector2.y, a12 = vector2.z, a13 = vector2.w;\n        float a20 = vector3.x, a21 = vector3.y, a22 = vector3.z, a23 = vector3.w;\n        float a30 = vector4.x, a31 = vector4.y, a32 = vector4.z, a33 = vector4.w;\n        float b00 = a00 * a11 - a01 * a10;\n        float b01 = a00 * a12 - a02 * a10;\n        float b02 = a00 * a13 - a03 * a10;\n        float b03 = a01 * a12 - a02 * a11;\n        float b04 = a01 * a13 - a03 * a11;\n        float b05 = a02 * a13 - a03 * a12;\n        float b06 = a20 * a31 - a21 * a30;\n        float b07 = a20 * a32 - a22 * a30;\n        float b08 = a20 * a33 - a23 * a30;\n        float b09 = a21 * a32 - a22 * a31;\n        float b10 = a21 * a33 - a23 * a31;\n        float b11 = a22 * a33 - a23 * a32;\n        float det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n        det = 1.0 / det;\n        mat4 m = mat4(\n            (a11 * b11 - a12 * b10 + a13 * b09) * det,\n            (a02 * b10 - a01 * b11 - a03 * b09) * det,\n            (a31 * b05 - a32 * b04 + a33 * b03) * det,\n            (a22 * b04 - a21 * b05 - a23 * b03) * det,\n            (a12 * b08 - a10 * b11 - a13 * b07) * det,\n            (a00 * b11 - a02 * b08 + a03 * b07) * det,\n            (a32 * b02 - a30 * b05 - a33 * b01) * det,\n            (a20 * b05 - a22 * b02 + a23 * b01) * det,\n            (a10 * b10 - a11 * b08 + a13 * b06) * det,\n            (a01 * b08 - a00 * b10 - a03 * b06) * det,\n            (a30 * b04 - a31 * b02 + a33 * b00) * det,\n            (a21 * b02 - a20 * b04 - a23 * b00) * det,\n            (a11 * b07 - a10 * b09 - a12 * b06) * det,\n            (a00 * b09 - a01 * b07 + a02 * b06) * det,\n            (a31 * b01 - a30 * b03 - a32 * b00) * det,\n            (a20 * b03 - a21 * b01 + a22 * b00) * det\n        );\n        return m;\n    #endif\n}\nmat4 transpose_matrix(mat4 matrix) {\n    #if __VERSION__ == 300\n        return transpose(matrix);\n    #else\n        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];\n        float a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;\n        float a12 = vector2.z, a13 = vector2.w;\n        float a23 = vector3.w;\n        mat4 m = mat4(\n            vector1.x,\n            vector2.x,\n            vector3.x,\n            vector4.x,\n            a01,\n            vector2.y,\n            vector3.y,\n            vector4.y,\n            a02,\n            a12,\n            vector3.z,\n            vector4.z,\n            a03,\n            a13,\n            a23,\n            vector4.w\n        );\n        return m;\n    #endif\n}",get_output:"#include <invert_matrix>\n#include <draco_decode_vert>\n#ifdef HAS_INSTANCE\n    #include <instance_vert>\n    #ifdef HAS_INSTANCE_COLOR\n        varying vec4 vInstanceColor;\n    #endif\n#endif\n#ifdef HAS_SKIN\n    uniform int skinAnimation;\n    #include <skin_vert>\n#endif\n#include <mask_vert>\n#ifdef HAS_MORPH\n    attribute vec3 POSITION0;\n    attribute vec3 POSITION1;\n    attribute vec3 POSITION2;\n    attribute vec3 POSITION3;\n    attribute vec3 POSITION4;\n    attribute vec3 POSITION5;\n    attribute vec3 POSITION6;\n    attribute vec3 POSITION7;\n    #ifdef HAS_MORPHNORMALS\n        attribute vec3 NORMAL0;\n        attribute vec3 NORMAL1;\n        attribute vec3 NORMAL2;\n        attribute vec3 NORMAL3;\n    #endif\n    uniform vec4 morphWeights1;\n    uniform vec4 morphWeights2;\n#endif\n#ifdef HAS_TERRAIN_ALTITUDE\nattribute float aTerrainAltitude;\n#endif\nmat4 getPositionMatrix() {\n    mat4 worldMatrix;\n    #ifdef HAS_INSTANCE\n        #ifdef HAS_INSTANCE_COLOR\n            vInstanceColor = instance_getInstanceColor();\n        #endif\n        mat4 attributeMatrix = instance_getAttributeMatrix();\n        #ifdef HAS_SKIN\n            if (skinAnimation == 1) {\n                worldMatrix = attributeMatrix * positionMatrix * skin_getSkinMatrix();\n            } else {\n                worldMatrix = attributeMatrix * positionMatrix;\n            }\n        #else\n            worldMatrix = attributeMatrix * positionMatrix;\n        #endif\n    #else\n        #ifdef HAS_SKIN\n            if (skinAnimation == 1) {\n                worldMatrix = skin_getSkinMatrix() * positionMatrix;\n            } else {\n                worldMatrix = positionMatrix;\n            }\n        #else\n            worldMatrix = positionMatrix;\n        #endif\n    #endif\n    return worldMatrix;\n}\n#ifdef HAS_MIN_ALTITUDE\n    uniform float minAltitude;\n#endif\n#ifdef HAS_TERRAIN_FLAT_MASK\n    uniform sampler2D flatMask;\n#endif\nvec4 getPosition(vec3 aPosition) {\n    vec3 position = decode_getPosition(aPosition);\n    #ifdef HAS_MORPH\n        vec4 POSITION = vec4(position + morphWeights1[0] * POSITION0 + morphWeights1[1] * POSITION1 + morphWeights1[2] * POSITION2 + morphWeights1[3] * POSITION3\n        + morphWeights2[0] * POSITION4 + morphWeights2[1] * POSITION5 + morphWeights2[2] * POSITION6 + morphWeights2[3] * POSITION7\n        , 1.0);\n    #else\n        vec4 POSITION = vec4(position, 1.0);\n    #endif\n    #ifdef HAS_TERRAIN_ALTITUDE\n        POSITION.z += aTerrainAltitude * 100.0;\n    #endif\n    #ifdef HAS_TERRAIN_FLAT_MASK\n        vec2 uv = aTexCoord;\n        uv.y = 1.0 - uv.y;\n        vec4 encodedHeight = texture2D(flatMask, uv);\n        if (length(encodedHeight) < 2.0) {\n            float maskHeight = decodeFloat32(encodedHeight);\n            POSITION.z = min(POSITION.z, maskHeight);\n        }\n    #endif\n    #ifdef HAS_MIN_ALTITUDE\n        POSITION.z += minAltitude * 100.0;\n    #endif\n    return POSITION;\n}\nvec3 appendMorphNormal(vec3 NORMAL) {\n    #ifdef HAS_MORPHNORMALS\n        vec3 normal = NORMAL + morphWeights1[0] * NORMAL0 + morphWeights1[1] * NORMAL1 + morphWeights1[2] * NORMAL2 + morphWeights1[3] * NORMAL3;\n    #else\n        vec3 normal = NORMAL;\n    #endif\n    return normal;\n}",instance_vert:"attribute vec4 instance_vectorA;\nattribute vec4 instance_vectorB;\nattribute vec4 instance_vectorC;\n#ifdef HAS_INSTANCE_TERRAIN_ALTITUDE\nattribute float aTerrainAltitude;\nuniform float terrainAltitudeScale;\n#endif\nmat4 instance_getAttributeMatrix() {\n    mat4 mat =  mat4(\n        instance_vectorA.x, instance_vectorB.x, instance_vectorC.x, 0.0,\n        instance_vectorA.y, instance_vectorB.y, instance_vectorC.y, 0.0,\n        instance_vectorA.z, instance_vectorB.z, instance_vectorC.z, 0.0,\n        instance_vectorA.w, instance_vectorB.w, instance_vectorC.w, 1.0\n    );\n    #ifdef HAS_INSTANCE_TERRAIN_ALTITUDE\n        mat4 terrainMat = mat4(\n            1., 0., 0., 0.,\n            0., 1., 0., 0.,\n            0., 0., 1., 0.,\n            0., 0., aTerrainAltitude * terrainAltitudeScale, 1.\n        );\n        mat = terrainMat * mat;\n    #endif\n    return mat;\n}\n#ifdef HAS_INSTANCE_HIGHLIGHT\n    attribute vec4 highlight_color;\n#endif\n#ifdef HAS_INSTANCE_COLOR\n   \n    attribute vec4 instance_color;\n    vec4 instance_getInstanceColor() {\n        vec4 color = instance_color;\n        #ifdef HAS_INSTANCE_HIGHLIGHT\n            color = instance_color * highlight_color;\n        #endif\n        return color;\n    }\n#endif",skin_vert:"attribute vec4 WEIGHTS_0;\nattribute vec4 JOINTS_0;\nuniform sampler2D jointTexture;\nuniform vec2 jointTextureSize;\nuniform float numJoints;\n#define ROW0_U ((0.5 + 0.0) / 4.)\n#define ROW1_U ((0.5 + 1.0) / 4.)\n#define ROW2_U ((0.5 + 2.0) / 4.)\n#define ROW3_U ((0.5 + 3.0) / 4.)\nmat4 skin_getBoneMatrix(float jointNdx) {\n    float v = (jointNdx + 0.5) / numJoints;\n    return mat4(\n        texture2D(jointTexture, vec2(ROW0_U, v)),\n        texture2D(jointTexture, vec2(ROW1_U, v)),\n        texture2D(jointTexture, vec2(ROW2_U, v)),\n        texture2D(jointTexture, vec2(ROW3_U, v)));\n}\nmat4 skin_getSkinMatrix() {\n        mat4 skinMatrix = skin_getBoneMatrix(JOINTS_0[0]) * WEIGHTS_0[0] +\n                        skin_getBoneMatrix(JOINTS_0[1]) * WEIGHTS_0[1] +\n                        skin_getBoneMatrix(JOINTS_0[2]) * WEIGHTS_0[2] +\n                        skin_getBoneMatrix(JOINTS_0[3]) * WEIGHTS_0[3];\n        return skinMatrix;\n}",heatmap_render_vert:"#ifdef HAS_HEATMAP\nvarying vec2 heatmap_vTexCoord;\nvoid heatmap_compute(mat4 matrix, vec3 position) {\n    vec4 pos = matrix * vec4(position.xy, 0., 1.);\n    heatmap_vTexCoord = (1. + pos.xy / pos.w) / 2.;\n}\n#endif",heatmap_render_frag:"#ifdef HAS_HEATMAP\nuniform sampler2D heatmap_inputTexture;\nuniform sampler2D heatmap_colorRamp;\nuniform float heatmap_heatmapOpacity;\nvarying vec2 heatmap_vTexCoord;\nvec4 heatmap_getColor(vec4 color) {\n    float t = texture2D(heatmap_inputTexture, heatmap_vTexCoord).r;\n    vec4 heatmapColor = texture2D(heatmap_colorRamp, vec2(t, 0.5)) * heatmap_heatmapOpacity;\n    return color * (1.0 - heatmapColor.a) + heatmapColor * heatmapColor.a;\n}\n#endif",line_extrusion_vert:"#ifdef IS_LINE_EXTRUSION\n    #define ALTITUDE_SCALE 32767.0;\n    #define EXTRUDE_SCALE 63.0;\n    attribute vec2 aExtrude;\n    #ifdef HAS_LINE_WIDTH\n        attribute float aLineWidth;\n    #else\n        uniform float lineWidth;\n    #endif\n    #ifdef HAS_LINE_HEIGHT\n        attribute float aLineHeight;\n    #else\n        uniform float lineHeight;\n    #endif\n    uniform float linePixelScale;\n    vec3 getLineExtrudePosition(vec3 position) {\n        #ifdef HAS_LINE_WIDTH\n            float lineWidth = aLineWidth / 2.0;\n        #endif\n        #ifdef HAS_LINE_HEIGHT\n            float lineHeight = aLineHeight / 10.0;\n        #endif\n        float halfwidth = lineWidth / 2.0;\n        float outset = halfwidth;\n        vec2 dist = outset * aExtrude / EXTRUDE_SCALE;\n        position.z *= lineHeight / ALTITUDE_SCALE;\n        return position + vec3(dist, 0.0) * linePixelScale;\n    }\n#endif",gl2_vert:"#if __VERSION__ == 300\n    #define texture2D texture\n    #define varying out\n    #define attribute in\n#endif",gl2_frag:"#if __VERSION__ == 300\n    #define varying in\n    #define gl_FragDepthEXT gl_FragDepth\n    #define texture2D texture\n    #define textureCube texture\n    #define texture2DProj textureProj\n    #define texture2DLodEXT textureLod\n    #define texture2DProjLodEXT textureProjLod\n    #define textureCubeLodEXT textureLod\n    #define texture2DGradEXT textureGrad\n    #define texture2DProjGradEXT textureProjGrad\n    #define textureCubeGradEXT textureGrad\n    out vec4 glFragColor;\n#else\n    vec4 glFragColor;\n#endif",hsv_frag:"\nconst mediump vec4 HSV_K0 = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\nconst mediump vec4 HSV_K1 = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\nconst mediump float HSV_E = 1.0e-10;\nvec3 hsv_rgb2hsv(vec3 c) {\n    vec4 K = HSV_K0;\n    vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\n    vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\n    float d = q.x - min(q.w, q.y);\n    float e = HSV_E;\n    return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\n}\nvec3 hsv_hsv2rgb(vec3 c) {\n    vec4 K = HSV_K1;\n    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n}\nvec4 hsv_apply(vec4 c, vec3 hsvOffset) {\n    vec3 hsv = hsv_rgb2hsv(c.rgb);\n    hsv += hsv * hsvOffset;\n    hsv = clamp(hsv, 0.0, 1.0);\n    return vec4(hsv_hsv2rgb(hsv), c.a);\n}\nvec3 hsv_apply(vec3 c, vec3 hsvOffset) {\n    vec3 hsv = hsv_rgb2hsv(c.rgb);\n    hsv += hsv * hsvOffset;\n    hsv = clamp(hsv, 0.0, 1.0);\n    return hsv_hsv2rgb(hsv);\n}\nmat4 contrastMatrix(float contrast)\n{\n    float t = (1.0 - contrast) / 2.0;\n    return mat4(\n        contrast, 0., 0., 0.,\n        0., contrast, 0., 0.,\n        0., 0., contrast, 0.,\n        t, t, t, 1\n    );\n}",snow_frag:"#ifdef HAS_SNOW\n    float lerp(float a, float b, float w) {\n        return a + w * (b - a);\n    }\n    vec3 snow(vec4 sceneColor, vec3 normalColor, float height) {\n        float snowIntense = normalColor.b;\n        vec3 fixedC = vec3(1.0, 1.0, 1.0);\n        if (height < 1.0) {\n            float r = lerp(0.5, fixedC.x, snowIntense);\n            float g = lerp(0.5, fixedC.y, snowIntense);\n            float b = lerp(0.5, fixedC.z, snowIntense);\n            return vec3(r, g, b);\n        } else {\n            float r = lerp(sceneColor.r, fixedC.x, snowIntense);\n            float g = lerp(sceneColor.g, fixedC.y, snowIntense);\n            float b = lerp(sceneColor.b, fixedC.z, snowIntense);\n            return vec3(r, g, b);\n        }\n    }\n#endif",draco_decode_vert:"#if defined(HAS_TANGENT)\n    attribute vec4 aTangent;\n#elif defined(HAS_NORMAL)\n    #ifdef HAS_DRACO_NORMAL\n        attribute vec2 aNormal;\n        uniform float gltf_u_dec_normal_rangeConstant;\n    #else\n        attribute vec3 aNormal;\n    #endif\n#endif\n#ifdef HAS_DRACO_POSITION\n    uniform float gltf_u_dec_position_normConstant;\n    uniform vec3 minValues_pos;\n    vec3 decodeDracoPosition(vec3 aPosition) {\n        return minValues_pos + aPosition * gltf_u_dec_position_normConstant;\n    }\n#endif\n#ifdef HAS_DRACO_TEXCOORD\n    uniform vec2 minValues_tex;\n    uniform float gltf_u_dec_texcoord_0_normConstant;\n    vec2 decodeDracoTexcoord(vec2 aTexCoord) {\n        return minValues_tex + aTexCoord * gltf_u_dec_texcoord_0_normConstant;\n    }\n#endif\n#ifdef HAS_WEB3D_quantized_attributes_TEXCOORD\n    uniform mat3 decodeMatrix;\n#endif\n#ifdef HAS_DRACO_NORMAL\n    float czm_signNotZero(float value) {\n        return value >= 0.0 ? 1.0 : -1.0;\n    }\n    vec2 czm_signNotZero(vec2 value) {\n        return vec2(czm_signNotZero(value.x), czm_signNotZero(value.y));\n    }\n    vec3 decodeDracoNormal(vec2 encoded, float range)\n    {\n        if (encoded.x == 0.0 && encoded.y == 0.0) {\n            return vec3(0.0, 0.0, 0.0);\n        }\n        encoded = encoded / range * 2.0 - 1.0;\n        vec3 v = vec3(encoded.x, encoded.y, 1.0 - abs(encoded.x) - abs(encoded.y));\n        if (v.z < 0.0) {\n            v.xy = (1.0 - abs(v.yx)) * czm_signNotZero(v.xy);\n        }\n        return normalize(v);\n    }\n    vec3 decode_getNormal(vec2 aNormal) {\n        return decodeDracoNormal(aNormal, gltf_u_dec_normal_rangeConstant).zxy;\n    }\n#endif\n#ifdef HAS_COMPRESSED_INT16\n    #ifdef HAS_COMPRESSED_INT16_POSITION\n      uniform vec2 compressedPositionRange;\n    #endif\n    #ifdef HAS_COMPRESSED_INT16_TEXCOORD_0\n      uniform vec2 compressedTexcoordRange_0;\n    #endif\n    #ifdef HAS_COMPRESSED_INT16_TEXCOORD_1\n      uniform vec2 compressedTexcoordRange_1;\n    #endif\n    #ifdef HAS_COMPRESSED_INT16_NORMAL\n      uniform vec2 compressedNormalRange;\n    #endif\n    #ifdef HAS_COMPRESSED_INT16_RATIO\n      uniform float compressed_ratio;\n    #endif\n    float int16ToFloat32(float value, vec2 range) {\n        float v = (value >= 32768.0) ? -(65536.0 - value) / 32768.0 : value / 32767.0;\n        return (v + 1.0) * (range.y - range.x) / 2.0 + range.x;\n    }\n#endif\nvec3 decode_getPosition(vec3 aPosition) {\n    vec3 position = aPosition;\n    #if defined(HAS_COMPRESSED_INT16) && defined(HAS_COMPRESSED_INT16_POSITION)\n        float x = int16ToFloat32(aPosition.x, compressedPositionRange);\n        float y = int16ToFloat32(aPosition.y, compressedPositionRange);\n        float z = int16ToFloat32(aPosition.z, compressedPositionRange);\n        #ifdef HAS_COMPRESSED_INT16_RATIO\n          position = vec3(x / compressed_ratio, y / compressed_ratio, z);\n        #else\n          position = vec3(x, y, z);\n        #endif\n    #endif\n    #ifdef HAS_DRACO_POSITION\n        return decodeDracoPosition(position);\n    #else\n        return position;\n    #endif\n}\nvec2 decode_getTexcoord(vec2 aTexCoord) {\n    vec2 texcoord = aTexCoord;\n    #if defined(HAS_COMPRESSED_INT16) && (defined(HAS_COMPRESSED_INT16_TEXCOORD_0) || defined(HAS_COMPRESSED_INT16_TEXCOORD_1))\n        float x = int16ToFloat32(aTexCoord.x, compressedTexcoordRange_0);\n        float y = int16ToFloat32(aTexCoord.y, compressedTexcoordRange_0);\n        texcoord = vec2(x, y);\n    #endif\n    #ifdef HAS_DRACO_TEXCOORD\n        return decodeDracoTexcoord(texcoord);\n    #elif defined(HAS_WEB3D_quantized_attributes_TEXCOORD)\n        vec3 web3dTexcoord = decodeMatrix * vec3(texcoord, 1.0);\n        return vec2(web3dTexcoord.x, web3dTexcoord.y);\n    #else\n        return texcoord;\n    #endif\n}\nvec3 decode_getNormal(vec3 aNormal) {\n    #ifdef HAS_COMPRESSED_INT16_NORMAL\n        aNormal.x = int16ToFloat32(aNormal.x, compressedNormalRange);\n        aNormal.y = int16ToFloat32(aNormal.y, compressedNormalRange);\n        aNormal.z = int16ToFloat32(aNormal.z, compressedNormalRange);\n    #endif\n    return aNormal;\n}",highlight_vert:"#if defined(HAS_HIGHLIGHT_COLOR)\n    attribute vec4 aHighlightColor;\n    varying vec4 vHighlightColor;\n#endif\n#if defined(HAS_HIGHLIGHT_OPACITY)\n    attribute float aHighlightOpacity;\n    varying float vHighlightOpacity;\n#endif\nvoid highlight_setVarying() {\n    #if defined(HAS_HIGHLIGHT_COLOR)\n        vHighlightColor = aHighlightColor / 255.0;\n    #endif\n    #if defined(HAS_HIGHLIGHT_OPACITY)\n        vHighlightOpacity = aHighlightOpacity / 255.0;\n    #endif\n}",highlight_frag:"#if defined(HAS_HIGHLIGHT_COLOR)\n\tvarying vec4 vHighlightColor;\n#endif\n#if defined(HAS_HIGHLIGHT_OPACITY)\n    varying float vHighlightOpacity;\n#endif\nvec4 highlight_blendColor(vec4 color) {\n\tvec4 outColor;\n\t#if defined(HAS_HIGHLIGHT_COLOR)\n\t\tcolor.rgb = color.rgb * (1.0 - vHighlightColor.a) + vHighlightColor.rgb * vHighlightColor.a;\n\t\t#ifndef HAS_HIGHLIGHT_COLOR_POINT\n        \tcolor.a = color.a * (1.0 - vHighlightColor.a) + vHighlightColor.a;\n        #endif\n        outColor = color;\n\t#else\n\t\toutColor = color;\n\t#endif\n\t#if defined(HAS_HIGHLIGHT_OPACITY)\n\t\toutColor *= vHighlightOpacity;\n\t#endif\n\treturn outColor;\n}",mask_vert:"#ifdef HAS_MASK_EXTENT\n    uniform vec4 mask_extent;\n    uniform sampler2D mask_colorExtent;\n    uniform sampler2D mask_modeExtent;\n    uniform float mask_maskMode;\n    uniform float mask_hasFlatOut;\n    uniform mat4 viewMatrix;\n    uniform float mask_heightRatio;\n    uniform float mask_heightOffset;\n    varying vec4 vWorldPosition;\n    varying vec2 vUVInExtent;\n    varying float vHeightRatio;\n    varying float vHeightOffset;\n    const float CLIPINSIDE_MODE = 0.2;\n    const float FLATINSIDE_MODE = 0.3;\n    const float FLATOUTSIDE_MODE = 0.4;\n    const float ELEVATE_MODE = 0.7;\n    float random (vec2 st) {\n        return fract(sin(dot(st.xy,vec2(12.9898,78.233)))*43758.5453123) * 0.1;\n    }\n    bool isInExtent(vec4 color) {\n        return length(color.rgb) > 0.0;\n    }\n    float getFlatHeight(float maskMode, float flatHeight, float height) {\n      if (maskMode <= ELEVATE_MODE && maskMode > 0.6) {\n          return flatHeight + height;\n      } else {\n        return flatHeight;\n      }\n    }\n    vec4 getNoErrorPosition(vec4 position, vec4 wPosition) {\n      vec4 realPos = modelViewMatrix * position;      vec4 pos = viewMatrix * wPosition;      vec4 tempPos = viewMatrix * modelMatrix * position;      float deltaX = realPos.x - tempPos.x;\n      float deltaY = realPos.y - tempPos.y;\n      float deltaZ = realPos.z - tempPos.z;\n      pos.x = pos.x + deltaX;\n      pos.y = pos.y + deltaY;\n      pos.z = pos.z + deltaZ;\n      return pos;\n    }\n    vec4 getMaskPosition(vec4 position, mat4 modelMatrix) {\n        vWorldPosition = modelMatrix * position;\n        float w = mask_extent.z - mask_extent.x;\n        float h = mask_extent.y - mask_extent.w;\n        vec2 uvInExtent = vec2((vWorldPosition.x - mask_extent.x) / abs(w), 1.0 - (vWorldPosition.y - mask_extent.w) / h);\n        vec4 extentColor = texture2D(mask_colorExtent, uvInExtent);\n        vec3 maskOptionColor = texture2D(mask_modeExtent, uvInExtent).rgb;\n        float maskMode = maskOptionColor.r;\n        float flatHeight = maskOptionColor.g / mask_heightRatio + mask_heightOffset;\n        float height = getFlatHeight(maskMode, flatHeight, vWorldPosition.z);\n        vec4 wPosition = vec4(vWorldPosition.x, vWorldPosition.y, height, vWorldPosition.w);\n        vUVInExtent = uvInExtent;\n        vHeightRatio = mask_heightRatio;\n        vHeightOffset = mask_heightOffset;\n        if (maskMode <= FLATOUTSIDE_MODE && maskMode > FLATINSIDE_MODE) {\n            return modelViewMatrix * position;;\n        } else if (mask_hasFlatOut == 1.0) {\n            return getNoErrorPosition(position, wPosition);\n        }\n        if (isInExtent(extentColor) == true && maskMode <= FLATINSIDE_MODE && maskMode > CLIPINSIDE_MODE) {\n            return getNoErrorPosition(position, wPosition);\n        } if (isInExtent(extentColor) == true && maskMode <= ELEVATE_MODE && maskMode > 0.6) {\n            return getNoErrorPosition(position, wPosition);\n        } else {\n            return modelViewMatrix * position;\n        }\n    }\n#endif",mask_frag:"#ifdef HAS_MASK_EXTENT\n    uniform sampler2D mask_colorExtent;\n    uniform sampler2D mask_modeExtent;\n    uniform float mask_hasClipOut;\n    varying float vHeightRatio;\n    varying float vHeightOffset;\n    varying vec2 vUVInExtent;\n    varying vec4 vWorldPosition;\n    const float CLIPINSIDE_MODE = 0.1;\n    const float CLIPOUTSIDE_MODE = 0.2;\n    const float FLATINSIDE_MODE = 0.3;\n    const float FLATOUTSIDE_MODE = 0.4;\n    const float COLOR_MODE = 0.5;\n    const float VIDEO_MODE = 0.6;\n    bool isInExtent(vec4 color) {\n        return length(color.rgb) > 0.0;\n    }\n    vec4 setMask(vec4 glFragColor) {\n        vec4 extentColor = texture2D(mask_colorExtent, vUVInExtent);\n        vec4 modeColor = texture2D(mask_modeExtent, vUVInExtent);\n        float maskMode = modeColor.r;\n        float minHeight = modeColor.b / vHeightRatio + vHeightOffset;\n        float maxHeight = modeColor.a / vHeightRatio + vHeightOffset;\n        if (maskMode > CLIPINSIDE_MODE && maskMode <= CLIPOUTSIDE_MODE) {\n            if (minHeight == 0.0 && maxHeight == 0.0) {\n                return glFragColor;\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\n                return glFragColor;\n            } else {\n              discard;\n            }\n        } else if (mask_hasClipOut == 1.0) {\n            discard;\n        }\n        if (isInExtent(extentColor) == true && maskMode <= CLIPINSIDE_MODE && maskMode > 0.0) {\n            if (minHeight == 0.0 && maxHeight == 0.0) {\n                discard;\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\n                discard;\n            } else {\n              return glFragColor;\n            }\n        } else if (isInExtent(extentColor) == true && maskMode <= VIDEO_MODE && maskMode > FLATOUTSIDE_MODE) {\n            if (minHeight == 0.0 && maxHeight == 0.0) {\n                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\n                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);\n            }\n        }\n        return glFragColor;\n    }\n#endif",compute_texcoord_frag:"#ifdef HAS_KHR_TEXTURE_TRANSFORM\n    uniform vec2 khr_offset;\n    uniform float khr_rotation;\n    uniform vec2 khr_scale;\n    vec2 khr_tex_transformTexCoord(vec2 texCoords, vec2 offset, float rotation, vec2 scale) {\n        rotation = -rotation;\n        mat3 transform = mat3(\n        cos(rotation) * scale.x, sin(rotation) * scale.x, 0.0, -sin(rotation) * scale.y, cos(rotation) * scale.y, 0.0, offset.x, offset.y, 1.0);\n        vec2 transformedTexCoords = (transform * vec3(fract(texCoords), 1.0)).xy;\n        return transformedTexCoords;\n    }\n#endif\nvarying highp vec2 vTexCoord;\n#ifdef HAS_I3S_UVREGION\n    varying vec4 vUvRegion;\n#endif\nvec2 computeTexCoord(vec2 texCoord) {\n    #ifdef HAS_I3S_UVREGION\n        vec2 atlasScale = vUvRegion.zw - vUvRegion.xy;\n        vec2 uvAtlas = fract(texCoord) * atlasScale + vUvRegion.xy;\n        return uvAtlas;\n    #elif defined(HAS_KHR_TEXTURE_TRANSFORM)\n        return khr_tex_transformTexCoord(texCoord, khr_offset, khr_rotation, khr_scale);\n    #else\n        return texCoord;\n    #endif\n}",terrain_normal_frag:"#ifdef HAS_TERRAIN_NORMAL\n    uniform sampler2D terrainHeightTexture;\n    uniform vec2 terrainHeightMapResolution;\n    uniform vec2 terrainResolution;\n    uniform vec4 terrainUnpackFactors;\n    float getHeight(vec2 uv) {\n        vec4 color = texture2D(terrainHeightTexture, uv) * 255.0;\n        color.a = -1.0;\n        return dot(color, terrainUnpackFactors) / 4.0;\n    }\n    vec3 convertTerrainHeightToNormalMap(vec2 uv) {\n        uv.y = 1.0 - uv.y;\n        vec2 epsilon = 1.0 / terrainHeightMapResolution;\n        float a = getHeight(uv + vec2(-epsilon.x, -epsilon.y));\n        float b = getHeight(uv + vec2(0, -epsilon.y));\n        float c = getHeight(uv + vec2(epsilon.x, -epsilon.y));\n        float d = getHeight(uv + vec2(-epsilon.x, 0));\n        float e = getHeight(uv + vec2(epsilon.x, 0));\n        float f = getHeight(uv + vec2(-epsilon.x, epsilon.y));\n        float g = getHeight(uv + vec2(0, epsilon.y));\n        float h = getHeight(uv + vec2(epsilon.x, epsilon.y));\n        vec2 dxy = vec2(\n            (c + e + e + h) - (a + d + d + f),\n            (f + g + g + h) - (a + b + b + c)\n        );\n        return normalize(vec3(dxy / epsilon, terrainResolution ));\n    }\n#endif",vertex_color_vert:"#ifdef HAS_VERTEX_COLOR\nattribute float aVertexColorType;\nuniform vec4 vertexColorsOfType[VERTEX_TYPES_COUNT];\nvarying vec4 vertexColor_color;\nvoid vertexColor_update() {\n    vertexColor_color = vertexColorsOfType[int(aVertexColorType)];\n}\n#endif\n//用于识别顶点颜色类型: topPolygonFill 还是 bottomPolygonFill",vertex_color_frag:"#ifdef HAS_VERTEX_COLOR\nvarying vec4 vertexColor_color;\nvec4 vertexColor_get() {\n\treturn vertexColor_color;\n}\n#endif",excavate_vert:"#ifdef HAS_EXCAVATE_ANALYSIS\n  uniform vec4 excavateExtent;\n  varying vec2 vCoordinateTexcoord;\n  varying float vExcavateHeight;\n  float getWorldHeight(vec4 localPosition) {\n    vec4 wPosition = modelMatrix * localPosition;\n    return wPosition.z;\n  }\n  vec2 getCoordinateTexcoord(vec4 localPosition) {\n    vec4 wPosition = modelMatrix * localPosition;\n    float x = (wPosition.x - excavateExtent.x) / (excavateExtent.z - excavateExtent.x);\n    float y = (wPosition.y - excavateExtent.y) / (excavateExtent.w - excavateExtent.y);\n    return vec2(x, y);\n  }\n#endif",excavate_frag:"#ifdef HAS_EXCAVATE_ANALYSIS\n  uniform sampler2D heightmap;\n  uniform float excavateHeight;\n  varying vec2 vCoordinateTexcoord;\n  varying float vExcavateHeight;\n  const vec2 range = vec2(-100.0, 1000.0);\n  float decodeHeight(const in vec4 pack) {\n      return pack.r + pack.g / 255.0;\n  }\n  vec4 excavateColor(vec4 fragColor) {\n      float samplerHeight = decodeHeight(texture2D(heightmap, vCoordinateTexcoord));\n      float realHeight = samplerHeight * (range.y - range.x) + range.x;\n      if(realHeight < range.x || realHeight > range.y) {\n          realHeight = 0.0;\n      }\n      if(vExcavateHeight > realHeight) {\n          discard;\n      }\n      return fragColor;\n  }\n#endif",srgb_frag:"vec3 linearTosRGB(const in vec3 color) {\n    return vec3(\n        color.r < 0.0031308 ? color.r * 12.92 : 1.055 * pow(color.r, 1.0/2.4) - 0.055,\n        color.g < 0.0031308 ? color.g * 12.92 : 1.055 * pow(color.g, 1.0/2.4) - 0.055,\n        color.b < 0.0031308 ? color.b * 12.92 : 1.055 * pow(color.b, 1.0/2.4) - 0.055\n    );\n}\nvec3 sRGBToLinear(const in vec3 color) {\n    return vec3(\n        color.r < 0.04045 ? color.r * (1.0 / 12.92) : pow((color.r + 0.055) * (1.0 / 1.055), 2.4),\n        color.g < 0.04045 ? color.g * (1.0 / 12.92) : pow((color.g + 0.055) * (1.0 / 1.055), 2.4),\n        color.b < 0.04045 ? color.b * (1.0 / 12.92) : pow((color.b + 0.055) * (1.0 / 1.055), 2.4)\n    );\n}",mesh_picking_vert:"attribute vec3 aPosition;\nuniform mat4 projViewModelMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 modelViewMatrix;\n#include <fbo_picking_vert>\n#include <get_output>\nvoid main()\n{\n    mat4 localPositionMatrix = getPositionMatrix();\n    vec4 localPosition = getPosition(aPosition);\n    gl_Position = projViewModelMatrix * localPositionMatrix * localPosition;\n    fbo_picking_setData(gl_Position.w, true);\n}"};var Ww={register(e,t){if(jw[e])throw new Error(`Key of ${e} is already registered in ShaderLib.`);jw[e]=t},compile:e=>Zw(e),get:e=>jw[e]};const qw=/^[ \t]*#include +<([\w\d.]+)>/gm;function Zw(e){return e.replace(qw,Xw)}function Xw(e,t){const n=jw[t];if(!n)throw new Error("Can not resolve #include <"+t+">");return Zw(n)}const Yw="\n// 矩阵求逆函数\nfn invert_matrix(matrix: mat4x4f) -> mat4x4f {\n    let vector1 = matrix[0];\n    let vector2 = matrix[1];\n    let vector3 = matrix[2];\n    let vector4 = matrix[3];\n\n    let a00 = vector1.x;\n    let a01 = vector1.y;\n    let a02 = vector1.z;\n    let a03 = vector1.w;\n\n    let a10 = vector2.x;\n    let a11 = vector2.y;\n    let a12 = vector2.z;\n    let a13 = vector2.w;\n\n    let a20 = vector3.x;\n    let a21 = vector3.y;\n    let a22 = vector3.z;\n    let a23 = vector3.w;\n\n    let a30 = vector4.x;\n    let a31 = vector4.y;\n    let a32 = vector4.z;\n    let a33 = vector4.w;\n\n    let b00 = a00 * a11 - a01 * a10;\n    let b01 = a00 * a12 - a02 * a10;\n    let b02 = a00 * a13 - a03 * a10;\n    let b03 = a01 * a12 - a02 * a11;\n    let b04 = a01 * a13 - a03 * a11;\n    let b05 = a02 * a13 - a03 * a12;\n    let b06 = a20 * a31 - a21 * a30;\n    let b07 = a20 * a32 - a22 * a30;\n    let b08 = a20 * a33 - a23 * a30;\n    let b09 = a21 * a32 - a22 * a31;\n    let b10 = a21 * a33 - a23 * a31;\n    let b11 = a22 * a33 - a23 * a32;\n\n    // 计算行列式\n    var det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n    det = 1.0 / det;\n\n    let m = mat4x4f(\n        (a11 * b11 - a12 * b10 + a13 * b09) * det,\n        (a02 * b10 - a01 * b11 - a03 * b09) * det,\n        (a31 * b05 - a32 * b04 + a33 * b03) * det,\n        (a22 * b04 - a21 * b05 - a23 * b03) * det,\n        (a12 * b08 - a10 * b11 - a13 * b07) * det,\n        (a00 * b11 - a02 * b08 + a03 * b07) * det,\n        (a32 * b02 - a30 * b05 - a33 * b01) * det,\n        (a20 * b05 - a22 * b02 + a23 * b01) * det,\n        (a10 * b10 - a11 * b08 + a13 * b06) * det,\n        (a01 * b08 - a00 * b10 - a03 * b06) * det,\n        (a30 * b04 - a31 * b02 + a33 * b00) * det,\n        (a21 * b02 - a20 * b04 - a23 * b00) * det,\n        (a11 * b07 - a10 * b09 - a12 * b06) * det,\n        (a00 * b09 - a01 * b07 + a02 * b06) * det,\n        (a31 * b01 - a30 * b03 - a32 * b00) * det,\n        (a20 * b03 - a21 * b01 + a22 * b00) * det\n    );\n\n    return m;\n}\n\n// 矩阵转置函数\nfn transpose_matrix(matrix: mat4x4f) -> mat4x4f {\n    let vector1 = matrix[0];\n    let vector2 = matrix[1];\n    let vector3 = matrix[2];\n    let vector4 = matrix[3];\n\n    let a01 = vector1.y;\n    let a02 = vector1.z;\n    let a03 = vector1.w;\n\n    let a12 = vector2.z;\n    let a13 = vector2.w;\n\n    let a23 = vector3.w;\n\n    let m = mat4x4f(\n        vector1.x,\n        vector2.x,\n        vector3.x,\n        vector4.x,\n        a01,\n        vector2.y,\n        vector3.y,\n        vector4.y,\n        a02,\n        a12,\n        vector3.z,\n        vector4.z,\n        a03,\n        a13,\n        a23,\n        vector4.w\n    );\n\n    return m;\n}\n";const Jw="\nconst COMMON_FLOAT_MAX: f32 = 1.70141184e38;\nconst COMMON_FLOAT_MIN: f32 = 1.17549435e-38;\n\nfn common_packFloat(val: vec4f) -> f32 {\n    let scl = floor(255.0 * val + 0.5);\n    let sgn = select(-1.0, 1.0, scl.a < 128.0);\n    let exn = (scl.a * 2.0 % 256.0) + floor(scl.b / 128.0) - 127.0;\n    let man = 1.0 +\n        (scl.r / 8388608.0) +\n        (scl.g / 32768.0) +\n        (scl.b % 128.0) / 128.0;\n    return sgn * man * pow(2.0, exn);\n}\n\nfn common_unpackFloat(v: f32) -> vec4f {\n    let av = abs(v);\n\n    // Handle special cases\n    if (av < COMMON_FLOAT_MIN) {\n        return vec4f(0.0, 0.0, 0.0, 0.0);\n    } else if (v > COMMON_FLOAT_MAX) {\n        return vec4f(127.0, 128.0, 0.0, 0.0) / 255.0;\n    } else if (v < -COMMON_FLOAT_MAX) {\n        return vec4f(255.0, 128.0, 0.0, 0.0) / 255.0;\n    }\n\n    var c = vec4f(0.0, 0.0, 0.0, 0.0);\n\n    // Compute exponent and mantissa\n    let e = floor(log2(av));\n    var m = av * pow(2.0, -e) - 1.0;\n\n    // Unpack mantissa\n    c[1] = floor(128.0 * m);\n    m -= c[1] / 128.0;\n    c[2] = floor(32768.0 * m);\n    m -= c[2] / 32768.0;\n    c[3] = floor(8388608.0 * m);\n\n    // Unpack exponent\n    var ebias = e + 127.0;\n    c[0] = floor(ebias / 2.0);\n    ebias -= c[0] * 2.0;\n    c[1] += floor(ebias) * 128.0;\n\n    // Unpack sign bit\n    c[0] += 128.0 * step(0.0, -v);\n\n    // Scale back to range\n    return c / 255.0;\n}\n\nfn common_encodeDepth(depth: f32) -> vec4f {\n    let alpha = 1.0;\n    var pack = vec4f(0.0);\n    pack.a = alpha;\n    const code = vec3f(1.0, 255.0, 65025.0);\n    pack = vec4f(vec3f(code * depth), pack.a);\n    pack = vec4f(pack.r, fract(pack.gb), pack.a);\n    pack.r -= pack.g * (1.0 / 256.0);\n    pack.g -= pack.b * (1.0 / 256.0);\n    pack.b -= (pack.b % (4.0 / 255.0));\n    return pack;\n}\n\nfn common_decodeDepth(pack: vec4f) -> f32 {\n    return pack.r + pack.g / 255.0;\n}\n\n// https://cloud.tencent.com/developer/ask/sof/103481834\nfn encodeFloat32(f: f32) -> vec4f {\n    var e = 5.0;\n\n    var F = abs(f);\n    var Sign = step(0.0, -f);\n    var Exponent = floor(log2(F));\n    var Mantissa = (exp2(- Exponent) * F);\n    Exponent = floor(log2(F) + 127.0) + floor(log2(Mantissa));\n    var rgba = vec4(0.0);\n    rgba[0] = 128.0 * Sign  + floor(Exponent*exp2(-1.0));\n    rgba[1] = 128.0 * mod(Exponent,2.0) + mod(floor(Mantissa*128.0),128.0);\n    rgba[2] = floor(mod(floor(Mantissa*exp2(23.0 -8.0)),exp2(8.0)));\n    rgba[3] = floor(exp2(23.0)*mod(Mantissa,exp2(-15.0)));\n    return rgba / 255.0;\n}\n\nfn decodeFloat32(rgba: vec4f) -> f32 {\n    rgba *= 255.0;\n    var Sign = 1.0 - step(128.0,rgba[0])*2.0;\n    var Exponent = 2.0 * mod(rgba[0],128.0) + step(128.0,rgba[1]) - 127.0;\n    var Mantissa = mod(rgba[1],128.0)*65536.0 + rgba[2]*256.0 +rgba[3] + float(0x800000);\n    var Result =  Sign * exp2(Exponent) * (Mantissa * exp2(-23.0 ));\n    return Result;\n}\n\n\n";const Qw={instance:{vert:"\n@group(0) @binding($b) var<uniform> terrainAltitudeScale: f32;\n\n// 获取实例属性矩阵函数\nfn instance_getAttributeMatrix(\n    input: VertexInput\n) -> mat4x4f {\n    let vectorA = input.instance_vectorA;\n    let vectorB = input.instance_vectorB;\n    let vectorC = input.instance_vectorC;\n    var mat = mat4x4f(\n        vectorA.x, vectorB.x, vectorC.x, 0.0,\n        vectorA.y, vectorB.y, vectorC.y, 0.0,\n        vectorA.z, vectorB.z, vectorC.z, 0.0,\n        vectorA.w, vectorB.w, vectorC.w, 1.0\n    );\n\n#ifdef HAS_INSTANCE_TERRAIN_ALTITUDE\n    var terrainMat = mat4x4f(\n        1.0, 0.0, 0.0, 0.0,\n        0.0, 1.0, 0.0, 0.0,\n        0.0, 0.0, 1.0, 0.0,\n        0.0, 0.0, aTerrainAltitude * terrainAltitudeScale, 1.0\n    );\n    mat = terrainMat * mat;\n#endif\n\n    return mat;\n}\n\n#ifdef HAS_INSTANCE_COLOR\n// 获取实例颜色函数\nfn instance_getInstanceColor(instance_color: vec4f) -> vec4f {\n    var color = instance_color;\n#ifdef HAS_INSTANCE_HIGHLIGHT\n    color = instance_color * highlight_color;\n#endif\n    return color;\n}\n#endif\n",attributes:[{name:"instance_vectorA",type:"vec4f"},{name:"instance_vectorB",type:"vec4f"},{name:"instance_vectorC",type:"vec4f"},{defines:["HAS_INSTANCE_TERRAIN_ALTITUDE"],name:"aTerrainAltitude",type:"f32"},{defines:["HAS_INSTANCE_HIGHLIGHT"],name:"highlight_color",type:"vec4f"},{defines:["HAS_INSTANCE_COLOR"],name:"instance_color",type:"vec4f"}],defines:["HAS_INSTANCE"]},invert_matrix:{vert:Yw,frag:Yw},line_extrusion:{vert:"\n    #define ALTITUDE_SCALE 32767.0;\n    #define EXTRUDE_SCALE 63.0;\n\n    struct LineExtrusionVertex {\n        linePixelScale: f32;\n        #if HAS_LINE_WIDTH\n        #else\n            lineWidth: f32;\n        #endif\n        #if HAS_LINE_HEIGHT\n        #else\n            lineHeight: f32;\n        #endif\n    }\n\n    @group(0) @binding($b) var<uniform> lineExtrusionVertex : LineExtrusionVertex;\n\n    fn getLineExtrudePosition(position: vec3f, input: VertexInput) -> vec3f {\n        #if HAS_LINE_WIDTH\n            let lineWidth: f32 = input.aLineWidth / 2.0;\n        #else\n            let lineWidth: f32 = lineExtrusionVertex.lineWidth;\n        #endif\n        #if HAS_LINE_HEIGHT\n            // aLineHeight单位是分米\n            let lineHeight: f32 = input.aLineHeight / 10.0;\n        #else\n            let lineHeight: f32 = lineExtrusionVertex.lineHeight\n        #endif\n\n        let halfwidth: f32 = lineWidth / 2.0;\n        let outset: f32 = halfwidth;\n        let dist: vec2f = outset * input.aExtrude / EXTRUDE_SCALE;\n        let z_scaled: f32 = position.z * (lineHeight / ALTITUDE_SCALE);\n    return position + vec3f(dist, 0.0) * linePixelScale;\n}\n",attributes:[{defines:["HAS_LINE_WIDTH"],name:"aLineWidth",type:"f32"},{defines:["HAS_LINE_HEIGHT"],name:"aLineHeight",type:"f32"}],defines:["IS_LINE_EXTRUSION"]},mask:{defines:["HAS_MASK_EXTENT"],vert:"\n#ifdef HAS_MASK_EXTENT\nstruct MaskUniforms {\n    mask_extent: vec4f,\n    mask_maskMode: f32,\n    mask_hasFlatOut: f32,\n    viewMatrix: mat4x4f,\n    mask_heightRatio: f32,\n    mask_heightOffset: f32,\n};\n\n@group(0) @binding($b) var<uniform> maskUniforms: MaskUniforms;\n@group(0) @binding($b) var mask_colorExtentSampler: sampler;\n@group(0) @binding($b) var mask_colorExtent: texture_2d<f32>;\n@group(0) @binding($b) var mask_modeExtentSampler: sampler;\n@group(0) @binding($b) var mask_modeExtent: texture_2d<f32>;\n\nconst CLIPINSIDE_MODE: f32 = 0.2;\nconst FLATINSIDE_MODE: f32 = 0.3;\nconst FLATOUTSIDE_MODE: f32 = 0.4;\nconst ELEVATE_MODE: f32 = 0.7;\n\nfn random(st: vec2f) -> f32 {\n    return fract(sin(dot(st, vec2f(12.9898, 78.233))) * 43758.5453123) * 0.1;\n}\n\nfn isInExtent(color: vec4f) -> bool {\n    return length(color.rgb) > 0.0;\n}\n\nfn getFlatHeight(maskMode: f32, flatHeight: f32, height: f32) -> f32 {\n    if (maskMode <= ELEVATE_MODE && maskMode > 0.6) {\n        return flatHeight + height;\n    } else {\n        return flatHeight;\n    }\n}\n\nfn getNoErrorPosition(position: vec4f, wPosition: vec4f) -> vec4f {\n    let realPos = uniforms.modelViewMatrix * position; // 未压平，采用 vm 矩阵的坐标\n    let pos = maskUniforms.viewMatrix * wPosition; // 压平的坐标\n    let tempPos = maskUniforms.viewMatrix * uniforms.modelMatrix * position; // 未压平而采用 v*m 矩阵的坐标\n    let deltaX = realPos.x - tempPos.x;\n    let deltaY = realPos.y - tempPos.y;\n    let deltaZ = realPos.z - tempPos.z;\n    pos.x = pos.x + deltaX;\n    pos.y = pos.y + deltaY;\n    pos.z = pos.z + deltaZ;\n    return pos;\n}\n\nfn getMaskPosition(position: vec4f, modelMatrix: mat4x4f, vertexOutput: VertexOutput) -> vec4f {\n    vertexOutput.vWorldPosition = modelMatrix * position;\n    let w = maskUniforms.mask_extent.z - maskUniforms.mask_extent.x;\n    let h = maskUniforms.mask_extent.y - maskUniforms.mask_extent.w;\n    let uvInExtent = vec2f((vertexOutput.vWorldPosition.x - maskUniforms.mask_extent.x) / abs(w), 1.0 - (vertexOutput.vWorldPosition.y - maskUniforms.mask_extent.w) / h);\n    let extentColor = textureSample(mask_colorExtent, mask_colorExtentSampler, uvInExtent);\n    let maskOptionColor = textureSample(mask_modeExtent, mask_modeExtentSampler, uvInExtent).rgb;\n    let maskMode = maskOptionColor.r;\n    let flatHeight = maskOptionColor.g / maskUniforms.mask_heightRatio + maskUniforms.mask_heightOffset;\n    let height = getFlatHeight(maskMode, flatHeight, vertexOutput.vWorldPosition.z);\n    let wPosition = vec4f(vertexOutput.vWorldPosition.x, vertexOutput.vWorldPosition.y, height, vertexOutput.vWorldPosition.w);\n    vertexOutput.vUVInExtent = uvInExtent;\n    vertexOutput.vHeightRatio = maskUniforms.mask_heightRatio;\n    vertexOutput.vHeightOffset = maskUniforms.mask_heightOffset;\n    if (maskMode <= FLATOUTSIDE_MODE && maskMode > FLATINSIDE_MODE) {\n        return uniforms.modelViewMatrix * position;\n    } else if (maskUniforms.mask_hasFlatOut == 1.0) {\n        return getNoErrorPosition(position, wPosition);\n    }\n    if (isInExtent(extentColor) && maskMode <= FLATINSIDE_MODE && maskMode > CLIPINSIDE_MODE) {\n        return getNoErrorPosition(position, wPosition);\n    }\n    if (isInExtent(extentColor) && maskMode <= ELEVATE_MODE && maskMode > 0.6) {\n        return getNoErrorPosition(position, wPosition);\n    } else {\n        return uniforms.modelViewMatrix * position;\n    }\n}\n#endif\n",varyings:[{name:"vWorldPosition",type:"vec4f"},{name:"vUVInExtent",type:"vec2f"},{name:"vHeightRatio",type:"f32"},{name:"vHeightOffset",type:"f32"}]},get_output:{attributes:[{defines:["HAS_MORPH"],name:"POSITION0",type:"vec3f"},{defines:["HAS_MORPH"],name:"POSITION0",type:"vec3f"},{defines:["HAS_MORPH"],name:"POSITION1",type:"vec3f"},{defines:["HAS_MORPH"],name:"POSITION2",type:"vec3f"},{defines:["HAS_MORPH"],name:"POSITION3",type:"vec3f"},{defines:["HAS_MORPH"],name:"POSITION4",type:"vec3f"},{defines:["HAS_MORPH"],name:"POSITION5",type:"vec3f"},{defines:["HAS_MORPH"],name:"POSITION6",type:"vec3f"},{defines:["HAS_MORPH"],name:"POSITION7",type:"vec3f"},{defines:["HAS_MORPH","HAS_MORPHNORMALS"],name:"NORMAL0",type:"vec3f"},{defines:["HAS_MORPH","HAS_MORPHNORMALS"],name:"NORMAL0",type:"vec3f"},{defines:["HAS_MORPH","HAS_MORPHNORMALS"],name:"NORMAL1",type:"vec3f"},{defines:["HAS_MORPH","HAS_MORPHNORMALS"],name:"NORMAL2",type:"vec3f"},{defines:["HAS_TERRAIN_ALTITUDE"],name:"aTerrainAltitude",type:"f32"}],varyings:[{defines:["HAS_INSTANCE_COLOR","HAS_INSTANCE"],name:"vInstanceColor",type:"vec4f"}],vert:"\n#include <invert_matrix>\n#include <draco_decode_vert>\n\n\n#include <instance_vert>\n\n\n#ifdef HAS_SKIN\n    struct SkinUniforms {\n        skinAnimation: i32,\n    };\n    @group(0) @binding($b) var<uniform> skinUniforms: SkinUniforms;\n    #include <skin_vert>\n#endif\n\n#include <mask_vert>\n\n#ifdef HAS_MORPH\n    struct MorphUniforms {\n        morphWeights1: vec4f,\n        morphWeights2: vec4f,\n    };\n    @group(0) @binding($b) var<uniform> morphUniforms: MorphUniforms;\n#endif\n\n#ifdef HAS_MIN_ALTITUDE\n    struct AltitudeUniforms {\n        minAltitude: f32,\n    };\n    @group(0) @binding($b) var<uniform> altitudeUniforms: AltitudeUniforms;\n#endif\n\n#ifdef HAS_TERRAIN_FLAT_MASK\n    @group(0) @binding($b) var flatMask: texture_2d<f32>;\n    @group(0) @binding($b) var flatMaskSampler: sampler;\n#endif\n\nfn getPositionMatrix(input: VertexInput, vertexOutput: ptr<function, VertexOutput>, positionMatrix: mat4x4f) -> mat4x4f {\n    var worldMatrix: mat4x4f;\n#ifdef HAS_INSTANCE\n    let attributeMatrix = instance_getAttributeMatrix(input);\n    #ifdef HAS_INSTANCE_COLOR\n        vertexOutput.vInstanceColor = instance_getInstanceColor();\n    #endif\n    #ifdef HAS_SKIN\n        if (skinUniforms.skinAnimation == 1) {\n            worldMatrix = attributeMatrix * positionMatrix * skin_getSkinMatrix();\n        } else {\n            worldMatrix = attributeMatrix * positionMatrix;\n        }\n    #else\n        worldMatrix = attributeMatrix * positionMatrix;\n    #endif\n#else\n    #ifdef HAS_SKIN\n        if (skinUniforms.skinAnimation == 1) {\n            worldMatrix = skin_getSkinMatrix() * positionMatrix;\n        } else {\n            worldMatrix = positionMatrix;\n        }\n    #else\n        worldMatrix = positionMatrix;\n    #endif\n#endif\n    return worldMatrix;\n}\n\nfn getPosition(inputPosition: vec3f, vertexInput: VertexInput) -> vec4f {\n    var position = decode_getPosition(inputPosition);\n    #ifdef HAS_MORPH\n        let outputPosition = vec4f(position +\n            morphUniforms.morphWeights1[0] * vertexInput.POSITION0 +\n            morphUniforms.morphWeights1[1] * vertexInput.POSITION1 +\n            morphUniforms.morphWeights1[2] * vertexInput.POSITION2 +\n            morphUniforms.morphWeights1[3] * vertexInput.POSITION3 +\n            morphUniforms.morphWeights2[0] * vertexInput.POSITION4 +\n            morphUniforms.morphWeights2[1] * vertexInput.POSITION5 +\n            morphUniforms.morphWeights2[2] * vertexInput.POSITION6 +\n            morphUniforms.morphWeights2[3] * vertexInput.POSITION7, 1.0);\n    #else\n        var outputPosition = vec4f(position, 1.0);\n    #endif\n    #ifdef HAS_TERRAIN_ALTITUDE\n        outputPosition.z += vertexInput.aTerrainAltitude * 100.0;\n    #endif\n    #ifdef HAS_TERRAIN_FLAT_MASK\n        var uv = aTexCoord;\n        uv.y = 1.0 - uv.y;\n        let encodedHeight = textureSample(flatMask, flatMaskSampler, uv);\n        if (length(encodedHeight) < 2.0) {\n            float maskHeight = decodeFloat32(encodedHeight);\n            outputPosition.z = min(outputPosition.z, maskHeight);\n        }\n    #endif\n    #ifdef HAS_MIN_ALTITUDE\n        outputPosition.z += altitudeUniforms.minAltitude * 100.0;\n    #endif\n    return outputPosition;\n}\n\nfn appendMorphNormal(inputNormal: vec3f, vertexInput: VertexInput) -> vec3f {\n    #ifdef HAS_MORPHNORMALS\n        let normal = inputNormal +\n            morphUniforms.morphWeights1[0] * vertexInput.NORMAL0 +\n            morphUniforms.morphWeights1[1] * vertexInput.NORMAL1 +\n            morphUniforms.morphWeights1[2] * vertexInput.NORMAL2 +\n            morphUniforms.morphWeights1[3] * vertexInput.NORMAL3;\n    #else\n        let normal = inputNormal;\n    #endif\n    return normal;\n}\n"},skin:{vert:"\n// 定义 uniform 变量\nstruct JoinUniforms {\n    numJoints: f32,                     // 关节数量\n};\n\n@group(0) @binding($b) var<uniform> joinUniforms: JoinUniforms;\n\n// 定义采样器\n@group(0) @binding($b) var jointTextureSampler: sampler;\n@group(0) @binding($b) var jointTexture: texture_2df,      // 关节纹理\n\n// 定义采样点坐标\n#define ROW0_U ((0.5 + 0.0) / 4.)\n#define ROW1_U ((0.5 + 1.0) / 4.)\n#define ROW2_U ((0.5 + 2.0) / 4.)\n#define ROW3_U ((0.5 + 3.0) / 4.)\n\n// 获取骨骼矩阵函数\nfn skin_getBoneMatrix(jointNdx: f32) -> mat4x4f {\n    let v = (jointNdx + 0.5) / joinUniforms.numJoints;\n    return mat4x4f(\n        textureSample(jointTexture, jointTextureSampler, vec2f(ROW0_U, v)),\n        textureSample(jointTexture, jointTextureSampler, vec2f(ROW1_U, v)),\n        textureSample(jointTexture, jointTextureSampler, vec2f(ROW2_U, v)),\n        textureSample(jointTexture, jointTextureSampler, vec2f(ROW3_U, v))\n    );\n}\n\n// 获取皮肤矩阵函数\nfn skin_getSkinMatrix(JOINTS_0: vec4f, WEIGHTS_0: vec4f) -> mat4x4f {\n    var skinMatrix = skin_getBoneMatrix(JOINTS_0[0]) * WEIGHTS_0[0] +\n                     skin_getBoneMatrix(JOINTS_0[1]) * WEIGHTS_0[1] +\n                     skin_getBoneMatrix(JOINTS_0[2]) * WEIGHTS_0[2] +\n                     skin_getBoneMatrix(JOINTS_0[3]) * WEIGHTS_0[3];\n    return skinMatrix;\n}\n",attributes:[{name:"WEIGHTS_0",type:"vec4f"},{name:"JOINTS_0",type:"vec4f"}],defines:["HAS_SKIN"]},vertex_color:{vert:"\nstruct VertexColorsUniforms {\n    vertexColorsOfType: array<vec4f, VERTEX_TYPES_COUNT>\n}\n\n@group(0) @binding($b) var<uniform> vertexColors: VertexColorsUniforms;\n\nfn vertexColor_update(input: VertexInput, output: ptr<function, VertexOutput>) {\n    // 将 aVertexColorType 转换为整数索引\n    let index: i32 = i32(input.aVertexColorType);\n    // 获取对应的颜色\n    output.vertexColorColor = vertexColors.vertexColorsOfType[index];\n}\n\n",frag:"\nfn vertexColor_get(input: VertexOutput) -> vec4<f32> {\n    return input.vertexColorColor;\n}\n",attributes:[{name:"aVertexColorType",type:"u32"}],varyings:[{name:"vertexColorColor",type:"vec4f"}],defines:["HAS_VERTEX_COLOR"]},vsm_shadow:{defines:e=>e.HAS_SHADOWING&&!e.HAS_BLOOM,vert:"\nstruct ShadowUniforms {\n    shadow_lightProjViewModelMatrix: mat4x4f,\n};\n\n@group(0) @binding($b) var<uniform> shadowUniforms: ShadowUniforms;\n\nstruct VertexOutput {\n    shadow_vLightSpacePos: vec4f,\n};\n\nfn shadow_computeShadowPars(position: vec4f, vertexOutput: VertexOutput) {\n    vertexOutput.shadow_vLightSpacePos = shadowUniforms.shadow_lightProjViewModelMatrix * position;\n}\n",frag:"\nstruct ShadowUniforms {\n    shadow_opacity: f32,\n    shadow_color: vec3f,\n    esm_shadow_threshold: f32\n};\n\n@group(0) @binding($b) var<uniform> shadowUniforms: ShadowUniforms;\n@group(0) @binding($b) var shadow_shadowMapSampler: sampler;\n@group(0) @binding($b) var shadow_shadowMap: texture_2d<f32>;\n\n\n#ifdef PACK_FLOAT\n#include <common_pack_float>\n#endif\n\nfn esm(projCoords: vec3f, shadowTexel: vec4f) -> f32 {\n    let compare = projCoords.z;\n    let c = 120.0;\n#ifdef PACK_FLOAT\n    let depth = common_decodeDepth(shadowTexel);\n    if (depth >= 1.0 - 1E-6 || compare <= depth) {\n        return 1.0;\n    }\n#else\n    let depth = shadowTexel.r;\n#endif\n\n    let depth = exp(-c * min(compare - depth, 0.05));\n    return clamp(depth, shadowUniforms.esm_shadow_threshold, 1.0);\n}\n\nfn shadow_computeShadow_coeff(shadowMap: texture_2d<f32>, projCoords: vec3f) -> f32 {\n    let uv = projCoords.xy;\n    let shadowTexel = textureSample(shadowMap, shadow_shadowMapSampler, uv);\n    let esm_coeff = esm(projCoords, shadowTexel);\n    let coeff = esm_coeff * esm_coeff;\n    return 1.0 - (1.0 - coeff) * shadowUniforms.shadow_opacity;\n}\n\nfn shadow_computeShadow(vertexOutput: VertexOutput) -> f32 {\n    let projCoords = vertexOutput.shadow_vLightSpacePos.xyz / vertexOutput.shadow_vLightSpacePos.w;\n    projCoords = projCoords * 0.5 + 0.5;\n    if (projCoords.z >= 1.0 || projCoords.x < 0.0 || projCoords.x > 1.0 || projCoords.y < 0.0 || projCoords.y > 1.0) {\n        return 1.0;\n    }\n    return shadow_computeShadow_coeff(shadow_shadowMap, projCoords);\n}\n\nfn shadow_blend(color: vec3f, coeff: f32) -> vec3f {\n    color = color * coeff + shadowUniforms.shadow_color * shadowUniforms.shadow_opacity * (1.0 - coeff);\n    return color;\n}\n",varyings:[{name:"shadow_vLightSpacePos",type:"vec4f",defines:["HAS_SHADOWING"]}]},draco_decode:{vert:"\n#if HAS_DRACO_NORMAL || HAS_DRACO_POSITION || HAS_DRACO_TEXCOORD || HAS_WEB3D_QUANTIZED_ATTRIBUTES_TEXCOORD || HAS_COMPRESSED_INT16\n    // 定义 uniform 变量\n    struct DracoUniforms {\n        #if HAS_DRACO_NORMAL\n            gltf_u_dec_normal_rangeConstant: f32,\n        #endif\n\n        #if HAS_DRACO_POSITION\n            minValues_pos: vec3f,\n            gltf_u_dec_position_normConstant: f32,\n        #endif\n\n        #if HAS_DRACO_TEXCOORD\n            minValues_tex: vec2f,\n            gltf_u_dec_texcoord_0_normConstant: f32,\n        #endif\n\n        #if HAS_WEB3D_QUANTIZED_ATTRIBUTES_TEXCOORD\n            decodeMatrix: mat3x3f,\n        #endif\n\n    #if HAS_COMPRESSED_INT16\n        #if HAS_COMPRESSED_INT16_POSITION\n            compressedPositionRange: vec2f, // 压缩位置范围\n        #endif\n        #if HAS_COMPRESSED_INT16_TEXCOORD_0\n            compressedTexcoordRange_0: vec2f, // 压缩纹理坐标范围 0\n        #endif\n        #if HAS_COMPRESSED_INT16_TEXCOORD_1\n            compressedTexcoordRange_1: vec2f, // 压缩纹理坐标范围 1\n        #endif\n        #if HAS_COMPRESSED_INT16_NORMAL\n            compressedNormalRange: vec2f, // 压缩法线范围\n        #endif\n        #if HAS_COMPRESSED_INT16_RATIO\n            compressed_ratio: f32, // 压缩比例\n        #endif\n    #endif\n    };\n\n    @group(0) @binding($b) var<uniform> dracoUniforms: DracoUniforms;\n#endif\n\n    // Draco 位置解码函数\n    #ifdef HAS_DRACO_POSITION\n    fn decodeDracoPosition(aPosition: vec3f) -> vec3f {\n        return dracoUniforms.minValues_pos + aPosition * dracoUniforms.gltf_u_dec_position_normConstant;\n    }\n    #endif\n\n    // Draco 纹理坐标解码函数\n    #ifdef HAS_DRACO_TEXCOORD\n    fn decodeDracoTexcoord(aTexCoord: vec2f) -> vec2f {\n        return dracoUniforms.minValues_tex + aTexCoord * dracoUniforms.gltf_u_dec_texcoord_0_normConstant;\n    }\n    #endif\n\n    // Draco 法线解码函数\n    #ifdef HAS_DRACO_NORMAL\n    fn czm_signNotZero(value: f32) -> f32 {\n        return select(-1.0, 1.0, value >= 0.0);\n    }\n\n    fn czm_signNotZero(value: vec2f) -> vec2f {\n        return vec2f(czm_signNotZero(value.x), czm_signNotZero(value.y));\n    }\n\n    fn decodeDracoNormal(encoded: vec2f, range: f32) -> vec3f {\n        if (encoded.x == 0.0 && encoded.y == 0.0) {\n            return vec3f(0.0, 0.0, 0.0);\n        }\n        encoded = encoded / range * 2.0 - 1.0;\n        var v = vec3f(encoded.x, encoded.y, 1.0 - abs(encoded.x) - abs(encoded.y));\n        if (v.z < 0.0) {\n            v.xy = (1.0 - abs(v.yx)) * czm_signNotZero(v.xy);\n        }\n        return normalize(v);\n    }\n\n    fn decode_getNormal(aNormal: vec2f) -> vec3f {\n        return decodeDracoNormal(aNormal, dracoUniforms.gltf_u_dec_normal_rangeConstant).zxy;\n    }\n    #endif\n\n    // 压缩属性解码函数\n    #ifdef HAS_COMPRESSED_INT16\n    fn int16ToFloat32(value: f32, range: vec2f) -> f32 {\n        let v = select(value / 32767.0, -(65536.0 - value) / 32768.0, value >= 32768.0);\n        return (v + 1.0) * (range.y - range.x) / 2.0 + range.x;\n    }\n    #endif\n\n    // 顶点位置解码函数\n    fn decode_getPosition(aPosition: vec3f) -> vec3f {\n        var position = aPosition;\n    #if HAS_COMPRESSED_INT16 && HAS_COMPRESSED_INT16_POSITION\n        let x = int16ToFloat32(aPosition.x, dracoUniforms.compressedPositionRange);\n        let y = int16ToFloat32(aPosition.y, dracoUniforms.compressedPositionRange);\n        let z = int16ToFloat32(aPosition.z, dracoUniforms.compressedPositionRange);\n        #ifdef HAS_COMPRESSED_INT16_RATIO\n            position = vec3f(x / dracoUniforms.compressed_ratio, y / dracoUniforms.compressed_ratio, z);\n        #else\n            position = vec3f(x, y, z);\n        #endif\n    #endif\n    #ifdef HAS_DRACO_POSITION\n        return decodeDracoPosition(position);\n    #else\n        return position;\n    #endif\n    }\n\n    // 纹理坐标解码函数\n    fn decode_getTexcoord(aTexCoord: vec2f) -> vec2f {\n        var texcoord = aTexCoord;\n    // if HAS_COMPRESSED_INT16 && (HAS_COMPRESSED_INT16_TEXCOORD_0 || HAS_COMPRESSED_INT16_TEXCOORD_1)\n    #if HAS_COMPRESSED_INT16\n        #if HAS_COMPRESSED_INT16_TEXCOORD_0 || HAS_COMPRESSED_INT16_TEXCOORD_1\n            let x = int16ToFloat32(aTexCoord.x, dracoUniforms.compressedTexcoordRange_0);\n            let y = int16ToFloat32(aTexCoord.y, dracoUniforms.compressedTexcoordRange_0);\n            texcoord = vec2f(x, y);\n        #endif\n    #endif\n    #ifdef HAS_DRACO_TEXCOORD\n        return decodeDracoTexcoord(texcoord);\n    #else\n        #if HAS_WEB3D_QUANTIZED_ATTRIBUTES_TEXCOORD\n            let web3dTexcoord = dracoUniforms.decodeMatrix * vec3f(texcoord, 1.0);\n            return vec2f(web3dTexcoord.x, web3dTexcoord.y);\n        #else\n            return texcoord;\n        #endif\n    #endif\n    }\n\n    // 法线解码函数\n    fn decode_getNormal(aNormal: vec3f) -> vec3f {\n    #ifdef HAS_COMPRESSED_INT16_NORMAL\n        aNormal.x = int16ToFloat32(aNormal.x, dracoUniforms.compressedNormalRange);\n        aNormal.y = int16ToFloat32(aNormal.y, dracoUniforms.compressedNormalRange);\n        aNormal.z = int16ToFloat32(aNormal.z, dracoUniforms.compressedNormalRange);\n    #endif\n        return aNormal;\n    }\n"},highlight:{defines:e=>e.HAS_HIGHLIGHT_OPACITY||e.HAS_HIGHLIGHT_COLOR,vert:"\n\n    // 顶点着色器函数\n    fn highlight_setVarying(input: VertexInput, output: ptr<function, VertexOutput>) {\n        // 如果有高亮颜色\n    #if HAS_HIGHLIGHT_COLOR\n        output.vHighlightColor = input.aHighlightColor / 255.0;\n    #endif\n\n        // 如果有高亮透明度\n    #if HAS_HIGHLIGHT_OPACITY\n        output.vHighlightOpacity = input.aHighlightOpacity / 255.0;\n    #endif\n    }\n",frag:"\n    // 高亮颜色混合函数\n    fn highlight_blendColor(color: vec4f, output: VertexOutput) -> vec4f {\n        var outColor: vec4f = color;\n\n        // 如果有高亮颜色\n        #if HAS_HIGHLIGHT_COLOR\n            outColor.rgb = outColor.rgb * (1.0 - output.vHighlightColor.a) + output.vHighlightColor.rgb * output.vHighlightColor.a;\n            #if HAS_HIGHLIGHT_COLOR_POINT\n            #else\n            // 如果没有高亮颜色点\n                outColor.a = outColor.a * (1.0 - output.vHighlightColor.a) + output.vHighlightColor.a;\n            #endif\n        #endif\n\n            // 如果有高亮透明度\n        #if HAS_HIGHLIGHT_OPACITY\n            outColor *= output.vHighlightOpacity;\n        #endif\n\n        return outColor;\n    }\n",attributes:[{defines:["HAS_HIGHLIGHT_COLOR"],name:"aHighlightColor",type:"vec4f"},{defines:["HAS_HIGHLIGHT_OPACITY"],name:"aHighlightOpacity",type:"f32"}],varyings:[{defines:["HAS_HIGHLIGHT_COLOR"],name:"vHighlightColor",type:"vec4f"},{defines:["HAS_HIGHLIGHT_OPACITY"],name:"vHighlightOpacity",type:"f32"}]},compute_texcoord:{defines:["HAS_MAP"],frag:"\n#ifdef HAS_KHR_TEXTURE_TRANSFORM\n    struct TextureTransformUniforms {\n        offset: vec2f,\n        rotation: f32,\n        scale: vec2f,\n    };\n\n    @group(0) @binding($b) var<uniform> textureTransformUniforms: TextureTransformUniforms;\n\n    fn khr_tex_transformTexCoord(texCoords: vec2f, offset: vec2f, rotation: f32, scale: vec2f) -> vec2f {\n        rotation = -rotation;\n        let transform = mat3x3f(\n            cos(rotation) * scale.x, sin(rotation) * scale.x, 0.0,\n            -sin(rotation) * scale.y, cos(rotation) * scale.y, 0.0,\n            offset.x, offset.y, 1.0\n        );\n        let transformedTexCoords = (transform * vec3f(fract(texCoords), 1.0)).xy;\n        return transformedTexCoords;\n    }\n#endif\n\nfn computeTexCoord(vertexOutput: VertexOutput) -> vec2f {\n    let texCoord = vertexOutput.vTexCoord;\n    #ifdef HAS_I3S_UVREGION\n        let atlasScale = vertexOutput.vUvRegion.zw - vertexOutput.vUvRegion.xy;\n        let uvAtlas = fract(texCoord) * atlasScale + vertexOutput.vUvRegion.xy;\n        return uvAtlas;\n    #elif HAS_KHR_TEXTURE_TRANSFORM\n        let uniforms = textureTransformUniforms;\n        return khr_tex_transformTexCoord(texCoord, uniforms.offset, uniforms.rotation, uniforms.scale);\n    #else\n        return texCoord;\n    #endif\n}\n"},fbo_picking:{vert:"\n//--------------------------\n// Picking\n//\n// #define ENABLE_PICKING 整型 是否开启PICKING\n//\n// uniform int batchId geometry的批次id\n//\n//\n// fn fbo_picking_setData(viewPosZ: f32, visible: bool)\n//   设置picking数据,必须在设置gl_Position后调用\n//\n// 示例：\n// fbo_picking_setData(output.position.w, true);\n//--------------------------\n\n#ifdef ENABLE_PICKING\n#if HAS_PICKING_ID == 2\n    struct PickingUniforms {\n        uPickingId: f32,\n    }\n    @group(0) @binding($b) var<uniform> pickingUniforms: PickingUniforms;\n#endif\n#endif\n\nfn fbo_picking_setData(input: VertexInput, output: ptr<function, VertexOutput>, viewPosZ: f32, visible: bool) {\n    #ifdef ENABLE_PICKING\n    #if HAS_PICKING_ID == 1\n       output.vPickingId = input.aPickingId;\n    #elif HAS_PICKING_ID == 2\n        output.vPickingId = pickingUniforms.uPickingId;\n    #endif\n        output.vFbo_picking_viewZ = viewPosZ;\n        output.vFbo_picking_visible = select(0.0, 1.0, visible);\n    #endif\n    output.vFbo_picking_fragDepth = viewPosZ + 1.0;\n}\n",attributes:[{defines:e=>1===e.HAS_PICKING_ID,name:"aPickingId",type:"f32"}],varyings:[{defines:["ENABLE_PICKING"],name:"vPickingId",type:"f32"},{defines:["ENABLE_PICKING"],name:"vFbo_picking_viewZ",type:"f32"},{defines:["ENABLE_PICKING"],name:"vFbo_picking_visible",type:"f32"},{name:"vFbo_picking_fragDepth",type:"f32"}]},common_pack_float:{vert:Jw,frag:Jw},excavate:{defines:["HAS_EXCAVATE_ANALYSIS"],vert:"\n#ifdef HAS_EXCAVATE_ANALYSIS\nstruct ExcavateUniforms {\n    excavateExtent: vec4f\n};\n\n@group(0) @binding($b) var<uniform> excavateUniforms: ExcavateUniforms;\n\nfn getWorldHeight(localPosition: vec4f, modelMatrix: mat4x4f) -> f32 {\n    let wPosition = uniforms.modelMatrix * localPosition;\n    return wPosition.z;\n}\n\nfn getCoordinateTexcoord(localPosition: vec4f, modelMatrix: mat4x4f) -> vec2f {\n    let wPosition = modelMatrix * localPositionMatrix;\n    let x = (wPosition.x - excavateUniforms.excavateExtent.x) /\n           (excavateUniforms.excavateExtent.z - excavateUniforms.excavateExtent.x);\n    let y = (wPosition.y - excavateUniforms.excavateExtent.y) /\n           (excavateUniforms.excavateExtent.w - excavateUniforms.excavateExtent.y);\n    return vec2f(x, y);\n}\n\n#endif\n",frag:"\n#ifdef HAS_EXCAVATE_ANALYSIS\nstruct ExcavateUniforms {\n    excavateHeight: f32,\n    heightRange: vec2f  // Replaces the const range\n};\n\n@group(0) @binding($b) var<uniform> excavateUniforms: ExcavateUniforms;\n@group(0) @binding($b) var heightmap: texture_2d<f32>;\n@group(0) @binding($b) var heightmapSampler: sampler;\n\n\nfn decodeHeight(pack: vec4f) -> f32 {\n    return pack.r + pack.g / 255.0;\n}\n\nfn excavateColor(fragColor: vec4f, vertexOutput: VertexOutput) -> vec4f {\n    let samplerHeight = decodeHeight(textureSample(heightmap, heightmapSampler, vertexOutput.vCoordinateTexcoord));\n    let realHeight = samplerHeight * (excavateUniforms.heightRange.y - excavateUniforms.heightRange.x) + excavateUniforms.heightRange.x;\n\n    let validHeight = select(\n        0.0,\n        realHeight,\n        realHeight >= excavateUniforms.heightRange.x && realHeight <= excavateUniforms.heightRange.y\n    );\n\n    if (vertexOutput.vExcavateHeight > validHeight) {\n        discard;\n    }\n    return fragColor;\n}\n#endif\n",varyings:[{name:"vCoordinateTexcoord",type:"vec2f"},{name:"vExcavateHeight",type:"f32"}]},hsv:{frag:"\nconst HSV_K0 = vec4f(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\nconst HSV_K1 = vec4f(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\nconst HSV_E = 1.0e-10;\n\nfn hsv_rgb2hsv(c: vec3f) -> vec3f {\n    var K = HSV_K0;\n    var p = mix(vec4f(c.bg, K.wz), vec4f(c.gb, K.xy), select(0.0, 1.0, c.b <= c.g));\n    var q = mix(vec4f(p.xyw, c.r), vec4f(c.r, p.yzx), select(0.0, 1.0, p.x <= c.r));\n\n    // Alternative implementation commented out\n    // var p = select(vec4f(c.gb, K.xy), vec4f(c.bg, K.wz), c.g < c.b);\n    // var q = select(vec4f(c.r, p.yzx), vec4f(p.xyw, c.r), c.r < p.x);\n\n    let d = q.x - min(q.w, q.y);\n    let e = HSV_E;\n    return vec3f(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\n}\n\nfn hsv_hsv2rgb(c: vec3f) -> vec3f {\n    let K = HSV_K1;\n    let p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n    return c.z * mix(K.xxx, clamp(p - K.xxx, vec3f(0.0), vec3f(1.0)), c.y);\n}\n\nfn hsv_apply4(c: vec4f, hsvOffset: vec3f) -> vec4f {\n    var hsv = hsv_rgb2hsv(c.rgb);\n    hsv += hsv * hsvOffset;\n    hsv = clamp(hsv, vec3f(0), vec3f(1));\n    return vec4f(hsv_hsv2rgb(hsv), c.a);\n}\n\nfn hsv_apply3(c: vec3f, hsvOffset: vec3f) -> vec3f {\n    var hsv = hsv_rgb2hsv(c);\n    hsv += hsv * hsvOffset;\n    hsv = clamp(hsv, vec3f(0), vec3f(1));\n    return hsv_hsv2rgb(hsv);\n}\n\nfn contrastMatrix(contrast: f32) -> mat4x4f {\n    let t = (1.0 - contrast) / 2.0;\n    return mat4x4f(\n        vec4f(contrast, 0.0, 0.0, 0.0),\n        vec4f(0.0, contrast, 0.0, 0.0),\n        vec4f(0.0, 0.0, contrast, 0.0),\n        vec4f(t, t, t, 1.0)\n    );\n}\n"},srgb:{frag:"\nfn linearTosRGB(color: vec3f) -> vec3f {\n    return vec3f(\n        select(1.055 * pow(color.r, 1.0/2.4) - 0.055, color.r * 12.92, color.r < 0.0031308),\n        select(1.055 * pow(color.g, 1.0/2.4) - 0.055, color.g * 12.92, color.g < 0.0031308),\n        select(1.055 * pow(color.b, 1.0/2.4) - 0.055, color.b * 12.92, color.b < 0.0031308)\n    );\n}\n\nfn sRGBToLinear(color: vec3f) -> vec3f {\n    return vec3f(\n        select(pow((color.r + 0.055) * (1.0 / 1.055), 2.4), color.r * (1.0 / 12.92), color.r < 0.04045),\n        select(pow((color.g + 0.055) * (1.0 / 1.055), 2.4), color.g * (1.0 / 12.92), color.g < 0.04045),\n        select(pow((color.b + 0.055) * (1.0 / 1.055), 2.4), color.b * (1.0 / 12.92), color.b < 0.04045)\n    );\n}\n"},snow:{defines:["HAS_SNOW"],frag:"\n#ifdef HAS_SNOW\nstruct SnowUniforms {\n    snowHeightThreshold: f32  // Added as a configurable uniform\n};\n\n@group(0) @binding($b) var<uniform> snowUniforms: SnowUniforms;\n\nfn lerp(a: f32, b: f32, w: f32) -> f32 {\n    return a + w * (b - a);\n}\n\nfn snow(sceneColor: vec4f, normalColor: vec3f, height: f32) -> vec3f {\n    let snowIntense = normalColor.b;\n    let fixedC = vec3f(1.0, 1.0, 1.0);\n\n    if (height < snowUniforms.snowHeightThreshold) {\n        let r = lerp(0.5, fixedC.x, snowIntense);\n        let g = lerp(0.5, fixedC.y, snowIntense);\n        let b = lerp(0.5, fixedC.z, snowIntense);\n        return vec3f(r, g, b);\n    } else {\n        let r = lerp(sceneColor.r, fixedC.x, snowIntense);\n        let g = lerp(sceneColor.g, fixedC.y, snowIntense);\n        let b = lerp(sceneColor.b, fixedC.z, snowIntense);\n        return vec3f(r, g, b);\n    }\n}\n#endif\n"},terrain_normal:{defines:["HAS_TERRAIN_NORMAL"],frag:"\n#ifdef HAS_TERRAIN_NORMAL\nstruct TerrainNormalUniforms {\n    terrainHeightMapResolution: vec2f,\n    terrainResolution: vec2f,\n    terrainHeightScale: f32,\n    terrainTileResolution: f32,\n    terrainUnpackFactors: vec4f\n};\n\n@group(0) @binding($b) var<uniform> terrainNormalUniforms: TerrainNormalUniforms;\n@group(0) @binding($b) var terrainHeightTexture: texture_2d<f32>;\n@group(0) @binding($b) var terrainHeightSampler: sampler;\n\nfn getHeight(uv: vec2f) -> f32 {\n    let color = textureSample(terrainHeightTexture, terrainHeightSampler, uv) * 255.0;\n    let colorWithAlpha = vec4f(color.rgb, -1.0);\n    return dot(colorWithAlpha, terrainNormalUniforms.terrainUnpackFactors) / 4.0;\n}\n\nfn convertTerrainHeightToNormalMap(uv: vec2f) -> vec3f {\n    let flippedUV = vec2f(uv.x, 1.0 - uv.y);\n    let epsilon = 1.0 / terrainNormalUniforms.terrainHeightMapResolution;\n\n    let a = getHeight(flippedUV + vec2f(-epsilon.x, -epsilon.y));\n    let b = getHeight(flippedUV + vec2f(0.0, -epsilon.y));\n    let c = getHeight(flippedUV + vec2f(epsilon.x, -epsilon.y));\n    let d = getHeight(flippedUV + vec2f(-epsilon.x, 0.0));\n    let e = getHeight(flippedUV + vec2f(epsilon.x, 0.0));\n    let f = getHeight(flippedUV + vec2f(-epsilon.x, epsilon.y));\n    let g = getHeight(flippedUV + vec2f(0.0, epsilon.y));\n    let h = getHeight(flippedUV + vec2f(epsilon.x, epsilon.y));\n\n    let dxy = vec2f(\n        (c + e + e + h) - (a + d + d + f),\n        (f + g + g + h) - (a + b + b + c)\n    );\n    return normalize(vec3f(dxy / epsilon, terrainNormalUniforms.terrainResolution.x));\n}\n#endif\n"},mesh_picking:{vert:"\n#include <fbo_picking_vert>\n#include <get_output>\n\nstruct VertexInput {\n    @location($i) aPosition: vec3f,\n}\n\nstruct Uniforms {\n    projViewModelMatrix: mat4x4f,\n    modelMatrix: mat4x4f,\n    positionMatrix: mat4x4f,\n}\n\n@group(0) @binding($b) var<uniform> uniforms: Uniforms;\n\nstruct VertexOutput {\n    @builtin(position) position: vec4f,\n    // 其他varying变量可以在这里添加\n}\n\n@vertex\nfn main(input: VertexInput) -> VertexOutput {\n    var output: VertexOutput;\n\n    let localPositionMatrix = getPositionMatrix(input, &output, uniforms.modelMatrix);\n    let localPosition = getPosition(vec3f(input.aPosition.xyz), input);\n\n    output.position = uniforms.projViewModelMatrix * localPositionMatrix * localPosition;\n    // 传入Position的depth值\n    fbo_picking_setData(input, &output, output.position.w, true);\n\n    return output;\n}\n"}};var $w={register(e,t){if(Qw[e])throw new Error(`Key of ${e} is already registered in WgslShaderLib.`);Qw[e]=t},compile:(e,t)=>new SourceCompiler(e,t).compile(),get:e=>Qw[e]};const Kw=/^[ \t]*#include +<([\w\d.]+)>/gm,eT=/\bstruct\s+VertexInput\b/,tT=/\bstruct\s+VertexOutput\b/;class SourceCompiler{constructor(e,t){this.defines=t,this.source=e,this.isVert=e.indexOf("@vertex")>-1,this.varyings=[],this.attributes=[]}compile(){let e=this.source;return e=this.parseIncludes(e),this.isVert&&(e=this.fillAttributes(e)),e=this.fillVaryings(e),e}parseIncludes(e){return e.replace(Kw,((e,t)=>{let n=t;(t.endsWith("_vert")||t.endsWith("_frag"))&&(n=t.substring(0,t.length-5));const i=Qw[n];if(!i)throw new Error("Can not resolve #include <"+t+">");if(i.defines&&!this.checkDefines(i.defines))return"";if(i.varyings)for(let e=0;e<i.varyings.length;e++){const t=i.varyings[e];t.defines&&!this.checkDefines(t.defines)||this.varyings.push(t)}if(i.attributes)for(let e=0;e<i.attributes.length;e++){const t=i.attributes[e];t.defines&&!this.checkDefines(t.defines)||this.attributes.push(t)}return this.parseIncludes(this.isVert?i.vert:i.frag)}))}fillAttributes(e){return this.fillStruct(e,eT,"$i",this.attributes)}fillVaryings(e){return this.fillStruct(e,tT,this.isVert?"$o":"$i",this.varyings)}fillStruct(e,t,n,i){if(!i.length)return e;const s=e.search(t),o=e.indexOf("}",s),a=e.substring(0,o),l=e.substring(o),h=[];for(let e=0;e<i.length;e++){const{name:t,type:s}=i[e];h.push(`@location(${n}) ${t}: ${s},`)}return a+h.join("\n")+"\n"+l}checkDefines(e){if(Array.isArray(e))for(let t=0;t<e.length;t++){if(!this.defines[e[t]])return!1}else if(!e(this.defines))return!1;return!0}}const nT={"=":"equal","<":"less","<=":"less-equal",lequal:"less-equal",">":"greater","!=":"not-equal",notequal:"not-equal",">=":"greater-equal",gequal:"greater-equal"};function rT(e){return nT[e]||e}const iT={triangles:"triangle-list","triangle strip":"triangle-strip",lines:"line-list"};const sT={0:"zero",1:"one","src color":"src","one minus src color":"one-minus-src","src alpha":"src-alpha","one minus src alpha":"one-minus-src-alpha","dst color":"dst","one minus dst color":"one-minus-dst","dst alpha":"dst-alpha","one minus dst alpha":"one-minus-dst-alpha"};function oT(e){return sT[e]||e}const aT={clamp:"clamp-to-edge",mirror:"mirror-repeat"};function lT(e,t,n,i,s){const o={magFilter:t};return"nearest"===e||"linear"===e?o.minFilter=e:"linear mipmap linear"===e||"mipmap"===e?(o.minFilter="linear",o.mipmapFilter="linear"):"nearest mipmap nearest"===e?(o.minFilter="linear",o.mipmapFilter="nearest"):"nearest mipmap linear"===e?(o.minFilter="nearest",o.mipmapFilter="linear"):"linear mipmap nearest"===e&&(o.minFilter="linear",o.mipmapFilter="nearest"),o.addressModeU=aT[n||"clamp"]||n,o.addressModeV=aT[i||"clamp"]||i,s&&(o.compare=s),o}class PipelineDescriptor{readFromREGLCommand(e,t,n,i){e||(e={});const s=t.getMaterial();let o=!1;s&&(o=s.doubleSided);this.topology=function(e){return iT[e]||"triangle-list"}(t.geometry.desc.primitive);const a=!i||!!i.depthTexture,l=!i||i.depthTexture&&i.depthTexture.gpuFormat.isDepthStencil;let h,c;if(this.functionProps=[],a&&e.polygonOffset&&hT(e.polygonOffset.enable,n))if(this.topology.startsWith("triangle")){const t=e.polygonOffset.offset;t&&!ux(t.units)&&(dx(t.units)?(h=t.units(null,n),this.functionProps.push({func:t.units,v:h})):h=t.units),t&&!ux(t.factor)&&(dx(t.factor)?(c=t.factor(null,n),this.functionProps.push({func:t.factor,v:c})):c=t.factor)}else h=0,c=0;this.depthBias=h,this.depthBiasSlopeScale=c;let u="less",f=!0;const g=e.depth;if(a&&g&&hT(g.enable,n)){if(g.func){let e=g.func;dx(g.func)&&(e=e(null,n),this.functionProps.push({func:g.func,v:e})),u=rT(e)}f=!0,ux(g.mask)||(dx(g.mask)?(f=g.mask(null,n),this.functionProps.push({func:g.mask,v:f})):f=!!g.mask)}let m,A;this.depthCompare=u,this.depthWriteEnabled=f;const w=e.stencil;if(l&&w&&hT(w.enable,n)&&(w.op&&(A=w.op.zpass,dx(A)&&(A=A(null,n),this.functionProps.push({func:w.op.zpass,v:A}))),w.func)){let e=w.func.cmp;e||(e="always");let t=e;dx(t)&&(t=e(null,n),this.functionProps.push({func:e,v:t})),m=rT(t)}let T,S,M,C;this.stencilFrontCompare=m,this.stencilFrontPassOp=A;const I=e.blend;if(I&&hT(I.enable,n)&&I.func){const e=I.func;if(e.src){let t=e.src;dx(e.src)&&(t=e.src(null,n),this.functionProps.push({func:e.src,v:t})),T=oT(t),M=T}if(e.dst){let t=e.dst;dx(e.dst)&&(t=e.dst(null,n),this.functionProps.push({func:e.dst,v:t})),S=oT(t),C=S}if(e.srcAlpha){let t=e.srcAlpha;dx(e.srcAlpha)&&(t=e.srcAlpha(null,n)||this.functionProps.push({func:e.srcAlpha,v:t})),T=oT(t)}if(e.srcRGB){let t=e.srcRGB;dx(e.srcRGB)&&(t=e.srcRGB(null,n)||this.functionProps.push({func:e.srcRGB,v:t})),M=oT(t)}if(e.dstAlpha){let t=e.dstAlpha;dx(e.dstAlpha)&&(t=e.dstAlpha(null,n)||this.functionProps.push({func:e.dstAlpha,v:t})),S=oT(t)}if(e.dstRGB){let t=e.dstRGB;dx(e.dstRGB)&&(t=e.dstRGB(null,n)||this.functionProps.push({func:e.dstRGB,v:t})),C=oT(t)}}this.blendAlphaDst=S,this.blendAlphaSrc=T,this.blendColorDst=C,this.blendColorSrc=M;let E="none";if(!o){const t=e.cull;t&&hT(t.enable,n)&&(E="back",t.face&&(E=t.face,dx(t.face)&&(E=t.face(null,n)||this.functionProps.push({func:t.face,v:E}))))}this.cullMode=E,this.frontFace=e.frontFace;let D=e.colorMask;if(D){dx(D)&&(D=D(null,n),this.functionProps.push({func:e.colorMask,v:D}));let t=0;D[0]&&(t|=GPUColorWrite.RED),D[1]&&(t|=GPUColorWrite.GREEN),D[2]&&(t|=GPUColorWrite.BLUE),D[3]&&(t|=GPUColorWrite.ALPHA),this.writeMask=t}}generateValuesKey(e){return e.map((e=>Array.isArray(e)?e.join():e)).join("-")}getFnValuesKey(){return this.generateValuesKey(this.functionProps.map((e=>e.v)))}getSignatureKey(){return(this.depthBias||0)+"-"+(this.depthBiasSlopeScale||0)+"-"+(this.depthCompare||0)+"-"+(this.depthWriteEnabled||0)+(this.stencilFrontCompare||0)+"-"+(this.stencilFrontPassOp||0)+(this.blendAlphaSrc||0)+"-"+(this.blendAlphaDst||0)+"-"+(this.blendColorSrc||0)+"-"+(this.blendColorDst||0)+(this.cullMode||0)+"-"+(this.frontFace||0)+"-"+(this.topology||0)+"-"+(this.writeMask||0)}}function hT(e,t){return dx(e)?!!(e=e(null,t)):!!e}class GraphicsTexture{constructor(e,t){this._bindGroups=[],this.device=e,this.config=t,this.gpuFormat=function(e,t){if("depth stencil"===(e=e||"rgba")||"depth24 stencil8"===e)return{format:"depth24plus-stencil8",bytesPerTexel:4,isDepthStencil:!0};if("depth"===e)return{format:"depth24plus",bytesPerTexel:4,isDepthStencil:!1};if("alpha"===e)return{format:"r8unorm",bytesPerTexel:1,isDepthStencil:!1};if("uint8"===(t=t||"uint8")){let t=e;return"rgba"===e&&(t="rgba8unorm"),{format:t,bytesPerTexel:4,isDepthStencil:!1}}return"float16"===t||"half float"===t?{format:"r16float",bytesPerTexel:2,isDepthStencil:!1}:"float"===t?{format:"r32float",bytesPerTexel:4,isDepthStencil:!1}:{format:e,bytesPerTexel:4,isDepthStencil:!1}}(t.format,t.type),this.update(this.config)}get width(){return this.texture&&this.texture.width||this.config&&this.config.width}get height(){return this.texture&&this.texture.height||this.config&&this.config.height}updateFilter(){this._clearBindGroups()}_clearBindGroups(){if(this._bindGroups.length){for(let e=0;e<this._bindGroups.length;e++)this._bindGroups[e].outdated=!0;this._bindGroups=[]}}resize(e,t){this.texture&&this.texture.width===e&&this.texture.height===t||(this.config.width=e,this.config.height=t,this.update(this.config))}update(e){const t=this.device.wgpu;let n;this.texture&&(this.texture.destroy(),this._clearBindGroups());{let i=e.width,s=e.height;if(void 0===i||void 0===s){const t=e.data;if(yx(e.data)){i=Math.sqrt(e.data.length/4),s=i}else i=t.width,s=t.height}const o=this.gpuFormat.format,a={size:[i,s,1],format:o,usage:"depth24plus"===o||"depth24plus-stencil8"===o?GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT};if(e.sampleCount&&(a.sampleCount=e.sampleCount),n=t.createTexture(a),e.data)if(yx(e.data)){let o=e.data;Array.isArray(e.data)&&(o=new Float32Array(o)),t.queue.writeTexture({texture:n},o.buffer,{bytesPerRow:i*this.gpuFormat.bytesPerTexel},[i,s])}else t.queue.copyExternalImageToTexture({source:e.data,flipY:!!this.config.flipY},{texture:n,premultipliedAlpha:!0},[i,s])}this.texture=n}getView(){return this.texture.createView()}addBindGroup(e){this._bindGroups.push(e)}destroy(){this.texture&&(this.texture.destroy(),delete this.texture),delete this._bindGroups}}class GraphicsFramebuffer{constructor(e,t){this.device=e,this.options=t,this._update()}get color(){return[this.colorTexture]}resize(e,t){if((!this.colorTexture||e!==this.colorTexture.width||t!==this.colorTexture.height)&&(this.options.width=e,this.options.height=t,this.colorTexture&&this.colorTexture.resize(e,t),this.depthTexture&&this.depthTexture.resize(e,t),this._renderPass)){const e=this._renderPass.colorAttachments[0];e&&e.view&&this.colorTexture&&(e.view=this.colorTexture.getView());const t=this._renderPass.depthStencilAttachment;t&&t.view&&this.depthTexture&&(t.view=this.depthTexture.getView())}}_update(){let e=this.options.colors&&this.options.colors[0]||this.options.color;const t=this.options.colorFormat,n=this.options.colorType;let i,s;e?(i=e.width,s=e.height):(t||n)&&(e=!0),ux(this.options.width)||(i=this.options.width),ux(this.options.height)||(s=this.options.height),this.width=i,this.height=s,!e||e instanceof GraphicsTexture||(!0===e&&(e={width:i,height:s}),e.width||(e.width=i),e.height||(e.height=s),e.format||(e.format=t||"rgba"),e.type||(e.type=n||"uint8"),this._ownColor=!0,e=new GraphicsTexture(this.device,e));let o=this.options.depth;o&&(!0===o?(this._ownDepthTexture=!0,o=new GraphicsTexture(this.device,{width:i,height:s,format:"depth"})):o instanceof GraphicsTexture||(this._ownDepthTexture=!0,o=new GraphicsTexture(this.device,o)));const a=this.options.depthStencil;if(a&&(!0===a?(this._ownDepthTexture=!0,o=new GraphicsTexture(this.device,{width:i,height:s,format:"depth stencil"})):a instanceof GraphicsTexture?o=a:(this._ownDepthTexture=!0,o=new GraphicsTexture(this.device,a))),this.colorTexture=e,this.depthTexture=o,this._renderPass={colorAttachments:[]},null!==e&&(this._renderPass.colorAttachments[0]={view:this.colorTexture&&this.colorTexture.getView(),clearValue:[0,0,0,0],loadOp:"load",storeOp:"store"}),o){const e=this._renderPass.depthStencilAttachment={view:this.depthTexture.getView(),depthClearValue:1,depthLoadOp:"load",depthStoreOp:"store"};o.gpuFormat.isDepthStencil&&(e.stencilReadOnly=!1,e.stencilClearValue=0,e.stencilLoadOp="load",e.stencilStoreOp="store")}}getRenderPassDescriptor(){const e=this._renderPass.colorAttachments[0],t=this._renderPass.depthStencilAttachment;let n,i;if(!this.colorTexture){const t=this.device.context.getCurrentTexture();n=t.width,i=t.height,e.view=t.createView(),e.view.label="default canvas view"}if(e&&(e.loadOp=this.colorLoadOp||"load",e.clearValue=this.colorClearValue||[0,0,0,0]),t){t.depthLoadOp=this.depthLoadOp||"load",t.depthClearValue=this.depthClearValue||1;const e=this.depthTexture;e.gpuFormat.isDepthStencil&&(t.stencilLoadOp=this.stencilLoadOp||"load",t.stencilClearValue=this.stencilClearValue||0),e&&n&&i&&(e.width!==n||e.height!==i)&&(e.resize(n,i),t.view=e.getView())}return this._resetClearOptions(),this._renderPass}setClearOptions(e){e.color&&(this.colorLoadOp="clear",this.colorClearValue=e.color),e.depth&&(this.depthLoadOp="clear",this.depthClearValue=e.depth),e.stencil&&(this.stencilLoadOp="clear",this.stencilClearValue=e.stencil)}_resetClearOptions(){this.colorLoadOp=null,this.colorClearValue=null,this.depthLoadOp=null,this.depthClearValue=null,this.stencilLoadOp=null,this.stencilClearValue=null}destroy(){this._ownColor&&this.colorTexture&&(this.colorTexture.destroy(),delete this.colorTexture),this._ownDepthTexture&&this.depthTexture&&(this.depthTexture.destroy(),delete this.depthTexture,delete this._ownDepthTexture)}}let cT=0;class BindGroupFormat{constructor(e,t,n){this.name=e,this.uuid=cT++,this.groups=t.groups,this.alignment=n,this._parse(t)}getShaderUniforms(){return this._shaderUniforms}getMeshUniforms(){return this._meshUniforms}_parse(e){this._shaderUniforms=[],this._shaderUniforms.index=0,this._shaderUniforms.totalSize=0,this._meshUniforms=[],this._meshUniforms.index=0,this._meshUniforms.totalSize=0;const t=e.groups;if(!t)return;const n=t[0];if(n)for(let e=0;e<n.length;e++){const t=n[e];if(t)if(t.isGlobal){let e=this._shaderUniforms.index;this._shaderUniforms[e++]=t,this._shaderUniforms.index=e,this._shaderUniforms.totalSize+=bb(t.size,this.alignment)}else{let e=this._meshUniforms.index;this._meshUniforms[e++]=t,this._meshUniforms.index=e,this._meshUniforms.totalSize+=bb(t.size,this.alignment)}}}createBindGroup(e,t,n,i,s,o){const a=this.name+"-"+t.uuid;if(!this.groups)return e.wgpu.createBindGroup({layout:i,label:a,entries:[]});const l=this.groups[0],h=[],c=[];for(let i=0;i<l.length;i++){const a=l[i];if(!a)continue;const u=a.name;if(a.resourceType===_w.Sampler){const i=u.substring(0,u.length-7);let s=n&&n[i]||t.getUniform(i)||t.material&&t.material.getUniform(i);if(s instanceof GraphicsFramebuffer&&(s=s.colorTexture),!s)continue;const{min:o,mag:l,wrapS:c,wrapT:f,compare:g}=s.config,m=lT(o,l,c,f,g),A=e.wgpu.createSampler(m);h.push({binding:a.binding,resource:A})}else if(a.resourceType===_w.Texture){const i=n&&n[u]||t.getUniform(u)||t.material&&t.material.getUniform(u);let s=i;if(s instanceof AbstractTexture&&(s=i.getREGLTexture(e)),s instanceof GraphicsFramebuffer&&(s=s.colorTexture),!s)continue;c.push(s),h.push({binding:a.binding,resource:s.getView()})}else{h.push({binding:a.binding,resource:{buffer:(a.isGlobal?s.allocation:o.allocation).gpuBuffer,size:bb(a.size,this.alignment)}})}}const u=e.wgpu.createBindGroup({layout:i,label:a,entries:h});for(let e=0;e<c.length;e++)c[e].addBindGroup(u);return u}dispose(){delete this._shaderUniforms,delete this._meshUniforms,delete this.groups}}const uT=/\s*#define\s+(\w+)\s+([^\n]+)/g,fT=/#([^\s]*)(\s*)/gm,dT=/#[^\s]*\s*\b[0-9A-Z][0-9A-Z_&&\|=! ]+\b/g;function pT(e,t){var n;if(!e)return;const i=e.matchAll(uT),s={};for(const e of i)s[e[1]]=e[2];let o=gT(e=e.replace(/#define.*$/gm,""),s);const a=null===(n=o.match(dT))||void 0===n?void 0:n.filter((e=>!(e=>!isNaN(e))(e)&&""!=e)).map((e=>{const t=e.indexOf(" ");return e.substring(t).trim()})),{normalizeDefines:l,constValues:h}=function(e,t){var n;const i=new Set,s=null===(n=null==e?void 0:e.map)||void 0===n?void 0:n.call(e,(e=>mT(e,t,i))),o={};for(const e in t)i.has(e)||(o[e]=t[e]);return{normalizeDefines:s,constValues:o}}(a,t);o=gT(o,h);const c=function(e,t){let n=e;const i=(null==t?void 0:t.map((e=>{const t=n.indexOf(e),i=n.slice(0,t);return n=n.slice(t+e.length),i})))||[];(null==i?void 0:i.length)&&i.push(n);return i}(o,a);return c.length>0?function(e,t){const n=[];let i=new ConditionalState(!0);i.elseIsValid=!1;const s=(e,t)=>{if(e.index+e[0].length!=t.length)throw new Error(`#${e[1]} must be immediately followed by a template expression (ie: \${value})`)};for(let o=0;o<e.length;++o){const a=e[o],l=a.matchAll(fT);let h=0,c=!1;for(const e of l){switch(i.appendStringToCurrentBranch(a.substring(h,e.index)),e[1]){case"if":case"ifdef":case"ifndef":s(e,a),c=!0,n.push(i);i=new ConditionalState("ifndef"===e[1]?!t[o]:!!t[o]);break;case"elif":s(e,a),c=!0,i.pushBranch(e[1],t[o]);break;case"else":i.pushBranch(e[1],!0),i.appendStringToCurrentBranch(e[2]);break;case"endif":if(!n.length)throw new Error(`#${e[1]} not preceeded by an #if`);const l=i.resolve();i=n.pop(),i.appendStringToCurrentBranch(l,e[2]);break;default:i.appendStringToCurrentBranch(e[0])}h=e.index+e[0].length}h!=a.length&&i.appendStringToCurrentBranch(a.substring(h,a.length)),!c&&t.length>o&&i.appendStringToCurrentBranch(t[o])}if(n.length)throw new Error("Mismatched #if/#endif count");return i.resolve()}(c,l):o}class ConditionalState{constructor(e){this.elseIsValid=!0,this.branches=[],this.pushBranch("if",e)}pushBranch(e,t){if(!this.elseIsValid)throw new Error(`#${e} not preceeded by an #if or #elif`);this.elseIsValid="if"===e||"elif"===e,this.branches.push({expression:!!t,string:""})}appendStringToCurrentBranch(...e){for(const t of e)this.branches[this.branches.length-1].string+=t}resolve(){for(const e of this.branches)if(e.expression)return e.string;return""}}function gT(e,t){var n;if(!t)return e;let i=e;const s=Object.keys(t);return null===(n=null==s?void 0:s.forEach)||void 0===n||n.call(s,(e=>{const n=new RegExp("\\b"+e+"\\b","g");i=i.replace(n,t[e]+"")})),i}function mT(e,t,n){if((null==e?void 0:e.includes("&&"))||(null==e?void 0:e.includes("||"))){if(e.includes("&&")){const i=e.split("&&").map((e=>e.trim()));return function(e,t,n){var i;let s=0;return null===(i=null==e?void 0:e.forEach)||void 0===i||i.call(e,(e=>s+=Number(AT(t,e,n)||0)>1?1:Number(AT(t,e,n)||0))),s===e.length}(i,t,n)}const i=e.split("||").map((e=>e.trim()));return!function(e,t,n){var i;let s=0;return null===(i=null==e?void 0:e.forEach)||void 0===i||i.call(e,(e=>{const i=AT(t,e,n);return s+=i?1:0})),0===s}(i,t,n)}return AT(t,e,n)}function AT(e,t,n){if(t&&t.startsWith&&t.startsWith("!"))return t=t.substring(1),n&&n.add(t),!e[t];if(t&&t.includes&&(t.includes("==")||t.includes("!="))){const i=t.includes("=="),s=t.split(i?"==":"!=").map((e=>e.trim()));return n&&n.add(s[0]),i?e[s[0]]===+s[1]:e[s[0]]!==+s[1]}return n&&n.add(t),e[t]}var yT=Object.freeze({__proto__:null,WGSLParseDefines:pT,getDefineConditionValue:mT});class CommandBuilder{constructor(e,t,n,i,s,o,a,l){this.name=e,this.device=t,this.vert=n,this.frag=i,this.mesh=s,this.contextDesc=o,this.defines=a,this.uniformValues=l}build(e,t){const n=this.mesh,i=this.device,s=this.defines;let o=MT(this.vert),a=MT(this.frag);try{o=pT(o,s)}catch(e){throw e.message=this.name+"(vert):"+e.message,e}try{a=pT(a,s)}catch(e){throw e.message=this.name+"(frag):"+e.message,e}o=TT(o),a&&(a=TT(a));const{source:l,index:h}=ST(o,0);if(o=l,a){const{source:e}=ST(a,h);a=e}const c=new WgslReflect(o),u=this._formatBufferInfo(c,n);let f;a&&(f=new WgslReflect(a));const g=c.getBindGroups();let m=[];f&&(m=f.getBindGroups());const A=this._createBindGroupLayout(g,m,n,this.uniformValues),w=this._createPipeline(i,o,u,a,A,n,e,t),T=this._createBindGroupMapping(g,m,n);return{uid:-1,layout:A,pipeline:w,vertexInfo:u,bindGroupFormat:new BindGroupFormat(this.name,T,i.wgpu.limits.minUniformBufferOffsetAlignment),bindGroupMapping:T,activeAttributes:this._getActiveAttributes()}}_getActiveAttributes(){const e=[{name:"position",type:1}];return e.key=e.map((e=>e.name)).join(),e}_createBindGroupLayout(e,t,n,i){const s=[];for(let t=0;t<e.length;t++){const o=e[t];for(let e=0;e<o.length;e++){const t=o[e];if(!t)continue;const a=this._createLayoutEntry(t.binding,GPUShaderStage.VERTEX,t,n,i);s.push(a)}}for(let e=0;e<t.length;e++){const o=t[e];for(let e=0;e<o.length;e++){const t=o[e];if(!t)continue;const a=this._createLayoutEntry(t.binding,GPUShaderStage.FRAGMENT,t,n,i);s.push(a)}}return s.sort(xT),this.device.wgpu.createBindGroupLayout({label:this.name+"-bindgrouplayout",entries:s})}_createLayoutEntry(e,t,n,i,s){if(n.resourceType===_w.Sampler){const i={};return n.type&&"sampler_comparison"===n.type.name&&(i.type="comparison"),{binding:e,visibility:t,sampler:i}}if(n.resourceType===_w.Texture){const o=n.name,a=s[o]||i.material&&i.material.get(o);let l;a&&(a instanceof Texture2D?l=a.config.type:a instanceof GraphicsTexture&&(l=a.gpuFormat.format));let h="float";return l&&l.startsWith("depth")&&(h="depth"),{binding:e,visibility:t,texture:{sampleType:h}}}return{binding:e,visibility:t,buffer:{type:"uniform",hasDynamicOffset:!0}}}_formatBufferInfo(e,t){const n=e.entry.vertex[0].inputs,i={};for(let e=0;e<n.length;e++){i[n[e].name]=n[e]}const s={},o=t.geometry.data,a=t.geometry.semantic;for(const e in o){const t=a[e]||e,n=i[t];n&&(s[t]={geoAttrName:e,location:n.location,itemSize:vT(n.type)})}if(t instanceof InstancedMesh){const e=t.instancedData;for(const t in e)i[t]&&(s[t]={geoAttrName:t,location:i[t].location,itemSize:vT(i[t].type)})}return s}_createBindGroupMapping(e,t,n){const i={};return this._parseGroupMapping(i,e[0],n,"vert"),this._parseGroupMapping(i,t[0],n,"frag"),i}_parseGroupMapping(e,t,n,i){if(t)for(let s=0;s<t.length;s++){const o=t[s];if(!o)continue;const{group:a,binding:l}=o,h=o.members;let c=!1;if(h&&h.length)for(let e=0;e<h.length;e++){const t=h[e].name;if(_T(n,t,this.contextDesc)){if(c)throw new Error("Found a mesh uniform in global struct:"+t+"("+o.name+") in "+this.name+"_"+i)}else{if(!c&&e>0)throw new Error("Found a global uniform in mesh struct:"+t+"("+o.name+") in "+this.name+"_"+i);c=!0}}else{_T(n,o.name,this.contextDesc)||(c=!0)}e.groups=e.groups||[],e.groups[a]=e.groups[a]||[],o.isGlobal=c,o.index=e.groups[a][l]=o}}_createPipeline(e,t,n,i,s,o,a,l){const h=e.wgpu,c=h.createShaderModule({label:this.name+"-vertmodule",code:t});let u;i&&(u=h.createShaderModule({label:this.name+"-fragmodule",code:i})),this._presentationFormat||(this._presentationFormat=navigator.gpu.getPreferredCanvasFormat());const f=o.geometry.getBufferDescriptor(n);if(o instanceof InstancedMesh){const e=o.getBufferDescriptor(n);for(let t=0;t<e.length;t++)e[t]&&(f[t]=e[t])}const g=h.createPipelineLayout({label:this.name+"-pipelinelayout",bindGroupLayouts:[s]}),m={label:this.name+"-pipeline",layout:g,vertex:{module:c,buffers:f},primitive:{topology:a.topology,cullMode:a.cullMode}},A=l&&l.colorTexture&&l.colorTexture.config.sampleCount;A&&(m.multisample={count:A});if(!l||!!l.depthTexture){const e=l&&l.depthTexture;m.depthStencil={depthBias:a.depthBias,depthBiasSlopeScale:a.depthBiasSlopeScale,depthWriteEnabled:a.depthWriteEnabled,depthCompare:a.depthCompare,format:!e||e.gpuFormat.isDepthStencil?"depth24plus-stencil8":"depth24plus"}}if(u){const e=a.writeMask;m.fragment={module:u,targets:[{format:l&&l.colorTexture&&l.colorTexture.gpuFormat.format||this._presentationFormat,writeMask:ux(e)?GPUColorWrite.ALL:e}]}}if(a.stencilFrontCompare&&(m.depthStencil.stencilBack=m.depthStencil.stencilFront={compare:a.stencilFrontCompare,passOp:a.stencilFrontPassOp}),u&&a.blendAlphaDst){const e=m.fragment.targets;for(const t of e)t.blend={color:{srcFactor:a.blendColorSrc,dstFactor:a.blendColorDst,operation:"add"},alpha:{srcFactor:a.blendAlphaSrc,dstFactor:a.blendAlphaDst,operation:"add"}}}return h.createRenderPipeline(m)}}function _T(e,t,n){return"modelMatrix"===t||"positionMatrix"===t||"projViewModelMatrix"===t||"modelViewMatrix"===t||"modelNormalMatrix"===t||"polygonFill"===t||"polygonOpacity"===t||"lineColor"===t||"lineOpacity"===t||(n[t]&&!n[t].global||e.hasUniform(t)||e.material&&e.material.hasUniform(t))}function vT(e){return e.name.startsWith("vec")?parseInt(e.name[3]):1}function xT(e,t){return e.binding-t.binding}let bT=0;const wT=()=>""+bT++;function TT(e){bT=0;const t=e.replaceAll("$i",wT);bT=0;return t.replaceAll("$o",wT)}function ST(e,t){return bT=t,{source:e.replaceAll("$b",wT),index:bT}}function MT(e){return e?e.replace(/[ \t]*\/\/.*\n/g,"").replace(/[ \t]*\/\*[\s\S]*?\*\//g,""):e}class DynamicOffsets{constructor(){this.items=[],this.offsets=[],this.index=0}reset(){this.index=0}addItem(e,t){const n=this.index++,i=this.items[n];i?(i.binding=e,i.offset=t):this.items[n]={binding:e,offset:t}}addItems(e){for(let t=0;t<e.length;t++)this.addItem(e[t].binding,e[t].offset)}getItems(){return this.items.slice(0,this.index)}getDynamicOffsets(){const e=this.getItems();e.sort(((e,t)=>e.binding-t.binding)),this.offsets.length=e.length;for(let t=0;t<e.length;t++)this.offsets[t]=e[t].offset;return this.offsets}}const CT="function",PT="array";let IT=0;const kT={};class GLShader{constructor({vert:e,frag:t,wgslVert:n,wgslFrag:i,uniforms:s,defines:o,extraCommandProps:a,name:l}){this.name=l,this.vert=e,this.frag=t,this.wgslVert=n,this.wgslFrag=i;const h=IT++;Object.defineProperty(this,"uid",{enumerable:!0,configurable:!1,get:()=>h}),this.shaderDefines=o&&px({},o)||{},s=this.uniforms=(s||[]).slice(),this.contextDesc={};for(let e=0,t=s.length;e<t;e++){const t=s[e];if(cx(t))if(t.indexOf("[")>0){const{name:e,len:n}=OT(t);this.contextDesc[e]={name:e,type:"array",length:n}}else this.contextDesc[t]=null;else if(t.name.indexOf("[")>0){const{name:e,len:n}=OT(t.name);this.contextDesc[e]={name:e,type:"array",length:n,fn:t.fn}}else this.contextDesc[t.name]=t}this.extraCommandProps=a&&px({},a)||{},this.commands={},this._compileSource()}set shaderDefines(e){this._shaderDefines=e,this.dkey=Object.keys(this._shaderDefines).join()}get shaderDefines(){return this._shaderDefines||{}}setDefines(e){this.shaderDefines=e}setFramebuffer(e){return this.context.framebuffer=e,this}run(e,t,n){return t(n)}getShaderCommandKey(e,t,n){return this.dkey||"default"}getVersion(e,t){if("#version"===t.substring(0,8))return"";return 0===e.limits.version.indexOf("WebGL 2.0")&&300===this.version?"#version 300 es\n":"#version 100\n"}getActiveVars(e,t,n,i){const s=i;if(kT[s])return kT[s];const o=e._gl,a=o.createProgram(),l=o.createShader(35633);o.shaderSource(l,t),o.compileShader(l);const h=o.createShader(35632);o.shaderSource(h,n),o.compileShader(h),o.attachShader(a,h),o.attachShader(a,l),o.linkProgram(a);const c=o.getProgramParameter(a,35721),u=[];for(let e=0;e<c;++e){const t=o.getActiveAttrib(a,e);t&&u.push({name:t.name,type:t.type})}const f=o.getProgramParameter(a,35718),g=[];for(let e=0;e<f;++e){const t=o.getActiveUniform(a,e);let n=t.name;t.name.indexOf("[")>0&&(n=n.replace("[0]","")),g.push(n)}return o.deleteProgram(a),o.deleteShader(l),o.deleteShader(h),kT[s]={activeUniforms:g,activeAttributes:u},kT[s]}_insertDefines(e,t){const n=[];for(const e in t)wx(t,e)&&!dx(t[e])&&n.push(`#define ${e} ${t[e]}\n`);return n.join("")+e}createMeshCommand(e,t,n={},i){const s=t.getDefines(),o=t.getElements(),a=t instanceof InstancedMesh,l=t.disableVAO,h=bx(e)&&!l,c=px({},this.shaderDefines||{},s||{}),u=this._insertDefines(this.vert,c),f=this.getVersion(e,u)+u,g=this._insertDefines(this.frag,c),m=this.getVersion(e,g)+g,A=Ox(f)+"_"+Ox(m),{activeAttributes:w,activeUniforms:T}=this.getActiveVars(e,f,m,A),S={};w.forEach(((t,n)=>{const i=t.name;S[i]=h?n:e.prop(i)}));const M={};T.forEach((t=>{M[t]=e.prop(t)}));const C=this.contextDesc;for(const t in C)if(C[t]&&C[t].type===CT)M[t]=C[t].fn;else if(C[t]&&C[t].type===PT){const n=C[t].name,i=C[t].length;for(let t=0;t<i;t++){const i=`${n}[${t}]`;M[i]=e.prop(i)}}else M[t]=e.prop(t);const I={vert:f,frag:m,uniforms:M,attributes:S};h&&(I.vao=e.prop("vao")),h&&!a||!o||mx(o)||(I.elements=e.prop("elements")),I.count=e.prop("count"),I.offset=e.prop("offset"),I.primitive=e.prop("primitive"),I.framebuffer=e.prop("framebuffer"),a&&(I.instances=e.prop("instances")),px(I,this.extraCommandProps,n);const E=e(I);return w.key=w.map((e=>e.name)).join(),E.activeAttributes=w,E}dispose(){for(const e in this.commands){const t=this.commands[e];t&&(t.destroy&&!t[Nx]&&(t[Nx]=!0,t.destroy()))}this.commands={},delete this.vert,delete this.frag}appendDescUniforms(e,t){const n=t,i=this.contextDesc;for(const s in i)if(i[s])if("array"===i[s].type){const o=s,a=i[s].length;let l=t[s];if(i[s].fn&&(l=i[s].fn(null,t)),!l)continue;if(l.length!==a)throw new Error(`${o} uniform's length is not ${a}`);n[o]=n[o]||{};for(let t=0;t<a;t++)n[o][`${t}`]=l[t].getREGLTexture?l[t].getREGLTexture(e):l[t]}else"function"===i[s].type&&(Object.getOwnPropertyDescriptor(n,s)||Object.defineProperty(n,s,{configurable:!1,enumerable:!0,get:function(){return i[s].fn(null,t)}}));return n}setUniforms(e){if(e.modelMatrix||e.positionMatrix)throw new Error("modelMatrix or positionMatrix is reserved uniform name for Mesh, please change to another name");return this.contextKeys=e?Object.keys(e).join():null,this.context=e,this}_compileSource(){this.vert&&(this.vert=Ww.compile(this.vert)),this.frag&&(this.frag=Ww.compile(this.frag))}}function OT(e){const t=e.indexOf("["),n=e.indexOf("]");return{name:e.substring(0,t),len:+e.substring(t+1,n)}}const ET=new PipelineDescriptor;class GPUShader extends GLShader{getShaderCommandKey(e,t,n){if(e&&e.wgpu){const e=t.getShaderFnValues(this.uid);if(e){const{funcs:t,key:i,commandKey:s}=e;if(!t.length)return s;const o=t.map((e=>e(null,n)));if(ET.generateValuesKey(o)===i)return s}ET.readFromREGLCommand(this.extraCommandProps,t,n,this._gpuFramebuffer);const i=ET.getSignatureKey();return t.setShaderFnValues(this.uid,{funcs:ET.functionProps.map((e=>e.func)),key:ET.getFnValuesKey(),commandKey:i}),i}return super.getShaderCommandKey(e,t,n)}createMeshCommand(e,t,n,i){if(e&&e.wgpu){const s=this.context,o=this._gpuFramebuffer,a=px({},this.shaderDefines||{},t.getDefines()),{vert:l,frag:h}=this._compileWGSLSource(a),c=new CommandBuilder(this.name,e,l,h,t,this.contextDesc,a,s),u=new PipelineDescriptor,f=px({},this.extraCommandProps||{},n||{});u.readFromREGLCommand(f,t,i,o);const g=c.build(u,o);return g.uid=this.uid,g}return super.createMeshCommand(e,t,n)}_compileWGSLSource(e){const t=$w.compile(this.wgslVert,e);let n;return this.wgslFrag&&(n=$w.compile(this.wgslFrag,e)),{vert:t,frag:n}}run(e,t,n){if(!e.wgpu)return super.run(e,t,n);if(!n||!n.length)return;const i=e;this.isGPU=!0;const s=i.dynamicBufferPool,o=this._getCurrentRenderPassEncoder(i);o.setPipeline(t.pipeline);const{uid:a,bindGroupFormat:l,vertexInfo:h,layout:c}=t;this._buffers||(this._buffers={});let u=this._buffers[a];u||(u=this._buffers[a]=new DynamicBuffer(l.getShaderUniforms(),s)),this._dynamicOffsets||(this._dynamicOffsets=new DynamicOffsets),this._shaderDynamicOffsets||(this._shaderDynamicOffsets=new DynamicOffsets),this._shaderDynamicOffsets.reset(),u.writeBuffer(n[0],this._shaderDynamicOffsets);const f=this._shaderDynamicOffsets.getItems();for(let e=0;e<n.length;e++){this._dynamicOffsets.reset();const t=n[e].meshObject,g=t.writeDynamicBuffer(a,n[e],l.getMeshUniforms(),s,this._dynamicOffsets),m=l.uuid+"-"+g.version+"-"+u.version;let A=t.getBindGroup(m);A&&!A.outdated||(A=l.createBindGroup(i,t,n[e],c,u,g),t.setBindGroup(m,A)),this._dynamicOffsets.addItems(f);const w=this._dynamicOffsets.getDynamicOffsets();let T;o.setBindGroup(0,A,w),t instanceof InstancedMesh&&(T=t);for(const e in h){const n=h[e];let i=t.geometry.getBuffer(n.geoAttrName||e);!i&&T&&(i=T.getInstancedBuffer(e)),o.setVertexBuffer(n.location,i,0,i.byteLength)}const S=t.getElements(),M=t.geometry.getDrawOffset(),C=t.geometry.getDrawCount();let I=1;T&&(I=T.instanceCount),t.geometry.isIndexedElements()?(o.setIndexBuffer(S,S.itemType),o.drawIndexed(C,I,M)):o.draw(C,I,M)}o.end()}_getCurrentRenderPassEncoder(e){return e.getRenderPassEncoder(this._gpuFramebuffer)}setFramebuffer(e){return e?e.getRenderPassDescriptor?(this._gpuFramebuffer=e,this):super.setFramebuffer(e):this._gpuFramebuffer?(this._gpuFramebuffer=null,this):super.setFramebuffer(e)}dispose(){if(!this.isGPU)return void super.dispose();for(const e in this._buffers)this._buffers[e]&&this._buffers[e].dispose();const e=this.gpuCommands;for(let t=0;t<e.length;t++)e[t]&&e[t].bindGroupFormat&&e[t].bindGroupFormat.dispose()}}class MeshShader extends GPUShader{draw(e,t){if(!t||!t.length)return 0;const n=[];let i,s=0;for(let o=0,a=t.length;o<a;o++){if(!t[o].isValid()){o===a-1&&i&&n.length&&this.run(e,i,n);continue}if(!t[o].geometry.getDrawCount()||!this._runFilter(t[o])){o===a-1&&i&&n.length&&this.run(e,i,n);continue}const l=t[o].getRenderProps(e);this._ensureContextDefines(l),l.shaderContext=this.context,l.meshObject=t[o],this.appendDescUniforms(e,l);const h=this.getMeshCommand(e,t[o],l);t[o].appendGeoAttributes(l,e,h.activeAttributes),n.length&&i!==h&&(this.run(e,i,n),n.length=0),n.push(l),s++,o<a-1?i=h:o===a-1&&this.run(e,h,n)}return s}_ensureContextDefines(e){if(this.context&&(e.contextKeys||(e.contextKeys={}),e.contextKeys[this.uid]!==this.contextKeys)){for(const t in this.context)"framebuffer"===t||Object.getOwnPropertyDescriptor(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:function(){return this.shaderContext[t]}});Object.getOwnPropertyDescriptor(e,"framebuffer")||Object.defineProperty(e,"framebuffer",{configurable:!1,enumerable:!0,get:function(){return this.targetFramebuffer||this.shaderContext&&this.shaderContext.framebuffer}}),e.contextKeys[this.uid]=this.contextKeys}}_runFilter(e){const t=this.filter;if(!t)return!0;if(Array.isArray(t)){for(let n=0;n<t.length;n++)if(!t[n](e))return!1;return!0}return t(e)}getMeshCommand(e,t,n){this._cmdKeys||(this._cmdKeys={});const i=t.getMaterial();let s=!1;i&&(s=i.doubleSided);const o=this.getShaderCommandKey(e,t,n);let a=this._cmdKeys[o];a||(a=this._cmdKeys[o]={});const l=t.getCommandKey(e);a[l]||(a[l]=o+"_"+t.getCommandKey());const h=a[l];let c=this.commands[h];if(!c){const i={};s&&this.extraCommandProps&&(i.cull={enable:!1}),c=this.commands[h]=this.createMeshCommand(e,t,i,n)}return c}}var RT="#if __VERSION__ == 300\n#define attribute in\n#define varying out\n#endif\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main() {\n  gl_Position = vec4(aPosition, 0., 1.);\n  vTexCoord = aTexCoord;\n}";const LT=new Int8Array([-1,1,-1,-1,1,1,1,1,-1,-1,1,-1]),DT=new Uint8Array([0,1,0,0,1,1,1,1,0,0,1,0]);class QuadShader extends MeshShader{constructor(e){e.vert=e.vert||RT,e.extraCommandProps=e.extraCommandProps||{},e.extraCommandProps.depth||(e.extraCommandProps.depth={enable:!1,mask:!1}),e.extraCommandProps.stencil||(e.extraCommandProps.stencil={enable:!1}),super(e)}draw(e){return this._quadMesh||this._createQuadMesh(e),super.draw(e,this._quadMesh)}getMeshCommand(e){const t=this.dkey||"";return this.commands[t+"_quad"]||(this.commands[t+"_quad"]=this.createMeshCommand(e,this._quadMesh[0])),this.commands[t+"_quad"]}_createQuadMesh(e){const t=new Geometry({aPosition:LT,aTexCoord:DT},null,LT.length/2,{positionSize:2,primitive:"triangles"});t.generateBuffers(e),this._quadMesh=[new Mesh(t)]}dispose(){if(this._quadMesh){const e=this._quadMesh[0];e.geometry.dispose(),e.dispose()}return delete this._quadMesh,super.dispose()}}class FxaaShader extends QuadShader{constructor(){super({vert:RT,frag:"#define SHADER_NAME FXAA\nprecision mediump float;\nvarying vec2 vTexCoord;\nuniform float enableFXAA;\nuniform float enableToneMapping;\nuniform float enableSharpen;\nuniform vec2 resolution;\nuniform sampler2D textureSource;\n#ifdef HAS_NOAA_TEX\nuniform sampler2D noAaTextureSource;\n#endif\n#ifdef HAS_POINT_TEX\nuniform sampler2D pointTextureSource;\n#endif\n#ifdef HAS_TAA_TEX\nuniform sampler2D taaTextureSource;\n#ifdef HAS_FXAA_TEX\nuniform sampler2D fxaaTextureSource;\n#endif\n#endif\nuniform float pixelRatio;\nuniform float sharpFactor;\n#ifdef HAS_OUTLINE_TEX\nuniform sampler2D textureOutline;\nuniform float enableOutline;\nuniform float highlightFactor;\nuniform float outlineFactor;\nuniform float outlineWidth;\nuniform vec3 outlineColor;\n#endif\nvec2 c;\nvec4 d(vec2 e) {\n  \n#ifdef HAS_TAA_TEX\nvec4 f = texture2D(textureSource, e);\n  vec4 taa = texture2D(taaTextureSource, e);\n#ifdef HAS_FXAA_TEX\nvec4 h = texture2D(fxaaTextureSource, e);\n#else\nvec4 h = vec4(.0);\n#endif\nvec4 i = taa + f * (1. - taa.a);\n  return h + i * (1. - h.a);\n#else\nreturn texture2D(textureSource, e);\n#endif\n}\nvec3 j(const in vec3 k, const float l) {\n  vec2 m = pixelRatio / resolution.xy;\n  float n = .0;\n  vec4 o = texture2D(textureSource, c + m * vec2(-1., -1.));\n  o.rgb = mix(vec3(.0), o.rgb, sign(o.a));\n  n += mix(.0, 1., sign(o.a));\n  vec4 u = texture2D(textureSource, c + m * vec2(1.));\n  u.rgb = mix(vec3(.0), u.rgb, sign(u.a));\n  n += mix(.0, 1., sign(u.a));\n  vec4 v = texture2D(textureSource, c + m * vec2(1., -1.));\n  v.rgb = mix(vec3(.0), v.rgb, sign(v.a));\n  n += mix(.0, 1., sign(v.a));\n  vec4 A = texture2D(textureSource, c + m * vec2(-1., 1.));\n  A.rgb = mix(vec3(.0), A.rgb, sign(A.a));\n  n += mix(.0, 1., sign(A.a));\n  return k + l * (n * k - o.rgb - v.rgb - A.rgb - u.rgb);\n}\nvec4 B(const in vec4 k) {\n  return vec4(j(k.rgb, sharpFactor), k.a);\n}\nvec3 C(const vec3 x) {\n  const float a = 2.51;\n  const float b = .03;\n  const float D = 2.43;\n  const float E = .59;\n  const float F = .14;\n  return (x * (a * x + b)) / (x * (D * x + E) + F);\n}\nvec3 G(vec3 k) {\n  k = k / (k + vec3(1.));\n  return k = pow(k, vec3(1. / 2.2));\n}\n#ifdef HAS_OUTLINE_TEX\nvec4 H() {\n  float I = 2.;\n  float J = 1.;\n  float K = pixelRatio / resolution[0] * outlineWidth;\n  float L = pixelRatio / resolution[1] * outlineWidth;\n  vec4 M = (texture2D(textureOutline, c + vec2(K, L)));\n  vec4 N = (texture2D(textureOutline, c + vec2(K, .0)));\n  vec4 O = (texture2D(textureOutline, c + vec2(K, -L)));\n  vec4 P = (texture2D(textureOutline, c + vec2(.0, -L)));\n  vec4 Q = (texture2D(textureOutline, c + vec2(-K, -L)));\n  vec4 R = (texture2D(textureOutline, c + vec2(-K, .0)));\n  vec4 S = (texture2D(textureOutline, c + vec2(-K, L)));\n  vec4 T = (texture2D(textureOutline, c + vec2(.0, L)));\n  vec4 U = -I * R + I * N + -J * S + J * M + -J * Q + J * O;\n  vec4 V = -I * P + I * T + -J * Q + J * S + -J * O + J * M;\n  float W = sqrt(dot(V, V) + dot(U, U));\n  bool X = W < 1. / 65025.;\n  vec3 Y = (texture2D(textureOutline, c)).r * outlineColor;\n  if(Y == vec3(.0) || (highlightFactor == .0 && X)) {\n    return vec4(.0);\n  }\n  float Z = X ? highlightFactor : min(1., sqrt(W) * outlineFactor);\n  return Z * vec4(Y, 1.);\n}\nvec4 ba(const in vec4 k) {\n  vec4 H = H();\n  return H + vec4(k) * (1. - H.a);\n}\n#endif\nvoid main() {\n  c = vTexCoord;\n  vec4 k;\n  if(enableFXAA == 1.) {\n    \n  } else {\n    k = d(vTexCoord);\n  }\n  if(enableSharpen == 1.) {\n    k = B(k);\n  }\n#if defined(HAS_NOAA_TEX) || defined(HAS_POINT_TEX)\nvec4 bb = vec4(.0);\n  vec4 bc = vec4(.0);\n#ifdef HAS_POINT_TEX\nbb = texture2D(pointTextureSource, vTexCoord);\n#endif\n#ifdef HAS_NOAA_TEX\nbc = texture2D(noAaTextureSource, vTexCoord);\n#endif\nvec4 bd = bb + bc * (1. - bb.a);\n  k = bd + k * (1. - bd.a);\n#endif\nif(enableToneMapping == 1.) {\n    k.rgb = G(k.rgb);\n  }\n#ifdef HAS_OUTLINE_TEX\nk = ba(k);\n#endif\ngl_FragColor = k;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(e,t)=>t.resolution[0],height:(e,t)=>t.resolution[1]}}})}getMeshCommand(e,t){const n=this.dkey||"";return this.commands[n+"_fxaa"]||(this.commands[n+"_fxaa"]=this.createMeshCommand(e,t)),this.commands[n+"_fxaa"]}}var FT="#include <gl2_vert>\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 projViewModelMatrix;\nvarying vec2 vTexCoord;\nvoid main() {\n  gl_Position = projViewModelMatrix * vec4(aPosition, 0., 1.);\n  vTexCoord = aTexCoord;\n}",HT="precision mediump float;\n#include <gl2_frag>\nuniform sampler2D baseColorTexture;\nuniform float opacity;\nuniform vec4 baseColor;\nuniform float alphaTest;\n#ifdef HAS_DEBUG\nuniform sampler2D debugTexture;\n#endif\nvarying vec2 vTexCoord;\nvoid main() {\n  vec4 c = texture2D(baseColorTexture, vTexCoord);\n  c *= baseColor;\n#ifdef HAS_DEBUG\nvec4 d = texture2D(debugTexture, vTexCoord);\n  c = vec4(d.rgb + c.rgb * (1. - d.a), d.a + c.a * (1. - d.a));\n#endif\nif(c.a < alphaTest) {\n    discard;\n  }\n  c *= opacity;\n#if __VERSION__ == 100\ngl_FragColor = c;\n#endif\n}";class ImageShader extends MeshShader{constructor(e){const t=[],n=e&&e.extraCommandProps||{};e.vert=FT,e.frag=HT,super({name:"image",vert:FT,frag:HT,wgslVert:"",wgslFrag:"",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,n){return vA(t,n.projViewMatrix,n.modelMatrix)}}],extraCommandProps:n})}getMeshCommand(e,t){const n=t.getCommandKey(e);return this.commands["image_"+n]||(this.commands["image_"+n]=this.createMeshCommand(e,t)),this.commands["image_"+n]}}class PostProcessShader extends QuadShader{constructor(){super({vert:RT,frag:"precision mediump float;\nvarying vec2 vTexCoord;\nuniform vec2 resolution;\nuniform sampler2D textureSource;\nuniform float enableVignette;\nuniform float enableGrain;\nuniform float enableLut;\nuniform float timeGrain;\nuniform float grainFactor;\nuniform vec2 lensRadius;\nuniform float frameMod;\nuniform sampler2D lookupTable;\n#include <srgb_frag>\nfloat c(const in vec2 d) {\n  vec3 e = fract(vec3(d.xyx) * .1031);\n  e += dot(e, e.yzx + 19.19);\n  return fract((e.x + e.y) * e.z);\n}\nfloat f() {\n  float h = c(gl_FragCoord.xy + 1000.0 * fract(timeGrain));\n  float i = h * 2. - 1.;\n  h = i * inversesqrt(abs(i));\n  h = max(-1., h);\n  h = h - sign(i) + .5;\n  return (h + .5) * .5;\n}\nvec4 j(const in vec4 k) {\n  float l = f();\n  return vec4(mix(k.rgb, k.rgb * (k.rgb + (1. - k.rgb) * 2. * l), grainFactor), k.a);\n}\nfloat m(const in vec2 d, const in float n) {\n  vec3 o = vec3(.06711056, .00583715, 52.9829189);\n  return fract(o.z * fract(dot(d.xy + n * vec2(47., 17.) * .695, o.xy)));\n}\nfloat u() {\n  vec2 v = lensRadius;\n  v.y = min(v.y, v.x - 1e-4);\n  float A = m(gl_FragCoord.xy, frameMod);\n  A = (v.x - v.y) * (v.x + v.y) * .07 * (A - .5);\n  return smoothstep(v.x, v.y, A + distance(vTexCoord, vec2(.5)));\n}\nvec4 B(const in vec4 k) {\n  float l = u();\n  return vec4(linearTosRGB(sRGBToLinear(k.rgb) * l), clamp(k.a + (1. - l), .0, 1.));\n}\nvec4 C(in vec4 D, in sampler2D E) {\n  mediump float F = D.b * 63.;\n  mediump vec2 G;\n  G.y = floor(floor(F) / 8.);\n  G.x = floor(F) - G.y * 8.;\n  mediump vec2 H;\n  H.y = floor(ceil(F) / 8.);\n  H.x = ceil(F) - H.y * 8.;\n  highp vec2 I;\n  I.x = G.x * .125 + .5 / 512. + (.125 - 1. / 512.) * D.r;\n  I.y = G.y * .125 + .5 / 512. + (.125 - 1. / 512.) * D.g;\n#ifdef LUT_FLIP_Y\nI.y = 1. - I.y;\n#endif\nhighp vec2 J;\n  J.x = H.x * .125 + .5 / 512. + (.125 - 1. / 512.) * D.r;\n  J.y = H.y * .125 + .5 / 512. + (.125 - 1. / 512.) * D.g;\n#ifdef LUT_FLIP_Y\nJ.y = 1. - J.y;\n#endif\nlowp vec4 K = texture2D(E, I);\n  lowp vec4 L = texture2D(E, J);\n  lowp vec4 M = mix(K, L, fract(F));\n  return M;\n}\nvoid main() {\n  vec4 k = texture2D(textureSource, vTexCoord);\n  if(enableLut == 1.) {\n    k = C(k, lookupTable);\n  }\n  if(enableVignette == 1.) {\n    k = B(k);\n  }\n  if(enableGrain == 1.) {\n    k = j(k);\n  }\n  gl_FragColor = k;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(e,t)=>t.resolution[0],height:(e,t)=>t.resolution[1]}}})}getMeshCommand(e,t){return this.commands.postprocess||(this.commands.postprocess=this.createMeshCommand(e,t)),this.commands.postprocess}}const NT=[[.263385,-.0252475],[-.38545,.054485],[-.139795,-.5379925],[-.2793775,.6875475],[.7139025,.4710925],[.90044,-.16422],[.4481775,-.82799],[-.9253375,-.2910625],[.3468025,1.02292],[-1.13742,.33522],[-.7676225,-.9123175],[-.2005775,-1.1774125],[-.926525,.96876],[1.12909,-.7500325],[.9603,1.14625]],BT=NT.length,zT=[0,0];for(let e=0;e<NT.length;e++)zT[0]+=NT[e][0],zT[1]+=NT[e][1];zT[0]/=BT,zT[1]/=BT;class Jitter{constructor(e){this._frameNum=0,this._ratio=e||.05,this._avg=[zT[0]*this._ratio,zT[1]*this._ratio]}getRatio(){return this._ratio}setRatio(e){this._ratio!==e&&(this._ratio=e,this.reset()),this._avg=[zT[0]*this._ratio,zT[1]*this._ratio]}getAverage(){return this._avg}reset(){this._frameNum=0}getJitter(e){const t=this._frameNum%BT,n=this._ratio;return U_(e,NT[t][0]*n,NT[t][1]*n),e}frame(){this._frameNum++,this._frameNum%BT==0&&(this._frameNum=0)}getSampleCount(){return BT}}class BlurPass{constructor(e,t,n=5){this._regl=e,this._renderer=new Renderer(e),this._inputRGBM=t,this._level=n}render(e,t){this._initShaders(),this._createTextures(e),this._blur(e,t||0);const n={blurTex0:this._blur01Tex,blurTex1:this._blur11Tex,blurTex2:this._blur21Tex,blurTex3:this._blur31Tex,blurTex4:this._blur41Tex};return this._level>5&&(n.blurTex5=this._blur51Tex,n.blurTex6=this._blur61Tex),n}_blur(e,t){let n=this._blurUniforms;n||(n=this._blurUniforms={rgbmRange:7,blurDir:[0,0],outSize:[0,0],pixelRatio:[1,1],outputSize:[0,0]}),U_(n.outSize,e.width,e.height),this._blurOnce(this._blur0Shader,e,this._blur00FBO,this._blur01FBO,.5,t),this._blurOnce(this._blur1Shader,this._blur01FBO.color[0],this._blur10FBO,this._blur11FBO,.5),this._blurOnce(this._blur2Shader,this._blur11FBO.color[0],this._blur20FBO,this._blur21FBO,.5),this._blurOnce(this._blur3Shader,this._blur21FBO.color[0],this._blur30FBO,this._blur31FBO,.5),this._blurOnce(this._blur4Shader,this._blur31FBO.color[0],this._blur40FBO,this._blur41FBO,.5),this._level>5&&(this._blurOnce(this._blur5Shader,this._blur41FBO.color[0],this._blur50FBO,this._blur51FBO,.5),this._blurOnce(this._blur6Shader,this._blur51FBO.color[0],this._blur60FBO,this._blur51FBO,.5))}_blurOnce(e,t,n,i,s,o){const a=Math.ceil(s*t.width),l=Math.ceil(s*t.height);n.width===a&&n.height===l||n.resize(a,l),i.width===a&&i.height===l||i.resize(a,l);const h=this._blurUniforms;h.luminThreshold=o,h.TextureBlurInput=t,h.inputRGBM=+this._inputRGBM,U_(h.blurDir,0,1),U_(h.outputSize,n.width,n.height),this._renderer.render(e,h,null,n),h.luminThreshold=0,h.inputRGBM=1,U_(h.blurDir,1,0),h.TextureBlurInput=n.color[0],this._renderer.render(e,h,null,i)}dispose(){this._blur0Shader&&(this._blur0Shader.dispose(),delete this._blur0Shader,this._blur1Shader.dispose(),this._blur2Shader.dispose(),this._blur3Shader.dispose(),this._blur4Shader.dispose(),this._blur5Shader&&(this._blur5Shader.dispose(),this._blur6Shader.dispose(),delete this._blur5Shader)),this._blur00Tex&&(delete this._blur00Tex,this._blur00FBO.destroy(),this._blur01FBO.destroy(),this._blur10FBO.destroy(),this._blur11FBO.destroy(),this._blur20FBO.destroy(),this._blur21FBO.destroy(),this._blur30FBO.destroy(),this._blur31FBO.destroy(),this._blur40FBO.destroy(),this._blur41FBO.destroy(),this._blur50FBO&&(this._blur50FBO.destroy(),this._blur51FBO.destroy(),this._blur60FBO.destroy(),this._blur61FBO.destroy()))}_createTextures(e){if(this._blur00Tex)return;let t=e.width,n=e.height;this._blur00Tex=this._createColorTex(e,t,n),this._blur00FBO=this._createBlurFBO(this._blur00Tex),this._blur01Tex=this._createColorTex(e),this._blur01FBO=this._createBlurFBO(this._blur01Tex),t=Math.ceil(t/2),n=Math.ceil(n/2),this._blur10Tex=this._createColorTex(e,t,n),this._blur10FBO=this._createBlurFBO(this._blur10Tex),this._blur11Tex=this._createColorTex(e,t,n),this._blur11FBO=this._createBlurFBO(this._blur11Tex),t=Math.ceil(t/2),n=Math.ceil(n/2),this._blur20Tex=this._createColorTex(e,t,n),this._blur20FBO=this._createBlurFBO(this._blur20Tex),this._blur21Tex=this._createColorTex(e,t,n),this._blur21FBO=this._createBlurFBO(this._blur21Tex),t=Math.ceil(t/2),n=Math.ceil(n/2),this._blur30Tex=this._createColorTex(e,t,n),this._blur30FBO=this._createBlurFBO(this._blur30Tex),this._blur31Tex=this._createColorTex(e,t,n),this._blur31FBO=this._createBlurFBO(this._blur31Tex),t=Math.ceil(t/2),n=Math.ceil(n/2),this._blur40Tex=this._createColorTex(e,t,n),this._blur40FBO=this._createBlurFBO(this._blur40Tex),this._blur41Tex=this._createColorTex(e,t,n),this._blur41FBO=this._createBlurFBO(this._blur41Tex),this._level>5&&(t=Math.ceil(t/2),n=Math.ceil(n/2),this._blur50Tex=this._createColorTex(e,t,n),this._blur50FBO=this._createBlurFBO(this._blur50Tex),this._blur51Tex=this._createColorTex(e,t,n),this._blur51FBO=this._createBlurFBO(this._blur51Tex),t=Math.ceil(t/2),n=Math.ceil(n/2),this._blur60Tex=this._createColorTex(e,t,n),this._blur60FBO=this._createBlurFBO(this._blur60Tex),this._blur61Tex=this._createColorTex(e,t,n),this._blur61FBO=this._createBlurFBO(this._blur61Tex))}_createColorTex(e,t,n){return this._regl.texture({min:"linear",mag:"linear",type:"uint8",width:t||e.width,height:n||e.height})}_createBlurFBO(e){return this._regl.framebuffer({width:e.width,height:e.height,colors:[e],depth:!1,stencil:!1})}_initShaders(){if(!this._blur0Shader){const e={vert:RT,extraCommandProps:{viewport:{x:0,y:0,width:(e,t)=>t.outputSize[0],height:(e,t)=>t.outputSize[1]}},frag:"#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\nuniform float inputRGBM;\nuniform float luminThreshold;\n#define SHADER_NAME GAUSSIAN_BLUR0\nconst vec3 c = vec3(.2126, .7152, .0722);\nfloat d(const in vec3 e) {\n  return dot(e, c);\n}\nvec4 f(vec4 e) {\n  float h = max(sign(d(e.rgb) - luminThreshold), .0);\n  return e * h;\n}\nvec2 i;\nvec4 j(const in vec3 e, const in float k) {\n  vec4 l;\n  vec3 m = e / k;\n  l.a = clamp(max(max(m.r, m.g), max(m.b, 1e-6)), .0, 1.);\n  l.a = ceil(l.a * 255.) / 255.;\n  l.rgb = m / l.a;\n  return l;\n}\nvec3 n(const in vec4 e, const in float k) {\n  if(inputRGBM == .0)\n    return e.rgb;\n  return k * e.rgb * e.a;\n}\nvec4 o() {\n  vec3 u = .375 * (f(vec4(n(texture2D(TextureBlurInput, i.xy), rgbmRange), 1.))).rgb;\n  vec2 v;\n  vec2 A = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  v = A * 1.2;\n  u += .3125 * (f(vec4(n(texture2D(TextureBlurInput, i.xy + v.xy), rgbmRange), 1.))).rgb;\n  u += .3125 * (f(vec4(n(texture2D(TextureBlurInput, i.xy - v.xy), rgbmRange), 1.))).rgb;\n  return vec4(u, 1.);\n}\nvoid main(void) {\n  i = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = o();\n  e = j(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}"};this._blur0Shader=new QuadShader(e),e.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR1\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .3125 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.2857142857142858;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur1Shader=new QuadShader(e),e.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR2\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .2734375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.3333333333333333;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.111111111111111;\n  l += .03515625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .03515625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur2Shader=new QuadShader(e),e.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR3\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .24609375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.3636363636363635;\n  l += .322265625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .322265625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.1818181818181817;\n  l += .0537109375 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .0537109375 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur3Shader=new QuadShader(e),e.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR4\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .2255859375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.3846153846153846;\n  l += .314208984375 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .314208984375 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.230769230769231;\n  l += .06982421875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .06982421875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 5.076923076923077;\n  l += .003173828125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .003173828125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur4Shader=new QuadShader(e),this._level>5&&(e.frag="precision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 outSize;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR5\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .20947265625 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  n *= outSize.y * .00075;\n  m = n * 1.4;\n  l += .30548095703125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .30548095703125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.2666666666666666;\n  l += .08331298828125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .08331298828125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 5.133333333333334;\n  l += .00640869140625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .00640869140625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur5Shader=new QuadShader(e),e.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 outSize;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR6\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .196380615234375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  n *= outSize.y * .00075;\n  m = n * 1.411764705882353;\n  l += .2967529296875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .2967529296875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.2941176470588234;\n  l += .09442138671875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .09442138671875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 5.176470588235294;\n  l += .0103759765625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .0103759765625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur6Shader=new QuadShader(e))}}}class BloomPass{constructor(e){this._regl=e,this._renderer=new Renderer(e)}render(e,t,n,i,s,o,a,l,h){this._initShaders(),this._createTextures(e);const c=this._blurPass.render(t,n);return this._combine(e,c,t,i,s,o,a,l,h)}_combine(e,t,n,i,s,o,a,l,h){h||this._combineTex.width===e.width&&this._combineTex.height===e.height||this._combineFBO.resize(e.width,e.height);let c=this._combineUniforms;const{blurTex0:u,blurTex1:f,blurTex2:g,blurTex3:m,blurTex4:A}=t;c||(c=this._combineUniforms={bloomFactor:0,bloomRadius:0,rgbmRange:7,TextureBloomBlur1:u,TextureBloomBlur2:f,TextureBloomBlur3:g,TextureBloomBlur4:m,TextureBloomBlur5:A,TextureInput:null,TextureSource:null,outputSize:[0,0]}),c.noAaTextureSource=o,c.pointTextureSource=a,c.enableAA=l,c.bloomFactor=i,c.bloomRadius=s,c.TextureInput=n,c.TextureSource=e,U_(c.outputSize,e.width,e.height);const w={};return o?w.HAS_NOAA_TEX=1:delete w.HAS_NOAA_TEX,a?w.HAS_POINT_TEX=1:delete w.HAS_POINT_TEX,this._combineShader.setDefines(w),this._renderer.render(this._combineShader,c,null,h?null:this._combineFBO),h?null:this._combineTex}dispose(){this._combineFBO&&(this._combineFBO.destroy(),delete this._combineFBO),this._blurPass&&(this._blurPass.dispose(),delete this._blurPass),delete this._uniforms}_createTextures(e){if(this._combineTex)return;this._combineTex=this._createColorTex(e,e.width,e.height,"uint8"),this._combineFBO=this._createBlurFBO(this._combineTex)}_createColorTex(e,t,n,i){return this._renderer.device.texture({min:"linear",mag:"linear",type:i,width:t||e.width,height:n||e.height})}_createBlurFBO(e){return this._renderer.device.framebuffer({width:e.width,height:e.height,colors:[e],depth:!1,stencil:!1})}_initShaders(){if(!this._combineShader){const e={x:0,y:0,width:(e,t)=>t.outputSize[0],height:(e,t)=>t.outputSize[1]};this._blurPass=new BlurPass(this._regl,!1),this._combineShader=new QuadShader({vert:RT,frag:"precision highp float;\nuniform float bloomFactor;\nuniform float bloomRadius;\nuniform float rgbmRange;\nuniform sampler2D TextureBloomBlur1;\nuniform sampler2D TextureBloomBlur2;\nuniform sampler2D TextureBloomBlur3;\nuniform sampler2D TextureBloomBlur4;\nuniform sampler2D TextureBloomBlur5;\nuniform sampler2D TextureInput;\nuniform sampler2D TextureSource;\n#ifdef HAS_NOAA_TEX\nuniform sampler2D noAaTextureSource;\n#endif\n#ifdef HAS_POINT_TEX\nuniform sampler2D pointTextureSource;\n#endif\nuniform float enableAA;\nuniform vec2 outputSize;\n#define SHADER_NAME bloomCombine\nvec2 c;\n#include <srgb_frag>\nvec3 d(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nfloat h(const float i, const float j) {\n  return mix(i, j * 2. - i, bloomRadius);\n}\nvec4 k() {\n  vec3 l = vec3(.0);\n  const float m = .6;\n  const float n = 1.1;\n  const float o = .9;\n  const float u = .6;\n  const float v = .3;\n  const float A = .1;\n  l += (vec4(d(texture2D(TextureBloomBlur1, c), rgbmRange), 1.)).rgb * h(n, m);\n  l += (vec4(d(texture2D(TextureBloomBlur2, c), rgbmRange), 1.)).rgb * h(o, m);\n  l += (vec4(d(texture2D(TextureBloomBlur3, c), rgbmRange), 1.)).rgb * h(u, m);\n  l += (vec4(d(texture2D(TextureBloomBlur4, c), rgbmRange), 1.)).rgb * h(v, m);\n  l += (vec4(d(texture2D(TextureBloomBlur5, c), rgbmRange), 1.)).rgb * h(A, m);\n  vec4 B;\n  if(enableAA == 1.) {\n    \n  } else {\n    B = texture2D(TextureInput, c);\n  }\n  B.rgb = mix(vec3(.0), B.rgb, sign(B.a));\n  vec4 C = texture2D(TextureSource, c);\n#ifdef HAS_NOAA_TEX\nvec4 D = texture2D(noAaTextureSource, c);\n  C = D + C * (1. - D.a);\n#endif\nvec4 E = vec4(.0);\n#ifdef HAS_POINT_TEX\nE = texture2D(pointTextureSource, c);\n#endif\nfloat F = sqrt((l.r + l.g + l.b) / 3.);\n  vec4 G = vec4(linearTosRGB(l * bloomFactor), F);\n  return E + (B + C * (1. - B.a)) * (1. - E.a) + G;\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  gl_FragColor = e;\n}",extraCommandProps:{viewport:e}})}}}class CopyDepthShader extends QuadShader{constructor(){const e=[];super({vert:RT,frag:"precision highp float;\n#include <gl2_frag>\n#define SHADER_NAME COPY_DEPTH\nuniform sampler2D TextureDepth;\nuniform vec2 textureSize;\n#include <common_pack_float>\nvoid main(void) {\n  vec2 c = gl_FragCoord.xy / textureSize.xy;\n  float d = texture2D(TextureDepth, c).r;\n  glFragColor = common_encodeDepth(d);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"textureSize",type:"function",fn:(t,n)=>(e[0]=n.TextureDepth.width,e[1]=n.TextureDepth.height,e)}],extraCommandProps:{viewport:{x:0,y:0,width:(e,t)=>t.TextureDepth.width,height:(e,t)=>t.TextureDepth.height}}}),this.version=300}getMeshCommand(e,t){return this.commands.copy_depth||(this.commands.copy_depth=this.createMeshCommand(e,t)),this.commands.copy_depth}}class SsrPass{static getUniformDeclares(){const e=[[0,0,0,0],[0,0,0,0]],t=new Array(16);return[{name:"invProjMatrix",type:"function",fn:(e,n)=>_A(t,n.projMatrix)},{name:"outputFovInfo",type:"array",length:2,fn:function(t,n){const i=Math.tan(.5*n.fov),s=n.outSize[0]/n.outSize[1]*i;return Sy(e[0],s,i,s,-i),Sy(e[1],-s,i,-s,-i),e}},{name:"reprojViewProjMatrix",type:"function",fn:(e,t)=>vA([],t.prevProjViewMatrix,t.cameraWorldMatrix)}]}static getDefines(){return{HAS_SSR:1}}constructor(e){this._regl=e,this._renderer=new Renderer(e),this._inputRGBM=0}setup(e){this._initShaders(),this._createTextures(e)}getSSRUniforms(e,t,n){if(!this._depthCopy)return null;const i=this._depthCopy;return{TextureDepth:i,TextureReflected:this.getMipmapTexture(),ssrFactor:t||1,ssrQuality:n||2,outSize:[i.width,i.height],fov:e.getFov()*Math.PI/180,prevProjViewMatrix:this._projViewMatrix||e.projViewMatrix,cameraWorldMatrix:e.cameraWorldMatrix}}genMipMap(e,t,n){return this.setup(e),this._mipmap(e),this.copyDepthTex(t),this._projViewMatrix||(this._projViewMatrix=[]),mA(this._projViewMatrix,n),delete this._depthCopied,this._outputTex}getPrevProjViewMatrix(){return this._projViewMatrix}copyDepthTex(e){if(this._depthCopied)return null;if(this.setup(e),this._depthCopy)e.width===this._depthCopy.width&&e.height===this._depthCopy.height||this._depthCopyFBO.resize(e.width,e.height);else{this._depthCopy=this._regl.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"uint8",width:e.width,height:e.height});this._depthCopyFBO=this._regl.framebuffer({width:e.width,height:e.height,colors:[this._depthCopy],colorFormat:"rgba"})}return this._renderer.render(this._copyDepthShader,{TextureDepth:e},null,this._depthCopyFBO),this._depthCopied=!0,this._depthCopy}_mipmap(e){const t=this._targetFBO,n=Math.ceil(.5*e.width),i=Math.ceil(.5*e.height);t.width===n&&t.height===i||t.resize(n,i);let s=this._blurUniforms;s||(s=this._blurUniforms={rgbmRange:7,outputSize:[0,0]}),s.TextureInput=e,s.inputRGBM=+this._inputRGBM,U_(s.outputSize,t.width,t.height),this._renderer.render(this._ssrQuadShader,s,null,t)}getMipmapTexture(){return this._outputTex||(this._outputTex=this._renderer.regl.texture({type:"uint8",width:2,height:2})),this._outputTex}dispose(){this._copyDepthShader&&(this._ssrQuadShader.dispose(),this._copyDepthShader.dispose(),this._targetFBO.destroy(),delete this._copyDepthShader),this._depthCopy&&(this._depthCopyFBO.destroy(),delete this._depthCopy,delete this._depthCopyFBO)}_initShaders(){if(!this._copyDepthShader){this._copyDepthShader=new CopyDepthShader;this._ssrQuadShader=new QuadShader({vert:RT,frag:"#version 100\nprecision mediump float;\nuniform sampler2D TextureInput;\nuniform vec2 outputSize;\n#define SHADER_NAME QUAD\nvec2 c;\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 d = texture2D(TextureInput, c.xy);\n  gl_FragColor = d;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(e,t)=>t.outputSize[0],height:(e,t)=>t.outputSize[1]}}})}}_createTextures(e){if(!this._targetFBO){const t=this._regl;this._outputTex&&this._outputTex.destroy(),this._outputTex=t.texture({min:"linear",mag:"linear",type:"uint8",width:e.width,height:e.height}),this._targetFBO=t.framebuffer({width:e.width,height:e.height,colors:[this._outputTex],depth:!1,stencil:!1})}}}class HeatmapShader extends MeshShader{constructor(e){const t=[];super({vert:"#define SHADER_NAME HEATMAP\nuniform mat4 projViewModelMatrix;\nuniform float extrudeScale;\nuniform float heatmapIntensity;\nattribute vec3 aPosition;\nvarying vec2 vExtrude;\n#ifdef HAS_HEAT_WEIGHT\nattribute highp float aWeight;\nvarying highp float weight;\n#else\nuniform highp float heatmapWeight;\n#endif\nuniform mediump float heatmapRadius;\nconst highp float c = 1. / 255. / 16.;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n  \n#ifdef HAS_HEAT_WEIGHT\nhighp float d = aWeight / 255.;\n  weight = d;\n#else\nhighp float d = heatmapWeight;\n#endif\nmediump float e = heatmapRadius;\n  vec2 f = vec2(mod(aPosition.xy, 2.) * 2. - 1.);\n  float h = sqrt(-2. * log(c / d / heatmapIntensity / GAUSS_COEF)) / 3.;\n  vExtrude = h * f;\n  vec2 i = vExtrude * e * extrudeScale;\n  vec4 j = vec4(floor(aPosition.xy * .5) + i, aPosition.z, 1);\n  gl_Position = projViewModelMatrix * j;\n}",frag:"#define SHADER_NAME HEATMAP\nprecision mediump float;\nuniform highp float heatmapIntensity;\nvarying vec2 vExtrude;\n#ifdef HAS_HEAT_WEIGHT\nvarying highp float weight;\n#else\nuniform highp float heatmapWeight;\n#endif\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n  \n#ifdef HAS_HEAT_WEIGHT\nhighp float c = weight;\n#else\nhighp float c = heatmapWeight;\n#endif\nfloat d = -.5 * 3. * 3. * dot(vExtrude, vExtrude);\n  float e = c * heatmapIntensity * GAUSS_COEF * exp(d);\n  gl_FragColor = vec4(e, 1., 1., 1.);\n}",uniforms:[{name:"extrudeScale",type:"function",fn:function(e,t){return t.resolution/t.dataResolution*t.tileRatio}},{name:"projViewModelMatrix",type:"function",fn:function(e,n){return vA(t,n.projViewMatrix,n.modelMatrix)}}],extraCommandProps:px({},e&&e.extraCommandProps||{},{blend:{enable:!0,func:{src:"one",dst:"one"},equation:"add"}})})}}var GT=[-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],UT="#define SHADER_NAME SKYBOX\n#if __VERSION__ == 100\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod : enable\n#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)\n#else\n#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)\n#endif\n#else\n#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)\n#endif\nprecision highp float;\n#define saturate(x)        clamp(x, 0.0, 1.0)\n#include <gl2_frag>\n#include <hsv_frag>\nuniform vec3 hsv;\nvarying vec3 vWorldPos;\n#ifdef USE_AMBIENT\nuniform vec3 diffuseSPH[9];\n#else\nuniform samplerCube cubeMap;\nuniform float bias;\nuniform float size;\n#endif\nuniform float environmentExposure;\nuniform float backgroundIntensity;\nvec4 c(const in samplerCube d, const in vec3 e, const in float f, const in float h) {\n  vec3 i = e;\n  return textureCubeLod(d, i, h);\n}\nvec3 j(const in vec3 k, const in vec3 l[9]) {\n  float x = k.x;\n  float y = k.y;\n  float z = k.z;\n  vec3 m = (l[0] + l[1] * x + l[2] * y + l[3] * z + l[4] * z * x + l[5] * y * z + l[6] * y * x + l[7] * (3. * z * z - 1.) + l[8] * (x * x - y * y));\n  return max(m, vec3(.0));\n}\nfloat n(const in vec2 o) {\n  vec3 u = fract(vec3(o.xyx) * .1031);\n  u += dot(u, u.yzx + 19.19);\n  return fract((u.x + u.y) * u.z);\n}\n#if defined(TONE_MAPPING)\nconst float v = 1.;\nvec3 A(vec3 B) {\n  vec3 a = B * (B + .0245786) - .000090537;\n  vec3 b = B * (.983729 * B + .4329510) + .238081;\n  return a / b;\n}\nvec3 C(vec3 D) {\n  const mat3 E = mat3(vec3(.59719, .07600, .02840), vec3(.35458, .90834, .13383), vec3(.04823, .01566, .83777));\n  const mat3 F = mat3(vec3(1.60475, -.10208, -.00327), vec3(-.53108, 1.10813, -.07276), vec3(-.07367, -.00605, 1.07602));\n  D *= v / .6;\n  D = E * D;\n  D = A(D);\n  D = F * D;\n  return saturate(D);\n}\nvec3 G(vec3 D) {\n  return C(D);\n}\nvec4 H(in vec4 I) {\n  return vec4(mix(pow(I.rgb, vec3(.41666)) * 1.055 - vec3(.055), I.rgb * 12.92, vec3(lessThanEqual(I.rgb, vec3(.0031308)))), I.a);\n}\nvec4 J(vec4 I) {\n  return (H(I));\n}\n#endif\nvoid main() {\n  vec4 K;\n#ifdef USE_AMBIENT\nvec3 k = normalize(vWorldPos + mix(-.5 / 255., .5 / 255., n(gl_FragCoord.xy)) * 2.);\n  K = vec4(j(k, diffuseSPH), 1.);\n#else\nK = c(cubeMap, vWorldPos, size, bias);\n#endif\nK.rgb *= environmentExposure;\n  K.rgb *= backgroundIntensity;\n  glFragColor = K;\n  if(length(hsv) > .0) {\n    glFragColor.rgb = hsv_apply(clamp(glFragColor.rgb, .0, 1.), hsv);\n  }\n#if defined(TONE_MAPPING)\nglFragColor.rgb = G(glFragColor.rgb);\n  glFragColor = J(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}";class SkyboxShader extends MeshShader{constructor(){super({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 viewMatrix;\nuniform mat3 transformMatrix;\nvarying vec3 vWorldPos;\nvoid main() {\n  vWorldPos = aPosition;\n  mat4 c = mat4(mat3(viewMatrix) * transformMatrix);\n  vec4 d = projMatrix * c * vec4(vWorldPos, 1.);\n  gl_Position = d.xyww;\n}",frag:UT,extraCommandProps:{depth:{enable:!0,range:[1,1],func:"lequal"},viewport:{x:0,y:0,width:(e,t)=>t.resolution[0],height:(e,t)=>t.resolution[1]}}}),this.version=300}setMode(e,t){const n={};return e&&(n.TONE_MAPPING=1),0===t&&(n.USE_AMBIENT=1),this._skyboxMesh?this._skyboxMesh[0].setDefines(n):this._meshDefines=n,this}draw(e){return this._skyboxMesh||this._createSkyboxMesh(e),super.draw(e,this._skyboxMesh)}_createSkyboxMesh(e){const t=new Geometry({aPosition:new Int8Array(GT)},null,GT.length/3);t.generateBuffers(e),this._skyboxMesh=[new Mesh(t)],this._meshDefines&&(this._skyboxMesh[0].setDefines(this._meshDefines),delete this._meshDefines)}dispose(){if(this._skyboxMesh){const e=this._skyboxMesh[0];e.geometry.dispose(),e.dispose()}return delete this._skyboxMesh,super.dispose()}}class HeatmapDisplayShader extends MeshShader{constructor(e,t){const n={blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},viewport:e};t&&t.extraCommandProps&&px(n,t.extraCommandProps);const i=[];super({vert:"#define SHADER_NAME HEATMAP_DISPLAY\nuniform mat4 projViewModelMatrix;\nattribute vec3 aPosition;\nvoid main() {\n  gl_Position = projViewModelMatrix * vec4(aPosition, 1.);\n}",frag:"#define SHADER_NAME HEATMAP_DISPLAY\nprecision mediump float;\nuniform sampler2D inputTexture;\nuniform sampler2D colorRamp;\nuniform vec2 textureOutputSize;\nuniform float heatmapOpacity;\nvoid main() {\n  vec2 c = gl_FragCoord.xy / textureOutputSize.xy;\n  float t = texture2D(inputTexture, c).r;\n  vec4 d = texture2D(colorRamp, vec2(t, .5));\n  gl_FragColor = d * heatmapOpacity;\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,t){return vA(i,t.projViewMatrix,t.modelMatrix)}}],extraCommandProps:n})}}class CopyShader extends QuadShader{constructor(){super({vert:RT,frag:"precision highp float;\nuniform sampler2D texture;\nuniform vec2 size;\nuniform float enableSharpen;\nuniform float sharpFactor;\nuniform float pixelRatio;\nvec2 c;\nvec3 d(const in vec3 e, const float f) {\n  vec2 h = pixelRatio / size.xy;\n  float i = .0;\n  vec4 j = texture2D(texture, c + h * vec2(-1., -1.));\n  j.rgb = mix(vec3(.0), j.rgb, sign(j.a));\n  i += mix(.0, 1., sign(j.a));\n  vec4 k = texture2D(texture, c + h * vec2(1.));\n  k.rgb = mix(vec3(.0), k.rgb, sign(k.a));\n  i += mix(.0, 1., sign(k.a));\n  vec4 l = texture2D(texture, c + h * vec2(1., -1.));\n  l.rgb = mix(vec3(.0), l.rgb, sign(l.a));\n  i += mix(.0, 1., sign(l.a));\n  vec4 m = texture2D(texture, c + h * vec2(-1., 1.));\n  m.rgb = mix(vec3(.0), m.rgb, sign(m.a));\n  i += mix(.0, 1., sign(m.a));\n  return e + f * (i * e - j.rgb - l.rgb - m.rgb - k.rgb);\n}\nvoid main() {\n  c = gl_FragCoord.xy / size;\n  vec4 e = texture2D(texture, c);\n  if(enableSharpen == 1.) {\n    e.rgb = d(e.rgb, sharpFactor);\n  }\n  gl_FragColor = e;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(e,t)=>t.size[0],height:(e,t)=>t.size[1]}}})}getMeshCommand(e,t){return this.commands.copy||(this.commands.copy=this.createMeshCommand(e,t)),this.commands.copy}}const VT=[],jT=[];class EffectShader extends QuadShader{constructor(){super({vert:RT,frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\nuniform sampler2D sceneMap;\nuniform sampler2D scanEffectMap;\nvoid main() {\n  vec4 c = texture2D(sceneMap, vTexCoord);\n  vec4 d = texture2D(scanEffectMap, vTexCoord);\n  glFragColor = c + d;\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",extraCommandProps:{viewport:{x:0,y:0,width:(e,t)=>t.resolution[0],height:(e,t)=>t.resolution[1]}}})}}const WT=[];class FogPass{constructor(e,t,n){this._regl=e,this._layer=n,this._viewport=t,this._init()}_init(){this._shader=new MeshShader({vert:"attribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nvarying vec4 vWorldPosition;\n#include <get_output>\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  vec4 e = modelMatrix * d * c;\n  gl_Position = projMatrix * modelViewMatrix * d * c;\n  vWorldPosition = e;\n}",frag:"precision mediump float;\nvarying vec4 vWorldPosition;\nuniform vec2 fogDist;\nuniform vec3 cameraPosition;\nuniform float rainDepth;\nvoid main() {\n  vec3 c = vec3(vWorldPosition[0] - cameraPosition[0], vWorldPosition[1] - cameraPosition[1], vWorldPosition[2] - cameraPosition[2]);\n  float d = length(c);\n  float e = clamp(1. - (d - fogDist.x) / (fogDist.y - fogDist.x), .0, 1.);\n  if(vWorldPosition[2] < rainDepth) {\n    gl_FragColor = vec4(e, .0, .0, 1.);\n  } else {\n    gl_FragColor = vec4(e, 1., .0, 1.);\n  }\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(e,t){return vA(WT,t.viewMatrix,t.modelMatrix)}}],extraCommandProps:{viewport:this._viewport}});const e=this._layer.getRenderer().createFBOInfo();this._fbo=this._regl.framebuffer(e),this._scene=new Scene,this.renderer=new Renderer(this._regl)}render(e,t){this._resize(),this.renderer.clear({color:[0,0,0,1],depth:1,framebuffer:this._fbo}),this._scene.setMeshes(e);return this.renderer.render(this._shader,{projMatrix:t.projMatrix,viewMatrix:t.viewMatrix,cameraPosition:t.cameraPosition,fogDist:t.fogDist,rainDepth:t.rainDepth},this._scene,this._fbo),this._fbo}dispose(){this._fbo&&this._fbo.destroy(),this._shader&&this._shader.dispose()}_resize(){const e=dx(this._viewport.width.data)?this._viewport.width.data():this._viewport.width,t=dx(this._viewport.height.data)?this._viewport.height.data():this._viewport.height;!this._fbo||this._fbo.width===e&&this._fbo.height===t||this._fbo.resize(e,t)}}class FogShader extends QuadShader{constructor(){super({vert:RT,frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\n#ifdef HAS_RAIN\nuniform sampler2D ripplesMap;\n#endif\n#ifdef HAS_SNOW\nuniform sampler2D normalMap;\n#endif\n#ifdef HAS_FOG\nuniform vec3 fogColor;\n#endif\nuniform sampler2D sceneMap;\nuniform sampler2D mixFactorMap;\nuniform float time;\nuniform vec2 resolution;\nuniform float snowIntensity;\nfloat c(float a, float b, float w) {\n  return a + w * (b - a);\n}\n#define HASHSCALE1 .1031\n#define HASHSCALE3 vec3(.1031, .1030, .0973)\n#define HASHSCALE4 vec3(.1031, .1030, .0973, .1099)\nfloat d = .5;\nfloat e = .2;\nfloat f = .5;\nfloat h = 20.;\nfloat i(float p) {\n  vec3 j = fract(vec3(p) * HASHSCALE1);\n  j += dot(j, j.yzx + 19.19);\n  return fract((j.x + j.y) * j.z);\n}\nvec2 k(vec2 p) {\n  vec3 j = fract(vec3(p.xyx) * HASHSCALE3);\n  j += dot(j, j.yzx + 19.19);\n  return fract((j.xx + j.yz) * j.zy);\n}\nvec2 l(vec2 m) {\n  float x = fract(sin(dot(m.xy, vec2(122.9898, 783.233))) * 43758.5453);\n  float y = fract(sin(dot(m.xy, vec2(457.6537, 537.2793))) * 37573.5913);\n  return vec2(x, y);\n}\nvec3 n(vec2 o, float u) {\n  vec3 v = vec3(.0);\n  o = o * (2. + u);\n  float A = e * snowIntensity;\n  float B = o.y * (((i(u) * 2. - 1.) * .5 + 1.) * A);\n  float C = (f * time);\n  o += vec2(B, C);\n  vec2 D = k(floor(o) + 31.1759 * u);\n  o = fract(o);\n  o -= (D * 2. - 1.) * .35;\n  o -= .5;\n  float r = length(o);\n  float E = .05 * (1. + .3 * sin(time * d));\n  float F = smoothstep(E, -E, r);\n  vec3 G = vec3(F) * D.x;\n  return G;\n}\nvec3 H() {\n  vec3 v = vec3(0);\n  vec2 o = gl_FragCoord.xy / resolution.xy;\n  o *= vec2(resolution.x / resolution.y, 1.);\n  float I = h * snowIntensity;\n  for(float J = 0.; J < I; J++) {\n    v += n(o, J);\n  }\n  return v;\n}\nvec3 K(vec4 L, vec4 M, float N) {\n  float O = M.b;\n  vec3 P = vec3(1.);\n  if(N < 1.) {\n    float r = c(.5, P.x, O);\n    float g = c(.5, P.y, O);\n    float b = c(.5, P.z, O);\n    return vec3(r, g, b);\n  } else {\n    float r = c(L.r, P.x, O);\n    float g = c(L.g, P.y, O);\n    float b = c(L.b, P.z, O);\n    return vec3(r, g, b);\n  }\n}\nvoid main() {\n  vec4 L = texture2D(sceneMap, vTexCoord);\n  glFragColor = L;\n  vec4 Q = texture2D(mixFactorMap, vTexCoord);\n#ifdef HAS_RAIN\nvec4 R = texture2D(ripplesMap, vTexCoord);\n  if(Q.g < 1.) {\n    L = mix(L, R, .4);\n  }\n  glFragColor = L;\n#endif\n#ifdef HAS_SNOW\nvec3 S = H();\n  glFragColor = vec4(L.rgb + S, L.a);\n#endif\n#ifdef HAS_FOG\nfloat T = Q.r;\n  vec3 U = mix(fogColor, glFragColor.rgb, T);\n  glFragColor = vec4(U, L.a);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",extraCommandProps:{viewport:{x:0,y:0,width:(e,t)=>t.resolution[0],height:(e,t)=>t.resolution[1]}}})}}const qT=[],ZT=[.03,.03,.03],XT=[],YT=[],JT=[],QT=CA([],a_([],90,0,0),[0,0,0]);class RainRipplePass{constructor(e,t){this._regl=e,this._viewport=t,this._init()}_init(){this._shader=new MeshShader({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nattribute vec3 aNormal;\nattribute vec2 aTexCoord;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nvarying vec2 vTexCoord;\n#include <get_output>\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  gl_Position = projMatrix * modelViewMatrix * d * c;\n  vTexCoord = aTexCoord;\n}",frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\nuniform float rippleRadius;\nuniform float density;\nuniform float time;\nvec3 c(vec2 p) {\n  vec3 q = vec3(dot(p, vec2(127.1, 311.7)), dot(p, vec2(269.5, 183.3)), dot(p, vec2(419.2, 371.9)));\n  return fract(sin(q) * 43758.5453);\n}\nfloat d(in vec2 x) {\n  vec2 e = x * density / 4000.0;\n  vec2 p = floor(e);\n  vec2 f = fract(e);\n  float h = .0;\n  for(int i = -4; i <= 4; i++)\n    for(int k = -4; k <= 4; k++) {\n      vec2 g = vec2(float(k), float(i));\n      vec3 l = c(p + g);\n      vec2 r = g - f + l.xy;\n      float m = sqrt(dot(r, r));\n      float n = max(mix(smoothstep(.99, .999, max(cos(m - time * 2. + (l.x + l.y) * 5.), 0.)), 0., m), 0.);\n      h += n;\n    }\n  return h;\n}\nvoid main() {\n  vec2 u = vTexCoord;\n  float A = 24. / (rippleRadius * .01);\n  float f = d(A * u) * smoothstep(.0, .4, sin(u.x * 3.151592) * sin(u.y * 3.141592));\n  vec3 B = vec3(-dFdx(f), -dFdy(f), -dFdy(f));\n  glFragColor = vec4(B, 1.);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(e,t){return vA(qT,t.viewMatrix,t.modelMatrix)}}],extraCommandProps:{viewport:this._viewport}}),this._shader.version=300,this._fbo=this._regl.framebuffer({color:this._regl.texture({width:this._viewport.width(),height:this._viewport.height(),wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this._scene=new Scene,this.renderer=new Renderer(this._regl)}_transformRipples(e){const t=e.coordinateToPointAtRes(e.getCenter(),e.getGLRes()),n=e.getGLScale()/e.getGLScale(this._fixZoom),i=ZA(YT,n,n,n),s=JA(i,ZT,i),o=AA(JT);EA(o,a_(XT,0,0,0),[t.x,t.y,0],s),vA(o,o,QT),this._mesh.setLocalTransform(o)}_createRipplesMask(e){this._fixZoom=e.getZoom();const t=800*Math.pow(2,16.685648411389433-this._fixZoom),n={};n.POSITION=[-t,0,-t,t,0,-t,-t,0,t,t,0,t],n.NORMAL=[0,1,0,0,1,0,0,1,0,0,1,0],n.TEXCOORD_0=[0,0,1,0,0,1,1,1];const i=new Geometry(n,[3,1,0,0,2,3],0,{positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});i.generateBuffers(this._regl);const s=new Material;return new Mesh(i,s)}render(e,t){this._resize(),this.renderer.clear({color:[0,0,0,1],depth:1,framebuffer:this._fbo}),this._mesh=this._mesh||this._createRipplesMask(e),this._scene.setMeshes(this._mesh),this._transformRipples(e);return this.renderer.render(this._shader,{projMatrix:t.projMatrix,viewMatrix:t.viewMatrix,time:t.time,rippleRadius:t.rippleRadius,density:t.density},this._scene,this._fbo),this._fbo}dispose(){this._fbo&&this._fbo.destroy(),this._shader&&this._shader.dispose()}_resize(){const e=dx(this._viewport.width.data)?this._viewport.width.data():this._viewport.width,t=dx(this._viewport.height.data)?this._viewport.height.data():this._viewport.height;!this._fbo||this._fbo.width===e&&this._fbo.height===t||this._fbo.resize(e,t)}}var $T="attribute vec3 aPosition;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\n#ifdef HAS_TEXTURE\nattribute vec2 aTexCoord;\nvarying vec2 uv;\nvarying vec4 vPos;\n#endif\n#include <get_output>\nvoid main() {\n  mat4 c = getPositionMatrix();\n  vec4 d = c * getPosition(aPosition);\n  gl_Position = projViewModelMatrix * d;\n#ifdef HAS_TEXTURE\nuv = aTexCoord;\n  vPos = getPosition(aPosition);\n#endif\n}";const KT=[0,0,0,1];class ExtentPass{constructor(e,t){this.regl=e,this._viewport=t,this.renderer=new Renderer(e),this._init()}_init(){this._maskColorFbo=this.renderer.device.framebuffer({color:this.renderer.device.texture({width:1,height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this._maskModeFbo=this.renderer.device.framebuffer({color:this.renderer.device.texture({width:1,height:1,wrap:"clamp",mag:"nearest",min:"nearest"}),depth:!0});const e=[{name:"projViewModelMatrix",type:"function",fn:(e,t)=>vA([],t.projViewMatrix,t.modelMatrix)}];this._maskColorShader=new MeshShader({vert:$T,frag:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec4 maskColor;\n#ifdef HAS_TEXTURE\nuniform sampler2D maskTexture;\nvarying vec2 uv;\nuniform vec3 mask_position0;\nuniform vec3 mask_position1;\nuniform vec3 mask_position2;\nuniform vec3 mask_position3;\nvarying vec4 vPos;\nvec2 c(vec2 d, vec2 a, vec2 b, vec2 e, vec2 f) {\n  vec2 h = vec2(.5);\n  for(int i = 0; i < 10; i++) {\n    float j = h.x;\n    float k = h.y;\n    vec2 l = (1. - j) * (1. - k) * a + j * (1. - k) * b + j * k * e + (1. - j) * k * f;\n    vec2 m = d - l;\n    if(length(m) < .001)\n      break;\n    vec2 n = -(1. - k) * a + (1. - k) * b + k * e - k * f;\n    vec2 o = -(1. - j) * a - j * b + j * e + (1. - j) * f;\n    float A = n.x * o.y - n.y * o.x;\n    if(abs(A) > .0001) {\n      vec2 B = vec2((m.x * o.y - m.y * o.x) / A, (m.y * n.x - m.x * n.y) / A);\n      h += B;\n    }\n    h = clamp(h, .0, 1.);\n  }\n  return h;\n}\n#endif\nvoid main() {\n  \n#ifdef HAS_TEXTURE\nvec2 d = vPos.xy;\n  vec2 C = c(d, mask_position0.xy, mask_position1.xy, mask_position2.xy, mask_position3.xy);\n  gl_FragColor = texture2D(maskTexture, C);\n  gl_FragColor.a *= maskColor.a;\n#else\nif(maskColor.a == .0) {\n    discard;\n  }\n  gl_FragColor = maskColor;\n#endif\n}",uniforms:e,extraCommandProps:{viewport:this._viewport,depth:{enable:!0,func:"lequal"}}}),this._maskModeShader=new MeshShader({vert:$T,frag:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform float maskMode;\n#ifdef HAS_MASK_FLAT\nuniform float flatHeight;\n#endif\n#ifdef HAS_MASK_COLOR\nuniform vec2 heightRange;\n#endif\nvoid main() {\n  \n#if defined(HAS_MASK_FLAT)\ngl_FragColor = vec4(maskMode, flatHeight, .0, 1.);\n#elif defined(HAS_MASK_COLOR)\ngl_FragColor = vec4(maskMode, .0, heightRange.x, heightRange.y);\n#else\ngl_FragColor = vec4(maskMode, .0, .0, .0);\n#endif\n}",uniforms:e,extraCommandProps:{viewport:this._viewport}}),this._scene=new Scene}render(e,t){this._resize(),this.renderer.clear({color:KT,depth:1,framebuffer:this._maskColorFbo}),this.renderer.clear({color:KT,depth:1,framebuffer:this._maskModeFbo}),this._scene.setMeshes(e);const n={projViewMatrix:t};return this.renderer.render(this._maskColorShader,n,this._scene,this._maskColorFbo),this.renderer.render(this._maskModeShader,n,this._scene,this._maskModeFbo),{colorExtent:this._maskColorFbo,modeExtent:this._maskModeFbo}}_resize(){const e=dx(this._viewport.width)?this._viewport.width():this._viewport.width.data(),t=dx(this._viewport.height)?this._viewport.height():this._viewport.height.data();!this._maskColorFbo||this._maskColorFbo.width===e&&this._maskColorFbo.height===t||(this._maskColorFbo.resize(e,t),this._maskModeFbo.resize(e,t))}dispose(){this._maskColorFbo&&(this._maskColorFbo.destroy(),delete this._maskColorFbo),this._maskModeFbo&&(this._maskModeFbo.destroy(),delete this._maskModeFbo),this._maskColorShader&&(this._maskColorShader.dispose(),delete this._maskColorShader),this._maskModeShader&&(this._maskModeShader.dispose(),delete this._maskModeShader)}}const eS="\n#ifdef GL_ES\n  precision highp float;\n#endif\nuniform mat3 ring;\n\nuniform float effectTime;\nvarying vec4 vWorldPosition;\n\nvec3 hsb2rgb(in vec3 c) {\n    vec3 rgb = clamp(abs(mod(c.x * 6.0 + vec3(0.0,4.0,2.0), 6.0)-3.0)-1.0, 0.0, 1.0 );\n    rgb = rgb*rgb*(3.0-2.0*rgb);\n    return c.z * mix( vec3(1.0), rgb, c.y);\n}\n\nvec4 glowring(vec4 worldPos, vec2 center, float radius, float speed, vec3 effectColor, float direction, float height) {\n  vec2 dir = vec2(worldPos.xy) - center;\n  float len = length(dir);\n  if (len > radius) {\n    return vec4(0.0);\n  } else {\n    vec2 uv = vec2(0.0);\n    if (direction == 0.0) {\n      vec2 lefttop = vec2(center.x - radius, center.y + radius);\n      vec2 rightbottom = vec2(center.x + radius, center.y - radius);\n      uv = vec2(abs(worldPos.x - lefttop.x) / (2.0 * radius), abs(worldPos.y - rightbottom.y) / (2.0 * radius));\n      uv.x -= 0.5;\n      uv.y -= 0.5;\n    } else {\n      if (worldPos.z < 0.1) {\n        return vec4(0.0);\n      }\n      uv = vec2(0.0, worldPos.z / height);\n    }\n    float itime = (effectTime / 2.0) * speed;\n    float r = length(uv) * 3.0;\n    vec3 color = hsb2rgb(effectColor);\n\n    float a = pow(r, 2.0);\n    float b = sin(r * 0.8 - 1.6);\n    float c = sin(r - 0.010);\n    float s = sin(a - itime * 3.0 + b) * c;\n    float t = abs(1.0 / (s * 10.8)) - 0.01;\n    color *= t;\n    vec4 newColor = vec4(color, t);\n    return newColor;\n  }\n}\n\nvoid main() {\n    vec4 color = vec4(0.0);\n    gl_FragColor = color;\n}\n",tS=[];class ScanEffectPass{constructor(e,t,n){this._regl=e,this._layer=n,this._viewport=t,this._init(),this._effectsLength=0}_init(){const e=this._layer.getRenderer().createFBOInfo();this._fbo=this._regl.framebuffer(e),this._scene=new Scene,this.renderer=new Renderer(this._regl)}render(e,t){this._resize(),this.renderer.clear({color:[0,0,0,1],depth:1,framebuffer:this._fbo}),this._scene.setMeshes(e);const n=t.effectInfos;if(!this._shader||n.length!==this._effectsLength){this._shader&&this._shader.dispose();const e=this._createFragSource(n);this._shader=new MeshShader({vert:"#include <gl2_vert>\n#define SHADER_NAME SCANEFFECT\nprecision highp float;\nattribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\n#include <line_extrusion_vert>\n#include <get_output>\nvarying vec4 vWorldPosition;\nvoid main()\n{\n    mat4 localPositionMatrix = getPositionMatrix();\n    #ifdef IS_LINE_EXTRUSION\n        vec3 linePosition = getLineExtrudePosition(aPosition);\n        //linePixelScale = tileRatio * resolution / tileResolution\n        vec4 localVertex = getPosition(linePosition);\n    #else\n        vec4 localVertex = getPosition(aPosition);\n    #endif\n    vec4 worldPosition = modelMatrix * localPositionMatrix * localVertex;\n    vWorldPosition = worldPosition;\n    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * localVertex;\n}\n",frag:e,uniforms:[{name:"modelViewMatrix",type:"function",fn:function(e,t){return vA(tS,t.viewMatrix,t.modelMatrix)}}],extraCommandProps:{viewport:this._viewport}}),this._effectsLength=n.length}const i={projMatrix:t.projMatrix,viewMatrix:t.viewMatrix,effectTime:t.effectTime,minAltitude:0};return this._updateUniforms(i,n),this.renderer.render(this._shader,i,this._scene,this._fbo),this._fbo}_createFragSource(e){let t="";for(let n=0;n<e.length;n++)t+=`uniform mat3 ring${n};\n`;t=eS.replace("uniform mat3 ring;",t);let n="";for(let t=0;t<e.length;t++)n+=`\n                vec2 center${t} = vec2(ring${t}[0][0], ring${t}[0][1]);\n                float radius${t} = ring${t}[0][2];\n                float speed${t} = ring${t}[1][0];\n                vec3 color${t} = vec3(ring${t}[1][1], ring${t}[1][2], ring${t}[2][0]);\n                float direction${t} = ring${t}[2][1];\n                float height${t} = ring${t}[2][2];\n                vec4 ringColor${t} = glowring(vWorldPosition, center${t}, radius${t}, speed${t}, color${t}, direction${t}, height${t});\n                color += ringColor${t};\n            `;return n+="gl_FragColor = color;",t=t.replace("gl_FragColor = color;",n),t}_updateUniforms(e,t){for(let n=0;n<t.length;n++)e[`ring${n}`]=t[n]}dispose(){this._fbo&&this._fbo.destroy(),this._shader&&this._shader.dispose()}_resize(){const e=dx(this._viewport.width.data)?this._viewport.width.data():this._viewport.width,t=dx(this._viewport.height.data)?this._viewport.height.data():this._viewport.height;!this._fbo||this._fbo.width===e&&this._fbo.height===t||this._fbo.resize(e,t)}}const nS=[],rS={width:4,type:"float"};class Skin{constructor(e,t,n){this._regl=e,this.joints=t,this.inverseBindMatrices=[],this.jointMatrices=[],this.jointData=new Float32Array(16*t.length);for(let e=0;e<t.length;++e)this.inverseBindMatrices.push(new Float32Array(n.buffer,n.byteOffset+16*Float32Array.BYTES_PER_ELEMENT*e,16)),this.jointMatrices.push(new Float32Array(this.jointData.buffer,16*Float32Array.BYTES_PER_ELEMENT*e,16));this.jointTextureSize=[4,6]}update(e,t,n){_A(nS,e);for(let e=0;e<this.joints.length;++e){const n=this.jointMatrices[e];vA(n,nS,t[this.joints[e].nodeIndex]),vA(n,n,this.inverseBindMatrices[e])}rS.height=this.joints.length,rS.data=this.jointData;const i=rS;return n?n(i):n=this._regl.texture(i),n}}const iS=[0,0,0],sS=[0,0,0,1],oS=[1,1,1],aS=[];class TRS{constructor(e=[0,0,0],t=[0,0,0,1],n=[1,1,1]){this.translation=e,this.rotation=t,this.scale=n}getMatrix(){return EA(aS,this.rotation,this.translation,this.scale)}decompose(e){PA(this.translation,e),OA(this.rotation,e),kA(this.scale,e)}update(e){e&&(e.translation&&!cy(e.translation,iS)&&qA(this.translation,e.translation),e.rotation&&!I_(e.rotation,sS)&&m_(this.rotation,e.rotation),e.scale&&!cy(e.scale,oS)&&qA(this.scale,e.scale))}}class GeometryResource{constructor(e){this._init(e)}_init(e){this.bbox=e.bbox,this.geometry=e.geometry,this.nodeMatrix=e.nodeMatrix,this.materialInfo=e.materialInfo,this.extraInfo=e.extraInfo,this.animationMatrix=e.animationMatrix,this.morphWeights=e.morphWeights,this.skin=e.skin,this.nodeIndex=e.nodeIndex}copyEdgeGeometry(){this.copyGeometry||(this.copyGeometry=this._copyEdgeGeometry(this.geometry))}createCopyBarycentric(){this.copyGeometry&&!this.copyGeometry.data.aBarycentric&&(this.copyGeometry.buildUniqueVertex(),this.copyGeometry.createBarycentric("aBarycentric"))}_copyEdgeGeometry(e){const t=e.data,n=e.indices||e.elements,i={};for(const n in t)if(n===e.desc.positionAttribute)if(yx(t[n]))i[n]=t[n].slice();else if(t[n].buffer&&t[n].buffer.destroy)i[n]={buffer:t[n].buffer},yx(t[n].array)&&(i[n].array=t[n].array.slice());else{const t=e._getAttributeData(n);i[n]=n!==e.desc.positionAttribute?t:t.slice()}const s=void 0!==n.length?n.slice():n,o=JSON.parse(JSON.stringify(e.desc)),a=new EdgeGeometry(i,s,0,o);return a.properties=e.properties,a}}let lS=0;const hS=[],cS=[];class GLTFPack{constructor(e,t){this.gltf=e,this.regl=t,this.geometries=[],t&&(this._emptyTexture=t.texture({width:2,height:2}))}getMeshesInfo(){if(!this.gltf)return null;if(this.geometries.length)return this.geometries;this._createTextures(this.gltf.textures),this._createSkins(this.gltf.skins);return this.gltf.scenes[0].nodes.forEach((e=>{this._parserNode(e,this.geometries)})),this._checkBaseColorFactor(),this.geometries}getGLTFBBox(){if(!this.gltf)return null;const e=this.geometries;if(!e||!e.length)return null;const t=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0];for(let i=0;i<e.length;i++){const s=e[i].bbox,o=s.min,a=s.max;o[0]<t[0]&&(t[0]=o[0]),o[1]<t[1]&&(t[1]=o[1]),o[2]<t[2]&&(t[2]=o[2]),a[0]>n[0]&&(n[0]=a[0]),a[1]>n[1]&&(n[1]=a[1]),a[2]>n[2]&&(n[2]=a[2])}return{min:t,max:n}}_createSkins(e){if(e){this._skinMap={};for(let t=0;t<e.length;t++){const n=e[t];n.joints=n.joints.map((e=>this.gltf.nodes[e])),this._skinMap[t]=new Skin(this.regl,n.joints,n.inverseBindMatrices.array),delete n.inverseBindMatrices}}}_createTextures(e){if(e){this._textureMap={};for(let t=0;t<e.length;t++){const n=e[t];this._textureMap[t]||(this._textureMap[t]=this._toTexture(n),delete n.image)}}}_checkBaseColorFactor(){if(!this._checkBaseColorFactorAlpha())for(let e=0;e<this.geometries.length;e++){const t=this.geometries[e].materialInfo.baseColorFactor;t&&0===t[3]&&(t[3]=1)}}_checkBaseColorFactorAlpha(){for(let e=0;e<this.geometries.length;e++){const t=this.geometries[e].materialInfo.baseColorFactor;if(t&&t[3]>0)return!0}return!1}dispose(){this._emptyTexture&&this._emptyTexture.destroy();const e=this.getMeshesInfo();if(e){e.forEach((e=>{e.geometry.dispose();for(const t in e.materialInfo){const n=e.materialInfo[t];n&&n.destroy&&!n[Nx]&&n.destroy()}}));for(const e in this._textureMap){const t=this._textureMap[e];t&&t.destroy&&!t[Nx]&&t.destroy()}delete this.gltf}}updateAnimation(e,t,n,i,s,o,a,l){const h=this.gltf;if(!h)return;const c=hx();if(lS=h.animations?c.GLTFLoader.getAnimationTimeSpan(h,i):null,!lS)return;e-=s;let u=0;u=t||!t&&this._isFirstLoop(e,n,i,s)?e*n*.001%(lS.max-lS.min)+lS.min:e*n*.001+lS.min,h.scenes[0].nodes.forEach((e=>{this._updateNodeMatrix(i,u,e,null,o,l)}));for(const e in this.gltf.nodes){const t=this.gltf.nodes[e],n=o[t.nodeIndex];if(t.skin&&n){const e=t.skin.update(n,o,a[t.nodeIndex]&&a[t.nodeIndex].jointTexture);a[t.nodeIndex]||(a[t.nodeIndex]={jointTextureSize:t.skin.jointTextureSize,numJoints:t.skin.joints.length}),a[t.nodeIndex].jointTexture=e}}}_isFirstLoop(e,t,n,i){const s=this.gltf;if(!i||!s)return!0;const o=hx();return lS=s.animations?o.GLTFLoader.getAnimationTimeSpan(s,n):null,e*t*.001/(lS.max-lS.min)<1}hasSkinAnimation(){return!!this._isAnimation}_updateNodeMatrix(e,t,n,i,s,o){n.trs&&(o?o.indexOf(Number(n.nodeIndex))>-1&&this._updateNodeTRS(n,t,e):this._updateNodeTRS(n,t,e)),s[n.nodeIndex]=i?vA(s[n.nodeIndex]||[],i,n.matrix||n.trs.getMatrix()):mA(s[n.nodeIndex]||[],n.matrix||n.trs.getMatrix()),n.children&&n.children.forEach((i=>{this._updateNodeMatrix(e,t,i,s[n.nodeIndex],s,o)}))}_updateNodeTRS(e,t,n){const i=hx().GLTFLoader.getAnimationClip(this.gltf,Number(e.nodeIndex),t,n);i.weights&&this._updateMorph(e,i.weights),e.trs.update(i)}_updateMorph(e,t){const n=t.length;if(!e.influencesList){e.influencesList=[];for(let t=0;t<n;t++)e.influencesList[t]=[t,0]}const i=e.influencesList;for(let e=0;e<i.length;e++){const n=i[e];n[0]=e,n[1]=t[e]}i.sort(fS);const s=[];for(let e=0;e<8;e++)s[e]=[e,0];for(let e=0;e<8;e++)e<n&&i[e][1]?(s[e][0]=i[e][0],s[e][1]=i[e][1]):(s[e][0]=Number.MAX_SAFE_INTEGER,s[e][1]=0);s.sort(uS);e.geometries.forEach((e=>{const t=e.properties.morphTargets;for(let n=0;n<8;n++){const i=s[n],o=i[0],a=i[1];o!==Number.MAX_SAFE_INTEGER&&a?(e.updateData("POSITION"+n,t["POSITION_"+o].array),e.properties.morphWeights[n]=a):e.properties.morphWeights[n]=0}}))}_parserNode(e,t,n){if(e.isParsed)return;e.nodeMatrix=e.nodeMatrix||AA([]),e.localMatrix=e.localMatrix||AA([]),e.matrix?(e.trs=new TRS,e.trs.decompose(e.matrix)):e.trs=new TRS(e.translation,e.rotation,e.scale),e.localMatrix=e.trs.getMatrix(),n?vA(e.nodeMatrix,n,e.matrix||e.localMatrix):mA(e.nodeMatrix,e.matrix||e.localMatrix);const i=e.nodeMatrix;if(e.children)for(let n=0;n<e.children.length;n++){this._parserNode(e.children[n],t,i)}if(fx(e.skin)){this._isAnimation=!0;const t=e.skin;e.trs=new TRS,e.skin=this._skinMap[t]}if(fx(e.mesh)){e.mesh=this.gltf.meshes[e.mesh],e.mesh.node=e,e.geometries=e.geometries||[],e.mesh.primitives.forEach((n=>{const s=this._createMaterialInfo(n.material),o=function(e,t,n){const i=e.attributes,s=i.COLOR_0;if(s&&s.array instanceof Float32Array){const e=new Uint8Array(s.array.length);for(let t=0;t<e.length;t++)e[t]=Math.round(255*s.array[t]);s.array=e}else if(s&&(s.array instanceof Uint16Array||s.array instanceof Int16Array||s.array instanceof Uint32Array||s.array instanceof Int32Array)){const e=new Uint8Array(s.array);s.array=e}n&&i.TEXCOORD_0&&!i.TEXCOORD_0&&(i.TEXCOORD_1=i.TEXCOORD_0);const o={};for(const e in i)o[e]=px({},i[e]),t&&(o[e].buffer=$b(t,i[e],{dimension:i[e].itemSize}));if(e.morphTargets){const e=Ix(o.POSITION)?o.POSITION.itemSize*o.POSITION.count:o.POSITION.array.length;for(let t=0;t<8;t++)o[`POSITION${t}`]||(o[`POSITION${t}`]=new Float32Array(e).fill(0));for(let e=0;e<4;e++){o[`NORMAL${e}`]||(o[`NORMAL${e}`]=new Float32Array(o.NORMAL.array?o.NORMAL.array.length:o.NORMAL.length).fill(0))}}let a=e.indices;a&&void 0===a.bufferView&&a.array&&(a=a.array);const l=new Geometry(o,a,0,{primitive:mx(e.mode)?Nb(e.mode):e.mode,positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0",uv1Attribute:"TEXCOORD_1",color0Attribute:"COLOR_0"});e.morphTargets&&(l.properties.morphWeights=[]);e.mode>3&&!l.data.NORMAL&&l.createNormal("NORMAL");return l}(n,this.regl,s.occlusionTexture);o.properties.morphTargets=n.morphTargets,e.geometries.push(o);let a=o.boundingBox.copy();a=a.transform(AA(hS),i);const l={geometry:o,bbox:a,nodeMatrix:i,materialInfo:s,extraInfo:this._createExtralInfo(n.material),animationMatrix:e.trs.getMatrix(),morphWeights:e.weights,nodeIndex:e.nodeIndex};e.skin&&(l.skin={jointTextureSize:[4,6],numJoints:e.skin.joints.length,jointTexture:e.skin.jointTexture});const h=new GeometryResource(l);t.push(h)}))}e.isParsed=!0}_createMaterialInfo(e){const t={};if(this.gltf.materials&&this.gltf.materials[e]){const n=this.gltf.materials[e],i=n.pbrMetallicRoughness;if(i){const e=i.metallicRoughnessTexture,n=i.baseColorTexture;n&&(t.baseColorTexture=this._getTexture(n),n.KHR_texture_transform&&(t.khr_offset=n.KHR_texture_transform.offset||[0,0],t.khr_rotation=n.KHR_texture_transform.rotation||0,t.khr_scale=n.KHR_texture_transform.scale||[1,1])),i.baseColorFactor&&(t.baseColorFactor=i.baseColorFactor),e?t.metallicRoughnessTexture=this._getTexture(e):(t.metallicFactor=fx(i.metallicFactor)?i.metallicFactor:1,t.roughnessFactor=fx(i.roughnessFactor)?i.roughnessFactor:1)}const s=n.extensions;if(s&&s.KHR_materials_pbrSpecularGlossiness){const e=s.KHR_materials_pbrSpecularGlossiness;t.name="pbrSpecularGlossiness";for(const n in e)t[n]=fx(e[n].index)?this._getTexture(e[n]):e[n]}n.normalTexture&&(t.normalTexture=this._getTexture(n.normalTexture)),n.occlusionTexture&&(t.occlusionTexture=this._getTexture(n.occlusionTexture)),n.emissiveTexture&&(t.emissiveTexture=this._getTexture(n.emissiveTexture)),n.emissiveFactor&&(t.emissiveFactor=n.emissiveFactor),t.alphaCutoff=n.alphaCutoff||.5,t.doubleSided=n.doubleSided,t.alphaMode=n.alphaMode||"OPAQUE"}return t}_createExtralInfo(e){const t={};if(this.gltf.materials&&this.gltf.materials[e]){const n=this.gltf.materials[e];t.doubleSided=n.doubleSided,t.alphaMode=n.alphaMode||"OPAQUE"}return t}_getTexture(e){const t=e.extensions,n=e.index;if(!fx(n))return null;t&&t.KHR_texture_transform&&(e.KHR_texture_transform=t.KHR_texture_transform);const i=this._textureMap[n];return i.texInfo=e,i}_toTexture(e){if(!e)return this._emptyTexture;const t=e.sampler||{};return new Texture2D({width:e.image.width,height:e.image.height,data:e.image.array,mag:Wb(t.magFilter)||"linear",min:Zb(t.minFilter)||"linear mipmap linear",wrapS:Yb(t.wrapS)||"repeat",wrapT:Yb(t.wrapT)||"repeat"})}arrangeAlongLine(e,t,n,i,s,o){const a=[],l=this._getRotationZ(e,t),h=(e.z||0)-(t.z||0),c=this._getRotationXY(n,h);let u=this._calBoxWidth(i,o);u/=s;const f=Math.sqrt(n*n+h*h),g=Math.floor(f/u);let m=o.direction||0;if(1===m?m=2:2===m&&(m=1),g>=1){for(let n=1;n<=g;n++){const i=u*(n-.5)/f,s={coordinates:dS(e,t,i),t:i,scale:[1,1,1],rotation:[0,0,l],rotationZ:l,rotationXY:c};a.push(s)}if(o.scaleVertex){const n=(u*g+(f-u*g)/2)/f,i=[1,1,1];i[m]=(f-u*g)/u;const s={coordinates:dS(e,t,n),t:n,scale:i,rotation:[0,0,l],rotationZ:l,rotationXY:c};a.push(s)}}else if(o.scaleVertex){const n=[1,1,1];n[m]=f/u;const i={coordinates:dS(e,t,.5),t:.5,scale:n,rotation:[0,0,l],rotationZ:l,rotationXY:c};a.push(i)}return a}calModelHeightScale(e,t){const n=this.getGLTFBBox(),i=t/Math.abs(n.max[1]-n.min[1]);return ZA(e,i,i,i)}_calBoxWidth(e,t){const n=this.getGLTFBBox(),i=t.direction||0,s=fy(cS,n.max,n.min);JA(s,s,e);return s[i]+t.gapLength}_getRotationZ(e,t){return Math.atan2(e.y-t.y,e.x-t.x)/Math.PI*180}_getRotationXY(e,t){return 180*Math.atan(t/e)/Math.PI}}function uS(e,t){return e[0]-t[0]}function fS(e,t){return Math.abs(t[1])-Math.abs(e[1])}function dS(e,t,n){const i=pS(e.x,t.x,n),s=pS(e.y,t.y,n),o=pS(e.z||0,t.z||0,n);return new e.constructor(i,s,o)}function pS(e,t,n){return e+n*(t-e)}function gS(e,t){const{Ajax:n}=hx(),{fetchOptions:i,gltfLoaderOptions:s,urlModifier:o}=t,a=s||{};a.urlModifier=o;const l=e.lastIndexOf("/"),h=e.slice(0,l),c=e.slice(e.lastIndexOf(".")).toLowerCase();return".gltf"===c?n.getJSON(e,i,o).then((e=>AS(h,e,a))):".glb"===c?n.getArrayBuffer(e,i,o).then((e=>AS(h,{buffer:e.data,byteOffset:0},a))):null}function mS(e,t){return new GLTFPack(e,t)}function AS(e,t,n){const{GLTFLoader:i}=hx();return new i(e,t,n).load()}var yS=Object.freeze({__proto__:null,exportGLTFPack:mS,load:gS,loadGLTF:AS});const _S=[-1,0,-1,1,0,-1,-1,0,1,1,0,1],vS=[0,1,0,0,1,0,0,1,0,0,1,0],xS=[3,1,0,0,2,3],bS=[0,0,1,0,0,1,1,1],wS={vertices:[-.8111000061035156,2.0102999210357666,-.8111000061035156,0,.010300000198185444,-0,-.8111000061035156,2.0102999210357666,.8111000061035156,-.8111000061035156,2.0102999210357666,.8111000061035156,0,.010300000198185444,-0,.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,.8111000061035156,0,.010300000198185444,-0,.8111000061035156,2.0102999210357666,-.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,0,.010300000198185444,-0,-.8111000061035156,2.0102999210357666,-.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,-.8111000061035156,2.0102999210357666,-.8111000061035156,0,2.9419000148773193,-0,.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,0,2.9419000148773193,-0,-.8111000061035156,2.0102999210357666,-.8111000061035156,-.8111000061035156,2.0102999210357666,.8111000061035156,0,2.9419000148773193,-0,-.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,.8111000061035156,0,2.9419000148773193,-0],normals:[-.9267006516456604,-.3758002817630768,-0,-.9267006516456604,-.3758002817630768,-0,-.9267006516456604,-.3758002817630768,-0,0,-.3758002817630768,.9267006516456604,0,-.3758002817630768,.9267006516456604,0,-.3758002817630768,.9267006516456604,.9267006516456604,-.3758002817630768,-0,.9267006516456604,-.3758002817630768,-0,.9267006516456604,-.3758002817630768,-0,0,-.3758002817630768,-.9267006516456604,0,-.3758002817630768,-.9267006516456604,0,-.3758002817630768,-.9267006516456604,0,.656676173210144,-.7541726231575012,0,.656676173210144,-.7541726231575012,0,.656676173210144,-.7541726231575012,.7541726231575012,.656676173210144,-0,.7541726231575012,.656676173210144,-0,.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,0,.656676173210144,.7541726231575012,0,.656676173210144,.7541726231575012,0,.656676173210144,.7541726231575012],indices:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]},TS=["cube","plane","pyramid"],SS={cube:{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1])},NORMAL:{array:new Int8Array([0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1])},TEXCOORD_0:{array:new Int8Array([0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1])}},indices:new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60]}]}]},"plane-cube":{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array(_S)},TEXCOORD_0:{array:new Int8Array(bS)}},indices:new Uint16Array(xS),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60],translation:[0,-60,0]},{mesh:0,scale:[60,60,60],translation:[0,60,0]},{mesh:0,scale:[60,60,60],translation:[60,0,0],rotation:[0,0,.7071067811865475,.7071067811865476]},{mesh:0,scale:[60,60,60],translation:[-60,0,0],rotation:[0,0,.7071067811865475,.7071067811865476]},{mesh:0,scale:[60,60,60],translation:[0,0,60],rotation:[.7071067811865475,0,0,.7071067811865476]},{mesh:0,scale:[60,60,60],translation:[0,0,-60],rotation:[.7071067811865475,0,0,.7071067811865476]}]}]},plane:{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array(_S)},NORMAL:{array:new Int8Array(vS)},TEXCOORD_0:{array:new Int8Array(bS)}},indices:new Uint16Array(xS),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60]}]}]},pyramid:{meshes:[{primitives:[{attributes:{POSITION:{array:new Float32Array(wS.vertices)},NORMAL:{array:new Float32Array(wS.normals)},TEXCOORD_0:{array:new Float32Array(wS.uv)}},indices:new Uint16Array(wS.indices),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60]}]}]}};const MS=function(){const e=[0,0,0],t=90*Math.PI/180,n=[0,0,0,0],i=new Array(16);return function(s,o,a,l,h,c){const u=[NA([],e,[1,0,0],c&&c[0]||[0,-1,0]),NA([],e,[-1,0,0],c&&c[1]||[0,-1,0]),NA([],e,[0,1,0],c&&c[2]||[0,0,1]),NA([],e,[0,-1,0],c&&c[3]||[0,0,-1]),NA([],e,[0,0,1],c&&c[4]||[0,-1,0]),NA([],e,[0,0,-1],c&&c[5]||[0,-1,0])],f={context:{viewMatrix:function(e,t,n){return u[n]},projMatrix:DA(i,t,1,.5,1.1)}};o&&(f.framebuffer=o.faces?function(e,t,n){return o.faces[n]}:o);return s(f)(6,((e,t,i)=>{const c={color:n,depth:1};o&&(c.framebuffer=o.faces?o.faces[i]:o),s.clear(c),a(l),h&&h()})),o}}();var CS={vertices:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],textures:[1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},PS="#define SHADER_NAME CUBE_MAP\nattribute vec3 aPosition;\nvarying vec3 vWorldPos;\nuniform mat4 projMatrix;\nuniform mat4 viewMatrix;\nvoid main() {\n  vWorldPos = aPosition;\n  gl_Position = projMatrix * viewMatrix * vec4(vWorldPos, 1.);\n}",IS="#define SHADER_NAME CUBEMAP\nprecision highp float;\nuniform samplerCube cubeMap;\nuniform float exposure;\nvarying vec3 vWorldPos;\n#ifdef ENCODE_RGBM\nvec4 c(const in vec3 d, const in float e) {\n  if(e <= .0)\n    return vec4(d, 1.);\n  vec4 f;\n  vec3 h = d / e;\n  f.a = clamp(max(max(h.r, h.g), max(h.b, 1e-6)), .0, 1.);\n  f.a = ceil(f.a * 255.) / 255.;\n  f.rgb = h / f.a;\n  return f;\n}\n#endif\nvoid main() {\n  vec4 i = textureCube(cubeMap, vWorldPos);\n  i.rgb *= exposure;\n#ifdef ENCODE_RGBM\ni = c(i.rgb, 7.);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = i;\n#endif\n}",kS="precision highp float;\n#define PI 3.1415926\nvarying vec3 vWorldPos;\nuniform sampler2D equirectangularMap;\nconst vec2 c = vec2(.1591, .3183);\nvec2 d(vec3 e) {\n  vec2 f = vec2(atan(e.y, e.x), asin(e.z));\n  f *= c;\n  f += .5;\n  return f;\n}\nvoid main() {\n  vec2 f = d(normalize(vWorldPos));\n  vec4 h = texture2D(equirectangularMap, f);\n  gl_FragColor = vec4(h.rgb, 1.);\n}",OS="#define SHADER_NAME PBR_prefilter\nprecision highp float;\nvarying vec3 vWorldPos;\nuniform samplerCube environmentMap;\nuniform sampler2D distributionMap;\nuniform float roughness;\nuniform float resolution;\nconst float c = 3.14159265359;\nfloat d(vec3 e, vec3 f, float h) {\n  float a = h * h;\n  float i = a * a;\n  float j = max(dot(e, f), .0);\n  float k = j * j;\n  float l = i;\n  float m = (k * (i - 1.) + 1.);\n  m = c * m * m;\n  return l / m;\n}\nvec3 n(float o, vec3 e, float h) {\n  vec4 u = texture2D(distributionMap, vec2(h, o));\n  vec3 f = u.xyz;\n  float v = sign(u.w - .5);\n  float A = sign(u.w - 200.0 / 255. * clamp(v, .0, 1.) - .15);\n  f.x *= v;\n  f.y *= A;\n  vec3 B = abs(e.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 C = normalize(cross(B, e));\n  vec3 D = cross(e, C);\n  vec3 E = C * f.x + D * f.y + e * f.z;\n  return normalize(E);\n}\nvoid main() {\n  vec3 e = normalize(vWorldPos);\n  vec3 F = e;\n  vec3 G = F;\n  const int I = 1024;\n  vec3 J = vec3(.0);\n  float K = .0;\n  for(int L = 0; L < I; ++L) {\n    vec3 f = n(float(L) / float(I), e, roughness);\n    vec3 M = normalize(2. * dot(G, f) * f - G);\n    float O = max(dot(e, M), .0);\n    if(O > .0) {\n      J += textureCube(environmentMap, M).rgb * O;\n      K += O;\n    }\n  }\n  J = J / K;\n  gl_FragColor = vec4(J, 1.);\n}",ES="precision highp float;\nvarying vec2 vTexCoords;\nuniform sampler2D distributionMap;\nconst float c = 3.14159265359;\nvec4 d(float a, float b) {\n  a *= 65535.;\n  b *= 65535.;\n  vec4 rgba;\n  rgba[0] = mod(a, 255.);\n  rgba[1] = (a - rgba[0]) / 65280.0;\n  rgba[2] = mod(b, 255.);\n  rgba[3] = (b - rgba[2]) / 65280.0;\n  return rgba;\n}\nvec3 e(float f, vec3 h, float i) {\n  vec4 j = texture2D(distributionMap, vec2(i, f));\n  vec3 k = j.xyz;\n  float l = sign(j.w - .5);\n  float m = sign(j.w - clamp(l, .0, 1.) * 200.0 / 255. - .15);\n  k.x *= l;\n  k.y *= m;\n  vec3 n = abs(h.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 o = normalize(cross(n, h));\n  vec3 u = cross(h, o);\n  vec3 v = o * k.x + u * k.y + h * k.z;\n  return normalize(v);\n}\nfloat A(float B, float i) {\n  float a = i;\n  float C = (a * a) / 2.;\n  float D = B;\n  float E = B * (1. - C) + C;\n  return D / E;\n}\nfloat F(float B, float G, float i) {\n  float I = A(B, i);\n  float J = A(G, i);\n  return J * I;\n}\nvec2 K(float B, float i) {\n  vec3 L;\n  L.x = sqrt(1. - B * B);\n  L.y = .0;\n  L.z = B;\n  float M = .0;\n  float O = .0;\n  vec3 h = vec3(.0, .0, 1.);\n  const int P = 1024;\n  for(int Q = 0; Q < P; ++Q) {\n    vec3 k = e(float(Q) / float(P), h, i);\n    vec3 R = normalize(2. * dot(L, k) * k - L);\n    float G = max(R.z, .0);\n    float S = max(k.z, .0);\n    float T = max(dot(L, k), .0);\n    float B = max(dot(h, L), .0);\n    if(G > .0) {\n      float U = F(B, G, i);\n      float W = (U * T) / (S * B);\n      float X = pow(1. - T, 5.);\n      M += (1. - X) * W;\n      O += X * W;\n    }\n  }\n  M /= float(P);\n  O /= float(P);\n  return vec2(M, O);\n}\nvoid main() {\n  vec2 Y = K(vTexCoords.x, vTexCoords.y);\n  gl_FragColor = d(Y.x, Y.y);\n}",RS="attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoords;\nvoid main() {\n  vTexCoords = aTexCoord;\n  gl_Position = vec4(aPosition, 1.);\n}";
/*!
   * from claygl
   * https://github.com/pissang/claygl/
   * License: BSD-2-Clause
   */
function LS(e,t){const n=e[0],i=e[1],s=e[2];return 0===t?1:1===t?n:2===t?i:3===t?s:4===t?n*s:5===t?i*s:6===t?n*i:7===t?3*s*s-1:n*n-i*i}const DS={px:[2,1,0,-1,-1,1],nx:[2,1,0,1,-1,-1],py:[0,2,1,1,-1,-1],ny:[0,2,1,1,1,1],pz:[0,1,2,-1,-1,-1],nz:[0,1,2,1,-1,1]},FS=["px","nx","py","ny","pz","nz"];let HS;const NS=Ww.compile(UT);function BS(e,t,n,i,s=1,o=!1){const a=e({frag:(o?"#define ENCODE_RGBM\n":"")+IS,vert:PS,attributes:{aPosition:CS.vertices},uniforms:{projMatrix:e.context("projMatrix"),viewMatrix:e.context("viewMatrix"),cubeMap:t,exposure:s},elements:CS.indices}),l=[],h=e.texture({radius:n,min:"linear",mag:"linear",type:i?"float":"uint8",format:"rgba"}),c=e.framebuffer({radius:n,color:h});return MS(e,c,a,{size:n},(function(){const t=e.read();if(i){const e=new Uint16Array(t.length);for(let n=0;n<t.length;n++)e[n]=Math.min(Bw.toHalfFloat(t[n]),65504);l.push(e)}else l.push(t)})),a.destroy(),c.destroy(),l}const zS=new Int8Array([-1,1,0,-1,-1,0,1,1,0,1,-1,0]),GS=new Int8Array([0,1,0,0,1,1,1,0]);function US(e){return e.vao&&e||function(){if(!HS){const e=document.createElement("canvas").getContext("webgl");HS=Wm({optionalExtensions:["OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear"],attributes:{alpha:!0,depth:!0,stencil:!0,preserveDrawingBuffer:!0},gl:e}),HS.on("lost",(()=>{HS.destroy(),HS=null}))}return HS}()}function VS(e,t,n,i){const s=US(e);t=t||256;const o=jS(n=n||1024,i=i||256),a=s.texture({data:o,width:i,height:n,min:"nearest",mag:"nearest"}),l=s.buffer({data:zS,name:"aPosition"}),h=s.buffer({data:GS,name:"aTexCoord"}),c=s.framebuffer({radius:t,colorType:"uint8",colorFormat:"rgba",min:"linear",mag:"linear"}),u=s({frag:ES,vert:RS,attributes:{aPosition:{buffer:l},aTexCoord:{buffer:h}},uniforms:{distributionMap:a},framebuffer:c,viewport:{x:0,y:0,width:t,height:t},count:zS.length/3,primitive:"triangle strip"});if(u(),e.wgpu){const t=s.read({framebuffer:c});return new GraphicsTexture(e,{data:t,width:c.width,height:c.height})}return u.destroy(),l.destroy(),h.destroy(),a.destroy(),c}function jS(e,t){const n=new Float32Array(e*t*4);for(let i=0;i<e;i++){const{x:s,y:o}=WS(i,e);for(let e=0;e<t;e++){const a=e/t,l=a*a,h=2*Math.PI*s,c=Math.sqrt((1-o)/(1+(l*l-1)*o)),u=Math.sqrt(1-c*c),f=4*(i*t+e),g=u*Math.cos(h),m=u*Math.sin(h);n[f]=Math.abs(255*g),n[f+1]=Math.abs(255*m),n[f+2]=255*c,n[f+3]=(g>0?200:0)+(m>0?55:0)}}return n}function WS(e,t){let n=(e<<16|e>>>16)>>>0;return n=((1431655765&n)<<1|(2863311530&n)>>>1)>>>0,n=((858993459&n)<<2|(3435973836&n)>>>2)>>>0,n=((252645135&n)<<4|(4042322160&n)>>>4)>>>0,n=(((16711935&n)<<8|(4278255360&n)>>>8)>>>0)/4294967296,{x:e/t,y:n}}function qS(e){return e._gl instanceof WebGL2RenderingContext||e.hasExtension("OES_texture_half_float")}var ZS=Object.freeze({__proto__:null,createIBLMaps:function(e,t={}){e=US(e);const n=t.envTexture,i=t.envCubeSize||512,s=t.sampleSize||1024,o=t.roughnessLevels||256,a=t.prefilterCubeSize||256;let l,h=!1;if(Array.isArray(n)){const t=e.cube({flipY:!0,faces:n});l=function(e,t,n){const i=e({frag:NS,vert:PS,attributes:{aPosition:CS.vertices},uniforms:{hsv:[0,0,0],projMatrix:e.context("projMatrix"),viewMatrix:e.context("viewMatrix"),cubeMap:t,bias:0,size:t.width,environmentExposure:1,backgroundIntensity:1},elements:CS.indices}),s=e.cube({width:n,height:n,min:"linear",mag:"linear",format:"rgba"}),o=e.framebufferCube({radius:n,color:s});return MS(e,o,i,{size:n},null,[[0,0,-1],[0,0,-1],[0,0,1],[0,0,1],[0,-1,0],[0,-1,0]]),i.destroy(),o}(e,t,i),t.destroy()}else l=function(e,t,n){if(!qS(e))throw new Error("HDR is not supported for lack of support for float 16 texture");n=n||512;const i=e({frag:kS,vert:PS,attributes:{aPosition:CS.vertices},uniforms:{projMatrix:e.context("projMatrix"),viewMatrix:e.context("viewMatrix"),equirectangularMap:t},elements:CS.indices}),s=e.cube({width:n,height:n,min:"linear mipmap linear",mag:"linear",type:"float16",format:"rgba"}),o=e.framebufferCube({radius:n,color:s});return MS(e,o,i),i.destroy(),o}(e,n,i),h=!0;const{prefilterMap:c,prefilterMipmap:u}=function(e,t,n,i,s,o){const a=function(e,t,n,i,s,o){i=i||1024,s=s||256;const a=jS(i,s),l=e.texture({data:a,width:s,height:i,min:"nearest",mag:"nearest"}),h=e({frag:OS,vert:PS,attributes:{aPosition:CS.vertices},uniforms:{projMatrix:e.context("projMatrix"),viewMatrix:e.context("viewMatrix"),environmentMap:t,distributionMap:l,roughness:e.prop("roughness"),resolution:n},elements:CS.indices,viewport:{x:0,y:0,width:e.prop("size"),height:e.prop("size")}});let c=n;const u=e.texture({radius:n,min:"linear",mag:"linear",type:o?"float":"uint8"}),f=e.framebuffer({radius:n,color:u}),g=Math.log(c)/Math.log(2),m=[];for(let t=0;t<=g;t++){let n=0;MS(e,f,h,{roughness:t/(g-1),size:c},(function(){const t=e.read({framebuffer:f});let i=t;if(o){i=new Uint16Array(t.length);for(let e=0;e<t.length;e++)i[e]=Math.min(Bw.toHalfFloat(t[e]),65504)}m[n]||(m[n]={mipmap:[]}),m[n].mipmap.push(i),n++})),c/=2,f.resize(c)}return l.destroy(),f.destroy(),h.destroy(),m}(e,t,n,i,s,o),l=e.cube({radius:n,min:"linear",mag:"linear",type:o?"float16":"uint8",faces:a,format:"rgba"});return{prefilterMap:l,prefilterMipmap:a}}(e,l,a,s,o,h);let f;if(!t.ignoreSH){const n=a;f=function(e,t,n){const i=new Array(9),s=[],o=[],a=[];for(let l=0;l<9;l++){const h=[0,0,0];for(let i=0;i<FS.length;i++){const c=e[i],u=[0,0,0];let f=0,g=0;const m=DS[FS[i]];for(let e=0;e<n;e++)for(let i=0;i<t;i++){s[0]=i/(t-1)*2-1,s[1]=e/(n-1)*2-1,s[2]=-1,ry(s,s),a[0]=s[m[0]]*m[3],a[1]=s[m[1]]*m[4],a[2]=s[m[2]]*m[5],o[0]=c[g++]/255,o[1]=c[g++]/255,o[2]=c[g++]/255;const h=c[g++]/255*7;o[0]*=h,o[1]*=h,o[2]*=h,KA(u,u,o,LS(a,l)*-s[2]),f+=-s[2]}KA(h,h,u,1/f)}i[l]=$A(h,h,1/6)}return i}(BS(e,c,n,!1,t.environmentExposure,!0),n,n);const i=[];for(let e=0;e<f.length;e++)i.push(...f[e]);f=i}const g={envMap:l,isHDR:h,prefilterMap:c};return f&&(g.sh=f),"array"===t.format&&(g.envMap={width:l.width,height:l.height,faces:BS(e,l,i,h)},g.prefilterMap={width:c.width,height:c.height,faces:u},l.destroy(),c.destroy()),g},generateDFGLUT:VS,supportFloat16:qS});const XS={uvScale:[1,1],uvOffset:[0,0],uvRotation:0,textureOrigin:null,textureWidth:null,baseColorFactor:[1,1,1,1],emissiveFactor:[0,0,0],baseColorIntensity:1,emitColorFactor:1,occlusionFactor:1,roughnessFactor:.4,metallicFactor:0,normalMapFactor:1,specularF0:.5,emitMultiplicative:1,normalMapFlipY:0,outputSRGB:1,baseColorTexture:null,normalTexture:null,occlusionTexture:null,metallicRoughnessTexture:null,emissiveTexture:null,uvOrigin:[0,0],noiseTexture:null,specularAAVariance:20,specularAAThreshold:20,hsv:[0,0,0],contrast:1,bumpTexture:null,bumpScale:.05,bumpMinLayers:5,bumpMaxLayers:20,alphaTest:0};class StandardMaterial extends Material{constructor(e){const t=px({},XS);(e.metallicRoughnessTexture||e.metallicRoughnessTexture)&&(t.roughnessFactor=1,t.metallicFactor=1),super(e,t)}appendDefines(e,t){super.appendDefines(e,t);const n=this.uniforms,i=t.data[t.desc.positionAttribute];i.buffer&&i.buffer.itemType&&i.buffer.itemType.startsWith("sint")&&(e.POSITION_IS_INT=1);const s=t.data[t.desc.normalAttribute];s&&s.buffer&&s.buffer.itemType&&s.buffer.itemType.startsWith("sint")&&(e.NORMAL_IS_INT=1),n.GAMMA_CORRECT_INPUT&&(e.GAMMA_CORRECT_INPUT=1),t.data[t.desc.colorAttribute]&&(e.HAS_COLOR=1);if(t.data[t.desc.color0Attribute]&&(e.HAS_COLOR0=1,e.COLOR0_SIZE=t.getColor0Size()),t.data[t.desc.tangentAttribute]?e.HAS_TANGENT=1:t.data[t.desc.normalAttribute]&&(e.HAS_NORMAL=1),t.data.aVertexColorType&&(e.HAS_VERTEX_COLOR=1),!t.data[t.desc.uv0Attribute])return e;n.baseColorTexture&&(e.HAS_ALBEDO_MAP=1),n.metallicRoughnessTexture&&(e.HAS_METALLICROUGHNESS_MAP=1),n.occlusionTexture&&t.data[t.desc.uv1Attribute]&&(e.HAS_AO_MAP=1),n.emissiveTexture&&(e.HAS_EMISSIVE_MAP=1),n.normalTexture&&(e.HAS_NORMAL_MAP=1),n.bumpTexture&&(e.HAS_BUMP_MAP=1),n.skinTexture&&(e.HAS_SKIN_MAP=1),(e.HAS_ALBEDO_MAP||e.HAS_METALLICROUGHNESS_MAP||e.HAS_AO_MAP||e.HAS_EMISSIVE_MAP||e.HAS_NORMAL_MAP||e.HAS_BUMP_MAP||e.HAS_SKIN_MAP)&&(e.HAS_MAP=1),n.noiseTexture&&(e.HAS_RANDOM_TEX=1),t.data[t.desc.tangentAttribute]?e.HAS_TANGENT=1:t.data[t.desc.normalAttribute]&&(e.HAS_NORMAL=1);const o=n.alphaMode&&n.alphaMode.toUpperCase();return"MASK"===o?e.ALPHA_MODE=1:"OPAQUE"===o&&(e.ALPHA_MODE=2),e}}class StandardSpecularGlossinessMaterial extends(dw(StandardMaterial)){}function YS(e,t,n){if(n.ambientUpdate){const{iblTexes:i}=e,s=n.target;i?($S(i),e.iblTexes=QS(t,s)):e.iblTexes=QS(t,s),s.getRenderer().setToRedraw()}}const JS=[0,0];function QS(e,t){const n=t.getLightManager(),i=n&&n.getAmbientResource();if(!i)return null;const s=i.isHDR;return{prefilterMap:e.cube({width:i.prefilterMap.width,height:i.prefilterMap.height,faces:i.prefilterMap.faces,min:"linear",mag:"linear",format:"rgba",type:s?"float16":"uint8"}),envMap:e.cube({width:i.envMap.width,height:i.envMap.height,faces:i.envMap.faces,min:"linear",mag:"linear",format:"rgba",type:s?"float16":"uint8"}),sh:i.sh}}function $S(e){for(const t in e)e[t]&&e[t].destroy&&e[t].destroy(),delete e[t]}var KS=Object.freeze({__proto__:null,createIBLTextures:QS,disposeIBLTextures:$S,getIBLResOnCanvas:function(e){const{dfgLUT:t,iblTexes:n}=e;return{dfgLUT:t,iblTexes:n}},getPBRUniforms:function(e,t,n,i,s){const o=e.viewMatrix,a=e.projMatrix,l=e.cameraPosition,h=e.getRenderer().canvas,c=function(e,t){const n=e.getLightManager(),i=n&&n.getAmbientResource(),s=n&&n.getAmbientLight()||{},o=n&&n.getDirectionalLight()||{};let a;if(i){const e=t.prefilterMap.width,n=Math.log(e)/Math.log(2);a={prefilterMap:t.prefilterMap,diffuseSPH:t.sh,prefilterMiplevel:[n,n],prefilterSize:[e,e],hdrHSV:s.hsv||[0,0,0]}}else a={ambientColor:s.color||[.2,.2,.2]};return a.environmentExposure=mx(s.exposure)?s.exposure:1,a.environmentOrientation=s.orientation||0,a.light0_diffuse=[...o.color||[1,1,1],1],a.light0_viewDirection=o.direction||[1,1,-1],a}(e,t),u=px({viewMatrix:o,projMatrix:a,projViewMatrix:e.projViewMatrix,cameraPosition:l,outSize:[h.width,h.height],cameraNearFar:[e.cameraNear,e.cameraFar]},c);return u.brdfLUT=n,i&&i.renderUniforms&&px(u,i.renderUniforms),u.halton=s||JS,u},isSupported:function(e){return!!e.wgpu||e.hasExtension("EXT_shader_texture_lod")},loginIBLResOnCanvas:function(e,t,n){if(!e.dfgLUT&&(e.dfgLUT=VS(t),e.dfgLUT.mtkRefCount=0,n)){const i=(...n)=>YS.call(this,e,t,...n);n.on("updatelights",i),e._iblResListener=i}e.dfgLUT.mtkRefCount++;const i=n.getLightManager();return i&&i.getAmbientResource()?(e.iblTexes||(e.iblTexes=QS(t,n)),{dfgLUT:e.dfgLUT,iblTexes:e.iblTexes}):{dfgLUT:e.dfgLUT,iblTexes:null}},logoutIBLResOnCanvas:function(e,t){let n=!1;if(e.dfgLUT&&(e.dfgLUT.mtkRefCount--,e.dfgLUT.mtkRefCount<=0)){if(n=!0,t){t.off("updatelights",e._iblResListener)}e.dfgLUT.destroy(),delete e.dfgLUT}e.iblTexes&&n&&($S(e.iblTexes),delete e.iblTexes)}});class ShadowMapShader extends MeshShader{constructor(e){super({vert:"attribute vec3 aPosition;\nuniform mat4 lightProjViewModelMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelMatrix;\n#include <line_extrusion_vert>\n#include <get_output>\nvarying vec4 vPosition;\nvoid main() {\n  mat4 c = getPositionMatrix();\n#ifdef IS_LINE_EXTRUSION\nvec3 d = getLineExtrudePosition(aPosition);\n  vec4 e = getPosition(d);\n#else\nvec4 e = getPosition(aPosition);\n#endif\ngl_Position = lightProjViewModelMatrix * c * e;\n  vPosition = gl_Position;\n}",frag:"#define SHADER_NAME vsm_mapping\nprecision highp float;\nvarying vec4 vPosition;\n#ifdef PACK_FLOAT\n#include <common_pack_float>\n#endif\nvoid main() {\n  \n#if defined(USE_ESM)\n#ifdef PACK_FLOAT\ngl_FragColor = common_encodeDepth(gl_FragCoord.z);\n#else\ngl_FragColor = vec4(gl_FragCoord.z, .0, .0, 1.);\n#endif\n#endif\n}",uniforms:[{name:"lightProjViewModelMatrix",type:"function",fn:function(e,t){return vA([],t.lightProjViewMatrix,t.modelMatrix)}}],extraCommandProps:{},defines:e})}filter(e){return e.castShadow}}class BoxShadowBlurShader extends QuadShader{constructor({blurOffset:e}){super({vert:RT,frag:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D textureSource;\nuniform vec2 resolution;\n#include <common_pack_float>\nvoid main() {\n  float c = .0;\n  float d = .0;\n  for(int x = -BOXBLUR_OFFSET; x <= BOXBLUR_OFFSET; ++x)\n    for(int y = -BOXBLUR_OFFSET; y <= BOXBLUR_OFFSET; ++y) {\n      vec2 e = vTexCoord.st + vec2(float(x) / resolution.x, float(y) / resolution.y);\n      e = clamp(e, .0, 1.);\n      float f = common_decodeDepth(texture2D(textureSource, e));\n      float s = max(.0, sign(1. - f));\n      d += sign(f) * s;\n      c += f;\n    }\n  float h = c / max(1., d);\n  gl_FragColor = common_encodeDepth(h);\n}",defines:{BOXBLUR_OFFSET:e||2}}),this._blurOffset=e||2}getMeshCommand(e,t){const n="box_shadow_blur_"+this._blurOffset;return this.commands[n]||(this.commands[n]=this.createMeshCommand(e,t)),this.commands[n]}}let eM=null,tM=null;class ShadowPass{constructor(e,{width:t,height:n,blurOffset:i,defines:s}){this.renderer=e,this.width=t||512,this.height=n||512,this.blurOffset=ux(i)?2:i,this._init(s)}render(e,{cameraProjViewMatrix:t,lightDir:n,farPlane:i,cameraLookAt:s}){return{lightProjViewMatrix:this._renderShadow(e,t,n,i,s),shadowMap:this.blurTex||this.depthTex,depthFBO:this.depthFBO,blurFBO:this.blurFBO}}resize(e,t){return this.depthTex&&(this.depthTex.resize(e,t),this.depthFBO.resize(e,t)),this.width=e,this.blurFBO&&(this.blurTex.resize(e,t),this.blurFBO.resize(e,t)),this.height=t,this}_renderShadow(e,t,n,i,s){const o=this.renderer,a=eM(t);if(i)for(let e=4;e<8;e++)a[e]=i[e-4];const l=tM(s,a,n);return o.clear({color:[1,0,0,1],depth:1,framebuffer:this.depthFBO}),o.render(this.shadowMapShader,{lightProjViewMatrix:l},e,this.depthFBO),this.blurFBO&&(this.boxBlurShader||(this.boxBlurShader=new BoxShadowBlurShader({blurOffset:this.blurOffset})),o.clear({color:[1,0,0,1],depth:1,framebuffer:this.blurFBO}),o.render(this.boxBlurShader,{resolution:[this.depthTex.width,this.depthTex.height],textureSource:this.depthTex},null,this.blurFBO)),l}_init(e){const t=this.renderer.device,n="uint8",i=this.width,s=this.height;this.depthTex=t.texture({width:i,height:s,format:"rgba",type:n,min:"nearest",mag:"nearest"}),this.shadowMapShader=new ShadowMapShader(e),this.shadowMapShader.filter=e=>e.castShadow,this.depthFBO=t.framebuffer({color:this.depthTex}),this.blurOffset<=0||(this.blurTex=t.texture({width:i,height:s,format:"rgba",type:n,min:"linear",mag:"linear"}),this.blurFBO=t.framebuffer({color:this.blurTex}))}dispose(){this.depthTex&&(this.depthTex.destroy(),this.depthFBO.destroy(),delete this.depthTex,delete this.depthFBO),this.blurTex&&(this.blurTex.destroy(),this.blurFBO.destroy(),delete this.blurTex,delete this.blurFBO),this.shadowMapShader&&(this.shadowMapShader.dispose(),delete this.shadowMapShader),this.boxBlurShader&&(this.boxBlurShader.dispose(),delete this.boxBlurShader)}}eM=function(){const e=[[-1,-1,-1,1],[1,-1,-1,1],[1,1,-1,1],[-1,1,-1,1],[-1,-1,1,1],[1,-1,1,1],[1,1,1,1],[-1,1,1,1]],t=new Array(16);return function(n){_A(t,n);const i=[];for(let n=0;n<e.length;n++){const s=Ny([],e[n],t);ky(s,s,1/s[3]),i.push(s)}return i}}(),tM=function(){let e=new Array(4);const t=new Array(3),n=[0,0,0,0],i=[0,1,0],s=new Array(3);let o=new Array(16),a=new Array(16);const l=new Array(16),h=[1,1,1],c=[0,0,0];return function(u,f,g){Sy(n,...u,1),$A(t,g,-1),o=NA(o,XA(s,n,ry(s,t)),n,i),Ny(e,f[0],o);let m=e[2],A=e[2],w=e[0],T=e[0],S=e[1],M=e[1];for(let t=1;t<8;t++)e=Ny(e,f[t],o),e[2]>A&&(A=e[2]),e[2]<m&&(m=e[2]),e[0]>T&&(T=e[0]),e[0]<w&&(w=e[0]),e[1]>M&&(M=e[1]),e[1]<S&&(S=e[1]);a=HA(a,-1,1,-1,1,-A,-m);const C=h[0]=2/(T-w),I=h[1]=-2/(M-S);c[0]=-.5*(w+T)*C,c[1]=-.5*(S+M)*I,AA(l),xA(l,l,c),bA(l,l,h);const E=vA(a,l,a);return vA(new Array(16),E,o)}}();class ShadowDisplayShader extends MeshShader{constructor(e){super({vert:"#define SHADER_NAME SHADOW_DISPLAY\nattribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 modelViewMatrix;\nuniform vec2 halton;\nuniform vec2 globalTexSize;\nvarying vec4 vPosition;\n#include <vsm_shadow_vert>\nvoid main() {\n  vec4 c = vec4(aPosition, 1.);\n  vec4 d = modelViewMatrix * c;\n  mat4 e = projMatrix;\n  e[2].xy += halton.xy / globalTexSize.xy;\n  gl_Position = e * d;\n  vPosition = gl_Position;\n  shadow_computeShadowPars(c);\n}",frag:"#define SHADER_NAME SHADOW_DISPLAY\nprecision mediump float;\nuniform vec3 color;\n#include <vsm_shadow_frag>\nvoid main() {\n  float c = shadow_computeShadow();\n  float d = 1. - c;\n  gl_FragColor = vec4(color * d, d);\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(e,t){const n=[];return vA(n,t.viewMatrix,t.modelMatrix),n}}],defines:e||{USE_ESM:1},extraCommandProps:{depth:{enable:!0,mask:!1},viewport:{x:0,y:0,width:(e,t)=>t.globalTexSize[0],height:(e,t)=>t.globalTexSize[1]}}})}getMeshCommand(e,t){return this.commands.shadow_display||(this.commands.shadow_display=this.createMeshCommand(e,t)),this.commands.shadow_display}}function nM(e){return 256*e[2]*256+256*e[1]+e[0]}const rM=new Uint8Array(4),iM=new Float32Array(rM.buffer);let sM,oM;const aM=[1,1],lM="\n    vec3 unpack(highp float f) {\n        highp vec3 color;\n        color.b = floor(f / 65536.0);\n        color.g = floor((f - color.b * 65536.0) / 256.0);\n        color.r = f - floor(color.b * 65536.0) - floor(color.g * 256.0);\n        // now we have a vec3 with the 3 components in range [0..255]. Let's normalize it!\n        return color / 255.0;\n    }\n",hM="\nfn unpack(f: f32) -> vec3f {\n    var color: vec3f;\n    color.b = floor(f / 65536.0);\n    color.g = floor((f - color.b * 65536.0) / 256.0);\n    color.r = f - floor(color.b * 65536.0) - floor(color.g * 256.0);\n    return color / 255.0;\n}\n",cM=`\n    precision highp float;\n\n    varying float vPickingId;\n    varying float vFbo_picking_visible;\n\n    uniform float fbo_picking_meshId;\n\n    ${lM}\n\n    void main() {\n        if (vFbo_picking_visible == 0.0) {\n            discard;\n            return;\n        }\n        gl_FragColor = vec4(unpack(vPickingId), fbo_picking_meshId / 255.0);\n    }\n`,uM=`\n    ${hM}  // Assuming unpack function is defined in this include\n\n    struct PickingUniforms {\n        fbo_picking_meshId: f32,\n    };\n\n    @group(0) @binding($b) var<uniform> pickingUniforms: PickingUniforms;\n\n    struct VertexOutput {\n        @location($i) vPickingId: f32,\n        @location($i) vFbo_picking_visible: f32,\n    };\n\n    @fragment\n    fn main(vertexOutput: VertexOutput) -> @location(0) vec4f {\n        if (vertexOutput.vFbo_picking_visible == 0.0) {\n            discard;\n        }\n\n        let rgb = unpack(vertexOutput.vPickingId);\n        let alpha = pickingUniforms.fbo_picking_meshId / 255.0;\n        return vec4f(rgb, alpha);\n        // return vec4f(1.0, 0.0, 0.0, 1.0);\n    }\n`,fM=`\n    precision highp float;\n\n    uniform int fbo_picking_meshId;\n    varying float vFbo_picking_visible;\n\n    ${lM}\n\n    void main() {\n        if (vFbo_picking_visible == 0.0) {\n            discard;\n            return;\n        }\n        gl_FragColor = vec4(unpack(float(fbo_picking_meshId)), 1.0);\n        // gl_FragColor = vec4(unpack(float(35)), 1.0);\n    }\n`,dM=`\n    ${hM}\n\n    struct PickingUniforms {\n        fbo_picking_meshId: f32,\n    };\n\n    @group(0) @binding(0) var<uniform> pickingUniforms: PickingUniforms;\n\n    struct VertexOutput {\n        @location($i) vFbo_picking_visible: f32,\n    };\n\n    @fragment\n    fn main(vertexOutput: VertexOutput) -> @location(0) vec4f {\n        if (vertexOutput.vFbo_picking_visible == 0.0) {\n            discard;\n        }\n\n        let meshIdFloat = pickingUniforms.fbo_picking_meshId;\n        let rgb = unpack(meshIdFloat);\n\n        return vec4f(rgb, 1.0);\n    }\n`,pM=`\n    precision highp float;\n\n    varying float vPickingId;\n    varying float vFbo_picking_visible;\n\n    ${lM}\n\n    void main() {\n        if (vFbo_picking_visible == 0.0) {\n            discard;\n            return;\n        }\n        gl_FragColor = vec4(unpack(vPickingId), 1.0);\n    }\n`,gM=`\n    ${hM}\n\n    struct VertexOutput {\n        @location($i) vPickingId: f32,\n        @location($i) vFbo_picking_visible: f32,\n    };\n\n    @fragment\n    fn main(vertexOutput: VertexOutput) -> @location(0) vec4f {\n        if (vertexOutput.vFbo_picking_visible == 0.0) {\n            discard;\n        }\n        let rgb = unpack(vertexOutput.vPickingId);\n        return vec4f(rgb, 1.0);\n    }\n`;function mM(e,t,n){const i=t[0],s=t[1],o=t[2],a=1/(n[3]*i+n[7]*s+n[11]*o+n[15]);return e[0]=(n[0]*i+n[4]*s+n[8]*o+n[12])*a,e[1]=(n[1]*i+n[5]*s+n[9]*o+n[13])*a,e[2]=(n[2]*i+n[6]*s+n[10]*o+n[14])*a,e}function AM(e){return mx(e)&&(aM[0]=aM[1]=e,e=aM),e}const yM=e=>e&&e.geometry&&void 0===e.geometry.properties.shaderHash,_M=[],vM=[],xM=[{name:"modelViewMatrix",type:"function",fn:(e,t)=>vA(_M,t.viewMatrix,t.modelMatrix)},{name:"modelViewProjMatrix",type:"function",fn:(e,t)=>{const n=vA(_M,t.viewMatrix,t.modelMatrix);return vA(_M,t.projMatrix,n)}},{name:"modelMatrixInverse",type:"function",fn:(e,t)=>_A(_M,t.modelMatrix)},{name:"projMatrixInverse",type:"function",fn:(e,t)=>_A(_M,t.projMatrix)},{name:"modelViewMatrixInverse",type:"function",fn:(e,t)=>(vA(_M,t.viewMatrix,t.modelMatrix),_A(_M,_M))},{name:"modelViewProjMatrixInverse",type:"function",fn:(e,t)=>{const n=vA(_M,t.viewMatrix,t.modelMatrix);return vA(_M,t.projMatrix,n),_A(_M,_M)}},{name:"modelInverseTransposeMatrix",type:"function",fn:(e,t)=>{const n=oA(vM,t.modelMatrix),i=lA(n,n);return hA(i,i)}},{name:"modelViewInverseTransposeMatrix",type:"function",fn:(e,t)=>{const n=vA(_M,t.viewMatrix,t.modelMatrix),i=oA(vM,n),s=lA(i,i);return hA(s,s)}}],bM={LOCAL:"positionMatrix",MODEL:"modelMatrix",VIEW:"viewMatrix",PROJECTION:"projMatrix",MODELVIEW:"modelViewMatrix",MODELVIEWPROJECTION:"modelViewProjMatrix",MODELINVERSE:"modelMatrixInverse",VIEWINVERSE:"viewMatrixInverse",PROJECTIONINVERSE:"projMatrixInverse",MODELVIEWINVERSE:"modelViewMatrixInverse",MODELVIEWPROJECTIONINVERSE:"modelViewProjMatrixInverse",MODELINVERSETRANSPOSE:"modelInverseTransposeMatrix",MODELVIEWINVERSETRANSPOSE:"modelViewInverseTransposeMatrix",VIEWPORT:"viewport",JOINTMATRIX:"jointMatrix",ALPHACUTOFF:"alphaCutoff"};class DynamicBufferPool{constructor(e,t,n){this.activeBuffer=null,this.device=e,this.usedBuffers=[],this.poolBuffers=[],this.bufferSize=t,this.bufferAlignment=n}destroy(){this.poolBuffers.forEach((e=>{e.gpuBuffer.destroy()})),this.poolBuffers.length=0,this.usedBuffers.length=0,this.activeBuffer=null}alloc(e,t){if(this.activeBuffer){const e=bb(this.activeBuffer.size,this.bufferAlignment);this.bufferSize-e<t&&this.scheduleSubmit()}this.activeBuffer||(this.activeBuffer=this.poolBuffers.pop(),this.activeBuffer||(this.activeBuffer={gpuBuffer:this.createBuffer(this.device,this.bufferSize),storage:new ArrayBuffer(this.bufferSize),offset:0,size:0}),this.activeBuffer.offset=0,this.activeBuffer.size=0);const n=this.activeBuffer,i=bb(n.size,this.bufferAlignment);e.gpuBuffer=n.gpuBuffer,e.offset=i,e.storage=n.storage,n.size=i+t}createBuffer(e,t){return e.createBuffer({size:t,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST})}scheduleSubmit(){this.activeBuffer&&(this.usedBuffers.push(this.activeBuffer),this.activeBuffer=null)}submit(){this.scheduleSubmit();const e=this.usedBuffers.length;if(e){const t=this.device,n=this.poolBuffers;for(let i=e-1;i>=0;i--){const e=this.usedBuffers[i],{storage:s,gpuBuffer:o,offset:a,size:l}=e;t.queue.writeBuffer(o,0,s,a,l),n.push(e)}this.usedBuffers.length=0}}}let wM=0;class GraphicsDevice{constructor(e,t,n){this.commandBuffers=[],this._readTargets={},this.wgpu=e,this.adapter=n;const i=navigator.gpu.getPreferredCanvasFormat();t.configure({device:e,format:i,alphaMode:"premultiplied"}),this.context=t;this.dynamicBufferPool=new DynamicBufferPool(e,1048576,e.limits.minUniformBufferOffsetAlignment)}hasExtension(e){return this._supportedFormats||(this._supportedFormats=kx(this.wgpu)),!0}getCommandEncoder(){let e=this.commandEncoder;return e||(e=this.wgpu.createCommandEncoder(),this.commandEncoder=e),e}endCommandEncoder(){const{commandEncoder:e}=this;if(e){const t=e.finish();this.addCommandBuffer(t,!1),this.commandEncoder=null}}getDefaultFramebuffer(){let e=this._defaultFramebuffer;if(!e){const t=this.context.canvas;e=this._defaultFramebuffer=new GraphicsFramebuffer(this,{width:t.width,height:t.height,depthStencil:!0}),e.uid=wM++}return e}getRenderPassEncoder(e){const t=(e=e||this.getDefaultFramebuffer()).getRenderPassDescriptor();return this.getCommandEncoder().beginRenderPass(t)}addCommandBuffer(e,t){t?this.commandBuffers.unshift(e):this.commandBuffers.push(e)}submit(){this.endCommandEncoder(),this.dynamicBufferPool.submit(),this.commandBuffers.length>0&&(this.wgpu.queue.submit(this.commandBuffers),this.commandBuffers.length=0)}buffer(e){return Geometry.createBuffer(this,e,e.name)}framebuffer(e,t){let n;return mx(e)?(void 0===t&&(t=e),n={color:!0,depthStencil:!0,width:e,height:t}):n=e,new GraphicsFramebuffer(this,n)}texture(e){return mx(e)&&(e={width:e,height:e}),new GraphicsTexture(this,e)}clear(e){(e.framebuffer||this.getDefaultFramebuffer()).setClearOptions(e)}read(e){const t=e.framebuffer||this._defaultFramebuffer,n=t.width,i=t.height;let{width:s,height:o}=e;s||(s=n),o||(o=i);const a=this.wgpu;this.submit();const l={x:e.x,y:i-e.y,z:0};l.x+s>n&&(l.x=n-s),l.y+o>i&&(l.y=i-o);const h=e.pixels||new Uint8Array(s*o*4);if(t===this._defaultFramebuffer){const e=new OffscreenCanvas(s,o).getContext("2d",{willReadFrequently:!0});e.drawImage(this.context.canvas,l.x,l.y,s,o,0,0,s,o);const t=e.getImageData(0,0,s,o).data;for(let e=0;e<h.length;e+=4)h[e]=t[e],h[e+1]=t[e+1],h[e+2]=t[e+2],h[e+3]=t[e+3];return h}const c=["opaque","premultiplied"],u=c.map((()=>new OffscreenCanvas(s,o)));return u.map(((e,t)=>{const n=e.getContext("webgpu");return n.configure({device:a,format:"bgra8unorm",usage:GPUTextureUsage.COPY_DST,alphaMode:c[t]}),n.getCurrentTexture()})).map(((e,n)=>{const i=a.createCommandEncoder();i.copyTextureToTexture({texture:t.colorTexture.texture,origin:l},{texture:e},{width:s,height:o}),this.wgpu.queue.submit([i.finish()]);const f=new OffscreenCanvas(s,o).getContext("2d",{willReadFrequently:!0});f.drawImage(u[n],0,0);const g=f.getImageData(0,0,s,o).data,m=c[n];for(let e=0;e<h.length;e+=4)"premultiplied"===m?h[e+3]=g[e+3]:(h[e]=g[e],h[e+1]=g[e+1],h[e+2]=g[e+2])})),h}destroy(){this._defaultFramebuffer&&(this._defaultFramebuffer.destroy(),delete this._defaultFramebuffer);for(const e in this._readTargets){const t=this._readTargets[e];t&&t.destroy()}this._readTargets={}}}const TM={parseHDR:Fw},SM={PBRHelper:ZS,StandardMaterial,StandardSpecularGlossinessMaterial,StandardShader:class StandardShader extends MeshShader{constructor(e={}){let t=e.extraCommandProps||{};const n=e.uniforms;t=px({},t);const i=e.defines||{},s=[],o=[],a=[],l=[],h=[],c=[{name:"modelNormalMatrix",type:"function",fn:(e,t)=>oA(s,t.modelMatrix)},{name:"modelViewNormalMatrix",type:"function",fn:(e,t)=>{const n=vA(o,t.viewMatrix,t.modelMatrix),i=_A(n,n),s=yA(i,i);return oA(a,s)}},{name:"modelViewMatrix",type:"function",fn:(e,t)=>vA(l,t.viewMatrix,t.modelMatrix)},{name:"environmentTransform",type:"function",global:!0,fn:(e,t)=>uA(h,Math.PI*(t.environmentOrientation||0)/180)}];n&&c.push(...n);super({name:"standard",vert:e.vert||"#include <gl2_vert>\n#define SHADER_NAME PBR\nattribute vec3 aPosition;\n#if defined(HAS_MAP) || defined(HAS_TERRAIN_FLAT_MASK)\nattribute vec2 aTexCoord;\n#include <common_pack_float>\n#endif\n#if defined(HAS_MAP)\nuniform vec2 uvOrigin;\nuniform vec2 uvScale;\nuniform vec2 uvOffset;\nuniform float uvRotation;\n#ifdef HAS_I3S_UVREGION\nattribute vec4 uvRegion;\nvarying vec4 vUvRegion;\n#endif\n#if defined(HAS_AO_MAP)\nattribute vec2 aTexCoord1;\nvarying vec2 vTexCoord1;\n#endif\n#endif\nvec3 c;\nvec3 d;\nvec4 e;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 projMatrix;\nuniform mediump vec3 cameraPosition;\nuniform mat3 modelNormalMatrix;\n#ifdef HAS_SSR\nuniform mat3 modelViewNormalMatrix;\nvarying vec3 vViewNormal;\n#ifdef HAS_TANGENT\nvarying vec4 vViewTangent;\n#endif\n#endif\nvarying vec3 vModelNormal;\nvarying vec4 vViewVertex;\n#if defined(HAS_TANGENT)\nvarying vec4 vModelTangent;\nvarying vec3 vModelBiTangent;\n#endif\nvarying vec3 vModelVertex;\n#if defined(HAS_MAP)\nvarying vec2 vTexCoord;\n#endif\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#ifdef HAS_OPACITY\nattribute float aOpacity;\n#endif\nvarying float vOpacity;\n#include <highlight_vert>\n#if defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nattribute vec3 aColor0;\nvarying vec3 vColor0;\n#else\nattribute vec4 aColor0;\nvarying vec4 vColor0;\n#endif\n#endif\n#include <line_extrusion_vert>\n#include <get_output>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#include <heatmap_render_vert>\n#include <vertex_color_vert>\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nvarying vec3 vTangentViewPos;\nvarying vec3 vTangentFragPos;\n#if __VERSION__ == 100\nmat3 f(in mat3 h) {\n  vec3 i = h[0];\n  vec3 j = h[1];\n  vec3 k = h[2];\n  return mat3(vec3(i.x, j.x, k.x), vec3(i.y, j.y, k.y), vec3(i.z, j.z, k.z));\n}\n#else\nmat3 f(in mat3 h) {\n  return transpose(h);\n}\n#endif\n#endif\nvoid l(const highp vec4 q, out highp vec3 m) {\n  m = vec3(.0, .0, 1.) + vec3(2., -2., -2.) * q.x * q.zwx + vec3(2., 2., -2.) * q.y * q.wzy;\n}\nvoid l(const highp vec4 q, out highp vec3 m, out highp vec3 t) {\n  l(q, m);\n  t = vec3(1., .0, .0) + vec3(-2., 2., -2.) * q.y * q.yxw + vec3(-2., 2., 2.) * q.z * q.zwx;\n}\nconst float o = .5;\nvec2 u(vec2 v, float A) {\n  return vec2(cos(A) * (v.x - o) + sin(A) * (v.y - o) + o, cos(A) * (v.y - o) - sin(A) * (v.x - o) + o);\n}\n#if defined(HAS_MAP)\nvec2 B(vec2 v) {\n  vec2 C = decode_getTexcoord(v);\n#ifdef HAS_RANDOM_TEX\nvec2 D = uvOrigin;\n  vec2 E = C * uvScale + uvOffset;\n  return mod(D, 1.) + E;\n#else\nvec2 D = uvOrigin;\n  vec2 E = C * uvScale;\n  if(uvRotation != .0) {\n    D = u(D, uvRotation);\n    E = u(E, uvRotation);\n  }\n  return mod(D, 1.) + E + uvOffset;\n#endif\n}\n#endif\n#ifdef PICKING_MODE\n#include <fbo_picking_vert>\n#endif\n#include <excavate_vert>\nvoid main() {\n  mat4 F = getPositionMatrix();\n#ifdef IS_LINE_EXTRUSION\nvec3 G = getLineExtrudePosition(aPosition);\n  vec4 H = getPosition(G);\n#else\nvec4 H = getPosition(aPosition);\n#endif\nvModelVertex = (modelMatrix * H).xyz;\n  vec4 I = F * H;\n  vec4 J = modelViewMatrix * I;\n  vViewVertex = J;\n#ifdef HAS_MASK_EXTENT\ngl_Position = projMatrix * getMaskPosition(I, modelMatrix);\n#else\ngl_Position = projMatrix * J;\n#endif\n#ifdef PICKING_MODE\nfloat K = 1.;\n#if defined(HAS_COLOR)\nK *= aColor.a;\n#endif\n#if defined(HAS_COLOR0) && COLOR0_SIZE == 4\nK *= aColor0.a;\n#endif\nfbo_picking_setData(gl_Position.w, K != .0);\n#else\n#if defined(HAS_MAP)\nvTexCoord = B(aTexCoord);\n#ifdef HAS_AO_MAP\nvTexCoord1 = B(aTexCoord1);\n#endif\n#ifdef HAS_I3S_UVREGION\nvUvRegion = uvRegion / 65535.;\n#endif\n#endif\n#if defined(HAS_TANGENT) || defined(HAS_NORMAL)\nmat3 L = mat3(F);\n  mat3 M = modelNormalMatrix * L;\n#if defined(HAS_TANGENT)\nvec3 t;\n  l(aTangent, d, t);\n  vModelTangent = vec4(M * t, aTangent.w);\n#else\nd = decode_getNormal(aNormal);\n#endif\nvec3 N = d;\n  vModelNormal = M * N;\n#else\nd = vec3(.0);\n  vModelNormal = vec3(.0);\n#endif\n#if defined(HAS_TANGENT)\nvModelBiTangent = cross(vModelNormal, vModelTangent.xyz) * sign(aTangent.w);\n#endif\n#ifdef HAS_SSR\nmat3 O = modelViewNormalMatrix * L;\n  vViewNormal = O * d;\n#if defined(HAS_TANGENT)\nvec4 P = vec4(t, aTangent.w);\n  vViewTangent = vec4(O * P.xyz, P.w);\n#endif\n#endif\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\nhighlight_setVarying();\n#if defined(HAS_COLOR0)\nvColor0 = aColor0 / 255.;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(I);\n#endif\n#ifdef HAS_HEATMAP\nheatmap_compute(projMatrix * modelViewMatrix * F, H);\n#endif\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nmat3 Q = f(mat3(vModelTangent.xyz, vModelBiTangent, vModelNormal));\n  vTangentViewPos = Q * cameraPosition;\n  vTangentFragPos = Q * vModelVertex;\n#endif\n#ifdef HAS_VERTEX_COLOR\nvertexColor_update();\n#endif\n#ifdef HAS_EXCAVATE_ANALYSIS\nvCoordinateTexcoord = getCoordinateTexcoord(I);\n  vExcavateHeight = getWorldHeight(I);\n#endif\n#endif\n}",frag:e.frag||"#define PI 3.141593\n#define RECIPROCAL_PI 1.0\n#if __VERSION__ == 100\n#if defined(GL_EXT_shader_texture_lod)\n#extension GL_EXT_shader_texture_lod : enable\n#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)\n#else\n#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)\n#endif\n#if defined(GL_OES_standard_derivatives)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#else\n#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)\n#endif\n#define saturate(x)        clamp(x, 0.0, 1.0)\nprecision mediump float;\n#include <gl2_frag>\n#include <hsv_frag>\n#include <srgb_frag>\nuniform vec3 hsv;\nuniform float contrast;\nstruct MaterialUniforms {\n  vec2 roughnessMetalness;\n  vec3 albedo;\n  float alpha;\n  vec3 normal;\n  vec3 emit;\n  float ao;\n  vec3 specularColor;\n  float glossiness;\n  vec4 skinColor;\n} c;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\nuniform vec3 cameraPosition;\nuniform float alphaTest;\n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nuniform vec4 diffuseFactor;\nuniform vec3 specularFactor;\nuniform float glossinessFactor;\n#if defined(HAS_DIFFUSE_MAP)\nuniform sampler2D diffuseTexture;\n#endif\n#if defined(HAS_SPECULARGLOSSINESS_MAP)\nuniform sampler2D specularGlossinessTexture;\n#endif\n#endif\nuniform vec3 emissiveFactor;\nuniform vec4 baseColorFactor;\nuniform float baseColorIntensity;\nuniform float emitColorFactor;\nuniform float occlusionFactor;\nuniform float environmentExposure;\nuniform float roughnessFactor;\nuniform float metallicFactor;\nuniform float normalMapFactor;\nuniform float specularF0;\nuniform int emitMultiplicative;\nuniform int normalMapFlipY;\nuniform int outputSRGB;\nuniform mat3 environmentTransform;\n#if defined(HAS_ALBEDO_MAP)\nuniform sampler2D baseColorTexture;\n#endif\n#if defined(HAS_METALLICROUGHNESS_MAP)\nuniform sampler2D metallicRoughnessTexture;\n#endif\n#if defined(HAS_EMISSIVE_MAP)\nuniform sampler2D emissiveTexture;\n#endif\n#if defined(HAS_AO_MAP)\nuniform sampler2D occlusionTexture;\nvarying vec2 vTexCoord1;\n#endif\n#if defined(HAS_NORMAL_MAP) && defined(HAS_TANGENT)\nuniform sampler2D normalTexture;\n#endif\n#if defined(HAS_SKIN_MAP)\nuniform sampler2D skinTexture;\n#endif\n#if defined(ALPHA_MODE) && ALPHA_MODE == 1\nuniform float alphaCutoff;\n#endif\n#ifdef HAS_RANDOM_TEX\nuniform highp vec2 uvOrigin;\nuniform sampler2D noiseTexture;\n#endif\nuniform sampler2D brdfLUT;\n#if defined(HAS_IBL_LIGHTING)\nuniform vec3 hdrHSV;\nuniform samplerCube prefilterMap;\nuniform vec3 diffuseSPH[9];\nuniform vec2 prefilterMiplevel;\nuniform vec2 prefilterSize;\n#else\nuniform vec3 ambientColor;\n#endif\nuniform vec2 cameraNearFar;\nuniform vec3 light0_viewDirection;\nuniform vec4 light0_diffuse;\n#ifdef HAS_SSR\nvarying vec3 vViewNormal;\n#if defined(HAS_TANGENT)\nvarying vec4 vViewTangent;\n#endif\n#endif\nvarying vec3 vModelVertex;\nvarying vec4 vViewVertex;\n#if defined(HAS_MAP)\n#include <compute_texcoord_frag>\n#endif\nvarying vec3 vModelNormal;\n#if defined(HAS_TANGENT)\nvarying vec4 vModelTangent;\nvarying vec3 vModelBiTangent;\n#endif\n#if defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nvarying vec3 vColor0;\n#else\nvarying vec4 vColor0;\n#endif\n#endif\n#if defined(HAS_COLOR)\nvarying vec4 vColor;\n#elif defined(IS_LINE_EXTRUSION)\nuniform vec4 lineColor;\n#else\nuniform vec4 polygonFill;\n#endif\n#ifdef HAS_LAYER_OPACITY\nuniform float layerOpacity;\n#endif\nvarying float vOpacity;\n#ifdef HAS_INSTANCE_COLOR\nvarying vec4 vInstanceColor;\n#endif\n#ifdef IS_LINE_EXTRUSION\nuniform float lineOpacity;\n#else\nuniform float polygonOpacity;\n#endif\n#ifdef HAS_PATTERN\nuniform sampler2D linePatternFile;\nuniform vec2 atlasSize;\nuniform float flipY;\nuniform float currentTime;\nuniform float animSpeedScale;\n#ifdef HAS_PATTERN_ANIM\nvarying float vLinePatternAnimSpeed;\n#else\nuniform float linePatternAnimSpeed;\n#endif\n#ifdef HAS_PATTERN_GAP\nvarying float vLinePatternGap;\n#else\nuniform float linePatternGap;\n#endif\nuniform vec4 linePatternGapColor;\nuniform vec2 uvScale;\nvarying float vPatternHeight;\nvarying float vLinesofar;\nvarying vec4 vTexInfo;\nvarying float vNormalY;\nvec2 d(vec2 e) {\n  vec2 f = mod(e, 1.);\n  vec2 h = vTexInfo.xy;\n  vec2 i = vTexInfo.zw;\n  return (h + f * i) / atlasSize;\n}\n#endif\n#include <heatmap_render_frag>\n#include <snow_frag>\n#include <mask_frag>\n#include <terrain_normal_frag>\n#include <vertex_color_frag>\n#include <excavate_frag>\n#ifdef HAS_RANDOM_TEX\nconst float j = .5;\nvec2 k(vec2 f, float l) {\n  return vec2(cos(l) * (f.x - j) + sin(l) * (f.y - j) + j, cos(l) * (f.y - j) - sin(l) * (f.x - j) + j);\n}\nfloat m(vec3 n) {\n  return n.x + n.y + n.z;\n}\n#endif\nvec4 o(sampler2D u, in vec2 f) {\n  \n#ifdef HAS_RANDOM_TEX\nhighp vec2 A = uvOrigin;\n  highp vec2 B = f + A - mod(A, 1.);\n  float C = texture2D(noiseTexture, .005 * B).x;\n  vec2 D = dFdx(B);\n  vec2 E = dFdx(B);\n  float F = C * 8.;\n  float G = fract(F);\n#if 1\nfloat H = floor(F);\n  float I = H + 1.;\n#else\nfloat H = floor(F + .5);\n  float I = floor(F);\n  G = min(G, 1. - G) * 2.;\n#endif\nvec2 J = sin(vec2(3., 7.) * H);\n  vec2 K = sin(vec2(3., 7.) * I);\n  float L = .5;\n  vec4 M = texture2DGradEXT(u, f + L * J, D, E);\n  vec4 N = texture2DGradEXT(u, f + L * K, D, E);\n  return mix(M, N, smoothstep(.2, .8, G - .1 * m(M.xyz - N.xyz)));\n#else\nreturn texture2D(u, f);\n#endif\n}\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nuniform sampler2D bumpTexture;\nuniform float bumpScale;\nuniform float bumpMaxLayers;\nuniform float bumpMinLayers;\nvec2 O(vec2 f, vec3 P) {\n  float Q = mix(bumpMaxLayers, bumpMinLayers, abs(dot(vec3(.0, .0, 1.), P)));\n  float R = 1. / Q;\n  float S = .0;\n  vec2 T = P.xy * bumpScale / (P.z * Q);\n  vec2 U = f;\n  float V = o(bumpTexture, U).r;\n  for(int W = 0; W < 30; W++) {\n    S += R;\n    U -= T;\n    V = o(bumpTexture, U).r;\n    if(V < S) {\n      break;\n    }\n  }\n  vec2 X = U + T;\n  float Y = V - S;\n  float Z = o(bumpTexture, X).r - S + R;\n  return mix(U, X, Y / (Y - Z));\n}\nvarying vec3 vTangentViewPos;\nvarying vec3 vTangentFragPos;\n#endif\n#define SHADER_NAME PBR\nvec3 ba() {\n  return c.albedo;\n}\nfloat bb() {\n  return c.alpha;\n}\nfloat bc() {\n  return c.roughnessMetalness.y;\n}\nfloat bd() {\n  \n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nreturn 1. - c.glossiness;\n#else\nreturn c.roughnessMetalness.x;\n#endif\n}\nvec3 be() {\n  return c.emit;\n}\nvec4 bf() {\n  return c.skinColor;\n}\nvec3 bg() {\n  return c.normal;\n}\nfloat bh() {\n  return c.ao;\n}\nfloat bi(const in vec4 bj) {\n  return bj.r + bj.g / 255.;\n}\nvec3 bk(const in float bl, in vec3 bm, const in vec3 t, const in vec3 b, in vec3 bn) {\n  bm.xy = bl * bm.xy;\n  mat3 bo = mat3(t, b, bn);\n  return normalize(bo * bm);\n}\nfloat bp(const float bq, const vec3 bm, const vec3 br) {\n  float bs = clamp(dot(bm, br), 0., 1.);\n  float a = bq * bq;\n  float bt = a * a;\n  float bu = (bs * bt - bs) * bs + 1.;\n  return bt / (PI * bu * bu);\n}\nvec3 bv(const vec3 bw, const float bx, const in vec3 by, const in vec3 br) {\n  float bz = clamp(dot(by, br), 0., 1.);\n  bz = pow(1. - bz, 5.);\n  return bx * bz + (1. - bz) * bw;\n}\nfloat bA(const in vec3 bm, const in vec3 bB, const in float bq, const float bC) {\n  float bD = clamp(dot(bm, bB), 0., 1.);\n  float a = bq * bq;\n  float bE = bD * (bC * (1. - a) + a);\n  float bF = bC * (bD * (1. - a) + a);\n  return .5 / (bF + bE);\n}\nvec3 bG(const float bq, const vec3 bm, const vec3 bB, const vec3 by, const vec3 bH, const float bC, const float bx) {\n  vec3 br = normalize(bB + by);\n  float bI = bp(bq, bm, br);\n  float bJ = bA(bm, bB, bq, bC);\n  vec3 bK = bv(bH, bx, by, br);\n  return (bI * bJ * PI) * bK;\n}\nvec3 bL(const in vec3 bM) {\n  return RECIPROCAL_PI * bM;\n}\nvoid bN(const in vec3 bm, const in vec3 bB, const in float bC, const in float bq, const in vec3 bO, const in vec3 bH, const in vec3 bP, const in vec3 by, const in float bx, out vec3 bQ, out vec3 bR) {\n  if(bC <= .0) {\n    bR = bQ = vec3(.0);\n    return;\n  }\n  vec3 a = bC * bP;\n  vec3 bS = bG(bq, bm, bB, by, bH, bC, bx);\n  bR = a * bS;\n  bQ = a * bL(bO);\n}\n#if defined(HAS_IBL_LIGHTING)\nvec3 bT(const in vec3 bm) {\n  vec3 bn = environmentTransform * bm;\n  float x = bn.x;\n  float y = bn.y;\n  float z = bn.z;\n  vec3 bU = (diffuseSPH[0] + diffuseSPH[1] * x + diffuseSPH[2] * y + diffuseSPH[3] * z + diffuseSPH[4] * z * x + diffuseSPH[5] * y * z + diffuseSPH[6] * y * x + diffuseSPH[7] * (3. * z * z - 1.) + diffuseSPH[8] * (x * x - y * y));\n  if(length(hdrHSV) > .0) {\n    bU = hsv_apply(bU, hdrHSV);\n  }\n  return max(bU, vec3(.0));\n}\nvec3 bV(const in float bq, const in vec3 bW) {\n  vec3 bX = bW;\n  float bY = prefilterMiplevel.x;\n  float bZ = min(bY, bq * prefilterMiplevel.y);\n  vec3 ca = textureCubeLod(prefilterMap, bX, bZ).rgb;\n  if(length(hdrHSV) > .0) {\n    return hsv_apply(ca, hdrHSV);\n  } else {\n    return ca;\n  }\n}\nvec3 cb(const in vec3 cc, const in vec3 bB, const in float bq, const in vec3 cd, const in vec3 bO) {\n  float ce = 1. - bq;\n  vec3 bW = mix(cc, reflect(-bB, cc), ce * (sqrt(ce) + bq));\n  float bl = clamp(1. + dot(bW, cd), .0, 1.);\n  vec3 cf = bV(bq, environmentTransform * bW) * bl * bl;\n  return cf;\n}\n#else\nvec3 cb(const in vec3 bm, const in vec3 cg, const in float bq, const in vec3 cd, const in vec3 bO) {\n  return ambientColor * bL(bO);\n}\n#endif\nvec3 ch(const in vec3 ci, const in float bq, const in float bD, const in float bx) {\n  vec4 rgba = texture2D(brdfLUT, vec2(bD, bq)) * vec4(255., 65280.0, 255., 65280.0);\n  float b = (rgba[3] + rgba[2]);\n  float a = (rgba[1] + rgba[0]);\n  return (ci * a + b * bx) / 65535.;\n}\nvec3 cj(const in vec3 bm, const in vec3 cg, const in float bD, const in float bq, const in vec3 bH, const in vec3 cd, const in float bx, const in vec3 bO) {\n  return cb(bm, cg, bq, cd, bO) * ch(bH, bq, bD, bx);\n}\nfloat ck(const in float cl, const in float bD) {\n  float bu = bD + cl;\n  return clamp(bu * bu - 1. + cl, .0, 1.);\n}\nvoid cm() {\n  \n#ifdef HAS_MAP\nvec2 f = computeTexCoord(vTexCoord);\n#endif\n#ifdef HAS_UV_FLIP\nf.y = 1. - f.y;\n#endif\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nf = O(f, normalize(vTangentViewPos - vTangentFragPos));\n#endif\nc.albedo = baseColorIntensity * baseColorFactor.rgb;\n  c.alpha = baseColorFactor.a * vOpacity;\n#if defined(HAS_PATTERN)\nfloat cn = vLinesofar;\n  vec2 i = vTexInfo.zw;\n#ifdef HAS_PATTERN_GAP\nfloat co = vLinePatternGap;\n#else\nfloat co = linePatternGap;\n#endif\n#ifdef HAS_PATTERN_ANIM\nfloat cp = vLinePatternAnimSpeed;\n#else\nfloat cp = linePatternAnimSpeed;\n#endif\nfloat cq = ceil(i.x * vPatternHeight / i.y);\n  float cr = cq * (1. + co);\n  cp /= animSpeedScale;\n  cn += mod(currentTime * -cp * .2, cr);\n  float cs = mod(cn / cr, 1.);\n  float ct = mod(flipY * vNormalY, 1.);\n  vec2 f = d(vec2(cs * (1. + co) * uvScale[0], ct * uvScale[1]));\n  vec4 cu = texture2D(linePatternFile, f);\n  float cv = clamp(sign(1. / (1. + co) - cs) + .000001, .0, 1.);\n  cu = mix(linePatternGapColor, cu, cv);\n#ifdef IS_SQUARE_TUBE\nfloat n = clamp(sign(abs(vNormalY) - .999999), .0, 1.);\n  cu = mix(cu, vec4(1.), n);\n#endif\nc.albedo *= cu.rgb;\n  c.alpha *= cu.a;\n#endif\n#if defined(HAS_ALBEDO_MAP)\nvec4 cw = o(baseColorTexture, f);\n  c.albedo *= sRGBToLinear(cw.rgb);\n  c.alpha *= cw.a;\n#endif\n#if defined(HAS_SKIN_MAP)\nvec4 cx = o(skinTexture, f);\n  c.skinColor = cx;\n#endif\n#if defined(HAS_COLOR0)\nc.albedo *= vColor0.rgb;\n#if COLOR0_SIZE == 4\nc.alpha *= vColor0.a;\n#endif\n#endif\n#if defined(HAS_COLOR)\nc.albedo *= vColor.rgb;\n  c.alpha *= vColor.a;\n#elif defined(IS_LINE_EXTRUSION)\nc.albedo *= lineColor.rgb;\n  c.alpha *= lineColor.a;\n#else\nc.albedo *= polygonFill.rgb;\n  c.alpha *= polygonFill.a;\n#endif\n#if defined(HAS_INSTANCE_COLOR)\nc.albedo *= vInstanceColor.rgb;\n  c.alpha *= vInstanceColor.a;\n#endif\n#if defined(HAS_METALLICROUGHNESS_MAP)\nc.roughnessMetalness = o(metallicRoughnessTexture, f).gb * vec2(roughnessFactor, metallicFactor);\n#else\nc.roughnessMetalness = vec2(roughnessFactor, metallicFactor);\n#endif\nc.emit = emissiveFactor;\n#if defined(HAS_EMISSIVE_MAP)\nif(emitMultiplicative == 1) {\n    c.emit *= sRGBToLinear(o(emissiveTexture, f).rgb);\n  } else {\n    c.emit += sRGBToLinear(o(emissiveTexture, f).rgb);\n  }\n#endif\nc.emit *= emitColorFactor;\n#if defined(HAS_AO_MAP)\nvec2 cy = computeTexCoord(vTexCoord1);\n  c.ao = o(occlusionTexture, cy).r;\n#else\nc.ao = 1.;\n#endif\nc.ao *= occlusionFactor;\n#if defined(HAS_NORMAL_MAP) && defined(HAS_TANGENT)\nvec3 cz = o(normalTexture, f).xyz * 2. - 1.;\n  cz.y = normalMapFlipY == 1 ? -cz.y : cz.y;\n  c.normal = cz;\n#else\nc.normal = normalize(vModelNormal);\n#endif\n#if defined(HAS_TERRAIN_NORMAL) && defined(HAS_TANGENT)\nvec3 cz = convertTerrainHeightToNormalMap(f);\n  cz.y = normalMapFlipY == 1 ? -cz.y : cz.y;\n  c.normal = cz;\n#endif\n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nc.albedo *= diffuseFactor.rgb;\n  c.alpha *= diffuseFactor.a;\n#if defined(HAS_DIFFUSE_MAP)\nvec4 cA = o(diffuseTexture, f);\n  c.albedo *= sRGBToLinear(cA.rgb);\n  c.alpha *= cA.a;\n#endif\nc.specularColor = specularFactor;\n  c.glossiness = glossinessFactor;\n#if defined(HAS_SPECULARGLOSSINESS_MAP)\nvec4 cB = o(specularGlossinessTexture, f);\n  c.specularColor *= sRGBToLinear(cB.rgb);\n  c.glossiness *= cB.a;\n#endif\n#endif\n}\nvec3 cC(const vec3 x) {\n  const float a = 2.51;\n  const float b = .03;\n  const float cD = 2.43;\n  const float bu = .59;\n  const float cE = .14;\n  return (x * (a * x + b)) / (x * (cD * x + bu) + cE);\n}\nvec3 cF(vec3 cG) {\n  cG = cC(cG);\n  return cG = pow(cG, vec3(1. / 2.2));\n}\nuniform float specularAAVariance;\nuniform float specularAAThreshold;\nfloat cH(float bq, const vec3 cI) {\n  \n#if defined(GL_OES_standard_derivatives) || __VERSION__ == 300\nvec3 cJ = dFdx(cI);\n  vec3 cK = dFdy(cI);\n  float cL = specularAAVariance * (dot(cJ, cJ) + dot(cK, cK));\n  float cM = min(2. * cL, specularAAThreshold);\n  float cN = saturate(bq * bq + cM);\n  return sqrt(cN);\n#else\nreturn bq;\n#endif\n}\n#ifdef HAS_SSR\nuniform sampler2D TextureDepth;\nuniform highp vec2 outSize;\nuniform float ssrFactor;\nuniform float ssrQuality;\nuniform sampler2D TextureReflected;\nuniform highp mat4 projMatrix;\nuniform mat4 invProjMatrix;\nuniform vec4 outputFovInfo[2];\nuniform mat4 reprojViewProjMatrix;\nvec3 cO(const in mat4 cP, const in vec3 cQ) {\n  vec4 cR = cP * vec4(cQ, 1.);\n  return vec3(.5 + .5 * cR.xy / cR.w, cR.w);\n}\nvec3 cS(const in float cT, const in vec2 f) {\n  return texture2D(TextureReflected, f).rgb;\n}\nfloat cU(float cV) {\n  highp mat4 cP = projMatrix;\n  highp float z = cV * 2. - 1.;\n  return -cP[3].z / (z + cP[2].z);\n}\nfloat cW(const vec2 f) {\n  float cV = bi(texture2D(TextureDepth, f));\n  return cV;\n}\nfloat cX(const in vec2 cY, const in float cZ) {\n  vec3 da = vec3(.06711056, .00583715, 52.9829189);\n  return fract(da.z * fract(dot(cY.xy + cZ * vec2(47., 17.) * .695, da.xy))) * .5;\n}\nvec3 db(const in float cZ, const in vec3 dc, const in vec3 dd, const in vec3 de, const in vec3 cg, const in float df) {\n  vec2 dg;\n  dg.x = cX(gl_FragCoord.yx, cZ);\n  dg.y = fract(dg.x * 52.9829189);\n  dg.y = mix(dg.y, 1., .7);\n  float dh = 2. * 3.14159 * dg.x;\n  float di = pow(max(dg.y, .000001), df / (2. - df));\n  float dj = sqrt(1. - di * di);\n  vec3 dk = vec3(dj * cos(dh), dj * sin(dh), di);\n  dk = dk.x * dc + dk.y * dd + dk.z * de;\n  return normalize((2. * dot(cg, dk)) * dk - cg);\n}\nfloat dl(const in float cZ) {\n  return (cX(gl_FragCoord.xy, cZ) - .5);\n}\nvec3 dm(const in vec3 dn, const in float dp, const in vec3 dq) {\n  vec3 dr = cO(projMatrix, vViewVertex.xyz + dq * dp);\n  dr.z = 1. / dr.z;\n  dr -= dn;\n  float ds = min(1., .99 * (1. - dn.x) / max(1e-5, dr.x));\n  float dt = min(1., .99 * (1. - dn.y) / max(1e-5, dr.y));\n  float dw = min(1., .99 * dn.x / max(1e-5, -dr.x));\n  float dx = min(1., .99 * dn.y / max(1e-5, -dr.y));\n  return dr * min(ds, dt) * min(dw, dx);\n}\nfloat dy(const in vec3 dn, const in vec3 dr, inout float dz, inout float dA) {\n  float dB = (dA + dz) * .5;\n  vec3 dC = dn + dr * dB;\n  float z = cW(dC.xy);\n  float cV = cU(z);\n  float dD = -1. / dC.z;\n  dz = cV > dD ? dz : dB;\n  dA = cV > dD ? dB : dA;\n  return dB;\n}\nvec4 dE(const in vec3 dn, const in float dp, in float dF, const in vec3 dq, const in float bq, const in float cZ) {\n  int dG = 20;\n  float dH = 1. / float(dG);\n  dF *= dH;\n  vec3 dr = dm(dn, dp, dq);\n  float dI = dH;\n  vec3 dJ = vec3(.0, dI, 1.);\n  vec3 dC;\n  float z, cV, dD, dK, dL, dM;\n  bool dN;\n  float dO = 1.;\n  float dB;\n  for(int W = 0; W < dG; W++) {\n    dC = dn + dr * dJ.y;\n    z = cW(dC.xy);\n    cV = cU(z);\n    dD = -1. / dC.z;\n    float dP = clamp(sign(.999 - z), .0, 1.);\n    dK = dP * (dD - cV);\n    dK *= clamp(sign(abs(dK) - dp * dH * dH), .0, 1.);\n    dN = abs(dK + dF) < dF;\n    dL = clamp(dJ.x / (dJ.x - dK), .0, 1.);\n    dM = dN ? dJ.y + dL * dH - dH : 1.;\n    dJ.z = min(dJ.z, dM);\n    dJ.x = dK;\n    if(dN) {\n      float dz = dJ.y - dH;\n      float dA = dJ.y;\n      dB = dy(dn, dr, dz, dA);\n      dB = dy(dn, dr, dz, dA);\n      dB = dy(dn, dr, dz, dA);\n      dO = dB;\n      break;\n    }\n    dJ.y += dH;\n  }\n  return vec4(dn + dr * dO, 1. - dO);\n}\nvec4 dQ(in vec4 dR, const in float dS, const in vec3 dT, const in vec3 dU, const in float bq) {\n  vec4 dV = mix(outputFovInfo[0], outputFovInfo[1], dR.x);\n  dR.xyz = vec3(mix(dV.xy, dV.zw, dR.y), 1.) * -1. / dR.z;\n  dR.xyz = (reprojViewProjMatrix * vec4(dR.xyz, 1.)).xyw;\n  dR.xy /= dR.z;\n  float dW = clamp(6. - 6. * max(abs(dR.x), abs(dR.y)), .0, 1.);\n  dR.xy = .5 + .5 * dR.xy;\n  vec3 dX = dU * cS(bq * (1. - dR.w), dR.xy);\n  return vec4(mix(dT, dX, dS * dW), 1.);\n}\nvec3 ssr(const in vec3 dT, const in vec3 dU, const in float bq, const in vec3 bm, const in vec3 cg) {\n  float dY = .0;\n  vec4 bU = vec4(.0);\n  float df = bq * bq;\n  df = df * df;\n  vec3 dZ = abs(bm.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 dc = normalize(cross(dZ, bm));\n  vec3 dd = cross(bm, dc);\n  float dS = ssrFactor * clamp(-4. * dot(cg, bm) + 3.8, .0, 1.);\n  dS *= clamp(4.7 - bq * 5., .0, 1.);\n  vec3 dn = cO(projMatrix, vViewVertex.xyz);\n  dn.z = 1. / dn.z;\n  vec3 dq = db(dY, dc, dd, bm, cg, df);\n  float dp = mix(cameraNearFar.y + vViewVertex.z, -vViewVertex.z - cameraNearFar.x, dq.z * .5 + .5);\n  float dF = .5 * dp;\n  vec4 dR;\n  if(dot(dq, bm) > .001 && dS > .0) {\n    dR = dE(dn, dp, dF, dq, bq, dY);\n    if(dR.w > .0)\n      bU += dQ(dR, dS, dT, dU, bq);\n    \n  }\n  return bU.w > .0 ? bU.rgb / bU.w : dT;\n}\n#endif\n#include <highlight_frag>\nvec4 ea(in vec4 eb) {\n  return vec4(mix(pow(eb.rgb, vec3(.41666)) * 1.055 - vec3(.055), eb.rgb * 12.92, vec3(lessThanEqual(eb.rgb, vec3(.0031308)))), eb.a);\n}\nvec4 ec(vec4 eb) {\n  return (ea(eb));\n}\nvoid main() {\n  cm();\n  vec3 cg = normalize(cameraPosition - vModelVertex.xyz);\n#if defined(HAS_DOUBLE_SIDE)\nvec3 cd = gl_FrontFacing ? normalize(vModelNormal) : -normalize(vModelNormal);\n#else\nvec3 cd = normalize(vModelNormal);\n#endif\n#if defined(HAS_TANGENT)\nvec4 ed;\n  ed = vModelTangent;\n#if defined(HAS_DOUBLE_SIDE)\ned.xyz = gl_FrontFacing ? normalize(ed.xyz) : -normalize(ed.xyz);\n#else\ned.xyz = normalize(ed.xyz);\n#endif\nvec3 ee = normalize(vModelBiTangent);\n#endif\nfloat bw = .08 * specularF0;\n  float ef = bc();\n  vec3 bO = ba();\n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nvec3 eg = c.specularColor;\n#else\nvec3 eg = mix(vec3(bw), bO, ef);\n#endif\nbO *= 1. - ef;\n  float eh = clamp(50.0 * eg.g, .0, 1.);\n  float ei = bd();\n  if(specularAAVariance > .0) {\n    ei = cH(ei, cd);\n  }\n  vec3 ej = be();\n  vec3 ek = bg();\n  vec3 el = vec3(ek);\n#if defined(HAS_TANGENT) && (defined(HAS_NORMAL_MAP) || defined(HAS_TERRAIN_NORMAL))\nel = bk(normalMapFactor, el, ed.xyz, ee, cd);\n#endif\nvec3 cA = vec3(.0);\n  vec3 bH = vec3(.0);\n#if defined(HAS_IBL_LIGHTING)\ncA = bO * bT(el) * .5;\n#else\ncA = bO * ambientColor;\n#endif\nfloat bD = dot(el, cg);\n  bH = cj(el, cg, bD, ei, eg, cd, eh, bO);\n  float em;\n  float en = 1.;\n  float eo = bh();\n  cA *= environmentExposure * eo;\n#ifdef HAS_IBL_LIGHTING\nen = ck(eo, bD);\n#endif\n#ifdef HAS_SSR\nvec3 ep = normalize(gl_FrontFacing ? vViewNormal : -vViewNormal);\n  vec3 eq = ep;\n#if defined(HAS_TANGENT) && (defined(HAS_NORMAL_MAP) || defined(HAS_TERRAIN_NORMAL))\nvec4 er;\n  er = vViewTangent;\n  er = gl_FrontFacing ? er : -er;\n  er.xyz = normalize(er.xyz);\n  vec3 es = normalize(cross(ep, er.xyz)) * er.w;\n  eq = bk(normalMapFactor, ek, er.xyz, es, ep);\n#endif\nbH = ssr(bH, eg * en, ei, eq, -normalize(vViewVertex.xyz));\n#endif\nbH *= environmentExposure * en;\n  vec3 et, eu;\n  vec3 ev = vModelNormal;\n  vec3 ew = -light0_viewDirection;\n  float ex = saturate(dot(ew, el));\n  bN(el, cg, ex, max(.045, ei), bO, eg, light0_diffuse.rgb, ew, eh, eu, et);\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat ey = shadow_computeShadow();\n  eu = shadow_blend(eu, ey).rgb;\n  et = shadow_blend(et, ey).rgb;\n#endif\ncA += eu;\n  bH += et;\n  cA += ej;\n  vec3 ez = bH + cA;\n  if(outputSRGB == 1)\n    ez = linearTosRGB(ez);\n  \n#ifdef HAS_SKIN_MAP\nvec4 eA = bf();\n  ez.rgb = ez.rgb * (1. - eA.a) + eA.rgb * eA.a;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nez.rgb = shadow_blend(ez.rgb, ey).rgb;\n#endif\n#endif\nfloat eB = bb();\n  if(eB < alphaTest) {\n    discard;\n  }\n#if defined(ALPHA_MODE)\n#if ALPHA_MODE == 1\nif(eB < alphaCutoff) {\n    discard;\n  } else {\n    eB = 1.;\n  }\n#else\neB = 1.;\n#endif\n#endif\n#if defined(IS_LINE_EXTRUSION)\neB *= lineOpacity;\n#else\neB *= polygonOpacity;\n#endif\nglFragColor = vec4(ez * eB, eB);\n#ifdef HAS_VERTEX_COLOR\nglFragColor *= vertexColor_get();\n#endif\n#ifdef HAS_EXCAVATE_ANALYSIS\nglFragColor = excavateColor(glFragColor);\n#endif\n#ifdef HAS_HEATMAP\nglFragColor = heatmap_getColor(glFragColor);\n#endif\n#ifdef HAS_SNOW\nglFragColor.rgb = snow(glFragColor, bg(), 1.);\n#endif\nif(contrast != 1.) {\n    glFragColor = contrastMatrix(contrast) * glFragColor;\n  }\n  if(length(hsv) > .0) {\n    glFragColor = hsv_apply(glFragColor, hsv);\n  }\n#ifdef OUTPUT_NORMAL\nglFragColor = vec4(cd, 1.);\n#endif\nglFragColor = highlight_blendColor(glFragColor);\n#ifdef HAS_LAYER_OPACITY\nglFragColor *= layerOpacity;\n#endif\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",wgslVert:e.wgslVert||"",wgslFrag:e.wgslFrag||"",uniforms:c,extraCommandProps:t,defines:i}),this.version=300}getGeometryDefines(e){const t={};return e.data[e.desc.tangentAttribute]?t.HAS_TANGENT=1:e.data[e.desc.normalAttribute]&&(t.HAS_NORMAL=1),e.data[e.desc.colorAttribute]&&(t.HAS_COLOR=1),e.data[e.desc.color0Attribute]&&(t.HAS_COLOR0=1,t.COLOR0_SIZE=e.getColor0Size()),t}},StandardDepthShader:class StandardDepthShader extends MeshShader{constructor(e={}){const t=[];super({vert:"#define SHADER_NAME depth_vert\nattribute vec3 aPosition;\n#include <line_extrusion_vert>\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 projMatrix;\nuniform vec2 outSize;\nuniform vec2 halton;\n#include <get_output>\nvoid main() {\n  mat4 c = getPositionMatrix();\n#ifdef IS_LINE_EXTRUSION\nvec4 d = getPosition(getLineExtrudePosition(aPosition));\n#else\nvec4 d = getPosition(aPosition);\n#endif\nvec4 e = modelViewMatrix * c * d;\n  mat4 f = projMatrix;\n  f[2].xy += halton.xy / outSize.xy;\n  gl_Position = f * e;\n}",frag:"#define SHADER_NAME depth_frag\nprecision highp float;\nvoid main() {\n  gl_FragColor = vec4(1., .0, .0, 1.);\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:(e,n)=>vA(t,n.viewMatrix,n.modelMatrix)}],extraCommandProps:e.extraCommandProps,defines:e.defines})}},PBRUtils:KS},MM=Wx;MM.flatten=Ab;var CM=Object.freeze({__proto__:null,AbstractTexture,BloomPass,BoundingBox,BoxBlurShader:class BoxBlurShader extends QuadShader{constructor({blurOffset:e}){super({vert:RT,frag:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D textureSource;\nuniform vec2 resolution;\nuniform float ignoreTransparent;\nvoid main() {\n  vec4 c = vec4(.0);\n  float d = .0;\n  for(int x = -BOXBLUR_OFFSET; x <= BOXBLUR_OFFSET; ++x)\n    for(int y = -BOXBLUR_OFFSET; y <= BOXBLUR_OFFSET; ++y) {\n      vec2 e = vTexCoord.st + vec2(float(x) / resolution.x, float(y) / resolution.y);\n      e = clamp(e, .0, 1.);\n      vec4 f = texture2D(textureSource, e);\n      float h;\n      if(ignoreTransparent == 1.) {\n        h = sign(f.a);\n      } else {\n        h = 1.;\n      }\n      d += h;\n      c += h * f;\n    }\n  gl_FragColor = c / max(d, 1.) * clamp(sign(d - 1.), .0, 1.);\n}",defines:{BOXBLUR_OFFSET:e||2},extraCommandProps:{viewport:{x:0,y:0,width:(e,t)=>t.resolution[0],height:(e,t)=>t.resolution[1]}}}),this._blurOffset=e||2}getMeshCommand(e,t){const n="box_blur_"+this._blurOffset;return this.commands[n]||(this.commands[n]=this.createMeshCommand(e,t)),this.commands[n]}},Constants:zx,CopyShader,EdgeGeometry,EdgeShader:class EdgeShader extends MeshShader{constructor(e={}){const t=[],n=e.uniforms,i=[{name:"modelViewMatrix",type:"function",fn:function(e,n){return vA(t,n.viewMatrix,n.modelMatrix)}}];n&&i.push(...n),super({vert:"attribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 modelViewMatrix;\n#include <get_output>\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  gl_Position = projMatrix * modelViewMatrix * d * c;\n}",frag:"precision mediump float;\nuniform vec4 lineColor;\nuniform float lineOpacity;\nvoid main() {\n  gl_FragColor = lineColor;\n  gl_FragColor.a *= lineOpacity;\n}",uniforms:i,defines:e.defines||{},extraCommandProps:e.extraCommandProps||{}})}},ExtentPass,FBORayPicking:class FBORayPicking{constructor(e,{name:t,vert:n,wgslVert:i,uniforms:s,defines:o,extraCommandProps:a,enableStencil:l},h,c){this._renderer=e,this._fbo=h,this._map=c,this._clearFbo(h),this._name=t||"fboraypicking",this._vert=n,this._wgslVert=i,this._uniforms=s,this._defines=o,this._extraCommandProps=px({},a),delete this._extraCommandProps.blend,l?this._extraCommandProps.stencil={enable:l,mask:255,func:{cmp:"<",ref:1,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}}:delete this._extraCommandProps.stencil,this._currentMeshes=[],this._init()}_init(){const e=[];this._uniforms&&e.push(...this._uniforms);const t={ENABLE_PICKING:1,HAS_PICKING_ID:1};if(this._defines)for(const e in this._defines)t[e]=this._defines[e];const n=this._vert,i=this._wgslVert,s=this._extraCommandProps;this._shader0=new MeshShader({name:this._name+"-0",vert:n,frag:cM,wgslVert:i,wgslFrag:uM,uniforms:e,defines:t,extraCommandProps:s}),this._shader2=new MeshShader({name:this._name+"-2",vert:n,frag:pM,wgslVert:i,wgslFrag:gM,uniforms:e,defines:t,extraCommandProps:s});const o={ENABLE_PICKING:1,HAS_PICKING_ID:1};if(this._defines)for(const e in this._defines)o[e]=this._defines[e];this._shader1=new MeshShader({name:this._name+"-1",vert:n,frag:fM,wgslVert:i,wgslFrag:dM,uniforms:e,defines:o,extraCommandProps:s}),this._depthShader=new MeshShader({name:this._name+"-depth",vert:n,frag:"\n    #ifdef GL_ES\n        precision highp float;\n    #endif\n    #if __VERSION__ == 100 && defined(GL_EXT_frag_depth)\n        #extension GL_EXT_frag_depth : enable\n    #endif\n    #include <gl2_frag>\n    #include <common_pack_float>\n    varying float vFbo_picking_viewZ;\n    uniform float logDepthBufFC;\n    varying float vFbo_picking_fragDepth;\n\n    const float PackUpscale = 256. / 255.;\n    const float UnpackDownscale = 255. / 256.;\n    const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\n    const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\n    const float ShiftRight8 = 1. / 256.;\n    vec4 packDepthToRGBA(const in float v ) {\n        vec4 r = vec4(fract(v * PackFactors), v);\n        r.yzw -= r.xyz * ShiftRight8;\n        return r * PackUpscale;\n    }\n\n    void main() {\n        float fragDepth = vFbo_picking_fragDepth > 1.0 ? vFbo_picking_fragDepth : vFbo_picking_viewZ + 1.0;\n        #if __VERSION__ == 300 || __VERSION__ == 100 && defined(GL_EXT_frag_depth)\n            gl_FragDepthEXT = log2(fragDepth) * logDepthBufFC * 0.5;\n        #endif\n        vec4 depthColor = packDepthToRGBA(fragDepth - 1.0);\n        glFragColor = common_unpackFloat(dot(depthColor, UnpackFactors));\n        #if __VERSION__ == 100\n            gl_FragColor = glFragColor;\n        #endif\n    }\n",wgslVert:i,wgslFrag:"\n    #include <common_pack_float>\n\n    struct DepthPackingUniforms {\n        logDepthBufFC: f32,\n    };\n\n    @group(0) @binding($b) var<uniform> depthPackingUniforms: DepthPackingUniforms;\n\n    struct VertexOutput {\n        @location($i) vFbo_picking_viewZ: f32,\n        @location($i) vFbo_picking_fragDepth: f32,\n    };\n\n    const PackUpscale = 256.0 / 255.0;\n    const UnpackDownscale = 255.0 / 256.0;\n    const PackFactors = vec3f(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0);\n    const UnpackFactors = UnpackDownscale / vec4f(PackFactors, 1.0);\n    const ShiftRight8 = 1.0 / 256.0;\n\n    fn packDepthToRGBA(v: f32) -> vec4f {\n        var r = vec4f(fract(v * PackFactors), v);\n        // r.yzw -= r.xyz * ShiftRight8;\n        r = vec4f(r.x, r.yzw - r.xyz * ShiftRight8);\n        return r * PackUpscale;\n    }\n\n    @fragment\n    fn main(vertexOutput: VertexOutput) -> @location(0) vec4f {\n        let fragDepth = select(\n            vertexOutput.vFbo_picking_viewZ + 1.0,\n            vertexOutput.vFbo_picking_fragDepth,\n            vertexOutput.vFbo_picking_fragDepth > 1.0\n        );\n\n        let depthColor = packDepthToRGBA(fragDepth - 1.0);\n        var glFragColor = common_unpackFloat(dot(depthColor, UnpackFactors));\n\n        return glFragColor;\n    }\n",uniforms:e,defines:o,extraCommandProps:s}),this._scene=new Scene,this._scene1=new Scene}filter(){return!0}render(e,t,n=!1){if(!e||!e.length)return this;const i=this._fbo;n&&this.clear(),e=e.filter((e=>e&&e.isValid&&e.isValid())),this._scene.setMeshes(e);const s=this._getShader(e,n);s.filter=this.filter,this._currentShader&&s!==this._currentShader&&this.clear(),this._currentShader=s,e.forEach(((e,t)=>{e.setUniform("fbo_picking_meshId",t+this._currentMeshes.length)}));for(let t=0;t<e.length;t++)this._currentMeshes.push(e[t]);return this._renderer.render(s,t,this._scene,i),this}pickAll(e,t,n,i,s){n=AM(n);const{meshIds:o,pickingIds:a,coords:l,points:h}=this._pick(e,t,n,i,s),c=[];if(a&&o){const e={};for(let t=0;t<o.length;t++){const n=`${a[t]}_${o[t]}`;null==o[t]||null==a[t]||e[n]||(e[n]=!0,c.push({meshId:o[t],pickingId:a[t],point:h[t]||null,coordinate:l[t]||null}))}}return c}pick(e,t,n,i,s={}){n=AM(n);const{meshIds:o,pickingIds:a,width:l,coords:h,points:c}=this._pick(e,t,n,i,s);if(a&&o){const e=[];for(let t=0;t<=n[0];t++)e.push(t),t>0&&e.push(-t);for(let t=0;t<e.length;t++)for(let i=0;i<e.length;i++){const s=(e[i]+n[1])*l+(e[t]+n[0]);if(null!=o[s])return{meshId:o[s],pickingId:a[s],point:c[s]||null,coordinate:h[s]||null}}}return{pickingId:null,meshId:null,point:null}}_pick(e,t,n,i,s={}){const o=this._currentShader,a=this._currentMeshes;if(!o||!a||!a.length)return{pickingId:null,meshId:null,point:null};e=Math.round(e),t=Math.round(t);const l=this._fbo;if(e<=2||e>=l.width-2||t<=2||t>=l.height-2)return{pickingId:null,meshId:null,point:null};const{px:h,py:c,width:u,height:f}=this._getParams(e,t,n,l),g=new Uint8Array(4*u*f),m=this._renderer.device.read({data:g,x:h,y:c,framebuffer:l,width:u,height:f}),A=[];let w=[];for(let e=0;e<m.length;e+=4){const{pickingId:t,meshId:n}=this._packData(m.subarray(e,e+4),o);A.push(n),w.push(t)}const T={},S=A.filter((e=>null!=e&&!T[e]&&(T[e]=1,!0))).map((e=>a[e]));let M;for(let e=0;e<S.length;e++)if(S[e]&&S[e].geometry){M=S[e];break}if(!M)return{pickingId:null,meshId:null,point:null};const C=M.geometry.desc.pickingIdAttribute;A.length&&o===this._shader1&&(void 0!==M.getUniform("uPickingId")||M.geometry.data[C])&&(w=this._getPickingId(h,c,u,f,g,S,i));const I=[],E=[];if(A.length&&s.returnPoint){const{viewMatrix:n,projMatrix:o}=s,a=this._pickDepth(h,c,u,f,g,S,i);for(let i=0;i<a.length;i++)if(a[i]&&null!=A[i]){const s=this._getWorldPos(e,t,a[i],n,o),l=this._convertPickPoint(s);I.push(s),E.push(l)}else I.push(null),E.push(null)}return{meshIds:A,pickingIds:w,coords:E,points:I,width:u,height:f}}_convertPickPoint(e){const t=this._map;if(!t)return null;const n=t.getGLRes();if(!sM){const e=t.getCenter();oM=new e.constructor(0,0,0);const n=t.coordToPoint(e);sM=new n.constructor(0,0)}sM.set(e[0],e[1]);const i=t.pointAtResToCoord(sM,n,oM),s=t.pointAtResToAltitude(e[2],n);return[i.x,i.y,s]}clear(){return this._fbo&&this._clearFbo(this._fbo),this._currentMeshes=[],delete this._currentShader,this}getMeshAt(e){return this._currentMeshes?this._currentMeshes[e]:null}getRenderedMeshes(){return this._currentMeshes}dispose(){this.clear(),this._shader0&&this._shader0.dispose(),this._shader1&&this._shader1.dispose(),this._shader2&&this._shader2.dispose(),this._scene&&this._scene.clear(),this._scene1&&this._scene1.clear()}_getWorldPos(e,t,n,i,s){const o=this._fbo,a=[],l=o.width/2||1,h=o.height/2||1,c=[(e-l)/l,(h-t)/h,0,1],u=[(e-l)/l,(h-t)/h,1,1],f=_A(a,s),g=[],m=[];mM(g,c,f),mM(m,u,f);const A=-g[2],w=(n-A)/(-m[2]-A),T=_A(a,vA(a,s,i)),S=mM(c,c,T),M=mM(u,u,T);return[Ax(S[0],M[0],w),Ax(S[1],M[1],w),Ax(S[2],M[2],w)]}_getPickingId(e,t,n,i,s,o,a){const l=this._renderer.device,h=this._getFBO1();this._clearFbo(h),this._scene1.setMeshes(o),this._renderer.render(this._shader2,a,this._scene1,h);const c=l.read({data:s,x:e,y:t,framebuffer:h,width:n,height:i}),u=[];for(let e=0;e<c.length;e+=4)u.push(nM(c.subarray(e,e+4)));return u}_pickDepth(e,t,n,i,s,o,a){const l=this._renderer.device,h=this._getFBO1();this._scene1.setMeshes(o),this._clearFbo(h),a.logDepthBufFC=2/(Math.log(this._map.cameraFar+1)/Math.LN2),this._renderer.render(this._depthShader,a,this._scene1,h);const c=l.read({data:s,x:e,y:t,framebuffer:h,width:n,height:i}),u=[];for(let e=0;e<c.length;e+=4)u.push((f=c.subarray(e,e+4),rM[0]=f[3],rM[1]=f[2],rM[2]=f[1],rM[3]=f[0],iM[0]));var f;return u}_packData(e,t){if(255===e[0]&&255===e[1]&&255===e[2]&&255===e[3])return{meshId:null,pickingId:null};let n=null,i=null;return t===this._shader1?i=nM(e):t===this._shader0?(i=e[3],n=nM(e)):(i=null,n=nM(e)),{meshId:i,pickingId:n}}_clearFbo(e){this._renderer.device.clear({color:[1,1,1,1],depth:1,stencil:255,framebuffer:e})}_getShader(e,t){return t&&e.length<256?this._shader0:this._shader1}_getFBO1(){const e=this._renderer.device,t=this._fbo;return this._fbo1?this._fbo1.width===t.width&&this._fbo1.height===t.height||this._fbo1.resize(t.width,t.height):this._fbo1=e.framebuffer(t.width,t.height),this._fbo1}_getParams(e,t,n,i){const s=n[0],o=n[1];t=i.height-t;let a=2*s+1,l=2*o+1;const h=(e-=s)+a,c=(t-=o)+l;return h>i.width&&(a-=h-i.width),c>i.height&&(l-=c-i.height),{px:e=e<0?0:e,py:t=t<0?0:t,width:a,height:l}}getPickingVert(){return this._vert}getPickingWGSLVert(){return this._wgslVert}getUniformDeclares(){return this._uniforms}},FogPass,FogShader,FxaaShader,GLTFHelper:yS,GLTFManager:class GLTFManager{constructor(e,t){this.regl=e,this.resourceMap={},this.options=t||{}}getGLTF(e){return this.resourceMap[e]}loginGLTF(e,t){if(this.resourceMap[e])this.resourceMap[e].refCount+=1;else{if(SS[e]){const t=function(e){let t=null;return SS[e]&&(t={meshes:SS[e].meshes},t.scenes=JSON.parse(JSON.stringify(SS[e].scenes))),t}(e);this.resourceMap[e]=this._exportGLTFResource(t,e,!1)}else this.resourceMap[e]=t?t(e).then((t=>(this.resourceMap[e]=this._exportGLTFResource(t,e),this.resourceMap[e]))):this._loadGLTFModel(e);this.resourceMap[e].refCount=1}}logoutGLTF(e){if(this.resourceMap[e]&&(this.resourceMap[e].refCount-=1,this.resourceMap[e].refCount<1)){const t=this.resourceMap[e].resources;if(t)for(let e=0;e<t.length;e++)t[e].geometry.dispose(),t[e].copyGeometry&&t[e].copyGeometry.dispose(),t[e].material&&t[e].material.dispose();this.resourceMap[e].gltfPack&&this.resourceMap[e].gltfPack.dispose(),delete this.resourceMap[e]}}isSimpleModel(e){return SS[e]}addSimpleModel(e,t){!function(e,t){"string"==typeof e&&TS.indexOf(e)<0&&(SS[e]=t)}(e,t)}removeSimpleModel(e){delete SS[e]}_exportGLTFResource(e,t,n=!0){if(!e)return null;const i=mS(e,n?this.regl:null),s=i.getMeshesInfo();return{bbox:i.getGLTFBBox(),gltfPack:i,resources:s,json:e.json,refCount:this.resourceMap[t]?this.resourceMap[t].refCount:0}}fetchGLTF(e){return gS(e,this.options).then((e=>e))}_loadGLTFModel(e){return this.fetchGLTF(e).then((t=>(this.resourceMap[e]=this._exportGLTFResource(t,e),this.resourceMap[e])))}},Geometry,GraphicsDevice,GraphicsFramebuffer,GraphicsTexture,HDR:TM,HeatmapDisplayShader,HeatmapShader,ImageShader,InstancedMesh,Jitter,KHRTechniquesWebglManager:class KHRTechniquesWebglManager{constructor(e,t,n){this._regl=e,this._khrShaders={},this._commandProps=t,this._resLoader=n}getExcludeFilter(){return yM}forEachShader(e){for(const t in this._khrShaders){const n=this._khrShaders[t];e(n.shader,n.filter,n.uniformSemantics)}}createMesh(e,t,n,i){const s=t.extensions.KHR_techniques_webgl,o=t.materials[e.material].extensions.KHR_techniques_webgl,{technique:a,values:l}=o,h=s.techniques[a],c=s.programs[h.program],u=s.shaders[c.vertexShader],f=s.shaders[c.fragmentShader];f.content=function(e){if(e&&e.indexOf("precision")<0)return"precision mediump float;\n"+e;return e}(f.content);const g=Ox(u.content)+"-"+Ox(f.content);this._khrShaders[g]||(this._khrShaders[g]=this._createTechniqueShader(g,s,a,this._commandProps,i));const{attributeSemantics:m}=this._khrShaders[g],A=this._createGeometry(e,m,n,g),w=px({},l);for(const e in l)if(h.uniforms[e]&&35678===h.uniforms[e].type){w[e]=this._getTexture(t.textures[l[e].index])}return{geometry:A,material:new Material(w)}}_createGeometry(e,t,n,i){const s=e.attributes,o="COLOR_0";if(s[o]){const e=s[o].array||s[o];if(e instanceof Float32Array){const t=new Uint8Array(e.length);for(let n=0;n<t.length;n++)t[n]=Math.round(255*e[n]);s[o].array?(s[o].array=t,s[o].componentType=5121):s[o]=t}}const a={};for(const e in s){const n=$b(this._regl,s[e],{dimension:s[e].itemSize,name:e}),i=t[e]||e;a[i]={buffer:n},s[e].quantization&&(a[i].quantization=s[e].quantization),i===t.POSITION&&(a[i].array=s[e].array)}const l=new Geometry(a,e.indices.array?e.indices.array:e.indices,0,{positionAttribute:t.POSITION,normalAttribute:t.NORMAL,uv0Attribute:t.TEXCOORD_0,uv1Attribute:t.TEXCOORD_1,color0Attribute:t.COLOR_0,tangentAttribute:t.TANGENT,textureCoordMatrixAttribute:t.TextureCoordMatrix,primitive:void 0===e.mode?"triangles":Nb(e.mode)});l.generateBuffers(this._regl,{excludeElementsInVAO:n}),l.properties.shaderHash=i;const h=l.data[l.desc.positionAttribute];return h&&h.array&&delete h.array,l}_getTexture(e){const t={type:e.type?zb(e.type):"uint8",format:e.format?Vb(e.format):"rgba",flipY:!!e.flipY},n=e.image;n.array?t.data=n.array:n.mipmap&&(t.mipmap=n.mipmap),t.width=n.width,t.height=n.height;const i=e.sampler||e.texture.sampler;return i&&(i.magFilter&&(t.mag=Wb(i.magFilter)),i.minFilter&&(t.min=Zb(i.minFilter)),i.wrapS&&(t.wrapS=Yb(i.wrapS)),i.wrapT&&(t.wrapT=Yb(i.wrapT))),new Texture2D(t,this._resLoader)}_createTechniqueShader(e,t,n,i,s){const{techniques:o,programs:a,shaders:l}=t,h=o[n],c=a[h.program],u=l[c.vertexShader].content,f=l[c.fragmentShader].content,g={};for(const e in h.uniforms){const t=h.uniforms[e];t.semantic&&(g[t.semantic]=e)}const m=xM.slice();for(const e in g){m.push({name:g[e],type:"function",fn:(t,n)=>n[bM[e]]})}const A=new MeshShader({vert:u,frag:f,uniforms:m,extraCommandProps:i});s&&(A.version=300);const w={};for(const e in h.attributes){w[h.attributes[e].semantic]=e}return{shader:A,filter:t=>t&&t.geometry&&t.geometry.properties.shaderHash===e,uniformSemantics:g,attributeSemantics:w}}dispose(){for(const e in this._khrShaders){const{shader:t}=this._khrShaders[e];t.dispose()}this._khrShaders={}}},Material,Mesh,MeshShader,PhongMaterial,PhongShader:class PhongShader extends MeshShader{constructor(e={}){const t=[],n=[],i=e.uniforms,s=[{name:"modelNormalMatrix",type:"function",fn:function(e,n){return oA(t,n.modelMatrix)}},{name:"modelViewMatrix",type:"function",fn:function(e,t){return vA(n,t.viewMatrix,t.modelMatrix)}}];i&&s.push(...i),super({name:"phong",vert:e.vert||"#include <gl2_vert>\nattribute vec3 aPosition;\n#include <line_extrusion_vert>\n#ifdef HAS_MAP\nuniform vec2 uvScale;\nuniform vec2 uvOffset;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\n#ifdef HAS_I3S_UVREGION\nattribute vec4 uvRegion;\nvarying vec4 vUvRegion;\n#endif\n#if defined(HAS_AO_MAP)\nattribute vec2 aTexCoord1;\nvarying vec2 vTexCoord1;\n#endif\n#endif\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\nvarying vec4 vColor;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nattribute vec3 aColor0;\n#else\nattribute vec4 aColor0;\n#endif\nvarying vec4 vColor;\n#endif\nvarying vec3 vFragPos;\nvarying vec3 vNormal;\nuniform mat4 projMatrix;\nuniform mat3 modelNormalMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 positionMatrix;\nuniform vec2 halton;\nuniform vec2 outSize;\nuniform mat4 projViewMatrix;\n#include <highlight_vert>\n#include <get_output>\n#include <heatmap_render_vert>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#ifdef HAS_EXTRUSION_OPACITY\nattribute float aExtrusionOpacity;\nvarying float vExtrusionOpacity;\n#endif\n#if defined(HAS_TANGENT)\nvarying vec4 vTangent;\n#endif\nvoid c(const highp vec4 q, out highp vec3 d) {\n  d = vec3(.0, .0, 1.) + vec3(2., -2., -2.) * q.x * q.zwx + vec3(2., 2., -2.) * q.y * q.wzy;\n}\nvoid c(const highp vec4 q, out highp vec3 d, out highp vec3 t) {\n  c(q, d);\n  t = vec3(1., .0, .0) + vec3(-2., 2., -2.) * q.y * q.yxw + vec3(-2., 2., 2.) * q.z * q.zwx;\n}\n#include <vertex_color_vert>\nvoid main() {\n  \n#ifdef IS_LINE_EXTRUSION\nvec4 e = getPosition(getLineExtrudePosition(aPosition));\n#else\nvec4 e = getPosition(aPosition);\n#endif\nmat4 f = getPositionMatrix();\n  vFragPos = vec3(modelMatrix * f * e);\n#if defined(HAS_NORMAL) || defined(HAS_TANGENT)\nmat3 h = modelNormalMatrix * mat3(f);\n  vec3 i;\n#if defined(HAS_TANGENT)\nvec3 t;\n  c(aTangent, i, t);\n  vTangent = vec4(h * t, aTangent.w);\n#else\ni = decode_getNormal(aNormal);\n#endif\nvec3 j = appendMorphNormal(i);\n  vNormal = normalize(h * j);\n#else\nvNormal = vec3(.0);\n#endif\nmat4 k = projMatrix;\n  k[2].xy += halton.xy / outSize.xy;\n#ifdef HAS_MASK_EXTENT\ngl_Position = k * getMaskPosition(f * e, modelMatrix);\n#else\ngl_Position = k * modelViewMatrix * f * e;\n#endif\n#ifdef HAS_MAP\nvec2 l = decode_getTexcoord(aTexCoord);\n  vTexCoord = l * uvScale + uvOffset;\n#endif\n#ifdef HAS_AO_MAP\nvec2 m = decode_getTexcoord(aTexCoord1);\n  vTexCoord1 = m * uvScale + uvOffset;\n#endif\n#ifdef HAS_EXTRUSION_OPACITY\nvExtrusionOpacity = aExtrusionOpacity;\n#endif\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nvColor = vec4(aColor0 / 255., 1.);\n#else\nvColor = aColor0 / 255.;\n#endif\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(f * e);\n#endif\n#ifdef HAS_HEATMAP\nheatmap_compute(projMatrix * modelViewMatrix * f, e);\n#endif\n#ifdef HAS_I3S_UVREGION\nvUvRegion = uvRegion / 65535.;\n#endif\nhighlight_setVarying();\n#ifdef HAS_VERTEX_COLOR\nvertexColor_update();\n#endif\n}",frag:e.frag||"precision mediump float;\n#include <gl2_frag>\nuniform vec4 baseColorFactor;\nuniform float materialShininess;\nuniform float environmentExposure;\nuniform float specularStrength;\nuniform vec3 light0_viewDirection;\nuniform vec3 ambientColor;\nuniform vec4 light0_diffuse;\nuniform vec3 lightSpecular;\nuniform vec3 cameraPosition;\nuniform float alphaTest;\n#ifdef HAS_TOON\nuniform float toons;\nuniform float specularToons;\n#endif\n#ifdef HAS_TANGENT\nvarying vec4 vTangent;\n#endif\n#ifdef HAS_MAP\n#include <compute_texcoord_frag>\n#endif\nvarying vec3 vNormal;\nvarying vec3 vFragPos;\n#ifdef HAS_INSTANCE_COLOR\nvarying vec4 vInstanceColor;\n#endif\n#ifdef HAS_BASECOLOR_MAP\nuniform sampler2D baseColorTexture;\n#endif\n#ifdef HAS_EXTRUSION_OPACITY\nuniform vec2 extrusionOpacityRange;\nvarying float vExtrusionOpacity;\n#endif\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nvarying vec4 vColor;\n#elif defined(IS_LINE_EXTRUSION)\nuniform vec4 lineColor;\n#else\nuniform vec4 polygonFill;\n#endif\n#ifdef HAS_LAYER_OPACITY\nuniform float layerOpacity;\n#endif\n#ifdef IS_LINE_EXTRUSION\nuniform float lineOpacity;\n#else\nuniform float polygonOpacity;\n#endif\n#ifdef HAS_AO_MAP\nuniform sampler2D occlusionTexture;\nvarying vec2 vTexCoord1;\n#endif\n#ifdef HAS_NORMAL_MAP\nuniform sampler2D normalTexture;\n#endif\n#ifdef HAS_EMISSIVE_MAP\nuniform sampler2D emissiveTexture;\n#endif\n#ifdef SHADING_MODEL_SPECULAR_GLOSSINESS\nuniform vec4 diffuseFactor;\nuniform vec3 specularFactor;\n#ifdef HAS_DIFFUSE_MAP\nuniform sampler2D diffuseTexture;\n#endif\n#ifdef HAS_SPECULARGLOSSINESS_MAP\nuniform sampler2D specularGlossinessTexture;\n#endif\n#endif\n#include <heatmap_render_frag>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#include <highlight_frag>\n#include <mask_frag>\n#include <vertex_color_frag>\nvec3 c() {\n  \n#if defined(HAS_NORMAL_MAP)\nvec3 d = normalize(vNormal);\n  vec3 e = texture2D(normalTexture, computeTexCoord(vTexCoord)).xyz * 2. - 1.;\n#if defined(HAS_TANGENT)\nvec3 t = normalize(vTangent.xyz);\n  vec3 b = normalize(cross(d, t) * sign(vTangent.w));\n  mat3 f = mat3(t, b, d);\n  return normalize(f * e);\n#else\nreturn normalize(e);\n#endif\n#else\nreturn normalize(vNormal);\n#endif\n}\nvec4 h() {\n  \n#if defined(HAS_BASECOLOR_MAP)\nreturn texture2D(baseColorTexture, computeTexCoord(vTexCoord));\n#elif defined(HAS_DIFFUSE_MAP)\nreturn texture2D(diffuseTexture, computeTexCoord(vTexCoord));\n#elif defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nreturn diffuseFactor;\n#else\nreturn baseColorFactor;\n#endif\n}\nvec3 i() {\n  \n#if defined(HAS_SPECULARGLOSSINESS_MAP)\nreturn texture2D(specularGlossinessTexture, computeTexCoord(vTexCoord)).rgb;\n#elif defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nreturn specularFactor;\n#else\nreturn vec3(1.);\n#endif\n}\nvoid main() {\n  vec4 j = h();\n#ifdef SHADING_MODEL_UNLIT\nvec3 k = vec3(1.);\n#else\nvec3 k = ambientColor;\n#endif\nvec3 l = environmentExposure * k * j.rgb;\n#ifdef HAS_INSTANCE_COLOR\nl *= vInstanceColor.rgb;\n#endif\nvec3 m = c();\n  vec3 o = normalize(-light0_viewDirection);\n  float u = max(dot(m, o), .0);\n#ifdef HAS_TOON\nfloat v = floor(u * toons);\n  u = v / toons;\n#endif\n#ifdef SHADING_MODEL_UNLIT\nvec3 A = vec3(.0);\n#else\nvec3 A = light0_diffuse.rgb;\n#endif\nvec3 B = A * u * j.rgb;\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nvec3 C = vColor.rgb;\n#elif defined(IS_LINE_EXTRUSION)\nvec3 C = lineColor.rgb;\n#else\nvec3 C = polygonFill.rgb;\n#endif\n#ifdef HAS_INSTANCE_COLOR\nC *= vInstanceColor.rgb;\n#endif\nl *= C.rgb;\n  B *= C.rgb;\n  vec3 D = normalize(cameraPosition - vFragPos);\n  vec3 E = normalize(o + D);\n  float F = pow(max(dot(m, E), .0), materialShininess);\n#ifdef HAS_TOON\nfloat G = floor(F * specularToons);\n  F = G / specularToons;\n#endif\n#ifdef SHADING_MODEL_UNLIT\nvec3 H = vec3(.0);\n#else\nvec3 H = lightSpecular;\n#endif\nvec3 I = specularStrength * H * F * i();\n#ifdef HAS_OCCLUSION_MAP\nfloat J = texture2D(occlusionTexture, computeTexCoord(vTexCoord1)).r;\n  l *= J;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat K = shadow_computeShadow();\n  B = shadow_blend(B, K).rgb;\n  I = shadow_blend(I, K).rgb;\n  l = shadow_blend(l, K).rgb;\n#endif\nvec3 L = l + B + I;\n#ifdef HAS_EMISSIVE_MAP\nvec3 M = texture2D(emissiveTexture, computeTexCoord(vTexCoord)).rgb;\n  L += M;\n#endif\n#ifdef IS_LINE_EXTRUSION\nglFragColor = vec4(L, lineOpacity * j.a);\n#else\nglFragColor = vec4(L, polygonOpacity * j.a);\n#endif\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nfloat N = vColor.a;\n#elif defined(IS_LINE_EXTRUSION)\nfloat N = lineColor.a;\n#else\nfloat N = polygonFill.a;\n#endif\nglFragColor *= N;\n#ifdef HAS_EXTRUSION_OPACITY\nfloat O = extrusionOpacityRange.x;\n  float P = extrusionOpacityRange.y;\n  float Q = O + vExtrusionOpacity * (P - O);\n  Q = clamp(Q, .0, 1.);\n  glFragColor *= Q;\n#endif\nif(glFragColor.a < alphaTest) {\n    discard;\n  }\n#ifdef HAS_VERTEX_COLOR\nglFragColor *= vertexColor_get();\n#endif\n#ifdef HAS_HEATMAP\nglFragColor = heatmap_getColor(glFragColor);\n#endif\nglFragColor = highlight_blendColor(glFragColor);\n#ifdef HAS_LAYER_OPACITY\nglFragColor *= layerOpacity;\n#endif\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",wgslVert:"",wgslFrag:"",uniforms:s,defines:e.defines||{},extraCommandProps:e.extraCommandProps||{}}),this.version=300}getGeometryDefines(e){const t={};return e.data[e.desc.tangentAttribute]?t.HAS_TANGENT=1:e.data[e.desc.normalAttribute]&&(t.HAS_NORMAL=1),t}},PhongSpecularGlossinessMaterial,Plane,PointLineShader:class PointLineShader extends MeshShader{constructor(e={}){const t=[];super({vert:"attribute vec3 aPosition;\n#ifdef HAS_COLOR0\nattribute vec4 aColor0;\nvarying vec4 vColor;\n#endif\nuniform mat4 modelMatrix;\nuniform mat4 projMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float pointSize;\n#if defined(HAS_MAP)\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\n#endif\n#include <get_output>\n#include <heatmap_render_vert>\n#ifdef HAS_FLOODANALYSE\nvarying float vHeight;\n#endif\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  gl_PointSize = pointSize;\n#ifdef HAS_MASK_EXTENT\ngl_Position = projMatrix * getMaskPosition(d * c, modelMatrix);\n#else\ngl_Position = projViewModelMatrix * d * c;\n#endif\n#ifdef HAS_COLOR0\nvColor = aColor0 / 255.;\n#endif\n#ifdef HAS_MAP\nvTexCoord = aTexCoord;\n#endif\n#ifdef HAS_HEATMAP\nheatmap_compute(projMatrix * modelViewMatrix * d, c);\n#endif\n}",frag:"precision mediump float;\n#include <gl2_frag>\n#if defined(HAS_COLOR0)\nvarying vec4 vColor;\n#endif\n#include <heatmap_render_frag>\nuniform vec4 baseColorFactor;\n#if defined(HAS_MAP)\n#if defined(HAS_ALBEDO_MAP)\nuniform sampler2D baseColorTexture;\n#endif\n#if defined(HAS_DIFFUSE_MAP)\nuniform sampler2D diffuseTexture;\n#endif\nvarying vec2 vTexCoord;\n#endif\n#include <mask_frag>\nvoid main() {\n  \n#ifdef HAS_COLOR0\nglFragColor = vColor * baseColorFactor;\n#else\nglFragColor = vec4(1.) * baseColorFactor;\n#endif\n#ifdef HAS_MAP\n#ifdef HAS_ALBEDO_MAP\nglFragColor *= texture2D(baseColorTexture, vTexCoord);\n#endif\n#ifdef HAS_DIFFUSE_MAP\nglFragColor *= texture2D(diffuseTexture, vTexCoord);\n#endif\n#endif\n#ifdef HAS_HEATMAP\nglFragColor = heatmap_getColor(glFragColor);\n#endif\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(e,n)=>vA(t,n.projViewMatrix,n.modelMatrix)}],defines:e.defines||{},extraCommandProps:e.extraCommandProps||{}})}},PostProcessShader,QuadShader,REGLHelper:ew,RainRipplesPass:RainRipplePass,Renderer,ResourceLoader,ScanEffectPass,ScanEffectShader:EffectShader,Scene,Shader:GPUShader,ShaderLib:Ww,ShadowDisplayShader,ShadowMapShader,ShadowPass,SkyboxShader,SsrPass,StandardLiteMaterial:class StandardLiteMaterial extends Material{constructor(e){super(e,uw)}appendDefines(e,t){super.appendDefines(e,t);const n=this.uniforms;n.extrusionOpacity&&(e.HAS_EXTRUSION_OPACITY=1),t.data[t.desc.colorAttribute]&&(e.HAS_COLOR=1);return t.data[t.desc.color0Attribute]&&(e.HAS_COLOR0=1,e.COLOR0_SIZE=t.getColor0Size()),t.data[t.desc.uv0Attribute]?(n.baseColorTexture&&(e.HAS_BASECOLOR_MAP=1),n.occlusionTexture&&t.data[t.desc.uv1Attribute]&&(e.HAS_AO_MAP=1),n.emissiveTexture&&(e.HAS_EMISSIVE_MAP=1),n.normalTexture&&(e.HAS_NORMAL_MAP=1),(e.HAS_BASECOLOR_MAP||e.HAS_AO_MAP||e.HAS_EMISSIVE_MAP||e.HAS_NORMAL_MAP)&&(e.HAS_MAP=1),e.ALPHATEST=.01,e.GAMMA_INPUT=1,e.GAMMA_FACTOR=1,e.TONEMAP_OUTPUT=1,e.ENVMAP_MODE_REFLECTION=1,e.ENV_RGBM=1,e.IRR_RGBM=1,e):e}},StandardLiteShader:class StandardLiteShader extends MeshShader{constructor(e={}){const t=[],n=e.uniforms,i=[{name:"viewMatrixInverse",type:"function",fn:(e,t)=>_A(VT,t.viewMatrix)},{name:"modelViewMatrix",type:"function",fn:function(e,n){return vA(t,n.viewMatrix,n.modelMatrix)}},{name:"environmentTransform",type:"function",fn:(e,t)=>uA(jT,Math.PI*(t.environmentOrientation||0)/180)}];n&&i.push(...n),super({vert:"precision mediump float;\n#include <gl2_vert>\nattribute vec3 aPosition;\n#include <line_extrusion_vert>\n#ifdef HAS_MAP\nuniform vec2 uvScale;\nuniform vec2 uvOffset;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\n#ifdef HAS_I3S_UVREGION\nattribute vec4 uvRegion;\nvarying vec4 vUvRegion;\n#endif\n#endif\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nattribute vec3 aColor0;\n#else\nattribute vec4 aColor0;\n#endif\nvarying vec4 vColor;\n#endif\nuniform mat4 projMatrix;\nuniform mat3 modelNormalMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 positionMatrix;\nuniform vec2 halton;\nuniform vec2 outSize;\nuniform mat4 projViewMatrix;\n#include <get_output>\n#include <heatmap_render_vert>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\nvarying vec3 vViewPosition;\nvoid main() {\n  \n#ifdef IS_LINE_EXTRUSION\nvec4 c = getPosition(getLineExtrudePosition(aPosition));\n#else\nvec4 c = getPosition(aPosition);\n#endif\nmat4 d = getPositionMatrix();\n  mat4 e = projMatrix;\n  e[2].xy += halton.xy / outSize.xy;\n#ifdef HAS_MASK_EXTENT\ngl_Position = e * getMaskPosition(d * c, modelMatrix);\n#else\ngl_Position = e * modelViewMatrix * d * c;\n#endif\nvec4 f = modelViewMatrix * d * c;\n  vViewPosition = -f.xyz;\n#ifdef HAS_MAP\nvec2 h = decode_getTexcoord(aTexCoord);\n  vTexCoord = h * uvScale + uvOffset;\n#endif\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nvColor = vec4(aColor0 / 255., 1.);\n#else\nvColor = aColor0 / 255.;\n#endif\n#endif\n}",frag:"#if __VERSION__ == 100\n#if defined(GL_EXT_shader_texture_lod)\n#extension GL_EXT_shader_texture_lod : enable\n#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)\n#else\n#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)\n#endif\n#if defined(GL_OES_standard_derivatives)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#else\n#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)\n#endif\n#define saturate(x)        clamp(x, 0.0, 1.0)\nprecision mediump float;\n#include <gl2_frag>\n#include <hsv_frag>\nuniform vec3 hsv;\n#define GET_BASEMAP(UV) (texture2D(baseColorTexture, (UV)))\nuniform mat4 viewMatrix;\nuniform mat4 projMatrix;\nuniform vec3 cameraPosition;\n#if defined(HAS_IBL_LIGHTING)\nuniform mat4 viewMatrixInverse;\n#endif\nuniform vec4 baseColorFactor;\nuniform vec3 emissiveFactor;\nuniform vec3 specularFactor;\nuniform float opacity;\nuniform float envRotationSin;\nuniform float envRotationCos;\nuniform float rgbmRange;\n#if defined(HAS_MAP)\n#include <compute_texcoord_frag>\n#endif\n#ifdef HAS_BASECOLOR_MAP\nuniform sampler2D baseColorTexture;\n#endif\n#ifdef HAS_NORMAL_MAP\nuniform sampler2D normalTexture;\nvec3 c(vec3 d, vec3 e) {\n  vec3 f = dFdx(d.xyz);\n  vec3 h = dFdy(d.xyz);\n  vec3 i = normalize(f - h);\n  vec3 j = normalize(-f + h);\n  vec3 k = normalize(e);\n  vec3 l = texture2D(normalTexture, computeTexCoord(vTexCoord)).rgb * 2. - 1.;\n  mat3 m = mat3(i, j, k);\n  return normalize(m * l);\n}\n#endif\n#ifdef HAS_EMISSIVE_MAP\nuniform sampler2D emissiveTexture;\n#endif\n#ifdef SHADING_MODEL_SPECULAR_GLOSSINESS\nuniform vec4 diffuseFactor;\n#ifdef HAS_DIFFUSE_MAP\nuniform sampler2D diffuseTexture;\n#endif\n#ifdef HAS_SPECULARGLOSSINESS_MAP\nuniform sampler2D specularGlossinessTexture;\n#endif\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nvarying vec4 vColor;\n#endif\n#ifdef GAMMA_INPUT\nvec3 n(vec3 o) {\n  return o * o;\n}\nfloat n(float o) {\n  return o * o;\n}\n#else\nvec3 n(vec3 o) {\n  return o;\n}\nfloat n(float o) {\n  return o;\n}\n#endif\nvec3 u() {\n  \n#ifdef SHADING_MODEL_SPECULAR_GLOSSINESS\n#ifdef HAS_SPECULARGLOSSINESS_MAP\nreturn texture2D(specularGlossinessTexture, computeTexCoord(vTexCoord)).rgb;\n#else\nreturn specularFactor;\n#endif\n#else\nreturn specularFactor;\n#endif\n}\nvec3 v() {\n  \n#ifdef HAS_EMISSIVE_MAP\nreturn texture2D(emissiveTexture, computeTexCoord(vTexCoord)).rgb;\n#else\nreturn emissiveFactor;\n#endif\n}\n#if defined(TONEMAP_OUTPUT)\n#if TONEMAP_OUTPUT > 0\nuniform float exposureBias;\nfloat A(vec3 rgb) {\n  return dot(rgb, vec3(.299, .587, .114));\n}\nfloat B(vec3 rgb) {\n  return dot(rgb, vec3(.212671, .715160, .072169));\n}\nvec3 C(vec3 xyz) {\n  vec3 D = vec3(3.240479, -1.53715, -.498535);\n  vec3 E = vec3(-.969256, 1.875992, .041556);\n  vec3 F = vec3(.055648, -.204043, 1.057311);\n  vec3 rgb;\n  rgb.b = dot(xyz, F);\n  rgb.g = dot(xyz, E);\n  rgb.r = dot(xyz, D);\n  return rgb;\n}\nvec3 H(vec3 rgb) {\n  vec3 I = vec3(.412453, .35758, .180423);\n  vec3 J = vec3(.212671, .71516, .0721688);\n  vec3 K = vec3(.0193338, .119194, .950227);\n  vec3 xyz;\n  xyz.x = dot(rgb, I);\n  xyz.y = dot(rgb, J);\n  xyz.z = dot(rgb, K);\n  return xyz;\n}\nvec3 L(vec3 xyz) {\n  float M = xyz.x + xyz.y + xyz.z;\n  M = 1. / M;\n  vec3 O;\n  O.z = xyz.y;\n  O.x = xyz.x * M;\n  O.y = xyz.y * M;\n  return O;\n}\nvec3 P(vec3 O) {\n  float x = O.x;\n  float y = O.y;\n  float J = O.z;\n  vec3 xyz;\n  xyz.y = J;\n  xyz.x = x * (J / y);\n  xyz.z = (1. - x - y) * (J / y);\n  return xyz;\n}\nfloat Q(float x) {\n  float U = pow(x, 1.60525727);\n  float V = ((1.05542877 * 4.68037409) * U) / (4.68037409 * U + 1.);\n  return clamp(V, .0, 1.);\n}\nconst float W = 1. / .18;\nfloat ba(float x) {\n  x *= W;\n  const float bb = .2;\n  const float F = .34;\n  const float bc = .002;\n  const float bd = 1.68;\n  const float be = .0005;\n  const float bf = .252;\n  const float bg = 1. / .833837;\n  return ((x * (bb * x + bc * F) + bd * be) / (x * (bb * x + F) + bd * bf) - be / bf) * bg;\n}\nvec3 bh(vec3 x) {\n  x *= W;\n  const float bb = .27;\n  const float F = .29;\n  const float bc = .052;\n  const float bd = .2;\n  const float bf = .18;\n  const float bg = 1. / .897105;\n  return ((x * (bb * x + bc * F)) / (x * (bb * x + F) + bd * bf)) * bg;\n}\nvec3 bi(vec3 x) {\n  vec3 bj = x.rgb;\n  bj = min(bj, vec3(3.));\n  float bk = B(bj);\n  if(bk > .0) {\n    float bl = Q(bk);\n    bj = bj * (bl / bk);\n    bj = clamp(bj, vec3(.0), vec3(1.));\n  }\n  float bm = 1. / 2.2;\n  bj = pow(bj, vec3(bm));\n  return bj;\n}\n#endif\n#endif\n#if defined(IRR_RGBM) || defined(ENV_RGBM) || defined(ENV_GAMMA) || defined(IRR_GAMMA)\nuniform float envMapExposure;\n#endif\nuniform vec4 themingColor;\nuniform mat3 environmentTransform;\nvec3 bn(vec3 bo, vec3 bp) {\n  \n#if defined(HAS_SHADOWMAP)\nfloat bq = dot(shadowLightDir, bp);\n  float br = (bq + 1.) / 2.;\n  br = min(1., br * 1.5);\n  float bs = 1.;\n  vec3 bt = bo * min(bs, br);\n  return bt;\n#else\nreturn bo;\n#endif\n}\n#ifdef HAS_IBL_LIGHTING\nuniform float reflectivity;\nuniform vec3 hdrHSV;\nuniform samplerCube prefilterMap;\nuniform vec3 diffuseSPH[9];\nuniform vec2 prefilterMiplevel;\nuniform vec2 prefilterSize;\n#else\nuniform vec3 ambientColor;\n#endif\n#if defined(HAS_IBL_LIGHTING)\nvec3 bu(const in vec3 bv) {\n  vec3 bw = environmentTransform * bv;\n  float x = bw.x;\n  float y = bw.y;\n  float z = bw.z;\n  vec3 bt = (diffuseSPH[0] + diffuseSPH[1] * x + diffuseSPH[2] * y + diffuseSPH[3] * z + diffuseSPH[4] * z * x + diffuseSPH[5] * y * z + diffuseSPH[6] * y * x + diffuseSPH[7] * (3. * z * z - 1.) + diffuseSPH[8] * (x * x - y * y));\n  if(length(hdrHSV) > .0) {\n    bt = hsv_apply(bt, hdrHSV);\n  }\n  return max(bt, vec3(.0));\n}\nvec3 bx(const in vec4 by, const in float bz) {\n  if(bz <= .0)\n    return by.rgb;\n  return bz * by.rgb * by.a;\n}\nfloat bA(const in float bB) {\n  return bB;\n}\nvec3 bC(const in float bD, const in vec3 D) {\n  vec3 bE = D;\n  float bF = prefilterMiplevel.x;\n  float bG = min(bF, bA(bD) * prefilterMiplevel.y);\n  vec3 bH = bx(textureCubeLod(prefilterMap, bE, bG), rgbmRange);\n  if(length(hdrHSV) > .0) {\n    return hsv_apply(bH, hdrHSV);\n  } else {\n    return bH;\n  }\n}\nvec3 bI(const in vec3 k, const in vec3 D, const in float bJ) {\n  float bK = 1. - bJ;\n  float bL = bK * (sqrt(bK) + bJ);\n  return mix(k, D, bL);\n}\nvec3 bM(const in vec3 bv, const in vec3 bN, const in float bO, const in vec3 bP) {\n  vec3 D = reflect(-bN, bv);\n  D = bI(bv, D, bO);\n  vec3 bQ = bC(bO, environmentTransform * D);\n  float bR = clamp(1. + dot(D, bP), .0, 1.);\n  bQ *= bR * bR;\n  return bQ;\n}\n#else\nvec3 bM(const in vec3 bv, const in vec3 bN, const in float bO, const in vec3 bP) {\n  return ambientColor;\n}\n#endif\nvarying highp vec3 vViewPosition;\nvec3 bS(vec3 bT, float bU) {\n  float bV = max(1. - bU, .0);\n  return bT + (1. - bT) * pow(bV, 5.);\n}\nfloat bW(float bT, float bU) {\n  float bV = max(1. - bU, .0);\n  return bT + (1. - bT) * pow(bV, 5.);\n}\n#include <srgb_frag>\nvoid main() {\n  glFragColor = vec4(vec3(1.), opacity);\n#ifdef HAS_BASECOLOR_MAP\nvec4 bX = GET_BASEMAP(computeTexCoord(vTexCoord));\n#ifdef GAMMA_INPUT\nbX.xyz *= bX.xyz;\n#endif\nglFragColor = glFragColor * bX;\n#endif\n#ifdef ALPHATEST\nif(glFragColor.a < ALPHATEST)\n    discard;\n  \n#endif\nfloat bY = 1.;\n  vec3 bZ = dFdx(vViewPosition);\n  vec3 ca = dFdy(vViewPosition);\n  vec3 bv = normalize(cross(bZ, ca));\n  vec3 cb;\n  if(projMatrix[3][3] == .0) {\n    cb = normalize(vViewPosition);\n  } else {\n    cb = vec3(.0, .0, 1.);\n  }\n  bv = faceforward(bv, -cb, bv);\n  vec3 cc = bv;\n#ifdef HAS_NORMAL_MAP\nbv = c(-vViewPosition, bv);\n#endif\nvec3 cd = vec3(.0);\n  vec3 ce = vec3(.0);\n#ifdef HAS_IBL_LIGHTING\nvec3 bp = mat3(viewMatrixInverse) * bv;\n  vec3 cf = glFragColor.rgb * bu(bp) * .5;\n  cf = bn(cf, bp);\n  cd += n(baseColorFactor.rgb) * cf;\n#endif\nvec3 cg = v();\n#ifdef METAL\nglFragColor.xyz = glFragColor.xyz * (n(cg) + cd + n(baseColorFactor.rgb) + ce);\n#else\nglFragColor.xyz = glFragColor.xyz * (n(cg) + cd + n(baseColorFactor.rgb)) + ce;\n#endif\nvec3 ch;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat ci = shadow_computeShadow();\n  ch = shadow_blend(ch, ci).rgb;\n#endif\n#ifdef HAS_COLOR\nglFragColor = glFragColor * vColor;\n#endif\nglFragColor.rgb += ch;\n  glFragColor.rgb = linearTosRGB(glFragColor.rgb);\n#if defined(HAS_IBL_LIGHTING)\nvec3 cj;\n#if defined(HAS_NORMAL_MAP)\n#ifdef ENVMAP_MODE_REFLECTION\ncj = reflect(-cb, bv);\n#else\ncj = refract(-cb, bv, 1.);\n#endif\n#else\ncj = reflect(-cb, bv);\n#endif\ncj = mat3(viewMatrixInverse) * cj;\n  float ck = 1.;\n  vec3 cl;\n#ifdef HAS_IBL_LIGHTING\ncl = vec3(.0);\n#elif\ncl = ambientColor;\n#endif\ncl *= ck;\n  float bV = dot(cb, bv);\n  if(bV < -1e-2 || reflectivity == .0)\n    bV = 1.;\n  else\n    bV = max(1e-6, bV);\n  vec3 cm;\n  vec3 cn = u();\n#ifdef METAL\ncm = n(cn);\n#else\ncm = bS(n(cn), bV) * (1. - envRotationSin);\n  glFragColor.a = mix(glFragColor.a, bW(glFragColor.a, bV), reflectivity) * envRotationCos;\n  float co = pow(1. - bV * .5, 5.);\n  float cp = (28. / 23.) * (1. - co) * (1. - co);\n  glFragColor.rgb *= cp * (1. - n(cn));\n#endif\nglFragColor.rgb += cl.rgb * bY * cm.rgb;\n#endif\n#if defined(TONEMAP_OUTPUT)\n#if TONEMAP_OUTPUT == 1\nglFragColor.rgb = bi(exposureBias * glFragColor.rgb);\n#elif TONEMAP_OUTPUT == 2\nglFragColor.rgb = bh(exposureBias * glFragColor.rgb);\n#endif\n#endif\nglFragColor.rgb = mix(glFragColor.rgb, themingColor.rgb, themingColor.a);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:i,defines:e.defines||{},extraCommandProps:e.extraCommandProps||{}}),this.version=300}},Texture2D,Util:Fx,WGSLParseDefines:yT,WaterShader:class WaterShader extends MeshShader{constructor(e={}){super({vert:"const float c = 3.141592653589793;\nuniform mat4 projMatrix;\nuniform mat4 viewMatrix;\nuniform mat4 modelMatrix;\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nattribute vec3 aNormal;\nvarying vec2 vuv;\nvarying vec3 vpos;\nvarying vec3 vnormal;\nvarying mat3 vtbnMatrix;\nvec4 d(mat4 e, mat4 f, vec3 h) {\n  return e * modelMatrix * f * vec4(h, 1.);\n}\nvec3 i(in vec3 h, in vec3 j) {\n  return normalize(h + j);\n}\nmat3 k(in vec3 l) {\n  vec3 t = normalize(cross(vec3(.0, .0, 1.), l));\n  vec3 b = normalize(cross(l, t));\n  return mat3(t, b, l);\n}\nvoid m() {\n  \n}\nvoid main(void) {\n  vuv = aTexCoord;\n  vpos = (modelMatrix * vec4(aPosition, 1.)).xyz;\n  vnormal = aNormal;\n  vtbnMatrix = k(vnormal);\n  gl_Position = d(projMatrix, viewMatrix, vpos);\n  m();\n}",frag:"precision highp float;\nprecision highp sampler2D;\nuniform sampler2D texWaveNormal;\nuniform sampler2D texWavePerturbation;\nuniform vec3 octaveTextureRepeat;\nuniform vec4 waveParams;\nuniform vec2 waveDirection;\nuniform vec4 waterColor;\nuniform vec3 lightingDirection;\nuniform vec3 lightingIntensity;\nuniform vec3 camPos;\nuniform float timeElapsed;\nvarying vec2 vuv;\nvarying vec3 vpos;\nvarying vec3 vnormal;\nvarying mat3 vtbnMatrix;\nconst vec2 c = vec2(6. / 25., 5. / 24.);\nvec2 d(sampler2D e, vec2 f) {\n  return 2. * texture2D(e, f).rg - 1.;\n}\nfloat h(vec2 f) {\n  return texture2D(texWavePerturbation, f).b;\n}\nvec3 i(sampler2D e, vec2 f) {\n  return 2. * texture2D(e, f).rgb - 1.;\n}\nfloat j(vec2 f, float k) {\n  return fract(k);\n}\nfloat l(vec2 f, float k) {\n  float m = j(f, k);\n  return 1. - abs(1. - 2. * m);\n}\nvec3 n(sampler2D o, vec2 f, float k, float u) {\n  float v = waveParams[2];\n  float A = waveParams[3];\n  vec2 B = d(o, f) * v;\n  float m = j(f, k + u);\n  float C = l(f, k + u);\n  vec2 D = f;\n  D -= B * (m + A);\n  D += u;\n  D += (k - m) * c;\n  return vec3(D, C);\n}\nconst float E = .3737;\nconst float F = 7.77;\nvec3 G(sampler2D H, sampler2D I, vec2 f, vec2 J, float k) {\n  float K = waveParams[0];\n  vec2 L = k * -J;\n  float M = h(f * E) * F;\n  vec3 N = n(I, f + L, k + M, .0);\n  vec3 O = n(I, f + L, k + M, .5);\n  vec3 P = i(H, N.xy) * N.z;\n  vec3 Q = i(H, O.xy) * O.z;\n  vec3 R = normalize(P + Q);\n  R.xy *= K;\n  R.z = sqrt(1. - dot(R.xy, R.xy));\n  return R;\n}\nvec3 S(vec2 f, float k) {\n  float T = waveParams[1];\n  return G(texWaveNormal, texWavePerturbation, f * T, waveDirection, k);\n}\nconst float U = 3.141592653589793;\nconst float V = 1. / U;\nconst float W = .3183098861837907;\nconst float X = 1.570796326794897;\nstruct PBRShadingWater {\n  float NdotL;\n  float NdotV;\n  float NdotH;\n  float VdotH;\n  float LdotH;\n  float VdotN;\n};\nfloat Y = 2.2;\nvec3 Z(float ba, vec3 bb, float bc) {\n  return bb + (bc - bb) * pow(1. - ba, 5.);\n}\nfloat bd(float be, float bf) {\n  float bg = bf * bf;\n  float bh = be * be;\n  float bi = pow((bh * (bg - 1.) + 1.), Y) * U;\n  return bg / bi;\n}\nfloat bj(float bk) {\n  return .25 / (bk * bk);\n}\nvec3 bl(in PBRShadingWater bm, float bf, vec3 bn, float bo) {\n  vec3 bp = Z(bm.VdotH, bn, bo);\n  float bq = bd(bm.NdotH, bf);\n  float br = bj(bm.LdotH);\n  return (bq * br) * bp;\n}\nvec3 bs(const vec3 x) {\n  return (x * (2.51 * x + .03)) / (x * (2.43 * x + .59) + .14);\n}\nconst float bt = 2.2;\nconst float bu = .4545454545;\nvec4 bv(vec4 bw) {\n  return vec4(pow(bw.rgb, vec3(bu)), bw.w);\n}\nvec3 bx(vec3 bw) {\n  return pow(bw, vec3(bt));\n}\nconst vec3 by = vec3(.02, 1., 5.);\nconst vec2 bz = vec2(.02, .1);\nconst float bf = .06;\nconst vec3 bA = vec3(0, .6, .9);\nconst vec3 bB = vec3(.72, .92, 1.);\nPBRShadingWater bC;\nvec3 bD(in float bE, in vec3 bF, in vec3 bG) {\n  float bH = pow((1. - bE), by[2]);\n  return mix(bG, bF, bH);\n}\nvec3 bI(in vec3 bJ, in vec3 bK, in vec3 bL, vec3 bw, in vec3 bM, in vec3 bN, in float bO) {\n  vec3 bP = bx(bw);\n  vec3 bQ = normalize(bL + bK);\n  bC.NdotL = clamp(dot(bJ, bL), .0, 1.);\n  bC.NdotV = clamp(dot(bJ, bK), .001, 1.);\n  bC.VdotN = clamp(dot(bK, bJ), .001, 1.);\n  bC.NdotH = clamp(dot(bJ, bQ), .0, 1.);\n  bC.VdotH = clamp(dot(bK, bQ), .0, 1.);\n  bC.LdotH = clamp(dot(bL, bQ), .0, 1.);\n  float bR = max(dot(bN, bK), .0);\n  vec3 bS = bx(bB);\n  vec3 bT = bx(bA);\n  vec3 bB = bD(bR, bS, bT);\n  float bU = max(dot(bN, bL), .0);\n  bB *= .1 + bU * .9;\n  float bV = clamp(bO, .8, 1.);\n  vec3 bW = Z(bC.VdotN, vec3(by[0]), by[1]) * bB * bV;\n  vec3 bX = bP * mix(bB, bU * bM * V, 2. / 3.) * bV;\n  vec3 bY = vec3(.0);\n  if(bR > .0 && bU > .0) {\n    vec3 bZ = bl(bC, bf, vec3(bz[0]), bz[1]);\n    vec3 ca = bM * V * bO;\n    bY = bC.NdotL * ca * bZ;\n  }\n  return bs(bW + bX + bY);\n}\nvoid main() {\n  vec3 bN = vnormal;\n  vec3 cb = S(vuv, timeElapsed);\n  vec3 bJ = normalize(vtbnMatrix * cb);\n  vec3 bK = -normalize(vpos - camPos);\n  vec3 bL = normalize(-lightingDirection);\n  float bO = 1.;\n  vec4 cc = vec4(bI(bJ, bK, bL, waterColor.rgb, lightingIntensity, bN, bO), waterColor.w);\n  gl_FragColor = bv(cc);\n}",defines:e.defines||{},extraCommandProps:e.extraCommandProps||{}})}},WebGLConstants:Vw,WgslShaderLib:$w,WireFrameMaterial:class WireFrameMaterial extends Material{constructor(e){super(e,hw)}},WireframeShader:class WireframeShader extends MeshShader{constructor(e={}){let t=e.extraCommandProps||{};const n=[];t=px({},t,{blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"},sample:{alpha:!0}}),super({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nattribute vec3 aBarycentric;\nvarying vec3 vBarycentric;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projMatrix;\nuniform mat4 positionMatrix;\nvarying vec3 vPosition;\n#include <get_output>\nvoid main() {\n  mat4 c = getPositionMatrix();\n  vec4 d = getPosition(aPosition);\n#ifdef HAS_MASK_EXTENT\ngl_Position = projMatrix * getMaskPosition(c * d, modelMatrix);\n#else\ngl_Position = projMatrix * modelViewMatrix * c * d;\n#endif\nvBarycentric = aBarycentric;\n  vPosition = aPosition;\n}",frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec3 vBarycentric;\nuniform float time;\nuniform float thickness;\nuniform float secondThickness;\nuniform float dashRepeats;\nuniform float dashLength;\nuniform bool dashOverlap;\nuniform bool dashEnabled;\nuniform bool dashAnimate;\nuniform bool seeThrough;\nuniform bool insideAltColor;\nuniform bool dualStroke;\nuniform bool squeeze;\nuniform float squeezeMin;\nuniform float squeezeMax;\nuniform vec4 stroke;\nuniform vec4 fill;\nuniform float opacity;\nuniform bool noiseEnable;\nvarying vec3 vPosition;\n#ifdef HAS_INSTANCE\nvarying vec4 vInstanceColor;\n#endif\n#include <mask_frag>\n#define F4 0.309016994374947451\n#define halfDist 0.5\nvec4 c(vec4 x) {\n  return x - floor(x * (1. / 289.)) * 289.;\n}\nfloat c(float x) {\n  return x - floor(x * (1. / 289.)) * 289.;\n}\nvec4 d(vec4 x) {\n  return c((x * 34. + 1.) * x);\n}\nfloat d(float x) {\n  return c((x * 34. + 1.) * x);\n}\nvec4 e(vec4 r) {\n  return 1.79284291400159 - .85373472095314 * r;\n}\nfloat e(float r) {\n  return 1.79284291400159 - .85373472095314 * r;\n}\nvec4 f(float h, vec4 i) {\n  const vec4 k = vec4(1., 1., 1., -1.);\n  vec4 p, s;\n  p.xyz = floor(fract(vec3(h) * i.xyz) * 7.) * i.z - 1.;\n  p.w = 1.5 - dot(abs(p.xyz), k.xyz);\n  s = vec4(lessThan(p, vec4(.0)));\n  p.xyz = p.xyz + (s.xyz * 2. - 1.) * s.www;\n  return p;\n}\nfloat l(vec4 m) {\n  const vec4 n = vec4(.138196601125011, .276393202250021, .414589803375032, -.447213595499958);\n  vec4 o = floor(m + dot(m, vec4(F4)));\n  vec4 u = m - o + dot(o, n.xxxx);\n  vec4 A;\n  vec3 B = step(u.yzw, u.xxx);\n  vec3 D = step(u.zww, u.yyz);\n  A.x = B.x + B.y + B.z;\n  A.yzw = 1. - B;\n  A.y += D.x + D.y;\n  A.zw += 1. - D.xy;\n  A.z += D.z;\n  A.w += 1. - D.z;\n  vec4 E = clamp(A, .0, 1.);\n  vec4 F = clamp(A - 1., .0, 1.);\n  vec4 G = clamp(A - 2., .0, 1.);\n  vec4 H = u - G + n.xxxx;\n  vec4 I = u - F + n.yyyy;\n  vec4 J = u - E + n.zzzz;\n  vec4 K = u + n.wwww;\n  o = c(o);\n  float L = d(d(d(d(o.w) + o.z) + o.y) + o.x);\n  vec4 M = d(d(d(d(o.w + vec4(G.w, F.w, E.w, 1.)) + o.z + vec4(G.z, F.z, E.z, 1.)) + o.y + vec4(G.y, F.y, E.y, 1.)) + o.x + vec4(G.x, F.x, E.x, 1.));\n  vec4 i = vec4(1. / 294., 1. / 49., 1. / 7., .0);\n  vec4 N = f(L, i);\n  vec4 O = f(M.x, i);\n  vec4 P = f(M.y, i);\n  vec4 Q = f(M.z, i);\n  vec4 R = f(M.w, i);\n  vec4 S = e(vec4(dot(N, N), dot(O, O), dot(P, P), dot(Q, Q)));\n  N *= S.x;\n  O *= S.y;\n  P *= S.z;\n  Q *= S.w;\n  R *= e(dot(R, R));\n  vec3 T = max(.6 - vec3(dot(u, u), dot(H, H), dot(I, I)), .0);\n  vec2 U = max(.6 - vec2(dot(J, J), dot(K, K)), .0);\n  T = T * T;\n  U = U * U;\n  return 49. * (dot(T * T, vec3(dot(N, u), dot(O, H), dot(P, I))) + dot(U * U, vec2(dot(Q, J), dot(R, K))));\n}\nconst float V = 3.14159265359;\nfloat W(float X, float Y) {\n  float Z = fwidth(Y) * halfDist;\n  return smoothstep(X - Z, X + Z, Y);\n}\nvec4 ba(vec3 bb) {\n  float bc = min(min(bb.x, bb.y), bb.z);\n  float bd = .0;\n  if(noiseEnable)\n    bd += l(vec4(vPosition.xyz * 80.0, time * halfDist)) * .12;\n  bc += bd;\n  float be = max(bb.x, bb.y);\n  if(bb.y < bb.x && bb.y < bb.z) {\n    be = 1. - be;\n  }\n  float bf = thickness;\n  if(squeeze) {\n    bf *= mix(squeezeMin, squeezeMax, (1. - sin(be * V)));\n  }\n  if(dashEnabled) {\n    float bg = 1. / dashRepeats * dashLength / 2.;\n    if(!dashOverlap) {\n      bg += 1. / dashRepeats / 2.;\n    }\n    if(dashAnimate) {\n      bg += time * .22;\n    }\n    float bh = fract((be + bg) * dashRepeats);\n    bf *= 1. - W(dashLength, bh);\n  }\n  float bi = 1. - W(bf, bc);\n#ifdef HAS_INSTANCE\nvec4 bj = vInstanceColor;\n#else\nvec4 bj = stroke;\n#endif\nvec4 bk = vec4(.0);\n  if(seeThrough) {\n    bk = vec4(bj.xyz, bi);\n    if(insideAltColor && !gl_FrontFacing) {\n      bk.rgb = fill.xyz;\n    }\n  } else {\n    vec3 bl = mix(fill.xyz, bj.xyz, bi);\n    bk.a = fill.a;\n    if(dualStroke) {\n      float bm = 1. - W(secondThickness, bc);\n      vec3 bn = mix(fill.xyz, stroke.xyz, abs(bm - bi));\n      bk.rgb = bn;\n    } else {\n      bk.rgb = bl;\n    }\n  }\n  return bk;\n}\nvoid main() {\n  glFragColor = ba(vBarycentric);\n  glFragColor *= halfDist + opacity;\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:(e,t)=>vA(n,t.viewMatrix,t.modelMatrix)}],extraCommandProps:t}),this.version=300}},earcut:MM,glMatrix:Jm,mat2:tA,mat2d:iA,mat3:pA,mat4:UA,pbr:SM,quat:R_,quat2:B_,vec2:hv,vec3:vy,vec4:Yy});function PM(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var IM={exports:{}},kM={exports:{}},OM=function(e){return!(!e||"string"==typeof e)&&(e instanceof Array||Array.isArray(e)||e.length>=0&&(e.splice instanceof Function||Object.getOwnPropertyDescriptor(e,e.length-1)&&"String"!==e.constructor.name))},EM=Array.prototype.concat,RM=Array.prototype.slice,LM=kM.exports=function(e){for(var t=[],n=0,i=e.length;n<i;n++){var s=e[n];OM(s)?t=EM.call(t,RM.call(s)):t.push(s)}return t};LM.wrap=function(e){return function(){return e(LM(arguments))}};var DM={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},FM=kM.exports,HM=Object.hasOwnProperty,NM=Object.create(null);for(var BM in DM)HM.call(DM,BM)&&(NM[DM[BM]]=BM);var zM=IM.exports={to:{},get:{}};function GM(e,t,n){return Math.min(Math.max(t,e),n)}function UM(e){var t=Math.round(e).toString(16).toUpperCase();return t.length<2?"0"+t:t}zM.get=function(e){var t,n;switch(e.substring(0,3).toLowerCase()){case"hsl":t=zM.get.hsl(e),n="hsl";break;case"hwb":t=zM.get.hwb(e),n="hwb";break;default:t=zM.get.rgb(e),n="rgb"}return t?{model:n,value:t}:null},zM.get.rgb=function(e){if(!e)return null;var t,n,i,s=[0,0,0,1];if(t=e.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(i=t[2],t=t[1],n=0;n<3;n++){var o=2*n;s[n]=parseInt(t.slice(o,o+2),16)}i&&(s[3]=parseInt(i,16)/255)}else if(t=e.match(/^#([a-f0-9]{3,4})$/i)){for(i=(t=t[1])[3],n=0;n<3;n++)s[n]=parseInt(t[n]+t[n],16);i&&(s[3]=parseInt(i+i,16)/255)}else if(t=e.match(/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)){for(n=0;n<3;n++)s[n]=parseInt(t[n+1],0);t[4]&&(s[3]=t[5]?.01*parseFloat(t[4]):parseFloat(t[4]))}else{if(!(t=e.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)))return(t=e.match(/^(\w+)$/))?"transparent"===t[1]?[0,0,0,0]:HM.call(DM,t[1])?((s=DM[t[1]])[3]=1,s):null:null;for(n=0;n<3;n++)s[n]=Math.round(2.55*parseFloat(t[n+1]));t[4]&&(s[3]=t[5]?.01*parseFloat(t[4]):parseFloat(t[4]))}for(n=0;n<3;n++)s[n]=GM(s[n],0,255);return s[3]=GM(s[3],0,1),s},zM.get.hsl=function(e){if(!e)return null;var t=e.match(/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(t){var n=parseFloat(t[4]);return[(parseFloat(t[1])%360+360)%360,GM(parseFloat(t[2]),0,100),GM(parseFloat(t[3]),0,100),GM(isNaN(n)?1:n,0,1)]}return null},zM.get.hwb=function(e){if(!e)return null;var t=e.match(/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(t){var n=parseFloat(t[4]);return[(parseFloat(t[1])%360+360)%360,GM(parseFloat(t[2]),0,100),GM(parseFloat(t[3]),0,100),GM(isNaN(n)?1:n,0,1)]}return null},zM.to.hex=function(){var e=FM(arguments);return"#"+UM(e[0])+UM(e[1])+UM(e[2])+(e[3]<1?UM(Math.round(255*e[3])):"")},zM.to.rgb=function(){var e=FM(arguments);return e.length<4||1===e[3]?"rgb("+Math.round(e[0])+", "+Math.round(e[1])+", "+Math.round(e[2])+")":"rgba("+Math.round(e[0])+", "+Math.round(e[1])+", "+Math.round(e[2])+", "+e[3]+")"},zM.to.rgb.percent=function(){var e=FM(arguments),t=Math.round(e[0]/255*100),n=Math.round(e[1]/255*100),i=Math.round(e[2]/255*100);return e.length<4||1===e[3]?"rgb("+t+"%, "+n+"%, "+i+"%)":"rgba("+t+"%, "+n+"%, "+i+"%, "+e[3]+")"},zM.to.hsl=function(){var e=FM(arguments);return e.length<4||1===e[3]?"hsl("+e[0]+", "+e[1]+"%, "+e[2]+"%)":"hsla("+e[0]+", "+e[1]+"%, "+e[2]+"%, "+e[3]+")"},zM.to.hwb=function(){var e=FM(arguments),t="";return e.length>=4&&1!==e[3]&&(t=", "+e[3]),"hwb("+e[0]+", "+e[1]+"%, "+e[2]+"%"+t+")"},zM.to.keyword=function(e){return NM[e.slice(0,3)]};var VM=IM.exports,jM={exports:{}},WM={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},qM={};for(var ZM in WM)WM.hasOwnProperty(ZM)&&(qM[WM[ZM]]=ZM);var XM=jM.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var YM in XM)if(XM.hasOwnProperty(YM)){if(!("channels"in XM[YM]))throw new Error("missing channels property: "+YM);if(!("labels"in XM[YM]))throw new Error("missing channel labels property: "+YM);if(XM[YM].labels.length!==XM[YM].channels)throw new Error("channel and label counts mismatch: "+YM);var JM=XM[YM].channels,QM=XM[YM].labels;delete XM[YM].channels,delete XM[YM].labels,Object.defineProperty(XM[YM],"channels",{value:JM}),Object.defineProperty(XM[YM],"labels",{value:QM})}function $M(e,t){return Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2)}XM.rgb.hsl=function(e){var t,n,i=e[0]/255,s=e[1]/255,o=e[2]/255,a=Math.min(i,s,o),l=Math.max(i,s,o),h=l-a;return l===a?t=0:i===l?t=(s-o)/h:s===l?t=2+(o-i)/h:o===l&&(t=4+(i-s)/h),(t=Math.min(60*t,360))<0&&(t+=360),n=(a+l)/2,[t,100*(l===a?0:n<=.5?h/(l+a):h/(2-l-a)),100*n]},XM.rgb.hsv=function(e){var t,n,i,s,o,a=e[0]/255,l=e[1]/255,h=e[2]/255,c=Math.max(a,l,h),u=c-Math.min(a,l,h),f=function(e){return(c-e)/6/u+.5};return 0===u?s=o=0:(o=u/c,t=f(a),n=f(l),i=f(h),a===c?s=i-n:l===c?s=1/3+t-i:h===c&&(s=2/3+n-t),s<0?s+=1:s>1&&(s-=1)),[360*s,100*o,100*c]},XM.rgb.hwb=function(e){var t=e[0],n=e[1],i=e[2];return[XM.rgb.hsl(e)[0],100*(1/255*Math.min(t,Math.min(n,i))),100*(i=1-1/255*Math.max(t,Math.max(n,i)))]},XM.rgb.cmyk=function(e){var t,n=e[0]/255,i=e[1]/255,s=e[2]/255;return[100*((1-n-(t=Math.min(1-n,1-i,1-s)))/(1-t)||0),100*((1-i-t)/(1-t)||0),100*((1-s-t)/(1-t)||0),100*t]},XM.rgb.keyword=function(e){var t=qM[e];if(t)return t;var n,i=1/0;for(var s in WM)if(WM.hasOwnProperty(s)){var o=$M(e,WM[s]);o<i&&(i=o,n=s)}return n},XM.keyword.rgb=function(e){return WM[e]},XM.rgb.xyz=function(e){var t=e[0]/255,n=e[1]/255,i=e[2]/255;return[100*(.4124*(t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92)),100*(.2126*t+.7152*n+.0722*i),100*(.0193*t+.1192*n+.9505*i)]},XM.rgb.lab=function(e){var t=XM.rgb.xyz(e),n=t[0],i=t[1],s=t[2];return i/=100,s/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116)-16,500*(n-i),200*(i-(s=s>.008856?Math.pow(s,1/3):7.787*s+16/116))]},XM.hsl.rgb=function(e){var t,n,i,s,o,a=e[0]/360,l=e[1]/100,h=e[2]/100;if(0===l)return[o=255*h,o,o];t=2*h-(n=h<.5?h*(1+l):h+l-h*l),s=[0,0,0];for(var c=0;c<3;c++)(i=a+1/3*-(c-1))<0&&i++,i>1&&i--,s[c]=255*(o=6*i<1?t+6*(n-t)*i:2*i<1?n:3*i<2?t+(n-t)*(2/3-i)*6:t);return s},XM.hsl.hsv=function(e){var t=e[0],n=e[1]/100,i=e[2]/100,s=n,o=Math.max(i,.01);return n*=(i*=2)<=1?i:2-i,s*=o<=1?o:2-o,[t,100*(0===i?2*s/(o+s):2*n/(i+n)),100*((i+n)/2)]},XM.hsv.rgb=function(e){var t=e[0]/60,n=e[1]/100,i=e[2]/100,s=Math.floor(t)%6,o=t-Math.floor(t),a=255*i*(1-n),l=255*i*(1-n*o),h=255*i*(1-n*(1-o));switch(i*=255,s){case 0:return[i,h,a];case 1:return[l,i,a];case 2:return[a,i,h];case 3:return[a,l,i];case 4:return[h,a,i];case 5:return[i,a,l]}},XM.hsv.hsl=function(e){var t,n,i,s=e[0],o=e[1]/100,a=e[2]/100,l=Math.max(a,.01);return i=(2-o)*a,n=o*l,[s,100*(n=(n/=(t=(2-o)*l)<=1?t:2-t)||0),100*(i/=2)]},XM.hwb.rgb=function(e){var t,n,i,s,o,a,l,h=e[0]/360,c=e[1]/100,u=e[2]/100,f=c+u;switch(f>1&&(c/=f,u/=f),i=6*h-(t=Math.floor(6*h)),1&t&&(i=1-i),s=c+i*((n=1-u)-c),t){default:case 6:case 0:o=n,a=s,l=c;break;case 1:o=s,a=n,l=c;break;case 2:o=c,a=n,l=s;break;case 3:o=c,a=s,l=n;break;case 4:o=s,a=c,l=n;break;case 5:o=n,a=c,l=s}return[255*o,255*a,255*l]},XM.cmyk.rgb=function(e){var t=e[1]/100,n=e[2]/100,i=e[3]/100;return[255*(1-Math.min(1,e[0]/100*(1-i)+i)),255*(1-Math.min(1,t*(1-i)+i)),255*(1-Math.min(1,n*(1-i)+i))]},XM.xyz.rgb=function(e){var t,n,i,s=e[0]/100,o=e[1]/100,a=e[2]/100;return n=-.9689*s+1.8758*o+.0415*a,i=.0557*s+-.204*o+1.057*a,t=(t=3.2406*s+-1.5372*o+-.4986*a)>.0031308?1.055*Math.pow(t,1/2.4)-.055:12.92*t,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,i=i>.0031308?1.055*Math.pow(i,1/2.4)-.055:12.92*i,[255*(t=Math.min(Math.max(0,t),1)),255*(n=Math.min(Math.max(0,n),1)),255*(i=Math.min(Math.max(0,i),1))]},XM.xyz.lab=function(e){var t=e[0],n=e[1],i=e[2];return n/=100,i/=108.883,t=(t/=95.047)>.008856?Math.pow(t,1/3):7.787*t+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(t-n),200*(n-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},XM.lab.xyz=function(e){var t,n,i;t=e[1]/500+(n=(e[0]+16)/116),i=n-e[2]/200;var s=Math.pow(n,3),o=Math.pow(t,3),a=Math.pow(i,3);return n=s>.008856?s:(n-16/116)/7.787,t=o>.008856?o:(t-16/116)/7.787,i=a>.008856?a:(i-16/116)/7.787,[t*=95.047,n*=100,i*=108.883]},XM.lab.lch=function(e){var t,n=e[0],i=e[1],s=e[2];return(t=360*Math.atan2(s,i)/2/Math.PI)<0&&(t+=360),[n,Math.sqrt(i*i+s*s),t]},XM.lch.lab=function(e){var t,n=e[1];return t=e[2]/360*2*Math.PI,[e[0],n*Math.cos(t),n*Math.sin(t)]},XM.rgb.ansi16=function(e){var t=e[0],n=e[1],i=e[2],s=1 in arguments?arguments[1]:XM.rgb.hsv(e)[2];if(0===(s=Math.round(s/50)))return 30;var o=30+(Math.round(i/255)<<2|Math.round(n/255)<<1|Math.round(t/255));return 2===s&&(o+=60),o},XM.hsv.ansi16=function(e){return XM.rgb.ansi16(XM.hsv.rgb(e),e[2])},XM.rgb.ansi256=function(e){var t=e[0],n=e[1],i=e[2];return t===n&&n===i?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(n/255*5)+Math.round(i/255*5)},XM.ansi16.rgb=function(e){var t=e%10;if(0===t||7===t)return e>50&&(t+=3.5),[t=t/10.5*255,t,t];var n=.5*(1+~~(e>50));return[(1&t)*n*255,(t>>1&1)*n*255,(t>>2&1)*n*255]},XM.ansi256.rgb=function(e){if(e>=232){var t=10*(e-232)+8;return[t,t,t]}var n;return e-=16,[Math.floor(e/36)/5*255,Math.floor((n=e%36)/6)/5*255,n%6/5*255]},XM.rgb.hex=function(e){var t=(((255&Math.round(e[0]))<<16)+((255&Math.round(e[1]))<<8)+(255&Math.round(e[2]))).toString(16).toUpperCase();return"000000".substring(t.length)+t},XM.hex.rgb=function(e){var t=e.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!t)return[0,0,0];var n=t[0];3===t[0].length&&(n=n.split("").map((function(e){return e+e})).join(""));var i=parseInt(n,16);return[i>>16&255,i>>8&255,255&i]},XM.rgb.hcg=function(e){var t,n=e[0]/255,i=e[1]/255,s=e[2]/255,o=Math.max(Math.max(n,i),s),a=Math.min(Math.min(n,i),s),l=o-a;return t=l<=0?0:o===n?(i-s)/l%6:o===i?2+(s-n)/l:4+(n-i)/l+4,t/=6,[360*(t%=1),100*l,100*(l<1?a/(1-l):0)]},XM.hsl.hcg=function(e){var t=e[1]/100,n=e[2]/100,i=1,s=0;return(i=n<.5?2*t*n:2*t*(1-n))<1&&(s=(n-.5*i)/(1-i)),[e[0],100*i,100*s]},XM.hsv.hcg=function(e){var t=e[2]/100,n=e[1]/100*t,i=0;return n<1&&(i=(t-n)/(1-n)),[e[0],100*n,100*i]},XM.hcg.rgb=function(e){var t=e[1]/100,n=e[2]/100;if(0===t)return[255*n,255*n,255*n];var i,s=[0,0,0],o=e[0]/360%1*6,a=o%1,l=1-a;switch(Math.floor(o)){case 0:s[0]=1,s[1]=a,s[2]=0;break;case 1:s[0]=l,s[1]=1,s[2]=0;break;case 2:s[0]=0,s[1]=1,s[2]=a;break;case 3:s[0]=0,s[1]=l,s[2]=1;break;case 4:s[0]=a,s[1]=0,s[2]=1;break;default:s[0]=1,s[1]=0,s[2]=l}return[255*(t*s[0]+(i=(1-t)*n)),255*(t*s[1]+i),255*(t*s[2]+i)]},XM.hcg.hsv=function(e){var t=e[1]/100,n=t+e[2]/100*(1-t),i=0;return n>0&&(i=t/n),[e[0],100*i,100*n]},XM.hcg.hsl=function(e){var t=e[1]/100,n=e[2]/100*(1-t)+.5*t,i=0;return n>0&&n<.5?i=t/(2*n):n>=.5&&n<1&&(i=t/(2*(1-n))),[e[0],100*i,100*n]},XM.hcg.hwb=function(e){var t=e[1]/100,n=t+e[2]/100*(1-t);return[e[0],100*(n-t),100*(1-n)]},XM.hwb.hcg=function(e){var t=1-e[2]/100,n=t-e[1]/100,i=0;return n<1&&(i=(t-n)/(1-n)),[e[0],100*n,100*i]},XM.apple.rgb=function(e){return[e[0]/65535*255,e[1]/65535*255,e[2]/65535*255]},XM.rgb.apple=function(e){return[e[0]/255*65535,e[1]/255*65535,e[2]/255*65535]},XM.gray.rgb=function(e){return[e[0]/100*255,e[0]/100*255,e[0]/100*255]},XM.gray.hsl=XM.gray.hsv=function(e){return[0,0,e[0]]},XM.gray.hwb=function(e){return[0,100,e[0]]},XM.gray.cmyk=function(e){return[0,0,0,e[0]]},XM.gray.lab=function(e){return[e[0],0,0]},XM.gray.hex=function(e){var t=255&Math.round(e[0]/100*255),n=((t<<16)+(t<<8)+t).toString(16).toUpperCase();return"000000".substring(n.length)+n},XM.rgb.gray=function(e){return[(e[0]+e[1]+e[2])/3/255*100]};var KM=jM.exports,eC=KM;function tC(e){var t=function(){for(var e={},t=Object.keys(eC),n=t.length,i=0;i<n;i++)e[t[i]]={distance:-1,parent:null};return e}(),n=[e];for(t[e].distance=0;n.length;)for(var i=n.pop(),s=Object.keys(eC[i]),o=s.length,a=0;a<o;a++){var l=s[a],h=t[l];-1===h.distance&&(h.distance=t[i].distance+1,h.parent=i,n.unshift(l))}return t}function nC(e,t){return function(n){return t(e(n))}}function rC(e,t){for(var n=[t[e].parent,e],i=eC[t[e].parent][e],s=t[e].parent;t[s].parent;)n.unshift(t[s].parent),i=nC(eC[t[s].parent][s],i),s=t[s].parent;return i.conversion=n,i}var iC=KM,sC=function(e){for(var t=tC(e),n={},i=Object.keys(t),s=i.length,o=0;o<s;o++){var a=i[o];null!==t[a].parent&&(n[a]=rC(a,t))}return n},oC={};Object.keys(iC).forEach((function(e){oC[e]={},Object.defineProperty(oC[e],"channels",{value:iC[e].channels}),Object.defineProperty(oC[e],"labels",{value:iC[e].labels});var t=sC(e);Object.keys(t).forEach((function(n){var i=t[n];oC[e][n]=function(e){var t=function(t){if(null==t)return t;arguments.length>1&&(t=Array.prototype.slice.call(arguments));var n=e(t);if("object"==typeof n)for(var i=n.length,s=0;s<i;s++)n[s]=Math.round(n[s]);return n};return"conversion"in e&&(t.conversion=e.conversion),t}(i),oC[e][n].raw=function(e){var t=function(t){return null==t?t:(arguments.length>1&&(t=Array.prototype.slice.call(arguments)),e(t))};return"conversion"in e&&(t.conversion=e.conversion),t}(i)}))}));var aC=VM,lC=oC,hC=[].slice,cC=["keyword","gray","hex"],uC={};Object.keys(lC).forEach((function(e){uC[hC.call(lC[e].labels).sort().join("")]=e}));var fC={};function dC(e,t){if(!(this instanceof dC))return new dC(e,t);if(t&&t in cC&&(t=null),t&&!(t in lC))throw new Error("Unknown model: "+t);var n,i;if(null==e)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(e instanceof dC)this.model=e.model,this.color=e.color.slice(),this.valpha=e.valpha;else if("string"==typeof e){var s=aC.get(e);if(null===s)throw new Error("Unable to parse color from string: "+e);this.model=s.model,this.color=s.value.slice(0,i=lC[this.model].channels),this.valpha="number"==typeof s.value[i]?s.value[i]:1}else if(e.length){this.model=t||"rgb";var o=hC.call(e,0,i=lC[this.model].channels);this.color=mC(o,i),this.valpha="number"==typeof e[i]?e[i]:1}else if("number"==typeof e)e&=16777215,this.model="rgb",this.color=[e>>16&255,e>>8&255,255&e],this.valpha=1;else{this.valpha=1;var a=Object.keys(e);"alpha"in e&&(a.splice(a.indexOf("alpha"),1),this.valpha="number"==typeof e.alpha?e.alpha:0);var l=a.sort().join("");if(!(l in uC))throw new Error("Unable to parse color from object: "+JSON.stringify(e));this.model=uC[l];var h=lC[this.model].labels,c=[];for(n=0;n<h.length;n++)c.push(e[h[n]]);this.color=mC(c)}if(fC[this.model])for(i=lC[this.model].channels,n=0;n<i;n++){var u=fC[this.model][n];u&&(this.color[n]=u(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function pC(e,t,n){return(e=Array.isArray(e)?e:[e]).forEach((function(e){(fC[e]||(fC[e]=[]))[t]=n})),e=e[0],function(i){var s;return arguments.length?(n&&(i=n(i)),(s=this[e]()).color[t]=i,s):(s=this[e]().color[t],n&&(s=n(s)),s)}}function gC(e){return function(t){return Math.max(0,Math.min(e,t))}}function mC(e,t){for(var n=0;n<t;n++)"number"!=typeof e[n]&&(e[n]=0);return e}dC.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(e){var t=this.model in aC.to?this:this.rgb(),n=1===(t=t.round("number"==typeof e?e:1)).valpha?t.color:t.color.concat(this.valpha);return aC.to[t.model](n)},percentString:function(e){var t=this.rgb().round("number"==typeof e?e:1),n=1===t.valpha?t.color:t.color.concat(this.valpha);return aC.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var e={},t=lC[this.model].channels,n=lC[this.model].labels,i=0;i<t;i++)e[n[i]]=this.color[i];return 1!==this.valpha&&(e.alpha=this.valpha),e},unitArray:function(){var e=this.rgb().color;return e[0]/=255,e[1]/=255,e[2]/=255,1!==this.valpha&&e.push(this.valpha),e},unitObject:function(){var e=this.rgb().object();return e.r/=255,e.g/=255,e.b/=255,1!==this.valpha&&(e.alpha=this.valpha),e},round:function(e){return e=Math.max(e||0,0),new dC(this.color.map(function(e){return function(t){return function(e,t){return Number(e.toFixed(t))}(t,e)}}(e)).concat(this.valpha),this.model)},alpha:function(e){return arguments.length?new dC(this.color.concat(Math.max(0,Math.min(1,e))),this.model):this.valpha},red:pC("rgb",0,gC(255)),green:pC("rgb",1,gC(255)),blue:pC("rgb",2,gC(255)),hue:pC(["hsl","hsv","hsl","hwb","hcg"],0,(function(e){return(e%360+360)%360})),saturationl:pC("hsl",1,gC(100)),lightness:pC("hsl",2,gC(100)),saturationv:pC("hsv",1,gC(100)),value:pC("hsv",2,gC(100)),chroma:pC("hcg",1,gC(100)),gray:pC("hcg",2,gC(100)),white:pC("hwb",1,gC(100)),wblack:pC("hwb",2,gC(100)),cyan:pC("cmyk",0,gC(100)),magenta:pC("cmyk",1,gC(100)),yellow:pC("cmyk",2,gC(100)),black:pC("cmyk",3,gC(100)),x:pC("xyz",0,gC(100)),y:pC("xyz",1,gC(100)),z:pC("xyz",2,gC(100)),l:pC("lab",0,gC(100)),a:pC("lab",1),b:pC("lab",2),keyword:function(e){return arguments.length?new dC(e):lC[this.model].keyword(this.color)},hex:function(e){return arguments.length?new dC(e):aC.to.hex(this.rgb().round().color)},rgbNumber:function(){var e=this.rgb().color;return(255&e[0])<<16|(255&e[1])<<8|255&e[2]},luminosity:function(){for(var e=this.rgb().color,t=[],n=0;n<e.length;n++){var i=e[n]/255;t[n]=i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4)}return.2126*t[0]+.7152*t[1]+.0722*t[2]},contrast:function(e){var t=this.luminosity(),n=e.luminosity();return t>n?(t+.05)/(n+.05):(n+.05)/(t+.05)},level:function(e){var t=this.contrast(e);return t>=7.1?"AAA":t>=4.5?"AA":""},isDark:function(){var e=this.rgb().color;return(299*e[0]+587*e[1]+114*e[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var e=this.rgb(),t=0;t<3;t++)e.color[t]=255-e.color[t];return e},lighten:function(e){var t=this.hsl();return t.color[2]+=t.color[2]*e,t},darken:function(e){var t=this.hsl();return t.color[2]-=t.color[2]*e,t},saturate:function(e){var t=this.hsl();return t.color[1]+=t.color[1]*e,t},desaturate:function(e){var t=this.hsl();return t.color[1]-=t.color[1]*e,t},whiten:function(e){var t=this.hwb();return t.color[1]+=t.color[1]*e,t},blacken:function(e){var t=this.hwb();return t.color[2]+=t.color[2]*e,t},grayscale:function(){var e=this.rgb().color,t=.3*e[0]+.59*e[1]+.11*e[2];return dC.rgb(t,t,t)},fade:function(e){return this.alpha(this.valpha-this.valpha*e)},opaquer:function(e){return this.alpha(this.valpha+this.valpha*e)},rotate:function(e){var t=this.hsl(),n=t.color[0];return t.color[0]=n=(n=(n+e)%360)<0?360+n:n,t},mix:function(e,t){if(!e||!e.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof e);var n=e.rgb(),i=this.rgb(),s=void 0===t?.5:t,o=2*s-1,a=n.alpha()-i.alpha(),l=((o*a==-1?o:(o+a)/(1+o*a))+1)/2,h=1-l;return dC.rgb(l*n.red()+h*i.red(),l*n.green()+h*i.green(),l*n.blue()+h*i.blue(),n.alpha()*s+i.alpha()*(1-s))}},Object.keys(lC).forEach((function(e){if(-1===cC.indexOf(e)){var t=lC[e].channels;dC.prototype[e]=function(){if(this.model===e)return new dC(this);if(arguments.length)return new dC(arguments,e);var n,i="number"==typeof arguments[t]?t:this.valpha;return new dC((n=lC[this.model][e].raw(this.color),Array.isArray(n)?n:[n]).concat(i),e)},dC[e]=function(n){return"number"==typeof n&&(n=mC(hC.call(arguments),t)),new dC(n,e)}}}));var AC=PM(dC);const yC="function"==typeof Object.assign,_C=[];function vC(e){if(yC)Object.assign.apply(Object,arguments);else for(let t=1;t<arguments.length;t++){const n=arguments[t];for(const t in n)e[t]=n[t]}return e}function xC(e){return null==e}function bC(e){return"number"==typeof e&&!isNaN(e)}function wC(e){return!xC(e)&&("function"==typeof e||null!==e.constructor&&e.constructor===Function)}const TC=[];function SC(e,t){const n=t._get2DExtentAtRes(t.getGLRes()),i=n.getWidth(),s=n.getHeight(),o=e;AA(o);const a=qA(_C,t.cameraLookAt);return a[2]=0,xA(o,o,a),bA(o,o,ZA(TC,i,s,1)),o}function MC(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function CC(e){for(let t=1;t<arguments.length;t++){const n=arguments[t];if(n)for(let t=0,i=n.length;t<i;t++)e.push(n[t])}return e.length}const PC={};function IC(e,t){if(!Array.isArray(t)){t=PC[t]=PC[t]||AC(t).unitArray()}for(let n=0;n<t.length;n++)e[n]=t[n];return 3===t.length&&(e[3]=1),e}function kC(e,t){if(!Array.isArray(t)){t=PC[t]=PC[t]||AC(t).unitArray()}for(let n=0;n<t.length;n++)e[n]=255*t[n];return 3===e.length&&e.push(255),e}function OC(e,t,n=0){if(!(e&&t instanceof fl))return null;const i=e.coordinateToPointAtRes(t,e.getGLRes());return[i.x,i.y,n]}const EC=[0,0],RC=[0,0,0];let LC;class ShadowProcess{static getUniformDeclares(){const e=[],t=[];return t.push({name:"shadow_lightProjViewModelMatrix",type:"function",fn:function(t,n){return vA(e,n.shadow_lightProjViewMatrix,n.modelMatrix)}}),t}constructor(e,t){this.renderer=new Renderer(e),this._esmShadowThreshold=.3,this._layer=t,this._init()}resize(){const e=this.canvas;e.width=this._layer.getRenderer().canvas.width,e.height=this._layer.getRenderer().canvas.height}_init(){const e=(this._layer._getSceneConfig()||{}).shadow||{},t=this._getShadowRes(),n=this.getDefines();this._shadowPass=new ShadowPass(this.renderer,{width:t,height:t,blurOffset:e.blurOffset,defines:n}),this._shadowDisplayShader=new ShadowDisplayShader(n),this._createGround()}_getShadowRes(){let e=2048;const t=((this._layer._getSceneConfig()||{}).shadow||{}).quality;return"medium"===t?e=1024:"low"===t&&(e=512),e}getDefines(){return{HAS_SHADOWING:1,PACK_FLOAT:1,USE_ESM:1}}render(e,t,n,i,s,o,a,l,h,c){this._transformGround();const u=this._layer.getMap(),f=this._getShadowRes();let g,m;if(c||f!==this._shadowPass.width||this._shadowChanged(u,a,!!e)){f!==this._shadowPass.width&&this._shadowPass.resize(f,f),this._tempMat0=this._tempMat0||[],this._tempMat1=this._tempMat1||[];const i=vA(this._tempMat0,t,n),s=ry(this._tempMat1,o);LC||(LC=u.getContainerExtent());let l=u.height;u.getPitch()>62&&(l=u._getVisualHeight(62));const h=LC.set(0,u.height-l,u.width,u.height).convertTo((e=>u._containerPointToPointAtRes(e,u.getGLRes()))),c=h.toArray();e&&a.addMesh(this._ground);const A=c.map((e=>[e.x,e.y,0,1])),{lightProjViewMatrix:w,shadowMap:T,blurFBO:S}=this._shadowPass.render(a,{cameraProjViewMatrix:i,lightDir:s,farPlane:A,cameraLookAt:u.cameraLookAt});g=this._lightProjViewMatrix=w,m=this._shadowMap=T,this._blurFBO=S,this._renderedShadows=a.getMeshes().reduce(((e,t)=>(t.castShadow&&t.geometry&&(e[t.uuid]={v0:t.version,v1:t.geometry.version}),e)),{}),this._renderedView={count:a.getMeshes().length-+!!e,displayShadow:!!e},this._updated=!0}else g=this._lightProjViewMatrix,m=this._shadowMap,this._updated=!1;this._projMatrix=t,this._viewMatrix=n,xC(s)&&(s=1),e&&a.getMeshes().length&&this.displayShadow(i,s,l,h);return{shadow_lightProjViewMatrix:g,shadow_shadowMap:m,shadow_opacity:s,shadow_color:i||RC,esm_shadow_threshold:this._esmShadowThreshold}}displayShadow(e,t,n,i){const s=this._lightProjViewMatrix,o=this._ground,a=this._groundLightProjViewModelMatrix||[],l=this._layer.getRenderer().canvas,h=this._texSize=this._texSize||[];h[0]=l.width,h[1]=l.height,this.renderer.render(this._shadowDisplayShader,{halton:n||EC,globalTexSize:h,projMatrix:this._projMatrix,viewMatrix:this._viewMatrix,shadow_lightProjViewModelMatrix:vA(a,s,o.localTransform),shadow_shadowMap:this._shadowMap,esm_shadow_threshold:this._esmShadowThreshold,shadow_opacity:t,color:e||RC},this._groundScene,i)}dispose(){this._shadowPass.dispose(),this._shadowDisplayShader.dispose(),this._ground&&(this._ground.geometry.dispose(),this._ground.dispose()),delete this.renderer}isUpdated(){return!1!==this._updated}_shadowChanged(e,t,n){if(!this._renderedShadows)return!0;const i=this._renderedView;if(t.getMeshes().length!==i.count||n!==i.displayShadow)return!0;const s=t.getMeshes();for(let e=0;e<s.length;e++){const t=this._renderedShadows[s[e].uuid];if(s[e].castShadow&&(s[e].hasSkinAnimation()||!t||t.v0!==s[e].version||t.v1!==s[e].geometry.version))return!0}return!1}_createGround(){const e=new Plane;e.generateBuffers(this.renderer.device),this._ground=new Mesh(e),this._groundScene=new Scene([this._ground])}_transformGround(){const e=this._layer.getMap(),t=SC(this._ground.localTransform,e);this._ground.setLocalTransform(t)}}const DC=[0,0],FC=new fl(0,0),HC=new fl(0,0),NC=[],BC=[],zC=[];function GC(e,t,n,i){const s=e.getGLRes(),o=e.distanceToPointAtRes(t,t,s,n?FC:null,HC);return i?o.y:o.x}const{getIBLResOnCanvas:UC,logoutIBLResOnCanvas:VC,getPBRUniforms:jC,loginIBLResOnCanvas:WC}=SM.PBRUtils,qC=[0,0],ZC=[1,1],XC=[],YC=[],JC=[],QC=[],$C=[];class GroundPainter{static getGroundTransform(e,t){return SC(e,t)}constructor(e,t){this._regl=e,this.renderer=new Renderer(e),this._layer=t,this._loader=new ResourceLoader(null),this._bindOnMaterialComplete=(...e)=>this._onMaterialComplete.call(this,...e),this._init();const n=this.getMap().getRenderer().canvas;WC(n,e,this.getMap())}needToRedraw(){const e=this._getUVOffsetAnim();return e&&(e[0]||e[1])}getMap(){return this._layer&&this._layer.getMap()}getSymbol(){const e=this._layer.getGroundConfig();return e&&e.symbol}isEnable(){const e=this._layer.getGroundConfig();return e&&e.enable}paint(e){if(!this.isEnable())return!1;const t=this._getShader();if(this._isInSSRPhase(e)&&t===this._fillShader)return!1;const n=this._getGroundDefines(e);n&&this._ground.setDefines(n),this._ground.material!==this.material&&this._ground.setMaterial(this.material);const i=this._layer.getGroundConfig();this._ground.ssr=(i&&i.symbol).ssr?1:0,this._transformGround();const s=this._getUniformValues(e);s.offsetFactor=e.offsetFactor,s.offsetUnits=e.offsetUnits;const o=e&&e.renderTarget&&e.renderTarget.fbo,a=this._layer.getRenderer();return t===this._fillShader?(this.renderer.render(t,s,this._groundScene,o),a.setCanvasUpdated&&a.setCanvasUpdated(),!0):(t.filter=e.sceneFilter,this.renderer.render(t,s,this._groundScene,o),a.setCanvasUpdated&&a.setCanvasUpdated(),!0)}_isInSSRPhase(e){return!(!this._layer.getRenderer().isEnableSSR||!this._layer.getRenderer().isEnableSSR())&&!(!e||!e.ssr)}update(){const e=this._layer.getGroundConfig();if(!e)return;const t=e&&e.symbol,n=e.urlModifier;if(t){this._polygonFill=this._parseColor(t.polygonFill||[1,1,1,1]),this._polygonOpacity=void 0===t.polygonOpacity?1:t.polygonOpacity;const e=t.polygonPatternFile;if(e){if(!this._polygonPatternFile||this._polygonPatternFile._pattern_src!==e){const t=new Image;t.onload=()=>{this._polygonPatternFile&&this._polygonPatternFile.destroy(),this._polygonPatternFile=this._createPatternTexture(t),this._polygonPatternFile._pattern_src=e,this.setToRedraw()},t.src=n&&n(e)||e}}else this._polygonPatternFile&&(this._polygonPatternFile.destroy(),delete this._polygonPatternFile)}else this._polygonFill=[1,1,1,1],this._polygonOpacity=1,this._polygonPatternFile&&(this._polygonPatternFile.destroy(),delete this._polygonPatternFile);this._updateMaterial()}setToRedraw(){const e=this._layer.getRenderer();e&&e.setToRedraw()}dispose(){this.material&&(this.material.dispose(),delete this.material),this._ground&&(this._ground.geometry.dispose(),this._ground.material&&this._ground.material.dispose(),this._ground.dispose(),delete this._ground),this._polygonPatternFile&&(this._polygonPatternFile.destroy(),delete this._polygonPatternFile),this._fillShader&&(this._fillShader.dispose(),delete this._fillShader),this._standardShader&&(this._standardShader.dispose(),delete this._standardShader),this._disposeIblTextures()}_getShader(){const e=this._layer.getGroundConfig();if(!e||!e.renderPlugin)return this._fillShader;const t=e.renderPlugin.type;if("lit"===t)return this._standardShader;if("fill"===t)return this._fillShader;throw new Error("unsupported render plugin of "+t+" for layer ground")}_getUniformValues(e){const t=this._getCommonUniforms(e);t.polygonFill=this._polygonFill,t.polygonOpacity=this._polygonOpacity;return this._getShader()===this._fillShader&&this._polygonPatternFile&&(t.polygonPatternFile=this._polygonPatternFile),t}_getCommonUniforms(e){let t;if("lit"===this._layer.getGroundConfig().renderPlugin.type){const n=this.getMap().getRenderer().canvas,{iblTexes:i,dfgLUT:s}=UC(n);t=jC(this.getMap(),i,s,e&&e.ssr,e&&e.jitter)}else{t={projViewMatrix:this.getMap().projViewMatrix}}return this._setIncludeUniformValues(t,e),t}_setIncludeUniformValues(e,t){const n=t&&t.includes;if(n)for(const i in n)n[i]&&t[i].renderUniforms&&vC(e,t[i].renderUniforms)}_disposeIblTextures(){const e=this.getMap().getRenderer().canvas;VC(e,this.getMap())}_init(){const e=this._getExtraCommandProps(),t=ShadowProcess.getUniformDeclares(),n=[];t.push({name:"projViewModelMatrix",type:"function",fn:function(e,t){return vA(n,t.projViewMatrix,t.modelMatrix)}}),this._fillShader=new MeshShader({name:"ground-fill",vert:"attribute vec3 aPosition;\nuniform mat4 projViewModelMatrix;\nuniform mat4 modelMatrix;\n#ifdef HAS_PATTERN\nattribute vec2 aTexCoord;\nuniform vec2 uvScale;\nuniform vec2 uvOffset;\nvarying vec2 vTexCoord;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\nvoid main() {\n  \n#ifdef HAS_PATTERN\nvTexCoord = aTexCoord * uvScale + uvOffset;\n#endif\nvec3 c = vec3(aPosition);\n  gl_Position = projViewModelMatrix * vec4(c, 1.);\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(vec4(c, 1.));\n#endif\n}",frag:"precision mediump float;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#ifdef HAS_PATTERN\nuniform sampler2D polygonPatternFile;\nvarying vec2 vTexCoord;\n#endif\nuniform vec4 polygonFill;\nuniform float polygonOpacity;\nvoid main() {\n  \n#ifdef HAS_PATTERN\nvec4 c = texture2D(polygonPatternFile, vTexCoord);\n#else\nvec4 c = polygonFill;\n#endif\ngl_FragColor = c * polygonOpacity;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat d = shadow_computeShadow();\n  gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, d);\n#endif\n}",wgslFrag:null,wgslVert:null,uniforms:t,extraCommandProps:e,defines:{}});const i=ShadowProcess.getUniformDeclares();i.push(...SsrPass.getUniformDeclares()),this._standardShader=new SM.StandardShader({uniforms:i,extraCommandProps:e}),this._createGround(),this.update()}_getExtraCommandProps(){const e=[0,1],t=this._layer.getRenderer().canvas;return{viewport:{x:0,y:0,width:()=>t.width,height:()=>t.height},cull:{enable:!0},depth:{enable:!0,mask:()=>{const e=this._layer.getGroundConfig();return e.depth||void 0===e.depth},range:()=>{const t=this._layer.getGroundConfig(),n=t&&t.renderPlugin.sceneConfig;return n&&n.depthRange||e},func:"<="},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"},polygonOffset:{enable:!0,offset:{factor:(e,t)=>t.offsetFactor,units:(e,t)=>t.offsetUnits}}}}_hasIBL(){const e=this.getMap().getLightManager();return!!(e&&e.getAmbientResource())}_createGround(){const e=new Plane;e.data.aTexCoord=new Uint8Array([0,0,1,0,0,1,1,1]),e.createTangent(),e.generateBuffers(this.renderer.device),this._ground=new Mesh(e,null,{castShadow:!1});const t=this._standardShader.getGeometryDefines(e);this._ground.setDefines(t),this._groundScene=new Scene([this._ground])}_transformGround(){const e=this.getMap(),t=GroundPainter.getGroundTransform(this._ground.localTransform,e);this._ground.setLocalTransform(t);const n=e.getGLRes(),i=e._get2DExtentAtRes(n),s=i.getWidth(),o=i.getHeight(),a=e.cameraLookAt,l=a[0]-s,h=a[1]-o,c=this._polygonPatternFile?this._polygonPatternFile.width/this._polygonPatternFile.height:1,u=this.getSymbol(),f=this.material?this.material.get("textureOrigin"):u.polygonPatternFileOrigin,g=!!(this.material?this.material.get("uvOffsetInMeter"):u.uvOffsetInMeter),m=(this.material?this.material.get("uvOffset"):u.uvOffset)||qC,A=this.material&&this.material.get("uvScale")||ZC,w=this.material?this.material.get("textureWidth"):u.polygonPatternFileWidth,T=this.material?w*(A[1]/A[0]):u.polygonPatternFileHeight,S=this._getUVOffsetAnim(),[M,C,I,E,D]=function(e,t,n,i,s,o,a,l,h,c,u){const f=e.getGLRes();i&&(FC.set(i[0],i[1]),e.coordToPointAtRes(FC,f,HC),t-=HC.x,n-=HC.y);const g=i?FC:null;c=G_(BC,c);const m=!h&&c||DC;let A=h&&c||DC;A=G_(NC,A),A[0]&&(A[0]=GC(e,A[0],g)),A[1]&&(A[1]=GC(e,A[1],g,1));let w=.5;s&&(w=GC(e,s,g));let T=w/a;if(o&&(T=GC(e,o,g,1)),u&&(u[0]||u[1])){const t=performance.now()/1e3;let n=u[0],i=u[1];h&&(n=-GC(e,u[0],g),i=-GC(e,u[1],g,1)),u[0]&&(h?A[0]=t*n:m[0]=t*n),u[1]&&(h?A[1]=t*i:m[1]=t*i)}const S=(t+A[0])/(w/l[0]),M=(n-A[1])/(T/l[1]);return zC[0]=w/l[0],zC[1]=T/l[1],zC[2]=S,zC[3]=M,zC[4]=m,zC}(e,l,h,f,w,T,c,A,g,m,S),H=2*i.getWidth()/M,N=2*i.getHeight()/C;if(!this.material)return this._ground.setUniform("uvScale",U_(XC,H,N)),void this._ground.setUniform("uvOffset",U_(YC,I%1+D[0],E%1+D[1]));this._ground.setUniform("uvScale",U_($C,H,N)),this._ground.setUniform("uvOffset",U_(JC,I%1+D[0],E%1+D[1])),this._ground.setUniform("uvOrigin",U_(QC,I-I%1,E-E%1)),this._ground.setUniform("uvRotation",0)}_getGroundDefines(e){let t=!1;const n=this._ground.defines,i=this._layer._getSceneConfig&&this._layer._getSceneConfig(),s=this._layer.getGroundConfig();function o(e,i){e?n[i]||(n[i]=1,t=!0):n[i]&&(delete n[i],t=!0)}o(this._hasIBL(),"HAS_IBL_LIGHTING");o(e&&e.ssr&&s&&s.symbol&&s.symbol.ssr,"HAS_SSR");const a=e&&i&&i.shadow&&i.shadow.enable;o(a,"HAS_SHADOWING"),o(a,"USE_ESM");return o(!!this._polygonPatternFile,"HAS_PATTERN"),t?n:null}_updateMaterial(){const e=this.getSymbol()&&this.getSymbol().material||{},t={};let n=!1;const i=this._layer.getGroundConfig();this._loader.setURLModifier(i.urlModifier);for(const i in e)if(MC(e,i))if(i.indexOf("Texture")>0){let s=e[i];if(!s)continue;s="string"==typeof s?{url:s,wrap:"repeat"}:s,s.flipY=!0,s.min="linear mipmap linear",s.mag="linear",s.flipY=!0,t[i]=new Texture2D(s,this._loader),n=!0}else t[i]=e[i];this.material?(this._loadingMaterial=new SM.StandardMaterial(t),this._loadingMaterial.isReady()?this._onMaterialComplete():this._loadingMaterial.once("complete",this._bindOnMaterialComplete)):(this.material=new SM.StandardMaterial(t),this.material.once("complete",this._bindOnMaterialComplete,this)),n||this._onMaterialComplete()}_onMaterialComplete(){this._loadingMaterial&&(this.material.dispose(),this.material=this._loadingMaterial,delete this._loadingMaterial),this.setToRedraw()}_createPatternTexture(e){e=Lx(e);return this._regl.texture({width:e.width,height:e.height,data:e,mag:"linear",min:"linear mipmap linear",flipY:!0,wrap:"repeat"})}_parseColor(e){return IC([],e)}_getUVOffsetAnim(){return this.material&&this.material.get("uvOffsetAnim")}getRenderMeshes(){return this._groundScene.getMeshes()}}const{createIBLTextures:KC,disposeIBLTextures:eP}=SM.PBRUtils,tP=[0,0,0],nP=[],rP=[];class EnvironmentPainter{constructor(e,t){this._maxLevel=4,this._regl=e,this.renderer=new Renderer(e),this._layer=t,this._init(),this._updateMode()}paint(e){if(!this.isEnable()||!this._resource)return;const t=this._getUniformValues(e);this.renderer.render(this._shader,t,null,e&&e.renderTarget&&e.renderTarget.fbo)}update(){const e=this.getMap();if(!e||!this.isEnable())return;const t=e.getLightManager(),n=t&&t.getAmbientResource();n!==this._resource&&this._iblTexes&&(eP(this._iblTexes),delete this._iblTexes),this._resource=n,this._updateMode()}dispose(){this._shader.dispose(),eP(this._iblTexes),delete this._shader,delete this._iblTexes,delete this._resource}getMap(){return this._layer.getMap()}_updateMode(){if(!this._resource)return;const e=this._layer._getSceneConfig().environment||{};this._shader.setMode(e.toneMapping,e.mode?1:0)}isEnable(){const e=this._layer._getSceneConfig();return this._hasIBL()&&e&&e.environment&&e.environment.enable}_hasIBL(){const e=this.getMap().getLightManager();return!!(e&&e.getAmbientResource())}_getUniformValues(){const e=this.getMap(),t=this.getMap().getLightManager(),n=t&&t.getAmbientLight();let i=this._iblTexes;i||(i=this._iblTexes=KC(this._regl,e));const s=this._layer.getRenderer().canvas,o=this._layer._getSceneConfig().environment||{},a=o.level||0,l=i.prefilterMap.width,h=this._transform=this._transform||[],c=o.brightness||0,u=o.intensity||1;return qA(nP,n&&n.hsv||tP),c&&(nP[2]+=c),rP[0]=s.width,rP[1]=s.height,{cubeMap:i.prefilterMap,bias:a,size:l/Math.pow(2,Math.max(0,a-1)),environmentExposure:bC(n&&n.exposure)?n.exposure:1,backgroundIntensity:u,diffuseSPH:i.sh,viewMatrix:e.viewMatrix,projMatrix:e.projMatrix,resolution:rP,hsv:nP,transformMatrix:uA(h,n&&Math.PI/180*-n.orientation||0)}}_init(){const e=this.getMap();if(e.on("updatelights",this.update,this),this._shader=new SkyboxShader,e.options.lights){const e=this.getMap().getLightManager().getAmbientResource();this._resource=e}}}const iP=[],sP=[.03,.03,.03],oP=[],aP=[],lP=[],hP=[1,1,1],cP=[-1200,-1200,0],uP=[1200,1200,1e3],fP={min:[],max:[]},dP=CA([],a_([],90,0,0),[0,0,0]);class RainPainer{constructor(e,t){this._regl=e,this.renderer=new Renderer(e),this._layer=t,this._timer=new Clock,this._init()}getMap(){return this._layer&&this._layer.getMap()}_init(){const e=this._layer.getRenderer().canvas;this._shader=new MeshShader({vert:"attribute vec3 aPosition;\nattribute vec3 aNormal;\nattribute vec2 aTexCoord;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform vec3 cameraPosition;\nuniform float top;\nuniform float bottom;\nuniform float time;\nvarying vec2 vTexCoord;\n#include <get_output>\nfloat c(float x, float y) {\n  return atan(y, x);\n}\nvec2 d(vec2 e, vec2 f, vec2 h) {\n  vec2 i = vec2(.0);\n  float j = distance(h, f);\n  float a = c(e.x - f.x, e.y - f.y);\n  h.x > f.x ? a -= .785 : a += .785;\n  i.x = cos(a) * j;\n  i.y = sin(a) * j;\n  return i + f;\n  return i;\n}\nvoid main() {\n  vec4 k = getPosition(aPosition);\n  mat4 l = getPositionMatrix();\n  vec2 m = d(vec2(cameraPosition.x, cameraPosition.z), vec2(aNormal.x, aNormal.z), vec2(k.x, k.z));\n  float n = top - bottom;\n  float y = aNormal.y - bottom - n * time;\n  y = y + (y < .0 ? n : .0);\n  float o = (1. - y / n) * (1. - y / n);\n  y = n * (1. - o);\n  y += bottom;\n  y += aPosition.y - aNormal.y;\n  k = vec4(m.x, y, m.y, 1.);\n  gl_Position = projMatrix * modelViewMatrix * l * k;\n  vTexCoord = aTexCoord;\n}",frag:"precision mediump float;\nvarying vec2 vTexCoord;\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D rainMap;\nvoid main() {\n  vec4 c = texture2D(rainMap, vTexCoord);\n  vec4 d = vec4(diffuse, opacity);\n  d *= c;\n  gl_FragColor = d;\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(e,t){return vA(iP,t.viewMatrix,t.modelMatrix)}}],extraCommandProps:{viewport:{x:0,y:0,width:()=>e.width,height:()=>e.height},depth:{enable:!0,mask:!1,func:"less",range:[0,1]},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}}),this._createScene()}_createScene(){const e=this._regl.texture({width:2,height:2});if(this._mesh=this._createRain(),!this._mesh)return;this._scene=new Scene(this._mesh);const t=this._getRainConfig();t.rainTexture?this._creatRainTexture(t.rainTexture).then((e=>{this._mesh.material.set("rainMap",e)})):(this._mesh.material.set("rainMap",e),console.warn("should set rain texture."))}_createRain(){const e=this.getMap(),t=this._getRainConfig();if(!t)return null;this._fixZoom=e.getZoom();const n=this._getFixExtent(),i=this._rainDensity=t.density,s=this._rainWidth=t.rainWidth||1,o=this._rainHeight=t.rainHeight||1,a=[],l=[],h=[],c=[];for(let e=0;e<i;e++){const t={};t.x=Math.random()*(n.max[0]-n.min[0])+n.min[0],t.y=Math.random()*(n.max[2]-n.min[2])+n.min[2],t.z=Math.random()*(n.max[1]-n.min[1])+n.min[1];const i=(n.max[2]-n.min[2])/37.5*o,u=i/3*s;a.push(t.x+u,t.y+i,t.z,t.x-u,t.y+i,t.z,t.x-u,t.y,t.z,t.x+u,t.y,t.z),l.push(t.x,t.y-i/2,t.z,t.x,t.y-i/2,t.z,t.x,t.y-i/2,t.z,t.x,t.y-i/2,t.z),h.push(1,1,0,1,0,0,1,0),c.push(4*e+0,4*e+1,4*e+2,4*e+0,4*e+2,4*e+3)}const u={};u.POSITION=a,u.NORMAL=l,u.TEXCOORD_0=h;const f=new Geometry(u,c,0,{primitive:"triangles",positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});f.generateBuffers(this.renderer.device);const g=new Material({rainMap:this._regl.texture({width:2,height:2}),diffuse:t.color||[1,1,1],opacity:t.opacity||1}),m=new Mesh(f,g);return m.setUniform("top",n.max[2]),m.setUniform("bottom",n.min[2]),this._transformRain(m),m.transparent=!0,m}_creatRainTexture(e){const t=new Image;return t.src=this._rainTexture=e,new Promise(((e,n)=>{t.onload=()=>{const n=this._regl.texture({mag:"linear",min:"linear mipmap nearest",wrapS:"clamp",wrapT:"clamp",data:t});e(n)},t.onerror=e=>{n(e)}}))}paint(e){if(!this._scene)return;const t=this._getRainConfig(),n={},i=this.getMap();n.projMatrix=i.projMatrix,n.viewMatrix=i.viewMatrix,n.cameraPosition=i.cameraPosition;const s=t.speed||1,o=this._timer.getElapsedTime()/(2/s)%1;n.time=o,this._mesh.material.set("diffuse",t.color||hP),this._mesh.material.set("opacity",t.opacity||1),this._transformRain(this._mesh);this.renderer.render(this._shader,n,this._scene,e&&e.renderTarget&&e.renderTarget.fbo),this._layer.getRenderer().setCanvasUpdated()}_transformRain(e){const t=this.getMap(),n=t.coordinateToPointAtRes(t.getCenter(),t.getGLRes()),i=t.getGLScale()/t.getGLScale(this._fixZoom),s=ZA(aP,i,i,i),o=JA(s,sP,s),a=AA(lP),l=this._getRainConfig(),h=t.getBearing();EA(a,a_(oP,l.windDirectionX||0,l.windDirectionY||0,90-h),[n.x,n.y,0],o),vA(a,a,dP),e.setLocalTransform(a)}setToRedraw(){const e=this._layer.getRenderer();e&&e.setToRedraw()}update(){const e=this._getRainConfig();if(e){if(this._mesh||this._createScene(),e.density!==this._rainDensity||e.rainWidth!==this._rainWidth||e.rainHeight!==this._rainHeight){const e=this._mesh.material.get("rainMap");this._mesh.geometry.dispose(),this._mesh.dispose(),this._scene.clear(),this._mesh=this._createRain(),this._mesh.material.set("rainMap",e),this._scene.setMeshes(this._mesh)}e.rainTexture!==this._rainTexture&&this._creatRainTexture(e.rainTexture).then((e=>{this._mesh.material.set("rainMap",e)}))}}dispose(){this._mesh&&(this._mesh.geometry.dispose(),this._mesh.material&&this._mesh.material.dispose(),this._mesh.dispose(),delete this._mesh),this._shader&&(this._shader.dispose(),delete this._shader)}isEnable(){const e=this._getRainConfig();return e&&e.enable}_getRainConfig(){const e=this._layer.getWeatherConfig();return e&&e.rain}_getFixExtent(){const e=16.685648411389433-this.getMap().getZoom();return $A(fP.min,cP,Math.pow(2,e)),$A(fP.max,uP,Math.pow(2,e)),fP}}class Clock{constructor(e){this.autoStart=void 0===e||e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=("undefined"==typeof performance?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const t=("undefined"==typeof performance?Date:performance).now();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return 0}}const pP=[],gP=[.03,.03,.03],mP=[],AP=[],yP=[],_P=CA([],a_([],90,0,0),[0,0,0]);class SnowPainter{constructor(e,t){this._regl=e,this._layer=t,this._init()}_init(){const e=this._layer.getRenderer().canvas;this._shader=new MeshShader({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\n#include <get_output>\nvoid main() {\n  mat4 c = getPositionMatrix();\n  vec4 d = getPosition(aPosition);\n  gl_Position = projMatrix * modelViewMatrix * c * d;\n  vTexCoord = aTexCoord;\n}",frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nprecision mediump float;\nuniform sampler2D perlinTexture;\nvarying vec2 vTexCoord;\nfloat c(float a, float b, float w) {\n  return a + w * (b - a);\n}\nvoid main() {\n  float d = texture2D(perlinTexture, vTexCoord).r;\n  vec3 e = vec3(1.);\n  float r = c(.5, e.x, d);\n  float g = c(.5, e.y, d);\n  float b = c(.5, e.z, d);\n  glFragColor = vec4(r, g, b, 1.);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(e,t){return vA(pP,t.viewMatrix,t.modelMatrix)}}],extraCommandProps:{viewport:{x:0,y:0,width:()=>e.width,height:()=>e.height}}}),this._shader.version=300,this._scene=new Scene,this._groundMask=this._createGroundMask(),this._scene.setMeshes(this._groundMask),this.renderer=new Renderer(this._regl);const t=this._getSnowConfig();t&&(t.snowGroundTexture?this._createSnowTexture(t.snowGroundTexture):(this._groundNormal=this._regl.texture({width:2,height:2}),console.warn("should set snow ground texture.")))}render(e){this._groundNormal&&this._groundMask.material.set("perlinTexture",this._groundNormal);const t=this._layer.getMap();this._transformMask(t);this.renderer.render(this._shader,{projMatrix:t.projMatrix,viewMatrix:t.viewMatrix,cameraPosition:t.cameraPosition},this._scene,e&&e.renderTarget&&e.renderTarget.fbo),this._layer.getRenderer().setCanvasUpdated()}_transformMask(e){const t=e.coordinateToPointAtRes(e.getCenter(),e.getGLRes()),n=e.getGLScale()/e.getGLScale(this._fixZoom),i=ZA(AP,n,n,n),s=JA(i,gP,i),o=AA(yP);EA(o,a_(mP,0,0,0),[t.x,t.y,.005],s),vA(o,o,_P),this._groundMask.setLocalTransform(o)}_createSnowTexture(e){const t=new Image;t.onload=()=>{this._groundNormal=this._regl.texture({mag:"linear",min:"linear mipmap nearest",wrapS:"repeat",wrapT:"repeat",data:t})},t.onerror=e=>{console.log(e)},t.src=this._snowGroundTexture=e}_createGroundMask(){const e=this._layer.getMap();this._fixZoom=e.getZoom();const t=16e3*Math.pow(2,16.685648411389433-this._fixZoom),n={};n.POSITION=[-t,0,-t,t,0,-t,-t,0,t,t,0,t],n.NORMAL=[0,1,0,0,1,0,0,1,0,0,1,0],n.TEXCOORD_0=[0,0,1,0,0,1,1,1];const i=new Geometry(n,[3,1,0,0,2,3],0,{positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});i.generateBuffers(this._regl);const s=new Material({perlinTexture:this._regl.texture({width:2,height:2})});return new Mesh(i,s)}getMeshes(){return this._groundMask}dispose(){this._groundMask&&(this._groundMask.geometry.dispose(),this._groundMask.material&&this._groundMask.material.dispose(),this._groundMask.dispose(),delete this._groundMask),this._shader&&(this._shader.dispose(),delete this._shader)}update(){const e=this._getSnowConfig();e&&e.snowGroundTexture===!this._snowGroundTexture&&this._createSnowTexture(e.snowGroundTexture)}isEnable(){const e=this._getSnowConfig();return e&&e.enable}_getSnowConfig(){const e=this._layer.getWeatherConfig();return e&&e.snow}}const vP=[];class WeatherPainter{constructor(e,t,n){this._regl=e,this._layer=t,this._config=n,this._init()}_init(){this.renderer=new Renderer(this._regl);const e=this._layer.getRenderer(),t=this._viewport={x:0,y:0,width:()=>e.canvas?e.canvas.width:1,height:()=>e.canvas?e.canvas.height:1};this._width=t.width,this._height=t.height,this._fbo=this._regl.framebuffer({color:this._regl.texture({width:e.canvas?e.canvas.width:1,height:e.canvas?e.canvas.height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this.EMPTY_TEXTURE=this._regl.texture({width:2,height:2}),this._rainPainter=new RainPainer(this._regl,this._layer),this._rainRipplesPass=new RainRipplePass(this._regl,t),this._snowPainter=new SnowPainter(this._regl,this._layer),this._fogPass=new FogPass(this._regl,t,this._layer),this._weatherShader=new FogShader,this._weatherShader.version=300}getMap(){return this._layer&&this._layer.getMap()}renderScene(e){this.renderSnowMask(e),this.renderRain(e)}renderRain(e){this.isEnableRain()&&this._rainPainter.paint(e)}renderSnowMask(e){if(!this.isEnableSnow()||!this._showSnowGround())return;const t=this.getMap();this._snowPainter.render(e,t)}paint(e,t){if(!t||!t.length)return e;this._resize();const n=this._layer.getWeatherConfig(),i={};if(this.isEnableRain()?(i.ripplesMap=this._renderRainRipples(),this._weatherShader.shaderDefines.HAS_RAIN=1):delete this._weatherShader.shaderDefines.HAS_RAIN,this.isEnableSnow()?(this._weatherShader.shaderDefines.HAS_SNOW=1,i.snowIntensity=mx(n.snow.snowIntensity)?n.snow.snowIntensity:.5,t.forEach((e=>{e.defines.HAS_SNOW=1}))):(delete this._weatherShader.shaderDefines.HAS_SNOW,t.forEach((e=>{delete e.defines.HAS_SNOW}))),this.isEnableFog()){i.fogColor=n.fog.color||[.9,.9,.9],this._weatherShader.shaderDefines.HAS_FOG=1}else delete this._weatherShader.shaderDefines.HAS_FOG;return this._weatherShader.setDefines(this._weatherShader.shaderDefines),i.mixFactorMap=this._renderMixFactor(t)||this.EMPTY_TEXTURE,i.sceneMap=e,i.time=this._getTimeSpan()/1e3,i.resolution=U_(vP,this._fbo.width,this._fbo.height),this.renderer.render(this._weatherShader,i,null,this._fbo),this._renderMeshes=t,this._fbo}_renderMixFactor(e){const t={},n=this.getMap(),i=n.getZoom(),s=Math.pow(2,16.685648411389433-i),o=this._layer.getWeatherConfig(),a=o.fog;if(!a||!a.enable)return null;const l=a.start||.1,h=a.end||100;t.projMatrix=n.projMatrix,t.viewMatrix=n.viewMatrix,t.cameraPosition=n.cameraPosition,t.fogDist=[l*s,h*s],t.rainDepth=n.altitudeToPoint(o.rain&&o.rain.rainDepth||.1,n.getGLRes());const c=this._fogPass.render(e,t);return this._layer.getRenderer()._getFBOColor(c)}_renderRainRipples(){const e=this.getMap(),t=this._layer.getWeatherConfig(),n=t.rain.rippleRadius||24,i={};i.projMatrix=e.projMatrix,i.viewMatrix=e.viewMatrix,i.time=this._getTimeSpan()/1e3,i.rippleRadius=n,i.density=t.rain.density||2e3;return this._rainRipplesPass.render(e,i)}_getTimeSpan(){if(!this._layer)return 0;if(void 0===this._currentFrameTime&&(this._currentFrameTime=0),this.isPlaying()){const e=this._layer.getRenderer();this._currentFrameTime=e.getFrameTime()}return this._currentFrameTime}isEnable(){const e=this._layer.getWeatherConfig();return e&&e.enable}isEnableRain(){const e=this._layer.getWeatherConfig();return e&&e.enable&&e.rain&&e.rain.enable}isEnableFog(){const e=this._layer.getWeatherConfig();return e&&e.enable&&e.fog&&e.fog.enable}isEnableSnow(){const e=this._layer.getWeatherConfig();return e&&e.enable&&e.snow&&e.snow.enable}_showSnowGround(){const e=this._layer.getWeatherConfig();return this.isEnableSnow()&&!1===e.snow.showGround}isPlaying(){const e=this._layer.getWeatherConfig();return!!e&&!1!==e.playing}_hasWeather(){return this.isEnableRain()||this.isEnableFog()||this.isEnableSnow()}update(){!this.isEnable()&&this._renderMeshes&&this._renderMeshes.forEach((e=>{delete e.defines.HAS_SNOW,delete e.defines.HAS_RAIN,delete e.defines.HAS_FOG})),this.isEnableRain()&&(this._rainPainter=this._rainPainter||new RainPainer(this._regl,this._layer),this._rainPainter.update()),this.isEnableSnow()&&(this._snowPainter=this._snowPainter||new SnowPainter(this._regl,this._layer),this._snowPainter.update())}getShadowMeshes(){return this._snowPainter.getMeshes()}_resize(){const e=this._width(),t=this._height();!this._fbo||this._fbo.width===e&&this._fbo.height===t||this._fbo.resize(e,t)}dispose(){this._fbo&&this._fbo.destroy(),this._weatherShader&&(this._weatherShader.dispose(),delete this._weatherShader),this._rainPainter&&(this._rainPainter.dispose(),delete this._rainPainter),this._snowPainter&&(this._snowPainter.dispose(),delete this._snowPainter)}}const xP=[],bP=e=>!!e.bloom,wP=e=>!!e.ssr;class PostProcess{constructor(e,t){this._regl=e,this._layer=t,this._renderer=new Renderer(e),this._fxaaShader=new FxaaShader,this._copyShader=new CopyShader,this._ssrPass=new SsrPass(this._regl)}setContextIncludes(){}bloom(e,t,n,i,s,o,a){this._bloomPass||(this._bloomPass=new BloomPass(this._regl));const l=this._layer.getRenderer()._getFBOColor(this._bloomFBO);return this._bloomPass.render(e,l,i,s,o,t,n,a)}drawBloom(e){const t=this._layer.getRenderer(),n=this._regl,i=this._bloomFBO;if(i){const{width:t,height:s}=e;i.width===t&&i.height===s||i.resize(t,s),n.clear({color:[0,0,0,0],framebuffer:i})}else{const t=this._createFBOInfo(e);this._bloomFBO=n.framebuffer(t)}const s=t.getFrameTime(),o=t.getFrameEvent(),a=t.getFrameContext(),l=a.renderMode,h=a.sceneFilter,c=a.renderTarget;a.isPostProcess=!0,a.renderMode="default",a.sceneFilter=bP,a.renderTarget={fbo:this._bloomFBO,getFramebuffer:TP,getDepthTexture:SP};const u=t.reglGL;return u.resetDrawCalls(),t.forEachRenderer(o?e=>{t.clearStencil(e,i),e.drawOnInteracting(o,s,a)}:e=>{t.clearStencil(e,i),e.draw(s,a)}),delete a.isPostProcess,a.renderMode=l,a.sceneFilter=h,a.renderTarget=c,u.getDrawCalls()}genSsrMipmap(e,t){const n=this._layer.getMap().projViewMatrix;this._ssrPass.genMipMap(e,t,n)}getPrevSsrProjViewMatrix(){return this._ssrPass&&this._ssrPass.getPrevProjViewMatrix()}drawSSR(e,t,n){n&&this._ssrPass.copyDepthTex(e);const i=this._layer.getRenderer(),s=i.getFrameTime(),o=i.getFrameEvent(),a=i.getFrameContext();a.isPostProcess=!0,a.ssr=this.getSSRContext();const l=a.renderMode,h=a.sceneFilter;a.renderMode="default",a.sceneFilter=wP,a.renderTarget.fbo=t;const c=i.reglGL;let u=!1;i.forEachRenderer(o?e=>{i.clearStencil(e,t),u||(c.resetDrawCalls(),u=!0),e.drawOnInteracting(o,s,a)}:e=>{i.clearStencil(e,t),u||(c.resetDrawCalls(),u=!0),e.draw(s,a)});const f=i.drawGround();return delete a.ssr,delete a.isPostProcess,a.renderMode=l,a.sceneFilter=h,this._ssrPainted=c.getDrawCalls()>0,f}getSSRUniforms(){const e=this._layer._getSceneConfig(),t=e&&e.postProcess,n=this._layer.getMap();return this._ssrPass.getSSRUniforms(n,t.ssr.factor,t.ssr.quality)}getSSRContext(){const e=this._layer._getSceneConfig(),t=e&&e.postProcess,n=this._layer.getMap(),i=this._ssrPass.getSSRUniforms(n,t.ssr.factor,t.ssr.quality);if(!i)return null;return{renderUniforms:i,defines:{HAS_SSR:1}}}fxaa(e,t,n,i,s,o,a,l,h,c,u,f){!e||e.width===t.fbo&&e.height===t.height||e.resize(t.width,t.height);const g={};l?g.HAS_OUTLINE_TEX=1:delete g.HAS_OUTLINE_TEX,this._fxaaShader.setDefines(g),this._renderer.render(this._fxaaShader,{textureSource:t,resolution:U_(xP,t.width,t.height),enableFXAA:n,enableToneMapping:i,enableSharpen:s,pixelRatio:o,sharpFactor:a,textureOutline:l,highlightFactor:h,outlineFactor:c,outlineWidth:u,outlineColor:f},null,e)}renderFBOToScreen(e,t,n,i){this._copyFBOSize||(this._copyFBOSize=[]),this._copyFBOSize[0]=e.width,this._copyFBOSize[1]=e.height;const s=this._layer.getRenderer();this._renderer.render(this._copyShader,{texture:e.color&&s._getFBOColor(e)||e,size:this._copyFBOSize,enableSharpen:+!!t,sharpFactor:n,pixelRatio:i})}postprocess(e,t,n){this._postProcessShader||(this._postProcessShader=new PostProcessShader);const i=this._layer&&this._layer.getRenderer(),s=n||i._getFBOColor(e);return t.resolution=U_(xP,s.width,s.height),t.textureSource=s,t.timeGrain=performance.now(),this._renderer.render(this._postProcessShader,t),this._target}dispose(){this._bloomFBO&&(this._bloomFBO.destroy(),delete this._bloomFBO),this._bloomPass&&(this._bloomPass.dispose(),delete this._bloomPass),this._postProcessShader&&(this._postProcessShader.dispose(),delete this._postProcessShader),this._fxaaShader&&(this._fxaaShader.dispose(),delete this._fxaaShader),this._copyShader&&(this._copyShader.dispose(),delete this._copyShader)}_createFBOInfo(e,t){const{width:n,height:i}=this._layer.getRenderer().canvas,s=this._regl;let o;o=this._layer.getRenderer()._isUseMultiSample()?s.renderbuffer({width:n,height:i,samples:this._layer.options.multiSamples,format:"rgba8"}):s.texture({min:"nearest",mag:"nearest",format:t||"rgba",width:n,height:i});const a={width:n,height:i,colors:[o]};return e&&(a.depthStencil=e),a}}function TP(e){return e._framebuffer.framebuffer}function SP(e){return e.depthStencil._texture.texture}class AnalysisShader extends QuadShader{constructor(e){super({vert:"#if __VERSION__ == 300\n#define attribute in\n#define varying out\n#endif\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main() {\n  gl_Position = vec4(aPosition, 0., 1.);\n  vTexCoord = aTexCoord;\n}",frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\n#ifdef HAS_FLOODANALYSE\nuniform vec3 flood_waterColor;\nuniform float flood_waterOpacity;\nuniform sampler2D floodMap;\n#endif\n#ifdef HAS_SKYLINE\nuniform sampler2D skylineMap;\n#endif\n#ifdef HAS_VIEWSHED\nuniform vec4 viewshed_visibleColor;\nuniform vec4 viewshed_invisibleColor;\nuniform sampler2D viewshedMap;\n#endif\n#ifdef HAS_INSIGHT\nuniform vec4 insight_visibleColor;\nuniform vec4 insight_invisibleColor;\nuniform sampler2D insightMap;\n#endif\n#ifdef HAS_CUT\nuniform sampler2D meshesMap;\nuniform sampler2D invisibleMap;\n#endif\n#ifdef HAS_EXCAVATE\nuniform sampler2D excavateMap;\n#endif\n#ifdef HAS_CROSSCUT\nuniform sampler2D crosscutMap;\nuniform vec4 cutLineColor;\n#endif\n#ifdef HAS_HEIGHTLIMIT\nuniform vec3 limitColor;\nuniform sampler2D heightLimitMap;\n#endif\nuniform sampler2D sceneMap;\nvoid main() {\n  vec4 c = texture2D(sceneMap, vTexCoord);\n  glFragColor = c;\n#ifdef HAS_VIEWSHED\nvec4 d = texture2D(viewshedMap, vTexCoord);\n  if(d.r > .99) {\n    glFragColor = vec4(mix(viewshed_invisibleColor.rgb, c.rgb, viewshed_invisibleColor.a), c.a);\n  } else if(d.g > .99) {\n    glFragColor = vec4(mix(viewshed_visibleColor.rgb, c.rgb, viewshed_visibleColor.a), c.a);\n  } else if(d.a < .01) {\n    glFragColor = vec4(d.rgb, 1.);\n  }\n  \n  \n#endif\n#ifdef HAS_FLOODANALYSE\nvec4 e = texture2D(floodMap, vTexCoord);\n  if(e.r > .0) {\n    glFragColor = vec4(mix(glFragColor.rgb, flood_waterColor, flood_waterOpacity), glFragColor.a);\n  }\n#endif\n#ifdef HAS_SKYLINE\nvec4 f = texture2D(skylineMap, vTexCoord);\n  if(f.r > .0 || f.g > .0 || f.b > .0) {\n    glFragColor = f;\n  }\n#endif\n#ifdef HAS_INSIGHT\nvec4 h = texture2D(insightMap, vTexCoord);\n  if(h.g > .0) {\n    glFragColor = insight_visibleColor;\n  } else if(h.r > .0) {\n    glFragColor = insight_invisibleColor;\n  }\n  \n#endif\n#ifdef HAS_CUT\nvec4 i = texture2D(invisibleMap, vTexCoord);\n  vec4 j = texture2D(meshesMap, vTexCoord);\n  if(i.r == 1. && i.g == .0 && i.b == .0) {\n    glFragColor = j;\n  } else if(i.r == .0 && i.g == 1. && i.b == .0) {\n    glFragColor = j;\n  } else if(i.r == .0 && i.g == .0 && i.b == 1.) {\n    glFragColor = c;\n  }\n  \n  \n#endif\n#ifdef HAS_EXCAVATE\nvec4 k = texture2D(excavateMap, vTexCoord);\n  if(k.r == 1. && k.g == .0 && k.b == .0) {\n    glFragColor = c;\n  } else {\n    glFragColor = k;\n  }\n#endif\n#ifdef HAS_CROSSCUT\nvec4 l = texture2D(crosscutMap, vTexCoord);\n  if(l.r > .0) {\n    glFragColor = vec4(mix(cutLineColor.rgb, glFragColor.rgb, .99), glFragColor.a);\n  }\n#endif\n#ifdef HAS_HEIGHTLIMIT\nvec4 m = texture2D(heightLimitMap, vTexCoord);\n  if(m.r > .0) {\n    glFragColor = vec4(mix(limitColor, glFragColor.rgb, .6), glFragColor.a);\n  }\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",extraCommandProps:{viewport:e,cull:{enable:!0},blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}})}}class AnalysisPainter{constructor(e,t,n){this._regl=e,this._layer=t,this._config=n,this._init()}_init(){this.renderer=new Renderer(this._regl);const e=this._layer.getRenderer(),t=this._viewport={x:0,y:0,width:()=>e.canvas?e.canvas.width:1,height:()=>e.canvas?e.canvas.height:1};this._fbo=this._regl.framebuffer({color:this._regl.texture({width:e.canvas?e.canvas.width:1,height:e.canvas?e.canvas.height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this._shader=new AnalysisShader(t)}getMap(){return this._layer&&this._layer.getMap()}paint(e,t){if(!t&&t.length)return e;this._resize();const n={},i=this._layer._analysisTaskList;if(!this._hasAnalysis())return e;this._regl.clear({color:[0,0,0,0],depth:1,stencil:0,framebuffer:this._fbo}),delete this._shader.shaderDefines.HAS_FLOODANALYSE,delete this._shader.shaderDefines.HAS_VIEWSHED,delete this._shader.shaderDefines.HAS_SKYLINE,delete this._shader.shaderDefines.HAS_INSIGHT,delete this._shader.shaderDefines.HAS_CUT,delete this._shader.shaderDefines.HAS_CROSSCUT,delete this._shader.shaderDefines.HAS_HEIGHTLIMIT;for(let e=0;e<i.length;e++){const s=i[e];if(!s.isEnable())continue;const o=s.getDefines();vC(this._shader.shaderDefines,o);const a=this.getMap(),l=a.width,h=a.height,c=this._getToAnalysisMeshes(t,s.getExcludeLayers()),u=s.renderAnalysis(c,l,h);u&&vC(n,u)}return n.sceneMap=e,this._shader.setDefines(this._shader.shaderDefines),this.renderer.render(this._shader,n,null,this._fbo),this._fbo}_getToAnalysisMeshes(e,t){let n=[];for(let i=0;i<e.length;i++){if(t.indexOf(e[i].getId())>-1)continue;const s=e[i].getRenderer();if(s&&s.getAnalysisMeshes){const e=s.getAnalysisMeshes();e.forEach((e=>{e.setUniform("useAnalysis",1)})),n=n.concat(e)}}return n}_resize(){const e=Zi.isFunction(this._viewport.width.data)?this._viewport.width.data():this._viewport.width,t=Zi.isFunction(this._viewport.height.data)?this._viewport.height.data():this._viewport.height;!this._fbo||this._fbo.width===e&&this._fbo.height===t||this._fbo.resize(e,t)}_hasAnalysis(){const e=this._layer&&this._layer._analysisTaskList;if(!e)return!1;for(let t=0;t<e.length;t++)if(e[t].isEnable())return!0;return!1}}const MP=[],CP=new fl(0,0);let PP={};class ScanEffectPainter{constructor(e,t){this._regl=e,this._layer=t,this._init()}_init(){this.renderer=new Renderer(this._regl);const e=this._layer.getRenderer(),t=this._viewport={x:0,y:0,width:()=>e.canvas?e.canvas.width:1,height:()=>e.canvas?e.canvas.height:1};this._width=t.width,this._height=t.height,this._fbo=this._regl.framebuffer({color:this._regl.texture({width:e.canvas?e.canvas.width:1,height:e.canvas?e.canvas.height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this.EMPTY_TEXTURE=this._regl.texture({width:2,height:2}),this._shader=new EffectShader,this._pass=new ScanEffectPass(this._regl,t,this._layer),this._shader.version=300}getMap(){return this._layer&&this._layer.getMap()}paint(e,t){if(!t||!t.length)return e;const n=this._layer.getMap();this._resize();const i=this._layer.getScanEffectConfig(),s={},{effects:o}=i,a=n.getGLRes(),l=[];this._effectLength!==o.length&&(PP={});for(let e=0;e<o.length;e++){const{center:t,radius:i,speed:s,color:h,direction:c,height:u}=o[e],f=IP(t),g=n.coordinateToPointAtRes(f,a,CP).toArray(),m=n.distanceToPointAtRes(i,0,a).x,A="vertical"===c?1:0,w=n.altitudeToPoint(u||0,a);PP[e]=PP[e]||[];const T=aA(PP[e],g[0],g[1],m,s,h[0],h[1],h[2],A,w);l.push(T)}const h={projMatrix:n.projMatrix,viewMatrix:n.viewMatrix,effectInfos:l,effectTime:this._getTimeSpan()/1e3},c=this._layer.getRenderer(),u=this._pass.render(t,h)||this.EMPTY_TEXTURE;return s.scanEffectMap=c._getFBOColor(u),s.sceneMap=e,s.resolution=U_(MP,this._fbo.width,this._fbo.height),this.renderer.render(this._shader,s,null,this._fbo),this._fbo}_getTimeSpan(){if(!this._layer)return 0;if(void 0===this._currentFrameTime&&(this._currentFrameTime=0),this.isPlaying()){const e=this._layer.getRenderer();this._currentFrameTime=e.getFrameTime()}return this._currentFrameTime}isPlaying(){const e=this._layer.getScanEffectConfig();return!!e&&!1!==e.playing}_resize(){const e=this._width(),t=this._height();!this._fbo||this._fbo.width===e&&this._fbo.height===t||this._fbo.resize(e,t)}dispose(){this._fbo&&this._fbo.destroy(),this._shader&&(this._shader.dispose(),delete this._shader),this._pass&&this._pass.dispose()}}function IP(e){return Array.isArray(e)?(CP.x=e[0],CP.y=e[1],CP):e}function kP(e,t,n,i,s){const o={alpha:!0,depth:!0,stencil:!0,preserveDrawingBuffer:t},a=function(e,t,n){const i=n?["webgl","experimental-webgl"]:["webgl2","webgl","experimental-webgl"];let s=null;for(let n=0;n<i.length;++n){try{s=e.getContext(i[n],t)}catch(e){}if(s)break}s||console.error("Browser doesn't support WebGL.");return s}(e,o,n);!function(e,t,n){t&&t.forEach((t=>{e.getExtension(t)}));n&&n.forEach((t=>{e.getExtension(t)}))}(a,i,s),a.wrap=()=>new ex(a);const l=a.wrap(),h=Wm({gl:l,attributes:o,extensions:i,optionalExtensions:s}),c={gl:a,reglGL:l,regl:h,getImageData:(t,n,i,s)=>{const o=new Uint8Array(i*s*4);return h.read({x:t,y:e.height-n,width:i,height:s,data:o}),new ImageData(new Uint8ClampedArray(o.buffer),i,s)}};return{gl:a,reglGL:l,regl:h,context:c}}const OP=function(e){return class extends e{createContext(){this.createCanvas();const e=this.getMap(),{preserveDrawingBuffer:t,onlyWebGL1:n,extensions:i,optionalExtensions:s}=e.options,{gl:o,regl:a,reglGL:l,context:h}=kP(this.canvas,t,n,i,s);this.gl=o,this.regl=a,this.reglGL=l,this.context=h}clearContext(){this.regl&&this.regl.clear({color:[0,0,0,0],depth:1,stencil:255})}}},{LayerAbstractRenderer:EP}=Om,RP=[0,0,0,0],LP=[1,1,-1],DP=[0,0],FP=e=>!e.bloom&&!e.ssr,HP=e=>!e.bloom,NP=e=>!e.ssr;class GroupGLLayerRenderer extends(OP(EP)){setToRedraw(){this.setRetireFrames(),super.setToRedraw()}onAdd(){super.onAdd(),this.prepareCanvas()}updateSceneConfig(){this._groundPainter&&this._groundPainter.update(),this._envPainter&&this._envPainter.update(),this._weatherPainter&&this._weatherPainter.update(),this.setToRedraw()}render(...e){this.getMap()&&this.layer.isVisible()&&(this.forEachRenderer((e=>{e._replacedDrawFn||(e.draw=this._buildDrawFn(e.draw),e.drawOnInteracting=this._buildDrawOnInteractingFn(e.drawOnInteracting),e.setToRedraw=this._buildSetToRedrawFn(e.setToRedraw),e._replacedDrawFn=!0)})),this.prepareRender(),this.prepareCanvas(),this.layer._updatePolygonOffset(),this._toRedraw=!1,this._renderChildLayers("render",e),this._renderOutlines(),this._postProcess())}prepareCanvas(){super.prepareCanvas(),this.forEachRenderer((e=>{e.prepareCanvas()}))}drawOnInteracting(...e){this.getMap()&&this.layer.isVisible()&&(this.layer._updatePolygonOffset(),this._toRedraw=!1,this._renderChildLayers("drawOnInteracting",e),this._renderOutlines(),this._postProcess())}_renderChildLayers(e,t){this._renderMode="default";const n=this.hasRenderTarget(),i=this._getDrawContext(t);if(n&&(this._drawContext.renderTarget=this._getFramebufferTarget()),this._envPainter.paint(i),this.drawGround(!0),!n)return void this._renderInMode("default",null,e,t,!0);const s=this.reglGL,o=this.layer._getSceneConfig(),a=o&&o.postProcess,l=this.isSSROn();i.jitter=DP;const h=this.layer.getGroundConfig();i.hasSSRGround=!!(l&&h&&h.enable&&h.symbol&&h.symbol.ssr),s.resetDrawCalls(),this._renderInMode("default",this._targetFBO,e,t,!0),l&&this._postProcessor.drawSSR(this._blitDepthTex(),this._targetFBO);a.bloom&&a.bloom.enable&&(this._bloomPainted=this._postProcessor.drawBloom(this._depthTex)),2===l&&this._postProcessor.drawSSR(this._blitDepthTex(),this._targetFBO,!0),s.resetDrawCalls(),this._weatherPainter.renderScene(i),this._pointDrawCount=s.getDrawCalls()}_renderInMode(e,t,n,i,s){this._renderMode=e;const o=this._getDrawContext(i);o.renderMode=this._renderMode,o.renderTarget&&(o.renderTarget.fbo=t),s&&(o.isFinalRender=!0),this.forEachRenderer(((e,s)=>{s.isVisible()&&(this.clearStencil(e,t),e[n].apply(e,i))}))}_getDrawContext(e){let t=e[0];return BP(t)||(t=e[1]),t!==this._contextFrameTime&&(this.forEachRenderer(((e,t)=>{t.isVisible()&&e.needRetireFrames&&e.needRetireFrames()&&this.setRetireFrames()})),this._drawContext=this._prepareDrawContext(t),this._contextFrameTime=t,this._frameEvent=BP(e[0])?null:e[0]),this._drawContext}_renderOutlines(){if(!this.isEnableOutline())return;const e=this._getOutlineFBO(),t=this.reglGL;t.resetDrawCalls(),this.forEachRenderer(((t,n)=>{n.isVisible()&&t.drawOutline&&t.drawOutline(e)})),this._outlineCounts=t.getDrawCalls()}_getOutlineFBO(){const{width:e,height:t}=this.canvas;let n=this._outlineFBO;if(n)e===n.width&&t===n.height||n.resize(e,t);else{const i=this.regl.texture({width:e,height:t,format:"rgba4",sampleCount:4});n=this._outlineFBO=this.regl.framebuffer({width:e,height:t,colors:[i],depth:!1,stencil:!1})}return n}_getFBOColor(e){if(this._isUseMultiSample()){const t=this._getBlitFBO(e);return t.width!==e.width||t.height!==e.height?t.resize(e.width,e.height):this.regl.clear({color:[0,0,0,0],framebuffer:t}),t.blit(e),t.color[0]}return e.color[0]}_blitDepthTex(){if(this._depthTex.subimage)return this._depthTex;const{width:e,height:t}=this._depthTex;if(!this._blitDepthFBO){const n=this.regl,i=n.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"depth stencil",width:e,height:t,format:"depth stencil"}),s=n.renderbuffer({width:e,height:t,format:"rgba4"});this._blitDepthFBO=n.framebuffer({depthStencil:i,colors:[s],colorFormat:"rgba4",width:e,height:t})}return this._blitDepthFBO.width===e&&this._blitDepthFBO.height===t||this._blitDepthFBO.resize(e,t),this.regl.clear({color:[0,0,0,0],depth:1,framebuffer:this._blitDepthFBO}),this._blitDepthFBO.blit(this._targetFBO,256,"nearest"),this._blitDepthFBO.depthStencil}_getBlitFBO(e){if(this._blitFBOs||(this._blitFBOs=[]),!e._blitFBO){const t=this._createSimpleFBOInfo(!0,e.width,e.height),n=this.regl.framebuffer(t);this._blitFBOs.push(n),e._blitFBO=n}return e._blitFBO}_isUseMultiSample(){if(this.device&&this.device.wgpu)return!1;return 0===this.regl.limits.version.indexOf("WebGL 2.0")&&this.layer.options.antialias}hasRenderTarget(){const e=this.layer._getSceneConfig(),t=e&&e.postProcess;return!(!t||!t.enable)}testIfNeedRedraw(){if(this.layer.options.forceRedrawPerFrame)return!0;if(this._toRedraw)return this._toRedraw=!1,!0;if(this.getMap().isInteracting()&&(this._groundPainter&&this._groundPainter.isEnable()||this._envPainter&&this._envPainter.isEnable()))return!0;if(this._weatherPainter&&this._weatherPainter.isEnable())return!0;if(this.isEnableScanEffect())return!0;const e=this.layer.getTerrainLayer();if(e){const t=e.getRenderer();if(t&&t.testIfNeedRedraw())return this._needUpdateSSR=!0,!0}const t=this._getLayers();for(const e of t){if(!e)continue;const t=e.getRenderer();if(t&&t.testIfNeedRedraw())return this._needUpdateSSR=!0,!0}return!1}isRenderComplete(){const e=this._getLayers();for(const t of e){const e=t.getRenderer();if(e&&!e.isRenderComplete())return!1}return!0}mustRenderOnInteracting(){const e=this._getLayers();for(const t of e){const e=t.getRenderer();if(e&&e.mustRenderOnInteracting())return!0}return!1}isCanvasUpdated(){if(super.isCanvasUpdated())return!0;const e=this._getLayers();for(const t of e){const e=t.getRenderer();if(e&&e.isCanvasUpdated())return!0}return!1}isBlank(){if(this._groundPainter&&this._groundPainter.isEnable())return!1;if(this._envPainter&&this._envPainter.isEnable())return!1;const e=this.layer.getTerrainLayer();if(e){const t=e.getRenderer();if(t&&!t.isBlank())return!1}const t=this._getLayers();for(const e of t){const t=e.getRenderer();if(t&&!t.isBlank())return!1}return!0}initContext(){if(super.initContext(),!this.context)return;this.forEachRenderer((e=>{e.canvas&&e.initContext()}));const e=this.layer,{regl:t,gl:n,reglGL:i,device:s}=this.context;this.device=s||t,this.regl=t,this.reglGL=i,this.gl=n,this.canvas.gl=this.gl,this._jitter=[0,0];const o=t||s;this._groundPainter=new GroundPainter(o,this.layer),this._envPainter=new EnvironmentPainter(o,this.layer);const a=this.layer.getWeatherConfig();this._weatherPainter=new WeatherPainter(o,e,a),this._analysisPainter=new AnalysisPainter(o,e),this._scanEffectPainter=new ScanEffectPainter(o,e);const l=this.layer._getSceneConfig()||{},h=l&&l.postProcess;this._jitGetter=new Jitter(h&&h.antialias&&h.antialias.jitterRatio||.2),this._postProcessor=new PostProcess(o,this.layer,this._jitGetter),this._shadowProcess=new ShadowProcess(o,this.layer)}clearContext(){super.clearContext(),this._clearFramebuffers()}_clearFramebuffers(){const e=this.regl;this._targetFBO&&e.clear({color:RP,depth:1,stencil:255,framebuffer:this._targetFBO}),this._outlineFBO&&e.clear({color:RP,depth:1,stencil:255,framebuffer:this._outlineFBO})}resizeCanvas(){const e=this.canvas.width,t=this.canvas.height;!this._targetFBO||this._targetFBO.width===e&&this._targetFBO.height===t||(super.resizeCanvas(),this._targetFBO.resize(e,t),this._clearFramebuffers(),this.forEachRenderer((e=>{e.canvas&&e.resizeCanvas()})))}_getLayers(){return this.layer._getLayers()}forEachRenderer(e){const t=this._getLayers();for(const n of t){if(!n.isVisible()||!n.options.beneathTerrain)continue;const t=n.getRenderer();t&&e(t,n)}const n=this.layer.getTerrainLayer();if(n){const t=n.getRenderer();t&&e(t,n)}for(const n of t){if(!n.isVisible()||n.options.beneathTerrain)continue;const t=n.getRenderer();t&&e(t,n)}}clearStencil(e,t){const n={stencil:e.getStencilValue?e.getStencilValue():255};t&&(n.framebuffer=t),this.device.clear(n)}onRemove(){const e=this.canvas.pickingFBO;e&&e.destroy&&!e.___disposed&&(e.___disposed=!0,e.destroy()),this._destroyFramebuffers(),this._groundPainter&&(this._groundPainter.dispose(),delete this._groundPainter),this._envPainter&&(this._envPainter.dispose(),delete this._envPainter),this._shadowProcess&&(this._shadowProcess.dispose(),delete this._shadowProcess),this._postProcessor&&(this._postProcessor.dispose(),delete this._postProcessor),this._outlineFBO&&(this._outlineFBO.destroy(),delete this._outlineFBO),this._weatherPainter&&(this._weatherPainter.dispose(),delete this._weatherPainter),delete this.gl,delete this.regl,super.onRemove()}hitDetect(){return!1}_destroyFramebuffers(){if(this._targetFBO&&(this._targetFBO.destroy(),delete this._targetFBO,this._postFBO&&(this._postFBO.destroy(),delete this._postFBO),this._blitDepthFBO&&(this._blitDepthFBO.destroy(),delete this._blitDepthFBO),this._blitFBOs)){for(let e=0;e<this._blitFBOs.length;e++)this._blitFBOs[e]&&this._blitFBOs[e].destroy();delete this._blitFBOs}}setRetireFrames(){this._needRetireFrames=!0}getFrameTime(){return this._contextFrameTime}getFrameEvent(){return this._frameEvent}getFrameContext(){return this._drawContext}drawGround(e){const t=this.layer.getGroundConfig();if(!t||!t.enable)return!1;if(!this._groundPainter)return!1;const n=this.getFrameContext(),i=n.jitter;n.jitter=DP;const s=this.layer.getPolygonOffsetCount();let o;n.offsetFactor=s+1,n.offsetUnits=s+1,e&&(o=n.sceneFilter,delete n.sceneFilter);const a=this._groundPainter.paint(n);return this._groundPainter.needToRedraw()&&this.setToRedraw(),o&&(n.sceneFilter=o),n.jitter=i,a}_buildDrawFn(e){const t=this;return function(n,i){return(i=i||t._drawContext)&&i.renderTarget&&(i.renderTarget.getFramebuffer=zP,i.renderTarget.getDepthTexture=GP),e.call(this,n,i)}}_buildDrawOnInteractingFn(e){const t=this;return function(n,i,s){return(s=s||t._drawContext)&&s.renderTarget&&(s.renderTarget.getFramebuffer=zP,s.renderTarget.getDepthTexture=GP),e.call(this,n,i,s)}}_buildSetToRedrawFn(e){return function(...t){return e.apply(this,t)}}isEnableSSR(){const e=this.layer._getSceneConfig(),t=e&&e.postProcess;return t&&t.enable&&t.ssr&&t.ssr.enable}isSSROn(){const e=this.isEnableSSR(),t=this.getMap();if(!e||t.getPitch()<=-.001)return 0;const n=t.projViewMatrix,i=this._postProcessor.getPrevSsrProjViewMatrix();return i&&zA(i,n)?1:2}isEnableTAA(){return!1}isEnableSSAO(){return!1}isEnableOutline(){const e=this.layer._getSceneConfig(),t=e&&e.postProcess;return t&&t.enable&&t.outline&&t.outline.enable}isEnableWeather(){const e=this.layer._getSceneConfig(),t=e&&e.weather;return t&&t.enable}_getViewStates(){const e=this.layer.getMap();if(!this._renderedView){this._renderedView={center:e.getCenter(),bearing:e.getBearing(),pitch:e.getPitch(),res:e.getResolution()};let t=!1;if(e.options.lights){const n=e.getLightManager().getDirectionalLight().direction||LP;this._renderedView.lightDirection=qA([],n),t=!0}return{viewChanged:!0,lightDirectionChanged:t}}const t=e.getResolution()/this._renderedView.res,n=e.coordToContainerPoint(this._renderedView.center),i=this.layer.options.viewMoveThreshold,s=n._sub(e.width/2,e.height/2).mag()>i||t<.95||t>1.05;let o=!1;if(e.options.lights){const t=e.getLightManager().getDirectionalLight().direction||LP;o=!cy(this._renderedView.lightDirection,t),o&&(this._renderedView.lightDirection=qA([],t))}return s&&(this._renderedView.center=e.getCenter(),this._renderedView.bearing=e.getBearing(),this._renderedView.pitch=e.getPitch(),this._renderedView.res=e.getResolution()),{viewChanged:s,lightDirectionChanged:o}}_prepareDrawContext(e){const t=this.layer._getSceneConfig(),n=t&&t.postProcess,i=t&&t.weather,s={timestamp:e,renderMode:this._renderMode||"default",includes:{},states:this._getViewStates(),testSceneFilter:e=>!s.sceneFilter||s.sceneFilter(e),isFinalRender:!1,weather:{fog:i&&i.fog}},o=this._jitGetter;o&&o.setRatio(n&&n.antialias&&n.antialias.jitterRatio||.2);const a=this.isSSROn();let l;if(n&&n.enable){if(this.isEnableTAA()){(this.getMap().isInteracting()||this._needRetireFrames)&&o.reset(),o.getJitter(this._jitter),o.frame()}else U_(this._jitter,0,0);s.jitter=this._jitter;const e=n.bloom&&n.bloom.enable;e&&a?(s.bloom=1,s.sceneFilter=FP):e?(s.bloom=1,s.sceneFilter=HP):a&&(s.sceneFilter=NP),l=this._getFramebufferTarget(),l&&(s.renderTarget=l)}else this._destroyFramebuffers();return"noAa"!==this._renderMode&&(this._shadowContext=this._prepareShadowContext(s),this._shadowContext&&(s.includes.shadow=1),this._includesState=this._updateIncludesState(s)),this._shadowContext&&(s.shadow=this._shadowContext,s.includes.shadow=1),s.states.includesChanged=this._includesState,n&&n.enable&&this._postProcessor&&this._postProcessor.setContextIncludes(s),s}_renderAnalysis(e){const t=this._getLayers().filter((e=>e.isVisible()));return this.layer.getTerrainLayer()&&t.push(this.layer.getTerrainLayer()),this._analysisPainter.paint(e,t)}_updateIncludesState(e){let t=!1;const n=Object.keys(e.includes),i=this._prevIncludeKeys;if(i){const e=n.filter((e=>-1===i.indexOf(e))).concat(i.filter((e=>-1===n.indexOf(e))));e.length&&(t=e.reduce(((e,t)=>(e[t]=1,e)),{}))}return this._prevIncludeKeys=n,t}_prepareShadowContext(e){const t=this.layer._getSceneConfig();if(!t||!t.shadow||!t.shadow.enable)return this._shadowProcess&&(this._shadowProcess.dispose(),delete this._shadowProcess),null;this._shadowProcess||(this._shadowProcess=new ShadowProcess(this.regl,this.layer));const n={config:t.shadow,defines:this._shadowProcess.getDefines(),uniformDeclares:ShadowProcess.getUniformDeclares()};return n.renderUniforms=this._renderShadow(e),n}_renderShadow(e){const t=e.renderTarget&&e.renderTarget.fbo,n=this.layer._getSceneConfig(),i=[];let s=e.states.lightDirectionChanged||e.states.viewChanged;this.forEachRenderer(((e,t)=>{if(!e.getShadowMeshes||!t.isVisible())return;const n=e.getShadowMeshes();if(Array.isArray(n))for(let e=0;e<n.length;e++)n[e]&&(n[e].needUpdateShadow&&(s=!0,n[e].needUpdateShadow=!1),n[e].hasFunctionUniform&&(n[e].hasFunctionUniform("minAltitude")||n[e].setFunctionUniform("minAltitude",(()=>t&&t.options.altitude||0)),i.push(n[e])))})),this._shadowScene||(this._shadowScene=new Scene),this._shadowScene.setMeshes(i);const o=this.getMap(),a=n.shadow,l=o.getLightManager(),h=l&&l.getDirectionalLight().direction||LP;return this._shadowProcess.render(!n.ground||!n.ground.enable,o.projMatrix,o.viewMatrix,a.color,a.opacity,h,this._shadowScene,this._jitter,t,s)}_renderWeather(e){let t=[];if(this.forEachRenderer(((e,n)=>{if(!e.getAnalysisMeshes||!n.isVisible())return;const i=e.getAnalysisMeshes();t=t.concat(i)})),this._groundPainter){const e=this._groundPainter.getRenderMeshes();t=t.concat(e)}const n=this.layer.getWeatherConfig();return this._weatherPainter.paint(e,t,n)}_renderScanEffect(e){let t=[];if(this.forEachRenderer(((e,n)=>{if(!e.getAnalysisMeshes||!n.isVisible())return;const i=e.getAnalysisMeshes();t=t.concat(i)})),this._groundPainter){const e=this._groundPainter.getRenderMeshes();t=t.concat(e)}return this._scanEffectPainter.paint(e,t)}getGroundMesh(){if(this._groundPainter){return this._groundPainter.getRenderMeshes()}return[]}_getFramebufferTarget(){const e=this.layer._getSceneConfig();if(!this._targetFBO){const t=this.regl;let n=this._depthTex;(!n||!n._texture||n._texture.refCount<=0)&&(n=null);const i=this.createFBOInfo(e&&e.postProcess,n);this._depthTex=i.depth||i.depthStencil,this._targetFBO=t.framebuffer(i),this._clearFramebuffers()}return{fbo:this._targetFBO}}_createSimpleFBOInfo(e,t,n){t=t||this.canvas.width,n=n||this.canvas.height;const i=this.device,s=this._isUseMultiSample();let o;if(!e&&s)o=i.renderbuffer({width:t,height:n,samples:this.layer.options.multiSamples,format:"rgba8"});else{o=i.texture({min:"nearest",mag:"nearest",type:"uint8",width:t,height:n,sampleCount:4})}return{width:t,height:n,colors:[o],colorFormat:s?"rgba8":"rgba"}}createFBOInfo(e,t){let{width:n,height:i}=this.canvas;n=n||1,i=i||1;const s=this.device,o=this._createSimpleFBOInfo(),a=this._isUseMultiSample(),l=!this.regl||s.hasExtension("WEBGL_depth_texture");if(a){const e=t||s.renderbuffer({width:n,height:i,format:"depth24 stencil8",samples:this.layer.options.multiSamples});o.depthStencil=e}else if(l){const e=t||s.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"depth stencil",width:n,height:i,format:"depth stencil"});o.depthStencil=e}else{const e=t||s.renderbuffer({width:n,height:i,format:"depth stencil"});o.depthStencil=e}return o}_postProcess(){if(!this._targetFBO)return void(this._needRetireFrames=!1);const e=this.layer._getSceneConfig(),t=e&&e.postProcess;if(!t||!t.enable){if(this.isEnableWeather())throw new Error("you must enable the post process to turn on weather");return}this.layer.fire("postprocessstart");const n=this.layer.getMap();let i=t.sharpen&&t.sharpen.factor;i||0===i||(i=.2);let s=0,o=.2,a=.3,l=1,h=[1,1,0];t.outline&&(s=+!!t.outline.enable,o=UP(t.outline,"highlightFactor",o),a=UP(t.outline,"outlineFactor",a),l=UP(t.outline,"outlineWidth",l),h=UP(t.outline,"outlineColor",h));const c=t.ssr&&t.ssr.enable,u=t.bloom&&t.bloom.enable,f=this._analysisPainter._hasAnalysis(),g=this._weatherPainter._hasWeather(),m=this.isEnableScanEffect(),A=u||c||f||g||m;let w=this._postFBO;if(A){if(!w){const e=this._createSimpleFBOInfo();this._isUseMultiSample()&&(e.depthStencil=this.regl.renderbuffer({width:this.canvas.width,height:this.canvas.height,samples:this.layer.options.multiSamples,format:"depth24 stencil8"})),w=this._postFBO=this.regl.framebuffer(e)}const{width:e,height:t}=this.canvas;w.width===e&&w.height===t||w.resize(e,t)}else w=null,this._postFBO&&(this._postFBO.destroy(),delete this._postFBO);let T=this._getFBOColor(this._targetFBO);if(this._postProcessor.fxaa(w,T,0,+!(!t.toneMapping||!t.toneMapping.enable),+!(A||!t.sharpen||!t.sharpen.enable),n.getDevicePixelRatio(),i,s&&this._outlineCounts>0&&this._getOutlineFBO(),o,a,l,h),w&&(T=this._getFBOColor(w)),u&&this._bloomPainted){const e=t.bloom,n=+e.threshold||0,i=UP(e,"factor",1),s=UP(e,"radius",1);T=this._postProcessor.bloom(T,null,null,n,i,s,0)}if(c&&(this._postProcessor.genSsrMipmap(T,this._blitDepthTex()),this._needUpdateSSR)){const e=this._needRetireFrames;this.setToRedraw(),this._needRetireFrames=e,this._needUpdateSSR=!1}this._scanEffectPainter&&this.isEnableScanEffect()&&(T=this._renderScanEffect(T)),this._analysisPainter&&(T=this._renderAnalysis(T)),this.isEnableWeather()&&(T=this._renderWeather(T)),A&&this._postProcessor.renderFBOToScreen(T,+!(!t.sharpen||!t.sharpen.enable),i,n.getDevicePixelRatio()),this.layer.fire("postprocessend")}isEnableScanEffect(){const e=this.layer._getSceneConfig(),t=e&&e.postProcess&&e.postProcess.scanEffect;return t&&t.enable&&t.effects.length}}function BP(e){return"number"==typeof e&&!isNaN(e)}function zP(e){return e._framebuffer.framebuffer}function GP(e){return e.depthStencil._texture.texture}function UP(e,t,n){return null==e[t]?n:e[t]}class TerrainWorkerConnection extends Um.Actor{constructor(e){super("@maptalks/terrain"),this.mapId=e}checkUrl(e){return e&&Zi.isString(e)?Zi.getAbsoluteURL(e):e}fetchTerrain(e,t,n){e=this.checkUrl(e);const i=t.tileImage,s={actorId:this.actorId,mapId:this.mapId,command:"fetchTerrain",params:{url:e,origin:location.origin,terrainWidth:t.terrainWidth,type:t.type,accessToken:t.accessToken,cesiumIonTokenURL:t.cesiumIonTokenURL,error:t.error,colors:t.colors,tileSize:t.tileSize,tileImage:i}},o=[];i&&o.push(i),this.send(s,o,((e,t)=>{e?n(e):n(e,t)}))}abortTerrain(e,t){this.broadcast({actorId:this.actorId,mapId:this.mapId,command:"abortTerrain",params:{url:e}},null,t)}addLayer(e,t,n){this.broadcast({actorId:this.actorId,mapId:this.mapId,layerId:e,command:"addLayer",params:{}},null,n)}createTerrainMesh(e,t){this.send({actorId:this.actorId,command:"createTerrainMesh",params:e},[e.terrainHeights.data.buffer],((e,n)=>{e?t(e):t(e,n)}))}removeLayer(e,t,n){this.broadcast({mapId:this.mapId,layerId:e,command:"removeLayer"},null,n)}}class Martini{constructor(e=257){this.gridSize=e;const t=e-1;if(t&t-1)throw new Error(`Expected grid size to be 2^n+1, got ${e}.`);this.numTriangles=t*t*2-2,this.numParentTriangles=this.numTriangles-t*t,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(4*this.numTriangles);for(let e=0;e<this.numTriangles;e++){let n=e+2,i=0,s=0,o=0,a=0,l=0,h=0;for(1&n?o=a=l=t:i=s=h=t;(n>>=1)>1;){const e=i+o>>1,t=s+a>>1;1&n?(o=i,a=s,i=l,s=h):(i=o,s=a,o=l,a=h),l=e,h=t}const c=4*e;this.coords[c+0]=i,this.coords[c+1]=s,this.coords[c+2]=o,this.coords[c+3]=a}}createTile(e){return new Tile(e,this)}}class Tile{constructor(e,t){const n=t.gridSize;if(e.length!==n*n)throw new Error(`Expected terrain data of length ${n*n} (${n} x ${n}), got ${e.length}.`);this.terrain=e,this.martini=t,this.errors=new Float32Array(e.length),this.update()}update(){const{numTriangles:e,numParentTriangles:t,coords:n,gridSize:i}=this.martini,{terrain:s,errors:o}=this;for(let a=e-1;a>=0;a--){const e=4*a,l=n[e+0],h=n[e+1],c=n[e+2],u=n[e+3],f=l+c>>1,g=h+u>>1,m=f+g-h,A=g+l-f,w=g*i+f,T=Math.abs((s[h*i+l]+s[u*i+c])/2-s[w]);if(o[w]=Math.max(o[w],T),a<t){o[w]=Math.max(o[w],o[(h+A>>1)*i+(l+m>>1)],o[(u+A>>1)*i+(c+m>>1)])}}}getMesh(e=0){const{gridSize:t,indices:n}=this.martini,{errors:i}=this;let s=0,o=0;const a=t-1;function l(a,h,c,u,f,g){const m=a+c>>1,A=h+u>>1;Math.abs(a-f)+Math.abs(h-g)>1&&i[A*t+m]>e?(l(f,g,a,h,m,A),l(c,u,f,g,m,A)):(n[h*t+a]=n[h*t+a]||++s,n[u*t+c]=n[u*t+c]||++s,n[g*t+f]=n[g*t+f]||++s,o++)}n.fill(0),l(0,0,a,a,a,0),l(a,a,0,0,0,a);const h=new Uint16Array(2*s),c=new Uint32Array(3*o);let u=0;function f(s,o,a,l,g,m){const A=s+a>>1,w=o+l>>1;if(Math.abs(s-g)+Math.abs(o-m)>1&&i[w*t+A]>e)f(g,m,s,o,A,w),f(a,l,g,m,A,w);else{const e=n[o*t+s]-1,i=n[l*t+a]-1,f=n[m*t+g]-1;h[2*e]=s,h[2*e+1]=o,h[2*i]=a,h[2*i+1]=l,h[2*f]=g,h[2*f+1]=m,c[u++]=e,c[u++]=i,c[u++]=f}}return f(0,0,a,a,a,0),f(a,a,0,0,0,a),{vertices:h,triangles:c}}getMeshWithSkirts(e=0,t){const{gridSize:n,indices:i}=this.martini,{errors:s}=this;let o=0,a=0;const l=n-1;let h,c,u=0;const f=[],g=[],m=[],A=[];function w(t,T,S,M,C,I){const E=t+S>>1,D=T+M>>1;Math.abs(t-C)+Math.abs(T-I)>1&&s[D*n+E]>e?(w(C,I,t,T,E,D),w(S,M,C,I,E,D)):(h=T*n+t,c=M*n+S,u=I*n+C,0===i[h]&&(0===t?f.push(o):t===l&&g.push(o),0===T?m.push(o):T===l&&A.push(o),i[h]=++o),0===i[c]&&(0===S?f.push(o):S===l&&g.push(o),0===M?m.push(o):M===l&&A.push(o),i[c]=++o),0===i[u]&&(0===C?f.push(o):C===l&&g.push(o),0===I?m.push(o):I===l&&A.push(o),i[u]=++o),a++)}let T;i.fill(0),w(0,0,l,l,l,0),w(l,l,0,0,0,l),T=t?2*(o+3*f.length-2+3*g.length-2+3*m.length-2+3*A.length-2):2*(o+f.length+g.length+m.length+A.length);const S=3*(a+2*(f.length-1)+2*(g.length-1)+2*(m.length-1)+2*(A.length-1)),M=new Uint16Array(T),C=new Uint32Array(S);let I=0;function E(t,o,a,l,h,c){const u=t+a>>1,f=o+l>>1;if(Math.abs(t-h)+Math.abs(o-c)>1&&s[f*n+u]>e)E(h,c,t,o,u,f),E(a,l,h,c,u,f);else{const e=i[o*n+t]-1,s=i[l*n+a]-1,u=i[c*n+h]-1;M[2*e]=t,M[2*e+1]=o,M[2*s]=a,M[2*s+1]=l,M[2*u]=h,M[2*u+1]=c,C[I++]=e,C[I++]=s,C[I++]=u}}E(0,0,l,l,l,0),E(l,l,0,0,0,l),f.sort(((e,t)=>M[2*e+1]-M[2*t+1])),g.sort(((e,t)=>M[2*t+1]-M[2*e+1])),m.sort(((e,t)=>M[2*t]-M[2*e])),A.sort(((e,t)=>M[2*e]-M[2*t]));let D,H,N,B,z=2*o,U=0;function j(e){U=e.length;for(let n=0;n<U-1;n++)D=e[n],H=e[n+1],N=z/2,B=(z+(t?6:2))/2,M[z++]=2*D,M[z++]=2*D+1,t&&(M[z++]=2*D,M[z++]=2*D+1,M[z++]=2*H,M[z++]=2*H+1),t?(C[I++]=N+1,C[I++]=N,C[I++]=N+2,C[I++]=N,C[I++]=B,C[I++]=N+2):(C[I++]=D,C[I++]=N,C[I++]=H,C[I++]=N,C[I++]=B,C[I++]=H);M[z++]=2*e[U-1],M[z++]=2*e[U-1]+1}j(f);const W=z;j(g);const q=z;j(m);const Z=z;j(A);return{vertices:M,triangles:C,numVerticesWithoutSkirts:o,numTrianglesWithoutSkirts:a,leftSkirtIndex:W,rightSkirtIndex:q,bottomSkirtIndex:Z,topSkirtIndex:z}}}const VP={};function jP(e,t,n){let i=VP[n];i||(i=VP[n]=new Martini(n));const s=i.createTile(t).getMeshWithSkirts(e,!0),{triangles:o,vertices:a,leftSkirtIndex:l,rightSkirtIndex:h,bottomSkirtIndex:c,topSkirtIndex:u}=s;let{numVerticesWithoutSkirts:f,numTrianglesWithoutSkirts:g}=s;f||(f=a.length/2,g=o.length/3);const m=a.length/2,A=new Float32Array(3*m),w=new Float32Array(2*m);let T=1/0,S=-1/0;const M=n-1;for(let e=0;e<m;e++){const i=a[2*e],s=a[2*e+1];if(e>=f){const t=i/2*3;let n,s=.001;(e-(e<l/2?f:e<h/2?l/2:e<c/2?h/2:c/2))%3==0?(n=Math.min(0,T),s=0):n=A[t+2];A[3*e]=A[t],A[3*e+1]=A[t+1],A[3*e+2]=n,w[2*e]=A[t]/M+s,w[2*e+1]=-A[t+1]/M+s}else{const o=t[s*n+i];A[3*e]=1*i,A[3*e+1]=1*-s,A[3*e+2]=o,w[2*e]=i/M,w[2*e+1]=s/M,o<T&&(T=o),o>S&&(S=o)}}return{positions:A,texcoords:w,triangles:o,leftSkirtIndex:l,rightSkirtIndex:h,bottomSkirtIndex:c,topSkirtIndex:u,numTrianglesWithoutSkirts:g,numVerticesWithoutSkirts:f,minHeight:Math.min(0,T),maxHeight:S,terrainWidth:n}}function WP(e,t,n,i,s,o,a,l,h){const c={};for(let u=0;u<h;u++)c[u+""]=ZP(e,t,n,i,s,o,a,l,u);return c}const qP=[];function ZP(e,t,n,i,s,o,a,l,h){if((i-=h)<=0)return qP;const c=e.getTileSize().width,u=e._getTileOffset(i,s),f=o[0]-u[0],g=u[1]-o[1],m=e._getTileConfig(),A=e.getSpatialReference().getResolution(i),w=m.tileSystem.scale.y,T=1e-7;let S=0,M=0,C=l/=Math.pow(2,h),I=l;if(f<0?C+=Math.ceil(-f/c-T):f>0&&(S-=Math.ceil(f/c-T)),g>0?M-=Math.ceil(g/c-T):g<0&&(I+=Math.ceil(-g/c-T)),0===S&&0===M&&C<=1&&I<=1){const s=Math.floor(t*l);let o=Math.floor(n*l);const h=o;return w!==a&&(o=JP(m,o,A)),[{x:s,y:o,skinY:h,z:i,offset:u,tileSize:c,id:e._getTileId(s,o,i)}]}const E=[];for(let s=S;s<C;s++)for(let o=M;o<I;o++){const h=t*l+s;let f=n*l+o;const g=f;w!==a&&(f=JP(m,f,A)),E.push({x:h,y:f,skinY:g,z:i,offset:u,tileSize:c,id:e._getTileId(h,f,i)})}return E}function XP(e,t,n,i){let s=e/n*i/t;return s<1?(s=1/s,s=1/Math.round(s)):s=Math.round(s),s}function YP(e,t,n){const i=e.getResolution(t),s=t-Math.log(n/i)*Math.LOG2E;return{zoom:s,res:e.getResolution(s)}}function JP(e,t,n){const i=e.fullExtent,s=e.tileSize.width,o=Math.max(i.top,i.bottom),a=Math.min(i.top,i.bottom);return Math.ceil(o/s/n)-1-Math.floor(a/s/n)-t}function QP(e,t){const n=t*t,i=0!==e?new Float32Array(n):new Uint8Array(n);return i.fill(e),{data:i,width:t,height:t,max:e,min:e}}new Re(0,0);const $P=QP(0,5),KP=jP(1,$P.data,$P.width);function eI(e,t,n){const i=n&&n.includes;if(i)for(const s in i)i[s]&&(n[s].uniformDeclares&&t.push(...n[s].uniformDeclares),n[s].defines&&vC(e,n[s].defines))}function tI(e,t){const n=t&&t.includes;if(n)for(const i in n)n[i]&&t[i].renderUniforms&&vC(e,t[i].renderUniforms)}KP.empty=!0;var nI=Object.freeze({__proto__:null,fillIncludes:eI,setIncludeUniformValues:tI});const rI=[],iI=[];class TerrainPainter{constructor(e){this.layer=e;const t=e.getRenderer();this.graphics=t.regl||t.device,this.renderer=new Renderer(this.graphics),this._leafScene=new Scene;const n=new Uint8Array(16);n.fill(255),this._emptyTileTexture=this.graphics.texture({width:2,height:2,data:n}),this._resLoader=new ResourceLoader(this._emptyTileTexture),this._createEmptyTerrainGeo()}setToRedraw(){this.layer.getRenderer().setToRedraw()}getMap(){return this.layer.getMap()}startFrame(e){e&&e.states&&e.states.includesChanged&&(this.shader.dispose(),delete this.shader),this.shader||this.initShader(e),this._leafScene.clear()}createTerrainMesh(e,t){const{mesh:n,image:i}=t;let s=t.terrainMesh;const{positions:o,texcoords:a,triangles:l,empty:h}=n;if(s&&s.geometry!==this._emptyTerrainGeometry)s.geometry.updateData("aPosition",o),s.geometry.updateData("aTexCoord",a),s.geometry.setElements(l),s.geometry.generateBuffers(this.graphics);else{const e=h?this._emptyTerrainGeometry:new Geometry({aPosition:o,aTexCoord:a},l,0);e!==this._emptyTerrainGeometry&&e.generateBuffers(this.graphics),s?s.geometry=e:s=new Mesh(e,null,{disableVAO:!0})}if(!s.uniforms.skin){const e=this.getEmptyTexture();s.setUniform("skin",e)}if(!s.uniforms.flatMask){const e=this.getEmptyTexture();s.setUniform("flatMask",e)}return s.setUniform("heightTexture",i),this.prepareMesh(s,e,t),s}_updateMaskDefines(e){const t=this.layer.getRenderer();t&&t.updateMaskDefines(e)}_getPositionMatrix(e){const t=this._getHeightScale(),n=AA(e);return bA(n,n,[1,1,t]),n}_getHeightScale(){let e=this.layer.options.exaggeration;return xC(e)&&(e=1),this._getPointZ(100)/100*e}_getLocalTransform(e,t,n){const i=this.getMap(),s=this.layer.getTileSize().width,o=t.res/i.getGLRes(),a=s/(n-1),{extent2d:l,offset:h}=t;ZA(rI,(l.xmin-h[0])*o,(t.extent2d.ymax-h[1])*o,0);const c=AA(e);return xA(c,c,rI),ZA(iI,o*a,o*a,1),bA(c,c,iI),c}prepareMesh(e,t,n){if(!e.isValid())return;const{mesh:i}=n;this._updateMaskDefines(e);const{triangles:s,numTrianglesWithoutSkirts:o,terrainWidth:a}=i;e.localTransform=this._getLocalTransform(e.localTransform||[],t,a),e.positionMatrix=this._getPositionMatrix(e.positionMatrix||[]),e.properties.skirtOffset=3*o,e.properties.skirtCount=s.length-3*o,e.properties.z=t.z,e.properties.minHeight=i.minHeight,e.properties.maxHeight=i.maxHeight,e.properties.terrainWidth=a,e.castShadow=!1,MC(e.uniforms,"minAltitude")||Object.defineProperty(e.uniforms,"minAltitude",{enumerable:!0,get:()=>n.minAltitude||0})}addTerrainImage(e,t){const n=t.terrainMesh;n&&n.geometry&&t.skin&&(n.setUniform("skin",t.skin.color[0]),n.setUniform("flatMask",t.mask.color[0]),n.setUniform("polygonOpacity",1),this._leafScene.addMesh(n))}endFrame(e){this.updateIBLDefines(this.shader);let t=0;const n=this.getUniformValues(),i=this._getRenderFBO(e);return this.shader.filter=e&&e.sceneFilter,tI(n,e),this._leafScene.getMeshes().forEach((e=>{this._updateMaskDefines(e)})),t+=this.renderer.render(this.shader,n,this._leafScene,i),t}delete(){this.shader&&(this.shader.dispose(),delete this.shader),this._emptyTileTexture&&(this._emptyTileTexture.destroy(),delete this._emptyTileTexture),this._emptyTerrainGeometry&&(this._emptyTerrainGeometry.dispose(),delete this._emptyTerrainGeometry)}deleteMesh(e){if(!e)return;const t=e.geometry;e.dispose(),t!==this._emptyTerrainGeometry&&t.dispose()}initShader(e){const t=[],n=[],i={},s=[];eI(i,s,e),this.shader=new MeshShader({name:"terrain-mesh",vert:"#define SHADER_NAME TERRAIN_MESH\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform float minAltitude;\nuniform mat4 projViewModelMatrix;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform float heightScale;\nvarying vec2 vUv;\nuniform sampler2D flatMask;\n#include <common_pack_float>\n#include <mask_vert>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\nvoid main() {\n  vec2 c = aTexCoord;\n  c.y = 1. - c.y;\n  vec4 d = texture2D(flatMask, c);\n  float e = aPosition.z;\n  if(length(d) < 2.) {\n    float f = decodeFloat32(d);\n    e = min(aPosition.z, f);\n  }\n  vec4 h = vec4(aPosition.xy, (e + minAltitude) * heightScale, 1.);\n  h = positionMatrix * h;\n#ifdef HAS_MASK_EXTENT\ngl_Position = projMatrix * getMaskPosition(h, modelMatrix);\n#else\ngl_Position = projViewModelMatrix * h;\n#endif\nvUv = aTexCoord;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(h);\n#endif\n}",frag:"#define SHADER_NAME TERRAIN_MESH\nprecision mediump float;\nuniform sampler2D skin;\nuniform float polygonOpacity;\nuniform float layerOpacity;\nvarying vec2 vUv;\n#include <mask_frag>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\nvoid main() {\n  vec2 c = vec2(vUv);\n  c.y = 1. - c.y;\n  vec4 d = texture2D(skin, c);\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat e = shadow_computeShadow();\n  d.rgb = shadow_blend(d.rgb, e).rgb;\n#endif\ngl_FragColor = d * polygonOpacity * layerOpacity;\n#ifdef HAS_MASK_EXTENT\ngl_FragColor = setMask(gl_FragColor);\n#endif\n}",wgslVert:"",wgslFrag:"",uniforms:s.concat([{name:"modelViewMatrix",type:"function",fn:function(e,t){return vA(n,t.viewMatrix,t.modelMatrix)}},{name:"projViewModelMatrix",type:"function",fn:function(e,n){return vA(t,n.projViewMatrix,n.modelMatrix)}}]),defines:i,extraCommandProps:this.getExtraCommandProps()})}getExtraCommandProps(){const e=this.layer.getRenderer().canvas;return{viewport:{x:0,y:0,width:()=>e?e.width:1,height:()=>e?e.height:1},cull:{enable:!0,face:"back"},depth:{enable:!0,mask:()=>!!this.layer.options.depthMask,func:this.layer.options.depthFunc||"<="},blend:{enable:!0,func:{src:this.layer.options.blendSrc,dst:this.layer.options.blendDst},equation:"add"}}}_getRenderFBO(e){return e&&e.renderTarget&&e.renderTarget.fbo}getUniformValues(){const e=this.getMap(),t=e.projViewMatrix,n=this.layer.getRenderer().getMaskUniforms();let i=this.layer.options.opacity;xC(i)&&(i=1);const s={viewMatrix:e.viewMatrix,projMatrix:e.projMatrix,projViewMatrix:t,heightScale:1,layerOpacity:i};return vC(s,n),s}_getPointZ(e){const t=this.layer.getMap();if(!t)return null;return t.altitudeToPoint(e,t.getGLRes())}getEmptyTexture(){return this._emptyTileTexture}hasIBL(){const e=this.getMap().getLightManager();return!!(e&&e.getAmbientResource())}updateIBLDefines(e){const t=e.shaderDefines;let n=!1;this.hasIBL()?t[["HAS_IBL_LIGHTING"]]||(t.HAS_IBL_LIGHTING=1,n=!0):t[["HAS_IBL_LIGHTING"]]&&(delete t.HAS_IBL_LIGHTING,n=!0),n&&(e.shaderDefines=t)}_createEmptyTerrainGeo(){const e=KP,{positions:t,texcoords:n,triangles:i}=e;this._emptyTerrainGeometry=new Geometry({aPosition:t,aTexCoord:n},i,0),this._emptyTerrainGeometry.generateBuffers(this.graphics)}}const{getIBLResOnCanvas:sI,getPBRUniforms:oI,loginIBLResOnCanvas:aI,logoutIBLResOnCanvas:lI}=SM.PBRUtils,hI={baseColorFactor:[1,1,1,1],emissiveFactor:[0,0,0],baseColorIntensity:1,emitColorFactor:1,roughnessFactor:1,metallicFactor:0,emitMultiplicative:1,outputSRGB:1,hsv:[0,0,0],contrast:1,alphaTest:0};class TerrainLitPainter extends TerrainPainter{constructor(...e){super(...e),this.createIBLTextures(),this._matVer=0}updateMaterial(e,t){this._matVer=t,this._material=this._material||{},vC(this._material,e),this.setToRedraw()}setMaterial(e,t){this._matVer=t,this._material=vC({},hI,e),this.setToRedraw()}createIBLTextures(){const e=this.getMap().getRenderer().canvas;aI(e,this.graphics,this.getMap()),this.layer.fire("iblupdated")}disposeIBLTextures(){const e=this.getMap().getRenderer().canvas;lI(e,this.getMap())}createTerrainMesh(e,t){const{mesh:n,image:i}=t,{positions:s,texcoords:o,triangles:a,leftSkirtIndex:l,rightSkirtIndex:h,bottomSkirtIndex:c,numVerticesWithoutSkirts:u}=n,f=new Int8Array(s.length);for(let e=2;e<f.length;e+=3)e<3*u?f[e]=1:e<l/2*3?f[e-2]=-1:e<h/2*3?f[e-2]=1:f[e-1]=e<c/2*3?-1:1;const g=new Geometry({aPosition:s,aTexCoord:o,aNormal:f},a,0);let m;g.createTangent(),delete g.data.aNormal,g.generateBuffers(this.graphics),m=i?this.graphics.texture({width:i.width,height:i.height,data:i,min:"linear",mag:"linear"}):this.getEmptyTexture();const A=this.getEmptyTexture(),w=vC({},hI,this.layer.options.material||{});w.skinTexture=A,w.terrainHeightTexture=m;const T=new SM.StandardMaterial(w),S=new Mesh(g,T);if(S.properties.matVer=this._matVer,!S.uniforms.flatMask){const e=this.getEmptyTexture();S.setUniform("flatMask",e)}const M=S.defines;return M.HAS_UV_FLIP=1,M.HAS_TERRAIN_NORMAL=1,M.HAS_MAP=1,M.HAS_LAYER_OPACITY=1,M.HAS_TERRAIN_FLAT_MASK=1,S.defines=M,this.prepareMesh(S,e,t),S}addTerrainImage(e,t){const n=t.terrainMesh;if(n){if(this._material&&n.properties.matVer!==this._matVer){for(const e in this._material)n.material.set(e,this._material[e]);n.properties.matVer=this._matVer}t.skin&&n.material.set("skinTexture",t.skin.color[0]),t.mask&&n.setUniform("flatMask",t.mask.color[0]),n.setUniform("polygonOpacity",1),this._leafScene.addMesh(n)}}getUniformValues(){const e=this.getMap(),t=e.getRenderer().canvas,{iblTexes:n,dfgLUT:i}=sI(t),s=oI(e,n,i),o=this.layer.getTileSize().width,a=this.layer.getRenderer().getMaskUniforms();let l=this.layer.options.opacity;return xC(l)&&(l=1),vC(s,{viewMatrix:e.viewMatrix,projMatrix:e.projMatrix,projViewMatrix:e.projViewMatrix,outSize:[t.width,t.height],polygonFill:[1,1,1,1],terrainHeightMapResolution:[o,o],terrainResolution:[t.width,t.height],terrainUnpackFactors:[6553.6,25.6,.1,1e4],layerOpacity:l}),vC(s,a),s}initShader(e){const t={},n=[];eI(t,n,e),this.shader=new SM.StandardShader({uniforms:n,defines:t,extraCommandProps:this.getExtraCommandProps()})}delete(){return this.disposeIBLTextures(),super.delete()}}function cI(e,t,n,i){const s=uI.call(this,n,i);this._projViewMatrix=t;const{colorExtent:o,modeExtent:a}=this._extentPass.render(s,t);this._maskUniforms=this._maskUniforms||{},this._maskUniforms.mask_colorExtent=o,this._maskUniforms.mask_extent=e,this._maskUniforms.mask_modeExtent=a,this._maskUniforms.mask_hasFlatOut=dI.call(this,"flat-outside"),this._maskUniforms.mask_hasClipOut=dI.call(this,"clip-outside"),this._maskUniforms.mask_hasVideo=dI.call(this,"video"),this._maskUniforms.mask_heightRatio=n,this._maskUniforms.mask_heightOffset=i,this.setToRedraw()}function uI(e,t){const n=[],i=this.layer.getMasks();for(let s=0;s<i.length;s++){const o=i[s].getMesh(this.regl,e,t);o&&n.push(o)}return n}function fI(){if(!this._extentPass||!this._maskUniforms)return;const e=uI.call(this,this._maskUniforms.mask_heightRatio,this._maskUniforms.mask_heightOffset);this._extentPass.render(e,this._projViewMatrix);const t=this.layer.getMasks();for(let e=0;e<t.length;e++)t[e]._update&&t[e]._update()}function dI(e){const t=this.layer.getMasks();for(let n=0;n<t.length;n++)if(t[n].getMode()===e)return 1;return 0}function pI(){const e=this.layer.getMasks();if(!e)return!1;for(let t=0;t<e.length;t++)if(e[t]._needUpdate)return e[t]._needUpdate();return!1}function gI(e){return class extends e{setMask(e,t,n,i){this.viewport||(this.viewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1}),this._extentPass?cI.call(this,e,t,n,i):this.regl?(this._extentPass=new ExtentPass(this.regl,this.viewport),cI.call(this,e,t,n,i)):this.layer.once("contextcreate",(()=>{this._extentPass=new ExtentPass(this.regl,this.viewport),cI.call(this,e,t,n,i)}),this)}needToRedraw(){return!!super.needToRedraw()||!!pI.call(this)}getMaskUniforms(){return pI.call(this)&&fI.call(this),this.layer.updateMaskExtent(),this._maskUniforms}getMaskDefines(){return this._maskDefines||(this._maskDefines={}),this._maskUniforms&&this._maskUniforms.mask_colorExtent?this._maskDefines.HAS_MASK_EXTENT=1:delete this._maskDefines.HAS_MASK_EXTENT,this._maskDefines}updateMaskDefines(e){const t=e.getDefines();delete t.HAS_MASK_EXTENT;vC(t,this.getMaskDefines()),e.setDefines(t)}_clearMask(){this._deleteMaskUniforms(),this._extentPass&&(this._extentPass.dispose(),delete this._extentPass),this.setToRedraw()}_deleteMaskUniforms(){delete this._maskUniforms}}}class LRUPool{constructor(e,t){this.max=e,this.onRemove=t,this.reset()}reset(){if(this.data){const e=this.data.values();for(const t of e)this.onRemove(t)}return this.data=new Map,this}clear(){this.reset(),delete this.onRemove}add(e,t){return t?(this.has(e)?(this.data.delete(e),this.data.set(e,t)):this.data.set(e,t),this):this}keys(){const e=new Array(this.data.size);let t=0;const n=this.data.keys();for(const i of n)e[t++]=i;return e}has(e){return this.data.has(e)}getAndRemove(e){if(!this.has(e))return null;const t=this.data.get(e);return this.data.delete(e),t}get(e){if(!this.has(e))return null;return this.data.get(e)}pop(){if(this.data.size<this.max)return null;const e=this.data.keys().next();return this.data.get(e.value).current?(this.max+=Math.ceil(this.max/2),null):this.getAndRemove(e.value)}remove(e){if(!this.has(e))return this;const t=this.data.get(e);return this.data.delete(e),this.onRemove(t),this}resetCurrent(e){this.data&&this.data.forEach((t=>{t.current=e}))}}const{TileLayerRendererable:mI,LayerAbstractRenderer:AI}=Om,yI=new Re(0,0),_I=new Re(0,0),vI=new Pl(0,0,0,0),xI=new Re(0,0),bI={color:[0,0,0,0],depth:1,stencil:0},wI={color:[1,1,1,1],depth:0,stencil:0};class TerrainLayerRenderer extends(gI(mI(AI))){constructor(...e){super(...e),this.init()}isDrawable(){return!0}getTempTileOnLoading(e,t){if(t.image&&!t.image.reset)return t;this._debugTile(e,"getTempTileOnLoading");const n=this._createTerrainFromParent(e);return n.temp=!0,t.image||(t.image=n),delete t.image.reset,t.current=!0,t.info=e,vC(t.image,n),this._createMesh(t.image,e),t}_resetTerrainImage(e,t,n){t.reset=!0,delete t.data,delete t.loadTime,delete t.rendered,delete t.minAltitude;const i=e.id+"-temp",s=t.skinImages;if(s)for(let e=0;e<s.length;e++){const t=s[e];if(t){for(let e=0;e<t.length;e++){const s=t[e];s&&(s.refs.delete(i),s.refs.size||n.push(s))}delete t.currentSkins,delete t.tileIds}}delete t.sourceZoom,delete t.skinImages,delete t.skinStatus,delete t.skinTileIds,t.debugTexture&&(t.debugTexture.destroy(),delete t.debugTexture)}_createTerrainFromParent(e,t){for(t=t||this.findParentTile(e);t&&t.image&&(-1===t.image.sourceZoom||t.image.originalError);)t=this.findParentTile(t.info);const n=e.res,i=this.getMap().pointAtResToDistance(1,1,n),s=t&&t.image&&t.image.data&&this._clipParentTerrain(t,e),o=s&&-1!==t.image.sourceZoom?t.info.z:-1;if(!s||s.width<=1){const n=this._findTileMinAltitude(e,t);return{data:QP(n||0,5),minAltitude:n,mesh:KP,sourceZoom:o}}return{data:s,mesh:jP(i/2,s.data,s.width),sourceZoom:o}}_findTileMinAltitude(e,t){if(t&&t.minAltitude)return t.minAltitude;const{idx:n,idy:i,z:s}=e;for(let e=-1;e<=1;e++)for(let t=-1;t<=1;t++){if(0===e&&0===t)continue;const o=this.layer.getTileId(n+e,i+t,s),a=this.layer.tileInfoCache,l=a&&a.get(o);if(l&&l.minAltitude)return l.minAltitude}return 0}consumeTile(e,t){if(this._debugTile(t,"consumeTile"),e.empty&&!e.mesh){const n=this.findParentTile(t);if(!n||n.image&&n.image.empty){e.mesh=KP;const n=this._findTileMinAltitude(t);e.data=QP(n||0,5),e.minAltitude=n,e.sourceZoom=-1}else e=this._createTerrainFromParent(t,n)}this._createMesh(e,t),super.consumeTile(e,t),this._recenterMapOnTerrain(t)}_createMesh(e,t){if(e&&e.mesh){e.terrainMesh=this._painter.createTerrainMesh(t,e),t.minAltitude=e.data.min,t.maxAltitude=e.data.max,delete e.mesh;const n=this.layer.tileInfoCache;if(n&&t.parent&&!e.empty&&!e.temp){const e=n.get(t.parent);if(e){const{minAltitude:n,maxAltitude:i}=t;(void 0===e.minAltitude||e.minAltitude>n)&&(e.minAltitude=n),(void 0===e.maxAltitude||e.maxAltitude<i)&&(e.maxAltitude=i)}}}}_recenterMapOnTerrain(e){const t=this.getMap();if(t.updateCenterAltitude&&void 0===t.centerAltitude&&e.z===this.getCurrentTileZoom()){const n=t._getPrjCenter(),i=t._prjToPointAtRes(n,e.res,xI);e.extent2d.contains(i)&&t.updateCenterAltitude()}}draw(e,t){this._createPainter(),this._painter.startFrame(t),super.draw(e,t),this._endFrame(t)}drawTile(e,t){const n=this.getMap();if(!e||!n||!t)return;if(!this.drawingCurrentTiles&&!this.drawingChildTiles)return;this._debugTile(e,"drawTile");let i=this.drawingCurrentTiles?this.getTileOpacity(t):1;i*=this.layer.options.opacity||1,this._painter.addTerrainImage(e,t,i)}_drawTiles(e,t,n,i,s,o,a){const l=[];this._newTerrainTileCounter=0;const h=this.layer.getSkinCount(),c=new Set;if(a&&a.length){CC(o,a.map((e=>e.info)));for(let e=0;e<h;e++)this._renderChildTerrainSkin(e,a,c,l)}CC(e,this._getTempTilesForMissed(o,l)),this._debugTile(e,"drawTiles");for(let t=0;t<h;t++)this._renderChildTerrainSkin(t,e,c,l);for(let t=0;t<e.length;t++)this._renderTerrainMeshSkin(e[t].info,e[t].image);for(let e=0;e<l.length;e++)l[e]&&l[e].texture&&!l[e].refs.size&&(this._skinImageCache.delete(l[e].tile.id),this._deleteSkinImage(l[e]));return this._clearCachdeSkinImages(),super._drawTiles(...arguments)}_getTempTilesForMissed(e,t){const n=[];let i=this._tempTilesPool;i||(i=this._tempTilesPool=new LRUPool(this.layer.options.tempTileCacheSize,(e=>{const{info:t,image:n}=e;this._deleteTerrainImage(t,n)}))),i.resetCurrent(!1);for(let s=0;s<e.length;s++){const o=e[s];let a;this._debugTile(o,"getTempTilesForMissed"),i.has(o.id)?a=i.getAndRemove(o.id):(a=i.pop(),a?a.image&&(this._resetTerrainImage(a.info,a.image,t),a.image.temp=!0):a={info:o}),a.current=!0,i.add(o.id,a),n.push(a)}for(let t=0;t<e.length;t++)this.getTempTileOnLoading(e[t],n[t]);return n}_clearCachdeSkinImages(){if(!this._skinImageCache)return;const e=this.getCurrentTimestamp();if(this._clearSkinImageTimestamp&&e-this._clearSkinImageTimestamp<1e3)return;const t=new Set;for(const e of this.tileCache.data.values())this._collectSkinImages(e,t);for(const e in this.tilesInView){this._collectSkinImages(this.tilesInView[e],t)}if(this._tempTilesPool)for(const e of this._tempTilesPool.data.values())this._collectSkinImages(e,t);t.size&&(this._skinImageCache.forEach(((e,n)=>{t.has(n)||(console.log("deleted:",n),this._deleteSkinImage(this._skinImageCache.get(n)),this._skinImageCache.delete(n))})),this._clearSkinImageTimestamp=e)}_collectSkinImages(e,t){const n=e.image&&e.image.skinImages;if(n&&n.length)for(let e=0;e<n.length;e++){const i=n[e]&&n.currentSkins;if(i)for(const e of i)t.add(e)}}_renderChildTerrainSkin(e,t,n,i){const s=this.layer.getSkinLayer(e).getRenderer();if(!s)return;const o=[];for(let s=0;s<t.length;s++){const{info:a,image:l}=t[s];this._prepareMask(a,l),this._debugTile(a,"renderChildTerrainSkin");let h=!1;if(this._prepareChildTerrainSkin(e,a,l,i)){const t=l.skinImages[e];for(let e=0;e<t.length;e++){const i=t[e].tile.info.id;n.has(i)||(!h&&t[e].layer.hasTerrainMask&&(this._clearMask(l.mask),h=!0),t[e].terrainMaskFBO=l.mask,o.push(t[e]),n.add(i))}}}s.renderTerrainSkin(this.device,this.layer,o)}_prepareMask(e,t){t.mask||(t.mask=this._createTerrainMaskTexture(e,t),t.mask.id=e.id)}_clearMask(e){wI.framebuffer=e,this.device.clear(wI)}_prepareChildTerrainSkin(e,t,n,i){const s=this.getMap();if(delete n.path,!t||!s||!n)return!1;if(!n.terrainMesh)return!1;const o=this.layer.getSkinLayer(e),a=o.getRenderer();if(!a)return!1;n.skinImages||(n.skinImages=[]),n.skinStatus||(n.skinStatus=[]),n.skinTileIds||(n.skinTileIds=[]);const l=a.isAnimating&&a.isAnimating(),h=n.skinStatus[e],c=a.needToRefreshTerrainTileOnZooming&&a.needToRefreshTerrainTileOnZooming(),u=l||c&&n.renderedZoom!==s.getZoom();if(h&&!u)return!1;const f=o.getSpatialReference(),{x:g,y:m,z:A,res:w,offset:T}=t;let S=t.nw;S||(S=t.nw=this.getMap().pointAtResToCoord(t.extent2d.getMin(yI),t.res));const M=this.layer.getTileSize().width;let{res:C,zoom:I}=YP(f,A,w);let E=XP(C,o.getTileSize().width,w,M),D=n.skinTileIds[e];if(!D){const t=this.layer._getTileConfig().tileSystem.scale.y,i=o.options.maxAvailableZoom;!xC(i)&&i>=0&&I>i&&(E*=Math.pow(2,i-I),I=i),D=n.skinTileIds[e]=WP(o,g,m,I,S,T,t,E,1)}const H=D[0];let N=!0;const B=[];for(let e=0;e<H.length;e++){const t=a.getCachedTile(H[e],!1);if(t)B.push(t);else{N=!1;const t=a.findParentTile(H[e]);t&&B.push(t)}}const z=n.skinImages[e]||[];z.currentSkins=z.currentSkins||new Set;const U=new Set;let j=!1;for(let e=0;e<z.length;e++){if(!z[e].tile){j=!0;continue}U.add(z[e].tile.info.id)}if(!B.length)return z.currentSkins.clear(),n.skinImages[e]=[],!1;const W=B.map((e=>e.info.id)).join();if(!u&&!j&&z.tileIds===W)return!1;z.tileIds=W;let q=!1;z.currentSkins.clear(),z.length=0;const Z=z.currentSkins;let X=t.id;n.temp&&(X+="-temp");for(let e=0;e<B.length;e++){const t=B[e].info.id;Z.add(t);let n=this._getCachedSkinImage(t);n&&((Y=n)&&Y.texture)||(n={tile:vC({},B[e]),layer:o,refs:new Set,texture:a.createTerrainTexture(this.device)},this._saveCachedSkinImage(t,n)),n.refs.add(X),z.push(n),q=!0}var Y;return this._clearPrevSkinImages(t,n,U,Z,i),q&&this._newTerrainTileCounter++,n.skinImages[e]=z,o.fire("renderterrainskin",{tile:t,skinTiles:B}),N&&(n.skinStatus[e]=1),!0}_clearPrevSkinImages(e,t,n,i,s){if(!n.size)return;let o=e.id;t.temp&&(o+="-temp");for(const e of n)if(!i||!i.has(e)){const t=this._getCachedSkinImage(e);this._deleteCachedSkinImage(t,o,s)}}_getCachedSkinImage(e){return this._skinImageCache||(this._skinImageCache=new Map),this._skinImageCache.get(e)}_saveCachedSkinImage(e,t){this._skinImageCache.set(e,t)}_renderTerrainMeshSkin(e,t){const n=this.getMap();if(!e||!n||!t)return;this._debugTile(e,"_renderTerrainMeshSkin");const i=this._needRefreshTerrainSkins(t.renderedZoom);if(t.rendered&&!i)return;t.skin?(bI.framebuffer=t.skin,this.device.clear(bI)):(t.skin=this._createTerrainTexture(e,t),this._prepareMask(e,t)),this._initSkinShader();const s=this.layer.options.debug,o=[],a=s&&[],l=this.layer.getTileSize().width,h=t.skinImages;if(h)for(let t=0;t<h.length;t++){const n=h[t];for(let t=0;t<n.length;t++){const{tile:i,texture:s,layer:a}=n[t];if((i.info.offset[0]||i.info.offset[1])&&e.skinTileIds){const t=e.skinTileIds[a.getId()];for(let e=0;e<t.length;e++)if(i.info.x===t[e].x&&i.info.y===t[e].y){i.info.offset=t[e].offset;break}}const h=TI(e,i,l),c=n[t].skinMesh||new Mesh(this._skinGeometry);c.setUniform("skinTexture",s);const u=a.getOpacity();c.setUniform("opacity",xC(u)?1:u),c.setUniform("skinDim",h),c.setUniform("tileSize",l),c.setUniform("x",e.x),c.setUniform("y",e.y),n[t].skinMesh=c,o.push(c)}}if(s){const n=t.skinDebugMesh||new Mesh(this._skinGeometry);n.setUniform("tileSize",l);const i=t.debugTexture||this._createDebugTexture(e,l,t.temp);t.debugTexture=i,t.skinDebugMesh=n,n.setUniform("opacity",1),n.setUniform("skinTexture",i),n.setUniform("skinDim",[0,0,1]),n.setUniform("tileSize",l),a.push(n)}if(o.length){this._skinScene.setMeshes(o);try{this.renderer.render(this._skinShader,null,this._skinScene,t.skin)}catch(e){throw console.error(t),e}}a&&a.length&&this.layer.options.debug&&(this._skinScene.setMeshes(a),this.renderer.render(this._skinShader,null,this._skinScene,t.skin)),t.rendered=this._isSkinReady(t),t.renderedZoom=n.getZoom()}_createDebugTexture(e,t,n){t*=2;const{x:i,y:s,z:o}=e,a=`terrain:${i}/${s}/${o}`+(n?"-temp":""),l=document.createElement("canvas");l.width=t,l.height=t;const h=l.getContext("2d");h.font="60px monospace";const c=this.layer.options.debugOutline;return h.fillStyle=c,h.strokeStyle=c,h.fillText(a,20,t-40),h.beginPath(),h.lineWidth=4,h.moveTo(0,0),h.lineTo(t,0),h.lineTo(t,t),h.lineTo(0,t),h.lineTo(0,0),h.stroke(),this.device.texture({data:l,flipY:!0,mag:"linear",min:"linear"})}_createTerrainMaskTexture(){const e=this.device,t=this.layer.getTileSize().width,n=2*t,i=2*t,s=e.texture({min:"linear",mag:"linear",type:"uint8",format:"rgba",width:n,height:i});this._terrainMaskDepthStencil||(this._terrainMaskDepthStencil=e.texture({width:n,height:i,format:"depth stencil"}));const o={width:n,height:i,colors:[s],colorFormat:"rgba",ignoreStatusCheck:!0};o.depthStencil=this._terrainMaskDepthStencil;const a=e.framebuffer(o);return a.colorTex=s,this._clearMask(a),a}_createTerrainTexture(e){const t=this.layer.getTileSize().width,n=2*t,i=2*t,s=this.device,o=e.colorsTexture;let a;a=o&&o instanceof Uint8Array?s.texture({data:o,min:"linear",mag:"linear",type:"uint8",width:n,height:i,flipY:!0}):s.texture({min:"linear",mag:"linear",type:"uint8",width:n,height:i,flipY:!0});const l=s.framebuffer({width:n,height:i,colors:[a],colorFormat:"rgba",ignoreStatusCheck:!0,depthStencil:!1,depth:!1,stencil:!1});return l.colorTex=a,l}_endFrame(e){this._painter.endFrame(e)&&!Object.keys(this.tilesLoading).length&&this.layer.fire("terrainreadyandrender")}_clipParentTerrain(e,t){const{image:n,info:i}=e,s=n.data,o=s.width,{extent2d:a,res:l}=i,{extent2d:h,res:c}=t,u=a.getWidth(),f=a.getHeight();let g=(h.xmin*c/l-a.xmin)/u*(o-1),m=(a.ymax-h.ymax*c/l)/f*(o-1);let A=Math.round((h.xmax*c/l-a.xmin)/u*(o-1)-g);const w=Math.log2(A);A=Math.pow(2,Math.round(w))+1,g=Math.floor(g),m=Math.floor(m);const T=new Float32Array(A*A);let S=1/0,M=-1/0;for(let e=0;e<A;e++)for(let t=0;t<A;t++){let n=e+g,i=t+m;n>o-1?n=o-1:n<0&&(n=0),i>o-1?i=o-1:i<0&&(i=0);const a=s.data[n+i*o];T[e+t*A]=a,a<S&&(S=a),a>M&&(M=a)}return{width:A,height:A,data:T,min:S,max:M}}getTileOpacity(e){return this._isSkinReady(e)?super.getTileOpacity(e):(this.resetTileLoadTime(e),0)}_isSkinReady(e){const t=this.layer.getSkinCount();if(!t)return!0;if(!e.skinStatus)return!1;for(let n=0;n<t;n++)if(!e.skinStatus[n])return!1;return!0}_needRefreshTerrainSkins(e){const t=this.getMap().getZoom(),n=this.layer.getSkinLayers();for(let i=0;i<n.length;i++){const s=n[i]&&n[i].getRenderer();if(s){if(s.isAnimating&&s.isAnimating())return!0;if(s.needToRefreshTerrainTileOnZooming&&s.needToRefreshTerrainTileOnZooming()&&e!==t)return!0}}return!1}isValidCachedTile(e){return e.image&&!e.image.temp&&(!e.image.skinStatus||this._isSkinReady(e.image))}isTileComplete(e){return e.image&&!e.image.temp&&this._isSkinReady(e.image)}_getTerrainWidth(){const e=this.layer.options,t=this.layer.getTileSize().width;return xC(e.terrainWidth)?t/4+1:e.terrainWidth}_getParentTileRequest(e,t){const n=this.layer.options.maxAvailableZoom-this.layer.options.zoomOffset,i=Math.pow(2,e.z-n),s=Math.floor(e.x/i),o=Math.floor(e.y/i),a=Math.floor(e.idx/i),l=Math.floor(e.idy/i),h=SI(s,o);this._parentRequests||(this._parentRequests={});const c=!this._parentRequests[h];return c&&t&&(this._parentRequests[h]=new Set,this._parentRequests[h].url=this.layer.getTileUrl(s,o,n+this.layer.options.zoomOffset)),{x:s,y:o,idx:a,idy:l,requests:this._parentRequests[h],isFirst:c,key:h}}loadTile(e){const t=this.layer,n=this._getTerrainWidth(),i=t.getSpatialReference().getResolution(e.z);let s=this.getMap().pointAtResToDistance(1,1,i);const o=t.options.maxAvailableZoom&&t.options.maxAvailableZoom-(t.options.zoomOffset||0);if(o&&e.z>o){const n=this._createTerrainFromParent(e);if(-1!==n.sourceZoom)return this.onTileLoad(n,e),n;{const{requests:i,isFirst:a,x:l,y:h,idx:c,idy:u}=this._getParentTileRequest(e,!0);if(i.add(e),!a)return n;const f=e.z-o;s*=Math.pow(2,f);const g=[l,h,o,c,u,e.res*Math.pow(2,f),e.error*Math.pow(2,f)];e=t.createTileNode?t.createTileNode(...g):t._createTileNode(...g)}}const a=e.url,l={},h=t.options,c=t.getTileSize(),u={terrainWidth:n,type:h.type,accessToken:h.accessToken,cesiumIonTokenURL:h.cesiumIonTokenURL,error:s,colors:h.colors,tileSize:c?[c.width,c.height]:[256,256],command:"loadTile"},f=()=>{this.workerConn.fetchTerrain(a,u,((t,n)=>{if(this._parentRequests){const t=SI(e.x,e.y),n=this._parentRequests[t];if(n&&n.size){this.tileCache.add(e.id,{info:e,image:l});for(const e of n)this.removeTileLoading(e)}delete this._parentRequests[t]}t?g(t):(Zi.extend(l,n),e.colorsTexture=l.colorsTexture,this.onTileLoad(l,e))}))},g=t=>{t&&t.canceled||(console.warn(t),this.onTileError(l,e))};return this.loadTileBitmap&&wC(this.loadTileBitmap)?this.loadTileBitmap(a,e,((e,t)=>{e?g(e):t&&t instanceof ImageBitmap?(u.tileImage=t,f()):g(new Error("bitmap is not ImageBitmap"))}),u):f(),l}deleteTile(e){if(!e||!e.image)return;super.deleteTile(e);const{info:t,image:n}=e;n.temp||(delete t.skinTileIds,this._deleteTerrainImage(e.info,n))}_deleteTerrainImage(e,t){const n=t.skin;n&&(n.destroy(),n.colorTex.destroy(),delete n.colorTex);const i=t.mask;i&&(i.destroy(),i.colorTex.destroy(),delete i.colorTex),t.debugTexture&&(t.debugTexture.destroy(),delete t.debugTexture,t.skinDebugMesh.dispose(),delete t.skinDebugMesh);const s=t.skinImages;if(s&&s.length){let n=e.id;t.temp&&(n+="-temp");for(let e=0;e<s.length;e++){const t=s[e];if(t){for(let e=0;e<t.length;e++){if(!t[e]||!t[e].tile)continue;const i=this._skinImageCache&&this._skinImageCache.get(t[e].tile.info.id);i&&this._deleteCachedSkinImage(i,n)}t.length=0}}}t.terrainMesh&&this._painter.deleteMesh(t.terrainMesh),t.image&&t.image.close&&t.image.close(),delete t.skinImages,delete t.skin,delete t.mask,delete t.skinStatus,delete t.skinTileIds,delete t.terrainMesh,delete t.image,delete t.data,delete t.mesh,delete t.rendered}_deleteCachedSkinImage(e,t,n){e&&(e.refs.delete(t),e.refs.size||(n?n.push(e):this._deleteSkinImage(e)))}_deleteSkinImage(e){if(!e||!e.tile)return;const t=e.tile.info.id,n=e.layer.getRenderer();delete e.canvas,delete e.layer,e.refs.clear(),e.texture&&(n?n.deleteTerrainTexture(e.texture):e.texture.destroy&&e.texture.destroy(),delete e.texture),e.skinMesh&&(e.skinMesh.dispose(),delete e.skinMesh),n&&(n.removeTileCache&&n.removeTileCache(t),n.deleteTile&&n.constructor.prototype.deleteTile.call(n,e.tile)),delete e.tile,this._skinImageCache.delete(t)}_clearSkinImageCache(){if(!this._skinImageCache)return;const e=this._skinImageCache.keys();for(const t of e){const e=this._getCachedSkinImage(t);this._deleteSkinImage(e)}this._skinImageCache.clear()}abortTileLoading(e,t){const n=this.layer,i=n.options.maxAvailableZoom&&n.options.maxAvailableZoom-n.options.zoomOffset,s=(e,t)=>{this.loadTileBitmap&&wC(this.loadTileBitmap)?this.loadTileBitmap(e,t,(()=>{}),{command:"abortTile"}):this.workerConn&&this.workerConn.abortTerrain(e)};if(t)if(i&&t.z>i){const{requests:e,key:n}=this._getParentTileRequest(t);e&&e.size&&(e.delete(t),e.size||(delete this._parentRequests[n],s(e.url,t)))}else t&&t.url&&s(t.url,t);super.abortTileLoading(e,t)}onTileError(e,t){super.onTileError(e,t)}_getTerrainTileAtPrjCoord(e){const t=this.getCurrentTileZoom(),n=this.layer.getSpatialReference().getResolution(t),i=this.layer._getTileConfig().getTileIndex(e,n,this.layer.options.repeatWorld);return i.z=t,i}_queryTerrain(e,t,n,i,s){const o=this.layer.getMinZoom(),a=this._findTerrainData(t,n.x,n.y,n.z,o);if(a&&a.image&&a.image.data){const t=a.info.extent2d,o=a.info.res/s,l=t.ymax*o-i.y;let h=this._queryAltitudeInHeights(a.image.data,(i.x-t.xmin*o)/(t.getWidth()*o),l/(t.getHeight()*o));const c=this.layer._getExaggeration();0!==c&&(h*=c),e[0]=h,e[1]=null===h?0:+(a.info.z===n.z)}else e[0]=null,e[1]=0;return e}_findTerrainData(e,t,n,i,s){e||(e=this.layer._getTileId(t,n,i));const o=this.tilesInView[e]||this.tileCache.get(e);return!o&&i-1>=s?this._findTerrainData(null,Math.floor(t/2),Math.floor(n/2),i-1,s):o}_queryAltitudeInHeights(e,t,n){const{width:i,height:s,data:o}=e,a=Math.floor((i-1)*t),l=Math.floor((s-1)*n)*i+a;return void 0===o[l]?null:o[l]}_queryTileAltitude(e,t,n){e||(e={tiles:{},dirty:!0,complete:!1});const i=this.layer,s=this.getCurrentTileZoom(),o=i.getSpatialReference().getResolution(s),{xmin:a,ymin:l,xmax:h,ymax:c}=t,u=i._getTileConfig();yI.set(a,l)._multi(n);const f=u._getTileNum(yI,n,!0);_I.set(h,c)._multi(n);const g=u._getTileNum(_I,n,!0),m=Math.min(f.x,g.x),A=Math.max(f.x,g.x),w=Math.min(f.y,g.y),T=Math.max(f.y,g.y),S=n/o;yI.set(a,l)._multi(S),_I.set(h,c)._multi(S);const M=vI.set(yI.x,yI.y,_I.x,_I.y),C=i.getTileSize().width+1;M._expand(M.getWidth()/C),e.array=e.array||new Float32Array(C*C);const I=e.tiles;e.complete=!0,e.array.fill(0);for(let t=m;t<=A;t++)for(let n=w;n<=T;n++){const i=this.layer._getTileId(t,n,s);if(I[i])continue;const o=this.tileCache.get(i);o?(this._fillAltitudeData(e.array,o,M,C),e.dirty=!0,I[i]=1):(e.dirty=e.dirty||void 0!==e.tiles[i],e.tiles[i]&&delete e.tiles[i],e.complete=!1)}return e}_fillAltitudeData(e,t,n,i){const s=t.info.extent2d,o=s.intersection(n),{xmin:a,ymin:l,xmax:h,ymax:c}=o,{data:u}=t.image,f=u.width,g=n.getWidth()/i,m=Math.floor((a-n.xmin)/g),A=Math.floor((l-n.ymin)/g),w=Math.floor((h-n.xmin)/g)-m,T=Math.floor((c-n.ymin)/g)-A,S=s.getWidth()/f,M=Math.floor((a-s.xmin)/S),C=Math.floor((l-s.ymin)/S),I=Math.floor(g/S);for(let t=0;t<=w;t++)for(let n=0;n<=T;n++){const s=t+m+(A+n)*i;let o=0;for(let e=0;e<I;e++)for(let i=0;i<I;i++){const s=(M+Math.floor(t*I))*f+e+C+Math.floor(n*I)+i;o+=u.data[s]}e[s]=o/Math.max(I,1)}return e}clear(){return this.clearTempResources(),this.clearTileCaches(),super.clear()}clearTempResources(){this._tempTilesPool&&(this._tempTilesPool.reset(),delete this._tempTilesPool),this._skinImageCache&&this._clearSkinImageCache()}onAdd(){super.onAdd(),this.prepareWorker()}onRemove(){this.workerConn&&(this.workerConn.removeLayer(this.layer.getId(),(e=>{if(e)throw e})),this.workerConn.remove(),delete this.workerConn),this.clearTempResources(),this._skinShader&&(this._skinShader.dispose(),delete this._skinShader),this._skinGeometry&&(this._skinGeometry.dispose(),delete this._skinGeometry),this._terrainMaskDepthStencil&&(this._terrainMaskDepthStencil.colorTex&&this._terrainMaskDepthStencil.colorTex.destroy(),this._terrainMaskDepthStencil.destroy(),delete this._terrainMaskDepthStencil),delete this._parentRequests,super.onRemove(),this._painter&&(this._painter.delete(),delete this._painter)}prepareWorker(){const e=this.layer.getMap();this.workerConn||(this.workerConn=new TerrainWorkerConnection(e.id));const t=this.workerConn;if(!t.isActive())return;const n=this.layer.options||{},i=this.layer.getId();t.addLayer(i,n,(e=>{if(e)throw e;this.layer&&(this.ready=!0,this.setToRedraw(),this.layer.fire("workerready"))}))}initContext(){super.initContext();const{regl:e,device:t}=this.context;this.regl=e,this.device=t||e,this.renderer=new Renderer(e||t),this.layer.fire("contextcreate",{regl:e,device:t})}_createPainter(){const e=this._painter;"lit"===this.layer.options.shader||"pbr"===this.layer.options.shader?(e&&e.constructor===TerrainPainter||!e)&&(e&&(e.delete(),this.clear(),this.setToRedraw()),this._painter=new TerrainLitPainter(this.layer),this.layer.fire("paintercreated")):(e&&e.constructor===TerrainLitPainter||!e)&&(e&&(e.delete(),this.clear(),this.setToRedraw()),this._painter=new TerrainPainter(this.layer),this.layer.fire("paintercreated"))}_initSkinShader(){if(this._skinShader)return;const e=this.layer.getTileSize().width;this._skinShader=new MeshShader({name:"terrain-skin",vert:"#define SHADER_NAME TERRAIN_SKIN\nattribute vec2 aPosition;\nvoid main() {\n  gl_Position = vec4(aPosition, .0, 1.);\n}",frag:"#define SHADER_NAME TERRAIN_SKIN\nprecision mediump float;\nuniform float tileSize;\nuniform sampler2D skinTexture;\nuniform vec3 skinDim;\nuniform float opacity;\nvoid main() {\n  vec2 c = gl_FragCoord.xy / 2.;\n  vec2 d = vec2(tileSize);\n  vec2 e = (c - skinDim.xy) / (d * skinDim.z);\n  if(e.x >= .0 && e.x <= 1. && e.y >= .0 && e.y <= 1.) {\n    gl_FragColor = texture2D(skinTexture, e) * opacity;\n  } else {\n    gl_FragColor = vec4(.0);\n  }\n}",wgslVert:"",wgslFrag:"",extraCommandProps:{cull:{enable:!1},viewport:{x:0,y:0,width:2*e,height:2*e},depth:{enable:!1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}});const t=new Int16Array([-1,-1,1,1,-1,1,1,1,-1,-1,1,-1]);this._skinGeometry=this._skinGeometry||new Geometry({aPosition:t},0,6,{positionSize:2}),this._skinGeometry.generateBuffers(this.device),this._skinScene=this._skinScene||new Scene}updateMaterial(e){this._painter&&e&&this._painter.updateMaterial&&(void 0===this._matVer&&(this._matVer=1),this._painter.updateMaterial(e,this._matVer++))}setMaterial(e){this._painter&&e&&this._painter.setMaterial&&(void 0===this._matVer&&(this._matVer=1),this._painter.setMaterial(e,this._matVer++))}getAnalysisMeshes(){return this._painter&&this._painter._leafScene?this._painter._leafScene.getMeshes():[]}_debugTile(e,t,n){if(this.layer.options.debugTile){if(Array.isArray(e)){for(let i=0;i<e.length;i++)e[i]&&this._debugTile(e[i],t+" at "+i,n);return}if(!e)return;const{x:i,y:s,z:o}=this.layer.options.debugTile,{info:a}=e;a&&(e=a),i===e.x&&s===e.y&&o===e.z&&console.log(`Found debug tile in TerrainLayerRenderer.${t}:`,e)}}}function TI(e,t,n){const{res:i,extent2d:s,offset:o}=e,{info:a}=t,l=a.res/i,h=a.offset;return[a.extent2d.xmin*l-s.xmin+(o[0]-h[0]),-(s.ymin-a.extent2d.ymin*l+(h[1]-o[1])),l*a.tileSize/n]}function SI(e,t){return e+"-"+t}const MI={"clip-inside":.1,"clip-outside":.2,"flat-inside":.3,"flat-outside":.4,color:.5,texture:.6,elevate:.7},CI=[],PI=[1,1,1],II={polygonFill:[255,0,0],polygonOpacity:.8},kI=new fl(0,0),OI=new fl(0,0),EI=[],RI=new fl(0,0),LI=new Re(0,0),DI=new Re(0,0),FI=new Re(0,0);class Mask extends df{getMode(){return this._mode}remove(){const e=this.getLayer();return e?(e.removeMask(this),this._dispose(),super.remove(),this):this}getMesh(e,t,n){return this.isVisible()&&this.getLayer()?(this._mesh||(this._mesh=this._createMesh(e,t,n)),this._updateUniforms(this._mesh,t,n),this._mesh):null}setCoordinates(e){super.setCoordinates(e);const t=this.getLayer();if(t&&(delete t._maskProjViewMatrix,delete t._maskExtentInWorld),!this._mesh)return this;const n=this.getMode(),i=this.toGeoJSON();i.geometry.coordinates[0].reverse();const s=Wx.flatten(i.geometry.coordinates),{positions:o,uvs:a,triangles:l}="texture"===n?this._createBilinearPOSITON(s):this._createPOSITION(s),h=this._mesh.geometry;if(h.updateData("POSITION",o),h.updateData("TEXCOORD",a),h.setElements(l),this._setLocalTransform(this._mesh),this._copyMesh){const e=this._createPOSITION(Wx.flatten(i.geometry.coordinates),!0).positions;this._copyMesh.geometry.updateData("POSITION",e),this._setLocalTransform(this._copyMesh)}}_createGeometry(e){const t=this.getMode(),n=this.toGeoJSON();n.geometry.coordinates[0].reverse();const i=Wx.flatten(n.geometry.coordinates),{positions:s,uvs:o,triangles:a}="texture"===t?this._createBilinearPOSITON(i):this._createPOSITION(i),l=this._createPOSITION(Wx.flatten(n.geometry.coordinates),!0).positions,h=new Geometry({POSITION:s,TEXCOORD:o},a,0,{positionAttribute:"POSITION",uv0Attribute:"TEXCOORD"});h.generateBuffers(e);const c=new Geometry({POSITION:l,TEXCOORD:o},a,0,{positionAttribute:"POSITION",uv0Attribute:"TEXCOORD"});return c.generateBuffers(e),"texture"===t?{geometry:h,copyGeometry:c}:h}_createPOSITION(e,t){const n=this.getMap(),i=e.dimensions;for(let t=0;t<e.vertices.length;t+=i){RI.x=e.vertices[t],RI.y=e.vertices[t+1];const i=OC(n,RI);e.vertices[t]=i[0],e.vertices[t+1]=i[1]}const s=OC(n,this.getCenter()),o=[],a=.01*this.getLayer().getMasks().indexOf(this),l="texture"===this.getMode()?4:e.vertices.length/i;for(let h=0;h<l;h++)o.push(e.vertices[h*i]-s[0]),o.push(e.vertices[h*i+1]-s[1]),o.push(a+t?n.altitudeToPoint(e.vertices[h*i+2],n.getGLRes()):0);return{positions:o,uvs:this._createTexcoords(e.vertices,i),triangles:Wx(o,e.holes,3)}}_createTexcoords(e,t){const n=[0,0,0,1,1,1,1,0];if(this.hasHoles()){const i=e.length/t*2;for(let e=n.length/2-1;e<i;e+=2)n[e]=n[e+1]=0}return n}_createBilinearPOSITON(e){const t=e.dimensions,n=[],i=[],s=[],o=this.getMap();for(let n=0;n<e.vertices.length;n+=t){RI.x=e.vertices[n],RI.y=e.vertices[n+1];const t=OC(o,RI);e.vertices[n]=t[0],e.vertices[n+1]=t[1]}const a=OC(this.getMap(),this.getCenter()),l={};l.a={x:e.vertices[0*t]-a[0],y:e.vertices[0*t+1]-a[1]},l.b={x:e.vertices[1*t]-a[0],y:e.vertices[1*t+1]-a[1]},l.c={x:e.vertices[2*t]-a[0],y:e.vertices[2*t+1]-a[1]},l.d={x:e.vertices[3*t]-a[0],y:e.vertices[3*t+1]-a[1]},this._positions=[];for(let n=0;n<4;n++)this._positions.push(e.vertices[n*t]-a[0]),this._positions.push(e.vertices[n*t+1]-a[1]),this._positions.push(0);for(let e=0;e<=20;e++)for(let t=0;t<=20;t++){const s=t/20,o=e/20;n.push((1-s)*(1-o)*l.a.x+s*(1-o)*l.b.x+s*o*l.c.x+(1-s)*o*l.d.x,(1-s)*(1-o)*l.a.y+s*(1-o)*l.b.y+s*o*l.c.y+(1-s)*o*l.d.y,0),i.push(s,1-o)}for(let e=0;e<20;e++)for(let t=0;t<20;t++){const n=21*e+t,i=21*(e+1)+t,o=i+1;s.push(n,n+1,o),s.push(n,o,i)}return{positions:n,uvs:i,triangles:s}}clearMesh(){this._dispose(),delete this._mesh,this.maskGeoJSON&&(this.maskGeoJSON=null)}_getMaskMode(){return MI[this._mode]}_getMaskColor(){const e=this.getSymbol(),{polygonFill:t,polygonOpacity:n}=e||II,i=IC([],t);return i[3]=bC(n)?n:"texture"===this.getMode()?1:II.polygonOpacity,i}_altitudeToPoint(e=0){const t=this.getMap(),n=t.getGLRes();return t.altitudeToPoint(e,n)}_setLocalTransform(e){const t=OC(this.getMap(),this.getCenter()),n=EA(e.localTransform,Qy(CI),t,PI);e.localTransform=n}_dispose(){this._mesh&&(this._mesh.material&&this._mesh.material.dispose(),this._mesh.geometry&&this._mesh.geometry.dispose(),this._copyMesh&&this._copyMesh.geometry&&(this._copyMesh.geometry.dispose(),this._copyMesh.dispose()),this._mesh.dispose(),delete this._mesh,delete this._copyMesh)}containsPoint(e){const t=this.getExtent();if(RI.set(e[0],e[1]),!t||!t.contains(RI))return!1;const n=this.getHoles();for(let t=0;t<n.length;t++)if(this._contains(n[t],e))return!1;const i=this.getShell();return this._contains(i,e)}_contains(e,t){const n=this._calArea(e);let i=0;for(let n=0;n<e.length;n++){kI.x=e[n].x,kI.y=e[n].y;const s=n+1>=e.length?0:n+1;OI.x=e[s].x,OI.y=e[s].y,RI.x=t[0],RI.y=t[1],EI[0]=RI,EI[1]=kI,EI[2]=OI;i+=this._calArea(EI)}return!(Math.abs(i-n)>1e-8)}_calArea(e){const t=this.getMap();let n=0;const i=t.getGLRes(),s=t.coordToPointAtRes(e[0],i,LI);for(let h=1;h<e.length-1;h++){const c=t.coordToPointAtRes(e[h],i,DI),u=t.coordToPointAtRes(e[h+1],i,FI);n+=(((a=c).x-(o=s).x)*((l=u).y-o.y)-(a.y-o.y)*(l.x-o.x))/2}var o,a,l;
/*!
  * Contains code from THREE.js
  * MIT License
  * https://github.com/mrdoob/three.js
  */return n}}for(var HI=[],NI=0;NI<6;NI++)HI[NI]=[];var BI=[];function zI(e,t,n){!function(e){var t=e,n=t[0],i=t[1],s=t[2],o=t[3],a=t[4],l=t[5],h=t[6],c=t[7],u=t[8],f=t[9],g=t[10],m=t[11],A=t[12],w=t[13],T=t[14],S=t[15];GI(HI[0],o-n,c-a,m-u,S-A),GI(HI[1],o+n,c+a,m+u,S+A),GI(HI[2],o+i,c+l,m+f,S+w),GI(HI[3],o-i,c-l,m-f,S-w),GI(HI[4],o-s,c-h,m-g,S-T),GI(HI[5],o+s,c+h,m+g,S+T)}(e);for(var i=0;i<6;i++){var s=HI[i];if(BI[0]=s[0]>0?t[1][0]:t[0][0],BI[1]=s[1]>0?t[1][1]:t[0][1],BI[2]=s[2]>0?t[1][2]:t[0][2],UI(s,BI)<0)return!1}return!0}function GI(e,t,n,i,s){var o=1/Math.sqrt(t*t+n*n+i*i);return e[0]=t*o,e[1]=n*o,e[2]=i*o,e[3]=s*o,e}function UI(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]}const VI=new fl(0,0),jI=[0,0,0],WI=[0,0,0],qI=AA([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);function ZI(){return this._maskList?(this._maskList.forEach((e=>{e.remove()})),this._maskList=[],this.updateMaskExtent(),this):this}function XI(){for(let e=0;e<this._maskList.length;e++)if(this._maskList[e].isVisible())return!0;return!1}function YI(e){return class MaskLayerMixin extends e{removeMask(e){if(!this._maskList)return this;if(!e)return ZI.call(this),this;const t=Array.isArray(e)?e:[e];for(let e=0;e<t.length;e++){const n=this._maskList.indexOf(t[e]);n>-1&&this._maskList.splice(n,1)}return this.updateMaskExtent(),this.fire("removemask",{masks:e}),this}setMask(e){return this.removeMask(null),this._maskList||(this._maskList=[]),Array.isArray(e)?e.forEach((e=>{this._maskList.push(e)})):this._maskList.push(e),this._maskList.forEach((e=>{e._bindLayer(this),e._updateCoordinates&&e._updateCoordinates()})),this.updateMaskExtent(),this.fire("setmask",{masks:e}),this}onAdd(){super.onAdd(),this.updateMaskExtent()}getMasks(){return this._maskList||[]}onGeometryEvent(e){if(!e||!e.target)return;"shapechange"===e.type&&e.target instanceof Mask&&e.target.clearMesh(),e.target instanceof Mask&&this.updateMaskExtent(),super.onGeometryEvent&&super.onGeometryEvent(e)}identifyMask(e,t){if(!this.getMap())return[];if(!this._maskList||!this._maskList.length)return[];const n=vC({},t);n.excludeMasks=!0;const i=this.identifyAtPoint(e,n),s=i.length&&i[0].coordinate;if(s){const e=this._maskList;if(!e)return[];const t=[];for(let n=0;n<e.length;n++){const i=e[n].getMode();!e[n].containsPoint(s)||"color"!==i&&"texture"!==i||t.push(e[n])}return t}return[]}remove(){this._maskList&&this._maskList.length&&this._maskList.forEach((e=>{e.remove()})),super.remove()}updateMask(e){const t=this.getMap(),{projViewMatrix:n,mapExtent:i}=this.getProjViewMatrixInOrtho(e);VI.x=i.xmin,VI.y=i.ymin;const s=JI(jI,VI,t);VI.x=i.xmax,VI.y=i.ymax;const o=JI(WI,VI,t);return{projViewMatrix:n,extentInWorld:[s[0],s[1],o[0],o[1]]}}getProjViewMatrixInOrtho(e){const t=this.getMap(),n=t.getView(),i=t.getFitZoom(e),s=e.getCenter();t.setView({center:s,zoom:i,pitch:0,bearing:0});const o=t.getExtent(),a=mA(qI,t.projViewMatrix);return t.setView(n),{mapExtent:o,projViewMatrix:a}}updateMaskExtent(){if(!this._maskList)return;if(!this.getMap())return;const e=this.getRenderer();if(e&&!this._maskList.length)return void e._clearMask();if(e&&!XI.call(this))return e._deleteMaskUniforms(),void e.setToRedraw();const t=this.getMaskExtent();if(!t)return;const{extent:n,ratio:i,minHeight:s}=t,{projViewMatrix:o,extentInWorld:a}=this.updateMask(n);this._maskProjViewMatrix=o,this._maskExtentInWorld=a,e?e.setMask(this._maskExtentInWorld,this._maskProjViewMatrix,i,s):this.once("renderercreate",(e=>{e.renderer.setMask(this._maskExtentInWorld,this._maskProjViewMatrix,i,s)}))}getMaskExtent(){let e=1/0,t=1/0,n=-1/0,i=-1/0,s=-1/0,o=1/0,a=!1;const l=this.getMap();for(let h=0;h<this._maskList.length;h++){const c=this._maskList[h];if(!c.isVisible())continue;const u=c.getExtent();if(u){if(c._mesh&&c.getBBox){const e=c.getBBox();if(!zI(l.projViewMatrix,e))continue}if(a=!0,u.xmin<e&&(e=u.xmin),u.ymin<t&&(t=u.ymin),u.xmax>n&&(n=u.xmax),u.ymax>i&&(i=u.ymax),c._getHeightRange){const e=c._getHeightRange();e[0]<o&&(o=e[0]),e[1]>s&&(s=e[1])}}}if(!a)return null;const{ratio:h,minHeight:c}=function(e,t){const n=e===1/0?0:e,i=Math.abs((t===-1/0?0:t)-n);return 0===i?{ratio:1,minHeight:0}:{ratio:Math.pow(i,-1),minHeight:n}}(o,s);return{extent:new Ml(e,t,n,i),ratio:h,minHeight:c}}}}function JI(e,t,n,i=0){if(!(n&&t instanceof fl))return null;const s=n.coordinateToPointAtRes(t,n.getGLRes());return e[0]=s.x,e[1]=s.y,e[2]=i,e}const QI=new fl(0,0),$I=new fl(0,0),KI=new Re(0,0),ek=[],tk={tileGrids:[],count:0},nk="01",rk="1";class TerrainLayer extends(YI(Up)){constructor(e,t){t&&!t.tileSystem&&("cesium"===t.type||"cesium-ion"===t.type?t.tileSystem=[1,1,-180,-90]:"tianditu"===t.type&&(t.tileSystem=[1,-1,-180,90])),t.tileSize||"mapbox"===t.type&&(t.tileSize=512),t.spatialReference||"mapbox"===t.type&&(t.spatialReference="preset-3857-512"),super(e,t)}onAdd(){const e=this.options,t=this.getMap().getProjection(),n="EPSG:3857"===t.code;512!==e.tileSize||e.spatialReference||("mapbox"===e.type?"EPSG:4326"===t.code||"EPSG:4490"===t.code?e.spatialReference="preset-4326-512":n&&(e.spatialReference="preset-3857-512"):"cesium"===e.type||"cesium-ion"===e.type?e.spatialReference="preset-4326-512":"tianditu"===e.type&&(e.spatialReference={projection:"EPSG:4326",fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){const e=[];for(let t=0;t<=22;t++)e[t]=90/(128*Math.pow(2,t));return e}()})),e.terrainWidth||"tianditu"!==e.type||(e.terrainWidth=65)}getTileUrl(e,t,n){let i=super.getTileUrl(e,t,n);return"mapbox"===this.options.type&&this.options.requireSkuToken&&(this._skuToken||(this._skuToken=this._createSkuToken()),i.indexOf("?")>-1?i+="&sku="+this._skuToken:i+="?sku="+this._skuToken),i}getMaxAvailableZoom(){return this.getSpatialReference().getMaxZoom()}_createSkuToken(){let e="";for(let t=0;t<10;t++)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return[rk,nk,e].join("")}_getExaggeration(){let e=this.options.exaggeration;return xC(e)&&(e=1),e}setSkinLayers(e){this._skinLayers=e;const t=this.getRenderer();t&&(t.clear(),t.setToRedraw())}getSkinTiles(e){const t=this.getRenderer();if(!t)return tk;const n=t.getTileGridsInCurrentFrame().tileGrids[0];if(!n)return tk;const i=e.getId(),s=this._getTileConfig().tileSystem.scale,o=e.getTileSize().width,a=n.tiles;if(!a.length)return tk;const l=this.getMap(),h=n.parents||ek,c=h.length,u=h.concat(a),f=e.getSpatialReference(),g=a[0].extent2d.getWidth(),m=s.x,A=s.y,w=[],T=[],S=new Set,M=this._getTileConfig().tileSystem.scale.y;for(let t=0;t<u.length;t++){const n=u[t],{res:s}=n;let a=n.nw;a||(a=n.nw=l.pointAtResToCoord(n.extent2d.getMin(KI),n.res));const{res:h,zoom:C}=YP(f,n.z,s),I=h/s,E=XP(h,o,s,g),{extent2d:D,offset:H}=n,N=E*n.x,B=E*n.y;if(n.skinTileIds||(n.skinTileIds={}),!n.skinTileIds[i]){const t=new Set,s=[],l=ZP(e,n.x,n.y,C,a,H,A,E,0);for(let n=0;n<l.length;n++){const i=l[n];if(t.has(i.id))continue;i.idx=i.x,i.idy=i.y,i.res=h,i.url=e.getTileUrl(i.x,i.y,i.z+e.options.zoomOffset);const a=A*(i.skinY-B)*o,c=D.xmin*I+m*(i.x-N)*o,u=D.ymax*I+a,f=D.ymin*I+a;i.extent2d=M>0?new Pl(c,f,c+o,f+o):new Pl(c,u-o,c+o,u),t.add(i.id),s.push(i)}n.skinTileIds[i]=s}const z=n.skinTileIds[i];for(let e=0;e<z.length;e++)S.has(z[e].id)||(t<c?w.push(z[e]):T.push(z[e]),S.add(z[e].id))}return{tileGrids:[{extent:n.extent,tiles:T,parents:w,count:T.length}],count:T.length}}getSkinLayer(e){return this.getSkinLayers()[e]}getSkinLayers(){return this._skinLayers||ek}getSkinCount(){return this._skinLayers&&this._skinLayers.length||0}queryTerrainByProjCoord(e,t){t=t||[];const n=this.getRenderer();if(!n)return t[0]=null,t[1]=0,t;const i=this.getMap(),s=n._getTerrainTileAtPrjCoord(e);if(!s)return t[0]=null,t[1]=0,t;const o=i._prjToPointAtRes(e,1,KI);return n._queryTerrain(t,s.id,s,o,1)}queryTileTerrainByProjCoord(e,t,n,i){i=i||[];const s=this.getRenderer();if(!s)return i[0]=null,i[1]=0,i;const o=this.getMap()._prjToPointAtRes(e,1,KI);return s._queryTerrain(i,t,n,o,1)}queryTileTerrainByPointAtRes(e,t,n,i,s){s=s||[];const o=this.getRenderer();return o?o._queryTerrain(s,n,i,e,t):(s[0]=null,s[1]=0,s)}queryTerrain(e,t){t=t||[];if(!this.getRenderer())return t[0]=null,t[1]=0,t;const n=this.getMap().getProjection().project(e,QI);return this.queryTerrainByProjCoord(n,t)}queryTileMesh(e,t){const n=this.getRenderer();n&&n._queryTileMesh(e,t)}getTerrainTiles(e,t){const{x:n,y:i,z:s,res:o,offset:a}=t,l=t.extent2d.getWidth(),h=this._getTileConfig(),c=e._getTileConfig(),u=this.getSpatialReference(),{res:f,zoom:g}=YP(u,s,o),m=this.getTileSize().width,A=XP(f,m,o,l);let w=t.nw;w||(w=t.nw=this.getMap().pointAtResToCoord(t.extent2d.getMin(KI),t.res));const T=WP(this,n,i,g,w,a,c.tileSystem.scale.y,A,1)[0];for(let e=0;e<T.length;e++){const{x:t,y:n}=T[e],i=h.getTilePointNW(t,n,f,KI);T[e].res=f,T[e].extent2d=new Pl(i.x,i.y,i.x+m,i.y-m)}return T}isTerrainTileLoaded(e){const t=this.getRenderer();return!!t&&t.isTileCached(e)}updateMaterial(e){if(!e)return;this.options.material||(this.options.material={}),vC(this.options.material,e);const t=this.getRenderer();t&&t.updateMaterial(e)}setMaterial(e){if(!e)return;this.options.material=e;const t=this.getRenderer();t&&t.setMaterial(e)}_createTileNode(e,t,n,i,s,o,a,l,h,c){const u=this.getMap(),f=this.options.zoomOffset;if(!h){h=this._getTileConfig().getTilePrjExtent(e,t,o).convertTo((e=>u._prjToPointAtRes(e,o,$I)))}const g=this._getTileOffset(n);return{parent:l,layer:this.getId(),x:e,y:t,z:n,idx:i,idy:s,res:o,extent2d:h,id:c||this._getTileId(e,t,n),url:this.getTileUrl(e,t,n+f),offset:g,error:a,children:[]}}}TerrainLayer.mergeOptions({forceRenderOnMoving:!0,forceRenderOnZooming:!0,forceRenderOnRotating:!0,fadeAnimation:!1,fadeDuration:1e3/60*15,tileLimitPerFrame:2,newTerrainTileRenderLimitPerFrameOnInteracting:1,opacity:1,renderer:"gl",pyramidMode:1,tileSize:512,terrainWidth:null,backZoomOffset:0,depthMask:!0,blendSrc:"one",blendDst:"one minus src alpha",requireSkuToken:!0,cesiumIonTokenURL:"https://api.cesium.com/v1/assets/1/endpoint?access_token=",tileRetryCount:0,shader:"default",terrainTileMode:!0,tempTileCacheSize:64,tileStackStartDepth:7,tileStackDepth:6,currentTilesFirst:!1,exaggeration:1,colors:[]}),TerrainLayer.registerJSONType("TerrainLayer"),TerrainLayer.registerRenderer("gl",TerrainLayerRenderer);const ik=[],sk=[],ok=[],ak=[],lk=new Re(0,0),hk=[],ck=[],uk=[],fk=[],dk=[],pk=[],gk=[],mk=[],Ak=[];class RayCaster{constructor(e,t,n=!0){this._from=e,this._to=t,this._isLngLat=n}setFromPoint(e){this._from=Array.isArray(e)?new fl(e):e}setToPoint(e){this._to=Array.isArray(e)?new fl(e):e}test(e,t,n={}){const i=n.count||0,s=[];let o=this._from,a=this._to;this._isLngLat&&(o=_k(t,this._from.x,this._from.y,this._from.z),a=_k(t,this._to.x,this._to.y,this._to.z));const l=new to.Ray(o,a);for(let n=0;n<e.length;n++){const o=e[n];if(!this._checkBBox(o.getBoundingBox(),l))continue;const a=o.localTransform,h=o.geometry,c=h.data[h.desc.positionAttribute].array,u=h.data[h.desc.altitudeAttribute]&&h.data[h.desc.altitudeAttribute].array||hk,f=h.indices;if(!(c&&c.length&&f&&f.length))continue;const g=vA(fk,a,o.positionMatrix),m=this._testMesh(o,l,t,c,u,f,h.desc.positionSize,g,i);if(m){if(s.push({mesh:o,coordinates:m}),0!==i&&s.length>=i)break}}return s}_testMesh(e,t,n,i,s,o,a,l,h){const c=[];for(let u=0;u<o.length&&!(u>e.properties.skirtOffset);u+=3){const e=o[u],f=o[u+1],g=o[u+2],m=ZA(dk,i[e*a],i[e*a+1],i[e*a+2]),A=this._toWorldPosition(sk,n,m,s[e]/100,l),w=ZA(pk,i[f*a],i[f*a+1],i[f*a+2]),T=this._toWorldPosition(ok,n,w,s[f]/100,l),S=ZA(gk,i[g*a],i[g*a+1],i[g*a+2]),M=this._toWorldPosition(ak,n,S,s[g]/100,l),C=ZA(ik,A,T,M),I=fy(ck,A,T),E=fy(uk,A,M),D=this._testIntersection(mk,C,t);if(D){const t=n.pointAtResToAltitude(D[2],n.getGLRes());lk.x=D[0],lk.y=D[1];const i=n.pointAtResToCoordinate(lk,n.getGLRes());if(i.z=t,c.push({coordinate:i,indices:[e,f,g],normal:sy([],I,E)}),0!==h&&c.length>=h)break}}return c.length?c:null}_toWorldPosition(e,t,n,i,s){let o;return Zi.isNumber(i)?(o=t.altitudeToPoint(i,t.getGLRes()),Sy(e,n[0],n[1],0,1),Ny(e,e,s),e[2]=o):(Sy(e,n[0],n[1],n[2],1),Ny(e,e,s)),e}_testIntersection(e,t,n){return n.intersectTriangle(t[0],t[1],t[2],!0,e)}_checkBBox(e,t){return!!e&&t.intersectBox(e,Ak)}}const yk=new fl(0,0);function _k(e,t,n,i){if(!e)return null;yk.set(t,n);const s=e.coordinateToPointAtRes(yk,e.getGLRes()),o=e.altitudeToPoint(i||0,e.getGLRes());return[s.x,s.y,o]}const vk=()=>{},xk=new fl(0,0),bk=[0,0,0],wk=[0,0,0],Tk=[0,0,0];class GroupGLLayer extends Lu{static fromJSON(e){if(!e||"GroupGLLayer"!==e.type)return null;const t=e.layers.map((e=>Lu.fromJSON(e)));return new GroupGLLayer(e.id,t,e.options)}constructor(e,t,n){super(e,n),this.layers=t&&t.slice()||[],this.layers.forEach((e=>{if(e.getMap())throw new Error(`layer(${e.getId()} is already added on map`)})),this._checkChildren(),this.sortLayersByZIndex(),this._layerMap={}}sortLayersByZIndex(){if(this.layers&&this.layers.length){for(let e=0,t=this.layers.length;e<t;e++)this.layers[e].__group_gl_order=e;this.layers.sort(Mk)}}setSceneConfig(e){this.options.sceneConfig=e;const t=this.getRenderer();return t&&t.updateSceneConfig(),this}getSceneConfig(){return JSON.parse(JSON.stringify(this._getSceneConfig()))}_getSceneConfig(){return this.options.sceneConfig||{}}getGroundConfig(){return this._getSceneConfig().ground}getWeatherConfig(){return this._getSceneConfig().weather}getScanEffectConfig(){const e=this._getSceneConfig();return e.postProcess&&e.postProcess.scanEffect}addLayer(e,t){if(e.getMap())throw new Error(`layer(${e.getId()}) is already added on map`);if("gl"!==e.options.renderer)throw new Error(`layer(${e.getId()})'s renderer is canvas, not supported to be added to GroupGLLayer`);void 0===t?this.layers.push(e):this.layers.splice(t,0,e),this._checkChildren(),this.sortLayersByZIndex();const n=this.getRenderer();return n?(this._prepareLayer(e),this._updateTerrainSkinLayers(),n.setToRedraw(),this):this}removeLayer(e){Zi.isString(e)&&(e=this.getChildLayer(e));const t=this.layers.indexOf(e);if(t<0)return this;const n=e.getRenderer();n&&n.setTerrainHelper&&n.setTerrainHelper(null),e._doRemove(),this._unbindChildListeners(e),delete this._layerMap[e.getId()],this.layers.splice(t,1);const i=this.getRenderer();return i?(this._updateTerrainSkinLayers(),i.setToRedraw(),this):this}clearLayers(){const e=this.getLayers();for(let t=0;t<e.length;t++)e[t]&&e[t].remove();return this}_updatePolygonOffset(){let e=0;for(let t=0;t<this.layers.length;t++){const n=this.layers[t];n.setPolygonOffset&&n.getPolygonOffsetCount&&(e+=n.getPolygonOffsetCount())}let t=0;for(let n=this.layers.length-1;n>=0;n--){const i=this.layers[n];i.setPolygonOffset&&i.getPolygonOffsetCount&&(i.setPolygonOffset(t,e),t+=i.getPolygonOffsetCount())}this._polygonOffset=t}getPolygonOffsetCount(){return this._polygonOffset}getLayers(){return this.layers.slice()}_getLayers(){return this.layers}toJSON(){const e=[];if(this.layers)for(let t=0;t<this.layers.length;t++){const n=this.layers[t];n&&(n&&n.toJSON&&e.push(n.toJSON()))}return{type:this.getJSONType(),id:this.getId(),layers:e,options:this.config()}}onLoadEnd(){this.layers.forEach((e=>{this._prepareLayer(e)})),this.options.terrain&&this._initTerrainLayer(),super.onLoadEnd()}_prepareLayer(e){const t=this.getRenderer();this._layerMap[e.getId()]=e,e._canvas=t.canvas,e._bindMap(this),e.once("renderercreate",this._onChildRendererCreate,this),e.remove=()=>(this.removeLayer(e),e.constructor.prototype.remove.call(e),delete e.remove,this),e.load(),this._bindChildListeners(e)}onRemove(){this._removeTerrainLayer(),this.layers.forEach((e=>{this._resetSkinLayer(e),e._doRemove(),this._unbindChildListeners(e)})),this._layerMap={},this.clearAnalysis(),super.onRemove()}getChildLayer(e){return this._layerMap[e]||null}getLayer(e){return this.getChildLayer(e)}_bindChildListeners(e){e.on("show hide",this._onLayerShowHide,this),e.on("idchange",this._onLayerIDChange,this)}_unbindChildListeners(e){e.off("show hide",this._onLayerShowHide,this),e.off("idchange",this._onLayerIDChange,this)}_onLayerShowHide(){const e=this.getRenderer();e&&e.setToRedraw()}_onLayerIDChange(e){const t=e.new,n=e.old,i=this.getLayer(n);delete this._layerMap[n],this._layerMap[t]=i}_onChildRendererCreate(e){e.renderer.clearCanvas=Sk}_checkChildren(){const e={};this.layers.forEach((t=>{const n=t.getId();if(e[n])throw new Error(`Duplicate child layer id (${n}) in the GroupGLLayer (${this.getId()})`);e[n]=1}))}addAnalysis(e){this._analysisTaskList=this._analysisTaskList||[],this._analysisTaskList.push(e);const t=this.getRenderer();t&&t.setToRedraw()}removeAnalysis(e){if(this._analysisTaskList){const t=this._analysisTaskList.indexOf(e);t>-1&&(this._analysisTaskList.splice(t,1),e.remove())}const t=this.getRenderer();t&&t.setToRedraw()}clearAnalysis(){this._analysisTaskList&&(this._analysisTaskList.forEach((e=>{e.remove()})),this._analysisTaskList=[]);const e=this.getRenderer();e&&e.setToRedraw()}identify(e,t){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];const s=n.coordToContainerPoint(new fl(e));return this.identifyAtPoint(s,t)}identifyAtPoint(e,t={}){const n=t.includeInternals,i=this.getLayers(),s=t&&t.childLayers||i,o=this.getMap();if(!o)return[];const a=xC(t.count)?1:t.count;let l=[];for(let o=s.length-1;o>=0;o--){const a=s[o];if(i.indexOf(a)<0||!a.identifyAtPoint)continue;const h=a.options.geometryEvents;if(n&&(void 0===h||!1===h||0===h))continue;if(a.isGeometryListening&&n&&t.eventTypes.indexOf("mousemove")>=0&&!a.isGeometryListening(t.eventTypes))continue;const c=a.identifyAtPoint(e,t);if(!c||!c.length)continue;const u=a.getId();for(let e=0;e<c.length;e++)c[e]&&(c[e].layer=u);l.push(...c)}if(t.orderByCamera){const e=o.cameraPosition;l.sort(((t,n)=>n.point?t.point?gy(t.point,e)-gy(n.point,e):1:-1))}return a&&(l=l.slice(0,a)),l}getTerrain(){return this.options.terrain}setTerrain(e){return this.options.terrain=e,this.getRenderer()?(this._initTerrainLayer(),this.getMap().updateCenterAltitude(),this):this}removeTerrain(){return this.setTerrain(null)}updateTerrainMaterial(e){this._terrainLayer&&e&&(this.options.terrain.material?vC(this.options.terrain.material,e):this.options.terrain.material=e,this._terrainLayer.updateMaterial(e))}_initTerrainLayer(){const e=this.getRenderer();e&&e.setToRedraw();const t=this.options.terrain;if(this._terrainLayer){const e=this._terrainLayer,n=e.options;if(t&&n.urlTemplate===t.urlTemplate&&n.spatialReference===t.spatialReference){for(const n in t)"material"===n?e.setMaterial(t[n]):"urlTemplate"!==n&&"spatialReference"!==n&&e.config(n,t[n]);return this}this._removeTerrainLayer()}if(this._resetTerrainSkinLayers(),!t)return this;this._terrainLayer=new TerrainLayer("__terrain_in_group",t),this._updateTerrainSkinLayers();const n=this._terrainLayer;n.on("tileload",this._onTerrainTileLoad,this),this._prepareLayer(n);const i=t.masks;return i&&i.length?n.setMask(i):n.removeMask(),this.fire("terrainlayercreated"),this}queryTerrain(e,t){return this._terrainLayer?this._terrainLayer.queryTerrain(e,t):(t&&(t[0]=null,t[1]=0),[null,0])}queryTerrainAtPoint(e){if(!this._terrainLayer)return null;const t=this._terrainLayer.getRenderer().getAnalysisMeshes();return this._queryRayCast(e,t)}query3DTilesAtPoint(e){const t=this._getLayers().filter((e=>e&&e.isGeo3DTilesLayer));if(!t.length)return null;const n={excludeMasks:!0};for(let i=0;i<t.length;i++){if(!t[i].getRenderer())continue;const s=t[i].identifyAtPoint(e,n);if(s.length)return new fl(s[0].coordinate)}return null}_queryRayCast(e,t){const n=this.getMap(),i=n.getGLRes();n.getContainerPointRay(wk,Tk,e);const s=new RayCaster(wk,Tk,!1).test(t,n,{count:1}),o=[];s.forEach((e=>{e.coordinates.forEach((e=>{o.push(e.coordinate)}))}));const a=n.pointAtResToCoordinate(new Re(wk[0],wk[1]),i,xk);this._meterToGLPoint||(this._meterToGLPoint=n.altitudeToPoint(1,i)),a.z=wk[2]/this._meterToGLPoint;const l=ZA(bk,a.x,a.y,a.z);return o.sort(((e,t)=>gy(e.toArray(),l)-gy(t.toArray(),l))),o[0]}queryTerrainByProjCoord(e,t){return this._terrainLayer?this._terrainLayer.queryTerrainByProjCoord(e,t):(t&&(t[0]=null,t[1]=0),[null,0])}_updateTerrainSkinLayers(){if(!this._terrainLayer)return;const e=this.layers,t=[];for(let n=0;n<e.length;n++){if(!e[n])continue;const i=e[n],s=i.getRenderer();if(s.renderTerrainSkin){if(s.deleteTile===vk){t.push(e[n]);continue}i.getTiles=()=>this._terrainLayer&&this._terrainLayer.getSkinTiles(i),s.drawTile=s.drawTileOnTerrain?(...e)=>s.drawTileOnTerrain(...e):vk,s.deleteTile=vk,t.push(e[n])}s.setTerrainHelper&&s.setTerrainHelper(this._terrainLayer)}this._terrainLayer.setSkinLayers(t)}_resetSkinLayer(e){if(!function(e){if(!e)return!1;const t=e.getRenderer();if(!t)return!1;return!!t.renderTerrainSkin}(e))return;const t=e.getRenderer();t&&(t.setTerrainHelper&&t.setTerrainHelper(null),t.clear&&t.clear(),delete t.drawTile,delete t.deleteTile),delete e.getTiles}_resetTerrainSkinLayers(){const e=this.layers;for(let t=0;t<e.length;t++)e[t]&&this._resetSkinLayer(e[t])}_onTerrainTileLoad(){const e=this.getRenderer();e&&e.setToRedraw()}_removeTerrainLayer(){if(this._terrainLayer){const e=this._terrainLayer;e.off("tileload",this._onTerrainTileLoad,this),this._unbindChildListeners(e),this._terrainLayer._doRemove(),delete this._terrainLayer,this.fire("terrainlayerremoved")}}getTerrainLayer(){return this._terrainLayer}_bindMap(...e){if(this.options.single){const t=e[0].getLayers();for(let e=0;e<t.length;e++)if(t[e]instanceof GroupGLLayer)throw new Error("Only one GroupGLLayer is allowed in a map instance. Set options.single to false if you want to add two or more GroupGLLayers.")}return super._bindMap(...e)}fire(...e){if("layerload"===e[0]){const e=this._getLayers();for(const t of e){const e=t.getRenderer();e&&e.isRenderComplete()&&t.fire("layerload")}}super.fire(...e)}}function Sk(){}function Mk(e,t){const n=e.getZIndex()-t.getZIndex();return 0===n?e.__group_gl_order-t.__group_gl_order:n}var Ck;GroupGLLayer.mergeOptions({renderer:"gl",antialias:!0,extensions:[],single:!0,onlyWebGL1:!1,optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","EXT_frag_depth","EXT_texture_filter_anisotropic","WEBGL_compressed_texture_astc","WEBGL_compressed_texture_etc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_compressed_texture_s3tc_srgb"],forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,viewMoveThreshold:100,geometryEvents:!0,multiSamples:4,forceRedrawPerFrame:!1}),GroupGLLayer.registerJSONType("GroupGLLayer"),GroupGLLayer.registerRenderer("gl",GroupGLLayerRenderer),GroupGLLayer.registerRenderer("canvas",null),function(e){e[e.AMBIENT=0]="AMBIENT",e[e.REALISTIC=1]="REALISTIC"}(Ck||(Ck={}));class LightManager{constructor(e){this._map=e,this._loader=new ResourceLoader}getDirectionalLight(){return this._config&&this._config.directional||{}}getAmbientLight(){return this._config&&this._config.ambient||{}}getAmbientResource(){return this._iblMaps}setConfig(e){const t=this._config;this._urlModifier=e.urlModifier,this._config=JSON.parse(JSON.stringify(e));let n=!1;if(e&&e.ambient&&e.ambient.resource){if(!(t&&t.ambient&&function(e,t){if(!e.resource)return!1;if(e.resource.url!==t.resource.url)return!1;return!0}(t.ambient,e.ambient)))return void this._initAmbientResources();if(this._iblMaps){const i=t.ambient&&t.ambient.resource,s=e.ambient.resource;s&&s.prefilterCubeSize!==i&&i.prefilterCubeSize&&this._onHDRLoaded(),n=!0,e.ambient.resource.sh&&(this._iblMaps.sh=e.ambient.resource.sh)}}else this._disposeCubeLight(),n=t&&t.ambient&&t.ambient.resource;this._map.fire("updatelights",{ambientUpdate:n})}_tryToGetREGLContext(e){const t=e.getLayers();for(let e=0;e<t.length;e++){const n=t[e]&&t[e].getRenderer();if(n&&n.regl)return n.regl}const n=document.createElement("canvas"),i=Wm({canvas:n,attributes:{depth:!1,stencil:!1,alpha:!1},optionalExtensions:["OES_standard_derivatives","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear"]});return i._temp=!0,i}_initAmbientResources(){const e=this._config.ambient.resource,t=e&&e.url;if(!t)return;const n=[];let i=0,s=0;const o=()=>{s++,s>=i&&this._onSkyboxLoaded(n)},a=function(){throw new Error(`skybox image with url(${this.src}) failed to load, please check the image's url.`)},l=this._urlModifier;if(t.top||t.nx){const{front:e,back:s,right:h,left:c,top:u,bottom:f}=t,{nx:g,ny:m,px:A,py:w,nz:T,pz:S}=t;let M;M=e?[c,h,s,e,u,f]:[g,A,T,S,w,m],i=M.length;for(let e=0;e<i;e++){const t=new Image;t.onload=o,t.onerror=a,t.src=l&&l(M[e])||M[e],n[e]=t}}else{const t={url:e.url,arrayBuffer:!0,hdr:!0,flipY:!0};this._loader.setURLModifier(l),this._hdr=new Texture2D(t,this._loader),this._hdr.once("complete",(()=>{this._onHDRLoaded()})),this._hdr.once("error",(()=>{this._onHDRError()}))}}dispose(){this._disposeCubeLight()}_onHDRLoaded(){this._hdr&&(this._iblMaps=this._createIBLMaps(this._hdr),this._map.fire("updatelights",{ambientUpdate:!0}))}_onHDRError(){this._map.fire("hdrerror")}_onSkyboxLoaded(e){this._iblMaps=this._createIBLMaps(e),this._map.fire("updatelights",{ambientUpdate:!0})}_createIBLMaps(e){const t=this._config.ambient.resource,n=t.prefilterCubeSize||512,i=this._tryToGetREGLContext(this._map),s=SM.PBRHelper.createIBLMaps(i,{envTexture:Array.isArray(e)?e:e.getREGLTexture(i),ignoreSH:!!t.sh,envCubeSize:n,prefilterCubeSize:n,environmentExposure:this._config.ambient.exposure,format:"array"});if(t.sh&&(s.sh=t.sh,Array.isArray(s.sh[0]))){const e=s.sh,t=[];for(let n=0;n<e.length;n++)t.push(...e[n]);s.sh=t}return i._temp&&(delete this._hdr,i.destroy()),s}_disposeCubeLight(){this._hdr&&(this._hdr.dispose(),delete this._hdr),delete this._iblMaps}}let Pk,Ik,kk,Ok,Ek;zu.include({setLights(e){return this.options.lights=e,this._initLightManager(),this},getLights(){return this.options.lights},_initLightManager(){this._lightManager||(this._lightManager=new LightManager(this)),this._lightManager.setConfig(this.getLights())},getLightManager(){return this._lightManager?this._lightManager:null}}),zu.addOnLoadHook((function(){this.options.lights&&this._initLightManager()}));const Rk={color:[0,0,0,0]},Lk={enable:!1};zu.include({setPostProcessConfig(e){return this.options.postProcessConfig=e,this},getPostProcessConfig(){return this.options.postProcessConfig}});const Dk=Om.MapCanvasRenderer.prototype.drawLayerCanvas;Om.MapCanvasRenderer.prototype.drawLayerCanvas=function(){const e=Dk.apply(this,arguments);return e&&function(e,t){const n=e.map.getPostProcessConfig();if(!n||!n.enable)return;Pk||(i=t.width,s=t.height,Pk=document.createElement("canvas",i,s),Ik=Wm({canvas:Pk,attributes:{depth:!1,stencil:!1,alpha:!0,antialias:!1,premultipliedAlpha:!1}}),kk=Ik.texture({mag:"linear",min:"linear",mipmap:!1,flipY:!0,width:i,height:s}),Ok=Ik.texture());var i,s;Pk.width===t.width&&Pk.height===t.height||(Pk.width=t.width,Pk.height=t.height);Ik.clear(Rk);const o=n.filmicGrain||Lk;void 0===o.enable&&(o.enable=!0);const a=n.vignette||Lk;void 0===a.enable&&(a.enable=!0);const l=n.colorLUT||Lk;void 0===l.enable&&(l.enable=!0);e._postProcessContext||(e._postProcessContext={});const h=e._postProcessContext;if(l.enable){const e=l.lut;if(!h.lutTexture||h.lutTexture.url!==e){const t=new Image;t.onload=function(){const n={data:t,min:"linear",mag:"linear"},i=h.lutTexture?h.lutTexture.texture(n):Ik.texture(n);h.lutTexture={url:e,texture:i}},t.src=e}}const c={enableGrain:+!!o.enable,grainFactor:void 0===o.factor?.15:o.factor,timeGrain:performance.now(),enableVignette:+!!a.enable,lensRadius:a.lensRadius||[.8,.25],frameMod:1,enableLut:+!!l.enable,lookupTable:h.lutTexture?h.lutTexture.texture:Ok};Ek||(Ek=new PostProcess(Ik));Ek.postprocess(null,c,kk({width:Pk.width,height:Pk.height,data:t,flipY:!0,mag:"linear",min:"linear",mipmap:!1})),e.context.drawImage(Pk,0,0,Pk.width,Pk.height)}(this,this.canvas),e};const Fk=Om.MapCanvasRenderer.prototype.renderFrame;Om.MapCanvasRenderer.prototype.renderFrame=function(){const e=Fk.apply(this,arguments),t=this.map.getPostProcessConfig(),n=t&&t.filmicGrain;return!n||void 0!==n.enable&&!0!==n.enable||this.setToRedraw(),e};zu.registerRenderer("gl",class MapGLRenderer extends Om.MapAbstractRenderer{clearCanvas(){this.regl&&this.regl.clear({color:[0,0,0,0]})}clearLayerCanvasContext(e){if(!this.regl)return;const t=e.getRenderer();this.regl.clear({depth:1,stencil:0}),t.clearContext()}createContext(){const e=this.map,{preserveDrawingBuffer:t,onlyWebGL1:n,extensions:i,optionalExtensions:s}=e.options,o=e.getRenderer().canvas,{gl:a,regl:l,reglGL:h,context:c}=kP(o,t,n,i,s);return this.gl=a,this.regl=l,this.reglGL=h,this.context=c,Promise.resolve()}_initGL(){const e=this.map,t=this.gl,n=e.options.extensions;n&&n.forEach((e=>{t.getExtension(e)}));const i=e.options.optionalExtensions;i&&i.forEach((e=>{t.getExtension(e)}))}getContextInstance(){return this.gl.wrap()}isWebGPU(){return!1}});const Hk=[];function Nk(e){e.properties.showOnlyTimestamp&&(delete e.properties.showOnlyTimestamp,zk(e))}function Bk(e,t){const n=e.geometry.properties;n.oldElementsBeforeHighlight||(n.oldElementsBeforeHighlight=e.geometry.elements),n.elements&&(n.oldElementsArrBeforeHighlight||(n.oldElementsArrBeforeHighlight=n.elements),n.elements=t)}function zk(e){const t=e.geometry.properties.oldElementsBeforeHighlight;t&&e.geometry.elements!==t&&(e.geometry.deleteElements(),e.geometry.setElements(e.geometry.properties.oldElementsBeforeHighlight),e.geometry.properties.oldElementsArrBeforeHighlight&&(e.geometry.properties.elements=e.geometry.properties.oldElementsArrBeforeHighlight,delete e.geometry.properties.oldElementsArrBeforeHighlight),delete e.geometry.properties.hasInvisible,delete e.geometry.properties.oldElementsBeforeHighlight)}function Gk(e){if(!e.properties.highlightTimestamp)return;const t=e.defines;delete t.HAS_HIGHLIGHT_COLOR,delete t.HAS_HIGHLIGHT_OPACITY,e.setDefines(t),delete e.properties.highlightTimestamp,zk(e),Uk(e)}function Uk(e){if(!e)return;const{hlBloomMesh:t}=e.properties;if(t){const n=t.geometry;n.elements&&n.elements.destroy&&n.deleteElements(),t.dispose(),delete e.properties.hlBloomMesh}}var Vk=Object.freeze({__proto__:null,clearHighlight:Gk,clearShowOnly:Nk,deleteHighlightBloomMesh:Uk,highlightMesh:function(e,t,n,i,s){const{highlightTimestamp:o}=t.properties;if(!n)return void(o&&Gk(t));if(i===o)return;const a=t instanceof InstancedMesh,l=a?t.instanceCount:t.geometry.getVertexCount();let{aHighlightColor:h,aHighlightOpacity:c}=t.geometry.properties;h&&h.fill(0),c&&c.fill(255);let u=!1,f=!1;const g=n.keys();let m=null,A=null;for(const e of g)if(s.has(e)){const i=n.get(e),{color:o,bloom:a,visible:g,nodeIndex:w}=i;if(!xC(w)&&w!==t.properties.nodeIndex)continue;let T,{opacity:S}=i;if(o&&(u||(h||(h=new Uint8Array(4*l)),u=!0),T=kC(Hk,o)),S=xC(S)?1:S,S<1&&(f||(c||(c=new Uint8Array(l),c.fill(255)),f=!0)),!1===g&&(A||(A=new Set),A.add(e)),T||S<1||a){const t=s.get(e);if(t)for(let e=0;e<t.length;e++){const n=t[e];T&&Sy(h.subarray(4*n,4*n+4),...T),S<1&&(c[n]=255*S),a&&(m||(m=[]),m.push(n))}}}const w=t.geometry,T=t.defines;if(u?(a?(t.updateInstancedData("aHighlightColor",h),t.generateInstancedBuffers(e)):(w.data.aHighlightColor?w.updateData("aHighlightColor",h):(w.data.aHighlightColor=h,w.generateBuffers(e)),w.properties.aHighlightColor=h),T.HAS_HIGHLIGHT_COLOR=1):T.HAS_HIGHLIGHT_COLOR&&(a?(t.updateInstancedData("aHighlightColor",h),t.generateInstancedBuffers(e)):w.updateData("aHighlightColor",h),delete T.HAS_HIGHLIGHT_COLOR),f?(a?(t.updateInstancedData("aHighlightOpacity",c),t.generateInstancedBuffers(e)):(w.data.aHighlightOpacity?w.updateData("aHighlightOpacity",c):(w.data.aHighlightOpacity=c,w.generateBuffers(e)),w.properties.aHighlightOpacity=c),T.HAS_HIGHLIGHT_OPACITY=1):T.HAS_HIGHLIGHT_OPACITY&&(a?(t.updateInstancedData("aHighlightOpacity",c),t.generateInstancedBuffers(e)):w.updateData("aHighlightOpacity",c),delete T.HAS_HIGHLIGHT_OPACITY),A&&A.size>0){let n=[];s.forEach(((e,t)=>{A.has(t)||CC(n,e)})),w.properties.hasInvisible=!0,Bk(t,n);const i={data:n,primitive:w.getPrimitive()};w.elements!==w.properties.oldElementsBeforeHighlight&&w.elements.destroy&&w.deleteElements(),n=e.elements(i),w.setElements(n),w.generateBuffers(e)}else w.properties.hasInvisible&&zk(t);t.setDefines(T),t.properties.highlightTimestamp=i;let S=t.properties.hlBloomMesh;if(m&&m.length){if(S){const e=mA(S.localTransform,t.localTransform),n=mA(S.positionMatrix,t.positionMatrix);S.setLocalTransform(e),S.setPositionMatrix(n),t.properties.hlBloomMesh.geometry.setElements(m)}else{const n=new Geometry(w.data,m,0,w.desc);n.generateBuffers(e);S=new Mesh(n,t.material,t.config);const i=t.uniforms;for(const e in i)Object.defineProperty(S.uniforms,e,{enumerable:!0,get:function(){return t.getUniform(e)}});const s=vC({},t.defines);s.HAS_BLOOM=1;const o=mA([],t.localTransform),a=mA([],t.positionMatrix);S.setLocalTransform(o),S.setPositionMatrix(a),vC(S.properties,t.properties),vC(n.properties,w.properties),S.setDefines(s),S.bloom=1}t.properties.hlBloomMesh=S}else S&&Uk(t)},showOnly:function(e,t,n,i,s){const{showOnlyTimestamp:o}=t.properties;if(!n)return void(o&&Nk(t));if(i===o)return;t.properties.showOnlyTimestamp=i;const a=n.keys(),l=[];for(const e of a){if(!s.has(e))continue;const t=s.get(e);t&&CC(l,t)}Bk(t,l),t.geometry.elements!==t.geometry.properties.oldElementsBeforeHighlight&&t.geometry.elements.destroy&&t.geometry.deleteElements();const h={data:l,primitive:t.geometry.getPrimitive()};t.geometry.setElements(e.elements(h)),t.geometry.generateBuffers(e)}});const jk=function(e){return class extends e{constructor(){super(...arguments),this._textures=[]}getTexture(){this._textures||(this._textures=[]);const e=this._textures;return e&&e.length>0?e.pop():null}saveTexture(e){this._textures.push(e)}disposeTexturePool(){const e=this._textures;for(let t=0;t<e.length;t++)e[t].dispose();this._textures=[]}}},Wk=new Re(0,0),qk=[1,1,1,1];function Zk(e,t,n,i,s,o){const a=n.xmax-n.xmin,l=n.ymax-n.ymin,h=Wk.set(n.xmin-(i=i||[0,0])[0],n.ymax-i[1]),c=h.x*s,u=h.y*s,f={data:t,mag:"nearest",mipmap:!0};let g=this.getTexture();g?g.setConfig(f):g=new Texture2D(f),o=vC(o||{},{opacity:1,debugLine:0,alphaTest:0,baseColor:qk,baseColorTexture:g});const m=new Material(o),A=new Mesh(e,m);A.properties.minFilter=zw;const w=AA([]);return xA(w,w,[c||0,u||0,0]),bA(w,w,[s*a,s*l,1]),A.localTransform=w,A}function Xk(e,t,n){const i=function(e){const t=e.getZoom(),n=e.isMoving()&&e.getRenderer().isViewChanged();let i;i=n?Uw:e.getBearing()||e.getPitch()||!Number.isInteger(t)?Gw:zw;return i}(t);if(e.properties.minFilter!==i){e.material.get("baseColorTexture").setMinFilter(i),e.properties.minFilter=i}const s=t.getDevicePixelRatio(),o=t.getResolution()!==n;let a=zw;if((1!==s||o)&&(a=Gw),e.properties.magFilter!==a){e.material.get("baseColorTexture").setMagFilter(a),e.properties.magFilter=a}}const{TileLayerRendererable:Yk,LayerAbstractRenderer:Jk}=Om,Qk=new Int16Array([0,0,0,-1,1,0,1,-1]),$k=new Uint16Array([0,0,0,1,1,0,1,1]),Kk={properties:{}},eO=new Re(20,20);class TileLayerGLRenderer2 extends(jk(OP(Yk(Jk)))){constructor(e){super(e),this.init()}onResize(e){super.onResize(e),this.resizeCanvas()}onDrawTileStart(e,t){if(!this._tileGeometry){this._shader=new ImageShader({extraCommandProps:this._getCommandProps()}),this._tileGeometry=new Geometry({aPosition:Qk,aTexCoord:$k},4,0,{positionSize:2,primitive:"triangle strip"});const{regl:e,device:t}=this.context;this._tileGeometry.generateBuffers(e||t),this._tileMeshes=[],this._tileScene=new Scene(this._tileMeshes),this._renderer=new Renderer(e||t)}this._tileMeshes.length=0,this.clearStencil(t)}clearStencil(e){let t;e&&e.renderTarget&&(t=e.renderTarget.fbo);const{regl:n,device:i}=this.context;(n||i).clear({stencil:255,fbo:t})}onDrawTileEnd(e,t){const n=this._getUniformValues();let i;t&&t.renderTarget&&(i=t.renderTarget.fbo),this._tileScene.setMeshes(this._tileMeshes),this._renderer.render(this._shader,n,this._tileScene,i)}_getUniformValues(){return{projViewMatrix:this.getMap().projViewMatrix}}consumeTile(e,t){let n=e.mesh;return n||(n=this._createTileMesh(t,e),e.mesh=n),super.consumeTile(e,t)}drawTile(e,t,n){if(n&&n.sceneFilter&&!n.sceneFilter(Kk))return;const i=this.getMap();if(!e||!i||!t)return;let s=t.mesh;s||(s=this._createTileMesh(e,t),t.mesh=s);const o=s.getDefines();if(this.layer.options.debug){let n=s.material.get("debugTexture");n||(n=this._createDebugTexture(e,t.width,t.height),s.material.set("debugTexture",n),t.debugTexture=n),o.HAS_DEBUG||s.setDefines({HAS_DEBUG:1})}else o.HAS_DEBUG&&s.setDefines({});Xk(s,i,e.res);let a=this.getTileOpacity(t,e),l=this.layer.options.opacity;xC(l)&&(l=1),a*=l,s.material.set("opacity",a),s.setUniform("isCurrentTiles",+!!this.drawingCurrentTiles),this._tileMeshes.push(s),this.getTileFadingOpacity(t)<1&&this.setToRedraw()}_createDebugTexture(e,t,n){const i=this.getDebugInfo(e.id),s=this.getMap().getDevicePixelRatio()>1?2:1,o=this._debugInfoCanvas=document.createElement("canvas");o.width=t*s,o.height=n*s;const a=o.getContext("2d");a.font="20px monospace",a.scale(s,s);const l=this.layer.options.debugOutline;a.fillStyle=l,a.strokeStyle=l,a.lineWidth=3,a.fillText(i,20,n-12),a.beginPath(),a.moveTo(0,0),a.lineTo(t,0),a.lineTo(t,n),a.lineTo(0,n),a.lineTo(0,0),a.stroke();const h={data:o,width:o.width,height:o.height};let c=this.getTexture();c?c.setConfig(h):c=new Texture2D(h);const{device:u,regl:f}=this.context;return c.getREGLTexture(u||f),c}_createTileMesh(e,t){const n=this.getMap(),i=e.res/n.getGLRes(),s=Zk.call(this,this._tileGeometry,t,e.extent2d,e.offset,i,{zoom:e.z}),o=s.material.get("baseColorTexture");return t.texture=o,s}loadTileImage(e,t){const n=this.layer.options.crossOrigin;e.crossOrigin=null!==n?n:"",e.src=t}deleteTile(e){if(!e||!e.image)return super.deleteTile(e);const t=e.image;t.texture&&this.saveTexture(t.texture),t.debugTexture&&this.saveTexture(t.debugTexture),delete t.texture,delete t.debugTexture;const n=t.mesh;return n&&(n.material.set("baseColorTexture",null,!1),n.material.set("debugTexture",null,!1),n.material.dispose(),n.dispose(),delete t.mesh),super.deleteTile(e)}onRemove(){this._tileGeometry&&(this._shader.dispose(),this._tileGeometry.dispose(),delete this._shader,delete this._tileGeometry,delete this._renderer,delete this._tileScene,delete this._tileMeshes),this.disposeTexturePool(),super.onRemove()}_getCommandProps(){const e=this.getMap().getRenderer().canvas,t={units:0,factor:0};return{stencil:{enable:!0,func:{cmp:"<=",ref:(e,t)=>Math.abs(this.getCurrentTileZoom()-t.zoom)},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,func:"<="},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"},viewport:{x:0,y:0,width:()=>e?e.width:1,height:()=>e?e.height:1},polygonOffset:{enable:!0,offset:(e,n)=>{let i=this.layer.getPolygonOffset();return i=n.isCurrentTiles?i:i+1,t.factor=i,t.units=i,t}}}}renderTerrainSkin(e,t,n){const i=this.layer.getTileSize().width,s=t.options.debug;for(let e=0;e<n.length;e++){const{tile:t,texture:o}=n[e];if(!t.image)continue;const a=document.createElement("canvas");n[e].canvas=a,a.width=i,a.height=i;const l=a.getContext("2d");if(l.drawImage(t.image,0,0),s){const{x:e,y:n,z:s}=t.info;tO(l,`${e}/${n}/${s}`,"yellow",1,0,0,i,i,-18)}const h={data:a,width:i,height:i,flipY:!0,min:"linear mipmap linear",mag:"linear"};o.update?o.update(h):o(h)}}createTerrainTexture(e){const t=this.layer.getTileSize().width;return e.texture({width:t,height:t,flipY:!0,min:"linear mipmap linear",mag:"linear",depthStencil:!1,depth:!1,stencil:!1})}deleteTerrainTexture(e){e.destroy()}clear(){this.clearTileCaches(),super.clear()}}function tO(e,t,n,i,s,o,a,l,h=0){e.font="20px monospace",e.fillStyle=n,eO.y=l-30,e.globalAlpha=1,e.fillText(t,eO.x+s,eO.y+o+h),e.globalAlpha=.6,e.strokeStyle=n,e.lineWidth=i,e.beginPath(),e.moveTo(s,o),e.lineTo(s+a,o),e.lineTo(s+a,o+l),e.lineTo(s,o+l),e.lineTo(s,o),e.stroke(),e.globalAlpha=1}Up.registerRenderer("gl",TileLayerGLRenderer2);const{LayerAbstractRenderer:nO,ImageLayerRenderable:rO}=Om,iO=new Int16Array([0,0,0,-1,1,0,1,-1]),sO=new Uint16Array([0,0,0,1,1,0,1,1]);class ImageLayerGLRenderer2 extends(jk(OP(rO(nO)))){constructor(){super(...arguments),this._imageMeshes=[]}isDrawable(){return!0}drawImage(e,t,n){let i=e.mesh;i||(i=this._createImageMesh(e,t),e.mesh=i);const s=this.getMap();if(Xk(i,s,s.getGLRes()),s.getRenderer().canvas===this.canvas){let e=this.layer.options.opacity;xC(e)&&(e=1),n*=e}i.material.set("opacity",n),this._imageMeshes.push(i)}_createImageMesh(e,t){const n=Zk.call(this,this._imageGeometry,e,t,null,1),i=n.material.get("baseColorTexture");return e.texture=i,n}drawImages(e,t){this._imageMeshes.length=0,super.drawImages(e,t);const n=this._getUniformValues();let i;t&&t.renderTarget&&(i=t.renderTarget.fbo),this._imageScene.setMeshes(this._imageMeshes),this._renderer.render(this._shader,n,this._imageScene,i)}_getUniformValues(){return{projViewMatrix:this.getMap().projViewMatrix}}retireImage(e){const t=e.texture;if(t&&(this.saveTexture(t),delete e.texture),e.mesh){const t=e.mesh;t.material.set("baseColorTexture",null,!1),t.material.dispose(),e.mesh.dispose()}return delete e.mesh,super.retireImage(e)}initContext(){this._shader=new ImageShader({extraCommandProps:this._getCommandProps()}),this._imageGeometry=new Geometry({aPosition:iO,aTexCoord:sO},4,0,{positionSize:2,primitive:"triangle strip"});const{regl:e,device:t}=this.context;this._imageGeometry.generateBuffers(e||t),this._imageMeshes=[],this._imageScene=new Scene(this._imageMeshes),this._renderer=new Renderer(e||t)}_getCommandProps(){const e=this.getMap().getRenderer().canvas;return{viewport:{x:0,y:0,width:()=>e?e.width:1,height:()=>e?e.height:1},depth:{enable:!0,func:this.layer.options.depthFunc,mask:!!this.layer.options.depthMask},blend:{enable:!0,func:{src:1,dst:"one minus src alpha"},equation:"add"}}}onRemove(){return this.disposeTexturePool(),super.onRemove()}}function oO(e,t,n,i){return new(n||(n=Promise))((function(t,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function a(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof n?i:new n((function(e){e(i)}))).then(o,a)}l((i=i.apply(e,[])).next())}))}let aO,lO;function hO(){return oO(this,0,void 0,(function*(){var e;return lO||(aO=yield null===(e=navigator.gpu)||void 0===e?void 0:e.requestAdapter(),lO=yield null==aO?void 0:aO.requestDevice({}),{gpuDevice:lO,gpuAdapter:aO})}))}yg.registerRenderer("gl",ImageLayerGLRenderer2),"function"==typeof SuppressedError&&SuppressedError;zu.registerRenderer("gpu",class MapGPURenderer extends Om.MapAbstractRenderer{drawLayers(e,t){const n=super.drawLayers(e,t);return n&&this.device.submit(),n}clearCanvas(){this.device&&this.device.clear({color:[0,0,0,0]})}clearLayerCanvasContext(e){if(!this.device)return;const t=e.getRenderer();this.device.clear({depth:1,stencil:0}),t.clearContext()}isWebGPU(){return!0}createContext(){return oO(this,0,void 0,(function*(){const{gpuDevice:e,gpuAdapter:t}=yield hO(),n=this.canvas.getContext("webgpu");this.device=new GraphicsDevice(e,n,t),this.context={context:n,device:this.device,getImageData:(e,t,n,i)=>{const s=new Uint8Array(n*i*4);return this.device.read({x:e,y:this.canvas.height-t,width:n,height:i,data:s}),new ImageData(new Uint8ClampedArray(s.buffer),n,i)}}}))}});const cO=[0,0,0,0];class HeatmapProcess{constructor(e,t,n,i,s,o){this.renderer=new Renderer(e),this.sceneConfig=t,this._layer=n,this._colorStops=i,this._stencil=s,this._polygonOffset=o||{factor:0,units:0},this._init(),this._outputSize=[]}render(e,t,n){this._check();const i=this._layer.getMap();this.renderer.device.clear({color:cO,depth:1,stencil:255,framebuffer:this._heatmapFBO}),this.renderer.render(this._heatmapShader,t,e,this._heatmapFBO);const s=this._layer.getRenderer().canvas;this._outputSize[0]=s.width,this._outputSize[1]=s.height;const o=vC({colorRamp:this._colorRampTex,inputTexture:this._heatmapFBO,projViewMatrix:i.projViewMatrix,textureOutputSize:this._outputSize},t);return this._transformGround(),this.renderer.render(this._displayShader,o,this._groundScene,n)}dispose(){this._heatmapShader&&(this._heatmapShader.dispose(),delete this._heatmapShader),this._displayShader&&(this._displayShader.dispose(),delete this._displayShader),this._ground&&(this._ground.geometry.dispose(),this._ground.dispose(),delete this._ground,delete this._groundScene),this._heatmapFBO&&(this._heatmapFBO.destroy(),delete this._heatmapFBO)}_createColorRamp(){const e=this._colorStops;let t=this._rampCanvas,n=this._rampCtx;n?n.clearRect(0,0,256,1):(t=this._rampCanvas=document.createElement("canvas"),t.width=256,t.height=1,n=this._rampCtx=t.getContext("2d"));const i=n.createLinearGradient(0,0,256,1);for(let t=0;t<e.length;t++)i.addColorStop(e[t][0],e[t][1]);n.fillStyle=i,n.fillRect(0,0,256,1),this._colorRampTex&&this._colorRampTex.destroy();this._colorRampTex=this.renderer.device.texture({width:256,height:1,data:t,min:"linear",mag:"linear",premultiplyAlpha:!0})}_check(){const e=this._layer.getRenderer().canvas,t=Math.ceil(e.width/4),n=Math.ceil(e.height/4),i=this._heatmapFBO;i.width===t&&i.height===n||i.resize(t,n)}_init(){this._createColorRamp(),this._createShader(),this._createHeatmapTex(),this._createGround()}_createGround(){const e=new Plane;e.generateBuffers(this.renderer.device),this._ground=new Mesh(e),this._groundScene=new Scene([this._ground])}_transformGround(){const e=this._layer.getMap(),t=GroundPainter.getGroundTransform(this._ground.localTransform,e);this._ground.setLocalTransform(t)}_createHeatmapTex(){const e=this._layer.getRenderer().canvas,t=this.renderer.device,n=t.hasExtension("OES_texture_half_float")?"half float":"float",i=Math.ceil(e.width/4),s=Math.ceil(e.height/4),o=t.texture({width:i,height:s,type:n,min:"linear",mag:"linear",format:"rgba"});this._heatmapFBO=t.framebuffer({width:i,height:s,color:[o]})}_createShader(){const e=this._layer.getRenderer().canvas,t=this.sceneConfig.depthRange,n={viewport:{x:0,y:0,width:()=>e?Math.ceil(e.width/4):1,height:()=>e?Math.ceil(e.height/4):1},depth:{enable:!0,func:"always"}};this._stencil&&(n.stencil=this._stencil),this._heatmapShader=new HeatmapShader({extraCommandProps:n}),this._displayShader=new HeatmapDisplayShader({x:0,y:0,width:()=>e?e.width:1,height:()=>e?e.height:1},{extraCommandProps:{depth:{enable:!0,range:t||[0,1],func:"<="},polygonOffset:{enable:!0,offset:this._polygonOffset}}})}}class ClipMask extends Mask{constructor(e,t){super(e,t)}_createMesh(e){const t=this._createGeometry(e),n=new Mesh(t);return this._setDefines(n),this._setLocalTransform(n),n}_updateUniforms(e,t,n){const i=this._getMaskMode();e.setUniform("maskMode",i);const s=this._getMaskColor();if(e.setUniform("maskColor",s),bC(t)){const i=this._getHeightRange();i[0]=(i[0]-n)*t,i[1]=(i[1]-n)*t,e.setUniform("heightRange",i)}}setHeightRange(e){this.options.heightRange=e,this._fireEvent("heightrangechange")}getHeightRange(){return this.options.heightRange}_getHeightRange(){const e=[0,0];return this.options.heightRange&&(e[0]=this._altitudeToPoint(this.options.heightRange[0]),e[1]=this._altitudeToPoint(this.options.heightRange[1])),e}_setDefines(e){const t=e.getDefines();t.HAS_MASK_COLOR=1,e.setDefines(t)}}class ClipOutsideMask extends ClipMask{constructor(e,t){super(e,t),this._mode="clip-outside"}}class FlatMask extends Mask{constructor(e,t){super(e,t)}setFlatheight(e){this.options.flatHeight=e,this._fireEvent("flatheightchange")}_createMesh(e){const t=this._createGeometry(e),n=new Mesh(t);return this._setDefines(n),this._setLocalTransform(n),n}_updateUniforms(e){const t=this._getMaskMode();e.setUniform("maskMode",t);const n=this._getMaskColor();e.setUniform("maskColor",n);const i=this._altitudeToPoint(this.options.flatHeight||0);e.setUniform("flatHeight",i)}_setDefines(e){const t=e.getDefines();t.HAS_MASK_FLAT=1,e.setDefines(t)}_getHeightRange(){const e=[0,this.options.flatHeight];return e[1]=this._altitudeToPoint(e[1]),e}}const uO=new Re(0,0),fO=new Re(0,0),dO=new Re(0,0),pO=new Re(0,0);class BoxClipMask extends ClipMask{constructor(e,t){super([],t),this._position=e}setPosition(e){this._position=e,this._updateCoordinates()}getPosition(){return this._position}setWidth(e){this.options.width=e,this._updateCoordinates()}setLength(e){this.options.length=e,this._updateCoordinates()}setHeight(e){this.options.height=e,this._updateCoordinates()}setRotation(e){this.options.rotation=e,this._updateCoordinates()}_updateCoordinates(){const e=this.getLayer();if(!e)return;const t=e.getMap();if(t){const{length:e,width:n,height:i}=this.options,s=this._position,o=this.options.rotation||0,{coordinates:a,heightRange:l}=this._generateCoordinates(t,s,e,n,i,o);this.setCoordinates(a),this.setHeightRange(l)}}_generateCoordinates(e,t,n,i,s,o){const a=e.getGLRes(),l=e.distanceToPointAtRes(i/2,0,a,uO),h=e.distanceToPointAtRes(0,n/2,a,fO),c=e.coordinateToPointAtRes(t,a,dO),u=c.x-l.x,f=c.x+l.x,g=c.y+h.y,m=c.y-h.y,A=this._rotatePoint([[u,g],[f,g],[f,m],[u,m]],c,o);pO.set(A[0][0],A[0][1]);const w=e.pointAtResToCoordinate(pO,a);pO.set(A[1][0],A[1][1]);const T=e.pointAtResToCoordinate(pO,a);pO.set(A[2][0],A[2][1]);const S=e.pointAtResToCoordinate(pO,a);pO.set(A[3][0],A[3][1]);const M=e.pointAtResToCoordinate(pO,a),C=t.z-s/2;return{coordinates:[[w.x,w.y,C],[T.x,T.y,C],[S.x,S.y,C],[M.x,M.y,C],[w.x,w.y,C]],heightRange:[C,t.z+s/2]}}_rotatePoint(e,t,n){for(let i=0;i<e.length;i++)K_(e[i],e[i],[t.x,t.y],n*Math.PI/180);return e}}class Measure3DTool extends od{constructor(e){super(e),this.on("enable",this._afterEnable,this),this.on("disable",this._afterDisable,this),this._drawCoordinates=[]}addTo(e){return e&&(super.addTo(e),this._map=e,this._addHelperLayer()),this}_addHelperLayer(){this._map.getLayer(vt+"drawtool").hide()}_afterEnable(){this.on("drawstart",this._msOnDrawStart,this).on("drawvertex",this._msOnDrawVertex,this).on("mousemove",this._msOnMouseMove,this).on("drawend",this._msOnDrawEnd,this)}_afterDisable(){this.off("drawstart",this._msOnDrawStart,this).off("drawvertex",this._msOnDrawVertex,this).off("mousemove",this._msOnMouseMove,this).off("drawend",this._msOnDrawEnd,this)}_getPickedCoordinate(e){const{coordinate:t,containerPoint:n}=e,i=this._map.getLayers((e=>e.queryTerrainAtPoint))[0];if(!i)return t.z=t.z||0,t;const s=i.identify(t,{includeInternals:!1})[0];let o=null;if(s&&s.coordinate?o=new fl(s.coordinate):(t.z=t.z||0,o=t),i.getTerrainLayer()){const e=i.queryTerrainAtPoint(n);return e&&e.z>o.z?e:o}return o}_msOnDrawStart(e){const t=this._getPickedCoordinate(e);t&&(this._first=!0,this._drawCoordinates.push(t),this._addHelperGeometry(t))}_msOnDrawVertex(e){const t=this._getPickedCoordinate(e);t&&(this._first=!0,this._drawCoordinates[this._drawCoordinates.length-1]=t,this._drawVertexMarker())}_msOnMouseMove(e){const t=this._getPickedCoordinate(e);t&&(this._first?this._drawCoordinates.push(t):this._drawCoordinates[this._drawCoordinates.length-1]=t,this._drawVertexMarker(),this._first=!1)}_msOnDrawEnd(e){const t=this._getPickedCoordinate(e);t&&(this._drawCoordinates.push(t),this._drawEnd())}_drawEnd(){this._drawVertexMarker(),this._drawCoordinates=[],this._helperGeometry=null,this._label=null}remove(){this._helperLayer&&this._helperLayer.remove(),this._markerLayer&&this._markerLayer.remove()}clear(){this._helperLayer&&this._helperLayer.clear(),this._markerLayer&&this._markerLayer.clear()}}Measure3DTool.mergeOptions({mode:"LineString",language:"zh-CN",metric:!0,imperial:!1,once:!0,symbol:{lineColor:"#e8542b",lineWidth:2,polygonFill:"#eee",polygonOpacity:.5},vertexSymbol:{markerType:"ellipse",markerFill:"#e8542b",markerLineColor:"#fff",markerLineWidth:2,markerWidth:10,markerHeight:10,markerDy:0},labelSymbol:{boxStyle:{padding:[15,6],verticalAlignment:"top",horizontalAlignment:"left",minWidth:150,minHeight:30,symbol:{markerType:"square",markerFill:"rgb(60, 60, 60)",markerFillOpacity:.8,markerLineColor:"#fff",markerLineWidth:2,textDx:-110}},textSymbol:{textFill:"#fff",textSize:16,textVerticalAlignment:"top"}}});const gO=[["直线距离","垂直高度","水平距离"],["spatial distance","vertical height","horizontal distance"]];const mO="${",AO=`function(t){\n/*!\n     * @maptalks/gltf-loader v0.103.0\n     * LICENSE : UNLICENSED\n     * (c) 2016-2025 maptalks.org\n     */\nvar r,e,i="undefined"!=typeof Float32Array?Float32Array:Array;function n(){var t=new i(3);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function s(t,r,e){var n=new i(3);return n[0]=t,n[1]=r,n[2]=e,n}function a(){var t=new i(4);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}Math.hypot||(Math.hypot=function(){for(var t=0,r=arguments.length;r--;)t+=arguments[r]*arguments[r];return Math.sqrt(t)}),n(),r=new i(4),i!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),n(),s(1,0,0),s(0,1,0),a(),a(),e=new i(9),i!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1;let o=0;!function(t){t[0]=0,t[1]=0,t[2]=0,t[3]=1}([]),"undefined"!=typeof TextDecoder&&new TextDecoder("utf-8");const h={get:function(t,r={},e){r||(r={});const i=new AbortController,n=i.signal,s=function(t){for(let r=1;r<arguments.length;r++){const e=arguments[r];for(const r in e)t[r]=e[r]}return t}({},r);s.signal=n,s.method||(s.method="GET"),s.referrerPolicy=s.referrerPolicy||"origin","undefined"==typeof window||s.referrer||(s.referrer=window.location.href),e&&(t=e(t));const a=fetch(t,s).then((t=>{const e=this.U(t,r.responseType);return e.message?e:e.then((e=>"arraybuffer"===r.responseType?{data:e,cacheControl:t.headers.get("Cache-Control"),expires:t.headers.get("Expires"),contentType:t.headers.get("Content-Type")}:e)).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}))})).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}));return a.xhr=i,a},U:(t,r)=>200!==t.status?{status:t.status,statusText:t.statusText,message:\`incorrect http request with status code(${mO}t.status}): ${mO}t.statusText}\`}:"arraybuffer"===r?t.arrayBuffer():"json"===r?t.json():t.text(),getArrayBuffer:(t,r={},e)=>(r||(r={}),r.responseType="arraybuffer",h.get(t,r,e)),getJSON:function(t,r={},e){return r&&r.jsonp?h.jsonp(t):((r=r||{}).responseType="json",h.get(t,r,e))},jsonp:function(t){const r="_maptalks_jsonp_"+o++;t.match(/\\?/)?t+="&callback="+r:t+="?callback="+r;let e=document.createElement("script");return e.type="text/javascript",e.src=t,new Promise((t=>{window[r]=function(i){document.getElementsByTagName("head")[0].removeChild(e),e=null,delete window[r],t(i)},document.getElementsByTagName("head")[0].appendChild(e)}))}};if("undefined"!=typeof TextDecoder&&new TextDecoder("utf-8"),"undefined"!=typeof OffscreenCanvas){let t;try{t=new OffscreenCanvas(2,2).getContext("2d")}catch(i){}}"undefined"!=typeof document&&document.createElement("canvas"),\n/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */function(){function t(t){throw t}var r=void 0,e=!0,i=this;function n(t,e){var n,s=t.split("."),a=i;!(s[0]in a)&&a.execScript&&a.execScript("var "+s[0]);for(;s.length&&(n=s.shift());)s.length||e===r?a=a[n]?a[n]:a[n]={}:a[n]=e}var s="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array&&"undefined"!=typeof DataView;function a(r,e){this.index="number"==typeof e?e:0,this.i=0,this.buffer=r instanceof(s?Uint8Array:Array)?r:new(s?Uint8Array:Array)(32768),2*this.buffer.length<=this.index&&t(Error("invalid index")),this.buffer.length<=this.index&&this.f()}a.prototype.f=function(){var t,r=this.buffer,e=r.length,i=new(s?Uint8Array:Array)(e<<1);if(s)i.set(r);else for(t=0;t<e;++t)i[t]=r[t];return this.buffer=i},a.prototype.d=function(t,r,e){var i,n=this.buffer,s=this.index,a=this.i,o=n[s];if(e&&1<r&&(t=8<r?(l[255&t]<<24|l[t>>>8&255]<<16|l[t>>>16&255]<<8|l[t>>>24&255])>>32-r:l[t]>>8-r),8>r+a)o=o<<r|t,a+=r;else for(i=0;i<r;++i)o=o<<1|t>>r-i-1&1,8==++a&&(a=0,n[s++]=l[o],o=0,s===n.length&&(n=this.f()));n[s]=o,this.buffer=n,this.i=a,this.index=s},a.prototype.finish=function(){var t,r=this.buffer,e=this.index;return 0<this.i&&(r[e]<<=8-this.i,r[e]=l[r[e]],e++),s?t=r.subarray(0,e):(r.length=e,t=r),t};var o,h=new(s?Uint8Array:Array)(256);for(o=0;256>o;++o){for(var c=u=o,f=7,u=u>>>1;u;u>>>=1)c<<=1,c|=1&u,--f;h[o]=(c<<f&255)>>>0}var l=h;function d(t){this.buffer=new(s?Uint16Array:Array)(2*t),this.length=0}function y(t){var r,e,i,n,a,o,h,c,f,u,l=t.length,d=0,y=Number.POSITIVE_INFINITY;for(c=0;c<l;++c)t[c]>d&&(d=t[c]),t[c]<y&&(y=t[c]);for(r=1<<d,e=new(s?Uint32Array:Array)(r),i=1,n=0,a=2;i<=d;){for(c=0;c<l;++c)if(t[c]===i){for(o=0,h=n,f=0;f<i;++f)o=o<<1|1&h,h>>=1;for(u=i<<16|c,f=o;f<r;f+=a)e[f]=u;++n}++i,n<<=1,a<<=1}return[e,d,y]}function w(t,r){this.h=v,this.w=0,this.input=s&&t instanceof Array?new Uint8Array(t):t,this.b=0,r&&(r.lazy&&(this.w=r.lazy),"number"==typeof r.compressionType&&(this.h=r.compressionType),r.outputBuffer&&(this.a=s&&r.outputBuffer instanceof Array?new Uint8Array(r.outputBuffer):r.outputBuffer),"number"==typeof r.outputIndex&&(this.b=r.outputIndex)),this.a||(this.a=new(s?Uint8Array:Array)(32768))}d.prototype.getParent=function(t){return 2*((t-2)/4|0)},d.prototype.push=function(t,r){var e,i,n,s=this.buffer;for(e=this.length,s[this.length++]=r,s[this.length++]=t;0<e&&(i=this.getParent(e),s[e]>s[i]);)n=s[e],s[e]=s[i],s[i]=n,n=s[e+1],s[e+1]=s[i+1],s[i+1]=n,e=i;return this.length},d.prototype.pop=function(){var t,r,e,i,n,s=this.buffer;for(r=s[0],t=s[1],this.length-=2,s[0]=s[this.length],s[1]=s[this.length+1],n=0;!((i=2*n+2)>=this.length)&&(i+2<this.length&&s[i+2]>s[i]&&(i+=2),s[i]>s[n]);)e=s[n],s[n]=s[i],s[i]=e,e=s[n+1],s[n+1]=s[i+1],s[i+1]=e,n=i;return{index:t,value:r,length:this.length}};var A,v=2,p={NONE:0,r:1,k:v,N:3},b=[];for(A=0;288>A;A++)switch(e){case 143>=A:b.push([A+48,8]);break;case 255>=A:b.push([A-144+400,9]);break;case 279>=A:b.push([A-256+0,7]);break;case 287>=A:b.push([A-280+192,8]);break;default:t("invalid literal: "+A)}function k(t,r){this.length=t,this.G=r}w.prototype.j=function(){var i,n,o,h,c=this.input;switch(this.h){case 0:for(o=0,h=c.length;o<h;){var f,u,l,d=n=s?c.subarray(o,o+65535):c.slice(o,o+65535),y=(o+=n.length)===h,w=r,A=r,p=this.a,k=this.b;if(s){for(p=new Uint8Array(this.a.buffer);p.length<=k+d.length+5;)p=new Uint8Array(p.length<<1);p.set(this.a)}if(f=y?1:0,p[k++]=0|f,l=65536+~(u=d.length)&65535,p[k++]=255&u,p[k++]=u>>>8&255,p[k++]=255&l,p[k++]=l>>>8&255,s)p.set(d,k),k+=d.length,p=p.subarray(0,k);else{for(w=0,A=d.length;w<A;++w)p[k++]=d[w];p.length=k}this.b=k,this.a=p}break;case 1:var m=new a(s?new Uint8Array(this.a.buffer):this.a,this.b);m.d(1,1,e),m.d(1,2,e);var g,x,S,T=U(this,c);for(g=0,x=T.length;g<x;g++)if(S=T[g],a.prototype.d.apply(m,b[S]),256<S)m.d(T[++g],T[++g],e),m.d(T[++g],5),m.d(T[++g],T[++g],e);else if(256===S)break;this.a=m.finish(),this.b=this.a.length;break;case v:var F,I,D,O,C,q,z,N,j,W,Z,H,V,$,_,B=new a(s?new Uint8Array(this.a.buffer):this.a,this.b),L=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],P=Array(19);for(F=v,B.d(1,1,e),B.d(F,2,e),I=U(this,c),z=E(q=M(this.L,15)),j=E(N=M(this.K,7)),D=286;257<D&&0===q[D-1];D--);for(O=30;1<O&&0===N[O-1];O--);var R,G,J,Y,K,X,Q=D,tt=O,rt=new(s?Uint32Array:Array)(Q+tt),et=new(s?Uint32Array:Array)(316),it=new(s?Uint8Array:Array)(19);for(R=G=0;R<Q;R++)rt[G++]=q[R];for(R=0;R<tt;R++)rt[G++]=N[R];if(!s)for(R=0,Y=it.length;R<Y;++R)it[R]=0;for(R=K=0,Y=rt.length;R<Y;R+=G){for(G=1;R+G<Y&&rt[R+G]===rt[R];++G);if(J=G,0===rt[R])if(3>J)for(;0<J--;)et[K++]=0,it[0]++;else for(;0<J;)(X=138>J?J:138)>J-3&&X<J&&(X=J-3),10>=X?(et[K++]=17,et[K++]=X-3,it[17]++):(et[K++]=18,et[K++]=X-11,it[18]++),J-=X;else if(et[K++]=rt[R],it[rt[R]]++,3>--J)for(;0<J--;)et[K++]=rt[R],it[rt[R]]++;else for(;0<J;)(X=6>J?J:6)>J-3&&X<J&&(X=J-3),et[K++]=16,et[K++]=X-3,it[16]++,J-=X}for(i=s?et.subarray(0,K):et.slice(0,K),W=M(it,7),$=0;19>$;$++)P[$]=W[L[$]];for(C=19;4<C&&0===P[C-1];C--);for(Z=E(W),B.d(D-257,5,e),B.d(O-1,5,e),B.d(C-4,4,e),$=0;$<C;$++)B.d(P[$],3,e);for($=0,_=i.length;$<_;$++)if(H=i[$],B.d(Z[H],W[H],e),16<=H){switch($++,H){case 16:V=2;break;case 17:V=3;break;case 18:V=7;break;default:t("invalid code: "+H)}B.d(i[$],V,e)}var nt,st,at,ot,ht,ct,ft,ut,lt=[z,q],dt=[j,N];for(ht=lt[0],ct=lt[1],ft=dt[0],ut=dt[1],nt=0,st=I.length;nt<st;++nt)if(at=I[nt],B.d(ht[at],ct[at],e),256<at)B.d(I[++nt],I[++nt],e),ot=I[++nt],B.d(ft[ot],ut[ot],e),B.d(I[++nt],I[++nt],e);else if(256===at)break;this.a=B.finish(),this.b=this.a.length;break;default:t("invalid compression type")}return this.a};var m=function(){function r(r){switch(e){case 3===r:return[257,r-3,0];case 4===r:return[258,r-4,0];case 5===r:return[259,r-5,0];case 6===r:return[260,r-6,0];case 7===r:return[261,r-7,0];case 8===r:return[262,r-8,0];case 9===r:return[263,r-9,0];case 10===r:return[264,r-10,0];case 12>=r:return[265,r-11,1];case 14>=r:return[266,r-13,1];case 16>=r:return[267,r-15,1];case 18>=r:return[268,r-17,1];case 22>=r:return[269,r-19,2];case 26>=r:return[270,r-23,2];case 30>=r:return[271,r-27,2];case 34>=r:return[272,r-31,2];case 42>=r:return[273,r-35,3];case 50>=r:return[274,r-43,3];case 58>=r:return[275,r-51,3];case 66>=r:return[276,r-59,3];case 82>=r:return[277,r-67,4];case 98>=r:return[278,r-83,4];case 114>=r:return[279,r-99,4];case 130>=r:return[280,r-115,4];case 162>=r:return[281,r-131,5];case 194>=r:return[282,r-163,5];case 226>=r:return[283,r-195,5];case 257>=r:return[284,r-227,5];case 258===r:return[285,r-258,0];default:t("invalid length: "+r)}}var i,n,s=[];for(i=3;258>=i;i++)n=r(i),s[i]=n[2]<<24|n[1]<<16|n[0];return s}(),g=s?new Uint32Array(m):m;function U(i,n){function a(r,i){var n,s,a,o,h=r.G,c=[],f=0;switch(n=g[r.length],c[f++]=65535&n,c[f++]=n>>16&255,c[f++]=n>>24,e){case 1===h:s=[0,h-1,0];break;case 2===h:s=[1,h-2,0];break;case 3===h:s=[2,h-3,0];break;case 4===h:s=[3,h-4,0];break;case 6>=h:s=[4,h-5,1];break;case 8>=h:s=[5,h-7,1];break;case 12>=h:s=[6,h-9,2];break;case 16>=h:s=[7,h-13,2];break;case 24>=h:s=[8,h-17,3];break;case 32>=h:s=[9,h-25,3];break;case 48>=h:s=[10,h-33,4];break;case 64>=h:s=[11,h-49,4];break;case 96>=h:s=[12,h-65,5];break;case 128>=h:s=[13,h-97,5];break;case 192>=h:s=[14,h-129,6];break;case 256>=h:s=[15,h-193,6];break;case 384>=h:s=[16,h-257,7];break;case 512>=h:s=[17,h-385,7];break;case 768>=h:s=[18,h-513,8];break;case 1024>=h:s=[19,h-769,8];break;case 1536>=h:s=[20,h-1025,9];break;case 2048>=h:s=[21,h-1537,9];break;case 3072>=h:s=[22,h-2049,10];break;case 4096>=h:s=[23,h-3073,10];break;case 6144>=h:s=[24,h-4097,11];break;case 8192>=h:s=[25,h-6145,11];break;case 12288>=h:s=[26,h-8193,12];break;case 16384>=h:s=[27,h-12289,12];break;case 24576>=h:s=[28,h-16385,13];break;case 32768>=h:s=[29,h-24577,13];break;default:t("invalid distance")}for(n=s,c[f++]=n[0],c[f++]=n[1],c[f++]=n[2],a=0,o=c.length;a<o;++a)v[p++]=c[a];k[c[0]]++,m[c[3]]++,b=r.length+i-1,y=null}var o,h,c,f,u,l,d,y,w,A={},v=s?new Uint16Array(2*n.length):[],p=0,b=0,k=new(s?Uint32Array:Array)(286),m=new(s?Uint32Array:Array)(30),U=i.w;if(!s){for(c=0;285>=c;)k[c++]=0;for(c=0;29>=c;)m[c++]=0}for(k[256]=1,o=0,h=n.length;o<h;++o){for(c=u=0,f=3;c<f&&o+c!==h;++c)u=u<<8|n[o+c];if(A[u]===r&&(A[u]=[]),l=A[u],!(0<b--)){for(;0<l.length&&32768<o-l[0];)l.shift();if(o+3>=h){for(y&&a(y,-1),c=0,f=h-o;c<f;++c)w=n[o+c],v[p++]=w,++k[w];break}0<l.length?(d=x(n,o,l),y?y.length<d.length?(w=n[o-1],v[p++]=w,++k[w],a(d,0)):a(y,-1):d.length<U?y=d:a(d,0)):y?a(y,-1):(w=n[o],v[p++]=w,++k[w])}l.push(o)}return v[p++]=256,k[256]++,i.L=k,i.K=m,s?v.subarray(0,p):v}function x(t,r,e){var i,n,s,a,o,h,c=0,f=t.length;a=0,h=e.length;t:for(;a<h;a++){if(i=e[h-a-1],s=3,3<c){for(o=c;3<o;o--)if(t[i+o-1]!==t[r+o-1])continue t;s=c}for(;258>s&&r+s<f&&t[i+s]===t[r+s];)++s;if(s>c&&(n=i,c=s),258===s)break}return new k(c,r-n)}function M(t,r){var e,i,n,a,o,h=t.length,c=new d(572),f=new(s?Uint8Array:Array)(h);if(!s)for(a=0;a<h;a++)f[a]=0;for(a=0;a<h;++a)0<t[a]&&c.push(a,t[a]);if(e=Array(c.length/2),i=new(s?Uint32Array:Array)(c.length/2),1===e.length)return f[c.pop().index]=1,f;for(a=0,o=c.length/2;a<o;++a)e[a]=c.pop(),i[a]=e[a].value;for(n=function(t,r,e){function i(t){var e=y[t][w[t]];e===r?(i(t+1),i(t+1)):--l[e],++w[t]}var n,a,o,h,c,f=new(s?Uint16Array:Array)(e),u=new(s?Uint8Array:Array)(e),l=new(s?Uint8Array:Array)(r),d=Array(e),y=Array(e),w=Array(e),A=(1<<e)-r,v=1<<e-1;for(f[e-1]=r,a=0;a<e;++a)A<v?u[a]=0:(u[a]=1,A-=v),A<<=1,f[e-2-a]=(f[e-1-a]/2|0)+r;for(f[0]=u[0],d[0]=Array(f[0]),y[0]=Array(f[0]),a=1;a<e;++a)f[a]>2*f[a-1]+u[a]&&(f[a]=2*f[a-1]+u[a]),d[a]=Array(f[a]),y[a]=Array(f[a]);for(n=0;n<r;++n)l[n]=e;for(o=0;o<f[e-1];++o)d[e-1][o]=t[o],y[e-1][o]=o;for(n=0;n<e;++n)w[n]=0;for(1===u[e-1]&&(--l[0],++w[e-1]),a=e-2;0<=a;--a){for(h=n=0,c=w[a+1],o=0;o<f[a];o++)(h=d[a+1][c]+d[a+1][c+1])>t[n]?(d[a][o]=h,y[a][o]=r,c+=2):(d[a][o]=t[n],y[a][o]=n,++n);w[a]=0,1===u[a]&&i(a)}return l}(i,i.length,r),a=0,o=e.length;a<o;++a)f[e[a].index]=n[a];return f}function E(t){var r,e,i,n,a=new(s?Uint16Array:Array)(t.length),o=[],h=[],c=0;for(r=0,e=t.length;r<e;r++)o[t[r]]=1+(0|o[t[r]]);for(r=1,e=16;r<=e;r++)h[r]=c,c+=0|o[r],c<<=1;for(r=0,e=t.length;r<e;r++)for(c=h[t[r]],h[t[r]]+=1,i=a[r]=0,n=t[r];i<n;i++)a[r]=a[r]<<1|1&c,c>>>=1;return a}function S(r,e){switch(this.l=[],this.m=32768,this.e=this.g=this.c=this.q=0,this.input=s?new Uint8Array(r):r,this.s=!1,this.n=F,this.B=!1,!e&&(e={})||(e.index&&(this.c=e.index),e.bufferSize&&(this.m=e.bufferSize),e.bufferType&&(this.n=e.bufferType),e.resize&&(this.B=e.resize)),this.n){case T:this.b=32768,this.a=new(s?Uint8Array:Array)(32768+this.m+258);break;case F:this.b=0,this.a=new(s?Uint8Array:Array)(this.m),this.f=this.J,this.t=this.H,this.o=this.I;break;default:t(Error("invalid inflate mode"))}}var T=0,F=1,I={D:T,C:F};S.prototype.p=function(){for(;!this.s;){var i=J(this,3);switch(1&i&&(this.s=e),i>>>=1){case 0:var n=this.input,a=this.c,o=this.a,h=this.b,c=n.length,f=r,u=o.length,l=r;switch(this.e=this.g=0,a+1>=c&&t(Error("invalid uncompressed block header: LEN")),f=n[a++]|n[a++]<<8,a+1>=c&&t(Error("invalid uncompressed block header: NLEN")),f===~(n[a++]|n[a++]<<8)&&t(Error("invalid uncompressed block header: length verify")),a+f>n.length&&t(Error("input buffer is broken")),this.n){case T:for(;h+f>o.length;){if(f-=l=u-h,s)o.set(n.subarray(a,a+l),h),h+=l,a+=l;else for(;l--;)o[h++]=n[a++];this.b=h,o=this.f(),h=this.b}break;case F:for(;h+f>o.length;)o=this.f({v:2});break;default:t(Error("invalid inflate mode"))}if(s)o.set(n.subarray(a,a+f),h),h+=f,a+=f;else for(;f--;)o[h++]=n[a++];this.c=a,this.b=h,this.a=o;break;case 1:this.o(P,G);break;case 2:var d,w,A,v,p=J(this,5)+257,b=J(this,5)+1,k=J(this,4)+4,m=new(s?Uint8Array:Array)(q.length),g=r,U=r,x=r,M=r,E=r;for(E=0;E<k;++E)m[q[E]]=J(this,3);if(!s)for(E=k,k=m.length;E<k;++E)m[q[E]]=0;for(d=y(m),g=new(s?Uint8Array:Array)(p+b),E=0,v=p+b;E<v;)switch(U=Y(this,d),U){case 16:for(M=3+J(this,2);M--;)g[E++]=x;break;case 17:for(M=3+J(this,3);M--;)g[E++]=0;x=0;break;case 18:for(M=11+J(this,7);M--;)g[E++]=0;x=0;break;default:x=g[E++]=U}w=y(s?g.subarray(0,p):g.slice(0,p)),A=y(s?g.subarray(p):g.slice(p)),this.o(w,A);break;default:t(Error("unknown BTYPE: "+i))}}return this.t()};var D,O,C=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],q=s?new Uint16Array(C):C,z=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],N=s?new Uint16Array(z):z,j=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],W=s?new Uint8Array(j):j,Z=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],H=s?new Uint16Array(Z):Z,V=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],$=s?new Uint8Array(V):V,_=new(s?Uint8Array:Array)(288);for(D=0,O=_.length;D<O;++D)_[D]=143>=D?8:255>=D?9:279>=D?7:8;var B,L,P=y(_),R=new(s?Uint8Array:Array)(30);for(B=0,L=R.length;B<L;++B)R[B]=5;var G=y(R);function J(r,e){for(var i,n=r.g,s=r.e,a=r.input,o=r.c,h=a.length;s<e;)o>=h&&t(Error("input buffer is broken")),n|=a[o++]<<s,s+=8;return i=n&(1<<e)-1,r.g=n>>>e,r.e=s-e,r.c=o,i}function Y(r,e){for(var i,n,s=r.g,a=r.e,o=r.input,h=r.c,c=o.length,f=e[0],u=e[1];a<u&&!(h>=c);)s|=o[h++]<<a,a+=8;return(n=(i=f[s&(1<<u)-1])>>>16)>a&&t(Error("invalid code length: "+n)),r.g=s>>n,r.e=a-n,r.c=h,65535&i}function K(t){if("string"==typeof t){var r,e,i=t.split("");for(r=0,e=i.length;r<e;r++)i[r]=(255&i[r].charCodeAt(0))>>>0;t=i}for(var n,s=1,a=0,o=t.length,h=0;0<o;){o-=n=1024<o?1024:o;do{a+=s+=t[h++]}while(--n);s%=65521,a%=65521}return(a<<16|s)>>>0}function X(r,e){var i,n;if(this.input=r,this.c=0,!e&&(e={})||(e.index&&(this.c=e.index),e.verify&&(this.M=e.verify)),i=r[this.c++],n=r[this.c++],(15&i)===Q)this.method=Q;else t(Error("unsupported compression method"));0!=((i<<8)+n)%31&&t(Error("invalid fcheck flag:"+((i<<8)+n)%31)),32&n&&t(Error("fdict flag is not supported")),this.A=new S(r,{index:this.c,bufferSize:e.bufferSize,bufferType:e.bufferType,resize:e.resize})}S.prototype.o=function(t,r){var e=this.a,i=this.b;this.u=t;for(var n,s,a,o,h=e.length-258;256!==(n=Y(this,t));)if(256>n)i>=h&&(this.b=i,e=this.f(),i=this.b),e[i++]=n;else for(o=N[s=n-257],0<W[s]&&(o+=J(this,W[s])),n=Y(this,r),a=H[n],0<$[n]&&(a+=J(this,$[n])),i>=h&&(this.b=i,e=this.f(),i=this.b);o--;)e[i]=e[i++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=i},S.prototype.I=function(t,r){var e=this.a,i=this.b;this.u=t;for(var n,s,a,o,h=e.length;256!==(n=Y(this,t));)if(256>n)i>=h&&(h=(e=this.f()).length),e[i++]=n;else for(o=N[s=n-257],0<W[s]&&(o+=J(this,W[s])),n=Y(this,r),a=H[n],0<$[n]&&(a+=J(this,$[n])),i+o>h&&(h=(e=this.f()).length);o--;)e[i]=e[i++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=i},S.prototype.f=function(){var t,r,e=new(s?Uint8Array:Array)(this.b-32768),i=this.b-32768,n=this.a;if(s)e.set(n.subarray(32768,e.length));else for(t=0,r=e.length;t<r;++t)e[t]=n[t+32768];if(this.l.push(e),this.q+=e.length,s)n.set(n.subarray(i,i+32768));else for(t=0;32768>t;++t)n[t]=n[i+t];return this.b=32768,n},S.prototype.J=function(t){var r,e,i,n=this.input.length/this.c+1|0,a=this.input,o=this.a;return t&&("number"==typeof t.v&&(n=t.v),"number"==typeof t.F&&(n+=t.F)),2>n?e=(i=(a.length-this.c)/this.u[2]/2*258|0)<o.length?o.length+i:o.length<<1:e=o.length*n,s?(r=new Uint8Array(e)).set(o):r=o,this.a=r},S.prototype.t=function(){var t,r,e,i,n,a=0,o=this.a,h=this.l,c=new(s?Uint8Array:Array)(this.q+(this.b-32768));if(0===h.length)return s?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);for(r=0,e=h.length;r<e;++r)for(i=0,n=(t=h[r]).length;i<n;++i)c[a++]=t[i];for(r=32768,e=this.b;r<e;++r)c[a++]=o[r];return this.l=[],this.buffer=c},S.prototype.H=function(){var t,r=this.b;return s?this.B?(t=new Uint8Array(r)).set(this.a.subarray(0,r)):t=this.a.subarray(0,r):(this.a.length>r&&(this.a.length=r),t=this.a),this.buffer=t},X.prototype.p=function(){var r,e=this.input;return r=this.A.p(),this.c=this.A.c,this.M&&((e[this.c++]<<24|e[this.c++]<<16|e[this.c++]<<8|e[this.c++])>>>0!==K(r)&&t(Error("invalid adler-32 checksum"))),r};var Q=8;function tt(t,r){this.input=t,this.a=new(s?Uint8Array:Array)(32768),this.h=rt.k;var e,i={};for(e in!r&&(r={})||"number"!=typeof r.compressionType||(this.h=r.compressionType),r)i[e]=r[e];i.outputBuffer=this.a,this.z=new w(this.input,i)}var rt=p;function et(t,r){var e,i,s,a;if(Object.keys)e=Object.keys(r);else for(i in e=[],s=0,r)e[s++]=i;for(s=0,a=e.length;s<a;++s)n(t+"."+(i=e[s]),r[i])}tt.prototype.j=function(){var r,e,i,n,a,o,h,c=0;if(h=this.a,(r=Q)===Q)e=Math.LOG2E*Math.log(32768)-8;else t(Error("invalid compression method"));if(i=e<<4|r,h[c++]=i,r===Q)switch(this.h){case rt.NONE:a=0;break;case rt.r:a=1;break;case rt.k:a=2;break;default:t(Error("unsupported compression type"))}else t(Error("invalid compression method"));return n=a<<6,h[c++]=n|31-(256*i+n)%31,o=K(this.input),this.z.b=c,c=(h=this.z.j()).length,s&&((h=new Uint8Array(h.buffer)).length<=c+4&&(this.a=new Uint8Array(h.length+4),this.a.set(h),h=this.a),h=h.subarray(0,c+4)),h[c++]=o>>24&255,h[c++]=o>>16&255,h[c++]=o>>8&255,h[c++]=255&o,h},n("Zlib.Inflate",X),n("Zlib.Inflate.prototype.decompress",X.prototype.p),et("Zlib.Inflate.BufferType",{ADAPTIVE:I.C,BLOCK:I.D}),n("Zlib.Deflate",tt),n("Zlib.Deflate.compress",(function(t,r){return new tt(t,r).j()})),n("Zlib.Deflate.prototype.compress",tt.prototype.j),et("Zlib.Deflate.CompressionType",{NONE:rt.NONE,FIXED:rt.r,DYNAMIC:rt.k})}.call(self);var c="undefined"!=typeof Float32Array?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var t=0,r=arguments.length;r--;)t+=arguments[r]*arguments[r];return Math.sqrt(t)});var f,u=function(t,r,e){return t[0]=r[0]-e[0],t[1]=r[1]-e[1],t[2]=r[2]-e[2],t};function l(t,r,e){return t[0]=r,t[1]=e,t}f=new c(3),c!=Float32Array&&(f[0]=0,f[1]=0,f[2]=0),function(){var t=function(){var t=new c(2);return c!=Float32Array&&(t[0]=0,t[1]=0),t}()}();class d{constructor(t=257){this.gridSize=t;const r=t-1;if(r&r-1)throw new Error(\`Expected grid size to be 2^n+1, got ${mO}t}.\`);this.numTriangles=r*r*2-2,this.numParentTriangles=this.numTriangles-r*r,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(4*this.numTriangles);for(let t=0;t<this.numTriangles;t++){let e=t+2,i=0,n=0,s=0,a=0,o=0,h=0;for(1&e?s=a=o=r:i=n=h=r;(e>>=1)>1;){const t=i+s>>1,r=n+a>>1;1&e?(s=i,a=n,i=o,n=h):(i=s,n=a,s=o,a=h),o=t,h=r}const c=4*t;this.coords[c+0]=i,this.coords[c+1]=n,this.coords[c+2]=s,this.coords[c+3]=a}}createTile(t){return new y(t,this)}}class y{constructor(t,r){const e=r.gridSize;if(t.length!==e*e)throw new Error(\`Expected terrain data of length ${mO}e*e} (${mO}e} x ${mO}e}), got ${mO}t.length}.\`);this.terrain=t,this.martini=r,this.errors=new Float32Array(t.length),this.update()}update(){const{numTriangles:t,numParentTriangles:r,coords:e,gridSize:i}=this.martini,{terrain:n,errors:s}=this;for(let a=t-1;a>=0;a--){const t=4*a,o=e[t+0],h=e[t+1],c=e[t+2],f=e[t+3],u=o+c>>1,l=h+f>>1,d=u+l-h,y=l+o-u,w=(n[h*i+o]+n[f*i+c])/2,A=l*i+u,v=Math.abs(w-n[A]);if(s[A]=Math.max(s[A],v),a<r){const t=(h+y>>1)*i+(o+d>>1),r=(f+y>>1)*i+(c+d>>1);s[A]=Math.max(s[A],s[t],s[r])}}}getMesh(t=0){const{gridSize:r,indices:e}=this.martini,{errors:i}=this;let n=0,s=0;const a=r-1;function o(a,h,c,f,u,l){const d=a+c>>1,y=h+f>>1;Math.abs(a-u)+Math.abs(h-l)>1&&i[y*r+d]>t?(o(u,l,a,h,d,y),o(c,f,u,l,d,y)):(e[h*r+a]=e[h*r+a]||++n,e[f*r+c]=e[f*r+c]||++n,e[l*r+u]=e[l*r+u]||++n,s++)}e.fill(0),o(0,0,a,a,a,0),o(a,a,0,0,0,a);const h=new Uint16Array(2*n),c=new Uint32Array(3*s);let f=0;function u(n,s,a,o,l,d){const y=n+a>>1,w=s+o>>1;if(Math.abs(n-l)+Math.abs(s-d)>1&&i[w*r+y]>t)u(l,d,n,s,y,w),u(a,o,l,d,y,w);else{const t=e[s*r+n]-1,i=e[o*r+a]-1,u=e[d*r+l]-1;h[2*t]=n,h[2*t+1]=s,h[2*i]=a,h[2*i+1]=o,h[2*u]=l,h[2*u+1]=d,c[f++]=t,c[f++]=i,c[f++]=u}}return u(0,0,a,a,a,0),u(a,a,0,0,0,a),{vertices:h,triangles:c}}getMeshWithSkirts(t=0,r){const{gridSize:e,indices:i}=this.martini,{errors:n}=this;let s=0,a=0;const o=e-1;let h,c,f=0;const u=[],l=[],d=[],y=[];function w(r,A,v,p,b,k){const m=r+v>>1,g=A+p>>1;Math.abs(r-b)+Math.abs(A-k)>1&&n[g*e+m]>t?(w(b,k,r,A,m,g),w(v,p,b,k,m,g)):(h=A*e+r,c=p*e+v,f=k*e+b,0===i[h]&&(0===r?u.push(s):r===o&&l.push(s),0===A?d.push(s):A===o&&y.push(s),i[h]=++s),0===i[c]&&(0===v?u.push(s):v===o&&l.push(s),0===p?d.push(s):p===o&&y.push(s),i[c]=++s),0===i[f]&&(0===b?u.push(s):b===o&&l.push(s),0===k?d.push(s):k===o&&y.push(s),i[f]=++s),a++)}let A;i.fill(0),w(0,0,o,o,o,0),w(o,o,0,0,0,o),A=r?2*(s+3*u.length-2+3*l.length-2+3*d.length-2+3*y.length-2):2*(s+u.length+l.length+d.length+y.length);const v=3*(a+2*(u.length-1)+2*(l.length-1)+2*(d.length-1)+2*(y.length-1)),p=new Uint16Array(A),b=new Uint32Array(v);let k=0;function m(r,s,a,o,h,c){const f=r+a>>1,u=s+o>>1;if(Math.abs(r-h)+Math.abs(s-c)>1&&n[u*e+f]>t)m(h,c,r,s,f,u),m(a,o,h,c,f,u);else{const t=i[s*e+r]-1,n=i[o*e+a]-1,f=i[c*e+h]-1;p[2*t]=r,p[2*t+1]=s,p[2*n]=a,p[2*n+1]=o,p[2*f]=h,p[2*f+1]=c,b[k++]=t,b[k++]=n,b[k++]=f}}m(0,0,o,o,o,0),m(o,o,0,0,0,o),u.sort(((t,r)=>p[2*t+1]-p[2*r+1])),l.sort(((t,r)=>p[2*r+1]-p[2*t+1])),d.sort(((t,r)=>p[2*r]-p[2*t])),y.sort(((t,r)=>p[2*t]-p[2*r]));let g,U,x,M,E=2*s,S=0;function T(t){S=t.length;for(let e=0;e<S-1;e++)g=t[e],U=t[e+1],x=E/2,M=(E+(r?6:2))/2,p[E++]=2*g,p[E++]=2*g+1,r&&(p[E++]=2*g,p[E++]=2*g+1,p[E++]=2*U,p[E++]=2*U+1),r?(b[k++]=x+1,b[k++]=x,b[k++]=x+2,b[k++]=x,b[k++]=M,b[k++]=x+2):(b[k++]=g,b[k++]=x,b[k++]=U,b[k++]=x,b[k++]=M,b[k++]=U);p[E++]=2*t[S-1],p[E++]=2*t[S-1]+1}T(u);const F=E;T(l);const I=E;T(d);const D=E;T(y);return{vertices:p,triangles:b,numVerticesWithoutSkirts:s,numTrianglesWithoutSkirts:a,leftSkirtIndex:F,rightSkirtIndex:I,bottomSkirtIndex:D,topSkirtIndex:E}}}const w={};let A;const v={width:100,height:10};let p,b=!1;try{const t=new OffscreenCanvas(1,1);t.getContext("2d").fillText("hello",0,0),b=!0}catch(t){b=!1}function k(){if(!A){const{width:t,height:r}=v;b?A=new OffscreenCanvas(t,r):(A=document.createElement("canvas"),A.width=t,A.height=r)}return A}class m{constructor(t,r={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let e=1/0,i=-1/0;for(let r=0,n=t.length;r<n;r++){const n=t[r][0];e=Math.min(n,e),i=Math.max(n,i)}this.min=e,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},v,r),this.S()}getImageData(){return this.imgData}S(){const t=k(),{width:r,height:e}=this.options;t.width=r,t.height=e;const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);const n=i.createLinearGradient(0,0,t.width,0),{colors:s,valueOffset:a}=this;for(let t=0,r=s.length;t<r;t++){const[r,e]=s[t],i=(r-this.min)/a;n.addColorStop(i,e)}i.fillStyle=n,i.fillRect(0,0,t.width,t.height),this.imgData=i.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t);const r=((t=Math.min(t,this.max))-this.min)/this.valueOffset;let e=Math.round(r*this.imgData.width);e=Math.min(e,this.imgData.width-1);const i=4*e;return[this.imgData.data[i],this.imgData.data[i+1],this.imgData.data[i+2],this.imgData.data[i+3]]}}let g=null,U=null;const x=[0,0,0],M=[256,256];function E(){try{g||(g=new OffscreenCanvas(1,1))}catch(t){console.error(t)}}const S={},T={},F={width:64,height:64,elementsPerHeight:3,heightOffset:-1e3,exaggeration:1,heightScale:.001,elementMultiplier:256,stride:4,skirtHeight:.002,skirtOffset:.01},I={cesium_request_token:{Accept:"application/json,*/*;q=0.01","Accept-Encoding":"gzip, deflate, br"},tianditu:{"Accept-Encoding":"gzip, deflate, br"},cesium:{"Accept-Encoding":"gzip, deflate, br",Accept:"application/vnd.quantized-mesh,application/octet-stream;q=0.9,*/*;q=0.01"},mapbox:{Accept:"image/webp,*/*"}};I["cesium-ion"]=I.cesium;const D=32767;let O=null,C=null;function q(t,r){const e=function(t){if(t.length<1e3)return null;const r=new Zlib.Inflate(t);return r?r.decompress():null}(new Uint8Array(t));if(!e)throw new Error((i=new Uint8Array(t),z.decode(i)));var i;const n=function(t){const r=t,e=F.width,i=F.height,n=new Uint8Array(e*i*F.stride);let s,a,o,h,c;for(let t=0;t<i;t++)for(let f=0;f<e;f++){h=parseInt(149*t/(i-1)),c=parseInt(149*f/(e-1)),a=2*(150*h+c),s=r[a]+256*r[a+1],(s>1e4||s<-2e3)&&(s=0),o=4*(t*e+f);const u=(s+1e3)/F.heightScale,l=F.elementMultiplier;n[o]=u/(l*l),n[o+1]=(u-n[o]*l*l)/l,n[o+2]=u-n[o]*l*l-n[o+1]*l,n[o+3]=255}return n}(e),s=function(t,r){const e=r,i=r,n=e+1,s=i+1,a=F.elementsPerHeight,o=F.heightOffset,h=F.heightScale,c=F.elementMultiplier,f=F.skirtHeight,u=new Float32Array(n*s);let l=0,d=1/0,y=-1/0;for(let r=0;r<n;r++){const n=r>=i?i-1:r;for(let r=0;r<s;r++){let i=0;const s=n*(4*e)+4*(r>=e?e-1:r);for(let r=0;r<a;r++)i=i*c+t[s+r];i=1*(i*h+o),i-=f,u[l]=i,i<d&&(d=i),i>y&&(y=i),l++}}return{data:u,min:d,max:y}}(n,r-1);return s.width=s.height=r,s}const z=new TextDecoder("utf-8");function N(t){return t>>1^-(1&t)}const j=[];function W(t){let r=0;const e=3*Float64Array.BYTES_PER_ELEMENT,i=3*Uint16Array.BYTES_PER_ELEMENT;let n=Uint16Array.BYTES_PER_ELEMENT;const s=new DataView(t);r+=e;const a=s.getFloat32(r,!0);r+=Float32Array.BYTES_PER_ELEMENT;const o=s.getFloat32(r,!0);r+=Float32Array.BYTES_PER_ELEMENT,r+=e;const h=s.getFloat64(r,!0);r+=Float64Array.BYTES_PER_ELEMENT,r+=e;const c=s.getUint32(r,!0);r+=Uint32Array.BYTES_PER_ELEMENT;const f=new Uint16Array(t,r,3*c);r+=c*i,c>65536&&(n=Uint32Array.BYTES_PER_ELEMENT);!function(t,r,e){const i=t.length;let n=0,s=0,a=0;for(let o=0;o<i;++o)n+=N(t[o]),s+=N(r[o]),t[o]=n,r[o]=s,e&&(a+=N(e[o]),e[o]=a)}(f.subarray(0,c),f.subarray(c,2*c),f.subarray(2*c,3*c)),r%n!=0&&(r+=n-r%n);const u=s.getUint32(r,!0);r+=Uint32Array.BYTES_PER_ELEMENT;const l=c>65536?new Uint32Array(t,r,3*u):new Uint16Array(t,r,3*u);let d=0;const y=l.length;for(let t=0;t<y;++t){const r=l[t];l[t]=d-r,0===r&&++d}const w={minimumHeight:a,maximumHeight:o,quantizedVertices:f,indices:l}.quantizedVertices,A=w.length/3,v=w.subarray(0,A),p=w.subarray(A,2*A),b=w.subarray(2*A,3*A),k=j;for(let t=0;t<A;++t){const r=v[t],e=p[t],i=r/D,n=e/D,s=(m=a,g=o,(1-(U=b[t]/D))*m+U*g);k[3*t]=i,k[3*t+1]=1-n,k[3*t+2]=s}var m,g,U;return{positions:k,radius:h,min:a,max:o,indices:l}}const Z=[],H=[],V=[],$=[],_=[];class B{constructor(t,r,e,i,n){this.p0=[],this.p1=[],this.p2=[],this.normal=[],this.min=[],this.max=[],this.set(t,r,e,i,n)}set(t,r,e,i,n){this.radius=n;let s=3*r,a=3*r+1,o=3*r+2;this.p0[0]=t[s]*n,this.p0[1]=t[a]*n,this.p0[2]=t[o],s=3*e,a=3*e+1,o=3*e+2,this.p1[0]=t[s]*n,this.p1[1]=t[a]*n,this.p1[2]=t[o],s=3*i,a=3*i+1,o=3*i+2,this.p2[0]=t[s]*n,this.p2[1]=t[a]*n,this.p2[2]=t[o],this.min[0]=Math.min(this.p0[0],this.p1[0],this.p2[0]),this.min[1]=Math.min(this.p0[1],this.p1[1],this.p2[1]),this.max[0]=Math.max(this.p0[0],this.p1[0],this.p2[0]),this.max[1]=Math.max(this.p0[1],this.p1[1],this.p2[1]);const h=u(Z,this.p1,this.p0),c=u(H,this.p2,this.p1);this.normal=function(t,r){var e=r[0],i=r[1],n=r[2],s=e*e+i*i+n*n;return s>0&&(s=1/Math.sqrt(s)),t[0]=r[0]*s,t[1]=r[1]*s,t[2]=r[2]*s,t}(this.normal,function(t,r,e){var i=r[0],n=r[1],s=r[2],a=e[0],o=e[1],h=e[2];return t[0]=n*h-s*o,t[1]=s*a-i*h,t[2]=i*o-n*a,t}(this.normal,h,c))}contains(t,r){if(t<this.min[0]||t>this.max[0]||r<this.min[1]||r>this.max[1])return!1;l(V,this.p0[0],this.p0[1]),l($,this.p1[0],this.p1[1]),l(_,this.p2[0],this.p2[1]);const e=G(V[0],V[1],$[0],$[1],_[0],_[1]);return G(t,r,V[0],V[1],_[0],_[1])+G(t,r,V[0],V[1],$[0],$[1])+G(t,r,$[0],$[1],_[0],_[1])-e<=1e-4}getHeight(t,r){const e=this.normal;return this.p0[2]-((t-this.p0[0])*e[0]+(r-this.p0[1])*e[1])/e[2]}}let L=null;function P(t,r,e){if(L&&L.contains(r,e))return L.getHeight(r,e);for(let i=0;i<t.length;i++)if(t[i].contains(r,e))return L=t[i],t[i].getHeight(r,e);return 0}const R=[];function G(t,r,e,i,n,s){return.5*Math.abs(t*i+e*s+n*r-t*s-e*r-n*i)}function J(t,r,e,i,n,s){"cesium-ion"===e&&(r.Authorization="Bearer "+O),function(t,r,e){const i={method:"GET",referrer:e,headers:r},n=h.getArrayBuffer(t,i),s=n.xhr;return T[t]=s,n.then((r=>(delete T[t],r)))}(t,r,origin).then((t=>{if(!t||t.message)s(t?{empty:!0,originalError:t}:{error:{canceled:!0}});else{const r=t.data;let a=null;if("tianditu"===e){const t=q(r,i);K(n,t,i,null,!0,s)}else if("cesium-ion"===e||"cesium"===e){a=W(r);const t=function(t,r){const{positions:e,min:i,max:n,indices:s,radius:a}=t,o=[];let h=0;for(let t=0;t<s.length;t+=3){let r=R[h];r?r.set(e,s[t],s[t+1],s[t+2],2*a):r=R[h]=new B(e,s[t],s[t+1],s[t+2],2*a),h++,o.push(r)}const c=new Float32Array(r*r);h=0;for(let t=0;t<r;t++)for(let e=0;e<r;e++)c[h++]=P(o,e/r*a*2,t/r*a*2);return{data:c,min:i,max:n,width:r,height:r}}(a,i);K(n,t,i,null,!0,s)}else"mapbox"===e&&(a=function(t){const r=new self.Blob([new Uint8Array(t)]);return self.createImageBitmap(r)}(r),a.then((t=>{const r=Q(X(t),i);K(n,r,i,t,!0,s)})))}})).catch((r=>{delete T[t],s({empty:!0,originalError:r})}))}function Y(t,r){const e=Math.floor(10*(t+1e4)),i=e>>16,n=e>>8&255,s=255&e;return r?(r[0]=i,r[1]=n,r[2]=s,r):[i,n,s]}function K(t,r,e,i,n,s){const a=function(t,r,e){let i=w[e];i||(i=w[e]=new d(e));const n=i.createTile(r).getMeshWithSkirts(t,!0),{triangles:s,vertices:a,leftSkirtIndex:o,rightSkirtIndex:h,bottomSkirtIndex:c,topSkirtIndex:f}=n;let{numVerticesWithoutSkirts:u,numTrianglesWithoutSkirts:l}=n;u||(u=a.length/2,l=s.length/3);const y=a.length/2,A=new Float32Array(3*y),v=new Float32Array(2*y);let p=1/0,b=-1/0;const k=e-1;for(let t=0;t<y;t++){const i=a[2*t],n=a[2*t+1];if(t>=u){const r=i/2*3;let e,n=.001;(t-(t<o/2?u:t<h/2?o/2:t<c/2?h/2:c/2))%3==0?(e=Math.min(0,p),n=0):e=A[r+2],A[3*t]=A[r],A[3*t+1]=A[r+1],A[3*t+2]=e,v[2*t]=A[r]/k+n,v[2*t+1]=-A[r+1]/k+n}else{const s=r[n*e+i];A[3*t]=1*i,A[3*t+1]=1*-n,A[3*t+2]=s,v[2*t]=i/k,v[2*t+1]=n/k,s<p&&(p=s),s>b&&(b=s)}}return{positions:A,texcoords:v,triangles:s,leftSkirtIndex:o,rightSkirtIndex:h,bottomSkirtIndex:c,topSkirtIndex:f,numTrianglesWithoutSkirts:l,numVerticesWithoutSkirts:u,minHeight:Math.min(0,p),maxHeight:b,terrainWidth:e}}(t/2,r.data,e),o=[a.positions.buffer,a.texcoords.buffer,a.triangles.buffer];i||(i=function(t){if(E(),!g)return;const{width:r,height:e,data:i}=t;if(r&&e&&i)try{let t=g.getContext("2d",{willReadFrequently:!0});const n=t.createImageData(r,e);for(let t=0,r=i.length;t<r;t++){const r=i[t],[e,s,a]=Y(r,x),o=4*t;n.data[o]=e,n.data[o+1]=s,n.data[o+2]=a,n.data[o+3]=255}return g.width=r,g.height=e,t=g.getContext("2d",{willReadFrequently:!0}),tt(t),t.putImageData(n,0,0),g.transferToImageBitmap()}catch(t){console.log(t)}}(r)),i&&o.push(i);const h={mesh:a};h.image=i,h.data=r,o.push(r.data.buffer),s(h,o)}function X(t){const{width:r,height:e}=t;return g||(g=new OffscreenCanvas(1,1),U=g.getContext("2d",{willReadFrequently:!0})),g.width=r,g.height=e,U.drawImage(t,0,0,r,e),U.getImageData(0,0,r,e)}function Q(t,r){const{data:e,width:i}=t;let n=1/0,s=-1/0;const a=new Float32Array(r*r),o=Math.round(i/r);for(let t=0;t<r;t++)for(let h=0;h<r;h++){const c=t+h*r;let f=0,u=0;const l=t,d=h;for(let t=0;t<o;t++)for(let r=0;r<o;r++){let n=l*o+t,s=d*o+r;s>i-1&&(s=i-1),n>i-1&&(n=i-1);const a=n+s*i,h=e[4*a],c=e[4*a+1],y=e[4*a+2];0===e[4*a+3]?u+=1:f+=.1*(256*h*256+256*c+y)-1e4}f/=o*o-u||1,f>s&&(s=f),f<n&&(n=f),a[c]=f}return{data:a,width:r,height:r,min:n,max:s}}function tt(t){const r=t.canvas,{width:e,height:i}=r;t.clearRect(0,0,e,i)}function rt(t,r,e){if(!r||!Array.isArray(r)||r.length<2)return;if(!t||!t.image)return null;let{width:i,height:n}=t.image;(e=e||M)[0]===i&&e[1]===n||(i=e[0],n=e[1]),i*=2,n*=2;try{if(E(),!g)return;const e=g;e.width=i,e.height=n;const s=e.getContext("2d",{willReadFrequently:!0});tt(s),s.drawImage(t.image,0,0,i,n);const a=s.getImageData(0,0,i,n);return function(t,r){const e=JSON.stringify(r);S[e]||(S[e]=new m(r));const i=S[e],n=t.data;for(let t=0,r=n.length;t<r;t+=4){const r=n[t],e=n[t+1],s=n[t+2];let a=0;0!==n[t+3]&&(a=.1*(256*r*256+256*e+s)-1e4,a=Math.max(a,0));const[o,h,c]=i.getColor(a);n[t]=o,n[t+1]=h,n[t+2]=c,n[t+3]=255}}(a,r),new Uint8Array(a.data)}catch(t){console.error(t)}}t.initialize=function(){},t.onmessage=function(t,r){const e=t.data;if("addLayer"===e.command||"removeLayer"===e.command)p=t.workerId,self.postMessage({type:"<response>",actorId:e.actorId,workerId:p,params:"ok",callback:t.callback});else if("fetchTerrain"===e.command){const t=(e.params||{}).colors,i=(e.params||{}).tileSize;!function(t,r){const{url:e,origin:i,type:n,accessToken:s,terrainWidth:a,error:o,tileImage:h}=t;if(h&&h.close){const t=Q(X(h),a);return void K(o,t,a,h,0,r)}const c=t.headers||I[n];if("tianditu"===n)J(e,c,n,a,o,r);else if("cesium-ion"===n){const h=t.cesiumIonTokenURL+s;O?J(e,c,n,a,o,r):(C||(C=fetch(h,{responseType:"json",method:"GET",referrer:i,headers:{Accept:"application/json,*/*;q=0.01","Accept-Encoding":"gzip, deflate, br"}}).then((t=>t.json())).then((t=>{O=t.accessToken,C=null}))),C.then((()=>{J(e,c,n,a,o,r)})))}else("cesium"===n||"mapbox"===n)&&J(e,c,n,a,o,r)}(e.params,((e,n)=>{const s=rt(e,t,i);s&&(e.colorsTexture=s,(n=n||[]).push(s.buffer)),r(e.error,e,n)}))}else"abortTerrain"===e.command&&(i=e.params.url,T[i]&&(T[i].abort(),delete T[i]));var i}}`;!function(e){ix().maptalks_gltf_loader_bundle=e}(ax),co("@maptalks/terrain",AO),"undefined"!=typeof console&&console.log("@maptalks/gl v0.110.0");var yO={exports:{}},_O={exports:{}},vO=function(e){return!(!e||"string"==typeof e)&&(e instanceof Array||Array.isArray(e)||e.length>=0&&(e.splice instanceof Function||Object.getOwnPropertyDescriptor(e,e.length-1)&&"String"!==e.constructor.name))},xO=Array.prototype.concat,bO=Array.prototype.slice,wO=_O.exports=function(e){for(var t=[],n=0,i=e.length;n<i;n++){var s=e[n];vO(s)?t=xO.call(t,bO.call(s)):t.push(s)}return t};wO.wrap=function(e){return function(){return e(wO(arguments))}};var TO={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},SO=_O.exports,MO=Object.hasOwnProperty,CO=Object.create(null);for(var PO in TO)MO.call(TO,PO)&&(CO[TO[PO]]=PO);var IO=yO.exports={to:{},get:{}};function kO(e,t,n){return Math.min(Math.max(t,e),n)}function OO(e){var t=Math.round(e).toString(16).toUpperCase();return t.length<2?"0"+t:t}IO.get=function(e){var t,n;switch(e.substring(0,3).toLowerCase()){case"hsl":t=IO.get.hsl(e),n="hsl";break;case"hwb":t=IO.get.hwb(e),n="hwb";break;default:t=IO.get.rgb(e),n="rgb"}return t?{model:n,value:t}:null},IO.get.rgb=function(e){if(!e)return null;var t,n,i,s=[0,0,0,1];if(t=e.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(i=t[2],t=t[1],n=0;n<3;n++){var o=2*n;s[n]=parseInt(t.slice(o,o+2),16)}i&&(s[3]=parseInt(i,16)/255)}else if(t=e.match(/^#([a-f0-9]{3,4})$/i)){for(i=(t=t[1])[3],n=0;n<3;n++)s[n]=parseInt(t[n]+t[n],16);i&&(s[3]=parseInt(i+i,16)/255)}else if(t=e.match(/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)){for(n=0;n<3;n++)s[n]=parseInt(t[n+1],0);t[4]&&(s[3]=t[5]?.01*parseFloat(t[4]):parseFloat(t[4]))}else{if(!(t=e.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)))return(t=e.match(/^(\w+)$/))?"transparent"===t[1]?[0,0,0,0]:MO.call(TO,t[1])?((s=TO[t[1]])[3]=1,s):null:null;for(n=0;n<3;n++)s[n]=Math.round(2.55*parseFloat(t[n+1]));t[4]&&(s[3]=t[5]?.01*parseFloat(t[4]):parseFloat(t[4]))}for(n=0;n<3;n++)s[n]=kO(s[n],0,255);return s[3]=kO(s[3],0,1),s},IO.get.hsl=function(e){if(!e)return null;var t=e.match(/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(t){var n=parseFloat(t[4]);return[(parseFloat(t[1])%360+360)%360,kO(parseFloat(t[2]),0,100),kO(parseFloat(t[3]),0,100),kO(isNaN(n)?1:n,0,1)]}return null},IO.get.hwb=function(e){if(!e)return null;var t=e.match(/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(t){var n=parseFloat(t[4]);return[(parseFloat(t[1])%360+360)%360,kO(parseFloat(t[2]),0,100),kO(parseFloat(t[3]),0,100),kO(isNaN(n)?1:n,0,1)]}return null},IO.to.hex=function(){var e=SO(arguments);return"#"+OO(e[0])+OO(e[1])+OO(e[2])+(e[3]<1?OO(Math.round(255*e[3])):"")},IO.to.rgb=function(){var e=SO(arguments);return e.length<4||1===e[3]?"rgb("+Math.round(e[0])+", "+Math.round(e[1])+", "+Math.round(e[2])+")":"rgba("+Math.round(e[0])+", "+Math.round(e[1])+", "+Math.round(e[2])+", "+e[3]+")"},IO.to.rgb.percent=function(){var e=SO(arguments),t=Math.round(e[0]/255*100),n=Math.round(e[1]/255*100),i=Math.round(e[2]/255*100);return e.length<4||1===e[3]?"rgb("+t+"%, "+n+"%, "+i+"%)":"rgba("+t+"%, "+n+"%, "+i+"%, "+e[3]+")"},IO.to.hsl=function(){var e=SO(arguments);return e.length<4||1===e[3]?"hsl("+e[0]+", "+e[1]+"%, "+e[2]+"%)":"hsla("+e[0]+", "+e[1]+"%, "+e[2]+"%, "+e[3]+")"},IO.to.hwb=function(){var e=SO(arguments),t="";return e.length>=4&&1!==e[3]&&(t=", "+e[3]),"hwb("+e[0]+", "+e[1]+"%, "+e[2]+"%"+t+")"},IO.to.keyword=function(e){return CO[e.slice(0,3)]};var EO=yO.exports,RO={exports:{}},LO={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},DO={};for(var FO in LO)LO.hasOwnProperty(FO)&&(DO[LO[FO]]=FO);var HO=RO.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var NO in HO)if(HO.hasOwnProperty(NO)){if(!("channels"in HO[NO]))throw new Error("missing channels property: "+NO);if(!("labels"in HO[NO]))throw new Error("missing channel labels property: "+NO);if(HO[NO].labels.length!==HO[NO].channels)throw new Error("channel and label counts mismatch: "+NO);var BO=HO[NO].channels,zO=HO[NO].labels;delete HO[NO].channels,delete HO[NO].labels,Object.defineProperty(HO[NO],"channels",{value:BO}),Object.defineProperty(HO[NO],"labels",{value:zO})}function GO(e,t){return Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2)}HO.rgb.hsl=function(e){var t,n,i=e[0]/255,s=e[1]/255,o=e[2]/255,a=Math.min(i,s,o),l=Math.max(i,s,o),h=l-a;return l===a?t=0:i===l?t=(s-o)/h:s===l?t=2+(o-i)/h:o===l&&(t=4+(i-s)/h),(t=Math.min(60*t,360))<0&&(t+=360),n=(a+l)/2,[t,100*(l===a?0:n<=.5?h/(l+a):h/(2-l-a)),100*n]},HO.rgb.hsv=function(e){var t,n,i,s,o,a=e[0]/255,l=e[1]/255,h=e[2]/255,c=Math.max(a,l,h),u=c-Math.min(a,l,h),f=function(e){return(c-e)/6/u+.5};return 0===u?s=o=0:(o=u/c,t=f(a),n=f(l),i=f(h),a===c?s=i-n:l===c?s=1/3+t-i:h===c&&(s=2/3+n-t),s<0?s+=1:s>1&&(s-=1)),[360*s,100*o,100*c]},HO.rgb.hwb=function(e){var t=e[0],n=e[1],i=e[2];return[HO.rgb.hsl(e)[0],100*(1/255*Math.min(t,Math.min(n,i))),100*(i=1-1/255*Math.max(t,Math.max(n,i)))]},HO.rgb.cmyk=function(e){var t,n=e[0]/255,i=e[1]/255,s=e[2]/255;return[100*((1-n-(t=Math.min(1-n,1-i,1-s)))/(1-t)||0),100*((1-i-t)/(1-t)||0),100*((1-s-t)/(1-t)||0),100*t]},HO.rgb.keyword=function(e){var t=DO[e];if(t)return t;var n,i=1/0;for(var s in LO)if(LO.hasOwnProperty(s)){var o=GO(e,LO[s]);o<i&&(i=o,n=s)}return n},HO.keyword.rgb=function(e){return LO[e]},HO.rgb.xyz=function(e){var t=e[0]/255,n=e[1]/255,i=e[2]/255;return[100*(.4124*(t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92)),100*(.2126*t+.7152*n+.0722*i),100*(.0193*t+.1192*n+.9505*i)]},HO.rgb.lab=function(e){var t=HO.rgb.xyz(e),n=t[0],i=t[1],s=t[2];return i/=100,s/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116)-16,500*(n-i),200*(i-(s=s>.008856?Math.pow(s,1/3):7.787*s+16/116))]},HO.hsl.rgb=function(e){var t,n,i,s,o,a=e[0]/360,l=e[1]/100,h=e[2]/100;if(0===l)return[o=255*h,o,o];t=2*h-(n=h<.5?h*(1+l):h+l-h*l),s=[0,0,0];for(var c=0;c<3;c++)(i=a+1/3*-(c-1))<0&&i++,i>1&&i--,s[c]=255*(o=6*i<1?t+6*(n-t)*i:2*i<1?n:3*i<2?t+(n-t)*(2/3-i)*6:t);return s},HO.hsl.hsv=function(e){var t=e[0],n=e[1]/100,i=e[2]/100,s=n,o=Math.max(i,.01);return n*=(i*=2)<=1?i:2-i,s*=o<=1?o:2-o,[t,100*(0===i?2*s/(o+s):2*n/(i+n)),100*((i+n)/2)]},HO.hsv.rgb=function(e){var t=e[0]/60,n=e[1]/100,i=e[2]/100,s=Math.floor(t)%6,o=t-Math.floor(t),a=255*i*(1-n),l=255*i*(1-n*o),h=255*i*(1-n*(1-o));switch(i*=255,s){case 0:return[i,h,a];case 1:return[l,i,a];case 2:return[a,i,h];case 3:return[a,l,i];case 4:return[h,a,i];case 5:return[i,a,l]}},HO.hsv.hsl=function(e){var t,n,i,s=e[0],o=e[1]/100,a=e[2]/100,l=Math.max(a,.01);return i=(2-o)*a,n=o*l,[s,100*(n=(n/=(t=(2-o)*l)<=1?t:2-t)||0),100*(i/=2)]},HO.hwb.rgb=function(e){var t,n,i,s,o,a,l,h=e[0]/360,c=e[1]/100,u=e[2]/100,f=c+u;switch(f>1&&(c/=f,u/=f),i=6*h-(t=Math.floor(6*h)),1&t&&(i=1-i),s=c+i*((n=1-u)-c),t){default:case 6:case 0:o=n,a=s,l=c;break;case 1:o=s,a=n,l=c;break;case 2:o=c,a=n,l=s;break;case 3:o=c,a=s,l=n;break;case 4:o=s,a=c,l=n;break;case 5:o=n,a=c,l=s}return[255*o,255*a,255*l]},HO.cmyk.rgb=function(e){var t=e[1]/100,n=e[2]/100,i=e[3]/100;return[255*(1-Math.min(1,e[0]/100*(1-i)+i)),255*(1-Math.min(1,t*(1-i)+i)),255*(1-Math.min(1,n*(1-i)+i))]},HO.xyz.rgb=function(e){var t,n,i,s=e[0]/100,o=e[1]/100,a=e[2]/100;return n=-.9689*s+1.8758*o+.0415*a,i=.0557*s+-.204*o+1.057*a,t=(t=3.2406*s+-1.5372*o+-.4986*a)>.0031308?1.055*Math.pow(t,1/2.4)-.055:12.92*t,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,i=i>.0031308?1.055*Math.pow(i,1/2.4)-.055:12.92*i,[255*(t=Math.min(Math.max(0,t),1)),255*(n=Math.min(Math.max(0,n),1)),255*(i=Math.min(Math.max(0,i),1))]},HO.xyz.lab=function(e){var t=e[0],n=e[1],i=e[2];return n/=100,i/=108.883,t=(t/=95.047)>.008856?Math.pow(t,1/3):7.787*t+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(t-n),200*(n-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},HO.lab.xyz=function(e){var t,n,i;t=e[1]/500+(n=(e[0]+16)/116),i=n-e[2]/200;var s=Math.pow(n,3),o=Math.pow(t,3),a=Math.pow(i,3);return n=s>.008856?s:(n-16/116)/7.787,t=o>.008856?o:(t-16/116)/7.787,i=a>.008856?a:(i-16/116)/7.787,[t*=95.047,n*=100,i*=108.883]},HO.lab.lch=function(e){var t,n=e[0],i=e[1],s=e[2];return(t=360*Math.atan2(s,i)/2/Math.PI)<0&&(t+=360),[n,Math.sqrt(i*i+s*s),t]},HO.lch.lab=function(e){var t,n=e[1];return t=e[2]/360*2*Math.PI,[e[0],n*Math.cos(t),n*Math.sin(t)]},HO.rgb.ansi16=function(e){var t=e[0],n=e[1],i=e[2],s=1 in arguments?arguments[1]:HO.rgb.hsv(e)[2];if(0===(s=Math.round(s/50)))return 30;var o=30+(Math.round(i/255)<<2|Math.round(n/255)<<1|Math.round(t/255));return 2===s&&(o+=60),o},HO.hsv.ansi16=function(e){return HO.rgb.ansi16(HO.hsv.rgb(e),e[2])},HO.rgb.ansi256=function(e){var t=e[0],n=e[1],i=e[2];return t===n&&n===i?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(n/255*5)+Math.round(i/255*5)},HO.ansi16.rgb=function(e){var t=e%10;if(0===t||7===t)return e>50&&(t+=3.5),[t=t/10.5*255,t,t];var n=.5*(1+~~(e>50));return[(1&t)*n*255,(t>>1&1)*n*255,(t>>2&1)*n*255]},HO.ansi256.rgb=function(e){if(e>=232){var t=10*(e-232)+8;return[t,t,t]}var n;return e-=16,[Math.floor(e/36)/5*255,Math.floor((n=e%36)/6)/5*255,n%6/5*255]},HO.rgb.hex=function(e){var t=(((255&Math.round(e[0]))<<16)+((255&Math.round(e[1]))<<8)+(255&Math.round(e[2]))).toString(16).toUpperCase();return"000000".substring(t.length)+t},HO.hex.rgb=function(e){var t=e.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!t)return[0,0,0];var n=t[0];3===t[0].length&&(n=n.split("").map((function(e){return e+e})).join(""));var i=parseInt(n,16);return[i>>16&255,i>>8&255,255&i]},HO.rgb.hcg=function(e){var t,n=e[0]/255,i=e[1]/255,s=e[2]/255,o=Math.max(Math.max(n,i),s),a=Math.min(Math.min(n,i),s),l=o-a;return t=l<=0?0:o===n?(i-s)/l%6:o===i?2+(s-n)/l:4+(n-i)/l+4,t/=6,[360*(t%=1),100*l,100*(l<1?a/(1-l):0)]},HO.hsl.hcg=function(e){var t=e[1]/100,n=e[2]/100,i=1,s=0;return(i=n<.5?2*t*n:2*t*(1-n))<1&&(s=(n-.5*i)/(1-i)),[e[0],100*i,100*s]},HO.hsv.hcg=function(e){var t=e[2]/100,n=e[1]/100*t,i=0;return n<1&&(i=(t-n)/(1-n)),[e[0],100*n,100*i]},HO.hcg.rgb=function(e){var t=e[1]/100,n=e[2]/100;if(0===t)return[255*n,255*n,255*n];var i,s=[0,0,0],o=e[0]/360%1*6,a=o%1,l=1-a;switch(Math.floor(o)){case 0:s[0]=1,s[1]=a,s[2]=0;break;case 1:s[0]=l,s[1]=1,s[2]=0;break;case 2:s[0]=0,s[1]=1,s[2]=a;break;case 3:s[0]=0,s[1]=l,s[2]=1;break;case 4:s[0]=a,s[1]=0,s[2]=1;break;default:s[0]=1,s[1]=0,s[2]=l}return[255*(t*s[0]+(i=(1-t)*n)),255*(t*s[1]+i),255*(t*s[2]+i)]},HO.hcg.hsv=function(e){var t=e[1]/100,n=t+e[2]/100*(1-t),i=0;return n>0&&(i=t/n),[e[0],100*i,100*n]},HO.hcg.hsl=function(e){var t=e[1]/100,n=e[2]/100*(1-t)+.5*t,i=0;return n>0&&n<.5?i=t/(2*n):n>=.5&&n<1&&(i=t/(2*(1-n))),[e[0],100*i,100*n]},HO.hcg.hwb=function(e){var t=e[1]/100,n=t+e[2]/100*(1-t);return[e[0],100*(n-t),100*(1-n)]},HO.hwb.hcg=function(e){var t=1-e[2]/100,n=t-e[1]/100,i=0;return n<1&&(i=(t-n)/(1-n)),[e[0],100*n,100*i]},HO.apple.rgb=function(e){return[e[0]/65535*255,e[1]/65535*255,e[2]/65535*255]},HO.rgb.apple=function(e){return[e[0]/255*65535,e[1]/255*65535,e[2]/255*65535]},HO.gray.rgb=function(e){return[e[0]/100*255,e[0]/100*255,e[0]/100*255]},HO.gray.hsl=HO.gray.hsv=function(e){return[0,0,e[0]]},HO.gray.hwb=function(e){return[0,100,e[0]]},HO.gray.cmyk=function(e){return[0,0,0,e[0]]},HO.gray.lab=function(e){return[e[0],0,0]},HO.gray.hex=function(e){var t=255&Math.round(e[0]/100*255),n=((t<<16)+(t<<8)+t).toString(16).toUpperCase();return"000000".substring(n.length)+n},HO.rgb.gray=function(e){return[(e[0]+e[1]+e[2])/3/255*100]};var UO=RO.exports,VO=UO;function jO(e){var t=function(){for(var e={},t=Object.keys(VO),n=t.length,i=0;i<n;i++)e[t[i]]={distance:-1,parent:null};return e}(),n=[e];for(t[e].distance=0;n.length;)for(var i=n.pop(),s=Object.keys(VO[i]),o=s.length,a=0;a<o;a++){var l=s[a],h=t[l];-1===h.distance&&(h.distance=t[i].distance+1,h.parent=i,n.unshift(l))}return t}function WO(e,t){return function(n){return t(e(n))}}function qO(e,t){for(var n=[t[e].parent,e],i=VO[t[e].parent][e],s=t[e].parent;t[s].parent;)n.unshift(t[s].parent),i=WO(VO[t[s].parent][s],i),s=t[s].parent;return i.conversion=n,i}var ZO=UO,XO=function(e){for(var t=jO(e),n={},i=Object.keys(t),s=i.length,o=0;o<s;o++){var a=i[o];null!==t[a].parent&&(n[a]=qO(a,t))}return n},YO={};Object.keys(ZO).forEach((function(e){YO[e]={},Object.defineProperty(YO[e],"channels",{value:ZO[e].channels}),Object.defineProperty(YO[e],"labels",{value:ZO[e].labels});var t=XO(e);Object.keys(t).forEach((function(n){var i=t[n];YO[e][n]=function(e){var t=function(t){if(null==t)return t;arguments.length>1&&(t=Array.prototype.slice.call(arguments));var n=e(t);if("object"==typeof n)for(var i=n.length,s=0;s<i;s++)n[s]=Math.round(n[s]);return n};return"conversion"in e&&(t.conversion=e.conversion),t}(i),YO[e][n].raw=function(e){var t=function(t){return null==t?t:(arguments.length>1&&(t=Array.prototype.slice.call(arguments)),e(t))};return"conversion"in e&&(t.conversion=e.conversion),t}(i)}))}));var JO=EO,QO=YO,$O=[].slice,KO=["keyword","gray","hex"],eE={};Object.keys(QO).forEach((function(e){eE[$O.call(QO[e].labels).sort().join("")]=e}));var tE={};function nE(e,t){if(!(this instanceof nE))return new nE(e,t);if(t&&t in KO&&(t=null),t&&!(t in QO))throw new Error("Unknown model: "+t);var n,i;if(null==e)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(e instanceof nE)this.model=e.model,this.color=e.color.slice(),this.valpha=e.valpha;else if("string"==typeof e){var s=JO.get(e);if(null===s)throw new Error("Unable to parse color from string: "+e);this.model=s.model,this.color=s.value.slice(0,i=QO[this.model].channels),this.valpha="number"==typeof s.value[i]?s.value[i]:1}else if(e.length){this.model=t||"rgb";var o=$O.call(e,0,i=QO[this.model].channels);this.color=sE(o,i),this.valpha="number"==typeof e[i]?e[i]:1}else if("number"==typeof e)e&=16777215,this.model="rgb",this.color=[e>>16&255,e>>8&255,255&e],this.valpha=1;else{this.valpha=1;var a=Object.keys(e);"alpha"in e&&(a.splice(a.indexOf("alpha"),1),this.valpha="number"==typeof e.alpha?e.alpha:0);var l=a.sort().join("");if(!(l in eE))throw new Error("Unable to parse color from object: "+JSON.stringify(e));this.model=eE[l];var h=QO[this.model].labels,c=[];for(n=0;n<h.length;n++)c.push(e[h[n]]);this.color=sE(c)}if(tE[this.model])for(i=QO[this.model].channels,n=0;n<i;n++){var u=tE[this.model][n];u&&(this.color[n]=u(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function rE(e,t,n){return(e=Array.isArray(e)?e:[e]).forEach((function(e){(tE[e]||(tE[e]=[]))[t]=n})),e=e[0],function(i){var s;return arguments.length?(n&&(i=n(i)),(s=this[e]()).color[t]=i,s):(s=this[e]().color[t],n&&(s=n(s)),s)}}function iE(e){return function(t){return Math.max(0,Math.min(e,t))}}function sE(e,t){for(var n=0;n<t;n++)"number"!=typeof e[n]&&(e[n]=0);return e}nE.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(e){var t=this.model in JO.to?this:this.rgb(),n=1===(t=t.round("number"==typeof e?e:1)).valpha?t.color:t.color.concat(this.valpha);return JO.to[t.model](n)},percentString:function(e){var t=this.rgb().round("number"==typeof e?e:1),n=1===t.valpha?t.color:t.color.concat(this.valpha);return JO.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var e={},t=QO[this.model].channels,n=QO[this.model].labels,i=0;i<t;i++)e[n[i]]=this.color[i];return 1!==this.valpha&&(e.alpha=this.valpha),e},unitArray:function(){var e=this.rgb().color;return e[0]/=255,e[1]/=255,e[2]/=255,1!==this.valpha&&e.push(this.valpha),e},unitObject:function(){var e=this.rgb().object();return e.r/=255,e.g/=255,e.b/=255,1!==this.valpha&&(e.alpha=this.valpha),e},round:function(e){return e=Math.max(e||0,0),new nE(this.color.map(function(e){return function(t){return function(e,t){return Number(e.toFixed(t))}(t,e)}}(e)).concat(this.valpha),this.model)},alpha:function(e){return arguments.length?new nE(this.color.concat(Math.max(0,Math.min(1,e))),this.model):this.valpha},red:rE("rgb",0,iE(255)),green:rE("rgb",1,iE(255)),blue:rE("rgb",2,iE(255)),hue:rE(["hsl","hsv","hsl","hwb","hcg"],0,(function(e){return(e%360+360)%360})),saturationl:rE("hsl",1,iE(100)),lightness:rE("hsl",2,iE(100)),saturationv:rE("hsv",1,iE(100)),value:rE("hsv",2,iE(100)),chroma:rE("hcg",1,iE(100)),gray:rE("hcg",2,iE(100)),white:rE("hwb",1,iE(100)),wblack:rE("hwb",2,iE(100)),cyan:rE("cmyk",0,iE(100)),magenta:rE("cmyk",1,iE(100)),yellow:rE("cmyk",2,iE(100)),black:rE("cmyk",3,iE(100)),x:rE("xyz",0,iE(100)),y:rE("xyz",1,iE(100)),z:rE("xyz",2,iE(100)),l:rE("lab",0,iE(100)),a:rE("lab",1),b:rE("lab",2),keyword:function(e){return arguments.length?new nE(e):QO[this.model].keyword(this.color)},hex:function(e){return arguments.length?new nE(e):JO.to.hex(this.rgb().round().color)},rgbNumber:function(){var e=this.rgb().color;return(255&e[0])<<16|(255&e[1])<<8|255&e[2]},luminosity:function(){for(var e=this.rgb().color,t=[],n=0;n<e.length;n++){var i=e[n]/255;t[n]=i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4)}return.2126*t[0]+.7152*t[1]+.0722*t[2]},contrast:function(e){var t=this.luminosity(),n=e.luminosity();return t>n?(t+.05)/(n+.05):(n+.05)/(t+.05)},level:function(e){var t=this.contrast(e);return t>=7.1?"AAA":t>=4.5?"AA":""},isDark:function(){var e=this.rgb().color;return(299*e[0]+587*e[1]+114*e[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var e=this.rgb(),t=0;t<3;t++)e.color[t]=255-e.color[t];return e},lighten:function(e){var t=this.hsl();return t.color[2]+=t.color[2]*e,t},darken:function(e){var t=this.hsl();return t.color[2]-=t.color[2]*e,t},saturate:function(e){var t=this.hsl();return t.color[1]+=t.color[1]*e,t},desaturate:function(e){var t=this.hsl();return t.color[1]-=t.color[1]*e,t},whiten:function(e){var t=this.hwb();return t.color[1]+=t.color[1]*e,t},blacken:function(e){var t=this.hwb();return t.color[2]+=t.color[2]*e,t},grayscale:function(){var e=this.rgb().color,t=.3*e[0]+.59*e[1]+.11*e[2];return nE.rgb(t,t,t)},fade:function(e){return this.alpha(this.valpha-this.valpha*e)},opaquer:function(e){return this.alpha(this.valpha+this.valpha*e)},rotate:function(e){var t=this.hsl(),n=t.color[0];return t.color[0]=n=(n=(n+e)%360)<0?360+n:n,t},mix:function(e,t){if(!e||!e.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof e);var n=e.rgb(),i=this.rgb(),s=void 0===t?.5:t,o=2*s-1,a=n.alpha()-i.alpha(),l=((o*a==-1?o:(o+a)/(1+o*a))+1)/2,h=1-l;return nE.rgb(l*n.red()+h*i.red(),l*n.green()+h*i.green(),l*n.blue()+h*i.blue(),n.alpha()*s+i.alpha()*(1-s))}},Object.keys(QO).forEach((function(e){if(-1===KO.indexOf(e)){var t=QO[e].channels;nE.prototype[e]=function(){if(this.model===e)return new nE(this);if(arguments.length)return new nE(arguments,e);var n,i="number"==typeof arguments[t]?t:this.valpha;return new nE((n=QO[this.model][e].raw(this.color),Array.isArray(n)?n:[n]).concat(i),e)},nE[e]=function(n){return"number"==typeof n&&(n=sE($O.call(arguments),t)),new nE(n,e)}}}));var oE=Vm(nE);let aE;const lE={width:100,height:10};let hE=!1;try{const e=new OffscreenCanvas(1,1);e.getContext("2d").fillText("hello",0,0),hE=!0}catch(e){hE=!1}function cE(){if(!aE){const{width:e,height:t}=lE;hE?aE=new OffscreenCanvas(e,t):(aE=document.createElement("canvas"),aE.width=e,aE.height=t)}return aE}class ColorIn{constructor(e,t={}){if(!Array.isArray(e))return void console.error("colors is not array");if(e.length<2)return void console.error("colors.length should >1");this.colors=e;let n=1/0,i=-1/0;for(let t=0,s=e.length;t<s;t++){const s=e[t][0];n=Math.min(s,n),i=Math.max(s,i)}this.min=n,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},lE,t),this._initImgData()}getImageData(){return this.imgData}_initImgData(){const e=cE(),{width:t,height:n}=this.options;e.width=t,e.height=n;const i=e.getContext("2d");i.clearRect(0,0,e.width,e.height);const s=i.createLinearGradient(0,0,e.width,0),{colors:o,valueOffset:a}=this;for(let e=0,t=o.length;e<t;e++){const[t,n]=o[e];s.addColorStop((t-this.min)/a,n)}i.fillStyle=s,i.fillRect(0,0,e.width,e.height),this.imgData=i.getImageData(0,0,e.width,e.height)}getColor(e){e=Math.max(this.min,e),e=Math.min(e,this.max);let t=Math.round((e-this.min)/this.valueOffset*this.imgData.width);t=Math.min(t,this.imgData.width-1);const n=4*t;return[this.imgData.data[n],this.imgData.data[n+1],this.imgData.data[n+2],this.imgData.data[n+3]]}}var uE;function fE(e){return null==e}function dE(e){return!fE(e)}function pE(e){return""===e}function gE(e,t){var n,i,s;if(SE(e)){var o,a=e.stops&&"object"==typeof e.stops[0][0],l=a||dE(e.property),h=a||!l,c=e.type||t||"exponential";if("exponential"===c)o=yE;else if("interval"===c)o=AE;else if("categorical"===c)o=mE;else if("identity"===c)o=xE;else if("color-interpolate"===c)o=vE;else{if("calculate-expression"!==c)throw new Error('Unknown function type "'+c+'"');o=bE}if(a){var u={},f=[];for(let t=0;t<e.stops.length;t++){var g=e.stops[t];void 0===u[g[0].zoom]&&(u[g[0].zoom]={zoom:g[0].zoom,type:e.type,property:e.property,default:e.default,stops:[]}),u[g[0].zoom].stops.push([g[0].value,g[1]])}for(let e in u)f.push([u[e].zoom,gE(u[e])]);n=function(t,n){const i=yE({stops:f,base:e.base},t)(t,n);return"function"==typeof i?i(t,n):i},i=!1,s=!1}else h?(n=function(t){const n=o(e,t);return"function"==typeof n?n(t):n},i=!0,s=!1):(n=function(t,n){const i=o(e,n?n[e.property]:null);return"function"==typeof i?i(t,n):i},i=!1,s=!0)}else n=function(){return e},i=!0,s=!0;return n.isZoomConstant=s,n.isFeatureConstant=i,n}function mE(e,t){for(let n=0;n<e.stops.length;n++)if(t===e.stops[n][0])return e.stops[n][1];return e.default}function AE(e,t){for(var n=0;n<e.stops.length&&!(t<e.stops[n][0]);n++);return e.stops[Math.max(n-1,0)][1]}function yE(e,t){for(var n=dE(e.base)&&!pE(e.base)?e.base:1,i=0;!(i>=e.stops.length||t<=e.stops[i][0]);)i++;return 0===i?e.stops[i][1]:i===e.stops.length?e.stops[i-1][1]:wE(t,n,e.stops[i-1][0],e.stops[i][0],e.stops[i-1][1],e.stops[i][1])}"function"==typeof Map&&(uE=new Map);const _E={width:100,height:1};function vE(e,t){const n=e.stops;if(n&&n.length>1){let e;if(uE){const t=JSON.stringify(n);if(!uE.has(t)){const e=new ColorIn(n,_E);uE.set(t,e)}e=uE.get(t)}else e=new ColorIn(n,_E);const[i,s,o,a]=e.getColor(t);return[i/255,s/255,o/255,a/255]}return n&&1===n.length?n[0][1]:null}function xE(e,t){return function(e,t,n){return dE(e)?e:dE(t)?t:dE(n)?n:null}(t,e.default)}function bE(e,t){const n=String(e.property),i=e.expression,s=t;function o(t){return fE(t)||pE(t)||isNaN(t)?e.default:t}if(!dE(t)||pE(t)||isNaN(t)||t<0)return o(e.default);{const t=function e(t,n,i){const s=Number(i),o=String(n);return Array.isArray(t)?t.map((t=>e(t,o,s))):t===o?s:t}(i,n,s);return o(function t(n){if(!Array.isArray(n)){if("number"==typeof n)return n;throw new Error("Invalid expression format")}{const i=n[0];if(!["+","-","*","/"].includes(i))throw new Error(`Unknown operator: ${i}`);const s=n.slice(1).map((e=>t(e)));switch(i){case"+":return s.reduce(((e,t)=>e+t),0);case"-":return s.reduce(((e,t)=>e-t));case"*":return s.reduce(((e,t)=>e*t),1);case"/":return s.some((e=>0===e))?e.default:s.reduce(((e,t)=>e/t));default:throw new Error(`Unsupported operator: ${i}`)}}}(t))}}function wE(e,t,n,i,s,o){return"function"==typeof s?function(){var a=s.apply(void 0,arguments),l=o.apply(void 0,arguments);return wE(e,t,n,i,a,l)}:s.length?function(e,t,n,i,s,o){var a=[];for(let l=0;l<s.length;l++)a[l]=TE(e,t,n,i,s[l],o[l]);return a}(e,t,n,i,s,o):TE(e,t,n,i,s,o)}function TE(e,t,n,i,s,o){var a,l=i-n,h=e-n;return s*(1-(a=1===t?h/l:(Math.pow(t,h)-1)/(Math.pow(t,l)-1)))+o*a}function SE(e){return e&&"object"==typeof e&&(e.stops||e.property&&"identity"===e.type||e.expression&&"calculate-expression"===e.type)}function ME(e){for(const t in e)if(SE(e[t]))return!0;return!1}function CE(e){return kE(e,"exponential")}function PE(e){return kE(e,"interval")}function IE(e,t){if(!e)return null;var n=!1;if(Array.isArray(e)){var i,s=[];for(let o=0;o<e.length;o++)(i=IE(e[o],t))?(s.push(i),n=!0):s.push(e[o]);return n?s:e}var o,a={__fn_types_loaded:!0},l=[];for(o in e)e.hasOwnProperty(o)&&l.push(o);const h=function(e){Object.defineProperty(a,e,{get:function(){return this["__fn_"+e]||(this["__fn_"+e]=CE(this["_"+e])),this["__fn_"+e].apply(this,t())},set:function(t){this["_"+e]=t},configurable:!0,enumerable:!0})};for(let t=0,i=l.length;t<i;t++)SE(e[o=l[t]])?(n=!0,a["_"+o]=e[o],h(o)):a[o]=e[o];return n?a:e}function kE(e,t){if(!SE(e))return function(){return e};let n=!0,i=!0;const s=(e=JSON.parse(JSON.stringify(e))).stops;if(s)for(let e=0;e<s.length;e++)if(SE(s[e][1])){const o=kE(s[e][1],t);n=n&&o.isZoomConstant,i=i&&o.isFeatureConstant,s[e]=[s[e][0],o]}const o=gE(e,t);return o.isZoomConstant=n&&o.isZoomConstant,o.isFeatureConstant=i&&o.isFeatureConstant,o}
/*!
  * Contains code from jquery.easing
  * BSD License
  * https://github.com/gdsmith/jquery.easing/
  */var OE=Math.pow,EE=Math.sqrt,RE=Math.sin,LE=Math.cos,DE=Math.PI,FE=1.70158,HE=1.525*FE,NE=FE+1,BE=2*DE/3,zE=2*DE/4.5;function GE(e){var t=7.5625,n=2.75;return e<1/n?t*e*e:e<2/n?t*(e-=1.5/n)*e+.75:e<2.5/n?t*(e-=2.25/n)*e+.9375:t*(e-=2.625/n)*e+.984375}function UE(e,t){switch(e=e.toLowerCase()){case"swing":return function(e){return VE(e)}(t);case"easeinquad":return VE(t);case"easeoutquad":return function(e){return 1-(1-e)*(1-e)}(t);case"easeinoutquad":return function(e){return e<.5?2*e*e:1-OE(-2*e+2,2)/2}(t);case"easeincubic":return function(e){return e*e*e}(t);case"easeoutcubic":return function(e){return 1-OE(1-e,3)}(t);case"easeinoutcubic":return function(e){return e<.5?4*e*e*e:1-OE(-2*e+2,3)/2}(t);case"easeinquart":return function(e){return e*e*e*e}(t);case"easeoutquart":return function(e){return 1-OE(1-e,4)}(t);case"easeinoutquart":return function(e){return e<.5?8*e*e*e*e:1-OE(-2*e+2,4)/2}(t);case"easeinquint":return function(e){return e*e*e*e*e}(t);case"easeoutquint":return function(e){return 1-OE(1-e,5)}(t);case"easeinoutquint":return function(e){return e<.5?16*e*e*e*e*e:1-OE(-2*e+2,5)/2}(t);case"easeinsine":return function(e){return 1-LE(e*DE/2)}(t);case"easeoutsine":return function(e){return RE(e*DE/2)}(t);case"easeinoutsine":return function(e){return-(LE(DE*e)-1)/2}(t);case"easeinexpo":return function(e){return 0===e?0:OE(2,10*e-10)}(t);case"easeoutexpo":return function(e){return 1===e?1:1-OE(2,-10*e)}(t);case"easeinoutexpo":return function(e){return 0===e?0:1===e?1:e<.5?OE(2,20*e-10)/2:(2-OE(2,-20*e+10))/2}(t);case"easeincirc":return function(e){return 1-EE(1-OE(e,2))}(t);case"easeoutcirc":return function(e){return EE(1-OE(e-1,2))}(t);case"easeinoutcirc":return function(e){return e<.5?(1-EE(1-OE(2*e,2)))/2:(EE(1-OE(-2*e+2,2))+1)/2}(t);case"easeinelastic":return function(e){return 0===e?0:1===e?1:-OE(2,10*e-10)*RE((10*e-10.75)*BE)}(t);case"easeoutelastic":return function(e){return 0===e?0:1===e?1:OE(2,-10*e)*RE((10*e-.75)*BE)+1}(t);case"easeinoutelastic":return function(e){return 0===e?0:1===e?1:e<.5?-OE(2,20*e-10)*RE((20*e-11.125)*zE)/2:OE(2,-20*e+10)*RE((20*e-11.125)*zE)/2+1}(t);case"easeinback":return function(e){return NE*e*e*e-FE*e*e}(t);case"easeoutback":return function(e){return 1+NE*OE(e-1,3)+FE*OE(e-1,2)}(t);case"easeinoutback":return function(e){return e<.5?OE(2*e,2)*(2*(HE+1)*e-HE)/2:(OE(2*e-2,2)*((HE+1)*(2*e-2)+HE)+2)/2}(t);case"easeinbounce":return function(e){return 1-GE(1-e)}(t);case"easeoutbounce":return function(e){return GE(e)}(t);case"easeinoutbounce":return function(e){return e<.5?(1-GE(1-2*e))/2:(1+GE(2*e-1))/2}
/*!
      Feature Filter by

      (c) mapbox 2016 and maptalks 2018
      www.mapbox.com | www.maptalks.org
      License: MIT, header required.
  */(t)}throw new Error("Unsupported easing function:"+e)}function VE(e){return e*e}const jE=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function WE(e){return new Function("f",`var p = (f && f.properties || {}); return ${qE(e)}`)}function qE(e){if(!e)return"true";const t=e[0];if(e.length<=1)return"any"===t?"false":"true";const n="=="===t?XE(e[1],e[2],"===",!1):"!="===t?XE(e[1],e[2],"!==",!1):"<"===t||">"===t||"<="===t||">="===t?XE(e[1],e[2],t,!0):"any"===t?JE(e.slice(1),"||"):"all"===t?JE(e.slice(1),"&&"):"none"===t?KE(JE(e.slice(1),"||")):"in"===t?QE(e[1],e.slice(2)):"!in"===t?KE(QE(e[1],e.slice(2))):"has"===t?$E(e[1]):"!has"===t?KE($E(e[1])):"contains"===t?function(e,t,n){const i=ZE(e);return void 0!==n?`(${i} + '').indexOf("${t}") === ${n}`:`(${i} + '').indexOf("${t}") >= 0`}(e[1],e[2],e[3]):"true";return`(${n})`}function ZE(e){return"$"===e[0]?"f."+e.substring(1):"p["+JSON.stringify(e)+"]"}function XE(e,t,n,i){if("object"==typeof(s=e)&&s&&e.op)return function(e,t,n,i){const s=e.property,o=e.op;let a=ZE(s);return"length"!==o?(console.error(`not support ${o} op`),"false"):(a=`((${a}+='').length)`,YE(a,s,t,n,i))}(e,t,n,i);var s;return YE(ZE(e),e,t,n,i)}function YE(e,t,n,i,s){const o="$type"===t?jE.indexOf(n):JSON.stringify(n);return(s?`typeof ${e}=== typeof ${o}&&`:"")+e+i+o}function JE(e,t){return e.map(qE).join(t)}function QE(e,t){"$type"===e&&(t=t.map((e=>jE.indexOf(e))));const n=JSON.stringify(t.sort(eR)),i=ZE(e);return t.length<=200?`${n}.indexOf(${i}) !== -1`:`function(v, a, i, j) {\n        while (i <= j) { var m = (i + j) >> 1;\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\n        }\n    return false; }(${i}, ${n},0,${t.length-1})`}function $E(e){return"$id"===e?'"id" in f':`${JSON.stringify(e)} in p`}function KE(e){return`!(${e})`}function eR(e,t){return e<t?-1:e>t?1:0}function tR(e){if(!Array.isArray(e))return tR([e]);const t=[];for(let n=0;n<e.length;n++){let i;i=!0===e[n].filter?function(){return!0}:WE(e[n].filter),t.push(nR({},e[n],{filter:i}))}return t}function nR(e){for(let t=1;t<arguments.length;t++){const n=arguments[t];for(const t in n)e[t]=n[t]}return e}function rR(){}const iR=rR.prototype;iR.getType=function(){return Object.getPrototypeOf(this).constructor.type},iR.isVisible=function(){throw new Error("to be implemented.")},iR.prepareRender=function(){throw new Error("to be implemented.")},iR.updateCollision=function(){throw new Error("to be implemented.")},iR.supportRenderMode=function(){throw new Error("to be implemented.")},iR.startFrame=function(){throw new Error("to be implemented.")},iR.endFrame=function(){throw new Error("to be implemented.")},iR.paintTile=function(){throw new Error("to be implemented.")},iR.getShadowMeshes=function(){throw new Error("to be implemented.")},iR.updateSceneConfig=function(){throw new Error("to be implemented.")},iR.updateDataConfig=function(){throw new Error("to be implemented.")},iR.updateSymbol=function(){throw new Error("to be implemented.")},iR.pick=function(){throw new Error("to be implemented.")},iR.resize=function(){throw new Error("to be implemented.")},iR.deleteTile=function(){throw new Error("to be implemented.")},iR.remove=function(){throw new Error("to be implemented.")},iR.needToRedraw=function(){throw new Error("to be implemented.")},iR.needToRetireFrames=function(){throw new Error("to be implemented.")},iR.outline=function(){throw new Error("to be implemented.")},iR.outlineAll=function(){throw new Error("to be implemented.")},iR.needPolygonOffset=function(){throw new Error("to be implemented.")},iR.constructor=rR;const sR=Object.prototype.hasOwnProperty;function oR(e){e.registerPlugin(this)}function aR(e,t,n=2){const i=t&&t.length,s=i?t[0]*n:e.length;let o=lR(e,0,s,n,!0);const a=[];if(!o||o.next===o.prev)return a;let l,h,c;if(i&&(o=function(e,t,n,i){const s=[];for(let n=0,o=t.length;n<o;n++){const a=lR(e,t[n]*i,n<o-1?t[n+1]*i:e.length,i,!1);a===a.next&&(a.steiner=!0),s.push(_R(a))}s.sort(gR);for(let e=0;e<s.length;e++)n=mR(s[e],n);return n}(e,t,o,n)),e.length>80*n){l=1/0,h=1/0;let t=-1/0,i=-1/0;for(let o=n;o<s;o+=n){const n=e[o],s=e[o+1];n<l&&(l=n),s<h&&(h=s),n>t&&(t=n),s>i&&(i=s)}c=Math.max(t-l,i-h),c=0!==c?32767/c:0}return cR(o,a,n,l,h,c,0),a}function lR(e,t,n,i,s){let o;if(s===function(e,t,n,i){let s=0;for(let o=t,a=n-i;o<n;o+=i)s+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return s}(e,t,n,i)>0)for(let s=t;s<n;s+=i)o=kR(s/i|0,e[s],e[s+1],o);else for(let s=n-i;s>=t;s-=i)o=kR(s/i|0,e[s],e[s+1],o);return o&&TR(o,o.next)&&(OR(o),o=o.next),o}function hR(e,t){if(!e)return e;t||(t=e);let n,i=e;do{if(n=!1,i.steiner||!TR(i,i.next)&&0!==wR(i.prev,i,i.next))i=i.next;else{if(OR(i),i=t=i.prev,i===i.next)break;n=!0}}while(n||i!==t);return t}function cR(e,t,n,i,s,o,a){if(!e)return;!a&&o&&function(e,t,n,i){let s=e;do{0===s.z&&(s.z=yR(s.x,s.y,t,n,i)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==e);s.prevZ.nextZ=null,s.prevZ=null,function(e){let t,n=1;do{let i,s=e;e=null;let o=null;for(t=0;s;){t++;let a=s,l=0;for(let e=0;e<n&&(l++,a=a.nextZ,a);e++);let h=n;for(;l>0||h>0&&a;)0!==l&&(0===h||!a||s.z<=a.z)?(i=s,s=s.nextZ,l--):(i=a,a=a.nextZ,h--),o?o.nextZ=i:e=i,i.prevZ=o,o=i;s=a}o.nextZ=null,n*=2}while(t>1)}(s)}(e,i,s,o);let l=e;for(;e.prev!==e.next;){const h=e.prev,c=e.next;if(o?fR(e,i,s,o):uR(e))t.push(h.i,e.i,c.i),OR(e),e=c.next,l=c.next;else if((e=c)===l){a?1===a?cR(e=dR(hR(e),t),t,n,i,s,o,2):2===a&&pR(e,t,n,i,s,o):cR(hR(e),t,n,i,s,o,1);break}}}function uR(e){const t=e.prev,n=e,i=e.next;if(wR(t,n,i)>=0)return!1;const s=t.x,o=n.x,a=i.x,l=t.y,h=n.y,c=i.y,u=Math.min(s,o,a),f=Math.min(l,h,c),g=Math.max(s,o,a),m=Math.max(l,h,c);let A=i.next;for(;A!==t;){if(A.x>=u&&A.x<=g&&A.y>=f&&A.y<=m&&xR(s,l,o,h,a,c,A.x,A.y)&&wR(A.prev,A,A.next)>=0)return!1;A=A.next}return!0}function fR(e,t,n,i){const s=e.prev,o=e,a=e.next;if(wR(s,o,a)>=0)return!1;const l=s.x,h=o.x,c=a.x,u=s.y,f=o.y,g=a.y,m=Math.min(l,h,c),A=Math.min(u,f,g),w=Math.max(l,h,c),T=Math.max(u,f,g),S=yR(m,A,t,n,i),M=yR(w,T,t,n,i);let C=e.prevZ,I=e.nextZ;for(;C&&C.z>=S&&I&&I.z<=M;){if(C.x>=m&&C.x<=w&&C.y>=A&&C.y<=T&&C!==s&&C!==a&&xR(l,u,h,f,c,g,C.x,C.y)&&wR(C.prev,C,C.next)>=0)return!1;if(C=C.prevZ,I.x>=m&&I.x<=w&&I.y>=A&&I.y<=T&&I!==s&&I!==a&&xR(l,u,h,f,c,g,I.x,I.y)&&wR(I.prev,I,I.next)>=0)return!1;I=I.nextZ}for(;C&&C.z>=S;){if(C.x>=m&&C.x<=w&&C.y>=A&&C.y<=T&&C!==s&&C!==a&&xR(l,u,h,f,c,g,C.x,C.y)&&wR(C.prev,C,C.next)>=0)return!1;C=C.prevZ}for(;I&&I.z<=M;){if(I.x>=m&&I.x<=w&&I.y>=A&&I.y<=T&&I!==s&&I!==a&&xR(l,u,h,f,c,g,I.x,I.y)&&wR(I.prev,I,I.next)>=0)return!1;I=I.nextZ}return!0}function dR(e,t){let n=e;do{const i=n.prev,s=n.next.next;!TR(i,s)&&SR(i,n,n.next,s)&&PR(i,s)&&PR(s,i)&&(t.push(i.i,n.i,s.i),OR(n),OR(n.next),n=e=s),n=n.next}while(n!==e);return hR(n)}function pR(e,t,n,i,s,o){let a=e;do{let e=a.next.next;for(;e!==a.prev;){if(a.i!==e.i&&bR(a,e)){let l=IR(a,e);return a=hR(a,a.next),l=hR(l,l.next),cR(a,t,n,i,s,o,0),void cR(l,t,n,i,s,o,0)}e=e.next}a=a.next}while(a!==e)}function gR(e,t){let n=e.x-t.x;if(0===n&&(n=e.y-t.y,0===n)){n=(e.next.y-e.y)/(e.next.x-e.x)-(t.next.y-t.y)/(t.next.x-t.x)}return n}function mR(e,t){const n=function(e,t){let n=t;const i=e.x,s=e.y;let o,a=-1/0;if(TR(e,n))return n;do{if(TR(e,n.next))return n.next;if(s<=n.y&&s>=n.next.y&&n.next.y!==n.y){const e=n.x+(s-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(e<=i&&e>a&&(a=e,o=n.x<n.next.x?n:n.next,e===i))return o}n=n.next}while(n!==t);if(!o)return null;const l=o,h=o.x,c=o.y;let u=1/0;n=o;do{if(i>=n.x&&n.x>=h&&i!==n.x&&vR(s<c?i:a,s,h,c,s<c?a:i,s,n.x,n.y)){const t=Math.abs(s-n.y)/(i-n.x);PR(n,e)&&(t<u||t===u&&(n.x>o.x||n.x===o.x&&AR(o,n)))&&(o=n,u=t)}n=n.next}while(n!==l);return o}(e,t);if(!n)return t;const i=IR(n,e);return hR(i,i.next),hR(n,n.next)}function AR(e,t){return wR(e.prev,e,t.prev)<0&&wR(t.next,e,e.next)<0}function yR(e,t,n,i,s){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*s|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*s|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function _R(e){let t=e,n=e;do{(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next}while(t!==e);return n}function vR(e,t,n,i,s,o,a,l){return(s-a)*(t-l)>=(e-a)*(o-l)&&(e-a)*(i-l)>=(n-a)*(t-l)&&(n-a)*(o-l)>=(s-a)*(i-l)}function xR(e,t,n,i,s,o,a,l){return!(e===a&&t===l)&&vR(e,t,n,i,s,o,a,l)}function bR(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){let n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&SR(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&(PR(e,t)&&PR(t,e)&&function(e,t){let n=e,i=!1;const s=(e.x+t.x)/2,o=(e.y+t.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&s<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==e);return i}(e,t)&&(wR(e.prev,e,t.prev)||wR(e,t.prev,t))||TR(e,t)&&wR(e.prev,e,e.next)>0&&wR(t.prev,t,t.next)>0)}function wR(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function TR(e,t){return e.x===t.x&&e.y===t.y}function SR(e,t,n,i){const s=CR(wR(e,t,n)),o=CR(wR(e,t,i)),a=CR(wR(n,i,e)),l=CR(wR(n,i,t));return s!==o&&a!==l||(!(0!==s||!MR(e,n,t))||(!(0!==o||!MR(e,i,t))||(!(0!==a||!MR(n,e,i))||!(0!==l||!MR(n,t,i)))))}function MR(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function CR(e){return e>0?1:e<0?-1:0}function PR(e,t){return wR(e.prev,e,e.next)<0?wR(e,t,e.next)>=0&&wR(e,e.prev,t)>=0:wR(e,t,e.prev)<0||wR(e,e.next,t)<0}function IR(e,t){const n=ER(e.i,e.x,e.y),i=ER(t.i,t.x,t.y),s=e.next,o=t.prev;return e.next=t,t.prev=e,n.next=s,s.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function kR(e,t,n,i){const s=ER(e,t,n);return i?(s.next=i.next,s.prev=i,i.next.prev=s,i.next=s):(s.prev=s,s.next=s),s}function OR(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function ER(e,t,n){return{i:e,x:t,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function RR(e,t,n,i,s){LR(e,t,n||0,i||e.length-1,s||FR)}function LR(e,t,n,i,s){for(;i>n;){if(i-n>600){var o=i-n+1,a=t-n+1,l=Math.log(o),h=.5*Math.exp(2*l/3),c=.5*Math.sqrt(l*h*(o-h)/o)*(a-o/2<0?-1:1);LR(e,t,Math.max(n,Math.floor(t-a*h/o+c)),Math.min(i,Math.floor(t+(o-a)*h/o+c)),s)}var u=e[t],f=n,g=i;for(DR(e,n,t),s(e[i],u)>0&&DR(e,n,i);f<g;){for(DR(e,f,g),f++,g--;s(e[f],u)<0;)f++;for(;s(e[g],u)>0;)g--}0===s(e[n],u)?DR(e,n,g):DR(e,++g,i),g<=t&&(n=g+1),t<=g&&(i=g-1)}}function DR(e,t,n){var i=e[t];e[t]=e[n],e[n]=i}function FR(e,t){return e<t?-1:e>t?1:0}rR.extend=function(e,t){const n=function(){this.init&&this.init()},i=Object.create(iR);i.constructor=n,n.prototype=i,n.type=e;for(const e in t)sR.call(t,e)&&(n.prototype[e]=t[e]);return n.registerAt=oR.bind(n),n};class RBush{constructor(e=9){this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}all(){return this._all(this.data,[])}search(e){let t=this.data;const n=[];if(!XR(e,t))return n;const i=this.toBBox,s=[];for(;t;){for(let o=0;o<t.children.length;o++){const a=t.children[o],l=t.leaf?i(a):a;XR(e,l)&&(t.leaf?n.push(a):ZR(e,l)?this._all(a,n):s.push(a))}t=s.pop()}return n}collides(e){let t=this.data;if(!XR(e,t))return!1;const n=[];for(;t;){for(let i=0;i<t.children.length;i++){const s=t.children[i],o=t.leaf?this.toBBox(s):s;if(XR(e,o)){if(t.leaf||ZR(e,o))return!0;n.push(s)}}t=n.pop()}return!1}load(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(let t=0;t<e.length;t++)this.insert(e[t]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===t.height)this._splitRoot(this.data,t);else{if(this.data.height<t.height){const e=this.data;this.data=t,t=e}this._insert(t,this.data.height-t.height-1,!0)}else this.data=t;return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=YR([]),this}remove(e,t){if(!e)return this;let n=this.data;const i=this.toBBox(e),s=[],o=[];let a,l,h;for(;n||s.length;){if(n||(n=s.pop(),l=s[s.length-1],a=o.pop(),h=!0),n.leaf){const i=HR(e,n.children,t);if(-1!==i)return n.children.splice(i,1),s.push(n),this._condense(s),this}h||n.leaf||!ZR(n,i)?l?(a++,n=l.children[a],h=!1):n=null:(s.push(n),o.push(a),a=0,l=n,n=n.children[0])}return this}toBBox(e){return e}compareMinX(e,t){return e.minX-t.minX}compareMinY(e,t){return e.minY-t.minY}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,t){const n=[];for(;e;)e.leaf?t.push(...e.children):n.push(...e.children),e=n.pop();return t}_build(e,t,n,i){const s=n-t+1;let o,a=this._maxEntries;if(s<=a)return o=YR(e.slice(t,n+1)),NR(o,this.toBBox),o;i||(i=Math.ceil(Math.log(s)/Math.log(a)),a=Math.ceil(s/Math.pow(a,i-1))),o=YR([]),o.leaf=!1,o.height=i;const l=Math.ceil(s/a),h=l*Math.ceil(Math.sqrt(a));JR(e,t,n,h,this.compareMinX);for(let s=t;s<=n;s+=h){const t=Math.min(s+h-1,n);JR(e,s,t,l,this.compareMinY);for(let n=s;n<=t;n+=l){const s=Math.min(n+l-1,t);o.children.push(this._build(e,n,s,i-1))}}return NR(o,this.toBBox),o}_chooseSubtree(e,t,n,i){for(;i.push(t),!t.leaf&&i.length-1!==n;){let n,i=1/0,s=1/0;for(let o=0;o<t.children.length;o++){const a=t.children[o],l=VR(a),h=WR(e,a)-l;h<s?(s=h,i=l<i?l:i,n=a):h===s&&l<i&&(i=l,n=a)}t=n||t.children[0]}return t}_insert(e,t,n){const i=n?e:this.toBBox(e),s=[],o=this._chooseSubtree(i,this.data,t,s);for(o.children.push(e),zR(o,i);t>=0&&s[t].children.length>this._maxEntries;)this._split(s,t),t--;this._adjustParentBBoxes(i,s,t)}_split(e,t){const n=e[t],i=n.children.length,s=this._minEntries;this._chooseSplitAxis(n,s,i);const o=this._chooseSplitIndex(n,s,i),a=YR(n.children.splice(o,n.children.length-o));a.height=n.height,a.leaf=n.leaf,NR(n,this.toBBox),NR(a,this.toBBox),t?e[t-1].children.push(a):this._splitRoot(n,a)}_splitRoot(e,t){this.data=YR([e,t]),this.data.height=e.height+1,this.data.leaf=!1,NR(this.data,this.toBBox)}_chooseSplitIndex(e,t,n){let i,s=1/0,o=1/0;for(let a=t;a<=n-t;a++){const t=BR(e,0,a,this.toBBox),l=BR(e,a,n,this.toBBox),h=qR(t,l),c=VR(t)+VR(l);h<s?(s=h,i=a,o=c<o?c:o):h===s&&c<o&&(o=c,i=a)}return i||n-t}_chooseSplitAxis(e,t,n){const i=e.leaf?this.compareMinX:GR,s=e.leaf?this.compareMinY:UR;this._allDistMargin(e,t,n,i)<this._allDistMargin(e,t,n,s)&&e.children.sort(i)}_allDistMargin(e,t,n,i){e.children.sort(i);const s=this.toBBox,o=BR(e,0,t,s),a=BR(e,n-t,n,s);let l=jR(o)+jR(a);for(let i=t;i<n-t;i++){const t=e.children[i];zR(o,e.leaf?s(t):t),l+=jR(o)}for(let i=n-t-1;i>=t;i--){const t=e.children[i];zR(a,e.leaf?s(t):t),l+=jR(a)}return l}_adjustParentBBoxes(e,t,n){for(let i=n;i>=0;i--)zR(t[i],e)}_condense(e){for(let t,n=e.length-1;n>=0;n--)0===e[n].children.length?n>0?(t=e[n-1].children,t.splice(t.indexOf(e[n]),1)):this.clear():NR(e[n],this.toBBox)}}function HR(e,t,n){if(!n)return t.indexOf(e);for(let i=0;i<t.length;i++)if(n(e,t[i]))return i;return-1}function NR(e,t){BR(e,0,e.children.length,t,e)}function BR(e,t,n,i,s){s||(s=YR(null)),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(let o=t;o<n;o++){const t=e.children[o];zR(s,e.leaf?i(t):t)}return s}function zR(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function GR(e,t){return e.minX-t.minX}function UR(e,t){return e.minY-t.minY}function VR(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function jR(e){return e.maxX-e.minX+(e.maxY-e.minY)}function WR(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function qR(e,t){const n=Math.max(e.minX,t.minX),i=Math.max(e.minY,t.minY),s=Math.min(e.maxX,t.maxX),o=Math.min(e.maxY,t.maxY);return Math.max(0,s-n)*Math.max(0,o-i)}function ZR(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function XR(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function YR(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function JR(e,t,n,i,s){const o=[t,n];for(;o.length;){if((n=o.pop())-(t=o.pop())<=i)continue;const a=t+Math.ceil((n-t)/i/2)*i;RR(e,a,t,n,s),o.push(t,a,a,n)}}
/*!
   * @maptalks/vt v0.109.0
   * LICENSE : undefined
   * (c) 2016-2025 maptalks.org
   */const QR="${",$R=`function(t){let e;const n={width:100,height:10};let r=!1;try{const t=new OffscreenCanvas(1,1);t.getContext("2d").fillText("hello",0,0),r=!0}catch(t){r=!1}function i(){if(!e){const{width:t,height:i}=n;r?e=new OffscreenCanvas(t,i):(e=document.createElement("canvas"),e.width=t,e.height=i)}return e}class o{constructor(t,e={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let r=1/0,i=-1/0;for(let e=0,n=t.length;e<n;e++){const n=t[e][0];r=Math.min(n,r),i=Math.max(n,i)}this.min=r,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},n,e),this._initImgData()}getImageData(){return this.imgData}_initImgData(){const t=i(),{width:e,height:n}=this.options;t.width=e,t.height=n;const r=t.getContext("2d");r.clearRect(0,0,t.width,t.height);const o=r.createLinearGradient(0,0,t.width,0),{colors:s,valueOffset:a}=this;for(let t=0,e=s.length;t<e;t++){const[e,n]=s[t],r=(e-this.min)/a;o.addColorStop(r,n)}r.fillStyle=o,r.fillRect(0,0,t.width,t.height),this.imgData=r.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t);const e=((t=Math.min(t,this.max))-this.min)/this.valueOffset;let n=Math.round(e*this.imgData.width);n=Math.min(n,this.imgData.width-1);const r=4*n;return[this.imgData.data[r],this.imgData.data[r+1],this.imgData.data[r+2],this.imgData.data[r+3]]}}var s;function a(t){return null==t}function l(t){return!a(t)}function u(t){return""===t}function h(t,e){var n,r,i;if(w(t)){var o,s=t.stops&&"object"==typeof t.stops[0][0],a=s||l(t.property),u=s||!a,d=t.type||e||"exponential";if("exponential"===d)o=p;else if("interval"===d)o=f;else if("categorical"===d)o=c;else if("identity"===d)o=y;else if("color-interpolate"===d)o=g;else{if("calculate-expression"!==d)throw new Error('Unknown function type "'+d+'"');o=x}if(s){var m={},v=[];for(let e=0;e<t.stops.length;e++){var M=t.stops[e];void 0===m[M[0].zoom]&&(m[M[0].zoom]={zoom:M[0].zoom,type:t.type,property:t.property,default:t.default,stops:[]}),m[M[0].zoom].stops.push([M[0].value,M[1]])}for(let t in m)v.push([m[t].zoom,h(m[t])]);n=function(e,n){const r=p({stops:v,base:t.base},e)(e,n);return"function"==typeof r?r(e,n):r},r=!1,i=!1}else u?(n=function(e){const n=o(t,e);return"function"==typeof n?n(e):n},r=!0,i=!1):(n=function(e,n){const r=o(t,n?n[t.property]:null);return"function"==typeof r?r(e,n):r},r=!1,i=!0)}else n=function(){return t},r=!0,i=!0;return n.isZoomConstant=i,n.isFeatureConstant=r,n}function c(t,e){for(let n=0;n<t.stops.length;n++)if(e===t.stops[n][0])return t.stops[n][1];return t.default}function f(t,e){for(var n=0;n<t.stops.length&&!(e<t.stops[n][0]);n++);return t.stops[Math.max(n-1,0)][1]}function p(t,e){for(var n=l(t.base)&&!u(t.base)?t.base:1,r=0;!(r>=t.stops.length||e<=t.stops[r][0]);)r++;return 0===r?t.stops[r][1]:r===t.stops.length?t.stops[r-1][1]:m(e,n,t.stops[r-1][0],t.stops[r][0],t.stops[r-1][1],t.stops[r][1])}"function"==typeof Map&&(s=new Map);const d={width:100,height:1};function g(t,e){const n=t.stops;if(n&&n.length>1){let t;if(s){const e=JSON.stringify(n);if(!s.has(e)){const t=new o(n,d);s.set(e,t)}t=s.get(e)}else t=new o(n,d);const[r,i,a,l]=t.getColor(e);return[r/255,i/255,a/255,l/255]}return n&&1===n.length?n[0][1]:null}function y(t,e){return n=e,r=t.default,l(n)?n:l(r)?r:l(i)?i:null;var n,r,i}function x(t,e){const n=String(t.property),r=t.expression,i=e;function o(e){return a(e)||u(e)||isNaN(e)?t.default:e}if(!l(e)||u(e)||isNaN(e)||e<0)return o(t.default);{const e=function t(e,n,r){const i=Number(r),o=String(n);return Array.isArray(e)?e.map((e=>t(e,o,i))):e===o?i:e}(r,n,i);return o(function e(n){if(!Array.isArray(n)){if("number"==typeof n)return n;throw new Error("Invalid expression format")}{const r=n[0];if(!["+","-","*","/"].includes(r))throw new Error(\`Unknown operator: ${QR}r}\`);const i=n.slice(1).map((t=>e(t)));switch(r){case"+":return i.reduce(((t,e)=>t+e),0);case"-":return i.reduce(((t,e)=>t-e));case"*":return i.reduce(((t,e)=>t*e),1);case"/":return i.some((t=>0===t))?t.default:i.reduce(((t,e)=>t/e));default:throw new Error(\`Unsupported operator: ${QR}r}\`)}}}(e))}}function m(t,e,n,r,i,o){return"function"==typeof i?function(){var s=i.apply(void 0,arguments),a=o.apply(void 0,arguments);return m(t,e,n,r,s,a)}:i.length?function(t,e,n,r,i,o){var s=[];for(let a=0;a<i.length;a++)s[a]=v(t,e,n,r,i[a],o[a]);return s}(t,e,n,r,i,o):v(t,e,n,r,i,o)}function v(t,e,n,r,i,o){var s,a=r-n,l=t-n;return i*(1-(s=1===e?l/a:(Math.pow(e,l)-1)/(Math.pow(e,a)-1)))+o*s}function w(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type||t.expression&&"calculate-expression"===t.type)}function M(t){return b(t,"interval")}function b(t,e){if(!w(t))return function(){return t};let n=!0,r=!0;const i=(t=JSON.parse(JSON.stringify(t))).stops;if(i)for(let t=0;t<i.length;t++)if(w(i[t][1])){const o=b(i[t][1],e);n=n&&o.isZoomConstant,r=r&&o.isFeatureConstant,i[t]=[i[t][0],o]}const o=h(t,e);return o.isZoomConstant=n&&o.isZoomConstant,o.isFeatureConstant=r&&o.isFeatureConstant,o}let P=0;const _="function"==typeof Object.assign;function I(t,...e){if(_)return Object.assign(t,...e),t;for(let n=0;n<e.length;n++){const r=e[n];for(const e in r)t[e]=r[e]}return t}function A(t){return!k(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function S(t){return"number"==typeof t&&!isNaN(t)}function T(t){return!k(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}function F(t){return!Array.isArray(t)&&"object"==typeof t&&!!t}function k(t){return null==t}function L(t){return w(t)&&t.property}const B="function"==typeof fetch&&"function"==typeof AbortController,C={jsonp:function(t,e){const n="_maptalks_jsonp_"+P++;t.match(/\\?/)?t+="&callback="+n:t+="?callback="+n;let r=document.createElement("script");return r.type="text/javascript",r.src=t,window[n]=function(t){e(null,t),document.getElementsByTagName("head")[0].removeChild(r),r=null,delete window[n]},document.getElementsByTagName("head")[0].appendChild(r),this},get:function(t,e,n){if(T(e)){const t=n;n=e,e=t}let r=(e=e||{}).errorLog;k(r)&&(r=!0),e.method&&(e.method=e.method.toUpperCase());const i="POST"===e.method;if(B){const i=new AbortController,o=e;o.signal=i.signal,o.referrerPolicy=o.referrerPolicy||"origin",o.method=o.method||"GET";const s=new Request(t,o);return e.returnJSON&&s.headers.set("Accept","application/json"),fetch(s).then((i=>{const o=this._parseResponse(i,e.returnJSON,e.responseType);o.message?(o.url=t,n(o)):o.then((t=>{"arraybuffer"===e.responseType?n(null,{data:t,cacheControl:i.headers.get("Cache-Control"),expires:i.headers.get("Expires"),contentType:i.headers.get("Content-Type")}):n(null,t)})).catch((e=>{e.code&&e.code===DOMException.ABORT_ERR||(r&&console.error("Fetch error:",t,e),n(e))}))})).catch((e=>{e.code&&e.code===DOMException.ABORT_ERR||(r&&console.error("Fetch error:",t,e),n(e))})),i}{const r=C._getClient(n);if(r.open(e.method||"GET",t,!0),e){for(const t in e.headers)r.setRequestHeader(t,e.headers[t]);r.withCredentials="include"===e.credentials,e.responseType&&(r.responseType=e.responseType)}return r.send(i?e.body:null),r}},_parseResponse:(t,e,n)=>200!==t.status?{status:t.status,statusText:t.statusText,message:\`incorrect http request with status code(${QR}t.status}): ${QR}t.statusText}\`}:"arraybuffer"===n?t.arrayBuffer():e?t.json():t.text(),_wrapCallback:function(t,e){return function(){if(4===t.readyState)if(200===t.status)if("arraybuffer"===t.responseType){0===t.response.byteLength?e({status:200,statusText:t.statusText,message:"http status 200 returned without content."}):e(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")})}else e(null,t.responseText);else e({status:t.status,statusText:t.statusText,message:\`incorrect http request with status code(${QR}t.status}): ${QR}t.statusText}\`})}},_getClient:function(t){let e;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}}return e.onreadystatechange=C._wrapCallback(e,t),e},getArrayBuffer(t,e,n){if(T(e)){const t=n;n=e,e=t}return e||(e={}),e.responseType="arraybuffer",C.get(t,e,n)}};function Y(t,e,n,r,i=3){let o=r;const s=n-e>>1;let a,l=n-e;const u=t[e],h=t[e+1],c=t[n],f=t[n+1];for(let r=e+i;r<n;r+=i){const e=O(t[r],t[r+1],u,h,c,f);if(e>o)a=r,o=e;else if(e===o){const t=Math.abs(r-s);t<l&&(a=r,l=t)}}o>r&&(a-e>i&&Y(t,e,a,r,i),t[a+2]=o,n-a>i&&Y(t,a,n,r,i))}function O(t,e,n,r,i,o){let s=i-n,a=o-r;if(0!==s||0!==a){const l=((t-n)*s+(e-r)*a)/(s*s+a*a);l>1?(n=i,r=o):l>0&&(n+=s*l,r+=a*l)}return s=t-n,a=e-r,s*s+a*a}function V(t,e,n,r,i,o){const s={id:null==t?null:t,type:e,geometry:n,tags:r,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};i&&(s.layer=i);return function(t,e){const n=t.geometry,r=t.type;if("Point"===r||"MultiPoint"===r||"LineString"===r)X(t,n,e);else if("Polygon"===r)X(t,n[0],e);else if("MultiLineString"===r)for(const r of n)X(t,r,e);else if("MultiPolygon"===r)for(const r of n)X(t,r[0],e)}(s,o?4:3),s}function X(t,e,n){for(let r=0;r<e.length;r+=n)t.minX=Math.min(t.minX,e[r]),t.minY=Math.min(t.minY,e[r+1]),t.maxX=Math.max(t.maxX,e[r]),t.maxY=Math.max(t.maxY,e[r+1])}function E(t,e,n,r){if(r.layer=e,"FeatureCollection"===n.type)for(let e=0;e<n.features.length;e++)N(t,n.features[e],r,e);else"Feature"===n.type?N(t,n,r):N(t,{geometry:n},r)}function N(t,e,n,r){if(!e.geometry)return;const i=e.geometry.coordinates,o=e.geometry.type,s=Math.pow(n.tolerance/((1<<n.maxZoom)*n.extent),2);let a=[],l=e.id;if(n.promoteId?l=e.properties[n.promoteId]:n.generateId&&(l=r||0),"Point"===o)z(i,a,n);else if("MultiPoint"===o)for(const t of i)z(t,a,n);else if("LineString"===o)D(i,a,s,!1,n);else if("MultiLineString"===o){if(n.lineMetrics){for(const r of i)a=[],D(r,a,s,!1,n),t.push(V(l,"LineString",a,e.properties,n.layer,n.hasAltitude));return}$(i,a,s,!1,n)}else if("Polygon"===o)$(i,a,s,!0,n);else{if("MultiPolygon"!==o){if("GeometryCollection"===o){for(const i of e.geometry.geometries)N(t,{id:l,geometry:i,properties:e.properties},n,r);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const t of i){const e=[];$(t,e,s,!0,n),a.push(e)}}t.push(V(l,o,a,e.properties,n.layer,n.hasAltitude))}function z(t,e,n){e.push(q(t[0]),j(t[1],n.projection),0),n.hasAltitude&&(t.length>2?e.push(t[2]):e.push(0))}function D(t,e,n,r,i){let o,s,a=0;for(let n=0;n<t.length;n++){const l=q(t[n][0]),u=j(t[n][1],i.projection);e.push(l,u,0),i.hasAltitude&&(t[n].length>2?e.push(t[n][2]):e.push(0)),n>0&&(a+=r?(o*u-l*s)/2:Math.sqrt(Math.pow(l-o,2)+Math.pow(u-s,2))),o=l,s=u}const l=i.hasAltitude?4:3,u=e.length-l;e[2]=1,Y(e,0,u,n,l),e[u+2]=1,e.size=Math.abs(a),e.start=0,e.end=e.size}function $(t,e,n,r,i){for(let o=0;o<t.length;o++){const s=[];D(t[o],s,n,r,i),e.push(s)}}function q(t){return t/360+.5}function j(t,e){if("EPSG:4326"===e)return(90-t)/360;const n=Math.sin(t*Math.PI/180),r=.5-.25*Math.log((1+n)/(1-n))/Math.PI;return r<0?0:r>1?1:r}function G(t,e,n,r,i,o,s,a){if(r/=e,o>=(n/=e)&&s<r)return t;if(s<n||o>=r)return null;const l=[];for(const e of t){const t=e.geometry;let o=e.type;const s=0===i?e.minX:e.minY,u=0===i?e.maxX:e.maxY;if(s>=n&&u<r){l.push(e);continue}if(u<n||s>=r)continue;let h=[];if("Point"===o||"MultiPoint"===o)Z(t,h,n,r,i,a.hasAltitude);else if("LineString"===o)U(t,h,n,r,i,!1,a.lineMetrics,a.hasAltitude);else if("MultiLineString"===o)J(t,h,n,r,i,!1,a.hasAltitude);else if("Polygon"===o)J(t,h,n,r,i,!0,a.hasAltitude);else if("MultiPolygon"===o)for(const e of t){const t=[];J(e,t,n,r,i,!0,a.hasAltitude),t.length&&h.push(t)}if(h.length){if(a.lineMetrics&&"LineString"===o){for(const t of h)l.push(V(e.id,o,t,e.tags,e.layer,a.hasAltitude));continue}"LineString"!==o&&"MultiLineString"!==o||(1===h.length?(o="LineString",h=h[0]):o="MultiLineString"),"Point"!==o&&"MultiPoint"!==o||(o=3===h.length?"Point":"MultiPoint"),l.push(V(e.id,o,h,e.tags,e.layer,a.hasAltitude))}}return l.length?l:null}function Z(t,e,n,r,i,o){const s=o?4:3;for(let a=0;a<t.length;a+=s){const s=t[a+i];s>=n&&s<=r&&(H(e,t[a],t[a+1],t[a+2]),o&&e.push(t[a+3]))}}function U(t,e,n,r,i,o,s,a){let l=R(t);const u=0===i?W:K;let h,c,f=t.start;const p=a?4:3,d=o?t.length:t.length-p;for(let g=0;g<d;g+=p){const y=t[g],x=t[g+1],m=t[g+2];let v,w,M,b;o&&g===d-p?(v=t[0],w=t[1]):(v=t[g+p],w=t[g+p+1]),a&&(M=t[g+3],b=o&&g===d-p?t[3]:t[g+p+3]);const P=0===i?y:x,_=0===i?v:w;let I=!1;s&&(h=Math.sqrt(Math.pow(y-v,2)+Math.pow(x-w,2))),P<n?_>n&&(c=u(l,y,x,v,w,n),a&&l.push(Q(M,b,c)),s&&(l.start=f+h*c)):P>r?_<r&&(c=u(l,y,x,v,w,r),a&&l.push(Q(M,b,c)),s&&(l.start=f+h*c)):(H(l,y,x,m),a&&l.push(M)),_<n&&P>=n&&(c=u(l,y,x,v,w,n),a&&l.push(Q(M,b,c)),I=!0),_>r&&P<=r&&(c=u(l,y,x,v,w,r),a&&l.push(Q(M,b,c)),I=!0),!o&&I&&(s&&(l.end=f+h*c),e.push(l),l=R(t)),s&&(f+=h)}let g=t.length-p;if(!o){const e=t[g],o=t[g+1],s=t[g+2],u=0===i?e:o;if(u>=n&&u<=r&&H(l,e,o,s),u>=n&&u<=r&&a){const e=t[g+3];l.push(e)}}g=l.length-p,o&&g>=p&&(l[g]!==l[0]||l[g+1]!==l[1])&&(H(l,l[0],l[1],l[2]),a&&l.push(l[3])),l.length&&e.push(l)}function R(t){const e=[];return e.size=t.size,e.start=t.start,e.end=t.end,e}function J(t,e,n,r,i,o,s){for(const a of t)U(a,e,n,r,i,o,!1,s)}function H(t,e,n,r){t.push(e,n,r)}function W(t,e,n,r,i,o){const s=(o-e)/(r-e);return H(t,o,n+(i-n)*s,1),s}function K(t,e,n,r,i,o){const s=(o-n)/(i-n);return H(t,e+(r-e)*s,o,1),s}function Q(t,e,n){return t+(e-t)*n}function tt(t,e,n){const r=[];for(let i=0;i<t.length;i++){const o=t[i],s=o.type;let a;if("Point"===s||"MultiPoint"===s||"LineString"===s)a=et(o.geometry,e,n);else if("MultiLineString"===s||"Polygon"===s){a=[];for(const t of o.geometry)a.push(et(t,e,n))}else if("MultiPolygon"===s){a=[];for(const t of o.geometry){const r=[];for(const i of t)r.push(et(i,e,n));a.push(r)}}r.push(V(o.id,s,a,o.tags,o.layer,n))}return r}function et(t,e,n){const r=[];r.size=t.size,void 0!==t.start&&(r.start=t.start,r.end=t.end);const i=n?4:3;for(let o=0;o<t.length;o+=i)r.push(t[o]+e,t[o+1],t[o+2]),n&&r.push(t[o+3]);return r}function nt(t,e,n){if(t.transformed)return t;const r=1<<t.z,i=t.x,o=t.y,s=n?3:2;for(const a of t.features){const t=a.geometry,l=a.type;if(a.geometry=[],1===l)for(let l=0;l<t.length;l+=s)a.geometry.push(rt(t[l],t[l+1],e,r,i,o)),n&&a.geometry[a.geometry.length-1].push(t[l+2]);else for(let l=0;l<t.length;l++){const u=[];for(let a=0;a<t[l].length;a+=s)u.push(rt(t[l][a],t[l][a+1],e,r,i,o)),n&&u[u.length-1].push(t[l][a+2]);a.geometry.push(u)}}return t.transformed=!0,t}function rt(t,e,n,r,i,o){return[Math.round(n*(t*r-i)),Math.round(n*(e*r-o))]}function it(t,e,n,r,i){const o=e===i.maxZoom?0:i.tolerance/((1<<e)*i.extent),s={features:[],numPoints:0,numSimplified:0,numFeatures:t.length,source:null,x:n,y:r,z:e,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const e of t)ot(s,e,o,i);return s}function ot(t,e,n,r){const i=e.geometry,o=e.type,s=[],a=r.hasAltitude?4:3;if(t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),"Point"===o||"MultiPoint"===o)for(let e=0;e<i.length;e+=a)s.push(i[e],i[e+1]),r.hasAltitude&&s.push(i[e+3]),t.numPoints++,t.numSimplified++;else if("LineString"===o)at(s,i,t,n,!1,!1,r);else if("MultiLineString"===o||"Polygon"===o)for(let e=0;e<i.length;e++)at(s,i[e],t,n,"Polygon"===o,0===e,r);else if("MultiPolygon"===o)for(let e=0;e<i.length;e++){const o=i[e];for(let e=0;e<o.length;e++)at(s,o[e],t,n,!0,0===e,r)}if(s.length){let n=e.tags||null;if("LineString"===o&&r.lineMetrics){n={};for(const t in e.tags)n[t]=e.tags[t];n.mapbox_clip_start=i.start/i.size,n.mapbox_clip_end=i.end/i.size}const a={geometry:s,type:"Polygon"===o||"MultiPolygon"===o?3:"LineString"===o||"MultiLineString"===o?2:1,tags:n};e.layer&&(a.layer=e.layer),null!==e.id&&(a.id=e.id),t.features.push(a)}}function st(t,e,n){return 0===t[e+2]&&t[e+3]>0&&n}function at(t,e,n,r,i,o,s){const a=r*r,{hasAltitude:l,disableFilter:u}=s,h=l?4:3;if(!u&&r>0&&e.size<(i?a:r))return void(n.numPoints+=e.length/h);const c=[];for(let t=0;t<e.length;t+=h)(0===r||e[t+2]>a||st(e,t,l))&&(n.numSimplified++,c.push(e[t],e[t+1]),l&&c.push(e[t+3])),n.numPoints++;i&&function(t,e,n){const r=n?3:2;let i=0;for(let e=0,n=t.length,o=n-r;e<n;o=e,e+=r)i+=(t[e]-t[o])*(t[e+1]+t[o+1]);if(i>0===e){const e=r,i=r-1,o=r-2;for(let s=0,a=t.length;s<a/2;s+=r){const r=t[s],l=t[s+1];let u;n&&(u=t[s+2]),t[s]=t[a-e-s],t[s+1]=t[a-i-s],n&&(t[s+2]=t[a-o-s]),t[a-e-s]=r,t[a-i-s]=l,n&&(t[a-o-s]=u)}}}(c,o,l),t.push(c)}C.getJSON=function(t,e,n){if(T(e)){const t=n;n=e,e=t}const r=function(t,e){const r="string"==typeof e?JSON.parse(e):e||null;n(t,r)};return e&&e.jsonp?C.jsonp(t,r):((e=e||{}).returnJSON=!0,C.get(t,e,r))};const lt={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,hasAltitude:!1,disableFilter:!1,debug:0};class ut{constructor(t,e){const n=(e=this.options=function(t,e){for(const n in e)t[n]=e[n];return t}(Object.create(lt),e)).debug;if(n&&console.time("preprocess data"),e.maxZoom<0||e.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(e.promoteId&&e.generateId)throw new Error("promoteId and generateId cannot be used together.");let r=function(t,e){const n=[];if(Array.isArray(t)){for(let r=0;r<t.length;r++)E(n,t[r].layer,t[r].data,e);return n}if("FeatureCollection"===t.type)for(let r=0;r<t.features.length;r++)N(n,t.features[r],e,r);else"Feature"===t.type?N(n,t,e):N(n,{geometry:t},e);return n}(t,e);this.tiles={},this.tileCoords=[],n&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",e.indexMaxZoom,e.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),r=function(t,e){const n=e.buffer/e.extent;let r=t;const i=G(t,1,-1-n,n,0,-1,2,e),o=G(t,1,1-n,2+n,0,-1,2,e);return(i||o)&&(r=G(t,1,-n,1+n,0,-1,2,e)||[],i&&(r=tt(i,1,e.hasAltitude).concat(r)),o&&(r=r.concat(tt(o,-1,e.hasAltitude)))),r}(r,e),r.length&&this.splitTile(r,0,0,0),n&&(r.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(t,e,n,r,i,o,s){const a=[t,e,n,r],l=this.options,u=l.debug;for(;a.length;){r=a.pop(),n=a.pop(),e=a.pop(),t=a.pop();const h=1<<e,c=ht(e,n,r);let f=this.tiles[c];if(!f&&(u>1&&console.time("creation"),f=this.tiles[c]=it(t,e,n,r,l),this.tileCoords.push({z:e,x:n,y:r}),u)){u>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",e,n,r,f.numFeatures,f.numPoints,f.numSimplified),console.timeEnd("creation"));const t=\`z${QR}e}\`;this.stats[t]=(this.stats[t]||0)+1,this.total++}if(f.source=t,null==i){if(e===l.indexMaxZoom||f.numPoints<=l.indexMaxPoints)continue}else{if(e===l.maxZoom||e===i)continue;if(null!=i){const t=i-e;if(n!==o>>t||r!==s>>t)continue}}if(f.source=null,0===t.length)continue;u>1&&console.time("clipping");const p=.5*l.buffer/l.extent,d=.5-p,g=.5+p,y=1+p;let x=null,m=null,v=null,w=null,M=G(t,h,n-p,n+g,0,f.minX,f.maxX,l),b=G(t,h,n+d,n+y,0,f.minX,f.maxX,l);t=null,M&&(x=G(M,h,r-p,r+g,1,f.minY,f.maxY,l),m=G(M,h,r+d,r+y,1,f.minY,f.maxY,l),M=null),b&&(v=G(b,h,r-p,r+g,1,f.minY,f.maxY,l),w=G(b,h,r+d,r+y,1,f.minY,f.maxY,l),b=null),u>1&&console.timeEnd("clipping"),a.push(x||[],e+1,2*n,2*r),a.push(m||[],e+1,2*n,2*r+1),a.push(v||[],e+1,2*n+1,2*r),a.push(w||[],e+1,2*n+1,2*r+1)}}getTile(t,e,n){t=+t,e=+e,n=+n;const r=this.options,{extent:i,debug:o}=r,{hasAltitude:s,wrapX:a}=r;if(t<0||t>24)return null;if(a){const n=1<<t;e=e+n&n-1}const l=ht(t,e,n);if(this.tiles[l])return nt(this.tiles[l],i,s);o>1&&console.log("drilling down to z%d-%d-%d",t,e,n);let u,h=t,c=e,f=n;for(;!u&&h>0;)h--,c>>=1,f>>=1,u=this.tiles[ht(h,c,f)];return u&&u.source?(o>1&&(console.log("found parent tile z%d-%d-%d",h,c,f),console.time("drilling down")),this.splitTile(u.source,h,c,f,t,e,n),o>1&&console.timeEnd("drilling down"),this.tiles[l]?nt(this.tiles[l],i,s):null):null}}function ht(t,e,n){return 32*((1<<t)*n+e)+t}function ct(t,e,n,r,i,o,s){const a=n&&Array.isArray(n[0]);for(let l=0,u=n.length;l<u;l++){t[e]=(a?n[l][0]:n[l].x)*r,t[e+1]=(a?n[l][1]:n[l].y)*r,s!==Float32Array&&(t[e]=Math.round(t[e]),t[e+1]=Math.round(t[e+1]));let h=i||0;Array.isArray(i)&&(h=i[l]),h=h?Math.round(r*h):0,t[e+2]=h,e+=3,o&&0!==l&&l!==u-1&&(t[e]=t[e-3],t[e+1]=t[e-2],t[e+2]=t[e-1],e+=3)}return t.trySetLength&&t.trySetLength(e),e}function ft(t,e,n,r){const i=t[3*e],o=t[3*e+1],s=t[3*n],a=t[3*n+1];return i===s&&(i<0||i>r)||o===a&&(o<0||o>r)}var pt="undefined"!=typeof Float32Array?Float32Array:Array;function dt(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function gt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function yt(t,e,n,r,i){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t}function xt(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t[3]=e[3]/n[3],t}function mt(t,e,n){return t[0]=e,t[1]=n,t}function vt(t,e){var n=e[0]-t[0],r=e[1]-t[1];return Math.hypot(n,r)}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),function(){var t,e=(t=new pt(3),pt!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t)}(),function(){var t,e=(t=new pt(4),pt!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}(),function(){var t,e=(t=new pt(2),pt!=Float32Array&&(t[0]=0,t[1]=0),t)}();const wt=Math.PI/180,Mt=6378137*Math.PI/180,bt=85.0511287798;function Pt(t,e,n){if("EPSG:3857"===n)return function(t,e){const n=bt,r=e[0],i=Math.max(Math.min(n,e[1]),-n);let o;o=0===i?0:Math.log(Math.tan((90+i)*wt/2))/wt;return t[0]=r*Mt,t[1]=o*Mt,t}(t,e);if("EPSG:4326"===n||"EPSG:4490"===n||"identity"===n)return _t(t,e);if("baidu"===n)return _t(t,e);throw new Error("unsupported projection:"+n)}function _t(t,e){return t[0]=e[0],t[1]=e[1],t}function It(t,e,n,r,i,o,s,a,l,u,h,c,f,p,d){0===t?function(t,e,n,r,i,o,s,a,l,u){const h=1/(100*o[0]),c=1/(100*o[1]),f=u&&u[0]||0,p=u&&u[1]||0,d=[0,0];for(let i=t;i<e;i+=3){const t=i/3*2,e=r[i]-f,o=r[i+1]-p;n[t]=d[0]+e/s*h/a,n[t+1]=d[1]-o/s*c/l}}(e,n,r,i,0,s,a,l,u,d):1===t&&function(t,e,n,r,i,o,s,a,l,u,h){if(!t)return;let c,f,p,d;0===t[4]?(c=t[0],f=t[1],p=t[2],d=t[3]):(c=t[1],f=t[2],p=t[3],d=t[0]);const g=vt(c,f),y=vt(f,p),x=[],m=[],v=[];for(let t=e;t<n;t+=3){const e=t/3*2;mt(x,(o.x/l+i[t]/s)*a,o.y/l*a+(h?i[t+1]:-i[t+1])/s*a),"EPSG:4326"!==u&&"EPSG:4490"!==u||Pt(x,x,"EPSG:3857"),At(m,x,c,f),At(v,x,d,c),r[e]=vt(c,m)/g,r[e+1]=vt(c,v)/y}}(h,e,n,r,i,o,a,c,f,p,!!d)}function At(t,e,n,r){const i=n[0]-r[0],o=n[1]-r[1];let s=(e[0]-n[0])*(n[0]-r[0])+(e[1]-n[1])*(n[1]-r[1]);return s/=i*i+o*o,t[0]=n[0]+s*i,t[1]=n[1]+s*o,t}function St(t,e,n,r,i){const o=3*e[n-1],s=3*e[n-1]+1,a=t[o],l=t[s];return u=r,h=i,c=a,f=l,Math.sqrt((c-u)*(c-u)+(f-h)*(f-h));var u,h,c,f}function Tt(t,e,n=2){const r=e&&e.length,i=r?e[0]*n:t.length;let o=Ft(t,0,i,n,!0);const s=[];if(!o||o.next===o.prev)return s;let a,l,u;if(r&&(o=function(t,e,n,r){const i=[];for(let n=0,o=e.length;n<o;n++){const s=Ft(t,e[n]*r,n<o-1?e[n+1]*r:t.length,r,!1);s===s.next&&(s.steiner=!0),i.push(zt(s))}i.sort(Vt);for(let t=0;t<i.length;t++)n=Xt(i[t],n);return n}(t,e,o,n)),t.length>80*n){a=1/0,l=1/0;let e=-1/0,r=-1/0;for(let o=n;o<i;o+=n){const n=t[o],i=t[o+1];n<a&&(a=n),i<l&&(l=i),n>e&&(e=n),i>r&&(r=i)}u=Math.max(e-a,r-l),u=0!==u?32767/u:0}return Lt(o,s,n,a,l,u,0),s}function Ft(t,e,n,r,i){let o;if(i===function(t,e,n,r){let i=0;for(let o=e,s=n-r;o<n;o+=r)i+=(t[s]-t[o])*(t[o+1]+t[s+1]),s=o;return i}(t,e,n,r)>0)for(let i=e;i<n;i+=r)o=Wt(i/r|0,t[i],t[i+1],o);else for(let i=n-r;i>=e;i-=r)o=Wt(i/r|0,t[i],t[i+1],o);return o&&Gt(o,o.next)&&(Kt(o),o=o.next),o}function kt(t,e){if(!t)return t;e||(e=t);let n,r=t;do{if(n=!1,r.steiner||!Gt(r,r.next)&&0!==jt(r.prev,r,r.next))r=r.next;else{if(Kt(r),r=e=r.prev,r===r.next)break;n=!0}}while(n||r!==e);return e}function Lt(t,e,n,r,i,o,s){if(!t)return;!s&&o&&function(t,e,n,r){let i=t;do{0===i.z&&(i.z=Nt(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){let e,n=1;do{let r,i=t;t=null;let o=null;for(e=0;i;){e++;let s=i,a=0;for(let t=0;t<n&&(a++,s=s.nextZ,s);t++);let l=n;for(;a>0||l>0&&s;)0!==a&&(0===l||!s||i.z<=s.z)?(r=i,i=i.nextZ,a--):(r=s,s=s.nextZ,l--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;i=s}o.nextZ=null,n*=2}while(e>1)}(i)}(t,r,i,o);let a=t;for(;t.prev!==t.next;){const l=t.prev,u=t.next;if(o?Ct(t,r,i,o):Bt(t))e.push(l.i,t.i,u.i),Kt(t),t=u.next,a=u.next;else if((t=u)===a){s?1===s?Lt(t=Yt(kt(t),e),e,n,r,i,o,2):2===s&&Ot(t,e,n,r,i,o):Lt(kt(t),e,n,r,i,o,1);break}}}function Bt(t){const e=t.prev,n=t,r=t.next;if(jt(e,n,r)>=0)return!1;const i=e.x,o=n.x,s=r.x,a=e.y,l=n.y,u=r.y,h=Math.min(i,o,s),c=Math.min(a,l,u),f=Math.max(i,o,s),p=Math.max(a,l,u);let d=r.next;for(;d!==e;){if(d.x>=h&&d.x<=f&&d.y>=c&&d.y<=p&&$t(i,a,o,l,s,u,d.x,d.y)&&jt(d.prev,d,d.next)>=0)return!1;d=d.next}return!0}function Ct(t,e,n,r){const i=t.prev,o=t,s=t.next;if(jt(i,o,s)>=0)return!1;const a=i.x,l=o.x,u=s.x,h=i.y,c=o.y,f=s.y,p=Math.min(a,l,u),d=Math.min(h,c,f),g=Math.max(a,l,u),y=Math.max(h,c,f),x=Nt(p,d,e,n,r),m=Nt(g,y,e,n,r);let v=t.prevZ,w=t.nextZ;for(;v&&v.z>=x&&w&&w.z<=m;){if(v.x>=p&&v.x<=g&&v.y>=d&&v.y<=y&&v!==i&&v!==s&&$t(a,h,l,c,u,f,v.x,v.y)&&jt(v.prev,v,v.next)>=0)return!1;if(v=v.prevZ,w.x>=p&&w.x<=g&&w.y>=d&&w.y<=y&&w!==i&&w!==s&&$t(a,h,l,c,u,f,w.x,w.y)&&jt(w.prev,w,w.next)>=0)return!1;w=w.nextZ}for(;v&&v.z>=x;){if(v.x>=p&&v.x<=g&&v.y>=d&&v.y<=y&&v!==i&&v!==s&&$t(a,h,l,c,u,f,v.x,v.y)&&jt(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;w&&w.z<=m;){if(w.x>=p&&w.x<=g&&w.y>=d&&w.y<=y&&w!==i&&w!==s&&$t(a,h,l,c,u,f,w.x,w.y)&&jt(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}function Yt(t,e){let n=t;do{const r=n.prev,i=n.next.next;!Gt(r,i)&&Zt(r,n,n.next,i)&&Jt(r,i)&&Jt(i,r)&&(e.push(r.i,n.i,i.i),Kt(n),Kt(n.next),n=t=i),n=n.next}while(n!==t);return kt(n)}function Ot(t,e,n,r,i,o){let s=t;do{let t=s.next.next;for(;t!==s.prev;){if(s.i!==t.i&&qt(s,t)){let a=Ht(s,t);return s=kt(s,s.next),a=kt(a,a.next),Lt(s,e,n,r,i,o,0),void Lt(a,e,n,r,i,o,0)}t=t.next}s=s.next}while(s!==t)}function Vt(t,e){let n=t.x-e.x;if(0===n&&(n=t.y-e.y,0===n)){n=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)}return n}function Xt(t,e){const n=function(t,e){let n=e;const r=t.x,i=t.y;let o,s=-1/0;if(Gt(t,n))return n;do{if(Gt(t,n.next))return n.next;if(i<=n.y&&i>=n.next.y&&n.next.y!==n.y){const t=n.x+(i-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=r&&t>s&&(s=t,o=n.x<n.next.x?n:n.next,t===r))return o}n=n.next}while(n!==e);if(!o)return null;const a=o,l=o.x,u=o.y;let h=1/0;n=o;do{if(r>=n.x&&n.x>=l&&r!==n.x&&Dt(i<u?r:s,i,l,u,i<u?s:r,i,n.x,n.y)){const e=Math.abs(i-n.y)/(r-n.x);Jt(n,t)&&(e<h||e===h&&(n.x>o.x||n.x===o.x&&Et(o,n)))&&(o=n,h=e)}n=n.next}while(n!==a);return o}(t,e);if(!n)return e;const r=Ht(n,t);return kt(r,r.next),kt(n,n.next)}function Et(t,e){return jt(t.prev,t,e.prev)<0&&jt(e.next,t,t.next)<0}function Nt(t,e,n,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*i|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function zt(t){let e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function Dt(t,e,n,r,i,o,s,a){return(i-s)*(e-a)>=(t-s)*(o-a)&&(t-s)*(r-a)>=(n-s)*(e-a)&&(n-s)*(o-a)>=(i-s)*(r-a)}function $t(t,e,n,r,i,o,s,a){return!(t===s&&e===a)&&Dt(t,e,n,r,i,o,s,a)}function qt(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&Zt(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(Jt(t,e)&&Jt(e,t)&&function(t,e){let n=t,r=!1;const i=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(jt(t.prev,t,e.prev)||jt(t,e.prev,e))||Gt(t,e)&&jt(t.prev,t,t.next)>0&&jt(e.prev,e,e.next)>0)}function jt(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function Gt(t,e){return t.x===e.x&&t.y===e.y}function Zt(t,e,n,r){const i=Rt(jt(t,e,n)),o=Rt(jt(t,e,r)),s=Rt(jt(n,r,t)),a=Rt(jt(n,r,e));return i!==o&&s!==a||(!(0!==i||!Ut(t,n,e))||(!(0!==o||!Ut(t,r,e))||(!(0!==s||!Ut(n,t,r))||!(0!==a||!Ut(n,e,r)))))}function Ut(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function Rt(t){return t>0?1:t<0?-1:0}function Jt(t,e){return jt(t.prev,t,t.next)<0?jt(t,e,t.next)>=0&&jt(t,t.prev,e)>=0:jt(t,e,t.prev)<0||jt(t,t.next,e)<0}function Ht(t,e){const n=Qt(t.i,t.x,t.y),r=Qt(e.i,e.x,e.y),i=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=i,i.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function Wt(t,e,n,r){const i=Qt(t,e,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function Kt(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Qt(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}const te="__fea_idx";new Float32Array([-1e12])[0];const ee="maptalks_ombb";function ne(){return function(){if("undefined"!=typeof undefinedThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof undefined)return global;throw new Error("unable to locate global object")}().maptalks_vt_packers}const{PackUtil:re,ArrayPool:ie}=ne();function oe(t,e,n,r,i,o,s,a,l,u,h,c,f,p,d,g,y){const x=e.getLength(),m=i/3;for(let n=2,r=x;n<r;n+=3)t[i+n-2]=e[n-2],t[i+n-1]=e[n-1],t[i+n-0]=e[n]-s;i+=x;for(let n=2,r=x;n<r;n+=3)t[i+n-2]=e[n-2],t[i+n-1]=e[n-1],t[i+n-0]=e[n]-a;i+=x,t.trySetLength(i+x),t.copyWithin(i,i-2*x,i-x),i+=x,t.trySetLength(i+x),t.copyWithin(i,i-2*x,i-x),i+=x,(n=n||[]).push(x/3);const v=n.getLength();for(let e=0;e<v;e++){se(m+(n[e-1]||0),m+n[e],t,x/3,l,r,u,h,c,f,o,p,d,g,y)}return i}function se(t,e,n,r,i,o,s,a,l,u,h,c,f,p,d){const g=o.getLength();let y,x;for(let s=t,a=e;s<a-1;s++)if(y=s,x=s+1,i===1/0||!ft(n,y,x,i))if((s-t)%2==1&&(y+=2*r,x+=2*r),d){let t=o.currentIndex;o[t++]=y+r,o[t++]=x,o[t++]=y,o[t++]=x+r,o[t++]=x,o[t++]=y+r,o.currentIndex=t}else{let t=o.currentIndex;o[t++]=y+r,o[t++]=y,o[t++]=x,o[t++]=x,o[t++]=x+r,o[t++]=y+r,o.currentIndex=t}s&&function(t,e,n,r,i,o,s,a,l,u,h,c){let f,p=0,d=0,g=0,y=0;const x=c?[1,3,4]:[2,3,4];for(let c=o.getLength()-1;c>=s;c--){const s=o[c],m=3*s+1,v=3*s+2,w=i[3*s],M=i[m],b=i[v];p||d||(p=Math.max(i[v],i[3*o[c-3]+2]),d=Math.min(i[v],i[3*o[c-3]+2]),f=p-d);let P=g;const _=c%6;0===t?(5===_&&(y=St(i,o,c,w,M)),P=_===x[0]||_===x[1]||_===x[2]?g:g+y):1===t&&(_===x[0]||_===x[1]||_===x[2]?P=0:5===_?(y=St(i,o,c,w,M),P=y):P=y);const I=P/u*(1/(100*h))/a;let A;A=1===e?b===p?1:0:"bottom"===n?b===p?f/100/l:0:b===p?0:-f/100/l,r[2*s]=I,r[2*s+1]=A,0===_&&(g+=y)}}(a,l,u,h,n,o,g,c[0],c[1],f,p,d)}function ae(t){const e=[t[0]];let n=t[0];for(let r=1;r<t.length;r++)Array.isArray(t[r])?t[r][0]===n[0]&&t[r][1]===n[1]&&t[r][2]===n[2]||e.push(t[r]):t[r].x===n.x&&t[r].y===n.y&&t[r].z===n.z||e.push(t[r]),n=t[r];return e}var le="undefined"!=typeof Float32Array?Float32Array:Array;function ue(){var t=new le(3);return le!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function he(t,e,n){var r=new le(3);return r[0]=t,r[1]=e,r[2]=n,r}function ce(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function fe(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function pe(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function de(t,e){var n=e[0],r=e[1],i=e[2],o=n*n+r*r+i*i;return o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o),t}function ge(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function ye(t,e,n){var r=e[0],i=e[1],o=e[2],s=n[0],a=n[1],l=n[2];return t[0]=i*l-o*a,t[1]=o*s-r*l,t[2]=r*a-i*s,t}var xe=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t};function me(){var t=new le(4);return le!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function ve(t,e){var n=e[0]+e[4]+e[8],r=void 0;if(n>0)r=Math.sqrt(n+1),t[3]=.5*r,r=.5/r,t[0]=(e[5]-e[7])*r,t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[3*i+i]&&(i=2);var o=(i+1)%3,s=(i+2)%3;r=Math.sqrt(e[3*i+i]-e[3*o+o]-e[3*s+s]+1),t[i]=.5*r,r=.5/r,t[3]=(e[3*o+s]-e[3*s+o])*r,t[o]=(e[3*o+i]+e[3*i+o])*r,t[s]=(e[3*s+i]+e[3*i+s])*r}return t}!function(){var t=ue()}(),function(){var t,e=(t=new le(4),le!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var we,Me=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t},be=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],s=n*n+r*r+i*i+o*o;return s>0&&(s=1/Math.sqrt(s),t[0]=n*s,t[1]=r*s,t[2]=i*s,t[3]=o*s),t};ue(),he(1,0,0),he(0,1,0),me(),me(),we=new le(9),le!=Float32Array&&(we[1]=0,we[2]=0,we[3]=0,we[5]=0,we[6]=0,we[7]=0),we[0]=1,we[4]=1,we[8]=1;\n/*!\n     * Contains code from google filament\n     * https://github.com/google/filament/\n     * License Apache-2.0\n     */\nconst Pe=8,_e=[],Ie=[],Ae=[],Se=[];function Te(t,e,n){const r=ye(Ie,e,n),i=function(t,e,n,r,i,o,s,a,l,u){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t[4]=o,t[5]=s,t[6]=a,t[7]=l,t[8]=u,t}(_e,n[0],n[1],n[2],...r,...e);t=ve(t,i),t=function(t){return t[3]<0?Me(t,t,-1):t}(t=be(t,t));const o=1/((1<<2*Pe-1)-1);if(t[3]<o){t[3]=o;const e=Math.sqrt(1-o*o);t[0]*=e,t[1]*=e,t[2]*=e}const s=n[3]>0?ye(Ae,n,e):ye(Ae,e,n);return ge(ye(Se,n,e),s)<0&&Me(t,t,-1),t}const Fe=[];const ke=[],Le=[],Be=[],Ce=[],Ye=[],Oe=[],Ve=[];function Xe(t,e,n,r,i,o){fe(Ce,t[3*e],t[3*e+1],t[3*e+2]),fe(Ye,t[3*n],t[3*n+1],t[3*n+2]),fe(Oe,t[3*r],t[3*r+1],t[3*r+2]);const s=xe(ke,Oe,Ye),a=xe(Le,Ce,Ye),l=ye(Be,s,a);de(Ve,l),i[3*e]=i[3*e]||0,i[3*n]=i[3*n]||0,i[3*r]=i[3*r]||0,i[3*e+1]=i[3*e+1]||0,i[3*n+1]=i[3*n+1]||0,i[3*r+1]=i[3*r+1]||0,i[3*e+2]=i[3*e+2]||0,i[3*n+2]=i[3*n+2]||0,i[3*r+2]=i[3*r+2]||0,i[3*e]+=Ve[0],i[3*n]+=Ve[0],i[3*r]+=Ve[0],i[3*e+1]+=Ve[1],i[3*n+1]+=Ve[1],i[3*r+1]+=Ve[1],i[3*e+2]+=Ve[2],i[3*n+2]+=Ve[2],i[3*r+2]+=Ve[2],o[e]+=1,o[n]+=1,o[r]+=1}\n/*!\n     * Contains code from THREE.JS\n     * https://github.com/mrdoob/three.js/\n     * License MIT\n     * \n     * Generate tangents per vertex.\n     */function Ee(t,e,n){return t[0]=e[n],t[1]=e[n+1],t[2]=e[n+2],t}function Ne(t,e,n){return t[0]=e[n],t[1]=e[n+1],t}const{StyleUtil:ze,PackUtil:De,ArrayPool:$e}=ne(),qe=$e.getInstance();function je(t,e,n,r,i,o,s,a,l,u,h,c,f,p,d,g){void 0===e.top&&(e.top=!0),void 0===e.side&&(e.side=!0),qe.reset();const{altitudeScale:y,altitudeProperty:x,defaultAltitude:m,heightProperty:v,minHeightProperty:P,defaultHeight:_,tangent:I,uv:A,topUVMode:T,sideUVMode:F,sideVerticalUVMode:k,top:B,side:C,textureYOrigin:Y,topThickness:O}=e,V=function(t,e,{altitudeScale:n,altitudeProperty:r,defaultAltitude:i,heightProperty:o,minHeightProperty:s,defaultHeight:a},{center:l,side:u,top:h,topThickness:c,uvOrigin:f,uv:p,uvSize:d,topUVMode:g,sideUVMode:y,sideVerticalUVMode:x,textureYOrigin:m,tileRatio:v,centimeterToPoint:w,verticalCentimeterToPoint:M,positionType:b,res:P,glScale:_,projectionCode:I},A,T){let F=e/t[0].extent;e===1/0&&(F=1);const k=e===1/0,L=T.get(),B=T.get(),C=T.get(),Y=T.getProxy(),O=T.get(),V=T.get(),X=T.get(),E=!!p,N=!!h,z=!!u,D=E?T.get():null;function $(t,n,r,i,o,s){let a=n;if(N){const u=Tt(Y,r,3);if(0===u.length)return n;let h=Y.getLength(),p=O.currentIndex;for(let t=0;t<h;t++)O[p++]=Y[t];if(O.currentIndex=p,n+=Y.getLength(),s)for(let e=2,n=u.length;e<n;e+=3)u[e]+=t/3,u[e-1]+=t/3,u[e-2]+=t/3;else{let e;for(let n=2,r=u.length;n<r;n+=3)e=u[n-1],u[n-1]=u[n]+t/3,u[n]=e+t/3,u[n-2]+=t/3}h=u.length,p=V.currentIndex;for(let t=0;t<h;t++)V[p++]=u[t];V.currentIndex=p,E&&It(g||0,t,n,D,O,f,w,v,d[0],d[1],o,P,_,I,l),c>0&&!z&&(n=oe(O,Y,r,V,n,D,0,c,e,E,y||0,x||0,m,d,v,M,i<0?!s:s)),X.setLength(n/3),X.fill(1,a/3,n/3)}if(z){N&&(c=0),a=n,n=oe(O,Y,r,V,n,D,c,i,e,E,y||0,x||0,m,d,v,M,i<0?!s:s),X.setLength(n/3);const t=Y.getLength()/3;X.fill(1,a/3,a/3+t),X.fill(0,a/3+t,a/3+2*t),X.fill(1,a/3+2*t,a/3+3*t),X.fill(0,a/3+3*t,n/3)}return n}let q=-1/0,j=1/0,G=0;const Z=[-1,-1,e+1,e+1];let U=0,R=t.length;S(A)&&(U=A,R=A+1);let J=0,H=!1;const W=T.getProxy();let K=!1;for(;U<R;U++){const l=t[U],u=l.id;S(u)&&(Math.abs(u)>J&&(J=Math.abs(u)),u<0&&(H=!0));const h=l.geometry,c=l.properties[ee];let f=Array.isArray(c&&c[0]&&c[0][0])?c[0]:c;const{altitude:p,height:d}=re.getFeaAltitudeAndHeight(l,n,r,i,o,a,s);d<0?(K=!0,j=Math.min(p,j),q=Math.max(p-d,q)):(q=Math.max(p,q),j=Math.min(p-d,j));const g=O.getLength();let y=0,x=G;W.setLength(0),Y.setLength(0);const m=re.calculateSignedArea(h[0])<0;for(let t=0,n=h.length;t<n;t++){let r=h[t];m&&(r=r.reverse()),r=ae(r);const i=re.calculateSignedArea(r)<0;if(!i&&t>0&&(y++,f=c&&c[y],G=$(x,G,W,d*F,f,k),Y.setLength(0),W.setLength(0),x=G),e!==1/0&&(r=re.clipPolygon(r,Z)),!r.length){t===n-1&&(G=$(x,G,W,d*F,f,k));continue}const o=r.length;if(Array.isArray(r[0])?r[0][0]===r[o-1][0]&&r[0][1]===r[o-1][1]||r.push([r[0][0],r[0][1]]):r[0].x===r[o-1].x&&r[0].y===r[o-1].y||r.push(r[0]),i){let t=W.currentIndex;W[t++]=Y.getLength()/3,W.currentIndex=t}ct(Y,Y.getLength(),r,F,p,!1,b),t===n-1&&(G=$(x,G,W,d*F,f,k))}const v=O.getLength()-g,w=(te+"").trim();for(let t=0;t<v/3;t++){let t=B.currentIndex;B[t++]=void 0===l[w]?U:l[w],B.currentIndex=t,t=L.currentIndex,L[t++]=U,L.currentIndex=t,S(u)&&(t=C.currentIndex,C[t++]=u,C.currentIndex=t)}}const Q=re.getUnsignedArrayType(B.getLength()?B[B.getLength()-1]:0),tt={hasNegativeHeight:K,maxAltitude:q===-1/0?0:q,minAltitude:j===1/0?0:j,vertices:O,verticeTypes:X,indices:V,pickingIds:ie.createTypedArray(B,Q),featureIndexes:L};if(C.getLength()){const t=H?re.getPosArrayType(J):re.getUnsignedArrayType(J);tt.featureIds=ie.createTypedArray(C,t)}else tt.featureIds=[];return D&&(D.setLength(O.getLength()/3*2),tt.uvs=D),tt}(t,n,{altitudeScale:y,altitudeProperty:x,defaultAltitude:m||0,heightProperty:v,minHeightProperty:P,defaultHeight:_||0},{center:g,top:B,side:C,topThickness:10*O||0,uv:A||I,uvSize:[i,i],uvOrigin:r,topUVMode:T,sideUVMode:F,sideVerticalUVMode:k,textureYOrigin:Y,tileRatio:a,centimeterToPoint:l,verticalCentimeterToPoint:u,positionType:d,res:o,glScale:s,projectionCode:f},p,qe),X=[],E=V.vertices.getLength()/3,N=De.getIndexArrayType(E),z=$e.createTypedArray(V.indices,N);delete V.indices,X.push(z.buffer,V.pickingIds.buffer);const D=Math.max(Math.abs(V.maxAltitude),Math.abs(V.minAltitude)),$=De.getPosArrayType(Math.max(512,D));V.vertices=$e.createTypedArray(V.vertices,$);const q=I?qe.getProxy():new Float32Array(3*E);q.setLength&&q.setLength(3*E);const j=function(t,e,n){const r=n||[];r.setLength&&r.setLength(t.length);const i=Fe;i.length<t.length/3&&(i.length=t.length/3),i.fill(0,0,t.length/3);const o=void 0===e.length?e:e.length;for(let n=0;n<o/3;n++)void 0===e.length?Xe(t,3*n,3*n+1,3*n+2,r,i):Xe(t,e[3*n],e[3*n+1],e[3*n+2],r,i);for(let t=0;t<r.length;t+=3){const e=i[t/3];0!==e?(r[t]/=e,r[t+1]/=e,r[t+2]/=e):(r[t]=0,r[t+1]=0,r[t+2]=0)}return r}(V.vertices,z,q);let G=!0;const Z=j.getLength?j.getLength():j.length;for(let t=0;t<Z;t++){j[t]=-j[t];const e=j[t]%1;1-Math.abs(e)>1e-6?G=!1:0!==e&&(j[t]=Math.round(j[t]))}if(V.normals=j,I){let t=qe.get();t.setLength(4*E),t=function(t,e,n,r,i){const o=t.length/3,s=i||new Array(4*o),a=[],l=[];for(let t=0;t<o;t++)a[t]=[0,0,0],l[t]=[0,0,0];const u=[0,0,0],h=[0,0,0],c=[0,0,0],f=[0,0],p=[0,0],d=[0,0],g=[0,0,0],y=[0,0,0];function x(e,r,i){Ee(u,t,3*e),Ee(h,t,3*r),Ee(c,t,3*i),Ne(f,n,2*e),Ne(p,n,2*r),Ne(d,n,2*i);const o=h[0]-u[0],s=c[0]-u[0],x=h[1]-u[1],m=c[1]-u[1],v=h[2]-u[2],w=c[2]-u[2],M=p[0]-f[0],b=d[0]-f[0],P=p[1]-f[1],_=d[1]-f[1],I=1/(M*_-b*P);fe(g,(_*o-P*s)*I,(_*x-P*m)*I,(_*v-P*w)*I),fe(y,(M*s-b*o)*I,(M*m-b*x)*I,(M*w-b*v)*I),pe(a[e],a[e],g),pe(a[r],a[r],g),pe(a[i],a[i],g),pe(l[e],l[e],y),pe(l[r],l[r],y),pe(l[i],l[i],y)}for(let t=0,e=r.length;t<e;t+=3)x(r[t+0],r[t+1],r[t+2]);const m=[],v=[],w=[],M=[];let b,P,_;function I(t){Ee(w,e,3*t),ce(M,w),P=a[t],ce(m,P),xe(m,m,function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}(w,w,ge(w,P))),de(m,m),ye(v,M,P),_=ge(v,l[t]),b=_<0?-1:1,s[4*t]=m[0],s[4*t+1]=m[1],s[4*t+2]=m[2],s[4*t+3]=b}for(let t=0,e=r.length;t<e;t+=3)I(r[t+0]),I(r[t+1]),I(r[t+2]);return s}(V.vertices,V.normals,V.uvs,z,t),t=function(t,e){const n=e.getLength(),r=new Float32Array(n),i=[],o=[],s=[];for(let a=0;a<n;a+=4){const n=a/4*3;dt(o,t[n]||0,t[n+1]||0,t[n+2]||0),yt(i,e[a]||0,e[a+1]||0,e[a+2]||0,e[a+3]||0),Te(s,o,i),gt(r.subarray(a,a+4),s)}return r}(V.normals,t),V.tangents=t,X.push(t.buffer),delete V.normals}if(V.normals&&(G&&(V.normals=$e.createTypedArray(V.normals,Int8Array)),X.push(V.normals.buffer)),V.uvs){const t=V.uvs;V.uvs=$e.createTypedArray(t,Float32Array),X.push(V.uvs.buffer)}const U=function(t,e,n,r){const i={},o={},s=r.getLength();if(L(e.polygonFill)){let a=M(e.polygonFill);const l=new Uint8Array(4*s);l.fill(255);for(let e=0;e<s;e++){const o=t[r[e]],s=o.properties||{};s.$layer=o.layer,s.$type=o.type;let u=a(n,s);w(u)&&(i.aColor=1,a=M(u),u=a(n,s)),delete s.$layer,delete s.$type,ze.normalizeColor(Ge,u),l[4*e]=Ge[0],l[4*e+1]=Ge[1],l[4*e+2]=Ge[2],l[4*e+3]=Ge[3]}o.aColor=l}if(L(e.polygonOpacity)){let a=b(e.polygonOpacity,"exponential");const l=new Uint8Array(s);l.fill(255);for(let e=0;e<s;e++){const o=t[r[e]],s=o.properties||{};s.$layer=o.layer,s.$type=o.type;let u=a(n,s);w(u)&&(i.aOpacity=1,a=M(u),u=a(n,s)),delete s.$layer,delete s.$type,l[e]=255*u}o.aOpacity=l}return o.dynamicAttributes=i,o}(t,h,c,V.featureIndexes),R=function(t,e,n,r,i){const o=[[],[]],s=L(r.topPolygonFill),a=L(r.bottomPolygonFill),l=[255,255,255,255],u=e.getLength();if(s||a){let h=s&&M(r.topPolygonFill),c=a&&M(r.bottomPolygonFill),f=null,p=null,d=null,g=null;for(let r=0;r<u;r++){if(1===t[r]&&!s||0===t[r]&&!a)continue;const u=1===t[r];if(u&&e[r]===f){t[r]=d;continue}if(!u&&e[r]===p){t[r]=g;continue}const y=n[e[r]],x=y.properties||{};x.$layer=y.layer,x.$type=y.type;let m=u?h:c,v=m(i,x);w(v)&&(m=M(v),v=m(i,x)),delete x.$layer,delete x.$type,ze.normalizeColor(Ge,v),xt(Ge,Ge,l);let b=Ze(o,Ge);b<0&&(b=o.length,o.push(gt([],Ge))),t[r]=b,u?(f=e[r],d=b):(p=e[r],g=b)}}return o.slice(2)}(V.verticeTypes,V.featureIndexes,t,h,c),J={data:{data:{aVertexColorType:R.length<=252?$e.createTypedArray(V.verticeTypes,Uint8Array):$e.createTypedArray(V.verticeTypes,Uint16Array),aPosition:V.vertices,aNormal:V.normals,aTexCoord0:V.uvs,aTangent:V.tangents,aPickingId:V.pickingIds},indices:z,properties:{maxAltitude:V.maxAltitude/100,minAltitude:V.minAltitude/100,hasNegativeHeight:V.hasNegativeHeight},dynamicAttributes:U.dynamicAttributes,vertexColors:R},buffers:X};return V.featureIds.length?(J.data.featureIds=V.featureIds,X.push(J.data.featureIds.buffer)):J.data.featureIds=[],U.aColor&&(J.data.data.aColor=U.aColor,J.buffers.push(U.aColor.buffer)),U.aOpacity&&(J.data.data.aOpacity=U.aOpacity,J.buffers.push(U.aOpacity.buffer)),J.buffers.push(J.data.data.aPosition.buffer),J.data.pickingIdIndiceMap=De.generatePickingIndiceIndex(J.data.data.aPickingId,J.data.indices),J}const Ge=[];function Ze(t,e){for(let i=0;i<t.length;i++)if(n=e,r=t[i],n[0]===r[0]&&n[1]===r[1]&&n[2]===r[2]&&n[3]===r[3])return i;var n,r;return-1}const{PackUtil:Ue,StyleUtil:Re,FilterUtil:Je}=ne();function He(t,e,n,r,{altitudeScale:i,altitudeProperty:o,defaultAltitude:s,heightProperty:a,minHeightProperty:l,defaultHeight:u,bottom:h}){const c=h,f=e/t[0].extent,p=2*function(t,e){let n=0;for(let e=0,r=t.length;e<r;e++){const r=t[e];if(S(r.geometry[0][0]))n+=3*r.geometry.length;else for(let t=0,e=r.geometry.length;t<e;t++){let e=3*r.geometry[t].length;3===r.type&&(e-=3),n+=e}}return n}(t)+3*t.length*2,d=[],g=new Int16Array(p),y=new Uint8Array(g.length/3*4);w(n)&&(n=Je.compileFilter(n));const x=[];function m(t,n,r){const i=n-t,o=g.subarray(t,n),s=g.subarray(n,n+i);s.set(o);for(let t=2,e=s.length;t<e;t+=3)s[t]=o[t]-r;const a=t/3,l=i/3;let u,h;for(let t=a,n=l+a;t<n;t++)t<n-1?(u=t,h=t+1):(u=t,h=a),ft(g,u,h,e)||(x.push(u,h),c&&x.push(u+l,h+l),We(g,u,e)||x.push(u,u+l));return n+i}let v=0,M=-1/0,b=1/0;const P=(te+"").trim(),_=[];for(let e=0,h=t.length;e<h;e++){const h=t[e],c=h.geometry;if(n){let t;t="function"==typeof n?n(h&&h.properties):n,Re.normalizeColor(_,t)}else dt(_,255,255,255);const p=v/3*4,{altitude:w,height:I}=Ue.getFeaAltitudeAndHeight(h,i,o,s,a,u,l);I<0?(b=Math.min(w,b),M=Math.max(w-I,M)):(b=Math.min(w-I,b),M=Math.max(w,M));let A=v;for(let t=0,e=c.length;t<e;t++){let e=c[t];const n=e.length;e[0][0]===e[n-1][0]&&e[0][1]===e[n-1][1]&&(e=e.slice(0,n-1)),v=ct(g,A,e,f,w),v=m(A,v,I*f),A=v}const S=A/3*4;for(let t=p;t<S;t+=4)y[t]=_[0],y[t+1]=_[1],y[t+2]=_[2],y[t+3]=255*(r||1);const T=x.length-d.length;for(let t=0;t<T;t++)d.push(h[P])}const I=x.reduce(((t,e)=>Math.max(t,e)),0),A=new(Ue.getIndexArrayType(I))(x),T=Ue.getUnsignedArrayType(t.length),F=Math.max(Math.abs(M,Math.abs(b)));return{aPosition:new(Ue.getPosArrayType(Math.max(512,F)))(g),indices:A,aPickingId:new T(d),aColor:y,maxAltitude:M===-1/0?0:M/100,minAltitude:b===1/0?0:b/100}}function We(t,e,n){const r=t[3*e],i=t[3*e+1];return r<0||r>n||i<0||i>n}function Ke(t,e,n,r){const i=He(t,e,n.lineColor,n.lineOpacity,r),{minAltitude:o,maxAltitude:s}=i;delete i.minAltitude,delete i.maxAltitude;const a=[i.aPosition.buffer,i.indices.buffer,i.aPickingId.buffer],l=i.indices;return delete i.indices,{data:{data:i,properties:{minAltitude:o,maxAltitude:s},indices:l},buffers:a}}\n/*!\n        Feature Filter by\n\n        (c) mapbox 2016 and maptalks 2018\n        www.mapbox.com | www.maptalks.org\n        License: MIT, header required.\n    */const Qe=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function tn(t){if(!t)return"true";const e=t[0];if(t.length<=1)return"any"===e?"false":"true";return\`(${QR}"=="===e?nn(t[1],t[2],"===",!1):"!="===e?nn(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?nn(t[1],t[2],e,!0):"any"===e?on(t.slice(1),"||"):"all"===e?on(t.slice(1),"&&"):"none"===e?ln(on(t.slice(1),"||")):"in"===e?sn(t[1],t.slice(2)):"!in"===e?ln(sn(t[1],t.slice(2))):"has"===e?an(t[1]):"!has"===e?ln(an(t[1])):"contains"===e?function(t,e,n){const r=en(t);return void 0!==n?\`(${QR}r} + '').indexOf("${QR}e}") === ${QR}n}\`:\`(${QR}r} + '').indexOf("${QR}e}") >= 0\`}(t[1],t[2],t[3]):"true"})\`}function en(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function nn(t,e,n,r){if("object"==typeof(i=t)&&i&&t.op)return function(t,e,n,r){const i=t.property,o=t.op;let s=en(i);return"length"!==o?(console.error(\`not support ${QR}o} op\`),"false"):(s=\`((${QR}s}+='').length)\`,rn(s,i,e,n,r))}(t,e,n,r);var i;return rn(en(t),t,e,n,r)}function rn(t,e,n,r,i){const o="$type"===e?Qe.indexOf(n):JSON.stringify(n);return(i?\`typeof ${QR}t}=== typeof ${QR}o}&&\`:"")+t+r+o}function on(t,e){return t.map(tn).join(e)}function sn(t,e){"$type"===t&&(e=e.map((t=>Qe.indexOf(t))));const n=JSON.stringify(e.sort(un)),r=en(t);return e.length<=200?\`${QR}n}.indexOf(${QR}r}) !== -1\`:\`function(v, a, i, j) {\\n        while (i <= j) { var m = (i + j) >> 1;\\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\\n        }\\n    return false; }(${QR}r}, ${QR}n},0,${QR}e.length-1})\`}function an(t){return"$id"===t?'"id" in f':\`${QR}JSON.stringify(t)} in p\`}function ln(t){return\`!(${QR}t})\`}function un(t,e){return t<e?-1:t>e?1:0}let hn=!1;try{const t=new OffscreenCanvas(1,1);t.getContext("2d").fillText("hello",0,0),hn=!0}catch(t){hn=!1}var cn=hn;const{VectorPack:fn,PolygonPack:pn,NativeLinePack:dn,LinePack:gn,PointPack:yn,NativePointPack:xn,LineExtrusionPack:mn,CirclePack:vn,RoundTubePack:wn,SquareTubePack:Mn,FilterUtil:bn,PackUtil:Pn,StyleUtil:_n,TextUtil:In,DEFAULT_TEX_WIDTH:An,GlyphRequestor:Sn}=ne(),Tn="__original_properties",Fn="__fn-type_properties";class kn{constructor(t,e,n,r,i){this.id=t,this.options=e,this.upload=n,this._compileStyle(e.style),this.requests={},this._cache=r,this._styleCounter=1,this.loadings=i}updateStyle(t,e){this.options.style=t,this._styleCounter=t.styleCounter,this._compileStyle(t),e()}updateOptions(t,e){this.options=I(this.options,t),e()}loadTile(t,e){const n=this.loadings,r=t.tileInfo.url,i=this.options.debugTile;if(i){const{x:n,y:r,z:o}=t.tileInfo;let s=!1;for(let t=0;t<i.length;t++)if(n===i[t].x&&r===i[t].y&&o===i[t].z){s=!0;break}if(!s)return void e()}if(n[r])return void n[r].push({context:t,callback:e,ref:this});n[r]=[{context:t,callback:e,ref:this}];const o=this.options.featureIdProperty;this.requests[r]=this.getTileFeatures(t,((e,i,s,a)=>{const l=n[r];if(delete n[r],this.checkIfCanceled(r))return delete this.requests[r],void this._callWaitings(l,null,{canceled:!0});if(delete this.requests[r],(this.options.debug||o)&&i)for(let e=0;e<i.length;e++)if(this.options.debug&&(i[e]._debug_info={index:e,id:i[e].id,tileId:t.tileInfo.id}),o){const t=F(o)?o[i[e].layer]:o,n=i[e].properties;i[e].id=n&&n[t]||null}if(e)this._callWaitings(l,e);else if(i&&i.length){if(l)for(let t=0;t<l.length;t++)this._onTileLoad.call(l[t].ref,l[t].context,l[t].callback,r,s,i,a)}else this._callWaitings(l)}))}_onTileLoad(t,e,n,r,i,o){this._createTileData(r,i,t).then((n=>{n.canceled?e(null,{canceled:!0}):(n.data.styleCounter=t.styleCounter,o&&I(n.data,o),e(null,n.data,n.buffers))})).catch((t=>{e(t)}))}abortTile(t,e){delete this.requests[t],this._cancelLoadings(t),e()}_cancelLoadings(t){const e=this.loadings[t];if(e)for(let t=0;t<e.length;t++)e[t].callback(null,{canceled:!0});delete this.loadings[t]}_callWaitings(t,e,n){if(t)for(let r=0;r<t.length;r++)t[r].callback(e,n)}checkIfCanceled(t){return!this.requests[t]}onRemove(){this.loadings={},delete this._cache,this.requests={}}fetchIconGlyphs(t,e,n){if(this.options.workerGlyph&&cn){const r=[];if(t&&Object.keys(t).length){const e=new Promise((e=>{this.upload("fetchIconGlyphs",{icons:t},null,((t,n)=>{e({err:t,iconData:n})}))}));r.push(e)}if(e&&Object.keys(e).length){const t=new Promise((t=>{this._glyphRequestor||(this._glyphRequestor=new Sn),this._glyphRequestor.getGlyphs(e,((e,n)=>{t({err:e,glyphData:n})}))}));r.push(t)}Promise.all(r).then((t=>{const e={icons:null,glyphs:null};for(let r=0;r<t.length;r++){if(t[r].err)return void n(t[r].err);t[r].iconData?e.icons=t[r].iconData.icons:t[r].glyphData&&(e.glyphs=t[r].glyphData.glyphs)}return e})).then((t=>{n(null,t)}))}else this.upload("fetchIconGlyphs",{icons:t,glyphs:e},null,n)}_createTileData(t,e,n){if(!e.length)return Promise.resolve({data:null,buffers:[]});const{glScale:r,tileInfo:i}=n,o=!this.options.style.style.length&&!this.options.style.featureStyle.length;let s=this.pluginConfig.slice(0);o&&(s=this._updateLayerPluginConfig(t)),this.featurePlugins&&function(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(n)for(let e=0,r=n.length;e<r;e++)t.push(n[e])}t.length}(s,this.featurePlugins);const a={};for(let t=0;t<s.length;t++)Xn(e,n.tileInfo.z,s[t],a);const l=[],u=[];for(let t=0;t<e.length;t++){const n=e[t],r=a[t];if(r){u.fill(null);let t=0;for(const e in r){let i=0;const o=r[e].values();for(const t of o){let r=u[i];r||(r=Dn(n),u[i]=r),r.properties[e]=t,i++}i>t&&(t=i)}for(let e=0;e<t;e++)l.push(u[e])}else l.push(n)}const h=(e=l)[0].extent,c=i.z,f={x:i.extent2d.xmin*r,y:i.extent2d.ymax*r},p=[],d=[],g=[],y=this.options,x=[],m={},v=[Promise.resolve(n.styleCounter)];let w=0,M=-1;const b=[];let P=!1;for(let t=0;t<s.length;t++){M++;const r=s[t];r.type!==w&&(M=0,w=r.type);const a=0===r.type?p:d;jn(r.symbol,b,t),P=P||b[t]&&b[t].size>0;const{tileFeatures:l,tileFeaIndexes:u}=this._filterFeatures(c,r.type,r.filter,e,m,t);if(!l.length){a[M]=null;continue}const y=u[u.length-1],_=Pn.getIndexArrayType(y);a[M]={styledFeatures:new _(u)},g.push({idx:t,typeIdx:M}),x.push(a[M].styledFeatures.buffer);const A=I({},n,{extent:h,zoom:c,tilePoint:f});if(this.options.debugTile){const t=this.options.debugTile;for(let e=0;e<t.length;e++){const{x:n,y:r,z:o}=t[e];if(i.x===n&&i.y===r&&i.z===o){A.debugIndex=t[e].index;break}}}let S=this._createTileGeometry(l,r,A);o&&(S=S.then((t=>{if(!t)return null;if(t.data)t.data.layer=l[0].layer;else if(Array.isArray(t))for(let e=0;e<t.length;e++)t[e]&&t[e].data&&(t[e].data.layer=l[0].layer);return t}))),v.push(S)}return Promise.all(v).then((([n,...r])=>{if(n!==this._styleCounter)return{canceled:!0};function i(t,e){if(void 0!==t.data.ref)return;const n=s[g[e].idx],r=n.renderPlugin.dataConfig;if(t.data.type=r.type,t.data.filter=n.filter.def,r.altitudeOffset&&(t.data.properties.minAltitude+=r.altitudeOffset,t.data.properties.maxAltitude+=r.altitudeOffset),t.buffers&&t.buffers.length)for(let e=0;e<t.buffers.length;e++)x.push(t.buffers[e])}for(let t=0;t<r.length;t++){if(!r[t])continue;const e=r[t],n=0===s[g[t].idx].type?p:d;if(Array.isArray(e)){const r=[];for(let n=0;n<e.length;n++)e[n]&&(i(e[n],t),(void 0===e[n].data.ref||e[e[n].data.ref])&&r.push(e[n].data));r.length&&(n[g[t].typeIdx].data=r)}else i(e,t),n[g[t].typeIdx].data=e.data}const o={},a=t;if(y.features||y.schema||P){let t,n=!1;for(let r=0,i=e.length;r<i;r++)if(t=e[r],a[t.layer].properties||(a[t.layer].properties=Cn(t.properties)),t&&(y.features||P&&m[r]))if("id"===y.features)o[r]=t.id;else{y.pickingGeometry||delete t.geometry,delete t.extent,delete t.properties.$layer,delete t.properties.$type,delete t.__index;const e=t.originalFeature;if(e){const e=t.properties,n=I({},t.originalFeature);delete e[Tn],n.customProps=I({},e),t=n}const i=I({},t);if(P&&m[r]&&(!y.features||"transient"===y.features)){const i=m[r];for(let r=0;r<i.length;r++){const i=b[r];i&&i.forEach((r=>{const i=e?e.properties:t.properties;i[Fn]||(i[Fn]=new Set),i[Fn].add(r),n=!0}))}}o[r]=i}if(n)for(const t in o){const e=o[t],n=e.properties[Fn];if(n){delete e.properties[Fn],"transient"===y.features&&(e.fnTypeProps=I({},e.properties));for(const t in e.properties)n.has(t)||("transient"===y.features?delete e.fnTypeProps[t]:delete e.properties[t])}}}return{data:{styleCounter:n,schema:a,data:p,featureData:d,extent:h,features:o},buffers:x}})).catch((t=>{console.error(t)}))}_createTileGeometry(t,e,n){let r=t;const i=e.renderPlugin.dataConfig,o=e.symbol,s=this.options.tileSize,{extent:a,glScale:l,zScale:u,zoom:h,tilePoint:c,centimeterToPoint:f,verticalCentimeterToPoint:p}=n,d=a/s,g=i.type,y=n.debugIndex;let x=I({},i,{EXTENT:a,zoom:h,debugIndex:y,features:this.options.features,isWebGPU:this.options.isWebGPU});if("3d-extrusion"===g){Yn(o)&&(i.uv=1);const t=this.options.projectionCode,e=o.material&&o.material.textureWidth||An;return Promise.all([Promise.resolve(je(r,i,a,c,e,n.tileInfo.res,l,a/this.options.tileSize,f,p,o,h,t,y))])}if("3d-wireframe"===g)return Promise.all([Promise.resolve(Ke(r,a,o,i))]);if("point"===g){x=I(x,{requestor:this.fetchIconGlyphs.bind(this),altitudeToTileScale:u*a/this.options.tileSize/l,pluginType:e.renderPlugin.type});let t=o;return Array.isArray(o)||(t=[o]),t=t.map(((t,e)=>(t&&(t.index={index:e},t.isIconText=function(t){return t.markerType||t.markerFile}(t)),t))).filter((t=>!!t)),Promise.all(t.map((t=>{const e=fn.genFnTypes(t);let n=r;return yn.needMerge(t,e,h)&&(n=yn.mergeLineFeatures(r,t,e,h)),new yn(n,t,x).load(d)})))}if("native-point"===g){const t=u*a/this.options.tileSize/l;return x.altitudeToTileScale=t,On(r,o,x,xn,d)}if("line"===g)return x=I(x,{requestor:this.fetchIconGlyphs.bind(this),tileRatio:d}),On(r,o,x,gn,1,!0);if("native-line"===g)return On(r,o,x,dn,1,!0);if("fill"===g)return x=I(x,{requestor:this.fetchIconGlyphs.bind(this)}),On(r,o,x,pn);if("line-extrusion"===g){delete o.lineGradientProperty,o.lineJoin="miter",o.lineCap="butt";const t=Yn(o);if(t&&(i.uv=1),x=I(x,{tileSize:s,zScale:u,glScale:l}),o.mergeOnProperty){const t=fn.genFnTypes(o);r=gn.mergeLineFeatures(r,o,t,x.zoom)}if(t){const t=[];if(!1!==i.top){const e=I({},x);e.side=!1,t.push(new mn(r,o,e))}return!1!==i.side&&(x.side=!0,x.top=!1,t.push(new mn(r,o,x))),Promise.all(t.map((t=>t.load())))}return Promise.all([new mn(r,o,x).load()])}if("circle"===g)return On(r,o,x,vn);if("round-tube"===g||"square-tube"===g){const t="round-tube"===g?wn:Mn;return x=I(x,{requestor:this.fetchIconGlyphs.bind(this),radialSegments:"round-tube"===g?i.radialSegments||8:4,centimeterToPoint:f,verticalCentimeterToPoint:p,tileRatio:d,isTube:!0}),On(r,o,x,t)}return Promise.resolve([])}_filterFeatures(t,e,n,r,i,o){const s=(te+"").trim(),a=[],l=[],u=r.length;for(let h=0;h<u;h++)if((1===e||void 0===r[h].id||!this.styledFeatures[r[h].id])&&((!n.def||"default"===n.def)&&!i[h]||!0===n.def||n.def&&(void 0!==n.def.condition||Array.isArray(n.def))&&n(r[h],t))){const t=r[h];if(void 0===t[s]&&(t[s]=h),i[h]||(i[h]=[]),i[h].push(o),l.push(t),a.push(h),1===e)break}return{tileFeatures:l,tileFeaIndexes:a}}_compileStyle(t){const{style:e,featureStyle:n}=t,r={};n.forEach((t=>{Array.isArray(t.id)?(t.id.forEach((t=>{r[t]=1})),t.filter=["in","$id",...t.id]):(r[t.id]=1,t.filter=["==","$id",t.id])}));const i=bn.compileStyle(e);for(let t=0;t<e.length;t++)i[t].filter&&(i[t].filter.def=e[t].filter?e[t].filter.value||e[t].filter:void 0),i[t].type=0;const o=[],s=bn.compileStyle(n);for(let t=0;t<n.length;t++)s[t].type=1,s[t].filter.def=n[t].filter?n[t].filter.value||n[t].filter:void 0,s[t].renderPlugin&&o.push(s[t]);this.pluginConfig=i,this.featurePlugins=o,this.styledFeatures=r}_updateLayerPluginConfig(t){let e=this._layerPlugins;this._layerPlugins||(e=this._layerPlugins={});const n=["","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon"],r=[];for(const o in t){const s=o;if(!e[o]){const r=[];for(let e=0;e<t[o].types.length;e++){const a=t[o].types[e],l=["all",["==","$layer",s],["==","$type",n[a]]],u={filter:(i=l,new Function("f",\`var p = (f && f.properties || {}); return ${QR}tn(i)}\`)),renderPlugin:Ln(a),symbol:Bn(a)};u.filter.def=l,u.type=0,r.push(u)}e[s]=r}r.push(...e[s])}var i;return r}}function Ln(t){switch(t){case 1:return{type:"native-point",dataConfig:{type:"native-point",only2D:!0}};case 2:return{type:"native-line",dataConfig:{type:"native-line",only2D:!0}};case 3:return{type:"fill",dataConfig:{type:"fill",only2D:!0}}}return null}function Bn(t){switch(t){case 1:return{markerFill:"#f00",markerSize:10};case 2:return{lineColor:"#fff"};case 3:return{polygonFill:"#00f",polygonOpacity:.4}}return null}function Cn(t){if(Array.isArray(t)||!F(t))return{};const e={};for(const n in t){const r=t[n];A(r)?e[n]="string":S(r)?e[n]="number":!0===r||!1===r?e[n]="boolean":Array.isArray(r)?e[n]="array":e[n]="object"}return e}function Yn(t){if(!t)return 0;let e=0;for(const n in t){if(("normalTexture"===n||"bumpTexture"===n)&&t[n])return 2;if(n.indexOf("Texture")>0&&t[n])e=1;else if(F(t[n])){const r=Yn(t[n]);if(2===r)return r;1===r&&(e=1)}}return e}function On(t,e,n,r,i,o){const s={},a=Array.isArray(e)?e:[e];let l=-1;for(let t=0;t<a.length;t++)s[t]=Vn(a[t]),!s[t]&&a[t]&&-1===l&&(l=t);const u=[];for(let e=0;e<a.length;e++){if(!a[e])continue;a[e].index={index:e};let h=t;if(o&&a[e].mergeOnProperty){const r=fn.genFnTypes(a[e]);h=gn.mergeLineFeatures(t,a[0],r,n.zoom)}s[e]||e===l?u.push(new r(h,a[e],n).load(i)):u.push({data:{ref:l,symbolIndex:{index:e}}})}return Promise.all(u)}function Vn(t){if(!t)return 0;for(const e in t)if(L(t[e]))return 1;return 0}function Xn(t,e,n,r){const i=n.customProperties;if(!i)return t;if(i)for(let t=0;t<i.length;t++)i[t].fn=bn.compileFilter(i[t].filter);for(let n=0;n<i.length;n++)for(let o=0,s=t.length;o<s;o++)if(i[n].fn(t[o],e))for(const t in i[n].properties){const e=i[n].properties[t];k(e)||(r[o]||(r[o]={}),r[o][t]||(r[o][t]=new Set),r[o][t].add(e))}}const En={get:(t,e)=>e in t?t[e]:t.originalFeature[e],has:(t,e)=>e in t||e in t.originalFeature},Nn={get:function(t,e){return e in t?t[e]:t[Tn][e]},has:(t,e)=>e in t||e in t[Tn]},zn={};function Dn(t){const e={};e.originalFeature=t;const n=new Proxy(e,En);return n.properties=new Proxy({},Nn),n.properties[Tn]=t.properties||zn,n}function $n(t,e,n){t[e]||(t[e]=new Set),t[e].add(n)}const qn=[];function jn(t,e,n){if(!t)return qn;for(const r in t){if(!t[r]||!_n.checkIfZoomFnTypeSymbol(r))continue;if(L(t[r]))$n(e,n,t[r].property);else{if("lineGradientProperty"===r){$n(e,n,t[r]);continue}if("textName"===r)if(A(t[r])){const i=In.resolveVarNames(t[r]);if(i)for(let t=0;t<i.length;t++)$n(e,n,i[t])}else if(bn.isExpression(t[r])){const i=[];In.resolveExpVarNames(i,t[r]);for(let t=0;t<i.length;t++)$n(e,n,i[t])}}const i=t[r].stops;if(i&&i.length)for(let t=0;t<i.length;t++)L(i[t][1])&&$n(e,t,i[t][1].property)}return e[n]}function Gn(t,e){Zn(t.geometry,e)}function Zn(t,e){if(t)switch(t.type){case"Point":Un(t.coordinates,e);break;case"MultiPoint":case"LineString":Rn(t.coordinates,e);break;case"MultiLineString":!function(t,e){for(let n=0,r=t.length;n<r;n++)Rn(t[n],e)}(t.coordinates,e);break;case"Polygon":Jn(t.coordinates,e);break;case"MultiPolygon":!function(t,e){for(let n=0,r=t.length;n<r;n++)Jn(t[n],e)}(t.coordinates,e);break;case"GeometryCollection":const n=t.geometries.length;for(let r=0;r<n;r++)Zn(t.geometries[r],e)}}function Un(t,e){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.max(e[2],t[0]),e[3]=Math.max(e[3],t[1])}function Rn(t,e){for(let n=0,r=t.length;n<r;n++)Un(t[n],e)}function Jn(t,e){t.length&&Rn(t[0],e)}function Hn(t,e,n,r,i){Wn(t,e,n||0,r||t.length-1,i||Qn)}function Wn(t,e,n,r,i){for(;r>n;){if(r-n>600){var o=r-n+1,s=e-n+1,a=Math.log(o),l=.5*Math.exp(2*a/3),u=.5*Math.sqrt(a*l*(o-l)/o)*(s-o/2<0?-1:1);Wn(t,e,Math.max(n,Math.floor(e-s*l/o+u)),Math.min(r,Math.floor(e+(o-s)*l/o+u)),i)}var h=t[e],c=n,f=r;for(Kn(t,n,e),i(t[r],h)>0&&Kn(t,n,r);c<f;){for(Kn(t,c,f),c++,f--;i(t[c],h)<0;)c++;for(;i(t[f],h)>0;)f--}0===i(t[n],h)?Kn(t,n,f):Kn(t,++f,r),f<=e&&(n=f+1),e<=f&&(r=f-1)}}function Kn(t,e,n){var r=t[e];t[e]=t[n],t[n]=r}function Qn(t,e){return t<e?-1:t>e?1:0}class tr{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}all(){return this._all(this.data,[])}search(t){let e=this.data;const n=[];if(!cr(t,e))return n;const r=this.toBBox,i=[];for(;e;){for(let o=0;o<e.children.length;o++){const s=e.children[o],a=e.leaf?r(s):s;cr(t,a)&&(e.leaf?n.push(s):hr(t,a)?this._all(s,n):i.push(s))}e=i.pop()}return n}collides(t){let e=this.data;if(!cr(t,e))return!1;const n=[];for(;e;){for(let r=0;r<e.children.length;r++){const i=e.children[r],o=e.leaf?this.toBBox(i):i;if(cr(t,o)){if(e.leaf||hr(t,o))return!0;n.push(i)}}e=n.pop()}return!1}load(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(let e=0;e<t.length;e++)this.insert(t[e]);return this}let e=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const t=this.data;this.data=e,e=t}this._insert(e,this.data.height-e.height-1,!0)}else this.data=e;return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=fr([]),this}remove(t,e){if(!t)return this;let n=this.data;const r=this.toBBox(t),i=[],o=[];let s,a,l;for(;n||i.length;){if(n||(n=i.pop(),a=i[i.length-1],s=o.pop(),l=!0),n.leaf){const r=er(t,n.children,e);if(-1!==r)return n.children.splice(r,1),i.push(n),this._condense(i),this}l||n.leaf||!hr(n,r)?a?(s++,n=a.children[s],l=!1):n=null:(i.push(n),o.push(s),s=0,a=n,n=n.children[0])}return this}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,e){const n=[];for(;t;)t.leaf?e.push(...t.children):n.push(...t.children),t=n.pop();return e}_build(t,e,n,r){const i=n-e+1;let o,s=this._maxEntries;if(i<=s)return o=fr(t.slice(e,n+1)),nr(o,this.toBBox),o;r||(r=Math.ceil(Math.log(i)/Math.log(s)),s=Math.ceil(i/Math.pow(s,r-1))),o=fr([]),o.leaf=!1,o.height=r;const a=Math.ceil(i/s),l=a*Math.ceil(Math.sqrt(s));pr(t,e,n,l,this.compareMinX);for(let i=e;i<=n;i+=l){const e=Math.min(i+l-1,n);pr(t,i,e,a,this.compareMinY);for(let n=i;n<=e;n+=a){const i=Math.min(n+a-1,e);o.children.push(this._build(t,n,i,r-1))}}return nr(o,this.toBBox),o}_chooseSubtree(t,e,n,r){for(;r.push(e),!e.leaf&&r.length-1!==n;){let n,r=1/0,s=1/0;for(let a=0;a<e.children.length;a++){const l=e.children[a],u=ar(l),h=(i=t,o=l,(Math.max(o.maxX,i.maxX)-Math.min(o.minX,i.minX))*(Math.max(o.maxY,i.maxY)-Math.min(o.minY,i.minY))-u);h<s?(s=h,r=u<r?u:r,n=l):h===s&&u<r&&(r=u,n=l)}e=n||e.children[0]}var i,o;return e}_insert(t,e,n){const r=n?t:this.toBBox(t),i=[],o=this._chooseSubtree(r,this.data,e,i);for(o.children.push(t),ir(o,r);e>=0&&i[e].children.length>this._maxEntries;)this._split(i,e),e--;this._adjustParentBBoxes(r,i,e)}_split(t,e){const n=t[e],r=n.children.length,i=this._minEntries;this._chooseSplitAxis(n,i,r);const o=this._chooseSplitIndex(n,i,r),s=fr(n.children.splice(o,n.children.length-o));s.height=n.height,s.leaf=n.leaf,nr(n,this.toBBox),nr(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(n,s)}_splitRoot(t,e){this.data=fr([t,e]),this.data.height=t.height+1,this.data.leaf=!1,nr(this.data,this.toBBox)}_chooseSplitIndex(t,e,n){let r,i=1/0,o=1/0;for(let s=e;s<=n-e;s++){const e=rr(t,0,s,this.toBBox),a=rr(t,s,n,this.toBBox),l=ur(e,a),u=ar(e)+ar(a);l<i?(i=l,r=s,o=u<o?u:o):l===i&&u<o&&(o=u,r=s)}return r||n-e}_chooseSplitAxis(t,e,n){const r=t.leaf?this.compareMinX:or,i=t.leaf?this.compareMinY:sr;this._allDistMargin(t,e,n,r)<this._allDistMargin(t,e,n,i)&&t.children.sort(r)}_allDistMargin(t,e,n,r){t.children.sort(r);const i=this.toBBox,o=rr(t,0,e,i),s=rr(t,n-e,n,i);let a=lr(o)+lr(s);for(let r=e;r<n-e;r++){const e=t.children[r];ir(o,t.leaf?i(e):e),a+=lr(o)}for(let r=n-e-1;r>=e;r--){const e=t.children[r];ir(s,t.leaf?i(e):e),a+=lr(s)}return a}_adjustParentBBoxes(t,e,n){for(let r=n;r>=0;r--)ir(e[r],t)}_condense(t){for(let e,n=t.length-1;n>=0;n--)0===t[n].children.length?n>0?(e=t[n-1].children,e.splice(e.indexOf(t[n]),1)):this.clear():nr(t[n],this.toBBox)}}function er(t,e,n){if(!n)return e.indexOf(t);for(let r=0;r<e.length;r++)if(n(t,e[r]))return r;return-1}function nr(t,e){rr(t,0,t.children.length,e,t)}function rr(t,e,n,r,i){i||(i=fr(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let o=e;o<n;o++){const e=t.children[o];ir(i,t.leaf?r(e):e)}return i}function ir(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function or(t,e){return t.minX-e.minX}function sr(t,e){return t.minY-e.minY}function ar(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function lr(t){return t.maxX-t.minX+(t.maxY-t.minY)}function ur(t,e){const n=Math.max(t.minX,e.minX),r=Math.max(t.minY,e.minY),i=Math.min(t.maxX,e.maxX),o=Math.min(t.maxY,e.maxY);return Math.max(0,i-n)*Math.max(0,o-r)}function hr(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function cr(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function fr(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function pr(t,e,n,r,i){const o=[e,n];for(;o.length;){if((n=o.pop())-(e=o.pop())<=r)continue;const s=e+Math.ceil((n-e)/r/2)*r;Hn(t,s,e,n,i),o.push(e,s,s,n)}}class dr{constructor(t=[],e=gr){if(this.data=t,this.length=this.data.length,this.compare=e,this.length>0)for(let t=(this.length>>1)-1;t>=0;t--)this._down(t)}push(t){this.data.push(t),this.length++,this._up(this.length-1)}pop(){if(0===this.length)return;const t=this.data[0],e=this.data.pop();return this.length--,this.length>0&&(this.data[0]=e,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:e,compare:n}=this,r=e[t];for(;t>0;){const i=t-1>>1,o=e[i];if(n(r,o)>=0)break;e[t]=o,t=i}e[t]=r}_down(t){const{data:e,compare:n}=this,r=this.length>>1,i=e[t];for(;t<r;){let r=1+(t<<1),o=e[r];const s=r+1;if(s<this.length&&n(e[s],o)<0&&(r=s,o=e[s]),n(o,i)>=0)break;e[t]=o,t=r}e[t]=i}}function gr(t,e){return t<e?-1:t>e?1:0}function yr(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var xr={exports:{}},mr=function(t,e,n,r){var i=t[0],o=t[1],s=!1;void 0===n&&(n=0),void 0===r&&(r=e.length);for(var a=(r-n)/2,l=0,u=a-1;l<a;u=l++){var h=e[n+2*l+0],c=e[n+2*l+1],f=e[n+2*u+0],p=e[n+2*u+1];c>o!=p>o&&i<(f-h)*(o-c)/(p-c)+h&&(s=!s)}return s},vr=function(t,e,n,r){var i=t[0],o=t[1],s=!1;void 0===n&&(n=0),void 0===r&&(r=e.length);for(var a=r-n,l=0,u=a-1;l<a;u=l++){var h=e[l+n][0],c=e[l+n][1],f=e[u+n][0],p=e[u+n][1];c>o!=p>o&&i<(f-h)*(o-c)/(p-c)+h&&(s=!s)}return s};xr.exports=function(t,e,n,r){return e.length>0&&Array.isArray(e[0])?vr(t,e,n,r):mr(t,e,n,r)};var wr=xr.exports.nested=vr;xr.exports.flat=mr;const Mr=11102230246251565e-32,br=134217729,Pr=(3+8*Mr)*Mr;function _r(t,e,n,r,i){let o,s,a,l,u=e[0],h=r[0],c=0,f=0;h>u==h>-u?(o=u,u=e[++c]):(o=h,h=r[++f]);let p=0;if(c<t&&f<n)for(h>u==h>-u?(s=u+o,a=o-(s-u),u=e[++c]):(s=h+o,a=o-(s-h),h=r[++f]),o=s,0!==a&&(i[p++]=a);c<t&&f<n;)h>u==h>-u?(s=o+u,l=s-o,a=o-(s-l)+(u-l),u=e[++c]):(s=o+h,l=s-o,a=o-(s-l)+(h-l),h=r[++f]),o=s,0!==a&&(i[p++]=a);for(;c<t;)s=o+u,l=s-o,a=o-(s-l)+(u-l),u=e[++c],o=s,0!==a&&(i[p++]=a);for(;f<n;)s=o+h,l=s-o,a=o-(s-l)+(h-l),h=r[++f],o=s,0!==a&&(i[p++]=a);return 0===o&&0!==p||(i[p++]=o),p}function Ir(t){return new Float64Array(t)}const Ar=33306690738754716e-32,Sr=22204460492503146e-32,Tr=11093356479670487e-47,Fr=Ir(4),kr=Ir(8),Lr=Ir(12),Br=Ir(16),Cr=Ir(4);function Yr(t,e,n,r,i,o){const s=(e-o)*(n-i),a=(t-i)*(r-o),l=s-a;if(0===s||0===a||s>0!=a>0)return l;const u=Math.abs(s+a);return Math.abs(l)>=Ar*u?l:-function(t,e,n,r,i,o,s){let a,l,u,h,c,f,p,d,g,y,x,m,v,w,M,b,P,_;const I=t-i,A=n-i,S=e-o,T=r-o;w=I*T,f=br*I,p=f-(f-I),d=I-p,f=br*T,g=f-(f-T),y=T-g,M=d*y-(w-p*g-d*g-p*y),b=S*A,f=br*S,p=f-(f-S),d=S-p,f=br*A,g=f-(f-A),y=A-g,P=d*y-(b-p*g-d*g-p*y),x=M-P,c=M-x,Fr[0]=M-(x+c)+(c-P),m=w+x,c=m-w,v=w-(m-c)+(x-c),x=v-b,c=v-x,Fr[1]=v-(x+c)+(c-b),_=m+x,c=_-m,Fr[2]=m-(_-c)+(x-c),Fr[3]=_;let F=function(t,e){let n=e[0];for(let r=1;r<t;r++)n+=e[r];return n}(4,Fr),k=Sr*s;if(F>=k||-F>=k)return F;if(c=t-I,a=t-(I+c)+(c-i),c=n-A,u=n-(A+c)+(c-i),c=e-S,l=e-(S+c)+(c-o),c=r-T,h=r-(T+c)+(c-o),0===a&&0===l&&0===u&&0===h)return F;if(k=Tr*s+Pr*Math.abs(F),F+=I*h+T*a-(S*u+A*l),F>=k||-F>=k)return F;w=a*T,f=br*a,p=f-(f-a),d=a-p,f=br*T,g=f-(f-T),y=T-g,M=d*y-(w-p*g-d*g-p*y),b=l*A,f=br*l,p=f-(f-l),d=l-p,f=br*A,g=f-(f-A),y=A-g,P=d*y-(b-p*g-d*g-p*y),x=M-P,c=M-x,Cr[0]=M-(x+c)+(c-P),m=w+x,c=m-w,v=w-(m-c)+(x-c),x=v-b,c=v-x,Cr[1]=v-(x+c)+(c-b),_=m+x,c=_-m,Cr[2]=m-(_-c)+(x-c),Cr[3]=_;const L=_r(4,Fr,4,Cr,kr);w=I*h,f=br*I,p=f-(f-I),d=I-p,f=br*h,g=f-(f-h),y=h-g,M=d*y-(w-p*g-d*g-p*y),b=S*u,f=br*S,p=f-(f-S),d=S-p,f=br*u,g=f-(f-u),y=u-g,P=d*y-(b-p*g-d*g-p*y),x=M-P,c=M-x,Cr[0]=M-(x+c)+(c-P),m=w+x,c=m-w,v=w-(m-c)+(x-c),x=v-b,c=v-x,Cr[1]=v-(x+c)+(c-b),_=m+x,c=_-m,Cr[2]=m-(_-c)+(x-c),Cr[3]=_;const B=_r(L,kr,4,Cr,Lr);w=a*h,f=br*a,p=f-(f-a),d=a-p,f=br*h,g=f-(f-h),y=h-g,M=d*y-(w-p*g-d*g-p*y),b=l*u,f=br*l,p=f-(f-l),d=l-p,f=br*u,g=f-(f-u),y=u-g,P=d*y-(b-p*g-d*g-p*y),x=M-P,c=M-x,Cr[0]=M-(x+c)+(c-P),m=w+x,c=m-w,v=w-(m-c)+(x-c),x=v-b,c=v-x,Cr[1]=v-(x+c)+(c-b),_=m+x,c=_-m,Cr[2]=m-(_-c)+(x-c),Cr[3]=_;const C=_r(B,Lr,4,Cr,Br);return Br[C-1]}(t,e,n,r,i,o,u)}function Or(t,e,n){e=Math.max(0,void 0===e?2:e),n=n||0;var r=function(t){for(var e=t[0],n=t[0],r=t[0],i=t[0],o=0;o<t.length;o++){var s=t[o];s[0]<e[0]&&(e=s),s[0]>r[0]&&(r=s),s[1]<n[1]&&(n=s),s[1]>i[1]&&(i=s)}var a=[e,n,r,i],l=a.slice();for(o=0;o<t.length;o++)wr(t[o],a)||l.push(t[o]);return function(t){t.sort(Ur);for(var e=[],n=0;n<t.length;n++){for(;e.length>=2&&Dr(e[e.length-2],e[e.length-1],t[n])<=0;)e.pop();e.push(t[n])}for(var r=[],i=t.length-1;i>=0;i--){for(;r.length>=2&&Dr(r[r.length-2],r[r.length-1],t[i])<=0;)r.pop();r.push(t[i])}return r.pop(),e.pop(),e.concat(r)}(l)}(t),i=new tr(16);i.toBBox=function(t){return{minX:t[0],minY:t[1],maxX:t[0],maxY:t[1]}},i.compareMinX=function(t,e){return t[0]-e[0]},i.compareMinY=function(t,e){return t[1]-e[1]},i.load(t);for(var o,s=[],a=0;a<r.length;a++){var l=r[a];i.remove(l),o=qr(l,o),s.push(o)}var u=new tr(16);for(a=0;a<s.length;a++)u.insert($r(s[a]));for(var h=e*e,c=n*n;s.length;){var f=s.shift(),p=f.p,d=f.next.p,g=jr(p,d);if(!(g<c)){var y=g/h;(l=Vr(i,f.prev.p,p,d,f.next.next.p,y,u))&&Math.min(jr(l,p),jr(l,d))<=y&&(s.push(f),s.push(qr(l,f)),i.remove(l),u.remove(f),u.insert($r(f)),u.insert($r(f.next)))}}f=o;var x=[];do{x.push(f.p),f=f.next}while(f!==o);return x.push(f.p),x}function Vr(t,e,n,r,i,o,s){for(var a=new dr([],Xr),l=t.data;l;){for(var u=0;u<l.children.length;u++){var h=l.children[u],c=l.leaf?Gr(h,n,r):Er(n,r,h);c>o||a.push({node:h,dist:c})}for(;a.length&&!a.peek().node.children;){var f=a.pop(),p=f.node,d=Gr(p,e,n),g=Gr(p,r,i);if(f.dist<d&&f.dist<g&&zr(n,p,s)&&zr(r,p,s))return p}(l=a.pop())&&(l=l.node)}return null}function Xr(t,e){return t.dist-e.dist}function Er(t,e,n){if(Nr(t,n)||Nr(e,n))return 0;var r=Zr(t[0],t[1],e[0],e[1],n.minX,n.minY,n.maxX,n.minY);if(0===r)return 0;var i=Zr(t[0],t[1],e[0],e[1],n.minX,n.minY,n.minX,n.maxY);if(0===i)return 0;var o=Zr(t[0],t[1],e[0],e[1],n.maxX,n.minY,n.maxX,n.maxY);if(0===o)return 0;var s=Zr(t[0],t[1],e[0],e[1],n.minX,n.maxY,n.maxX,n.maxY);return 0===s?0:Math.min(r,i,o,s)}function Nr(t,e){return t[0]>=e.minX&&t[0]<=e.maxX&&t[1]>=e.minY&&t[1]<=e.maxY}function zr(t,e,n){for(var r,i,o,s,a=Math.min(t[0],e[0]),l=Math.min(t[1],e[1]),u=Math.max(t[0],e[0]),h=Math.max(t[1],e[1]),c=n.search({minX:a,minY:l,maxX:u,maxY:h}),f=0;f<c.length;f++)if(r=c[f].p,i=c[f].next.p,o=t,r!==(s=e)&&i!==o&&Dr(r,i,o)>0!=Dr(r,i,s)>0&&Dr(o,s,r)>0!=Dr(o,s,i)>0)return!1;return!0}function Dr(t,e,n){return Yr(t[0],t[1],e[0],e[1],n[0],n[1])}function $r(t){var e=t.p,n=t.next.p;return t.minX=Math.min(e[0],n[0]),t.minY=Math.min(e[1],n[1]),t.maxX=Math.max(e[0],n[0]),t.maxY=Math.max(e[1],n[1]),t}function qr(t,e){var n={p:t,prev:null,next:null,minX:0,minY:0,maxX:0,maxY:0};return e?(n.next=e.next,n.prev=e,e.next.prev=n,e.next=n):(n.prev=n,n.next=n),n}function jr(t,e){var n=t[0]-e[0],r=t[1]-e[1];return n*n+r*r}function Gr(t,e,n){var r=e[0],i=e[1],o=n[0]-r,s=n[1]-i;if(0!==o||0!==s){var a=((t[0]-r)*o+(t[1]-i)*s)/(o*o+s*s);a>1?(r=n[0],i=n[1]):a>0&&(r+=o*a,i+=s*a)}return(o=t[0]-r)*o+(s=t[1]-i)*s}function Zr(t,e,n,r,i,o,s,a){var l,u,h,c,f=n-t,p=r-e,d=s-i,g=a-o,y=t-i,x=e-o,m=f*f+p*p,v=f*d+p*g,w=d*d+g*g,M=f*y+p*x,b=d*y+g*x,P=m*w-v*v,_=P,I=P;0===P?(u=0,_=1,c=b,I=w):(c=m*b-v*M,(u=v*b-w*M)<0?(u=0,c=b,I=w):u>_&&(u=_,c=b+v,I=w)),c<0?(c=0,-M<0?u=0:-M>m?u=_:(u=-M,_=m)):c>I&&(c=I,-M+v<0?u=0:-M+v>m?u=_:(u=-M+v,_=m));var A=(1-(h=0===c?0:c/I))*i+h*s-((1-(l=0===u?0:u/_))*t+l*n),S=(1-h)*o+h*a-((1-l)*e+l*r);return A*A+S*S}function Ur(t,e){return t[0]===e[0]?t[1]-e[1]:t[0]-e[0]}const{PackUtil:Rr}=ne();class Jr{constructor(t,e){this.x=t,this.y=e}clone(){return new Jr(this.x,this.y)}normalize(){const t=this.length();this.x/=t,this.y/=t}negate(){this.x=-this.x,this.y=-this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}diff(t){return new Jr(this.x-t.x,this.y-t.y)}distance(t){const e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)}dot(t){return this.x*t.x+this.y*t.y}equals(t){return this.x===t.x&&this.y===t.y}orthogonal(){return new Jr(this.y,-this.x)}}function Hr(t,e,n,r){const i=e.x*r.y-e.y*r.x,o=n.x-t.x,s=n.y-t.y,a=(o*r.y-s*r.x)/i;return new Jr(t.x+a*e.x,t.y+a*e.y)}const Wr=[],Kr=[];function Qr(t){if(S(t[0]&&t[0].x)){const e=[];let n=0;for(let r=0;r<t.length;r++)Kr[n]?(Kr[n][0]=t[r].x,Kr[n][1]=t[r].y):Kr[n]=[t[r].x,t[r].y],e.push(Kr[n]),n++;t=e}try{const e=Or(t,1/0);let n=[1/0,1/0],r=[-1/0,-1/0];for(let t=0;t<e.length;t++)e[t][0]<n[0]&&(n[0]=e[t][0]),e[t][0]>r[0]&&(r[0]=e[t][0]),e[t][1]<n[1]&&(n[1]=e[t][1]),e[t][1]>r[1]&&(r[1]=e[t][1]);const i=[];let o=[],s=0;for(let t=0;t<e.length;t++)t===e.length-1&&e[t][0]===e[0][0]&&e[t][1]===e[0][1]||(Pt(i,e[t],"EPSG:3857"),Wr[s]?(Wr[s].x=i[0],Wr[s].y=i[1]):Wr[s]=new Jr(i[0],i[1]),o.push(Wr[s]),s++);Rr.calculateSignedArea(o)<0&&(o=o.reverse());const a=function(t){let e,n=Number.MAX_VALUE;const r=function(t,r,i,o,s,a,l,u){var h=Hr(t,r,s,a),c=Hr(i,o,s,a),f=Hr(l,u,t,r),p=Hr(l,u,i,o),d=h.distance(c)*h.distance(f);0!==d&&d<n&&(e=[h,f,p,c],n=d)};var i=[];for(let e=0;e<t.length;e++)i.push(t[(e+1)%t.length].diff(t[e])),i[e].normalize();var o,s,a,l,u=new Jr(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),h=new Jr(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let e=0;e<t.length;e++){var c=t[e];c.x<u.x&&(u.x=c.x,o=e),c.x>h.x&&(h.x=c.x,s=e),c.y<u.y&&(u.y=c.y,l=e),c.y>h.y&&(h.y=c.y,a=e)}var f=new Jr(0,-1),p=new Jr(0,1),d=new Jr(-1,0),g=new Jr(1,0);for(let e=0;e<t.length;e++){var y=[Math.acos(f.dot(i[o])),Math.acos(p.dot(i[s])),Math.acos(d.dot(i[a])),Math.acos(g.dot(i[l]))];switch(y.indexOf(Math.min.apply(Math,y))){case 0:(p=(f=i[o].clone()).clone()).negate(),(g=(d=f.orthogonal()).clone()).negate(),o=(o+1)%t.length;break;case 1:(f=(p=i[s].clone()).clone()).negate(),(g=(d=f.orthogonal()).clone()).negate(),s=(s+1)%t.length;break;case 2:(g=(d=i[a].clone()).clone()).negate(),(p=(f=g.orthogonal()).clone()).negate(),a=(a+1)%t.length;break;case 3:(d=(g=i[l].clone()).clone()).negate(),(p=(f=g.orthogonal()).clone()).negate(),l=(l+1)%t.length}r(t[o],f,t[s],p,t[a],d,t[l],g)}return e}(o);if(!a||4!==a.length)return null;const l=a[0].distance(a[1]),u=a[1].distance(a[2]),h=a.map((t=>[t.x,t.y]));return h.push(+(u>l)),h}catch(t){return null}}const ti=[];function ei(t,e){const n=Array.isArray(t&&t[0]&&t[0][0]);for(let r=0;r<t.length;r++)n?t[r]=ei(t[r]):(Pt(ti,t[r],e),t[r][0]=ti[0],t[r][1]=ti[1]);return t}const{PackUtil:ni}=ne();class ri extends kn{constructor(t,e,n,r,i,o){super(t,e,n,r,i),(e=e||{}).extent||(e.extent=8192),this.setData(e.data,o)}clearData(){delete this.index}setData(t,e){if(delete this.index,function(t){if(!t)return!0;if(Array.isArray(t)&&!t.length)return!0;if(t.features&&!t.features.length)return!0;return!1}(t))return this.empty=!0,void e();const n={maxZoom:24,tolerance:this.options.simplifyTolerance,extent:this.options.extent,buffer:S(this.options.tileBuffer)?this.options.tileBuffer:64,hasAltitude:!!this.options.hasAltitude,debug:0,lineMetrics:!0,indexMaxZoom:5,indexMaxPoints:1e5,disableFilter:!0};if(this.options.projection&&(n.projection=this.options.projection,"EPSG:4490"===n.projection&&(n.projection="EPSG:4326")),A(t)&&"{"!=t.substring(0,1)||t.url){const r=t.url?t.url:t;C.getJSON(r,t.url?t:{},((t,i)=>{if(t&&(console.error("Failed to fetch geojson:"+r),e(t)),!i)return void e(null,{extent:null,idMap:{}});let o=i;if(this.options.convertFn){o=new Function("data",this.options.convertFn+"\\nreturn convert(data)")(o)}const s=Array.isArray(o)?o:o.features;this._genOMBB(s);const{sample1000:a,idMap:l}=this._generateId(s);this._generate(a,l,o,n,e)}))}else{"string"==typeof t&&(t=JSON.parse(t));const r=Array.isArray(t)?t:t.features,i=r&&r.length;this._genOMBB(r);let o=r;if(r&&i>1e3){o=[];for(let t=0;t<i;t++)ii(r[t],o,t,i)}this._generate(o,null,t,n,e)}}_genOMBB(t){if(this.options.generateOMBB&&t)for(let e=0;e<t.length;e++){const n=t[e];if(n&&n.geometry&&n.geometry.coordinates)if("Polygon"===n.geometry.type){const t=n.geometry.coordinates[0];if(!t)continue;const e=Qr(t,t.length);n.properties=n.properties||{},n.properties[ee]=e}else if("MultiPolygon"===n.geometry.type){const t=n.geometry.coordinates;for(let e=0;e<t.length;e++){if(!t[e])continue;const r=t[e][0];if(!r)continue;const i=Qr(r,r.length);n.properties=n.properties||{},n.properties[ee]=n.properties[ee]||[],n.properties[ee][e]=i}}}}_generate(t,e,n,r,i){try{const o=t&&t.length?function(t){let e=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];switch(t.type){case"FeatureCollection":const n=t.features.length;for(let r=0;r<n;r++)Gn(t.features[r],e);break;case"Feature":Gn(t,e);break;default:Zn(t,e)}return e}({type:"FeatureCollection",features:t}):null;this.index=function(t,e){return new ut(t,e)}(n,this.options.geojsonvt||r),i(null,{extent:o,idMap:e})}catch(t){console.warn(t),i({error:t.message})}}_generateId(t){const e=[],n={};let r=0;const i=this.options.featureIdProperty;if(t){const o=t.length;t.forEach(((t,s)=>{!function(t,o,s){if(t&&("Feature"!==t.type||t.geometry)){if(S(t.id)||(t.id=r++),i){let e=i;F(i)&&(e=i[t.layer||"0"]),t.id=t.properties[e]}n[t.id]=I({},t),t.geometry?(n[t.id].geometry=I({},t.geometry),n[t.id].geometry.coordinates=null):t.coordinates&&(n[t.id].coordinates=null),ii(t,e,o,s)}}(t,s,o)}))}return{sample1000:e,idMap:n}}getTileFeatures(t,e){const n=t.tileInfo,r=[];if(!this.index)return this.empty?(setTimeout((function(){e(null,r,[])}),1),1):(setTimeout((function(){e({loading:!0})}),1),1);const i=this.index.getTile(n.z,n.x,n.y);if(!i||0===i.features.length)return setTimeout((function(){e(null,r,[])}),1),1;const o=[];for(let t=0,e=i.features.length;t<e;t++){const e=i.features[t];let n=e.layer;void 0===n&&(n="0"),o[n]={types:{}};o[n].types[e.type]=1,e.tags=e.tags||{},e.geometry.converted||(ni.convertGeometry(e),e.geometry.converted=1),r.push({type:e.type,layer:n,id:e.id,geometry:e.geometry,properties:e.tags,extent:this.options.extent})}for(const t in o)o[t].types=Object.keys(o[t].types).map((t=>+t));return setTimeout((function(){e(null,r,o)}),1),1}onRemove(){super.onRemove(),delete this.index}}function ii(t,e,n,r){const i=Math.floor(r/998);(0===n||n===r-1||(0===i||n%i==0)&&e.length<999)&&e.push(t)}var oi={\n/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */\nread:function(t,e,n,r,i){var o,s,a=8*i-r-1,l=(1<<a)-1,u=l>>1,h=-7,c=n?i-1:0,f=n?-1:1,p=t[e+c];for(c+=f,o=p&(1<<-h)-1,p>>=-h,h+=a;h>0;o=256*o+t[e+c],c+=f,h-=8);for(s=o&(1<<-h)-1,o>>=-h,h+=r;h>0;s=256*s+t[e+c],c+=f,h-=8);if(0===o)o=1-u;else{if(o===l)return s?NaN:1/0*(p?-1:1);s+=Math.pow(2,r),o-=u}return(p?-1:1)*s*Math.pow(2,o-r)},write:function(t,e,n,r,i,o){var s,a,l,u=8*o-i-1,h=(1<<u)-1,c=h>>1,f=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,p=r?0:o-1,d=r?1:-1,g=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,s=h):(s=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-s))<1&&(s--,l*=2),(e+=s+c>=1?f/l:f*Math.pow(2,1-c))*l>=2&&(s++,l/=2),s+c>=h?(a=0,s=h):s+c>=1?(a=(e*l-1)*Math.pow(2,i),s+=c):(a=e*Math.pow(2,c-1)*Math.pow(2,i),s=0));i>=8;t[n+p]=255&a,p+=d,a/=256,i-=8);for(s=s<<i|a,u+=i;u>0;t[n+p]=255&s,p+=d,s/=256,u-=8);t[n+p-d]|=128*g}},si=li,ai=oi;function li(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}li.Varint=0,li.Fixed64=1,li.Bytes=2,li.Fixed32=5;var ui=4294967296,hi=1/ui,ci="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function fi(t){return t.type===li.Bytes?t.readVarint()+t.pos:t.pos+1}function pi(t,e,n){return n?4294967296*e+(t>>>0):4294967296*(e>>>0)+(t>>>0)}function di(t,e,n){var r=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));n.realloc(r);for(var i=n.pos-1;i>=t;i--)n.buf[i+r]=n.buf[i]}function gi(t,e){for(var n=0;n<t.length;n++)e.writeVarint(t[n])}function yi(t,e){for(var n=0;n<t.length;n++)e.writeSVarint(t[n])}function xi(t,e){for(var n=0;n<t.length;n++)e.writeFloat(t[n])}function mi(t,e){for(var n=0;n<t.length;n++)e.writeDouble(t[n])}function vi(t,e){for(var n=0;n<t.length;n++)e.writeBoolean(t[n])}function wi(t,e){for(var n=0;n<t.length;n++)e.writeFixed32(t[n])}function Mi(t,e){for(var n=0;n<t.length;n++)e.writeSFixed32(t[n])}function bi(t,e){for(var n=0;n<t.length;n++)e.writeFixed64(t[n])}function Pi(t,e){for(var n=0;n<t.length;n++)e.writeSFixed64(t[n])}function _i(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+16777216*t[e+3]}function Ii(t,e,n){t[n]=e,t[n+1]=e>>>8,t[n+2]=e>>>16,t[n+3]=e>>>24}function Ai(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}li.prototype={destroy:function(){this.buf=null},readFields:function(t,e,n){for(n=n||this.length;this.pos<n;){var r=this.readVarint(),i=r>>3,o=this.pos;this.type=7&r,t(i,e,this),this.pos===o&&this.skip(r)}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=_i(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=Ai(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=_i(this.buf,this.pos)+_i(this.buf,this.pos+4)*ui;return this.pos+=8,t},readSFixed64:function(){var t=_i(this.buf,this.pos)+Ai(this.buf,this.pos+4)*ui;return this.pos+=8,t},readFloat:function(){var t=ai.read(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=ai.read(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var e,n,r=this.buf;return e=127&(n=r[this.pos++]),n<128?e:(e|=(127&(n=r[this.pos++]))<<7,n<128?e:(e|=(127&(n=r[this.pos++]))<<14,n<128?e:(e|=(127&(n=r[this.pos++]))<<21,n<128?e:function(t,e,n){var r,i,o=n.buf;if(i=o[n.pos++],r=(112&i)>>4,i<128)return pi(t,r,e);if(i=o[n.pos++],r|=(127&i)<<3,i<128)return pi(t,r,e);if(i=o[n.pos++],r|=(127&i)<<10,i<128)return pi(t,r,e);if(i=o[n.pos++],r|=(127&i)<<17,i<128)return pi(t,r,e);if(i=o[n.pos++],r|=(127&i)<<24,i<128)return pi(t,r,e);if(i=o[n.pos++],r|=(1&i)<<31,i<128)return pi(t,r,e);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(n=r[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=12&&ci?function(t,e,n){return ci.decode(t.subarray(e,n))}(this.buf,e,t):function(t,e,n){var r="",i=e;for(;i<n;){var o,s,a,l=t[i],u=null,h=l>239?4:l>223?3:l>191?2:1;if(i+h>n)break;1===h?l<128&&(u=l):2===h?128==(192&(o=t[i+1]))&&(u=(31&l)<<6|63&o)<=127&&(u=null):3===h?(o=t[i+1],s=t[i+2],128==(192&o)&&128==(192&s)&&((u=(15&l)<<12|(63&o)<<6|63&s)<=2047||u>=55296&&u<=57343)&&(u=null)):4===h&&(o=t[i+1],s=t[i+2],a=t[i+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&((u=(15&l)<<18|(63&o)<<12|(63&s)<<6|63&a)<=65535||u>=1114112)&&(u=null)),null===u?(u=65533,h=1):u>65535&&(u-=65536,r+=String.fromCharCode(u>>>10&1023|55296),u=56320|1023&u),r+=String.fromCharCode(u),i+=h}return r}(this.buf,e,t)},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,e){if(this.type!==li.Bytes)return t.push(this.readVarint(e));var n=fi(this);for(t=t||[];this.pos<n;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){if(this.type!==li.Bytes)return t.push(this.readSVarint());var e=fi(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==li.Bytes)return t.push(this.readBoolean());var e=fi(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==li.Bytes)return t.push(this.readFloat());var e=fi(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==li.Bytes)return t.push(this.readDouble());var e=fi(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==li.Bytes)return t.push(this.readFixed32());var e=fi(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==li.Bytes)return t.push(this.readSFixed32());var e=fi(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==li.Bytes)return t.push(this.readFixed64());var e=fi(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==li.Bytes)return t.push(this.readSFixed64());var e=fi(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=7&t;if(e===li.Varint)for(;this.buf[this.pos++]>127;);else if(e===li.Bytes)this.pos=this.readVarint()+this.pos;else if(e===li.Fixed32)this.pos+=4;else{if(e!==li.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(t,e){this.writeVarint(t<<3|e)},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var n=new Uint8Array(e);n.set(this.buf),this.buf=n,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),Ii(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),Ii(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),Ii(this.buf,-1&t,this.pos),Ii(this.buf,Math.floor(t*hi),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),Ii(this.buf,-1&t,this.pos),Ii(this.buf,Math.floor(t*hi),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(t,e){var n,r;t>=0?(n=t%4294967296|0,r=t/4294967296|0):(r=~(-t/4294967296),4294967295^(n=~(-t%4294967296))?n=n+1|0:(n=0,r=r+1|0));if(t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),function(t,e,n){n.buf[n.pos++]=127&t|128,t>>>=7,n.buf[n.pos++]=127&t|128,t>>>=7,n.buf[n.pos++]=127&t|128,t>>>=7,n.buf[n.pos++]=127&t|128,t>>>=7,n.buf[n.pos]=127&t}(n,0,e),function(t,e){var n=(7&t)<<4;if(e.buf[e.pos++]|=n|((t>>>=3)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;e.buf[e.pos++]=127&t}(r,e)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(Boolean(t))},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var e=this.pos;this.pos=function(t,e,n){for(var r,i,o=0;o<e.length;o++){if((r=e.charCodeAt(o))>55295&&r<57344){if(!i){r>56319||o+1===e.length?(t[n++]=239,t[n++]=191,t[n++]=189):i=r;continue}if(r<56320){t[n++]=239,t[n++]=191,t[n++]=189,i=r;continue}r=i-55296<<10|r-56320|65536,i=null}else i&&(t[n++]=239,t[n++]=191,t[n++]=189,i=null);r<128?t[n++]=r:(r<2048?t[n++]=r>>6|192:(r<65536?t[n++]=r>>12|224:(t[n++]=r>>18|240,t[n++]=r>>12&63|128),t[n++]=r>>6&63|128),t[n++]=63&r|128)}return n}(this.buf,t,this.pos);var n=this.pos-e;n>=128&&di(e,n,this),this.pos=e-1,this.writeVarint(n),this.pos+=n},writeFloat:function(t){this.realloc(4),ai.write(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),ai.write(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var n=0;n<e;n++)this.buf[this.pos++]=t[n]},writeRawMessage:function(t,e){this.pos++;var n=this.pos;t(e,this);var r=this.pos-n;r>=128&&di(n,r,this),this.pos=n-1,this.writeVarint(r),this.pos+=r},writeMessage:function(t,e,n){this.writeTag(t,li.Bytes),this.writeRawMessage(e,n)},writePackedVarint:function(t,e){e.length&&this.writeMessage(t,gi,e)},writePackedSVarint:function(t,e){e.length&&this.writeMessage(t,yi,e)},writePackedBoolean:function(t,e){e.length&&this.writeMessage(t,vi,e)},writePackedFloat:function(t,e){e.length&&this.writeMessage(t,xi,e)},writePackedDouble:function(t,e){e.length&&this.writeMessage(t,mi,e)},writePackedFixed32:function(t,e){e.length&&this.writeMessage(t,wi,e)},writePackedSFixed32:function(t,e){e.length&&this.writeMessage(t,Mi,e)},writePackedFixed64:function(t,e){e.length&&this.writeMessage(t,bi,e)},writePackedSFixed64:function(t,e){e.length&&this.writeMessage(t,Pi,e)},writeBytesField:function(t,e){this.writeTag(t,li.Bytes),this.writeBytes(e)},writeFixed32Field:function(t,e){this.writeTag(t,li.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(t,e){this.writeTag(t,li.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(t,e){this.writeTag(t,li.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(t,e){this.writeTag(t,li.Fixed64),this.writeSFixed64(e)},writeVarintField:function(t,e){this.writeTag(t,li.Varint),this.writeVarint(e)},writeSVarintField:function(t,e){this.writeTag(t,li.Varint),this.writeSVarint(e)},writeStringField:function(t,e){this.writeTag(t,li.Bytes),this.writeString(e)},writeFloatField:function(t,e){this.writeTag(t,li.Fixed32),this.writeFloat(e)},writeDoubleField:function(t,e){this.writeTag(t,li.Fixed64),this.writeDouble(e)},writeBooleanField:function(t,e){this.writeVarintField(t,Boolean(e))}};var Si=yr(si),Ti=Fi;function Fi(t,e){this.x=t,this.y=e}Fi.prototype={clone:function(){return new Fi(this.x,this.y)},add:function(t){return this.clone()._add(t)},sub:function(t){return this.clone()._sub(t)},multByPoint:function(t){return this.clone()._multByPoint(t)},divByPoint:function(t){return this.clone()._divByPoint(t)},mult:function(t){return this.clone()._mult(t)},div:function(t){return this.clone()._div(t)},rotate:function(t){return this.clone()._rotate(t)},rotateAround:function(t,e){return this.clone()._rotateAround(t,e)},matMult:function(t){return this.clone()._matMult(t)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var e=t.x-this.x,n=t.y-this.y;return e*e+n*n},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},_matMult:function(t){var e=t[0]*this.x+t[1]*this.y,n=t[2]*this.x+t[3]*this.y;return this.x=e,this.y=n,this},_add:function(t){return this.x+=t.x,this.y+=t.y,this},_sub:function(t){return this.x-=t.x,this.y-=t.y,this},_mult:function(t){return this.x*=t,this.y*=t,this},_div:function(t){return this.x/=t,this.y/=t,this},_multByPoint:function(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint:function(t){return this.x/=t.x,this.y/=t.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var t=this.y;return this.y=this.x,this.x=-t,this},_rotate:function(t){var e=Math.cos(t),n=Math.sin(t),r=e*this.x-n*this.y,i=n*this.x+e*this.y;return this.x=r,this.y=i,this},_rotateAround:function(t,e){var n=Math.cos(t),r=Math.sin(t),i=e.x+n*(this.x-e.x)-r*(this.y-e.y),o=e.y+r*(this.x-e.x)+n*(this.y-e.y);return this.x=i,this.y=o,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},Fi.convert=function(t){return t instanceof Fi?t:Array.isArray(t)?new Fi(t[0],t[1]):t};var ki=Ti,Li=Bi;function Bi(t,e,n,r,i){this.properties={},this.extent=n,this.type=0,this._pbf=t,this._geometry=-1,this._keys=r,this._values=i,t.readFields(Ci,this,e)}function Ci(t,e,n){1==t?e.id=n.readVarint():2==t?function(t,e){var n=t.readVarint()+t.pos;for(;t.pos<n;){var r=e._keys[t.readVarint()],i=e._values[t.readVarint()];e.properties[r]=i}}(n,e):3==t?e.type=n.readVarint():4==t&&(e._geometry=n.pos)}function Yi(t){for(var e,n,r=0,i=0,o=t.length,s=o-1;i<o;s=i++)e=t[i],r+=((n=t[s]).x-e.x)*(e.y+n.y);return r}Bi.types=["Unknown","Point","LineString","Polygon"],Bi.prototype.loadGeometry=function(){var t=this._pbf;t.pos=this._geometry;for(var e,n=t.readVarint()+t.pos,r=1,i=0,o=0,s=0,a=[];t.pos<n;){if(i<=0){var l=t.readVarint();r=7&l,i=l>>3}if(i--,1===r||2===r)o+=t.readSVarint(),s+=t.readSVarint(),1===r&&(e&&a.push(e),e=[]),e.push(new ki(o,s));else{if(7!==r)throw new Error("unknown command "+r);e&&e.push(e[0].clone())}}return e&&a.push(e),a},Bi.prototype.bbox=function(){var t=this._pbf;t.pos=this._geometry;for(var e=t.readVarint()+t.pos,n=1,r=0,i=0,o=0,s=1/0,a=-1/0,l=1/0,u=-1/0;t.pos<e;){if(r<=0){var h=t.readVarint();n=7&h,r=h>>3}if(r--,1===n||2===n)(i+=t.readSVarint())<s&&(s=i),i>a&&(a=i),(o+=t.readSVarint())<l&&(l=o),o>u&&(u=o);else if(7!==n)throw new Error("unknown command "+n)}return[s,l,a,u]},Bi.prototype.toGeoJSON=function(t,e,n){var r,i,o=this.extent*Math.pow(2,n),s=this.extent*t,a=this.extent*e,l=this.loadGeometry(),u=Bi.types[this.type];function h(t){for(var e=0;e<t.length;e++){var n=t[e],r=180-360*(n.y+a)/o;t[e]=[360*(n.x+s)/o-180,360/Math.PI*Math.atan(Math.exp(r*Math.PI/180))-90]}}switch(this.type){case 1:var c=[];for(r=0;r<l.length;r++)c[r]=l[r][0];h(l=c);break;case 2:for(r=0;r<l.length;r++)h(l[r]);break;case 3:for(l=function(t){var e=t.length;if(e<=1)return[t];for(var n,r,i=[],o=0;o<e;o++){var s=Yi(t[o]);0!==s&&(void 0===r&&(r=s<0),r===s<0?(n&&i.push(n),n=[t[o]]):n.push(t[o]))}n&&i.push(n);return i}(l),r=0;r<l.length;r++)for(i=0;i<l[r].length;i++)h(l[r][i])}1===l.length?l=l[0]:u="Multi"+u;var f={type:"Feature",geometry:{type:u,coordinates:l},properties:this.properties};return"id"in this&&(f.id=this.id),f};var Oi=Li,Vi=Xi;function Xi(t,e){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=t,this._keys=[],this._values=[],this._features=[],t.readFields(Ei,this,e),this.length=this._features.length}function Ei(t,e,n){15===t?e.version=n.readVarint():1===t?e.name=n.readString():5===t?e.extent=n.readVarint():2===t?e._features.push(n.pos):3===t?e._keys.push(n.readString()):4===t&&e._values.push(function(t){var e=null,n=t.readVarint()+t.pos;for(;t.pos<n;){var r=t.readVarint()>>3;e=1===r?t.readString():2===r?t.readFloat():3===r?t.readDouble():4===r?t.readVarint64():5===r?t.readVarint():6===r?t.readSVarint():7===r?t.readBoolean():null}return e}(n))}Xi.prototype.feature=function(t){if(t<0||t>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[t];var e=this._pbf.readVarint()+this._pbf.pos;return new Oi(this._pbf,e,this.extent,this._keys,this._values)};var Ni=Vi,zi=function(t,e){this.layers=t.readFields(Di,{},e)};function Di(t,e,n){if(3===t){var r=new Ni(n,n.readVarint()+n.pos);r.length&&(e[r.name]=r)}}var $i=zi;const qi=2,ji=new TextDecoder("utf-8");class Gi extends kn{constructor(t,e,n,r,i,o){super(t,e,n,r,i),e=e||{},o()}clearData(){this._abortRequests()}getTileFeatures(t,e){const n=t.tileInfo.url,r=t.fetchOptions||{},{altitudePropertyName:i,disableAltitudeWarning:o}=t,s=this._cache.get(n);if(s&&s.cacheIndex===t.workerCacheIndex){const{err:t,data:r}=s;return setTimeout((()=>{this._readTile(n,i,o,t,r,e)}),1)}const{tileArrayBuffer:a}=t;return a?setTimeout((()=>{this._readTile(n,i,o,null,a,e)}),1):(r.referrer=t.referrer,r.errorLog=t.loadTileErrorLog,C.getArrayBuffer(n,r,((r,s)=>{this._cache&&(r?r.loading||this._cache.add(n,{err:r,data:s&&s.data,cacheIndex:t.workerCacheIndex}):s&&s.data&&this._cache.add(n,{err:null,data:s.data,cacheIndex:t.workerCacheIndex}),this._readTile(n,i,o,r,s&&s.data,e))})))}_readTile(t,e,n,r,i,o){if(r)return void o(r);let s;try{s=new $i(new Si(i))}catch(r){const e=ji.decode(i);return r.message+="\\n"+t+"\\n"+e,void o(r.message,[],[])}const a=[];if(!s.layers)return void o(null,a,[]);const l={};let u;for(const t in s.layers)if(h=s.layers,c=t,Object.prototype.hasOwnProperty.call(h,c)){l[t]={types:{}};const i=l[t].types;for(let o=0,l=s.layers[t].length;o<l;o++)try{u=s.layers[t].feature(o),i[u.type]=1;const r={type:u.type,layer:t,geometry:u.loadGeometry(),properties:u.properties,extent:u.extent};void 0!==u.id&&(r.id=u.id);let l=r.properties[ee];l&&(A(l)&&(l=JSON.parse(l)),r.properties[ee]=ei(l,"EPSG:3857"));const h=e&&r.properties[e];if(h){const t=Zi(h),e=[];Ui(r.geometry,t,e),e.length&&!n&&(console.warn("feature.geometry is not consistent with altitude values:"),console.warn(JSON.stringify(r,null,2)))}a.push(r)}catch(r){console.warn("error when load vt geometry:",r)}}var h,c;for(const t in l)l[t].types=Object.keys(l[t].types).map((t=>+t));o(null,a,l,{byteLength:i.byteLength})}abortTile(t,e){const n=this.requests[t];delete this.requests[t],n&&n.abort&&n.abort(),this._cancelLoadings(t),e()}onRemove(){super.onRemove(),this._abortRequests()}_abortRequests(){for(const t in this.requests){const e=this.requests[t];e&&e.abort&&e.abort()}this.requests={}}}function Zi(t){const e=atob(t),n=new Uint8Array(e.length);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return new Float32Array(n.buffer)}function Ui(t,e,n,r){r||(r={index:0});for(let i=0;i<t.length;i++)if(Array.isArray(t[i]))Ui(t[i],e,n,r);else{const o=r.index;k(e[o])?n.push(qi):t[i].z=100*e[o],r.index++}}const{LRUCache:Ri}=ne();let Ji=0;const Hi=new Ri(128);class Wi{constructor(t){this._layers={},this._callbacks={},this.workerId=t}addLayer({actorId:t,mapId:e,layerId:n,params:r},i){if(this._getLayerById(e,n))return;const o=this._genKey(e,n),s=r.type,a=r.options,l=this.send.bind(this,t);this._layers[o]="GeoJSONVectorTileLayer"===s?new ri(n,a,l,Hi,{},i):new Gi(n,a,l,Hi,{},i)}removeLayer({mapId:t,layerId:e},n){const r=this._getLayerById(t,e),i=this._genKey(t,e);delete this._layers[i],r&&r.onRemove(n)}loadTile({mapId:t,layerId:e,params:n},r){const i=this._getLayerById(t,e);i&&i.loadTile(n,r)}abortTile({mapId:t,layerId:e,params:n},r){const i=this._getLayerById(t,e);i&&i.abortTile&&i.abortTile(n.url,r)}removeTile({mapId:t,layerId:e,params:n},r){const i=this._getLayerById(t,e);i&&i.removeTile(n,r)}updateStyle({mapId:t,layerId:e,params:n},r){const i=this._getLayerById(t,e);i&&i.updateStyle(n,r)}updateOptions({mapId:t,layerId:e,params:n},r){const i=this._getLayerById(t,e);i&&i.updateOptions(n,r)}setData({mapId:t,layerId:e,params:n},r){const i=this._getLayerById(t,e);i&&i.setData(n.data,r)}clearData({mapId:t,layerId:e},n){const r=this._getLayerById(t,e);r&&(r.clearData(n),this._resetCache())}receive(t){const e=t.callback,n=this._callbacks[e];delete this._callbacks[e],n&&t.error?n(new Error(t.error)):n&&n(null,t.data)}send(t,e,n,r,i){const o=i?\`${QR}t}-${QR}Ji++}\`:null;i&&(this._callbacks[o]=i),postMessage({type:"<request>",workerId:this.workerId,actorId:t,command:e,params:n,callback:String(o)},r||[])}_genKey(t,e){return\`${QR}t}-${QR}e}\`}_getLayerById(t,e){const n=this._genKey(t,e);return this._layers[n]}_resetCache(){Hi.reset()}}t.initialize=function(){},t.onmessage=function(t,e){const n=t.data;if(this.dispatcher||(this.dispatcher=new Wi(t.workerId)),"<response>"===t.type)this.dispatcher.workerId===t.workerId&&this.dispatcher.receive(t);else{const r=n.command,i=(n.params||{}).loadTileErrorLog,o=(n.params||{}).loadTileErrorLogIgnoreCodes||[];this.dispatcher[r]({actorId:t.actorId,mapId:n.mapId,layerId:n.layerId,params:n.params},((t,n,s)=>{if(i&&t&&!t.loading){const e=t.status;S(e)&&-1===o.indexOf(e)&&console.error(r,t)}e(t,n,s)}))}}}`;function KR(e){const t=function(){return"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:void 0};if(t().maptalks_vt_packers)return;function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var i=s;function s(e,t){this.x=e,this.y=t}s.prototype={clone:function(){return new s(this.x,this.y)},add:function(e){return this.clone()._add(e)},sub:function(e){return this.clone()._sub(e)},multByPoint:function(e){return this.clone()._multByPoint(e)},divByPoint:function(e){return this.clone()._divByPoint(e)},mult:function(e){return this.clone()._mult(e)},div:function(e){return this.clone()._div(e)},rotate:function(e){return this.clone()._rotate(e)},rotateAround:function(e,t){return this.clone()._rotateAround(e,t)},matMult:function(e){return this.clone()._matMult(e)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(e){return this.x===e.x&&this.y===e.y},dist:function(e){return Math.sqrt(this.distSqr(e))},distSqr:function(e){var t=e.x-this.x,n=e.y-this.y;return t*t+n*n},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith:function(e){return this.angleWithSep(e.x,e.y)},angleWithSep:function(e,t){return Math.atan2(this.x*t-this.y*e,this.x*e+this.y*t)},_matMult:function(e){var t=e[2]*this.x+e[3]*this.y;return this.x=e[0]*this.x+e[1]*this.y,this.y=t,this},_add:function(e){return this.x+=e.x,this.y+=e.y,this},_sub:function(e){return this.x-=e.x,this.y-=e.y,this},_mult:function(e){return this.x*=e,this.y*=e,this},_div:function(e){return this.x/=e,this.y/=e,this},_multByPoint:function(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint:function(e){return this.x/=e.x,this.y/=e.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var e=this.y;return this.y=this.x,this.x=-e,this},_rotate:function(e){var t=Math.cos(e),n=Math.sin(e),i=n*this.x+t*this.y;return this.x=t*this.x-n*this.y,this.y=i,this},_rotateAround:function(e,t){var n=Math.cos(e),i=Math.sin(e),s=t.y+i*(this.x-t.x)+n*(this.y-t.y);return this.x=t.x+n*(this.x-t.x)-i*(this.y-t.y),this.y=s,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},s.convert=function(e){return e instanceof s?e:Array.isArray(e)?new s(e[0],e[1]):e};var o=n(i);const a={Point:1,LineString:2,Polygon:3,MultiPoint:4,MultiLineString:5,MultiPolygon:6};function l(e,t={}){var n=[];if("FeatureCollection"===e.type)for(var i=0;i<e.features.length;i++)h(n,e.features[i],t,i);else h(n,"Feature"===e.type?e:{geometry:e},t);return n}function h(e,t,n,i){if(t.geometry&&t.geometry.geometry){var s=t.geometry.coordinates,o=t.geometry.type,a=[],l=t.id;if(n.promoteId?l=t.properties[n.promoteId]:n.generateId&&(l=i||0),"Point"===o)c(s,a);else if("MultiPoint"===o)for(var m=0;m<s.length;m++)c(s[m],a);else if("LineString"===o)f([s],a);else if("MultiLineString"===o){if(n.lineMetrics){for(m=0;m<s.length;m++)u(s[m],a=[]),e.push(g(l,"LineString",a,t.properties));return}f(s,a)}else if("Polygon"===o)f(s,a);else{if("MultiPolygon"!==o){if("GeometryCollection"===o){for(m=0;m<t.geometry.geometries.length;m++)h(e,{id:l,geometry:t.geometry.geometries[m],properties:t.properties},n,i);return}return void console.warn(`Input data type(${o}) is not a valid GeoJSON geometry type.`)}for(m=0;m<s.length;m++){var A=[];f(s[m],A),a.push(A)}}e.push(g(l,o,a,t.properties))}}function c(e,t){const n=new o(e[0],e[1]);n.z=100*(e[2]||0),t.push([n])}function u(e,t){for(let n=0;n<e.length;n++){const i=new o(e[n][0],e[n][1]);i.z=100*(e[n][2]||0),t.push(i)}}function f(e,t,n,i){for(var s=0;s<e.length;s++){var o=[];u(e[s],o),t.push(o)}}function g(e,t,n,i){return{id:void 0===e?null:e,type:a[t],geometry:n,properties:i}}function m(e,t,n){n=n||{},this.w=e||64,this.h=t||64,this.autoResize=!!n.autoResize,this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0}function A(e,t,n){this.x=0,this.y=e,this.w=this.free=t,this.h=n}function w(e,t,n,i,s,o,a){this.id=e,this.x=t,this.y=n,this.w=i,this.h=s,this.maxw=o||i,this.maxh=a||s,this.refcount=0
/*!
  	 * Codes from mapbox-gl-js
  	 * github.com/mapbox/mapbox-gl-js
  	 * MIT License
  	 */}function T(e,{width:t,height:n},i,s){if(s){if(s.length!==t*n*i)throw new RangeError("mismatched image size")}else s=new Uint8Array(t*n*i);return e.width=t,e.height=n,e.data=s,e}function S(e,{width:t,height:n},i){if(t===e.width&&n===e.height)return;const s=T({},{width:t,height:n},i);M(e,s,{x:0,y:0},{x:0,y:0},{width:Math.min(e.width,t),height:Math.min(e.height,n)},i),e.width=t,e.height=n,e.data=s.data}function M(e,t,n,i,s,o){if(0===s.width||0===s.height)return t;if(s.width>e.width||s.height>e.height||n.x>e.width-s.width||n.y>e.height-s.height)throw new RangeError("out of range source coordinates for image copy");if(s.width>t.width||s.height>t.height||i.x>t.width-s.width||i.y>t.height-s.height)throw new RangeError("out of range destination coordinates for image copy");const a=e.data,l=t.data;if(a===l)return t;for(let h=0;h<s.height;h++){const c=((n.y+h)*e.width+n.x)*o,u=((i.y+h)*t.width+i.x)*o;for(let e=0;e<s.width*o;e++)l[u+e]=a[c+e]}return t}m.prototype.pack=function(e,t){e=[].concat(e),t=t||{};for(var n,i,s,o=[],a=0;a<e.length;a++)if(i=e[a].h||e[a].height,(n=e[a].w||e[a].width)&&i){if(!(s=this.packOne(n,i,e[a].id)))continue;t.inPlace&&(e[a].x=s.x,e[a].y=s.y,e[a].id=s.id),o.push(s)}return this.shrink(),o},m.prototype.packOne=function(e,t,n){var i,s,o,a,l,h,c,u,f={freebin:-1,shelf:-1,waste:1/0},g=0;if("string"==typeof n||"number"==typeof n){if(i=this.getBin(n))return this.ref(i),i;"number"==typeof n&&(this.maxId=Math.max(n,this.maxId))}else n=++this.maxId;for(a=0;a<this.freebins.length;a++){if(t===(i=this.freebins[a]).maxh&&e===i.maxw)return this.allocFreebin(a,e,t,n);t>i.maxh||e>i.maxw||t<=i.maxh&&e<=i.maxw&&(o=i.maxw*i.maxh-e*t)<f.waste&&(f.waste=o,f.freebin=a)}for(a=0;a<this.shelves.length;a++)if(g+=(s=this.shelves[a]).h,!(e>s.free)){if(t===s.h)return this.allocShelf(a,e,t,n);t>s.h||t<s.h&&(o=(s.h-t)*e)<f.waste&&(f.freebin=-1,f.waste=o,f.shelf=a)}return-1!==f.freebin?this.allocFreebin(f.freebin,e,t,n):-1!==f.shelf?this.allocShelf(f.shelf,e,t,n):t<=this.h-g&&e<=this.w?(s=new A(g,this.w,t),this.allocShelf(this.shelves.push(s)-1,e,t,n)):this.autoResize?(l=h=this.h,((c=u=this.w)<=l||e>c)&&(u=2*Math.max(e,c)),(l<c||t>l)&&(h=2*Math.max(t,l)),this.resize(u,h),this.packOne(e,t,n)):null},m.prototype.allocFreebin=function(e,t,n,i){var s=this.freebins.splice(e,1)[0];return s.id=i,s.w=t,s.h=n,s.refcount=0,this.bins[i]=s,this.ref(s),s},m.prototype.allocShelf=function(e,t,n,i){var s=this.shelves[e].alloc(t,n,i);return this.bins[i]=s,this.ref(s),s},m.prototype.shrink=function(){if(this.shelves.length>0){for(var e=0,t=0,n=0;n<this.shelves.length;n++){var i=this.shelves[n];t+=i.h,e=Math.max(i.w-i.free,e)}this.resize(e,t)}},m.prototype.getBin=function(e){return this.bins[e]},m.prototype.ref=function(e){if(1==++e.refcount){var t=e.h;this.stats[t]=1+(0|this.stats[t])}return e.refcount},m.prototype.unref=function(e){return 0===e.refcount?0:(0==--e.refcount&&(this.stats[e.h]--,delete this.bins[e.id],this.freebins.push(e)),e.refcount)},m.prototype.clear=function(){this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0},m.prototype.resize=function(e,t){this.w=e,this.h=t;for(var n=0;n<this.shelves.length;n++)this.shelves[n].resize(e);return!0},A.prototype.alloc=function(e,t,n){if(e>this.free||t>this.h)return null;var i=this.x;return this.x+=e,this.free-=e,new w(n,i,this.y,e,t,e,this.h)},A.prototype.resize=function(e){return this.free+=e-this.w,this.w=e,!0};class _{constructor(e,t){T(this,e,1,t)}resize(e){S(this,e,1)}clone(){return new _({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,t,n,i,s){M(e,t,n,i,s,1)}}class v{constructor(e,t){T(this,e,4,t)}resize(e){S(this,e,4)}clone(){return new v({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,t,n,i,s){M(e,t,n,i,s,4)}}function C(e){let t=0;for(let n,i,s=0,o=e.length,a=o-1;s<o;a=s++)if(n=e[s],i=e[a],void 0!==n.x)t+=(i.x-n.x)*(n.y+i.y);else{if(n[2]||i[2])return 1;t+=(i[0]-n[0])*(n[1]+i[1])}return t}function I(e,t,n,i,s){const o=e[t*i],a=e[t*i+1],l=e[n*i],h=e[n*i+1];return o===l&&(o<0||o>s)&&a!==h||a===h&&(a<0||a>s)&&o!==l}function E(e,t,n){let i=n;return t&&e&&(i=+e[t]),isNaN(i)&&(i=n||0),100*i}function D(e,t,n,i,s,o,a){t||0===t||(t=1);const l=E(e.properties,n,i),h=l*t;let c=(o?100*o:0)||l;return s?c=E(e.properties,s,o):a&&(c=l-E(e.properties,a,o)),c*=t,{altitude:h,height:c}}function H(e,t){return t<1/0&&(e.x<0||e.x>t||e.y<0||e.y>t)}function N(e){return null==e}function B(e,t,n){if(e===n||e===t)return e;const i=n-t;return((e-t)%i+i)%i+t}function z(e,t){if(!t)return null;const n=new Map;for(let i=0;i<t.length;i++){const s=t[i],o=e[s];let a=n.get(o);a||(a=[],n.set(o,a)),a.push(s)}return n}function U(e){return!(e&e-1)&&0!==e}
/*!
  	 * Codes from mapbox-gl-js
  	 * github.com/mapbox/mapbox-gl-js
  	 * MIT License
  	 */class O{constructor(e,t,{pixelRatio:n}){this.paddedRect=e,this.pixelRatio=n||1,this.padding=t}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.pixelRatio,(this.paddedRect.h-2*this.padding)/this.pixelRatio]}}class k{constructor(e){this.glyphMap=e,this.build()}build(){const e=this.glyphMap,t=Object.keys(e).length,n={},i=new m(0,0,{autoResize:!0}),s=[],o=t>1?1:0;for(const t in e){const i=e[t],a={x:0,y:0,w:i.data.width+2*o,h:i.data.height+2*o};s.push(a),n[t]=new O(a,o,i)}if(i.pack(s,{inPlace:!0}),!U(i.w)||!U(i.h)){const e=j(i.w),t=j(i.h);i.resize(e,t)}const a=new v({width:i.w,height:i.h});for(const t in e){const i=e[t],s=n[t].paddedRect;v.copy(i.data,a,{x:0,y:0},{x:s.x+o,y:s.y+o},i.data)}this.image=a,this.positions=n}}function j(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))}
/*!
  	 * Codes from mapbox-gl-js
  	 * github.com/mapbox/mapbox-gl-js
  	 * MIT License
  	 * TODO 升级为potpack
  	 */class F{constructor(e){this.glyphMap=e,this.build()}build(){const e=this.glyphMap,t={},n=new m(0,0,{autoResize:!0}),i=[];for(const n in e){const s=e[n],o=t[n]={};for(const e in s){const t=s[+e];if(!t||0===t.bitmap.width||0===t.bitmap.height)continue;const n={x:0,y:0,w:t.bitmap.width+2,h:t.bitmap.height+2};i.push(n),o[e]={rect:n,metrics:t.metrics}}}n.pack(i,{inPlace:!0});const s=new _({width:n.w,height:n.h});for(const n in e){const i=e[n];for(const e in i){const o=i[+e];if(!o||0===o.bitmap.width||0===o.bitmap.height)continue;const a=t[n][e].rect;_.copy(o.bitmap,s,{x:0,y:0},{x:a.x+1,y:a.y+1},o.bitmap)}}this.image=s,this.positions=t}}function W(e){return e<65536?Uint16Array:Uint32Array}function q(e){return(e=Math.abs(e))<32768?Int16Array:Float32Array}function Z(e){return e<65536?Uint16Array:Float32Array}function X(e,t){const n=e.getLength?e.getLength():e.length;if(e instanceof t)return e.slice(0,n);const i=new t(n);e=e._origin||e;for(let t=0;t<n;t++)i[t]=e[t]||0;return i}function Y(e){const t=e.type,n=[];if(1===t||4===t)for(let t=0;t<e.geometry.length;t++)c(e.geometry[t],n);else if(2===t)f(e.geometry,n);else if(3===t)f(e.geometry,n);else if(5===t)f(e.geometry,n);else if(6===t)for(let t=0;t<e.geometry.length;t++){const i=[];f(e.geometry[t],i),n.push(i)}return e.geometry=n,e}let J;const Q={width:100,height:10};let $=!1;try{new OffscreenCanvas(1,1).getContext("2d").fillText("hello",0,0),$=!0}catch(e){$=!1}class G{constructor(e,t={}){if(!Array.isArray(e))return void console.error("colors is not array");if(e.length<2)return void console.error("colors.length should >1");this.colors=e;let n=1/0,i=-1/0;for(let t=0,s=e.length;t<s;t++){const s=e[t][0];n=Math.min(s,n),i=Math.max(s,i)}this.min=n,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},Q,t),this._initImgData()}getImageData(){return this.imgData}_initImgData(){const e=function(){if(!J){const{width:e,height:t}=Q;$?J=new OffscreenCanvas(e,t):(J=document.createElement("canvas"),J.width=e,J.height=t)}return J}(),{width:t,height:n}=this.options;e.width=t,e.height=n;const i=e.getContext("2d");i.clearRect(0,0,e.width,e.height);const s=i.createLinearGradient(0,0,e.width,0),{colors:o,valueOffset:a}=this;for(let e=0,t=o.length;e<t;e++){const[t,n]=o[e];s.addColorStop((t-this.min)/a,n)}i.fillStyle=s,i.fillRect(0,0,e.width,e.height),this.imgData=i.getImageData(0,0,e.width,e.height)}getColor(e){e=Math.max(this.min,e);const t=((e=Math.min(e,this.max))-this.min)/this.valueOffset;let n=Math.round(t*this.imgData.width);n=Math.min(n,this.imgData.width-1);const i=4*n;return[this.imgData.data[i],this.imgData.data[i+1],this.imgData.data[i+2],this.imgData.data[i+3]]}}var K;function ee(e){return null==e}function te(e){return!ee(e)}function re(e){return""===e}function se(e,t){var n,i,s;if(ye(e)){var o,a=e.stops&&"object"==typeof e.stops[0][0],l=a||te(e.property),h=a||!l,c=e.type||t||"exponential";if("exponential"===c)o=he;else if("interval"===c)o=le;else if("categorical"===c)o=oe;else if("identity"===c)o=de;else if("color-interpolate"===c)o=fe;else{if("calculate-expression"!==c)throw new Error('Unknown function type "'+c+'"');o=pe}if(a){var u={},f=[];for(let t=0;t<e.stops.length;t++){var g=e.stops[t];void 0===u[g[0].zoom]&&(u[g[0].zoom]={zoom:g[0].zoom,type:e.type,property:e.property,default:e.default,stops:[]}),u[g[0].zoom].stops.push([g[0].value,g[1]])}for(let e in u)f.push([u[e].zoom,se(u[e])]);n=function(t,n){const i=he({stops:f,base:e.base},t)(t,n);return"function"==typeof i?i(t,n):i},i=!1,s=!1}else h?(n=function(t){const n=o(e,t);return"function"==typeof n?n(t):n},i=!0,s=!1):(n=function(t,n){const i=o(e,n?n[e.property]:null);return"function"==typeof i?i(t,n):i},i=!1,s=!0)}else n=function(){return e},i=!0,s=!0;return n.isZoomConstant=s,n.isFeatureConstant=i,n}function oe(e,t){for(let n=0;n<e.stops.length;n++)if(t===e.stops[n][0])return e.stops[n][1];return e.default}function le(e,t){for(var n=0;n<e.stops.length&&!(t<e.stops[n][0]);n++);return e.stops[Math.max(n-1,0)][1]}function he(e,t){for(var n=te(e.base)&&!re(e.base)?e.base:1,i=0;!(i>=e.stops.length||t<=e.stops[i][0]);)i++;return 0===i?e.stops[i][1]:i===e.stops.length?e.stops[i-1][1]:me(t,n,e.stops[i-1][0],e.stops[i][0],e.stops[i-1][1],e.stops[i][1])}"function"==typeof Map&&(K=new Map);const ue={width:100,height:1};function fe(e,t){const n=e.stops;if(n&&n.length>1){let e;if(K){const t=JSON.stringify(n);if(!K.has(t)){const e=new G(n,ue);K.set(t,e)}e=K.get(t)}else e=new G(n,ue);const[i,s,o,a]=e.getColor(t);return[i/255,s/255,o/255,a/255]}return n&&1===n.length?n[0][1]:null}function de(e,t){return i=e.default,te(n=t)?n:te(i)?i:te(s)?s:null;var n,i,s}function pe(e,t){const n=String(e.property),i=e.expression,s=t;function o(t){return ee(t)||re(t)||isNaN(t)?e.default:t}if(!te(t)||re(t)||isNaN(t)||t<0)return o(e.default);{const t=function e(t,n,i){const s=Number(i),o=String(n);return Array.isArray(t)?t.map((t=>e(t,o,s))):t===o?s:t}(i,n,s);return o(function t(n){if(!Array.isArray(n)){if("number"==typeof n)return n;throw new Error("Invalid expression format")}{const i=n[0];if(!["+","-","*","/"].includes(i))throw new Error(`Unknown operator: ${i}`);const s=n.slice(1).map((e=>t(e)));switch(i){case"+":return s.reduce(((e,t)=>e+t),0);case"-":return s.reduce(((e,t)=>e-t));case"*":return s.reduce(((e,t)=>e*t),1);case"/":return s.some((e=>0===e))?e.default:s.reduce(((e,t)=>e/t));default:throw new Error(`Unsupported operator: ${i}`)}}}(t))}}function me(e,t,n,i,s,o){return"function"==typeof s?function(){var a=s.apply(void 0,arguments),l=o.apply(void 0,arguments);return me(e,t,n,i,a,l)}:s.length?function(e,t,n,i,s,o){var a=[];for(let l=0;l<s.length;l++)a[l]=Ae(e,t,n,i,s[l],o[l]);return a}(e,t,n,i,s,o):Ae(e,t,n,i,s,o)}function Ae(e,t,n,i,s,o){var a,l=i-n,h=e-n;return s*(1-(a=1===t?h/l:(Math.pow(t,h)-1)/(Math.pow(t,l)-1)))+o*a}function ye(e){return e&&"object"==typeof e&&(e.stops||e.property&&"identity"===e.type||e.expression&&"calculate-expression"===e.type)}function _e(e){return be(e,"exponential")}function ve(e){return be(e,"interval")}function xe(e,t){if(!e)return null;var n=!1;if(Array.isArray(e)){var i,s=[];for(let o=0;o<e.length;o++)(i=xe(e[o],t))?(s.push(i),n=!0):s.push(e[o]);return n?s:e}var o,a={__fn_types_loaded:!0},l=[];for(o in e)e.hasOwnProperty(o)&&l.push(o);const h=function(e){Object.defineProperty(a,e,{get:function(){return this["__fn_"+e]||(this["__fn_"+e]=_e(this["_"+e])),this["__fn_"+e].apply(this,t())},set:function(t){this["_"+e]=t},configurable:!0,enumerable:!0})};for(let t=0,i=l.length;t<i;t++)ye(e[o=l[t]])?(n=!0,a["_"+o]=e[o],h(o)):a[o]=e[o];return n?a:e}function be(e,t){if(!ye(e))return function(){return e};let n=!0,i=!0;const s=(e=JSON.parse(JSON.stringify(e))).stops;if(s)for(let e=0;e<s.length;e++)if(ye(s[e][1])){const o=be(s[e][1],t);n=n&&o.isZoomConstant,i=i&&o.isFeatureConstant,s[e]=[s[e][0],o]}const o=se(e,t);return o.isZoomConstant=n&&o.isZoomConstant,o.isFeatureConstant=i&&o.isFeatureConstant,o}var we={exports:{}},Te={exports:{}},Se=function(e){return!(!e||"string"==typeof e)&&(e instanceof Array||Array.isArray(e)||e.length>=0&&(e.splice instanceof Function||Object.getOwnPropertyDescriptor(e,e.length-1)&&"String"!==e.constructor.name))},Me=Array.prototype.concat,Ce=Array.prototype.slice,Pe=Te.exports=function(e){for(var t=[],n=0,i=e.length;n<i;n++){var s=e[n];Se(s)?t=Me.call(t,Ce.call(s)):t.push(s)}return t};Pe.wrap=function(e){return function(){return e(Pe(arguments))}};var Ie={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},ke=Te.exports,Oe=Object.hasOwnProperty,Ee=Object.create(null);for(var Re in Ie)Oe.call(Ie,Re)&&(Ee[Ie[Re]]=Re);var Le=we.exports={to:{},get:{}};function De(e,t,n){return Math.min(Math.max(t,e),n)}function Fe(e){var t=Math.round(e).toString(16).toUpperCase();return t.length<2?"0"+t:t}Le.get=function(e){var t,n;switch(e.substring(0,3).toLowerCase()){case"hsl":t=Le.get.hsl(e),n="hsl";break;case"hwb":t=Le.get.hwb(e),n="hwb";break;default:t=Le.get.rgb(e),n="rgb"}return t?{model:n,value:t}:null},Le.get.rgb=function(e){if(!e)return null;var t,n,i,s=[0,0,0,1];if(t=e.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(i=t[2],t=t[1],n=0;n<3;n++){var o=2*n;s[n]=parseInt(t.slice(o,o+2),16)}i&&(s[3]=parseInt(i,16)/255)}else if(t=e.match(/^#([a-f0-9]{3,4})$/i)){for(i=(t=t[1])[3],n=0;n<3;n++)s[n]=parseInt(t[n]+t[n],16);i&&(s[3]=parseInt(i+i,16)/255)}else if(t=e.match(/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)){for(n=0;n<3;n++)s[n]=parseInt(t[n+1],0);t[4]&&(s[3]=t[5]?.01*parseFloat(t[4]):parseFloat(t[4]))}else{if(!(t=e.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)))return(t=e.match(/^(\w+)$/))?"transparent"===t[1]?[0,0,0,0]:Oe.call(Ie,t[1])?((s=Ie[t[1]])[3]=1,s):null:null;for(n=0;n<3;n++)s[n]=Math.round(2.55*parseFloat(t[n+1]));t[4]&&(s[3]=t[5]?.01*parseFloat(t[4]):parseFloat(t[4]))}for(n=0;n<3;n++)s[n]=De(s[n],0,255);return s[3]=De(s[3],0,1),s},Le.get.hsl=function(e){if(!e)return null;var t=e.match(/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(t){var n=parseFloat(t[4]);return[(parseFloat(t[1])%360+360)%360,De(parseFloat(t[2]),0,100),De(parseFloat(t[3]),0,100),De(isNaN(n)?1:n,0,1)]}return null},Le.get.hwb=function(e){if(!e)return null;var t=e.match(/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(t){var n=parseFloat(t[4]);return[(parseFloat(t[1])%360+360)%360,De(parseFloat(t[2]),0,100),De(parseFloat(t[3]),0,100),De(isNaN(n)?1:n,0,1)]}return null},Le.to.hex=function(){var e=ke(arguments);return"#"+Fe(e[0])+Fe(e[1])+Fe(e[2])+(e[3]<1?Fe(Math.round(255*e[3])):"")},Le.to.rgb=function(){var e=ke(arguments);return e.length<4||1===e[3]?"rgb("+Math.round(e[0])+", "+Math.round(e[1])+", "+Math.round(e[2])+")":"rgba("+Math.round(e[0])+", "+Math.round(e[1])+", "+Math.round(e[2])+", "+e[3]+")"},Le.to.rgb.percent=function(){var e=ke(arguments),t=Math.round(e[0]/255*100),n=Math.round(e[1]/255*100),i=Math.round(e[2]/255*100);return e.length<4||1===e[3]?"rgb("+t+"%, "+n+"%, "+i+"%)":"rgba("+t+"%, "+n+"%, "+i+"%, "+e[3]+")"},Le.to.hsl=function(){var e=ke(arguments);return e.length<4||1===e[3]?"hsl("+e[0]+", "+e[1]+"%, "+e[2]+"%)":"hsla("+e[0]+", "+e[1]+"%, "+e[2]+"%, "+e[3]+")"},Le.to.hwb=function(){var e=ke(arguments),t="";return e.length>=4&&1!==e[3]&&(t=", "+e[3]),"hwb("+e[0]+", "+e[1]+"%, "+e[2]+"%"+t+")"},Le.to.keyword=function(e){return Ee[e.slice(0,3)]};var He=we.exports,Ne={exports:{}},Be={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},ze={};for(var Ge in Be)Be.hasOwnProperty(Ge)&&(ze[Be[Ge]]=Ge);var Ue=Ne.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var Ve in Ue)if(Ue.hasOwnProperty(Ve)){if(!("channels"in Ue[Ve]))throw new Error("missing channels property: "+Ve);if(!("labels"in Ue[Ve]))throw new Error("missing channel labels property: "+Ve);if(Ue[Ve].labels.length!==Ue[Ve].channels)throw new Error("channel and label counts mismatch: "+Ve);var je=Ue[Ve].channels,We=Ue[Ve].labels;delete Ue[Ve].channels,delete Ue[Ve].labels,Object.defineProperty(Ue[Ve],"channels",{value:je}),Object.defineProperty(Ue[Ve],"labels",{value:We})}Ue.rgb.hsl=function(e){var t,n,i=e[0]/255,s=e[1]/255,o=e[2]/255,a=Math.min(i,s,o),l=Math.max(i,s,o),h=l-a;return l===a?t=0:i===l?t=(s-o)/h:s===l?t=2+(o-i)/h:o===l&&(t=4+(i-s)/h),(t=Math.min(60*t,360))<0&&(t+=360),n=(a+l)/2,[t,100*(l===a?0:n<=.5?h/(l+a):h/(2-l-a)),100*n]},Ue.rgb.hsv=function(e){var t,n,i,s,o,a=e[0]/255,l=e[1]/255,h=e[2]/255,c=Math.max(a,l,h),u=c-Math.min(a,l,h),f=function(e){return(c-e)/6/u+.5};return 0===u?s=o=0:(o=u/c,t=f(a),n=f(l),i=f(h),a===c?s=i-n:l===c?s=1/3+t-i:h===c&&(s=2/3+n-t),s<0?s+=1:s>1&&(s-=1)),[360*s,100*o,100*c]},Ue.rgb.hwb=function(e){var t=e[0],n=e[1],i=e[2];return[Ue.rgb.hsl(e)[0],1/255*Math.min(t,Math.min(n,i))*100,100*(i=1-1/255*Math.max(t,Math.max(n,i)))]},Ue.rgb.cmyk=function(e){var t,n=e[0]/255,i=e[1]/255,s=e[2]/255;return[100*((1-n-(t=Math.min(1-n,1-i,1-s)))/(1-t)||0),100*((1-i-t)/(1-t)||0),100*((1-s-t)/(1-t)||0),100*t]},Ue.rgb.keyword=function(e){var t=ze[e];if(t)return t;var n,i,s,o=1/0;for(var a in Be)if(Be.hasOwnProperty(a)){var l=(i=e,s=Be[a],Math.pow(i[0]-s[0],2)+Math.pow(i[1]-s[1],2)+Math.pow(i[2]-s[2],2));l<o&&(o=l,n=a)}return n},Ue.keyword.rgb=function(e){return Be[e]},Ue.rgb.xyz=function(e){var t=e[0]/255,n=e[1]/255,i=e[2]/255;return[100*(.4124*(t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92)),100*(.2126*t+.7152*n+.0722*i),100*(.0193*t+.1192*n+.9505*i)]},Ue.rgb.lab=function(e){var t=Ue.rgb.xyz(e),n=t[0],i=t[1],s=t[2];return i/=100,s/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116)-16,500*(n-i),200*(i-(s=s>.008856?Math.pow(s,1/3):7.787*s+16/116))]},Ue.hsl.rgb=function(e){var t,n,i,s,o,a=e[0]/360,l=e[1]/100,h=e[2]/100;if(0===l)return[o=255*h,o,o];t=2*h-(n=h<.5?h*(1+l):h+l-h*l),s=[0,0,0];for(var c=0;c<3;c++)(i=a+1/3*-(c-1))<0&&i++,i>1&&i--,s[c]=255*(o=6*i<1?t+6*(n-t)*i:2*i<1?n:3*i<2?t+(n-t)*(2/3-i)*6:t);return s},Ue.hsl.hsv=function(e){var t=e[0],n=e[1]/100,i=e[2]/100,s=n,o=Math.max(i,.01);return n*=(i*=2)<=1?i:2-i,s*=o<=1?o:2-o,[t,100*(0===i?2*s/(o+s):2*n/(i+n)),(i+n)/2*100]},Ue.hsv.rgb=function(e){var t=e[0]/60,n=e[1]/100,i=e[2]/100,s=Math.floor(t)%6,o=t-Math.floor(t),a=255*i*(1-n),l=255*i*(1-n*o),h=255*i*(1-n*(1-o));switch(i*=255,s){case 0:return[i,h,a];case 1:return[l,i,a];case 2:return[a,i,h];case 3:return[a,l,i];case 4:return[h,a,i];case 5:return[i,a,l]}},Ue.hsv.hsl=function(e){var t,n,i,s=e[0],o=e[1]/100,a=e[2]/100,l=Math.max(a,.01);return i=(2-o)*a,n=o*l,[s,100*(n=(n/=(t=(2-o)*l)<=1?t:2-t)||0),100*(i/=2)]},Ue.hwb.rgb=function(e){var t,n,i,s,o,a,l,h=e[0]/360,c=e[1]/100,u=e[2]/100,f=c+u;switch(f>1&&(c/=f,u/=f),i=6*h-(t=Math.floor(6*h)),1&t&&(i=1-i),s=c+i*((n=1-u)-c),t){default:case 6:case 0:o=n,a=s,l=c;break;case 1:o=s,a=n,l=c;break;case 2:o=c,a=n,l=s;break;case 3:o=c,a=s,l=n;break;case 4:o=s,a=c,l=n;break;case 5:o=n,a=c,l=s}return[255*o,255*a,255*l]},Ue.cmyk.rgb=function(e){var t=e[1]/100,n=e[2]/100,i=e[3]/100;return[255*(1-Math.min(1,e[0]/100*(1-i)+i)),255*(1-Math.min(1,t*(1-i)+i)),255*(1-Math.min(1,n*(1-i)+i))]},Ue.xyz.rgb=function(e){var t,n,i,s=e[0]/100,o=e[1]/100,a=e[2]/100;return n=-.9689*s+1.8758*o+.0415*a,i=.0557*s+-.204*o+1.057*a,t=(t=3.2406*s+-1.5372*o+-.4986*a)>.0031308?1.055*Math.pow(t,1/2.4)-.055:12.92*t,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,i=i>.0031308?1.055*Math.pow(i,1/2.4)-.055:12.92*i,[255*(t=Math.min(Math.max(0,t),1)),255*(n=Math.min(Math.max(0,n),1)),255*(i=Math.min(Math.max(0,i),1))]},Ue.xyz.lab=function(e){var t=e[0],n=e[1],i=e[2];return n/=100,i/=108.883,t=(t/=95.047)>.008856?Math.pow(t,1/3):7.787*t+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(t-n),200*(n-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},Ue.lab.xyz=function(e){var t,n,i;t=e[1]/500+(n=(e[0]+16)/116),i=n-e[2]/200;var s=Math.pow(n,3),o=Math.pow(t,3),a=Math.pow(i,3);return n=s>.008856?s:(n-16/116)/7.787,t=o>.008856?o:(t-16/116)/7.787,i=a>.008856?a:(i-16/116)/7.787,[t*=95.047,n*=100,i*=108.883]},Ue.lab.lch=function(e){var t,n=e[0],i=e[1],s=e[2];return(t=360*Math.atan2(s,i)/2/Math.PI)<0&&(t+=360),[n,Math.sqrt(i*i+s*s),t]},Ue.lch.lab=function(e){var t,n=e[1];return t=e[2]/360*2*Math.PI,[e[0],n*Math.cos(t),n*Math.sin(t)]},Ue.rgb.ansi16=function(e){var t=e[0],n=e[1],i=e[2],s=1 in arguments?arguments[1]:Ue.rgb.hsv(e)[2];if(0===(s=Math.round(s/50)))return 30;var o=30+(Math.round(i/255)<<2|Math.round(n/255)<<1|Math.round(t/255));return 2===s&&(o+=60),o},Ue.hsv.ansi16=function(e){return Ue.rgb.ansi16(Ue.hsv.rgb(e),e[2])},Ue.rgb.ansi256=function(e){var t=e[0],n=e[1],i=e[2];return t===n&&n===i?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(n/255*5)+Math.round(i/255*5)},Ue.ansi16.rgb=function(e){var t=e%10;if(0===t||7===t)return e>50&&(t+=3.5),[t=t/10.5*255,t,t];var n=.5*(1+~~(e>50));return[(1&t)*n*255,(t>>1&1)*n*255,(t>>2&1)*n*255]},Ue.ansi256.rgb=function(e){if(e>=232){var t=10*(e-232)+8;return[t,t,t]}var n;return e-=16,[Math.floor(e/36)/5*255,Math.floor((n=e%36)/6)/5*255,n%6/5*255]},Ue.rgb.hex=function(e){var t=(((255&Math.round(e[0]))<<16)+((255&Math.round(e[1]))<<8)+(255&Math.round(e[2]))).toString(16).toUpperCase();return"000000".substring(t.length)+t},Ue.hex.rgb=function(e){var t=e.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!t)return[0,0,0];var n=t[0];3===t[0].length&&(n=n.split("").map((function(e){return e+e})).join(""));var i=parseInt(n,16);return[i>>16&255,i>>8&255,255&i]},Ue.rgb.hcg=function(e){var t,n=e[0]/255,i=e[1]/255,s=e[2]/255,o=Math.max(Math.max(n,i),s),a=Math.min(Math.min(n,i),s),l=o-a;return t=l<=0?0:o===n?(i-s)/l%6:o===i?2+(s-n)/l:4+(n-i)/l+4,t/=6,[360*(t%=1),100*l,100*(l<1?a/(1-l):0)]},Ue.hsl.hcg=function(e){var t,n=e[1]/100,i=e[2]/100,s=0;return(t=i<.5?2*n*i:2*n*(1-i))<1&&(s=(i-.5*t)/(1-t)),[e[0],100*t,100*s]},Ue.hsv.hcg=function(e){var t=e[2]/100,n=e[1]/100*t,i=0;return n<1&&(i=(t-n)/(1-n)),[e[0],100*n,100*i]},Ue.hcg.rgb=function(e){var t=e[1]/100,n=e[2]/100;if(0===t)return[255*n,255*n,255*n];var i,s=[0,0,0],o=e[0]/360%1*6,a=o%1,l=1-a;switch(Math.floor(o)){case 0:s[0]=1,s[1]=a,s[2]=0;break;case 1:s[0]=l,s[1]=1,s[2]=0;break;case 2:s[0]=0,s[1]=1,s[2]=a;break;case 3:s[0]=0,s[1]=l,s[2]=1;break;case 4:s[0]=a,s[1]=0,s[2]=1;break;default:s[0]=1,s[1]=0,s[2]=l}return[255*(t*s[0]+(i=(1-t)*n)),255*(t*s[1]+i),255*(t*s[2]+i)]},Ue.hcg.hsv=function(e){var t=e[1]/100,n=t+e[2]/100*(1-t),i=0;return n>0&&(i=t/n),[e[0],100*i,100*n]},Ue.hcg.hsl=function(e){var t=e[1]/100,n=e[2]/100*(1-t)+.5*t,i=0;return n>0&&n<.5?i=t/(2*n):n>=.5&&n<1&&(i=t/(2*(1-n))),[e[0],100*i,100*n]},Ue.hcg.hwb=function(e){var t=e[1]/100,n=t+e[2]/100*(1-t);return[e[0],100*(n-t),100*(1-n)]},Ue.hwb.hcg=function(e){var t=1-e[2]/100,n=t-e[1]/100,i=0;return n<1&&(i=(t-n)/(1-n)),[e[0],100*n,100*i]},Ue.apple.rgb=function(e){return[e[0]/65535*255,e[1]/65535*255,e[2]/65535*255]},Ue.rgb.apple=function(e){return[e[0]/255*65535,e[1]/255*65535,e[2]/255*65535]},Ue.gray.rgb=function(e){return[e[0]/100*255,e[0]/100*255,e[0]/100*255]},Ue.gray.hsl=Ue.gray.hsv=function(e){return[0,0,e[0]]},Ue.gray.hwb=function(e){return[0,100,e[0]]},Ue.gray.cmyk=function(e){return[0,0,0,e[0]]},Ue.gray.lab=function(e){return[e[0],0,0]},Ue.gray.hex=function(e){var t=255&Math.round(e[0]/100*255),n=((t<<16)+(t<<8)+t).toString(16).toUpperCase();return"000000".substring(n.length)+n},Ue.rgb.gray=function(e){return[(e[0]+e[1]+e[2])/3/255*100]};var qe=Ne.exports,Ze=qe;function Xe(e,t){return function(n){return t(e(n))}}function Ye(e,t){for(var n=[t[e].parent,e],i=Ze[t[e].parent][e],s=t[e].parent;t[s].parent;)n.unshift(t[s].parent),i=Xe(Ze[t[s].parent][s],i),s=t[s].parent;return i.conversion=n,i}var Je=qe,$e={};Object.keys(Je).forEach((function(e){$e[e]={},Object.defineProperty($e[e],"channels",{value:Je[e].channels}),Object.defineProperty($e[e],"labels",{value:Je[e].labels});var t=function(e){for(var t=function(e){var t=function(){for(var e={},t=Object.keys(Ze),n=t.length,i=0;i<n;i++)e[t[i]]={distance:-1,parent:null};return e}(),n=[e];for(t[e].distance=0;n.length;)for(var i=n.pop(),s=Object.keys(Ze[i]),o=s.length,a=0;a<o;a++){var l=s[a],h=t[l];-1===h.distance&&(h.distance=t[i].distance+1,h.parent=i,n.unshift(l))}return t}(e),n={},i=Object.keys(t),s=i.length,o=0;o<s;o++){var a=i[o];null!==t[a].parent&&(n[a]=Ye(a,t))}return n}(e);Object.keys(t).forEach((function(n){var i=t[n];$e[e][n]=function(e){var t=function(t){if(null==t)return t;arguments.length>1&&(t=Array.prototype.slice.call(arguments));var n=e(t);if("object"==typeof n)for(var i=n.length,s=0;s<i;s++)n[s]=Math.round(n[s]);return n};return"conversion"in e&&(t.conversion=e.conversion),t}(i),$e[e][n].raw=function(e){var t=function(t){return null==t?t:(arguments.length>1&&(t=Array.prototype.slice.call(arguments)),e(t))};return"conversion"in e&&(t.conversion=e.conversion),t}(i)}))}));var Ke=He,et=$e,tt=[].slice,nt=["keyword","gray","hex"],rt={};Object.keys(et).forEach((function(e){rt[tt.call(et[e].labels).sort().join("")]=e}));var it={};function st(e,t){if(!(this instanceof st))return new st(e,t);if(t&&t in nt&&(t=null),t&&!(t in et))throw new Error("Unknown model: "+t);var n,i;if(null==e)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(e instanceof st)this.model=e.model,this.color=e.color.slice(),this.valpha=e.valpha;else if("string"==typeof e){var s=Ke.get(e);if(null===s)throw new Error("Unable to parse color from string: "+e);this.model=s.model,this.color=s.value.slice(0,i=et[this.model].channels),this.valpha="number"==typeof s.value[i]?s.value[i]:1}else if(e.length){this.model=t||"rgb";var o=tt.call(e,0,i=et[this.model].channels);this.color=lt(o,i),this.valpha="number"==typeof e[i]?e[i]:1}else if("number"==typeof e)e&=16777215,this.model="rgb",this.color=[e>>16&255,e>>8&255,255&e],this.valpha=1;else{this.valpha=1;var a=Object.keys(e);"alpha"in e&&(a.splice(a.indexOf("alpha"),1),this.valpha="number"==typeof e.alpha?e.alpha:0);var l=a.sort().join("");if(!(l in rt))throw new Error("Unable to parse color from object: "+JSON.stringify(e));this.model=rt[l];var h=et[this.model].labels,c=[];for(n=0;n<h.length;n++)c.push(e[h[n]]);this.color=lt(c)}if(it[this.model])for(i=et[this.model].channels,n=0;n<i;n++){var u=it[this.model][n];u&&(this.color[n]=u(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function ot(e,t,n){return(e=Array.isArray(e)?e:[e]).forEach((function(e){(it[e]||(it[e]=[]))[t]=n})),e=e[0],function(i){var s;return arguments.length?(n&&(i=n(i)),(s=this[e]()).color[t]=i,s):(s=this[e]().color[t],n&&(s=n(s)),s)}}function at(e){return function(t){return Math.max(0,Math.min(e,t))}}function lt(e,t){for(var n=0;n<t;n++)"number"!=typeof e[n]&&(e[n]=0);return e}st.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(e){var t=this.model in Ke.to?this:this.rgb(),n=1===(t=t.round("number"==typeof e?e:1)).valpha?t.color:t.color.concat(this.valpha);return Ke.to[t.model](n)},percentString:function(e){var t=this.rgb().round("number"==typeof e?e:1),n=1===t.valpha?t.color:t.color.concat(this.valpha);return Ke.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var e={},t=et[this.model].channels,n=et[this.model].labels,i=0;i<t;i++)e[n[i]]=this.color[i];return 1!==this.valpha&&(e.alpha=this.valpha),e},unitArray:function(){var e=this.rgb().color;return e[0]/=255,e[1]/=255,e[2]/=255,1!==this.valpha&&e.push(this.valpha),e},unitObject:function(){var e=this.rgb().object();return e.r/=255,e.g/=255,e.b/=255,1!==this.valpha&&(e.alpha=this.valpha),e},round:function(e){return e=Math.max(e||0,0),new st(this.color.map(function(e){return function(t){return function(e,t){return Number(e.toFixed(t))}(t,e)}}(e)).concat(this.valpha),this.model)},alpha:function(e){return arguments.length?new st(this.color.concat(Math.max(0,Math.min(1,e))),this.model):this.valpha},red:ot("rgb",0,at(255)),green:ot("rgb",1,at(255)),blue:ot("rgb",2,at(255)),hue:ot(["hsl","hsv","hsl","hwb","hcg"],0,(function(e){return(e%360+360)%360})),saturationl:ot("hsl",1,at(100)),lightness:ot("hsl",2,at(100)),saturationv:ot("hsv",1,at(100)),value:ot("hsv",2,at(100)),chroma:ot("hcg",1,at(100)),gray:ot("hcg",2,at(100)),white:ot("hwb",1,at(100)),wblack:ot("hwb",2,at(100)),cyan:ot("cmyk",0,at(100)),magenta:ot("cmyk",1,at(100)),yellow:ot("cmyk",2,at(100)),black:ot("cmyk",3,at(100)),x:ot("xyz",0,at(100)),y:ot("xyz",1,at(100)),z:ot("xyz",2,at(100)),l:ot("lab",0,at(100)),a:ot("lab",1),b:ot("lab",2),keyword:function(e){return arguments.length?new st(e):et[this.model].keyword(this.color)},hex:function(e){return arguments.length?new st(e):Ke.to.hex(this.rgb().round().color)},rgbNumber:function(){var e=this.rgb().color;return(255&e[0])<<16|(255&e[1])<<8|255&e[2]},luminosity:function(){for(var e=this.rgb().color,t=[],n=0;n<e.length;n++){var i=e[n]/255;t[n]=i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4)}return.2126*t[0]+.7152*t[1]+.0722*t[2]},contrast:function(e){var t=this.luminosity(),n=e.luminosity();return t>n?(t+.05)/(n+.05):(n+.05)/(t+.05)},level:function(e){var t=this.contrast(e);return t>=7.1?"AAA":t>=4.5?"AA":""},isDark:function(){var e=this.rgb().color;return(299*e[0]+587*e[1]+114*e[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var e=this.rgb(),t=0;t<3;t++)e.color[t]=255-e.color[t];return e},lighten:function(e){var t=this.hsl();return t.color[2]+=t.color[2]*e,t},darken:function(e){var t=this.hsl();return t.color[2]-=t.color[2]*e,t},saturate:function(e){var t=this.hsl();return t.color[1]+=t.color[1]*e,t},desaturate:function(e){var t=this.hsl();return t.color[1]-=t.color[1]*e,t},whiten:function(e){var t=this.hwb();return t.color[1]+=t.color[1]*e,t},blacken:function(e){var t=this.hwb();return t.color[2]+=t.color[2]*e,t},grayscale:function(){var e=this.rgb().color,t=.3*e[0]+.59*e[1]+.11*e[2];return st.rgb(t,t,t)},fade:function(e){return this.alpha(this.valpha-this.valpha*e)},opaquer:function(e){return this.alpha(this.valpha+this.valpha*e)},rotate:function(e){var t=this.hsl(),n=t.color[0];return n=(n=(n+e)%360)<0?360+n:n,t.color[0]=n,t},mix:function(e,t){if(!e||!e.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof e);var n=e.rgb(),i=this.rgb(),s=void 0===t?.5:t,o=2*s-1,a=n.alpha()-i.alpha(),l=((o*a==-1?o:(o+a)/(1+o*a))+1)/2,h=1-l;return st.rgb(l*n.red()+h*i.red(),l*n.green()+h*i.green(),l*n.blue()+h*i.blue(),n.alpha()*s+i.alpha()*(1-s))}},Object.keys(et).forEach((function(e){if(-1===nt.indexOf(e)){var t=et[e].channels;st.prototype[e]=function(){if(this.model===e)return new st(this);if(arguments.length)return new st(arguments,e);var n,i="number"==typeof arguments[t]?t:this.valpha;return new st((n=et[this.model][e].raw(this.color),Array.isArray(n)?n:[n]).concat(i),e)},st[e]=function(n){return"number"==typeof n&&(n=lt(tt.call(arguments),t)),new st(n,e)}}}));var ht=n(st);function ut(e){for(let t=1;t<arguments.length;t++){const n=arguments[t];for(const t in n)e[t]=n[t]}return e}function pt(e){return null==e}function gt(e){return"number"==typeof e&&!isNaN(e)}function mt(e){return"object"==typeof e&&!!e}function At(e){return!pt(e)&&("string"==typeof e||null!==e.constructor&&e.constructor===String)}function yt(e){return!pt(e)&&("function"==typeof e||null!==e.constructor&&e.constructor===Function)}const vt=Object.prototype.hasOwnProperty;function xt(e,t){return vt.call(e,t)}const bt=Math.PI/180;function wt(e){return e&&ye(e)&&e.property}function Tt(e){const{verticalCentimeterToPoint:t,tileRatio:n}=e;return t*n}function Mt(e){return"centimeter"===e||"cm"===e?1:"millimeter"===e||"mm"===e?.1:100}const Ct={};function Pt(e,t){if(!Array.isArray(t)){if(t&&void 0!==t.r&&void 0!==t.g&&void 0!==t.b)return e[0]=255*t.r,e[1]=255*t.g,e[2]=255*t.b,e[3]=void 0!==t.a?255*t.a:255,e;t=Ct[t]=Ct[t]||ht(t).unitArray()}for(let n=0;n<t.length;n++)e[n]=255*t[n];return 3===t.length&&(e[3]=255),e}const Ot={textFill:1,textSize:1,textOpacity:1,textDx:1,textDy:1,markerWidth:1,markerHeight:1,markerOpacity:1,markerDx:1,markerDy:1,lineWidth:1,lineColor:1,lineOpacity:1,polygonFill:1,polygonOpacity:1,polygonPatternFileWidth:1,polygonPatternFileOrigin:1,rotationX:1,rotationY:1,rotationZ:1,scaleX:1,scaleY:1,scaleZ:1,translationX:1,translationY:1,translationZ:1},Et={textName:1,markerTextFitPadding:1,markerTextFit:1,lineGradientProperty:1};var Rt=Object.freeze({__proto__:null,checkIfIdentityZoomDependent:function(e,t,n){if(Array.isArray(n)||(n=Object.values(n)),!n||!n.length)return!1;if(!Ot[e])return!1;for(let e=0;e<n.length;e++){const i=n[e]&&(n[e].feature||n[e]);if(!i)continue;const s=i.properties&&i.properties[t];if(s&&ye(s)&&!_e(s).isZoomConstant)return!0}return!1},checkIfZoomFnTypeSymbol:function(e){return!!Ot[e]||!!Et[e]},evaluate:function(e,t,n){return yt(e)?e(void 0!==n?n:null,t):e},extend:ut,getAltitudeToLocal:Tt,getTubeSizeScale:Mt,hasOwn:xt,isFnTypeSymbol:wt,isFunction:yt,isInteger:function(e){return(0|e)===e},isNil:pt,isNumber:gt,isObject:mt,isString:At,join:function(e,t){return e.join?e.join(t||","):Array.prototype.join.call(e,t||",")},normalizeColor:Pt,now:function(){return Date.now()},toDegree:function(e){return e/bt},toRadian:function(e){return e*bt}});class dt{constructor(e,t,n,i){this.feature=e,this.symbol=t,this.fnTypes=n,this.options=i}getPolygonResource(){let e=this.symbol.polygonPatternFile;const{polygonPatternFileFn:t}=this.fnTypes;return this._getResource(e,t)}getLineResource(){let e=this.symbol.linePatternFile;const{linePatternFileFn:t}=this.fnTypes;return this._getResource(e,t)}_getResource(e,t){if(t){e=t(this.options.zoom,this.feature.properties)}return e}}function Dt(e,t,n,i){const s=Math.abs(i)>>15,o=s>>1,a=s%2;let l=i%Math.pow(2,15);const h=t+(o<<14)*Math.sign(t),c=n+(a<<14)*Math.sign(n);return e[0]=h,e[1]=c,l=Math.round(l),e[2]=0===l?i<0?-1:0:l,e}const Ht=Math.pow(2,14),Nt=Math.pow(2,15),Bt=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];
/*!
  	    Feature Filter by

  	    (c) mapbox 2016 and maptalks 2018
  	    www.mapbox.com | www.maptalks.org
  	    License: MIT, header required.
  	*/function zt(e){if(!0===e||!1===e)return!0;if(!Array.isArray(e)||0===e.length)return!1;switch(e[0]){case"has":case"!has":return 2===e.length&&("string"==typeof e[1]||e[1].property&&e[1].op);case"in":case"!in":return e.length>=2&&("string"==typeof e[1]||e[1].property&&e[1].op);case"==":case"!=":case">":case">=":case"<":case"<=":return 3===e.length&&("string"==typeof e[1]||e[1].property&&e[1].op);case"none":case"any":case"all":for(const t of e.slice(1))if(!zt(t)&&"boolean"!=typeof t)return!1;return!0;case"contains":return!0;default:return!1}}function Ut(e){if(!e)return"true";const t=e[0];if(e.length<=1)return"any"===t?"false":"true";const n="=="===t?Wt(e[1],e[2],"===",!1):"!="===t?Wt(e[1],e[2],"!==",!1):"<"===t||">"===t||"<="===t||">="===t?Wt(e[1],e[2],t,!0):"any"===t?Zt(e.slice(1),"||"):"all"===t?Zt(e.slice(1),"&&"):"none"===t?Qt(Zt(e.slice(1),"||")):"in"===t?Xt(e[1],e.slice(2)):"!in"===t?Qt(Xt(e[1],e.slice(2))):"has"===t?Yt(e[1]):"!has"===t?Qt(Yt(e[1])):"contains"===t?function(e,t,n){const i=Vt(e);return void 0!==n?`(${i} + '').indexOf("${t}") === ${n}`:`(${i} + '').indexOf("${t}") >= 0`}(e[1],e[2],e[3]):"true";return`(${n})`}function Vt(e){return"$"===e[0]?"f."+e.substring(1):"p["+JSON.stringify(e)+"]"}function Wt(e,t,n,i){return"object"==typeof(s=e)&&s&&e.op?function(e,t,n,i){const s=e.property,o=e.op;let a=Vt(s);return"length"!==o?(console.error(`not support ${o} op`),"false"):(a=`((${a}+='').length)`,qt(a,s,t,n,i))}(e,t,n,i):qt(Vt(e),e,t,n,i);var s}function qt(e,t,n,i,s){const o="$type"===t?Bt.indexOf(n):JSON.stringify(n);return(s?`typeof ${e}=== typeof ${o}&&`:"")+e+i+o}function Zt(e,t){return e.map(Ut).join(t)}function Xt(e,t){"$type"===e&&(t=t.map((e=>Bt.indexOf(e))));const n=JSON.stringify(t.sort($t)),i=Vt(e);return t.length<=200?`${n}.indexOf(${i}) !== -1`:`function(v, a, i, j) {\n        while (i <= j) { var m = (i + j) >> 1;\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\n        }\n    return false; }(${i}, ${n},0,${t.length-1})`}function Yt(e){return"$id"===e?'"id" in f':`${JSON.stringify(e)} in p`}function Qt(e){return`!(${e})`}function $t(e,t){return e<t?-1:e>t?1:0}
/*!
  	 * a compact version of mapbox-gl-style-spec
  	 * based on mapbox-gl-style-spec@13.28.0
  	 * https://github.com/mapbox/mapbox-gl-js/tree/main/src/style-spec
  	 * LICENSE : ISC
  	 */var Kt="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},en={exports:{}};function tn(e,...t){for(const n of t)for(const t in n)e[t]=n[t];return e}
/*! https://mths.be/punycode v1.3.2 by @mathias */!function(e,t){!function(n){var i=t&&!t.nodeType&&t,s=e&&!e.nodeType&&e,o="object"==typeof Kt&&Kt;o.global!==o&&o.window!==o&&o.self!==o||(n=o);var a,l,h=2147483647,c=36,u=26,f=38,g=700,m=/^xn--/,A=/[^\x20-\x7E]/,w=/[\x2E\u3002\uFF0E\uFF61]/g,T={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},S=c-1,M=Math.floor,C=String.fromCharCode;function I(e){throw RangeError(T[e])}function E(e,t){for(var n=e.length,i=[];n--;)i[n]=t(e[n]);return i}function D(e,t){var n=e.split("@"),i="";return n.length>1&&(i=n[0]+"@",e=n[1]),i+E((e=e.replace(w,".")).split("."),t).join(".")}function H(e){for(var t,n,i=[],s=0,o=e.length;s<o;)(t=e.charCodeAt(s++))>=55296&&t<=56319&&s<o?56320==(64512&(n=e.charCodeAt(s++)))?i.push(((1023&t)<<10)+(1023&n)+65536):(i.push(t),s--):i.push(t);return i}function N(e){return E(e,(function(e){var t="";return e>65535&&(t+=C((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+C(e)})).join("")}function B(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function z(e,t,n){var i=0;for(e=n?M(e/g):e>>1,e+=M(e/t);e>S*u>>1;i+=c)e=M(e/S);return M(i+(S+1)*e/(e+f))}function U(e){var t,n,i,s,o,a,l,f,g,m,A,w=[],T=e.length,S=0,C=128,E=72;for((n=e.lastIndexOf("-"))<0&&(n=0),i=0;i<n;++i)e.charCodeAt(i)>=128&&I("not-basic"),w.push(e.charCodeAt(i));for(s=n>0?n+1:0;s<T;){for(o=S,a=1,l=c;s>=T&&I("invalid-input"),((f=(A=e.charCodeAt(s++))-48<10?A-22:A-65<26?A-65:A-97<26?A-97:c)>=c||f>M((h-S)/a))&&I("overflow"),S+=f*a,!(f<(g=l<=E?1:l>=E+u?u:l-E));l+=c)a>M(h/(m=c-g))&&I("overflow"),a*=m;E=z(S-o,t=w.length+1,0==o),M(S/t)>h-C&&I("overflow"),C+=M(S/t),S%=t,w.splice(S++,0,C)}return N(w)}function j(e){var t,n,i,s,o,a,l,f,g,m,A,w,T,S,E,D=[];for(w=(e=H(e)).length,t=128,n=0,o=72,a=0;a<w;++a)(A=e[a])<128&&D.push(C(A));for(i=s=D.length,s&&D.push("-");i<w;){for(l=h,a=0;a<w;++a)(A=e[a])>=t&&A<l&&(l=A);for(l-t>M((h-n)/(T=i+1))&&I("overflow"),n+=(l-t)*T,t=l,a=0;a<w;++a)if((A=e[a])<t&&++n>h&&I("overflow"),A==t){for(f=n,g=c;!(f<(m=g<=o?1:g>=o+u?u:g-o));g+=c)D.push(C(B(m+(E=f-m)%(S=c-m),0))),f=M(E/S);D.push(C(B(f,0))),o=z(n,T,i==s),n=0,++i}++n,++t}return D.join("")}if(a={version:"1.3.2",ucs2:{decode:H,encode:N},decode:U,encode:j,toASCII:function(e){return D(e,(function(e){return A.test(e)?"xn--"+j(e):e}))},toUnicode:function(e){return D(e,(function(e){return m.test(e)?U(e.slice(4).toLowerCase()):e}))}},i&&s)if(e.exports==i)s.exports=a;else for(l in a)a.hasOwnProperty(l)&&(i[l]=a[l]);else n.punycode=a}(Kt)}(en,en.exports);class kt extends Error{constructor(e,t){super(t),this.message=t,this.key=e}}var nn=kt;class Ft{constructor(e,t=[]){this.parent=e,this.bindings={};for(const[e,n]of t)this.bindings[e]=n}concat(e){return new Ft(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}var rn=Ft;const sn={kind:"null"},un={kind:"number"},fn={kind:"string"},dn={kind:"boolean"},pn={kind:"color"},mn={kind:"object"},yn={kind:"value"},vn={kind:"collator"},bn={kind:"formatted"},wn={kind:"resolvedImage"};function Mn(e,t){return{kind:"array",itemType:e,N:t}}function Cn(e){if("array"===e.kind){const t=Cn(e.itemType);return"number"==typeof e.N?`array<${t}, ${e.N}>`:"value"===e.itemType.kind?"array":`array<${t}>`}return e.kind}const Pn=[sn,un,fn,dn,pn,bn,mn,Mn(yn),wn];function kn(e,t){if("error"===t.kind)return null;if("array"===e.kind){if("array"===t.kind&&(0===t.N&&"value"===t.itemType.kind||!kn(e.itemType,t.itemType))&&("number"!=typeof e.N||e.N===t.N))return null}else{if(e.kind===t.kind)return null;if("value"===e.kind)for(const e of Pn)if(!kn(e,t))return null}return`Expected ${Cn(e)} but found ${Cn(t)} instead.`}function En(e,t){return t.some((t=>t.kind===e.kind))}function Rn(e,t){return t.some((t=>"null"===t?null===e:"array"===t?Array.isArray(e):"object"===t?e&&!Array.isArray(e)&&"object"==typeof e:t===typeof e))}var Ln,Dn={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function Fn(e){return(e=Math.round(e))<0?0:e>255?255:e}function Hn(e){return e<0?0:e>1?1:e}function Nn(e){return Fn("%"===e[e.length-1]?parseFloat(e)/100*255:parseInt(e))}function Bn(e){return Hn("%"===e[e.length-1]?parseFloat(e)/100:parseFloat(e))}function zn(e,t,n){return n<0?n+=1:n>1&&(n-=1),6*n<1?e+(t-e)*n*6:2*n<1?t:3*n<2?e+(t-e)*(2/3-n)*6:e}try{Ln={}.parseCSSColor=function(e){var t,n=e.replace(/ /g,"").toLowerCase();if(n in Dn)return Dn[n].slice();if("#"===n[0])return 4===n.length?(t=parseInt(n.substr(1),16))>=0&&t<=4095?[(3840&t)>>4|(3840&t)>>8,240&t|(240&t)>>4,15&t|(15&t)<<4,1]:null:7===n.length&&(t=parseInt(n.substr(1),16))>=0&&t<=16777215?[(16711680&t)>>16,(65280&t)>>8,255&t,1]:null;var i=n.indexOf("("),s=n.indexOf(")");if(-1!==i&&s+1===n.length){var o=n.substr(0,i),a=n.substr(i+1,s-(i+1)).split(","),l=1;switch(o){case"rgba":if(4!==a.length)return null;l=Bn(a.pop());case"rgb":return 3!==a.length?null:[Nn(a[0]),Nn(a[1]),Nn(a[2]),l];case"hsla":if(4!==a.length)return null;l=Bn(a.pop());case"hsl":if(3!==a.length)return null;var h=(parseFloat(a[0])%360+360)%360/360,c=Bn(a[1]),u=Bn(a[2]),f=u<=.5?u*(c+1):u+c-u*c,g=2*u-f;return[Fn(255*zn(g,f,h+1/3)),Fn(255*zn(g,f,h)),Fn(255*zn(g,f,h-1/3)),l];default:return null}}return null}}catch(e){}class on{constructor(e,t,n,i=1){this.r=e,this.g=t,this.b=n,this.a=i}static parse(e){if(!e)return;if(e instanceof on)return e;if("string"!=typeof e)return;const t=Ln(e);return t?new on(t[0]/255*t[3],t[1]/255*t[3],t[2]/255*t[3],t[3]):void 0}toString(){const[e,t,n,i]=this.toArray();return`rgba(${Math.round(e)},${Math.round(t)},${Math.round(n)},${i})`}toArray(){const{r:e,g:t,b:n,a:i}=this;return 0===i?[0,0,0,0]:[255*e/i,255*t/i,255*n/i,i]}toArray01(){const{r:e,g:t,b:n,a:i}=this;return 0===i?[0,0,0,0]:[e/i,t/i,n/i,i]}toArray01PremultipliedAlpha(){const{r:e,g:t,b:n,a:i}=this;return[e,t,n,i]}}on.black=new on(0,0,0,1),on.white=new on(1,1,1,1),on.transparent=new on(0,0,0,0),on.red=new on(1,0,0,1),on.blue=new on(0,0,1,1);var Un=on;class an{constructor(e,t,n){this.sensitivity=e?t?"variant":"case":t?"accent":"base",this.locale=n,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,t){return this.collator.compare(e,t)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class ln{constructor(e,t,n,i,s){this.text=e.normalize?e.normalize():e,this.image=t,this.scale=n,this.fontStack=i,this.textColor=s}}class hn{constructor(e){this.sections=e}static fromString(e){return new hn([new ln(e,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((e=>0!==e.text.length||e.image&&0!==e.image.name.length))}static factory(e){return e instanceof hn?e:hn.fromString(e)}toString(){return 0===this.sections.length?"":this.sections.map((e=>e.text)).join("")}serialize(){const e=["format"];for(const t of this.sections){if(t.image){e.push(["image",t.image.name]);continue}e.push(t.text);const n={};t.fontStack&&(n["text-font"]=["literal",t.fontStack.split(",")]),t.scale&&(n["font-scale"]=t.scale),t.textColor&&(n["text-color"]=["rgba"].concat(t.textColor.toArray())),e.push(n)}return e}}class cn{constructor(e){this.name=e.name,this.available=e.available}toString(){return this.name}static fromString(e){return e?new cn({name:e,available:!1}):null}serialize(){return["image",this.name]}}function Vn(e,t,n,i){return"number"==typeof e&&e>=0&&e<=255&&"number"==typeof t&&t>=0&&t<=255&&"number"==typeof n&&n>=0&&n<=255?void 0===i||"number"==typeof i&&i>=0&&i<=1?null:`Invalid rgba value [${[e,t,n,i].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof i?[e,t,n,i]:[e,t,n]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function jn(e){if(null===e)return!0;if("string"==typeof e)return!0;if("boolean"==typeof e)return!0;if("number"==typeof e)return!0;if(e instanceof Un)return!0;if(e instanceof an)return!0;if(e instanceof hn)return!0;if(e instanceof cn)return!0;if(Array.isArray(e)){for(const t of e)if(!jn(t))return!1;return!0}if("object"==typeof e){for(const t in e)if(!jn(e[t]))return!1;return!0}return!1}function Wn(e){if(null===e)return sn;if("string"==typeof e)return fn;if("boolean"==typeof e)return dn;if("number"==typeof e)return un;if(e instanceof Un)return pn;if(e instanceof an)return vn;if(e instanceof hn)return bn;if(e instanceof cn)return wn;if(Array.isArray(e)){const t=e.length;let n;for(const t of e){const e=Wn(t);if(n){if(n===e)continue;n=yn;break}n=e}return Mn(n||yn,t)}return mn}function qn(e){const t=typeof e;return null===e?"":"string"===t||"number"===t||"boolean"===t?String(e):e instanceof Un||e instanceof hn||e instanceof cn?e.toString():JSON.stringify(e)}class gn{constructor(e,t){this.type=e,this.value=t}static parse(e,t){if(2!==e.length)return t.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!jn(e[1]))return t.error("invalid value");const n=e[1];let i=Wn(n);const s=t.expectedType;return"array"!==i.kind||0!==i.N||!s||"array"!==s.kind||"number"==typeof s.N&&0!==s.N||(i=s),new gn(i,n)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof Un?["rgba"].concat(this.value.toArray()):this.value instanceof hn?this.value.serialize():this.value}}var Zn=gn,Xn=class{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}};const Jn={string:fn,number:un,boolean:dn,object:mn};class _n{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");let n,i=1;const s=e[0];if("array"===s){let s,o;if(e.length>2){const n=e[1];if("string"!=typeof n||!(n in Jn)||"object"===n)return t.error('The item type argument of "array" must be one of string, number, boolean',1);s=Jn[n],i++}else s=yn;if(e.length>3){if(null!==e[2]&&("number"!=typeof e[2]||e[2]<0||e[2]!==Math.floor(e[2])))return t.error('The length argument to "array" must be a positive integer literal',2);o=e[2],i++}n=Mn(s,o)}else n=Jn[s];const o=[];for(;i<e.length;i++){const n=t.parse(e[i],i,yn);if(!n)return null;o.push(n)}return new _n(n,o)}evaluate(e){for(let t=0;t<this.args.length;t++){const n=this.args[t].evaluate(e);if(!kn(this.type,Wn(n)))return n;if(t===this.args.length-1)throw new Xn(`Expected value to be of type ${Cn(this.type)}, but found ${Cn(Wn(n))} instead.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){const e=this.type,t=[e.kind];if("array"===e.kind){const n=e.itemType;if("string"===n.kind||"number"===n.kind||"boolean"===n.kind){t.push(n.kind);const i=e.N;("number"==typeof i||this.args.length>1)&&t.push(i)}}return t.concat(this.args.map((e=>e.serialize())))}}var Kn=_n;class An{constructor(e){this.type=bn,this.sections=e}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");const n=e[1];if(!Array.isArray(n)&&"object"==typeof n)return t.error("First argument must be an image or text section.");const i=[];let s=!1;for(let n=1;n<=e.length-1;++n){const o=e[n];if(s&&"object"==typeof o&&!Array.isArray(o)){s=!1;let e=null;if(o["font-scale"]&&(e=t.parse(o["font-scale"],1,un),!e))return null;let n=null;if(o["text-font"]&&(n=t.parse(o["text-font"],1,Mn(fn)),!n))return null;let a=null;if(o["text-color"]&&(a=t.parse(o["text-color"],1,pn),!a))return null;const l=i[i.length-1];l.scale=e,l.font=n,l.textColor=a}else{const o=t.parse(e[n],1,yn);if(!o)return null;const a=o.type.kind;if("string"!==a&&"value"!==a&&"null"!==a&&"resolvedImage"!==a)return t.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");s=!0,i.push({content:o,scale:null,font:null,textColor:null})}}return new An(i)}evaluate(e){return new hn(this.sections.map((t=>{const n=t.content.evaluate(e);return Wn(n)===wn?new ln("",n,null,null,null):new ln(qn(n),null,t.scale?t.scale.evaluate(e):null,t.font?t.font.evaluate(e).join(","):null,t.textColor?t.textColor.evaluate(e):null)})))}eachChild(e){for(const t of this.sections)e(t.content),t.scale&&e(t.scale),t.font&&e(t.font),t.textColor&&e(t.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const t of this.sections){e.push(t.content.serialize());const n={};t.scale&&(n["font-scale"]=t.scale.serialize()),t.font&&(n["text-font"]=t.font.serialize()),t.textColor&&(n["text-color"]=t.textColor.serialize()),e.push(n)}return e}}class Tn{constructor(e){this.type=wn,this.input=e}static parse(e,t){if(2!==e.length)return t.error("Expected two arguments.");const n=t.parse(e[1],1,fn);return n?new Tn(n):t.error("No image name provided.")}evaluate(e){const t=this.input.evaluate(e),n=cn.fromString(t);return n&&e.availableImages&&(n.available=e.availableImages.indexOf(t)>-1),n}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}}const er={"to-boolean":dn,"to-color":pn,"to-number":un,"to-string":fn};class Sn{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");const n=e[0];if(("to-boolean"===n||"to-string"===n)&&2!==e.length)return t.error("Expected one argument.");const i=er[n],s=[];for(let n=1;n<e.length;n++){const i=t.parse(e[n],n,yn);if(!i)return null;s.push(i)}return new Sn(i,s)}evaluate(e){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(e));if("color"===this.type.kind){let t,n;for(const i of this.args){if(t=i.evaluate(e),n=null,t instanceof Un)return t;if("string"==typeof t){const n=e.parseColor(t);if(n)return n}else if(Array.isArray(t)&&(n=t.length<3||t.length>4?`Invalid rbga value ${JSON.stringify(t)}: expected an array containing either three or four numeric values.`:Vn(t[0],t[1],t[2],t[3]),!n))return new Un(t[0]/255,t[1]/255,t[2]/255,t[3])}throw new Xn(n||`Could not parse color from value '${"string"==typeof t?t:String(JSON.stringify(t))}'`)}if("number"===this.type.kind){let t=null;for(const n of this.args){if(t=n.evaluate(e),null===t)return 0;const i=Number(t);if(!isNaN(i))return i}throw new Xn(`Could not convert ${JSON.stringify(t)} to number.`)}return"formatted"===this.type.kind?hn.fromString(qn(this.args[0].evaluate(e))):"resolvedImage"===this.type.kind?cn.fromString(qn(this.args[0].evaluate(e))):qn(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){if("formatted"===this.type.kind)return new An([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new Tn(this.args[0]).serialize();const e=[`to-${this.type.kind}`];return this.eachChild((t=>{e.push(t.serialize())})),e}}var tr=Sn;const nr=["Unknown","Point","LineString","Polygon"];var sr=class{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?nr[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,t=this.featureDistanceData.scale,{x:n,y:i}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(n*t-e[0])+this.featureDistanceData.bearing[1]*(i*t-e[1])}return 0}parseColor(e){let t=this._parseColorCache[e];return t||(t=this._parseColorCache[e]=Un.parse(e)),t}};class In{constructor(e,t,n,i){this.name=e,this.type=t,this._evaluate=n,this.args=i}evaluate(e){return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((e=>e.serialize())))}static parse(e,t){const n=e[0],i=In.definitions[n];if(!i)return t.error(`Unknown expression "${n}". If you wanted a literal array, use ["literal", [...]].`,0);const s=Array.isArray(i)?i[0]:i.type,o=Array.isArray(i)?[[i[1],i[2]]]:i.overloads,a=o.filter((([t])=>!Array.isArray(t)||t.length===e.length-1));let l=null;for(const[i,o]of a){l=new Dr(t.registry,t.path,null,t.scope);const a=[];let h=!1;for(let t=1;t<e.length;t++){const n=e[t],s=Array.isArray(i)?i[t-1]:i.type,o=l.parse(n,1+a.length,s);if(!o){h=!0;break}a.push(o)}if(!h)if(Array.isArray(i)&&i.length!==a.length)l.error(`Expected ${i.length} arguments, but found ${a.length} instead.`);else{for(let e=0;e<a.length;e++){const t=Array.isArray(i)?i[e]:i.type,n=a[e];l.concat(e+1).checkSubtype(t,n.type)}if(0===l.errors.length)return new In(n,s,o,a)}}if(1===a.length)t.errors.push(...l.errors);else{const n=(a.length?a:o).map((([e])=>{return t=e,Array.isArray(t)?`(${t.map(Cn).join(", ")})`:`(${Cn(t.type)}...)`;var t})).join(" | "),i=[];for(let n=1;n<e.length;n++){const s=t.parse(e[n],1+i.length);if(!s)return null;i.push(Cn(s.type))}t.error(`Expected arguments of type ${n}, but found (${i.join(", ")}) instead.`)}return null}static register(e,t){In.definitions=t;for(const n in t)e[n]=In}}var or=In;class On{constructor(e,t,n){this.type=vn,this.locale=n,this.caseSensitive=e,this.diacriticSensitive=t}static parse(e,t){if(2!==e.length)return t.error("Expected one argument.");const n=e[1];if("object"!=typeof n||Array.isArray(n))return t.error("Collator options argument must be an object.");const i=t.parse(void 0!==n["case-sensitive"]&&n["case-sensitive"],1,dn);if(!i)return null;const s=t.parse(void 0!==n["diacritic-sensitive"]&&n["diacritic-sensitive"],1,dn);if(!s)return null;let o=null;return n.locale&&(o=t.parse(n.locale,1,fn),!o)?null:new On(i,s,o)}evaluate(e){return new an(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}const ar=8192;function lr(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.max(e[2],t[0]),e[3]=Math.max(e[3],t[1])}function hr(e,t){return!(e[0]<=t[0]||e[2]>=t[2]||e[1]<=t[1]||e[3]>=t[3])}function cr(e,t){const n=(180+e[0])/360,i=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e[1]*Math.PI/360)))/360;const s=Math.pow(2,t.z);return[Math.round(n*s*ar),Math.round(i*s*ar)]}function ur(e,t,n){const i=e[0]-t[0],s=e[1]-t[1],o=e[0]-n[0],a=e[1]-n[1];return i*a-o*s==0&&i*o<=0&&s*a<=0}function fr(e,t){let n=!1;for(let a=0,l=t.length;a<l;a++){const l=t[a];for(let t=0,a=l.length;t<a-1;t++){if(ur(e,l[t],l[t+1]))return!1;(s=l[t])[1]>(i=e)[1]!=(o=l[t+1])[1]>i[1]&&i[0]<(o[0]-s[0])*(i[1]-s[1])/(o[1]-s[1])+s[0]&&(n=!n)}}var i,s,o;return n}function dr(e,t){for(let n=0;n<t.length;n++)if(fr(e,t[n]))return!0;return!1}function pr(e,t,n,i){const s=i[0]-n[0],o=i[1]-n[1],a=(e[0]-n[0])*o-s*(e[1]-n[1]),l=(t[0]-n[0])*o-s*(t[1]-n[1]);return a>0&&l<0||a<0&&l>0}function gr(e,t,n,i){return 0!=(s=[i[0]-n[0],i[1]-n[1]])[0]*(o=[t[0]-e[0],t[1]-e[1]])[1]-s[1]*o[0]&&!(!pr(e,t,n,i)||!pr(n,i,e,t));var s,o}function mr(e,t,n){for(const i of n)for(let n=0;n<i.length-1;++n)if(gr(e,t,i[n],i[n+1]))return!0;return!1}function Ar(e,t){for(let n=0;n<e.length;++n)if(!fr(e[n],t))return!1;for(let n=0;n<e.length-1;++n)if(mr(e[n],e[n+1],t))return!1;return!0}function yr(e,t){for(let n=0;n<t.length;n++)if(Ar(e,t[n]))return!0;return!1}function _r(e,t,n){const i=[];for(let s=0;s<e.length;s++){const o=[];for(let i=0;i<e[s].length;i++){const a=cr(e[s][i],n);lr(t,a),o.push(a)}i.push(o)}return i}function xr(e,t,n){const i=[];for(let s=0;s<e.length;s++){const o=_r(e[s],t,n);i.push(o)}return i}function wr(e,t,n,i){if(e[0]<n[0]||e[0]>n[2]){const t=.5*i;let s=e[0]-n[0]>t?-i:n[0]-e[0]>t?i:0;0===s&&(s=e[0]-n[2]>t?-i:n[2]-e[0]>t?i:0),e[0]+=s}lr(t,e)}function Tr(e,t,n,i){const s=Math.pow(2,i.z)*ar,o=[i.x*ar,i.y*ar],a=[];if(!e)return a;for(const i of e)for(const e of i){const i=[e.x+o[0],e.y+o[1]];wr(i,t,n,s),a.push(i)}return a}function Sr(e,t,n,i){const s=Math.pow(2,i.z)*ar,o=[i.x*ar,i.y*ar],a=[];if(!e)return a;for(const n of e){const e=[];for(const i of n){const n=[i.x+o[0],i.y+o[1]];lr(t,n),e.push(n)}a.push(e)}if(t[2]-t[0]<=s/2){(l=t)[0]=l[1]=1/0,l[2]=l[3]=-1/0;for(const e of a)for(const i of e)wr(i,t,n,s)}var l;return a}class Yn{constructor(e,t){this.type=dn,this.geojson=e,this.geometries=t}static parse(e,t){if(2!==e.length)return t.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(jn(e[1])){const t=e[1];if("FeatureCollection"===t.type)for(let e=0;e<t.features.length;++e){const n=t.features[e].geometry.type;if("Polygon"===n||"MultiPolygon"===n)return new Yn(t,t.features[e].geometry)}else if("Feature"===t.type){const e=t.geometry.type;if("Polygon"===e||"MultiPolygon"===e)return new Yn(t,t.geometry)}else if("Polygon"===t.type||"MultiPolygon"===t.type)return new Yn(t,t)}return t.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(null!=e.geometry()&&null!=e.canonicalID()){if("Point"===e.geometryType())return function(e,t){const n=[1/0,1/0,-1/0,-1/0],i=[1/0,1/0,-1/0,-1/0],s=e.canonicalID();if(!s)return!1;if("Polygon"===t.type){const o=_r(t.coordinates,i,s),a=Tr(e.geometry(),n,i,s);if(!hr(n,i))return!1;for(const e of a)if(!fr(e,o))return!1}if("MultiPolygon"===t.type){const o=xr(t.coordinates,i,s),a=Tr(e.geometry(),n,i,s);if(!hr(n,i))return!1;for(const e of a)if(!dr(e,o))return!1}return!0}(e,this.geometries);if("LineString"===e.geometryType())return function(e,t){const n=[1/0,1/0,-1/0,-1/0],i=[1/0,1/0,-1/0,-1/0],s=e.canonicalID();if(!s)return!1;if("Polygon"===t.type){const o=_r(t.coordinates,i,s),a=Sr(e.geometry(),n,i,s);if(!hr(n,i))return!1;for(const e of a)if(!Ar(e,o))return!1}if("MultiPolygon"===t.type){const o=xr(t.coordinates,i,s),a=Sr(e.geometry(),n,i,s);if(!hr(n,i))return!1;for(const e of a)if(!yr(e,o))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var Ir=Yn;function kr(e){if(e instanceof or){if("get"===e.name&&1===e.args.length)return!1;if("feature-state"===e.name)return!1;if("has"===e.name&&1===e.args.length)return!1;if("properties"===e.name||"geometry-type"===e.name||"id"===e.name)return!1;if(/^filter-/.test(e.name))return!1}if(e instanceof Ir)return!1;let t=!0;return e.eachChild((e=>{t&&!kr(e)&&(t=!1)})),t}function Er(e){if(e instanceof or&&"feature-state"===e.name)return!1;let t=!0;return e.eachChild((e=>{t&&!Er(e)&&(t=!1)})),t}function Rr(e,t){if(e instanceof or&&t.indexOf(e.name)>=0)return!1;let n=!0;return e.eachChild((e=>{n&&!Rr(e,t)&&(n=!1)})),n}class Qn{constructor(e,t){this.type=t.type,this.name=e,this.boundExpression=t}static parse(e,t){if(2!==e.length||"string"!=typeof e[1])return t.error("'var' expression requires exactly one string literal argument.");const n=e[1];return t.scope.has(n)?new Qn(n,t.scope.get(n)):t.error(`Unknown variable "${n}". Make sure "${n}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var Lr=Qn;class ti{constructor(e,t=[],n,i=new rn,s=[]){this.registry=e,this.path=t,this.key=t.map((e=>`[${e}]`)).join(""),this.scope=i,this.errors=s,this.expectedType=n}parse(e,t,n,i,s={}){return t?this.concat(t,n,i)._parse(e,s):this._parse(e,s)}_parse(e,t){function n(e,t,n){return"assert"===n?new Kn(t,[e]):"coerce"===n?new tr(t,[e]):e}if(null!==e&&"string"!=typeof e&&"boolean"!=typeof e&&"number"!=typeof e||(e=["literal",e]),Array.isArray(e)){if(0===e.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const i=e[0];if("string"!=typeof i)return this.error(`Expression name must be a string, but found ${typeof i} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const s=this.registry[i];if(s){let i=s.parse(e,this);if(!i)return null;if(this.expectedType){const e=this.expectedType,s=i.type;if("string"!==e.kind&&"number"!==e.kind&&"boolean"!==e.kind&&"object"!==e.kind&&"array"!==e.kind||"value"!==s.kind)if("color"!==e.kind&&"formatted"!==e.kind&&"resolvedImage"!==e.kind||"value"!==s.kind&&"string"!==s.kind){if(this.checkSubtype(e,s))return null}else i=n(i,e,t.typeAnnotation||"coerce");else i=n(i,e,t.typeAnnotation||"assert")}if(!(i instanceof Zn)&&"resolvedImage"!==i.type.kind&&Fr(i)){const t=new sr;try{i=new Zn(i.type,i.evaluate(t))}catch(e){return this.error(e.message),null}}return i}return this.error(`Unknown expression "${i}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(void 0===e?"'undefined' value invalid. Use null instead.":"object"==typeof e?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,t,n){const i="number"==typeof e?this.path.concat(e):this.path,s=n?this.scope.concat(n):this.scope;return new ti(this.registry,i,t||null,s,this.errors)}error(e,...t){const n=`${this.key}${t.map((e=>`[${e}]`)).join("")}`;this.errors.push(new nn(n,e))}checkSubtype(e,t){const n=kn(e,t);return n&&this.error(n),n}}var Dr=ti;function Fr(e){if(e instanceof Lr)return Fr(e.boundExpression);if(e instanceof or&&"error"===e.name)return!1;if(e instanceof On)return!1;if(e instanceof Ir)return!1;const t=e instanceof tr||e instanceof Kn;let n=!0;return e.eachChild((e=>{n=t?n&&Fr(e):n&&e instanceof Zn})),!!n&&kr(e)&&Rr(e,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"])}function Hr(e,t){const n=e.length-1;let i,s,o=0,a=n,l=0;for(;o<=a;)if(l=Math.floor((o+a)/2),i=e[l],s=e[l+1],i<=t){if(l===n||t<s)return l;o=l+1}else{if(!(i>t))throw new Xn("Input is not a number.");a=l-1}return 0}class oi{constructor(e,t,n){this.type=e,this.input=t,this.labels=[],this.outputs=[];for(const[e,t]of n)this.labels.push(e),this.outputs.push(t)}static parse(e,t){if(e.length-1<4)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return t.error("Expected an even number of arguments.");const n=t.parse(e[1],1,un);if(!n)return null;const i=[];let s=null;t.expectedType&&"value"!==t.expectedType.kind&&(s=t.expectedType);for(let n=1;n<e.length;n+=2){const o=1===n?-1/0:e[n],a=e[n+1],l=n,h=n+1;if("number"!=typeof o)return t.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',l);if(i.length&&i[i.length-1][0]>=o)return t.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',l);const c=t.parse(a,h,s);if(!c)return null;s=s||c.type,i.push([o,c])}return new oi(s,n,i)}evaluate(e){const t=this.labels,n=this.outputs;if(1===t.length)return n[0].evaluate(e);const i=this.input.evaluate(e);if(i<=t[0])return n[0].evaluate(e);const s=t.length;return i>=t[s-1]?n[s-1].evaluate(e):n[Hr(t,i)].evaluate(e)}eachChild(e){e(this.input);for(const t of this.outputs)e(t)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}serialize(){const e=["step",this.input.serialize()];for(let t=0;t<this.labels.length;t++)t>0&&e.push(this.labels[t]),e.push(this.outputs[t].serialize());return e}}var Nr=oi,Br=Ur;function Ur(e,t,n,i){this.cx=3*e,this.bx=3*(n-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(i-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=t,this.p2x=n,this.p2y=i}function Vr(e,t,n){return e*(1-n)+t*n}Ur.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,t){if(void 0===t&&(t=1e-6),e<0)return 0;if(e>1)return 1;for(var n=e,i=0;i<8;i++){var s=this.sampleCurveX(n)-e;if(Math.abs(s)<t)return n;var o=this.sampleCurveDerivativeX(n);if(Math.abs(o)<1e-6)break;n-=s/o}var a=0,l=1;for(n=e,i=0;i<20&&(s=this.sampleCurveX(n),!(Math.abs(s-e)<t));i++)e>s?a=n:l=n,n=.5*(l-a)+a;return n},solve:function(e,t){return this.sampleCurveY(this.solveCurveX(e,t))}};var jr=Object.freeze({__proto__:null,number:Vr,color:function(e,t,n){return new Un(Vr(e.r,t.r,n),Vr(e.g,t.g,n),Vr(e.b,t.b,n),Vr(e.a,t.a,n))},array:function(e,t,n){return e.map(((e,i)=>Vr(e,t[i],n)))}});const qr=.95047,Zr=1.08883,Xr=4/29,Yr=6/29,Jr=3*Yr*Yr,Qr=Yr*Yr*Yr,$r=Math.PI/180,Kr=180/Math.PI;function ei(e){return e>Qr?Math.pow(e,1/3):e/Jr+Xr}function ni(e){return e>Yr?e*e*e:Jr*(e-Xr)}function ii(e){return 255*(e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055)}function ai(e){return(e/=255)<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function li(e){const t=ai(e.r),n=ai(e.g),i=ai(e.b),s=ei((.4124564*t+.3575761*n+.1804375*i)/qr),o=ei((.2126729*t+.7151522*n+.072175*i)/1);return{l:116*o-16,a:500*(s-o),b:200*(o-ei((.0193339*t+.119192*n+.9503041*i)/Zr)),alpha:e.a}}function hi(e){let t=(e.l+16)/116,n=isNaN(e.a)?t:t+e.a/500,i=isNaN(e.b)?t:t-e.b/200;return t=1*ni(t),n=qr*ni(n),i=Zr*ni(i),new Un(ii(3.2404542*n-1.5371385*t-.4985314*i),ii(-.969266*n+1.8760108*t+.041556*i),ii(.0556434*n-.2040259*t+1.0572252*i),e.alpha)}function ci(e,t,n){const i=t-e;return e+n*(i>180||i<-180?i-360*Math.round(i/360):i)}const fi={forward:li,reverse:hi,interpolate:function(e,t,n){return{l:Vr(e.l,t.l,n),a:Vr(e.a,t.a,n),b:Vr(e.b,t.b,n),alpha:Vr(e.alpha,t.alpha,n)}}},di={forward:function(e){const{l:t,a:n,b:i}=li(e),s=Math.atan2(i,n)*Kr;return{h:s<0?s+360:s,c:Math.sqrt(n*n+i*i),l:t,alpha:e.a}},reverse:function(e){const t=e.h*$r,n=e.c;return hi({l:e.l,a:Math.cos(t)*n,b:Math.sin(t)*n,alpha:e.alpha})},interpolate:function(e,t,n){return{h:ci(e.h,t.h,n),c:Vr(e.c,t.c,n),l:Vr(e.l,t.l,n),alpha:Vr(e.alpha,t.alpha,n)}}};var mi=Object.freeze({__proto__:null,lab:fi,hcl:di});class Ci{constructor(e,t,n,i,s){this.type=e,this.operator=t,this.interpolation=n,this.input=i,this.labels=[],this.outputs=[];for(const[e,t]of s)this.labels.push(e),this.outputs.push(t)}static interpolationFactor(e,t,n,i){let s=0;if("exponential"===e.name)s=Ai(t,e.base,n,i);else if("linear"===e.name)s=Ai(t,1,n,i);else if("cubic-bezier"===e.name){const o=e.controlPoints;s=new Br(o[0],o[1],o[2],o[3]).solve(Ai(t,1,n,i))}return s}static parse(e,t){let[n,i,s,...o]=e;if(!Array.isArray(i)||0===i.length)return t.error("Expected an interpolation type expression.",1);if("linear"===i[0])i={name:"linear"};else if("exponential"===i[0]){const e=i[1];if("number"!=typeof e)return t.error("Exponential interpolation requires a numeric base.",1,1);i={name:"exponential",base:e}}else{if("cubic-bezier"!==i[0])return t.error(`Unknown interpolation type ${String(i[0])}`,1,0);{const e=i.slice(1);if(4!==e.length||e.some((e=>"number"!=typeof e||e<0||e>1)))return t.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);i={name:"cubic-bezier",controlPoints:e}}}if(e.length-1<4)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return t.error("Expected an even number of arguments.");if(s=t.parse(s,2,un),!s)return null;const a=[];let l=null;"interpolate-hcl"===n||"interpolate-lab"===n?l=pn:t.expectedType&&"value"!==t.expectedType.kind&&(l=t.expectedType);for(let e=0;e<o.length;e+=2){const n=o[e],i=o[e+1],s=e+3,h=e+4;if("number"!=typeof n)return t.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',s);if(a.length&&a[a.length-1][0]>=n)return t.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',s);const c=t.parse(i,h,l);if(!c)return null;l=l||c.type,a.push([n,c])}return"number"===l.kind||"color"===l.kind||"array"===l.kind&&"number"===l.itemType.kind&&"number"==typeof l.N?new Ci(l,n,i,s,a):t.error(`Type ${Cn(l)} is not interpolatable.`)}evaluate(e){const t=this.labels,n=this.outputs;if(1===t.length)return n[0].evaluate(e);const i=this.input.evaluate(e);if(i<=t[0])return n[0].evaluate(e);const s=t.length;if(i>=t[s-1])return n[s-1].evaluate(e);const o=Hr(t,i),a=Ci.interpolationFactor(this.interpolation,i,t[o],t[o+1]),l=n[o].evaluate(e),h=n[o+1].evaluate(e);return"interpolate"===this.operator?jr[this.type.kind.toLowerCase()](l,h,a):"interpolate-hcl"===this.operator?di.reverse(di.interpolate(di.forward(l),di.forward(h),a)):fi.reverse(fi.interpolate(fi.forward(l),fi.forward(h),a))}eachChild(e){e(this.input);for(const t of this.outputs)e(t)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}serialize(){let e;e="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const t=[this.operator,e,this.input.serialize()];for(let e=0;e<this.labels.length;e++)t.push(this.labels[e],this.outputs[e].serialize());return t}}function Ai(e,t,n,i){const s=i-n,o=e-n;return 0===s?0:1===t?o/s:(Math.pow(t,o)-1)/(Math.pow(t,s)-1)}var yi=Ci;class Ri{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expectected at least one argument.");let n=null;const i=t.expectedType;i&&"value"!==i.kind&&(n=i);const s=[];for(const i of e.slice(1)){const e=t.parse(i,1+s.length,n,void 0,{typeAnnotation:"omit"});if(!e)return null;n=n||e.type,s.push(e)}const o=i&&s.some((e=>kn(i,e.type)));return new Ri(o?yn:n,s)}evaluate(e){let t,n=null,i=0;for(const s of this.args){if(i++,n=s.evaluate(e),n&&n instanceof cn&&!n.available&&(t||(t=n),n=null,i===this.args.length))return t;if(null!==n)break}return n}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){const e=["coalesce"];return this.eachChild((t=>{e.push(t.serialize())})),e}}var _i=Ri;class Ei{constructor(e,t){this.type=t.type,this.bindings=[].concat(e),this.result=t}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const t of this.bindings)e(t[1]);e(this.result)}static parse(e,t){if(e.length<4)return t.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const n=[];for(let i=1;i<e.length-1;i+=2){const s=e[i];if("string"!=typeof s)return t.error(`Expected string, but found ${typeof s} instead.`,i);if(/[^a-zA-Z0-9_]/.test(s))return t.error("Variable names must contain only alphanumeric characters or '_'.",i);const o=t.parse(e[i+1],i+1);if(!o)return null;n.push([s,o])}const i=t.parse(e[e.length-1],e.length-1,t.expectedType,n);return i?new Ei(n,i):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[t,n]of this.bindings)e.push(t,n.serialize());return e.push(this.result.serialize()),e}}var vi=Ei;class Hi{constructor(e,t,n){this.type=e,this.index=t,this.input=n}static parse(e,t){if(3!==e.length)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const n=t.parse(e[1],1,un),i=t.parse(e[2],2,Mn(t.expectedType||yn));if(!n||!i)return null;return new Hi(i.type.itemType,n,i)}evaluate(e){const t=this.index.evaluate(e),n=this.input.evaluate(e);if(t<0)throw new Xn(`Array index out of bounds: ${t} < 0.`);if(t>=n.length)throw new Xn(`Array index out of bounds: ${t} > ${n.length-1}.`);if(t!==Math.floor(t))throw new Xn(`Array index must be an integer, but found ${t} instead.`);return n[t]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var xi=Hi;class Ni{constructor(e,t){this.type=dn,this.needle=e,this.haystack=t}static parse(e,t){if(3!==e.length)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const n=t.parse(e[1],1,yn),i=t.parse(e[2],2,yn);return n&&i?En(n.type,[dn,fn,un,sn,yn])?new Ni(n,i):t.error(`Expected first argument to be of type boolean, string, number or null, but found ${Cn(n.type)} instead`):null}evaluate(e){const t=this.needle.evaluate(e),n=this.haystack.evaluate(e);if(null==n)return!1;if(!Rn(t,["boolean","string","number","null"]))throw new Xn(`Expected first argument to be of type boolean, string, number or null, but found ${Cn(Wn(t))} instead.`);if(!Rn(n,["string","array"]))throw new Xn(`Expected second argument to be of type array or string, but found ${Cn(Wn(n))} instead.`);return n.indexOf(t)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var bi=Ni;class Vi{constructor(e,t,n){this.type=un,this.needle=e,this.haystack=t,this.fromIndex=n}static parse(e,t){if(e.length<=2||e.length>=5)return t.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const n=t.parse(e[1],1,yn),i=t.parse(e[2],2,yn);if(!n||!i)return null;if(!En(n.type,[dn,fn,un,sn,yn]))return t.error(`Expected first argument to be of type boolean, string, number or null, but found ${Cn(n.type)} instead`);if(4===e.length){const s=t.parse(e[3],3,un);return s?new Vi(n,i,s):null}return new Vi(n,i)}evaluate(e){const t=this.needle.evaluate(e),n=this.haystack.evaluate(e);if(!Rn(t,["boolean","string","number","null"]))throw new Xn(`Expected first argument to be of type boolean, string, number or null, but found ${Cn(Wn(t))} instead.`);if(!Rn(n,["string","array"]))throw new Xn(`Expected second argument to be of type array or string, but found ${Cn(Wn(n))} instead.`);if(this.fromIndex){const i=this.fromIndex.evaluate(e);return n.indexOf(t,i)}return n.indexOf(t)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var wi=Vi;class Gi{constructor(e,t,n,i,s,o){this.inputType=e,this.type=t,this.input=n,this.cases=i,this.outputs=s,this.otherwise=o}static parse(e,t){if(e.length<5)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return t.error("Expected an even number of arguments.");let n,i;t.expectedType&&"value"!==t.expectedType.kind&&(i=t.expectedType);const s={},o=[];for(let a=2;a<e.length-1;a+=2){let l=e[a];const h=e[a+1];Array.isArray(l)||(l=[l]);const c=t.concat(a);if(0===l.length)return c.error("Expected at least one branch label.");for(const e of l){if("number"!=typeof e&&"string"!=typeof e)return c.error("Branch labels must be numbers or strings.");if("number"==typeof e&&Math.abs(e)>Number.MAX_SAFE_INTEGER)return c.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof e&&Math.floor(e)!==e)return c.error("Numeric branch labels must be integer values.");if(n){if(c.checkSubtype(n,Wn(e)))return null}else n=Wn(e);if(void 0!==s[String(e)])return c.error("Branch labels must be unique.");s[String(e)]=o.length}const u=t.parse(h,a,i);if(!u)return null;i=i||u.type,o.push(u)}const a=t.parse(e[1],1,yn);if(!a)return null;const l=t.parse(e[e.length-1],e.length-1,i);return l?"value"!==a.type.kind&&t.concat(1).checkSubtype(n,a.type)?null:new Gi(n,i,a,s,o,l):null}evaluate(e){const t=this.input.evaluate(e);return(Wn(t)===this.inputType&&this.outputs[this.cases[t]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],t=Object.keys(this.cases).sort(),n=[],i={};for(const e of t){const t=i[this.cases[e]];void 0===t?(i[this.cases[e]]=n.length,n.push([this.cases[e],[e]])):n[t][1].push(e)}const s=e=>"number"===this.inputType.kind?Number(e):e;for(const[t,i]of n)e.push(1===i.length?s(i[0]):i.map(s)),e.push(this.outputs[t].serialize());return e.push(this.otherwise.serialize()),e}}var Ti=Gi;class Wi{constructor(e,t,n){this.type=e,this.branches=t,this.otherwise=n}static parse(e,t){if(e.length<4)return t.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return t.error("Expected an odd number of arguments.");let n;t.expectedType&&"value"!==t.expectedType.kind&&(n=t.expectedType);const i=[];for(let s=1;s<e.length-1;s+=2){const o=t.parse(e[s],s,dn);if(!o)return null;const a=t.parse(e[s+1],s+1,n);if(!a)return null;i.push([o,a]),n=n||a.type}const s=t.parse(e[e.length-1],e.length-1,n);return s?new Wi(n,i,s):null}evaluate(e){for(const[t,n]of this.branches)if(t.evaluate(e))return n.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[t,n]of this.branches)e(t),e(n);e(this.otherwise)}outputDefined(){return this.branches.every((([e,t])=>t.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild((t=>{e.push(t.serialize())})),e}}var Si=Wi;class Xi{constructor(e,t,n,i){this.type=e,this.input=t,this.beginIndex=n,this.endIndex=i}static parse(e,t){if(e.length<=2||e.length>=5)return t.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const n=t.parse(e[1],1,yn),i=t.parse(e[2],2,un);if(!n||!i)return null;if(!En(n.type,[Mn(yn),fn,yn]))return t.error(`Expected first argument to be of type array or string, but found ${Cn(n.type)} instead`);if(4===e.length){const s=t.parse(e[3],3,un);return s?new Xi(n.type,n,i,s):null}return new Xi(n.type,n,i)}evaluate(e){const t=this.input.evaluate(e),n=this.beginIndex.evaluate(e);if(!Rn(t,["string","array"]))throw new Xn(`Expected first argument to be of type array or string, but found ${Cn(Wn(t))} instead.`);if(this.endIndex){const i=this.endIndex.evaluate(e);return t.slice(n,i)}return t.slice(n)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var Mi=Xi;function Pi(e,t){return"=="===e||"!="===e?"boolean"===t.kind||"string"===t.kind||"number"===t.kind||"null"===t.kind||"value"===t.kind:"string"===t.kind||"number"===t.kind||"value"===t.kind}function Ii(e,t,n,i){return 0===i.compare(t,n)}function ki(e,t,n){const i="=="!==e&&"!="!==e;return class r{constructor(e,t,n){this.type=dn,this.lhs=e,this.rhs=t,this.collator=n,this.hasUntypedArgument="value"===e.type.kind||"value"===t.type.kind}static parse(e,t){if(3!==e.length&&4!==e.length)return t.error("Expected two or three arguments.");const n=e[0];let s=t.parse(e[1],1,yn);if(!s)return null;if(!Pi(n,s.type))return t.concat(1).error(`"${n}" comparisons are not supported for type '${Cn(s.type)}'.`);let o=t.parse(e[2],2,yn);if(!o)return null;if(!Pi(n,o.type))return t.concat(2).error(`"${n}" comparisons are not supported for type '${Cn(o.type)}'.`);if(s.type.kind!==o.type.kind&&"value"!==s.type.kind&&"value"!==o.type.kind)return t.error(`Cannot compare types '${Cn(s.type)}' and '${Cn(o.type)}'.`);i&&("value"===s.type.kind&&"value"!==o.type.kind?s=new Kn(o.type,[s]):"value"!==s.type.kind&&"value"===o.type.kind&&(o=new Kn(s.type,[o])));let a=null;if(4===e.length){if("string"!==s.type.kind&&"string"!==o.type.kind&&"value"!==s.type.kind&&"value"!==o.type.kind)return t.error("Cannot use collator to compare non-string types.");if(a=t.parse(e[3],3,vn),!a)return null}return new r(s,o,a)}evaluate(s){const o=this.lhs.evaluate(s),a=this.rhs.evaluate(s);if(i&&this.hasUntypedArgument){const t=Wn(o),n=Wn(a);if(t.kind!==n.kind||"string"!==t.kind&&"number"!==t.kind)throw new Xn(`Expected arguments for "${e}" to be (string, string) or (number, number), but found (${t.kind}, ${n.kind}) instead.`)}if(this.collator&&!i&&this.hasUntypedArgument){const e=Wn(o),n=Wn(a);if("string"!==e.kind||"string"!==n.kind)return t(s,o,a)}return this.collator?n(s,o,a,this.collator.evaluate(s)):t(s,o,a)}eachChild(e){e(this.lhs),e(this.rhs),this.collator&&e(this.collator)}outputDefined(){return!0}serialize(){const t=[e];return this.eachChild((e=>{t.push(e.serialize())})),t}}}const Oi=ki("==",(function(e,t,n){return t===n}),Ii),Li=ki("!=",(function(e,t,n){return t!==n}),(function(e,t,n,i){return!Ii(0,t,n,i)})),Di=ki("<",(function(e,t,n){return t<n}),(function(e,t,n,i){return i.compare(t,n)<0})),Fi=ki(">",(function(e,t,n){return t>n}),(function(e,t,n,i){return i.compare(t,n)>0})),Bi=ki("<=",(function(e,t,n){return t<=n}),(function(e,t,n,i){return i.compare(t,n)<=0})),zi=ki(">=",(function(e,t,n){return t>=n}),(function(e,t,n,i){return i.compare(t,n)>=0}));class ir{constructor(e,t,n,i,s,o){this.type=fn,this.number=e,this.locale=t,this.currency=n,this.unit=i,this.minFractionDigits=s,this.maxFractionDigits=o}static parse(e,t){if(3!==e.length)return t.error("Expected two arguments.");const n=t.parse(e[1],1,un);if(!n)return null;const i=e[2];if("object"!=typeof i||Array.isArray(i))return t.error("NumberFormat options argument must be an object.");let s=null;if(i.locale&&(s=t.parse(i.locale,1,fn),!s))return null;let o=null;if(i.currency&&(o=t.parse(i.currency,1,fn),!o))return null;let a=null;if(i.unit&&(a=t.parse(i.unit,1,fn),!a))return null;let l=null;if(i["min-fraction-digits"]&&(l=t.parse(i["min-fraction-digits"],1,un),!l))return null;let h=null;return i["max-fraction-digits"]&&(h=t.parse(i["max-fraction-digits"],1,un),!h)?null:new ir(n,s,o,a,l,h)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class rr{constructor(e){this.type=un,this.input=e}static parse(e,t){if(2!==e.length)return t.error(`Expected 1 argument, but found ${e.length-1} instead.`);const n=t.parse(e[1],1);return n?"array"!==n.type.kind&&"string"!==n.type.kind&&"value"!==n.type.kind?t.error(`Expected argument of type string or array, but found ${Cn(n.type)} instead.`):new rr(n):null}evaluate(e){const t=this.input.evaluate(e);if("string"==typeof t)return t.length;if(Array.isArray(t))return t.length;throw new Xn(`Expected value to be of type string or array, but found ${Cn(Wn(t))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild((t=>{e.push(t.serialize())})),e}}const Ui={"==":Oi,"!=":Li,">":Fi,"<":Di,">=":zi,"<=":Bi,array:Kn,at:xi,boolean:Kn,case:Si,coalesce:_i,collator:On,format:An,image:Tn,in:bi,"index-of":wi,interpolate:yi,"interpolate-hcl":yi,"interpolate-lab":yi,length:rr,let:vi,literal:Zn,match:Ti,number:Kn,"number-format":ir,object:Kn,slice:Mi,step:Nr,string:Kn,"to-boolean":tr,"to-color":tr,"to-number":tr,"to-string":tr,var:Lr,within:Ir};function ji(e,[t,n,i,s]){t=t.evaluate(e),n=n.evaluate(e),i=i.evaluate(e);const o=s?s.evaluate(e):1,a=Vn(t,n,i,o);if(a)throw new Xn(a);return new Un(t/255*o,n/255*o,i/255*o,o)}function qi(e,t){return e in t}function Zi(e,t){const n=t[e];return void 0===n?null:n}function Yi(e){return{type:e}}or.register(Ui,{error:[{kind:"error"},[fn],(e,[t])=>{throw new Xn(t.evaluate(e))}],typeof:[fn,[yn],(e,[t])=>Cn(Wn(t.evaluate(e)))],"to-rgba":[Mn(un,4),[pn],(e,[t])=>t.evaluate(e).toArray()],rgb:[pn,[un,un,un],ji],rgba:[pn,[un,un,un,un],ji],has:{type:dn,overloads:[[[fn],(e,[t])=>qi(t.evaluate(e),e.properties())],[[fn,mn],(e,[t,n])=>qi(t.evaluate(e),n.evaluate(e))]]},get:{type:yn,overloads:[[[fn],(e,[t])=>Zi(t.evaluate(e),e.properties())],[[fn,mn],(e,[t,n])=>Zi(t.evaluate(e),n.evaluate(e))]]},"feature-state":[yn,[fn],(e,[t])=>Zi(t.evaluate(e),e.featureState||{})],properties:[mn,[],e=>e.properties()],"geometry-type":[fn,[],e=>e.geometryType()],id:[yn,[],e=>e.id()],zoom:[un,[],e=>e.globals.zoom],pitch:[un,[],e=>e.globals.pitch||0],"distance-from-center":[un,[],e=>e.distanceFromCenter()],"heatmap-density":[un,[],e=>e.globals.heatmapDensity||0],"line-progress":[un,[],e=>e.globals.lineProgress||0],"sky-radial-progress":[un,[],e=>e.globals.skyRadialProgress||0],accumulated:[yn,[],e=>void 0===e.globals.accumulated?null:e.globals.accumulated],"+":[un,Yi(un),(e,t)=>{let n=0;for(const i of t)n+=i.evaluate(e);return n}],"*":[un,Yi(un),(e,t)=>{let n=1;for(const i of t)n*=i.evaluate(e);return n}],"-":{type:un,overloads:[[[un,un],(e,[t,n])=>t.evaluate(e)-n.evaluate(e)],[[un],(e,[t])=>-t.evaluate(e)]]},"/":[un,[un,un],(e,[t,n])=>t.evaluate(e)/n.evaluate(e)],"%":[un,[un,un],(e,[t,n])=>t.evaluate(e)%n.evaluate(e)],ln2:[un,[],()=>Math.LN2],pi:[un,[],()=>Math.PI],e:[un,[],()=>Math.E],"^":[un,[un,un],(e,[t,n])=>Math.pow(t.evaluate(e),n.evaluate(e))],sqrt:[un,[un],(e,[t])=>Math.sqrt(t.evaluate(e))],log10:[un,[un],(e,[t])=>Math.log(t.evaluate(e))/Math.LN10],ln:[un,[un],(e,[t])=>Math.log(t.evaluate(e))],log2:[un,[un],(e,[t])=>Math.log(t.evaluate(e))/Math.LN2],sin:[un,[un],(e,[t])=>Math.sin(t.evaluate(e))],cos:[un,[un],(e,[t])=>Math.cos(t.evaluate(e))],tan:[un,[un],(e,[t])=>Math.tan(t.evaluate(e))],asin:[un,[un],(e,[t])=>Math.asin(t.evaluate(e))],acos:[un,[un],(e,[t])=>Math.acos(t.evaluate(e))],atan:[un,[un],(e,[t])=>Math.atan(t.evaluate(e))],min:[un,Yi(un),(e,t)=>Math.min(...t.map((t=>t.evaluate(e))))],max:[un,Yi(un),(e,t)=>Math.max(...t.map((t=>t.evaluate(e))))],abs:[un,[un],(e,[t])=>Math.abs(t.evaluate(e))],round:[un,[un],(e,[t])=>{const n=t.evaluate(e);return n<0?-Math.round(-n):Math.round(n)}],floor:[un,[un],(e,[t])=>Math.floor(t.evaluate(e))],ceil:[un,[un],(e,[t])=>Math.ceil(t.evaluate(e))],"filter-==":[dn,[fn,yn],(e,[t,n])=>e.properties()[t.value]===n.value],"filter-id-==":[dn,[yn],(e,[t])=>e.id()===t.value],"filter-type-==":[dn,[fn],(e,[t])=>e.geometryType()===t.value],"filter-<":[dn,[fn,yn],(e,[t,n])=>{const i=e.properties()[t.value],s=n.value;return typeof i==typeof s&&i<s}],"filter-id-<":[dn,[yn],(e,[t])=>{const n=e.id(),i=t.value;return typeof n==typeof i&&n<i}],"filter->":[dn,[fn,yn],(e,[t,n])=>{const i=e.properties()[t.value],s=n.value;return typeof i==typeof s&&i>s}],"filter-id->":[dn,[yn],(e,[t])=>{const n=e.id(),i=t.value;return typeof n==typeof i&&n>i}],"filter-<=":[dn,[fn,yn],(e,[t,n])=>{const i=e.properties()[t.value],s=n.value;return typeof i==typeof s&&i<=s}],"filter-id-<=":[dn,[yn],(e,[t])=>{const n=e.id(),i=t.value;return typeof n==typeof i&&n<=i}],"filter->=":[dn,[fn,yn],(e,[t,n])=>{const i=e.properties()[t.value],s=n.value;return typeof i==typeof s&&i>=s}],"filter-id->=":[dn,[yn],(e,[t])=>{const n=e.id(),i=t.value;return typeof n==typeof i&&n>=i}],"filter-has":[dn,[yn],(e,[t])=>t.value in e.properties()],"filter-has-id":[dn,[],e=>null!==e.id()&&void 0!==e.id()],"filter-type-in":[dn,[Mn(fn)],(e,[t])=>t.value.indexOf(e.geometryType())>=0],"filter-id-in":[dn,[Mn(yn)],(e,[t])=>t.value.indexOf(e.id())>=0],"filter-in-small":[dn,[fn,Mn(yn)],(e,[t,n])=>n.value.indexOf(e.properties()[t.value])>=0],"filter-in-large":[dn,[fn,Mn(yn)],(e,[t,n])=>function(e,t,n,i){for(;n<=i;){const s=n+i>>1;if(t[s]===e)return!0;t[s]>e?i=s-1:n=s+1}return!1}(e.properties()[t.value],n.value,0,n.value.length-1)],all:{type:dn,overloads:[[[dn,dn],(e,[t,n])=>t.evaluate(e)&&n.evaluate(e)],[Yi(dn),(e,t)=>{for(const n of t)if(!n.evaluate(e))return!1;return!0}]]},any:{type:dn,overloads:[[[dn,dn],(e,[t,n])=>t.evaluate(e)||n.evaluate(e)],[Yi(dn),(e,t)=>{for(const n of t)if(n.evaluate(e))return!0;return!1}]]},"!":[dn,[dn],(e,[t])=>!t.evaluate(e)],"is-supported-script":[dn,[fn],(e,[t])=>{const n=e.globals&&e.globals.isSupportedScript;return!n||n(t.evaluate(e))}],upcase:[fn,[fn],(e,[t])=>t.evaluate(e).toUpperCase()],downcase:[fn,[fn],(e,[t])=>t.evaluate(e).toLowerCase()],concat:[fn,Yi(yn),(e,t)=>t.map((t=>qn(t.evaluate(e)))).join("")],"resolved-locale":[fn,[vn],(e,[t])=>t.evaluate(e).resolvedLocale()]});var Ji=Ui;function Qi(e){return{result:"success",value:e}}function $i(e){return{result:"error",value:e}}function Ki(e){return!!e.expression&&e.expression.interpolated}function ns(e){return e instanceof Number?"number":e instanceof String?"string":e instanceof Boolean?"boolean":Array.isArray(e)?"array":null===e?"null":typeof e}function rs(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function is(e){return e}function ss(e,t){const n="color"===t.type,i=e.stops&&"object"==typeof e.stops[0][0],s=i||!(i||void 0!==e.property),o=e.type||(Ki(t)?"exponential":"interval");if(n&&((e=tn({},e)).stops&&(e.stops=e.stops.map((e=>[e[0],Un.parse(e[1])]))),e.default=Un.parse(e.default?e.default:t.default)),e.colorSpace&&"rgb"!==e.colorSpace&&!mi[e.colorSpace])throw new Error(`Unknown color space: ${e.colorSpace}`);let a,l,h;if("exponential"===o)a=ds;else if("interval"===o)a=fs;else if("categorical"===o){a=hs,l=Object.create(null);for(const t of e.stops)l[t[0]]=t[1];h=typeof e.stops[0][0]}else{if("identity"!==o)throw new Error(`Unknown function type "${o}"`);a=ps}if(i){const n={},i=[];for(let t=0;t<e.stops.length;t++){const s=e.stops[t],o=s[0].zoom;void 0===n[o]&&(n[o]={zoom:o,type:e.type,property:e.property,default:e.default,stops:[]},i.push(o)),n[o].stops.push([s[0].value,s[1]])}const s=[];for(const e of i)s.push([n[e].zoom,ss(n[e],t)]);const o={name:"linear"};return{kind:"composite",interpolationType:o,interpolationFactor:yi.interpolationFactor.bind(void 0,o),zoomStops:s.map((e=>e[0])),evaluate:({zoom:n},i)=>ds({stops:s,base:e.base},t,n).evaluate(n,i)}}if(s){const n="exponential"===o?{name:"exponential",base:void 0!==e.base?e.base:1}:null;return{kind:"camera",interpolationType:n,interpolationFactor:yi.interpolationFactor.bind(void 0,n),zoomStops:e.stops.map((e=>e[0])),evaluate:({zoom:n})=>a(e,t,n,l,h)}}return{kind:"source",evaluate(n,i){const s=i&&i.properties?i.properties[e.property]:void 0;return void 0===s?ls(e.default,t.default):a(e,t,s,l,h)}}}function ls(e,t,n){return void 0!==e?e:void 0!==t?t:void 0!==n?n:void 0}function hs(e,t,n,i,s){return ls(typeof n===s?i[n]:void 0,e.default,t.default)}function fs(e,t,n){if("number"!==ns(n))return ls(e.default,t.default);const i=e.stops.length;if(1===i)return e.stops[0][1];if(n<=e.stops[0][0])return e.stops[0][1];if(n>=e.stops[i-1][0])return e.stops[i-1][1];const s=Hr(e.stops.map((e=>e[0])),n);return e.stops[s][1]}function ds(e,t,n){const i=void 0!==e.base?e.base:1;if("number"!==ns(n))return ls(e.default,t.default);const s=e.stops.length;if(1===s)return e.stops[0][1];if(n<=e.stops[0][0])return e.stops[0][1];if(n>=e.stops[s-1][0])return e.stops[s-1][1];const o=Hr(e.stops.map((e=>e[0])),n),a=function(e,t,n,i){const s=i-n,o=e-n;return 0===s?0:1===t?o/s:(Math.pow(t,o)-1)/(Math.pow(t,s)-1)}(n,i,e.stops[o][0],e.stops[o+1][0]),l=e.stops[o][1],h=e.stops[o+1][1];let c=jr[t.type]||is;if(e.colorSpace&&"rgb"!==e.colorSpace){const t=mi[e.colorSpace];c=(e,n)=>t.reverse(t.interpolate(t.forward(e),t.forward(n),a))}return"function"==typeof l.evaluate?{evaluate(...e){const t=l.evaluate.apply(void 0,e),n=h.evaluate.apply(void 0,e);if(void 0!==t&&void 0!==n)return c(t,n,a)}}:c(l,h,a)}function ps(e,t,n){return"color"===t.type?n=Un.parse(n):"formatted"===t.type?n=hn.fromString(n.toString()):"resolvedImage"===t.type?n=cn.fromString(n.toString()):ns(n)===t.type||"enum"===t.type&&t.values[n]||(n=void 0),ls(n,e.default,t.default)}class br{constructor(e,t){this.expression=e,this._warningHistory={},this._evaluator=new sr,this._defaultValue=t?function(e){return"color"===e.type&&(rs(e.default)||Array.isArray(e.default))?new Un(0,0,0,0):"color"===e.type?Un.parse(e.default)||null:void 0===e.default?null:e.default}(t):null,this._enumValues=t&&"enum"===t.type?t.values:null}evaluateWithoutErrorHandling(e,t,n,i,s,o,a,l){return this._evaluator.globals=e,this._evaluator.feature=t,this._evaluator.featureState=n,this._evaluator.canonical=i||null,this._evaluator.availableImages=s||null,this._evaluator.formattedSection=o,this._evaluator.featureTileCoord=a||null,this._evaluator.featureDistanceData=l||null,this.expression.evaluate(this._evaluator)}evaluate(e,t,n,i,s,o,a,l){this._evaluator.globals=e,this._evaluator.feature=t||null,this._evaluator.featureState=n||null,this._evaluator.canonical=i||null,this._evaluator.availableImages=s||null,this._evaluator.formattedSection=o||null,this._evaluator.featureTileCoord=a||null,this._evaluator.featureDistanceData=l||null;try{const e=this.expression.evaluate(this._evaluator);if(null==e||"number"==typeof e&&e!=e)return this._defaultValue;if(this._enumValues&&!(e in this._enumValues))throw new Xn(`Expected value to be one of ${Object.keys(this._enumValues).map((e=>JSON.stringify(e))).join(", ")}, but found ${JSON.stringify(e)} instead.`);return e}catch(e){return this._warningHistory[e.message]||(this._warningHistory[e.message]=!0,"undefined"!=typeof console&&console.warn(e.message)),this._defaultValue}}}function As(e){return Array.isArray(e)&&e.length>0&&"string"==typeof e[0]&&e[0]in Ji}function ys(e,t){const n=new Dr(Ji,[],t?function(e){const t={color:pn,string:fn,number:un,enum:fn,boolean:dn,formatted:bn,resolvedImage:wn};return"array"===e.type?Mn(t[e.value]||yn,e.length):t[e.type]}(t):void 0),i=n.parse(e,void 0,void 0,void 0,t&&"string"===t.type?{typeAnnotation:"coerce"}:void 0);return i?Qi(new br(i,t)):$i(n.errors)}class Pr{constructor(e,t){this.kind=e,this._styleExpression=t,this.isStateDependent="constant"!==e&&!Er(t.expression)}evaluateWithoutErrorHandling(e,t,n,i,s,o){return this._styleExpression.evaluateWithoutErrorHandling(e,t,n,i,s,o)}evaluate(e,t,n,i,s,o){return this._styleExpression.evaluate(e,t,n,i,s,o)}}class Mr{constructor(e,t,n,i){this.kind=e,this.zoomStops=n,this._styleExpression=t,this.isStateDependent="camera"!==e&&!Er(t.expression),this.interpolationType=i}evaluateWithoutErrorHandling(e,t,n,i,s,o){return this._styleExpression.evaluateWithoutErrorHandling(e,t,n,i,s,o)}evaluate(e,t,n,i,s,o){return this._styleExpression.evaluate(e,t,n,i,s,o)}interpolationFactor(e,t,n){return this.interpolationType?yi.interpolationFactor(this.interpolationType,e,t,n):0}}function _s(e,t){if("error"===(e=ys(e,t)).result)return e;const n=e.value.expression,i=kr(n);if(!i&&!function(e){return"data-driven"===e["property-type"]}(t))return $i([new nn("","data expressions not supported")]);const s=Rr(n,["zoom","pitch","distance-from-center"]);if(!s&&!function(e){return!!e.expression&&e.expression.parameters.indexOf("zoom")>-1}(t))return $i([new nn("","zoom expressions not supported")]);const o=vs(n);if(!o&&!s)return $i([new nn("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')]);if(o instanceof nn)return $i([o]);if(o instanceof yi&&!Ki(t))return $i([new nn("",'"interpolate" expressions cannot be used with this property')]);if(!o)return Qi(new Pr(i?"constant":"source",e.value));return Qi(new Mr(i?"camera":"composite",e.value,o.labels,o instanceof yi?o.interpolation:void 0))}class Cr{constructor(e,t){this._parameters=e,this._specification=t,tn(this,ss(this._parameters,this._specification))}static deserialize(e){return new Cr(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function vs(e){let t=null;if(e instanceof vi)t=vs(e.result);else if(e instanceof _i){for(const n of e.args)if(t=vs(n),t)break}else(e instanceof Nr||e instanceof yi)&&e.input instanceof or&&"zoom"===e.input.name&&(t=e);return t instanceof nn||e.eachChild((e=>{const n=vs(e);n instanceof nn?t=n:!t&&n?t=new nn("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):t&&n&&t!==n&&(t=new nn("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),t}function xs(e){if(Array.isArray(e))return e.map(xs);if(e instanceof Object&&!(e instanceof Number||e instanceof String||e instanceof Boolean)){const t={};for(const n in e)t[n]=xs(e[n]);return t}return function(e){return e instanceof Number||e instanceof String||e instanceof Boolean?e.valueOf():e}(e)}function ws(e,t="fill"){if(null==e)return{filter:()=>!0,needGeometry:!1,needFeature:!1};const n=e;let i=!0;try{i=function(e){if(!Cs(e))return e;let t=xs(e);return Ms(t),t=Ss(t),t}(n)}catch(e){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(n,null,2)}\n        `)}const s=ys(i,null);let o=null;if("error"===s.result)throw new Error(s.value.map((e=>`${e.key}: ${e.message}`)).join(", "));o=(e,t,n)=>s.value.evaluate(e,t,{},n);let a=null,l=null;if(i!==n){const e=ys(n,null);if("error"===e.result)throw new Error(e.value.map((e=>`${e.key}: ${e.message}`)).join(", "));a=(t,n,i,s,o)=>e.value.evaluate(t,n,{},i,void 0,void 0,s,o),l=!kr(e.value.expression)}return{filter:o,dynamicFilter:a||void 0,needGeometry:Is(i),needFeature:!!l}}function Ss(e){if(!Array.isArray(e))return e;const t=function(e){if(Ps.has(e[0]))for(let t=1;t<e.length;t++)if(Cs(e[t]))return!0;return e}(e);return!0===t?t:t.map((e=>Ss(e)))}function Ms(e){let t=!1;const n=[];if("case"===e[0]){for(let i=1;i<e.length-1;i+=2)t=t||Cs(e[i]),n.push(e[i+1]);n.push(e[e.length-1])}else if("match"===e[0]){t=t||Cs(e[1]);for(let t=2;t<e.length-1;t+=2)n.push(e[t+1]);n.push(e[e.length-1])}else if("step"===e[0]){t=t||Cs(e[1]);for(let t=1;t<e.length-1;t+=2)n.push(e[t+1])}t&&(e.length=0,e.push("any",...n));for(let t=1;t<e.length;t++)Ms(e[t])}function Cs(e){if(!Array.isArray(e))return!1;if(function(e){return"pitch"===e||"distance-from-center"===e}(e[0]))return!0;for(let t=1;t<e.length;t++)if(Cs(e[t]))return!0;return!1}const Ps=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Is(e){if(!Array.isArray(e))return!1;if("within"===e[0])return!0;for(let t=1;t<e.length;t++)if(Is(e[t]))return!0;return!1}const ks={StyleExpression:br,isExpression:As,isExpressionFilter:function e(t){if(!0===t||!1===t)return!0;if(!Array.isArray(t)||0===t.length)return!1;switch(t[0]){case"has":return t.length>=2&&"$id"!==t[1]&&"$type"!==t[1];case"in":return t.length>=3&&("string"!=typeof t[1]||Array.isArray(t[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==t.length||Array.isArray(t[1])||Array.isArray(t[2]);case"any":case"all":for(const n of t.slice(1))if(!e(n)&&"boolean"!=typeof n)return!1;return!0;default:return!0}},createExpression:ys,createPropertyExpression:_s,normalizePropertyExpression:function(e,t){if(rs(e))return new Cr(e,t);if(As(e)){const n=_s(e,t);if("error"===n.result)throw new Error(n.value.map((e=>`${e.key}: ${e.message}`)).join(", "));return n.value}{let n=e;return"string"==typeof e&&"color"===t.type&&(n=Un.parse(e)),{kind:"constant",evaluate:()=>n}}},ZoomConstantExpression:Pr,ZoomDependentExpression:Mr,StylePropertyFunction:Cr},{isExpression:Os,createExpression:Es}=ks,Rs={};function Ds(e){if(!Array.isArray(e))return Ds([e]);const t=[];for(let n=0;n<e.length;n++){let i;i=!0===e[n].filter?function(){return!0}:Fs(e[n].filter),t.push(ut({},e[n],{filter:i}))}return t}function Fs(e){if(!0===e)return function(){return!0};if(e&&e.condition){if("any"===e.type){const t=e.condition,n=[];for(let e=0;e<t.length;e++)n.push(Fs(t[e]));return(e,t)=>{for(let i=0;i<n.length;i++)if(n[i](e,t))return!0;return!1}}const t=Fs(e.condition);if(pt(e.layer))return t;const n=t=>t.layer===e.layer;return(e,i)=>n(e)&&t(e,i)}if(zt(e))return new Function("f",`var p = (f && f.properties || {}); return ${Ut(e)}`);{let t=ws(e);t=t&&t.filter;const n=(e,n)=>(Rs.zoom=n,t&&t(Rs,e));return n}}const Bs={type:"number","property-type":"data-driven",expression:{parameters:["zoom","feature"]}};function zs(e,t){Bs.type=t||"number";const n=Es(e,Bs);if("success"!==n.result)throw new Error(`Invalid maplibre spec expression: ${JSON.stringify(e)} (${n.value})`);return n.value}function Gs(e){return Os(e)}const Us={lineWidth:1,lineStrokeWidth:1,lineDx:1,lineDy:1,lineOpacity:1,linePatternAnimSpeed:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerSpacing:1,markerOpacity:1,markerRotation:1,textWrapWidth:1,textSpacing:1,textSize:1,textHaloRadius:1,textHaloOpacity:1,textDx:1,textDy:1,textOpacity:1,textRotation:1,polygonOpacity:1};function Vs(e){return Us[e]}const js={markerPlacement:1,markerFile:1,mergeOnProperty:1,markerTextFit:1,markerType:1,markerHorizontalAlignment:1,markerVerticalAlignment:1,markerRotationAlignment:1,markerPitchAlignment:1,markerFillPatternFile:1,markerLinePatternFile:1,textName:1,textPlacement:1,textFaceName:1,textStyle:1,textHorizontalAlignment:1,textVerticalAlignment:1,textRotationAlignment:1,textPitchAlignment:1,lineJoin:1,lineCap:1,linePatternFile:1,polygonPatternFile:1},qs={lineDasharray:1,markerLineDasharray:1,uvScale:1,uvOffset:1};function Zs(e){return js[e]?"string":Vs(e)?"number":qs[e]?"array":"color"}var Xs=Object.freeze({__proto__:null,compileFilter:Fs,compileStyle:function(e=[]){return Ds(e=e.map((e=>{const t=ut({},e);return t.filter&&t.filter.value&&(t.filter=t.filter.value),t})))},createExpression:zs,getExpressionType:Zs,isExpression:Gs,isInterpolated:Vs});const Ys="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,Qs=function(e){return class extends e{pushIn(...e){const t=e.length;for(let n=0;n<t;n++)this[this.currentIndex++]=e[n]}fill(e,t,n){super.fill(e,t,n),n>this.currentIndex&&(this.currentIndex=n)}set(e,t){e>=this.currentIndex&&(this.currentIndex=e+1),this[e]=t}getLength(){return this.currentIndex}setLength(e){this.currentIndex=e,super.length<e&&(super.length=e)}trySetLength(e){e>this.currentIndex&&this.setLength(e)}reset(){this.currentIndex=0}slice(e,t){const n=super.slice(e,t);return n.currentIndex=t-e,n}}},Ks=Qs(Array),eo={get:function(e,t){return"length"===t?e.getLength():e[t]}};class io extends Array{setLength(e){this.length=e,this.currentIndex=e}trySetLength(e){this.length=e,this.currentIndex=e}getLength(){return this.length}}let to;class oo{static createTypedArray(e,t){return X(e,t)}static getInstance(){return to}static ensureCapacity(e,t){if(!e.BYTES_PER_ELEMENT)return e;if(e.length>=t)return e;const n=new e.constructor(t+Math.ceil(.5*t)),i=e.getLength();for(let t=0;t<i;t++)n[t]=e[t];return n.currentIndex=e.currentIndex,n}static getArray(e){let t;if(e){const n=Qs(e);t=new n(1048576/n.BYTES_PER_ELEMENT)}else t=new Ks;return t.push=(...e)=>{t.pushIn(...e)},t}static getProxyArray(){const e=new Ks,t=new Proxy(e,eo);return t.push=(...t)=>{e.pushIn(...t)},t._origin=e,t}constructor(){this._arrays=[],this._index=0,this._proxiedArrays=[],this._proxiedIndex=0,this._typedArrays={}}getProxy(){if(!Ys){const e=new io;return e.currentIndex=0,e}const e=this._proxiedArrays[this._proxiedIndex]=this._proxiedArrays[this._proxiedIndex]||oo.getProxyArray();return e.reset(),this._proxiedIndex++,e}get(e){if(!Ys){const e=new io;return e.currentIndex=0,e}if(e){const t=e.name;let n=this._typedArrays[t];n||(n=this._typedArrays[t]={arrays:[],index:0});const i=n.index,s=n.arrays[i]=n.arrays[i]||oo.getArray(e);return s.reset(),n.index++,s}const t=this._arrays[this._index]=this._arrays[this._index]||oo.getArray();return t.reset(),this._index++,t}reset(){this._index=0,this._proxiedIndex=0;for(const e in this._typedArrays)this._typedArrays[e].index=0}}to=new oo;const no="__fea_idx",ro=[],so={},ao={},lo={},ho=[],co=oo.getInstance();let uo=!1;const fo=Math.pow(2,17);class mo{static isAtlasLoaded(e,t={}){const{iconAtlas:n}=t;return!!(!e||n&&n.positions[e])}static genFnTypes(e){const t={};for(const n in e)if(Gs(e[n])){const i=(n+"_Fn_0").trim(),s=(n+"Fn").trim(),o=Zs(n);t[i]=zs(e[n],o),t[s]=(e,n)=>{let s;so.zoom=e,ao.properties=n;try{s=t[i].evaluateWithoutErrorHandling(so,ao,lo,null,ho)}catch(e){return null}return s}}else if(wt(e[n])){const i=(n+"_Fn_0").trim(),s=(n+"Fn").trim();Vs(n)?(t[i]=_e(e[n]),t[s]=(e,n)=>{const s=t[i](e,n);return wt(s)?_e(s)(e,n):s}):(t[i]=ve(e[n]),t[s]=(e,n)=>{const s=t[i](e,n);return wt(s)?ve(s)(e,n):s})}return t}constructor(e,t,n){this.options=n;const i=[];this.symbolDef=t,this.symbol=xe(t,(()=>(i[0]=n.zoom,i))),this.styledVectors=[],this.properties={},this._fnTypes=n.fnTypes||mo.genFnTypes(this.symbolDef),wt(this.symbolDef.visible)&&(this._visibleFn=_e(this.symbolDef.visible)),n.atlas&&(this.iconAtlas=n.atlas.iconAtlas,this.glyphAtlas=n.atlas.glyphAtlas),this.maxAltitude=0,this.features=this._check(e)}needAltitudeAttribute(){const e=Math.max(Math.abs(this.maxPosZ),Math.abs(this.minPosZ));return this.options.forceAltitudeAttribute||e>=fo||this.options.positionType===Float32Array}getPositionFormat(){return this.needAltitudeAttribute()?[{type:Int16Array,width:2,name:"aPosition"},{type:Float32Array,width:1,name:"aAltitude"}]:[{type:Float32Array,width:3,name:"aPosition"}]}fillPosition(e,t,n,i){if(t<this._minX&&(this._minX=t),t>this._maxX&&(this._maxX=t),n<this._minY&&(this._minY=n),n>this._maxY&&(this._maxY=n),this.needAltitudeAttribute()){let s=e.aPosition.currentIndex;e.aPosition[s++]=t,e.aPosition[s++]=n,e.aPosition.currentIndex=s,s=e.aAltitude.currentIndex,e.aAltitude[s++]=i,e.aAltitude.currentIndex=s}else{Dt(ro,t,n,i);let s=e.aPosition.currentIndex;e.aPosition[s++]=ro[0],e.aPosition[s++]=ro[1],e.aPosition[s++]=ro[2],e.aPosition.currentIndex=s}}_check(e){if(!e.length)return e;const t=(no+"").trim();let n,i=0,s=e[i];for(;!s.geometry;)i++,s=e[i];if(Array.isArray(s.geometry)&&s.properties){let t=s.geometry[0];for(;Array.isArray(t);)t=t[0];t&&!pt(t.x)&&(n=e)}if(!n)if(n=[],Array.isArray(s.geometry))for(let t=0;t<e.length;t++){const i=ut({},e[t]);n.push(Y(i))}else for(let i=0;i<e.length;i++){const s=e[i],o=l(s);for(let e=0;e<o.length;e++){const i=o[e];i[t]=s[t],n.push(i)}}if(this.options.altitudeProperty)for(let e=0;e<n.length;e++){const t=n[e];if(!t||!t.geometry||1!==t.type&&4!==t.type)continue;const i=this.getAltitude(t.properties);if(i)for(let e=0;e<t.geometry.length;e++){const n=t.geometry[e];if(n&&n.length)for(let e=0;e<n.length;e++)n[e].z=(n[e].z||0)+i}}if(this.maxPosZ=0,this.minPosZ=0,!this.options.forceAltitudeAttribute){const e="line"===this.symbolDef.textPlacement;let t=-1/0,i=1/0,s=!1;const{textPitchAlignmentFn:o}=this._fnTypes;!o&&e&&"map"===this.symbolDef.textPitchAlignment&&(s=!0);const a=[];for(let l=0;l<n.length;l++){const[h,c]=go(a,n[l]&&n[l].geometry);if(c>t&&(t=c),h<i&&(i=h),e&&!s&&o&&n[l].properties){const e=o(null,n[l].properties);"map"===e&&(s=e)}}this.hasMapPitchAlign=s,this.maxPosZ=t===-1/0?0:t,this.minPosZ=i===1/0?0:i}const o=this.options.order;if(o){const e=[];for(let t=0;t<o.length;t++)o[t]&&e.push(Fs(o[t]));n=n.sort(((t,n)=>{const i=e.length;let s=-1,o=-1;for(let a=0;a<i&&(e[a](t)&&(s=a),e[a](n)&&(o=a),!(s>=0&&s<i&&o>=0&&o<i));a++);return s-o}))}return n}load(e=1){const t=(no+"").trim(),n="_debug_info".trim(),i=this._fnTypes,s=this.styledVectors;this.count=0;const o=this.features;if(!o||!o.length)return Promise.resolve(null);const a={},l={},h={zoom:this.options.zoom,isVector3D:!!this.options.center},c=[],u=xe(this.symbolDef,(()=>(c[0]=h.zoom,c)));let f=0,g=o.length;const m=this.options.debugIndex;try{for(;f<g;f++){const e=o[f];if(!e||!e.geometry)continue;if(gt(m)&&e[n].index!==m)continue;e.properties||(e.properties={}),e.properties.$layer=e.layer,e.properties.$type=e.type;const c=this.createStyledVector(e,u,i,h,a,l);c&&c.feature.geometry&&(c.featureIdx=void 0===e[t]?f:e[t],this.count++,s.push(c))}}catch(e){return Promise.reject(e)}return this.options.atlas?Promise.resolve(this.pack(e)):this.loadAtlas(a,l).then((()=>this.pack(e)))}loadAtlas(e,t){return new Promise(((n,i)=>{this.fetchAtlas(e,t,((e,t)=>{if(e)i(e);else{if(t){const{icons:e,glyphs:n}=t;if(e&&Object.keys(e).length){for(const t in e){const n=e[t],{width:i,height:s,data:o}=n.data;n.data=new v({width:i,height:s},o)}this.iconAtlas=new k(e)}if(n&&Object.keys(n).length){for(const e in n){const t=n[e];for(const e in t){const n=t[e],{width:i,height:s,data:o}=n.bitmap;n.bitmap=new _({width:i,height:s},o)}}this.glyphAtlas=new F(n)}}n({glyphAtlas:this.glyphAtlas,iconAtlas:this.iconAtlas})}}))}))}fetchAtlas(e,t,n){Object.keys(e).length>0||Object.keys(t).length>0?this.options.requestor(e,t,n):n()}pack(e){if(!this.count)return null;if(null==e)throw new Error("layout scale is undefined");const t=this.createDataPack(this.styledVectors,e);if(!t)return null;this.properties.minAltitude=this.minPosZ/100,this.properties.maxAltitude=this.maxPosZ/100,t.properties=this.properties,this.empty&&(t.empty=!0);const n=t.buffers;delete t.buffers;const i={data:t,buffers:n};if(this.iconAtlas){const e=i.data.iconAtlas=po(this.iconAtlas);if(e.glyphMap)for(const t in e.glyphMap){n.push(e.glyphMap[t].data.data.buffer)}n.push(i.data.iconAtlas.image.data.buffer)}return this.glyphAtlas&&(i.data.glyphAtlas=po(this.glyphAtlas),n.push(i.data.glyphAtlas.image.data.buffer)),i}createStyledVector(e,t,n,i){return new dt(e,t,n,i)}createDataPack(e,t){if(!e||!e.length)return null;this.maxIndex=0,this.maxPos=0,this._minX=this._minY=1/0,this._maxX=this._maxY=-1/0,this.dynamicAttrs={};const n=this.data={};this._arrayPool=co,co.reset();let i=this.elements=co.get();const s=this._dataFormat=this.getFormat(Array.isArray(e[0])?e[0][0].symbol:e[0].symbol),o=this.needAltitudeAttribute()?2:3;for(let e=0;e<s.length;e++)n[s[e].name]=co.get(s[e].type);let a=co.get(),l=0;const h=co.get();let c=0,u=!1,f=!0;const g=new Set;for(let i=0,s=e.length;i<s;i++){if(!e[i].feature.geometry)continue;const s=Array.isArray(e[i])?e[i][0].feature.id:e[i].feature.id;f&&(void 0!==ao.id?g&&(g.has(ao.id)?f=!1:g.add(ao.id)):f=!1),gt(s)&&(Math.abs(s)>c&&(c=Math.abs(s)),s<0&&(u=!0));const m=this.data.aPosition.getLength();if(Array.isArray(e[i]))for(let n=0;n<e[i].length;n++)this._placeVector(e[i][n],t);else this._placeVector(e[i],t);const A=(n.aPosition.getLength()-m)/o;for(let t=0;t<A;t++)a.push(e[i].featureIdx),gt(s)&&h.push(s);l=Math.max(l,e[i].featureIdx)}if(this.countOutOfAngle>0&&!uo&&(uo=!0,console.warn("text anchor along line is ignored as anchor's line angle is bigger than textMaxAngle.")),this.hasElements()&&!i.getLength())return null;const m=this.options.center?Float32Array:Z(l);a=oo.createTypedArray(a,m),s[0].type=this.options.positionType?this.options.positionType:q(this.maxPos);const A=this.options.center;if(A&&(A[0]||A[1])){const e=n.aPosition,t=e.getLength();for(let n=0;n<t;n+=o)e[n]-=A[0],e[n+1]-=A[1]}const w=function(e,t){const n={};for(let i=0;i<e.length;i++){const s=e[i],o=s.type,a=s.name;n[a]=o===Array?t[a]:X(t[a],o)}return n}(s,n);w.aPickingId=a;const T=[];for(const e in w)T.push(w[e].buffer);const S=W(this.maxIndex);i=oo.createTypedArray(i,S),T.push(i.buffer);const M={data:w,isIdUnique:f,is2D:0===this.maxPosZ&&0===this.minPosZ,indices:this.hasElements()?i:null,positionSize:o,positionBounding:[this._minX,this._minY,this._maxX,this._maxY],buffers:T,symbolIndex:this.symbolDef.index||{index:0},dynamicAttributes:this.dynamicAttrs};if(this._packMarkerPlacement&&(M.markerPlacement=this._packMarkerPlacement),this._packTextPlacement&&(M.textPlacement=this._packTextPlacement),h.getLength()){const e=u?q(c):Z(c);M.featureIds=oo.createTypedArray(h,e),T.push(M.featureIds.buffer)}else M.featureIds=[];return M.pickingIdIndiceMap=z(a,M.indices),M}_placeVector(e,t){this._visibleFn&&!this._visibleFn(this.options.zoom,e.feature.properties)||this.placeVector(e,t,this.formatWidth)}addElements(e,t,n){this.maxIndex=Math.max(this.maxIndex,e,t,n);let i=this.elements.currentIndex;this.elements[i++]=e,this.elements[i++]=t,this.elements[i++]=n,this.elements.currentIndex=i}hasElements(){return!0}getAltitude(e){const{altitudeProperty:t,defaultAltitude:n,altitudeScale:i}=this.options;let s=E(e,t,n);return i&&(s*=i),this.maxAltitude=Math.max(this.maxAltitude,Math.abs(s)),s}getIconAtlasMaxValue(){const e=this.iconAtlas.positions;let t=0;for(const n in e)if(xt(e,n)){const{tl:i,displaySize:s}=e[n],o=Math.max(i[0],i[1],s[0]-1,s[1]-1);o>t&&(t=o)}return t}ensureDataCapacity(e,t){const n=this._dataFormat;for(let i=0;i<n.length;i++){const s=this.data[n[i].name];if(!s)continue;const o=n[i].width*e,a=s.getLength();this.data[n[i].name]=oo.ensureCapacity(s,a+o*t)}}}function po(e){let t=e.positions,n=e.image&&e.image.format||"alpha";if(e instanceof k){t={};for(const n in e.positions){const i=e.positions[n];t[n]={paddedRect:i.paddedRect,pixelRatio:i.pixelRatio,tl:i.tl,br:i.br,displaySize:i.displaySize}}n="rgba"}const i=e.image;return{image:{width:i.width,height:i.height,data:i.data,format:n},glyphMap:e.glyphMap,positions:t}}function go(e,t){if(!t)return 0;let n=-1/0,i=1/0;const s=[];if(Array.isArray(t))for(let e=0;e<t.length;e++)if(Array.isArray(t[e])){const[o,a]=go(s,t[e]);a>n&&(n=a),o<i&&(i=o)}else{const s=Math.abs(t[e].z||0);s>n&&(n=s),s<i&&(i=s)}else{const e=Math.abs(t.z||0);e>n&&(n=e),e<i&&(i=e)}return e[0]=i,e[1]=n,e}const Ao="___fn_in_stops";function yo(e,t,n,i){const s="__fn_textSize".trim();let o=e.textSize;if(pt(t.textSize))return[16,16];e[s]&&(o=e[s]);const a=[];if(a[0]=yt(o)?o(i,n):o,ye(a[0])){const t=a[0].__fn_key=a[0].__fn_key||JSON.stringify(a[0]);e[Ao]||(e[Ao]={}),e[Ao][t]||(e[Ao][t]=_e(a[0]));a[0]=(0,e[Ao][t])(i,n)}return a[1]=a[0],a}function _o(e){const t=e.stops;let n=-1/0;for(let e=0;e<t.length;e++){let i=t[e][1];mt(t[e][1])&&(i=_o(t[e][1])),i>n&&(n=i)}return n}const vo=["{","}"],xo="";function bo(e){return e||"Open Sans Regular"}const wo=/\{[\w-]+(?:\|[\w-]+)*\}/g;function To(e,t){if(!At(e))return e;function n(e){if(!t)return xo;const n=t[e];return pt(n)?xo:Array.isArray(n)?n.join():n}const[i,s]=vo,o=So(e);for(let t=0,a=o.length;t<a;t++){const a=o[t],l=`${i}${a}${s}`;if(a.indexOf("|")>0){const t=a.split("|");let i=!1;for(let s=0;s<t.length;s++){const o=n(t[s]);if(o!==xo){e=Mo(e,l,o),i=!0;break}}i||(e=Mo(e,l,xo))}else e=Mo(e,l,n(a))}return e}function So(e){e+=xo;const[t,n]=vo,i=[];let s=!1,o=xo;for(let a=0,l=e.length;a<l;a++){const l=e[a];s||l!==t||(s=!0),l===t&&s&&(o=xo),s&&l!==t&&l!==n&&(o+=l),l===n&&o&&(s=!1,i.push(o),o=xo)}return i}function Mo(e,t,n){if(!e)return e;if(e.replaceAll)return e.replaceAll(t,n);for(;e.indexOf(t)>-1;)e=e.replace(t,n);return e}var Co=Object.freeze({__proto__:null,EMPTY_STRING:xo,getSDFFont:bo,replaceAll:Mo,resolveExpVarNames:function e(t,n){if(2!==n.length||"get"!==n[0])for(let i=0;i<n.length;i++)2===n[i].length&&"get"===n[i][0]?t.push(n[i][1]):Array.isArray(n[i])&&e(t,n[i]);else t.push(n[1])},resolveText:To,resolveText_bak:function(e,t){return At(e)?e.replace(wo,(function(e){if(!t)return"";if((e=e.substring(1,e.length-1)).indexOf("|")>0){const n=e.split("|");for(let e=0;e<n.length;e++){const i=t[n[e]];if(!pt(i))return i}return""}const n=t[e];return pt(n)?"":Array.isArray(n)?n.join():n})):e},resolveVarNames:function(e){return e.match(wo)},templateKeys:So});const Po={"Latin-1 Supplement":e=>e>=128&&e<=255,Arabic:e=>e>=1536&&e<=1791,"Arabic Supplement":e=>e>=1872&&e<=1919,"Arabic Extended-A":e=>e>=2208&&e<=2303,"Hangul Jamo":e=>e>=4352&&e<=4607,"Unified Canadian Aboriginal Syllabics":e=>e>=5120&&e<=5759,Khmer:e=>e>=6016&&e<=6143,"Unified Canadian Aboriginal Syllabics Extended":e=>e>=6320&&e<=6399,"General Punctuation":e=>e>=8192&&e<=8303,"Letterlike Symbols":e=>e>=8448&&e<=8527,"Number Forms":e=>e>=8528&&e<=8591,"Miscellaneous Technical":e=>e>=8960&&e<=9215,"Control Pictures":e=>e>=9216&&e<=9279,"Optical Character Recognition":e=>e>=9280&&e<=9311,"Enclosed Alphanumerics":e=>e>=9312&&e<=9471,"Geometric Shapes":e=>e>=9632&&e<=9727,"Miscellaneous Symbols":e=>e>=9728&&e<=9983,"Miscellaneous Symbols and Arrows":e=>e>=11008&&e<=11263,"CJK Radicals Supplement":e=>e>=11904&&e<=12031,"Kangxi Radicals":e=>e>=12032&&e<=12255,"Ideographic Description Characters":e=>e>=12272&&e<=12287,"CJK Symbols and Punctuation":e=>e>=12288&&e<=12351,Hiragana:e=>e>=12352&&e<=12447,Katakana:e=>e>=12448&&e<=12543,Bopomofo:e=>e>=12544&&e<=12591,"Hangul Compatibility Jamo":e=>e>=12592&&e<=12687,Kanbun:e=>e>=12688&&e<=12703,"Bopomofo Extended":e=>e>=12704&&e<=12735,"CJK Strokes":e=>e>=12736&&e<=12783,"Katakana Phonetic Extensions":e=>e>=12784&&e<=12799,"Enclosed CJK Letters and Months":e=>e>=12800&&e<=13055,"CJK Compatibility":e=>e>=13056&&e<=13311,"CJK Unified Ideographs Extension A":e=>e>=13312&&e<=19903,"Yijing Hexagram Symbols":e=>e>=19904&&e<=19967,"CJK Unified Ideographs":e=>e>=19968&&e<=40959,"Yi Syllables":e=>e>=40960&&e<=42127,"Yi Radicals":e=>e>=42128&&e<=42191,"Hangul Jamo Extended-A":e=>e>=43360&&e<=43391,"Hangul Syllables":e=>e>=44032&&e<=55215,"Hangul Jamo Extended-B":e=>e>=55216&&e<=55295,"Private Use Area":e=>e>=57344&&e<=63743,"CJK Compatibility Ideographs":e=>e>=63744&&e<=64255,"Arabic Presentation Forms-A":e=>e>=64336&&e<=65023,"Vertical Forms":e=>e>=65040&&e<=65055,"CJK Compatibility Forms":e=>e>=65072&&e<=65103,"Small Form Variants":e=>e>=65104&&e<=65135,"Arabic Presentation Forms-B":e=>e>=65136&&e<=65279,"Halfwidth and Fullwidth Forms":e=>e>=65280&&e<=65519};function Io(e){return!(Po.Arabic(e)||Po["Arabic Supplement"](e)||Po["Arabic Extended-A"](e)||Po["Arabic Presentation Forms-A"](e)||Po["Arabic Presentation Forms-B"](e))}function ko(e){return!(e<11904||!(Po["Bopomofo Extended"](e)||Po.Bopomofo(e)||Po["CJK Compatibility Forms"](e)||Po["CJK Compatibility Ideographs"](e)||Po["CJK Compatibility"](e)||Po["CJK Radicals Supplement"](e)||Po["CJK Strokes"](e)||Po["CJK Symbols and Punctuation"](e)||Po["CJK Unified Ideographs Extension A"](e)||Po["CJK Unified Ideographs"](e)||Po["Enclosed CJK Letters and Months"](e)||Po["Halfwidth and Fullwidth Forms"](e)||Po.Hiragana(e)||Po["Ideographic Description Characters"](e)||Po["Kangxi Radicals"](e)||Po["Katakana Phonetic Extensions"](e)||Po.Katakana(e)||Po["Vertical Forms"](e)||Po["Yi Radicals"](e)||Po["Yi Syllables"](e)))}function Oo(e){return!(746!==e&&747!==e&&(e<4352||!(Po["Bopomofo Extended"](e)||Po.Bopomofo(e)||Po["CJK Compatibility Forms"](e)&&!(e>=65097&&e<=65103)||Po["CJK Compatibility Ideographs"](e)||Po["CJK Compatibility"](e)||Po["CJK Radicals Supplement"](e)||Po["CJK Strokes"](e)||!(!Po["CJK Symbols and Punctuation"](e)||e>=12296&&e<=12305||e>=12308&&e<=12319||12336===e)||Po["CJK Unified Ideographs Extension A"](e)||Po["CJK Unified Ideographs"](e)||Po["Enclosed CJK Letters and Months"](e)||Po["Hangul Compatibility Jamo"](e)||Po["Hangul Jamo Extended-A"](e)||Po["Hangul Jamo Extended-B"](e)||Po["Hangul Jamo"](e)||Po["Hangul Syllables"](e)||Po.Hiragana(e)||Po["Ideographic Description Characters"](e)||Po.Kanbun(e)||Po["Kangxi Radicals"](e)||Po["Katakana Phonetic Extensions"](e)||Po.Katakana(e)&&12540!==e||!(!Po["Halfwidth and Fullwidth Forms"](e)||65288===e||65289===e||65293===e||e>=65306&&e<=65310||65339===e||65341===e||65343===e||e>=65371&&e<=65503||65507===e||e>=65512&&e<=65519)||!(!Po["Small Form Variants"](e)||e>=65112&&e<=65118||e>=65123&&e<=65126)||Po["Unified Canadian Aboriginal Syllabics"](e)||Po["Unified Canadian Aboriginal Syllabics Extended"](e)||Po["Vertical Forms"](e)||Po["Yijing Hexagram Symbols"](e)||Po["Yi Syllables"](e)||Po["Yi Radicals"](e))))}function Ro(e){return!(Oo(e)||function(e){return!!(Po["Latin-1 Supplement"](e)&&(167===e||169===e||174===e||177===e||188===e||189===e||190===e||215===e||247===e)||Po["General Punctuation"](e)&&(8214===e||8224===e||8225===e||8240===e||8241===e||8251===e||8252===e||8258===e||8263===e||8264===e||8265===e||8273===e)||Po["Letterlike Symbols"](e)||Po["Number Forms"](e)||Po["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||9003===e||e>=9085&&e<=9114||e>=9150&&e<=9165||9167===e||e>=9169&&e<=9179||e>=9186&&e<=9215)||Po["Control Pictures"](e)&&9251!==e||Po["Optical Character Recognition"](e)||Po["Enclosed Alphanumerics"](e)||Po["Geometric Shapes"](e)||Po["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Po["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Po["CJK Symbols and Punctuation"](e)||Po.Katakana(e)||Po["Private Use Area"](e)||Po["CJK Compatibility Forms"](e)||Po["Small Form Variants"](e)||Po["Halfwidth and Fullwidth Forms"](e)||8734===e||8756===e||8757===e||e>=9984&&e<=10087||e>=10102&&e<=10131||65532===e||65533===e)}(e))}function Lo(e){return e>=1424&&e<=2303||Po["Arabic Presentation Forms-A"](e)||Po["Arabic Presentation Forms-B"](e)}const Do=[[9,9],[32,32],[5760,5760],[8192,8198],[8200,8202],[8287,12288],[6158,6158],[8203,8205]];function Fo(e){for(const t of Do)if(e>=t[0]&&e<=t[1])return!0;return!1}const Ho={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂"};function No(e,t,n,i,s,o,a,l,h,c){let u=e.trim();2===c&&(u=function(e){let t="";const n=Array.from(e);for(let e=0;e<n.length;e++){const i=n[e+1].codePointAt(0)||null,s=n[e-1].codePointAt(0)||null;i&&Ro(i)&&!Ho[n[e+1]]||s&&Ro(s)&&!Ho[n[e-1]]||!Ho[n[e]]?t+=n[e]:t+=Ho[n[e]]}return t}(u));const f=[],g={positionedGlyphs:f,text:u,top:l[1],bottom:l[1],left:l[0],right:l[0],writingMode:c};let m;return m=function(e,t){const n=[];let i=0;for(let s=0;s<t.length;s++){const o=t[s];n.push(e.substring(i,o)),i=o}return i<e.length&&n.push(e.substring(i,e.length)),n}(u,function(e,t,n,i){if(!n)return[];if(!e)return[];const s=[],o=function(e,t,n,i){let s=0;for(let n=0;n<e.length;n++){const o=i[e.codePointAt(n)];o&&(s+=o.metrics.advance+t)}return s/Math.max(1,Math.ceil(s/n))}(e,t,n,i);let a=0;for(let n=0;n<e.length;n++){const l=e.codePointAt(n),h=i[l];h&&(h&&!Go[l]&&(a+=h.metrics.advance+t),n<e.length-1&&(Uo[l]||ko(l))&&s.push(Wo(n+1,a,o,s,jo(l,e.codePointAt(n+1)),!1)))}return qo(Wo(e.length,a,o,s,0,!0))}(u,a,n,t)),function(e,t,n,i,s,o,a,l,h,c){let u=0,f=0,g=0;const m=e.positionedGlyphs;for(let e=0;e<n.length;e++){let s=n[e];if(s=s.trim(),!s.length){f-=i;continue}const o=m.length;for(let e=0;e<s.length;e++){const n=s.codePointAt(e),i=t[n];i&&(Oo(n)&&1!==a?(32!==n&&m.push({glyph:n,x:u,y:0,vertical:!0}),u+=h+l):(32!==n&&m.push({glyph:n,x:u,y:f,vertical:!1}),u+=i.metrics.advance+l))}if(m.length!==o){g=Math.max(u-l,g),Xo(m,t,o,m.length-1,.5)}u=0,f-=i}const{horizontalAlign:A,verticalAlign:w}=Zo(s,void 0);!function(e,t,n,i,s,o,a){const l=(.5-n)*s,h=-(-i*a+.5)*o;if(l||h)for(let t=0;t<e.length;t++)e[t].x+=l,e[t].y+=h}(m,0,A,w,g,i,n.length);const T=n.length*i;e.top+=-w*T,e.bottom=e.top+T,e.left+=-A*g,e.right=e.left+g}(g,t,m,i,s,0,c,a,h),!!f.length&&g}const Go={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Uo={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Vo(e,t,n,i){const s=Math.pow(e-t,2);return i?e<t?s/2:2*s:s+Math.abs(n)*n}function jo(e,t){let n=0;return 10===e&&(n-=1e4),40!==e&&65288!==e||(n+=50),41!==t&&65289!==t||(n+=50),n}function Wo(e,t,n,i,s,o){let a=null,l=Vo(t,n,s,o);for(let e=0;e<i.length;e++){const h=i[e],c=Vo(t-h.x,n,s,o)+h.badness;c<=l&&(a=h,l=c)}return{index:e,x:t,priorBreak:a,badness:l}}function qo(e){return e?qo(e.priorBreak).concat(e.index):[]}function Zo(e,t){let n=.5,i=.5;switch(e){case"right":case"top-right":case"bottom-right":n=t?1:0;break;case"left":case"top-left":case"bottom-left":n=t?0:1}switch(e){case"bottom":case"bottom-right":case"bottom-left":i=t?1:0;break;case"top":case"top-right":case"top-left":i=t?0:1}return{horizontalAlign:n,verticalAlign:i}}function Xo(e,t,n,i,s){const o=t[e[i].glyph];if(o){const t=(e[i].x+o.metrics.advance)*s;if(!t)return;for(let s=n;s<=i;s++)e[s].x-=t}}function Yo(e){if(!function(e){for(const t of e)if(Lo(t.charCodeAt(0)))return!0;return!1}(e))return e;const t=[],n=[],i=[];let s=0,o=0,a=1,l=1;for(const h of e){const e=h.codePointAt(0);Fo(e)?(i.push(h),s++):(a=Lo(e)?-1:1,l!==a?(o=s,n.length&&(l>0&&n.reverse(),t.push(...n)),i.length&&(t.splice(o,0,...i),i.length=0),l=a,n.length=0):i.length&&(n.push(...i),i.length=0),n.push(h),s++)}return i.length&&n.push(...i),n.length&&(l>0&&n.reverse(),t.push(...n)),t.reverse().join("")}const Qo=/\{ *([\w_]+) *\}/g;class Jo{constructor(e,t,n,i,s){this.feature=e,this.symbolDef=t,this.symbol=n,this.options=s,this._thisReplacer=this._replacer.bind(this),this._fnTypes=i}_replacer(e,t){return this.feature.properties[t]||""}getShape(e,t){if(this._shape)return this._shape;const{textHorizontalAlignmentFn:n,textVerticalAlignmentFn:i,markerHorizontalAlignmentFn:s,markerVerticalAlignmentFn:o,textWrapWidthFn:a}=this._fnTypes,l={},h=this.symbol,c=this.getIconAndGlyph(),u=this.feature.properties;if(c&&c.glyph){const{font:e,text:s}=c.glyph;if(""===s)return null;const o=this.textSize[0]/24,f=24,g=h.textKeepUpright,m="map"===h.textRotationAlignment&&"line"===h.textPlacement&&!h.isIconText,A=t.glyphMap[e],w=$o(n?n(null,u):h.textHorizontalAlignment,i?i(null,u):h.textVerticalAlignment),T=1.2*f,S=function(e){for(let t=0;t<e.length;t++)if(!Io(e.charAt(t).charCodeAt(0)))return!1;return!0}(s),M=S&&h.textLetterSpacing/o||0,C=[h.textDx/o||0,h.textDy/o||0],I=((a?a(null,u):h.textWrapWidth)||10*f)/o,E={};E.horizontal=No(s,A,I,T,w,0,M,C,f,1),S&&m&&g&&(E.vertical=No(s,A,I,T,w,0,M,C,f,2)),l.textShape=E}if(c&&c.icon){if(!e||!e.positions[c.icon.url])return null;const t=$o(s?s(null,u):h.markerHorizontalAlignment,o?o(null,u):h.markerVerticalAlignment),n=function(e,t,n){let{horizontalAlign:i,verticalAlign:s}=Zo(t,n);n?i=1-i:s=1-s;const o=-2048*i,a=-2048*s;return{image:e,top:a,bottom:a+2048,left:o,right:o+2048}}(e.positions[c.icon.url],t,this.options.isVector3D);this.iconSize||(this.iconSize=n.image.displaySize),l.iconShape=n}return this._shape=l,l}getIconAndGlyph(){if(this.iconGlyph)return this.iconGlyph;const{markerFileFn:e,markerTypeFn:t,markerPathFn:n,markerWidthFn:i,markerHeightFn:s,markerFillFn:o,markerFillPatternFileFn:a,markerFillOpacityFn:l,markerTextFitFn:h,markerTextFitPaddingFn:c,markerLineColorFn:u,markerLineWidthFn:f,markerLineOpacityFn:g,markerLineDasharrayFn:m,markerLinePatternFileFn:A,markerPathWidthFn:w,markerPathHeightFn:T,textNameFn:S,textFaceNameFn:M}=this._fnTypes,{zoom:C}=this.options,I={},E=this.symbol,D=this.symbolDef,H=this.feature.properties,N=e?e(null,H):E.markerFile,B=t?t(null,H):E.markerType,z=N||B||E.markerPath,U=!pt(this.symbolDef.textName);let j,W;if(z){j=function(e,t,n,i,s,o){if(pt(t.markerWidth)&&pt(t.markerHeight))return null;const a="__fn_markerWidth".trim(),l="__fn_markerHeight".trim();let h=t.markerWidth||0,c=t.markerHeight||0;return mt(h)&&("identity"!==h.type?h=_o(h):(h=e.markerWidth,e[a]&&(h=e[a](i,n)),mt(h)&&(h="identity"===h.type?s(i,n):_o(h)))),mt(c)&&("identity"!==c.type?c=_o(c):(c=e.markerHeight,e[l]&&(c=e[l](i,n)),mt(c)&&(c="identity"===c.type?o(i,n):_o(c)))),[h,c]}(E,this.symbolDef,H,C,i,s)||[0,0];let e=E.markerTextFit;if(h&&(e=h(C,H)),e&&D.textName&&"none"!==e){const t=D.textSize;let n=D.textName;ye(n)&&(n=_e(n)(C,H));const i=To(n,H);if(i){const n="__fn_textSize".trim(),s="__fn_textSize_0".trim();ye(t)&&!D[n]&&(D[s]=_e(t),D[n]=(e,t)=>{const n=D[s](e,t);return ye(n)?_e(n)(e,t):n});const o=yo(D,D,H,C);if("width"!==e&&"both"!==e||(j[0]=o[0]*i.length),"height"!==e&&"both"!==e||(j[1]=o[1]),o[0]&&o[1]){let e=E.markerTextFitPadding||[0,0,0,0];c&&(e=c(C,H)),j[0]+=e[1]+e[3],j[1]+=e[0]+e[2]}}else j[0]=j[1]=-1}}if(U&&(W=yo(E,this.symbolDef,H,C)),!W&&!j)return I;if(j&&(j[0]=Math.ceil(j[0]),j[1]=Math.ceil(j[1])),W&&(W[0]=Math.ceil(W[0]),W[1]=Math.ceil(W[1])),this.iconSize=j,this.textSize=W,z&&j[0]>=0&&j[1]>=0){let e;if(B){const t={};if(t.markerType=B,"path"===B&&(t.markerPath=n?n(null,H):E.markerPath,t.markerPathWidth=w?w(null,H):E.markerPathWidth,t.markerPathHeight=T?T(null,H):E.markerPathHeight),i){const e=i(null,H);pt(e)||(t.markerWidth=e)}else E.markerWidth>=0&&(t.markerWidth=E.markerWidth);if(s){const e=s(null,H);pt(e)||(t.markerHeight=e)}else E.markerHeight>=0&&(t.markerHeight=E.markerHeight);if(o){const e=o(null,H);pt(e)||(t.markerFill=e)}else E.markerFill&&(t.markerFill=E.markerFill);if(a){const e=a(null,H);pt(e)||(t.markerFillPatternFile=e)}else E.markerFillPatternFile&&(t.markerFillPatternFile=E.markerFillPatternFile);if(l){const e=l(null,H);pt(e)||(t.markerFillOpacity=e)}else E.markerFillOpacity>=0&&(t.markerFillOpacity=E.markerFillOpacity);if(u){const e=u(null,H);pt(e)||(t.markerLineColor=e)}else E.markerLineColor&&(t.markerLineColor=E.markerLineColor);if(f){const e=f(null,H);pt(e)||(t.markerLineWidth=e)}else E.markerLineWidth>=0&&(t.markerLineWidth=E.markerLineWidth);if(g){const e=g(null,H);pt(e)||(t.markerLineOpacity=e)}else E.markerLineOpacity>=0&&(t.markerLineOpacity=E.markerLineOpacity);if(m){const e=m(null,H);pt(e)||(t.markerLineDasharray=e)}else E.markerLineDasharray&&(t.markerLineDasharray=E.markerLineDasharray);if(A){const e=A(null,H);pt(e)||(t.markerLinePatternFile=e)}else E.markerLinePatternFile&&(t.markerLinePatternFile=E.markerLinePatternFile);e="vector://"+JSON.stringify(t)}else e=N?N.replace(Qo,this._thisReplacer):E.markerPath?function(e,t,n){if(!e.markerPath)return null;let i=1;const s=function(e){const t={stroke:{stroke:e.markerLineColor,"stroke-width":e.markerLineWidth,"stroke-opacity":e.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:e.markerFill,"fill-opacity":e.markerFillOpacity}};return 0===t.stroke["stroke-width"]&&(t.stroke["stroke-opacity"]=0),t}(e);gt(e.markerOpacity)&&(i=e.markerOpacity),gt(e.opacity)&&(i*=e.opacity);const o={};if(s){for(const e in s.stroke)xt(s.stroke,e)&&(pt(s.stroke[e])||(o[e]=s.stroke[e]));for(const e in s.fill)xt(s.fill,e)&&(pt(s.fill[e])||(o[e]=s.fill[e]))}const a=Array.isArray(e.markerPath)?e.markerPath:[e.markerPath];let l;const h=[];for(let e=0;e<a.length;e++)l=At(a[e])?{path:a[e]}:a[e],l=ut({},l,o),l.d=l.path,delete l.path,h.push(l);const c=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];i<1&&c.push('opacity="'+i+'"'),e.markerPathWidth&&e.markerPathHeight&&c.push('viewBox="0 0 '+e.markerPathWidth+" "+e.markerPathHeight+'"'),c.push('preserveAspectRatio="none"'),t&&c.push('width="'+t+'"'),n&&c.push('height="'+n+'"'),c.push("><defs></defs>");for(let e=0;e<h.length;e++){let t="<path ";for(const n in h[e])xt(h[e],n)&&(t+=" "+n+'="'+h[e][n]+'"');t+="></path>",c.push(t)}return c.push("</svg>"),"data:image/svg+xml;base64,"+btoa(c.join(" "))}(E,j[0],j[1]):null;I.icon={url:e,iconSize:j,textSize:W}}if(U){const e=S?S(this.options.zoom,H):E.textName;if(e||0===e){const t=bo(M?M(null,H):E.textFaceName);let n=To(e,H);n&&n.length&&(n=Yo(n),I.glyph={font:t,text:n})}}return this.iconGlyph=I,I}}function $o(e,t){t&&"middle"!==t||(t="center"),e&&"middle"!==e||(e="center");let n="center"!==t?t:"";return n+="center"!==e?(n.length?"-":"")+e:"",n
/*!
  	 * From mapbox-gl-js
  	 * MIT License
  	 * https://github.com/mapbox/mapbox-gl-js
  	 */}function Ko(e,t,n,i,s){const a=[];let l;for(let h=0;h<e.length;h++){const c=e[h];let u,f=!1;for(let e=0;e<c.length-1;e++){let h=c[e],g=c[e+1];h.x<t&&g.x<t||(h.x<t?(l=h,h=new o(t,h.y+(t-h.x)/(g.x-h.x)*(g.y-h.y))._round(),h.z=l.z+(t-l.x)/(g.x-l.x)*(g.z-l.z),f=!0):g.x<t&&(l=g,g=new o(t,h.y+(t-h.x)/(g.x-h.x)*(g.y-h.y))._round(),g.z=h.z+(t-h.x)/(l.x-h.x)*(l.z-h.z),f=!0),h.y<n&&g.y<n||(h.y<n?(l=h,h=new o(h.x+(n-h.y)/(g.y-h.y)*(g.x-h.x),n)._round(),h.z=l.z+(n-l.y)/(g.y-l.y)*(g.z-l.z),f=!0):g.y<n&&(l=g,g=new o(h.x+(n-h.y)/(g.y-h.y)*(g.x-h.x),n)._round(),g.z=h.z+(n-h.y)/(l.y-h.y)*(l.z-h.z),f=!0),h.x>=i&&g.x>=i||(h.x>=i?(l=h,h=new o(i,h.y+(i-h.x)/(g.x-h.x)*(g.y-h.y))._round(),h.z=l.z+(i-l.x)/(g.x-l.x)*(g.z-l.z),f=!0):g.x>=i&&(l=g,g=new o(i,h.y+(i-h.x)/(g.x-h.x)*(g.y-h.y))._round(),g.z=h.z+(i-h.x)/(l.x-h.x)*(l.z-h.z),f=!0),h.y>=s&&g.y>=s||(h.y>=s?(l=h,h=new o(h.x+(s-h.y)/(g.y-h.y)*(g.x-h.x),s)._round(),h.z=l.z+(s-l.y)/(g.y-l.y)*(g.z-l.z),f=!0):g.y>=s&&(l=g,g=new o(h.x+(s-h.y)/(g.y-h.y)*(g.x-h.x),s)._round(),g.z=h.z+(s-h.y)/(l.y-h.y)*(l.z-h.z),f=!0),u&&h.equals(u[u.length-1])||(u=[h],a.push(u)),f&&(u.clipped=!0),u.push(g)))))}}return a}class ts extends o{constructor(e,t,n,i){super(e,t),this.angle=n,void 0!==i&&(this.segment=i)}clone(){return new ts(this.x,this.y,this.angle,this.segment)}}
/*!
  	 * From mapbox-gl-js
  	 * MIT License
  	 * https://github.com/mapbox/mapbox-gl-js
  	 */function ea(e,t,n,i,s){if(void 0===t.segment)return!0;let o=t,a=t.segment+1,l=0;for(;l>-n/2;){if(a--,a<0)return!1;l-=e[a].dist(o),o=e[a]}l+=e[a].dist(e[a+1]),a++;const h=[];let c=0;for(;l<n/2;){const t=e[a],n=e[a+1];if(!n)return!1;let o=e[a-1].angleTo(t)-t.angleTo(n);for(o=Math.abs((o+3*Math.PI)%(2*Math.PI)-Math.PI),h.push({distance:l,angleDelta:o}),c+=o;l-h[0].distance>i;)c-=h.shift().angleDelta;if(c>s)return!1;a++,l+=t.dist(n)}return!0}function ta(e,t,n,i,s,o,a,l,h,c,u){const f=function(e,t,n){return e?.6*t*n:0}(i,o,a),g=function(e,t){return Math.max(e?e.right-e.left:0,0)}(i),m=0===e[0].x||e[0].x===h||0===e[0].y||e[0].y===h;return t-g*a<t/4&&(t=g*a+t/4),na(e,m?t/2*l%t:(g/2+2*o)*a*l%t,t,f,n,g*a,m,!1,h,c,u)}function na(e,t,n,i,s,o,a,l,h,c,u){let f=0;const g=o/2,m=function(e){let t=0;for(let n=0;n<e.length-1;n++)t+=e[n].dist(e[n+1]);return t}(e);let A=0,w=t-n,T=[];for(let t=0;t<e.length-1;t++){const a=e[t],l=e[t+1],S=a.dist(l),M=l.angleTo(a);for(;w+n<A+S;){w+=n;const C=(w-A)/S,I=ra(a.x,l.x,C),E=ra(a.y,l.y,C),D=ra(a.z||0,l.z||0,C);if(I>=0&&I<h&&E>=0&&E<h&&w-g>=0&&w+g<=m){const n=new ts(I,E,M,t);n.z=D,c&&(n.axis=[a.y-E,I-a.x],n.angleR=D===(a.z||0)?0:Math.atan(.9*(D-(a.z||0))*u/a.dist(n))),n.line=e,n._round(),!i||ea(e,n,o,i,s)?T.push(n):i&&f++}}A+=S}return l||T.length||a||(T=na(e,A/2,n,i,s,o,a,!0,h,c,u)),T.countOutOfAngle=f,T}function ra(e,t,n){return e*(1-n)+t*n}var oa={exports:{}};oa.exports=function(){function e(n,i,s,o,a){for(;o>s;){if(o-s>600){var l=o-s+1,h=i-s+1,c=Math.log(l),u=.5*Math.exp(2*c/3),f=.5*Math.sqrt(c*u*(l-u)/l)*(h-l/2<0?-1:1);e(n,i,Math.max(s,Math.floor(i-h*u/l+f)),Math.min(o,Math.floor(i+(l-h)*u/l+f)),a)}var g=n[i],m=s,A=o;for(t(n,s,i),a(n[o],g)>0&&t(n,s,o);m<A;){for(t(n,m,A),m++,A--;a(n[m],g)<0;)m++;for(;a(n[A],g)>0;)A--}0===a(n[s],g)?t(n,s,A):t(n,++A,o),A<=i&&(s=A+1),i<=A&&(o=A-1)}}function t(e,t,n){var i=e[t];e[t]=e[n],e[n]=i}function n(e,t){return e<t?-1:e>t?1:0}return function(t,i,s,o,a){e(t,i,s||0,o||t.length-1,a||n)}}();var aa=n(oa.exports);function la(e,t){const n=e.length;if(n<=1)return[e];const i=[];let s,o;for(let t=0;t<n;t++){const n=C(e[t]);0!==n&&(e[t].area=Math.abs(n),void 0===o&&(o=n<0),o===n<0?(s&&i.push(s),s=[e[t]]):s.push(e[t]))}if(s&&i.push(s),t>1)for(let e=0;e<i.length;e++)i[e].length<=t||(aa(i[e],t,1,i[e].length-1,ha),i[e]=i[e].slice(0,t));return i}function ha(e,t){return t.area-e.area}class cs{constructor(e=[],t=ca){if(this.data=e,this.length=this.data.length,this.compare=t,this.length>0)for(let e=(this.length>>1)-1;e>=0;e--)this._down(e)}push(e){this.data.push(e),this.length++,this._up(this.length-1)}pop(){if(0===this.length)return;const e=this.data[0],t=this.data.pop();return this.length--,this.length>0&&(this.data[0]=t,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:t,compare:n}=this,i=t[e];for(;e>0;){const s=e-1>>1,o=t[s];if(n(i,o)>=0)break;t[e]=o,e=s}t[e]=i}_down(e){const{data:t,compare:n}=this,i=this.length>>1,s=t[e];for(;e<i;){let i=1+(e<<1),o=t[i];const a=i+1;if(a<this.length&&n(t[a],o)<0&&(i=a,o=t[a]),n(o,s)>=0)break;t[e]=o,e=i}t[e]=s}}function ca(e,t){return e<t?-1:e>t?1:0}function ua(e,t,n){const i=t.distSqr(n);if(0===i)return e.distSqr(t);const s=((e.x-t.x)*(n.x-t.x)+(e.y-t.y)*(n.y-t.y))/i;return e.distSqr(s<0?t:s>1?n:n.sub(t)._mult(s)._add(t))}function fa(e,t=1,n=!1){let i=1/0,s=1/0,a=-1/0,l=-1/0;const h=e[0];for(let e=0;e<h.length;e++){const t=h[e];(!e||t.x<i)&&(i=t.x),(!e||t.y<s)&&(s=t.y),(!e||t.x>a)&&(a=t.x),(!e||t.y>l)&&(l=t.y)}const c=Math.min(a-i,l-s);let u=c/2;const f=new cs([],da);if(0===c)return new o(i,s);for(let t=i;t<a;t+=c)for(let n=s;n<l;n+=c)f.push(new pa(t+u,n+u,u,e));let g=function(e){let t=0,n=0,i=0;const s=e[0];for(let e=0,o=s.length,a=o-1;e<o;a=e++){const o=s[e],l=s[a],h=o.x*l.y-l.x*o.y;n+=(o.x+l.x)*h,i+=(o.y+l.y)*h,t+=3*h}return new pa(n/t,i/t,0,e)}(e),m=f.length;for(;f.length;){const i=f.pop();(i.d>g.d||!g.d)&&(g=i,n&&console.log("found best %d after %d probes",Math.round(1e4*i.d)/1e4,m)),i.max-g.d<=t||(u=i.h/2,f.push(new pa(i.p.x-u,i.p.y-u,u,e)),f.push(new pa(i.p.x+u,i.p.y-u,u,e)),f.push(new pa(i.p.x-u,i.p.y+u,u,e)),f.push(new pa(i.p.x+u,i.p.y+u,u,e)),m+=4)}return n&&(console.log(`num probes: ${m}`),console.log(`best distance: ${g.d}`)),g.p}function da(e,t){return t.max-e.max}function pa(e,t,n,i){this.p=new o(e,t),this.h=n,this.d=function(e,t){let n=!1,i=1/0;for(let s=0;s<t.length;s++){const o=t[s];for(let t=0,s=o.length,a=s-1;t<s;a=t++){const s=o[t],l=o[a];s.y>e.y!=l.y>e.y&&e.x<(l.x-s.x)*(e.y-s.y)/(l.y-s.y)+s.x&&(n=!n),i=Math.min(i,ua(e,s,l))}}return(n?1:-1)*Math.sqrt(i)}(this.p,i),this.max=this.d+this.h*Math.SQRT2}function ga(e,t,n,i,s,o,a,l,h,c){const{feature:u,iconSize:f,textSize:g,symbol:m}=e,A=f||g?24:0,w=s*(g?g[0]/A:1);if("line"===a){const e=[];e.countOutOfAngle=0;let s=u.geometry;o&&(s=Ko(u.geometry,0,0,o,o));for(let a=0;a<s.length;a++){const u=ta(s[a],l,n,m.isIconText?null:i&&i.vertical||i&&i.horizontal||i,0,A,m.isIconText?1:w,1,o||1/0,h,c);if(m.textPlacement&&!m.isIconText)for(let e=0;e<u.length;e++)u[e].startIndex=t.length/3;if(e.push.apply(e,u),m.textPlacement&&!m.isIconText)for(let e=0;e<s[a].length;e++)t.push(s[a][e].x,s[a][e].y,s[a][e].z||0);e.countOutOfAngle+=u.countOutOfAngle||0}return e}return ma(u,a,o)}function ma(e,t,n,i,s){const o=[];if(3===e.type){const a=la(e.geometry,0);for(let e=0;e<a.length;e++){const l=a[e];if("vertex"===t)for(let e=0;e<l.length;e++){const t=l[e];for(let a=0;a<t.length;a++)H(t[a],n)||(o.push(t[a]),i&&(0===a?Aa(t[a],t[a],t[e+1],s):Aa(t[a],t[a-1],t[a],s)))}else if("vertex-first"===t){const e=l[0];e&&e[0]&&!H(e[0],n)&&(o.push(e[0]),i&&Aa(e[0],e[0],e[1],s))}else if("vertex-last"===t||"vertex-firstlast"===t){const e=l[0];if("vertex-firstlast"===t&&e&&e[0]&&!H(e[0],n)&&(o.push(e[0]),i&&Aa(e[0],e[0],e[1],s)),e&&e[e.length-1]&&!H(e[e.length-1],n)){const t=e.length-1;o.push(e[t]),i&&Aa(e[t],e[t-1],e[t],s)}}else{const e=fa(l,16);H(e,n)||o.push(e)}}}else if(2===e.type)for(let a=0;a<e.geometry.length;a++){const l=e.geometry[a];if("vertex"===t)for(let e=0;e<l.length;e++)H(l[e],n)||(o.push(l[e]),i&&(0===e?Aa(l[e],l[e],l[e+1],s):Aa(l[e],l[e-1],l[e],s)));else if("vertex-last"===t||"vertex-firstlast"===t){if("vertex-firstlast"!==t||H(l[0],n)||(o.push(l[0]),i&&Aa(l[0],l[0],l[1],s)),l&&l[l.length-1]&&!H(l[l.length-1],n)){const e=l.length-1;o.push(l[e]),i&&Aa(l[e],l[e-1],l[e],s)}}else H(l[0],n)||(o.push(l[0]),i&&Aa(l[0],l[0],l[1],s))}else if(1===e.type)for(let t=0;t<e.geometry.length;t++){const s=e.geometry[t];for(let e=0;e<s.length;e++){const t=s[e];H(t,n)||(i&&(t.xRotation=0,t.yRotation=0,t.zRotation=0),o.push(t))}}return o}function Aa(e,t,n,i){if(e.xRotation||e.yRotation||e.zRotation)return e;const s=n.x-t.x,o=t.y-n.y,a=(n.z-t.z)*i,l=Math.atan2(o,s);e.zRotation=l;const h=Math.atan2(a,Math.sqrt(s*s+o*o));return e.xyRotation=h,e}function ya(e,t){const n={},i={},s=[];let o=0;function a(t){s.push(e[t]),o++}function l(e,t,n){const o=i[e];return delete i[e],i[t]=o,s[o].geometry[0].pop(),s[o].geometry[0]=s[o].geometry[0].concat(n[0]),o}function h(e,t,i){const o=n[t];return delete n[t],n[e]=o,s[o].geometry[0].shift(),s[o].geometry[0]=i[0].concat(s[o].geometry[0]),o}function c(e,t,n){const i=n?t[0][t[0].length-1]:t[0][0];return`${e}:${i.x}:${i.y}`}for(let u=0;u<e.length;u++){const f=e[u],g=f.geometry;if(!g)continue;const m=f.properties[t]?f.properties[t].toString():null;if(!m){a(u);continue}const A=c(m,g),w=c(m,g,!0);if(A in i&&w in n&&i[A]!==n[w]){const e=h(A,w,g),t=l(A,w,s[e].geometry);delete n[A],delete i[w],i[c(m,s[t].geometry,!0)]=t,s[e].geometry=null}else A in i?l(A,w,g):w in n?h(A,w,g):(a(u),n[A]=o-1,i[w]=o-1)}return s.filter((e=>e.geometry))}const _a="__index";function va(e,t,n,i){const s=(_a+"").trim(),o=function(e,t,n,i){const s=(_a+"").trim(),{mergeOnPropertyFn:o}=n;if(!t.mergeOnProperty)return[];if(!N(a=t.mergeOnProperty)&&("string"==typeof a||null!==a.constructor&&a.constructor===String))return[{features:e,property:t.mergeOnProperty}];var a;const l=[],h={},c=[];for(let n=0;n<e.length;n++){e[n][s]=n;const a=e[n].properties=e[n].properties||{};a.$layer=e[n].layer,a.$type=e[n].type;const u=o?o(i,a):t.mergeOnProperty;N(u)?c.push(e[n]):(void 0===h[u]&&(h[u]=l.length,l.push({features:[],property:u})),l[h[u]].features.push(e[n]))}return c.length&&l.push({features:c}),l}(e,t,n,i);if(o.length){const e=[];for(let t=0;t<o.length;t++)e.push(o[t].property?ya(o[t].features,o[t].property):o[t].features);if(1===e.length)return e[0];{let t=[];for(let n=0;n<e.length;n++)t=t.concat(e[n]);return t.sort(((e,t)=>e[s]-t[s])),t}}return[]}class Ts extends mo{static needMerge(e,t,n){if(!e)return!1;let i="line"===e.textPlacement||"line"===e.markerPlacement;return i||(t.textPlacementFn&&(i="line"===t.textPlacementFn(n)),t.markerPlacementFn&&(i="line"===t.markerPlacementFn(n))),e.mergeOnProperty&&i}static mergeLineFeatures(e,t,n,i){let s=t.textPlacement,o=t.markerPlacement;return n.textPlacementFn&&(s=n.textPlacementFn(i)),n.markerPlacementFn&&(o=n.markerPlacementFn(i)),"line"!==s&&"line"!==o?e:va(e,t,n,i)}static splitPointSymbol(e,t=0){const n=[];if(Array.isArray(e)){const t=e;for(let e=0;e<t.length;e++)t[e]&&n.push(...Ts.splitPointSymbol(t[e],e));return n}let i=null,s=null;for(const t in e)0===t.indexOf("marker")?(i=i||{},i[t]=e[t]):0===t.indexOf("text")&&(s=s||{},s[t]=e[t]);return i&&(i.isIconText=!0,e.mergeOnProperty&&(i.mergeOnProperty=e.mergeOnProperty),n.push(i)),s&&(i&&(s.textPlacement=i.markerPlacement,s.textSpacing=i.markerSpacing,s.isIconText=!0),e.mergeOnProperty&&(s.mergeOnProperty=e.mergeOnProperty),n.push(s)),void 0!==e.visible&&(i&&(i.visible=e.visible),s&&(s.visible=e.visible)),i&&(i.markerTextFit&&s&&(i.text={},i.text.textName=s.textName,i.text.textSize=s.textSize),i.index={index:t,type:0}),s&&(s.index={index:t,type:1}),n}static isAtlasLoaded(e,t){const{icon:n,glyph:i}=e,{iconAtlas:s,glyphAtlas:o}=t;if(n&&(!s||!s.positions[n.url]))return!1;if(i){if(!o||!o.positions[i.font])return!1;const e=o.positions[i.font],{text:t}=i;for(const n of t)if(!e[n.codePointAt(0)])return!1}return!0}constructor(e,t,n){super(e,t,n),this._textPlacement=t.textPlacement,this._fnTypes.textPlacementFn&&(this._textPlacement=this._fnTypes.textPlacementFn(this.options.zoom))}createStyledVector(e,t,n,i,s,o){const a=new Jo(e,this.symbolDef,t,n,i),l=a.getIconAndGlyph();if(l.icon&&!this.options.atlas){const{url:e,iconSize:t}=l.icon;s[e]||(s[e]=l.icon.iconSize),s[e][0]<t[0]&&(s[e][0]=t[0]),s[e][1]<t[1]&&(s[e][1]=t[1])}if(l.glyph&&!this.options.atlas){const{font:e,text:t}=l.glyph,n=o[e]=o[e]||{};for(const e of t)n[e.codePointAt(0)]=1;"line"===this._textPlacement&&(o.options={isCharsCompact:!1})}return this.options.allowEmptyPack||l.icon||l.glyph?a:null}getFormat(e){const t="text"===this.options.pluginType,n="line"===this._textPlacement&&!e.isIconText,i=this.getPackSDFFormat(e);i.push(...this._getTextFnTypeFormats()),n||i.push(...this._getMarkerFnTypeFormats());const{markerOpacityFn:s,textOpacityFn:o,markerPitchAlignmentFn:a,textPitchAlignmentFn:l,markerRotationAlignmentFn:h,textRotationAlignmentFn:c,markerRotationFn:u,textRotationFn:f,markerAllowOverlapFn:g,textAllowOverlapFn:m,markerIgnorePlacementFn:A,textIgnorePlacementFn:w}=this._fnTypes;return s?i.push({type:Uint8Array,width:2,name:"aColorOpacity"}):o&&i.push({type:Uint8Array,width:1,name:"aColorOpacity"}),(a||l)&&i.push({type:Uint8Array,width:t?1:2,name:"aPitchAlign"}),(h||c)&&i.push({type:Uint8Array,width:t?1:2,name:"aRotationAlign"}),(u||f)&&i.push({type:Uint16Array,width:t?1:2,name:"aRotation"}),(g||m||A||w)&&i.push({type:Uint8Array,width:1,name:"aOverlap"}),i}_is3DPitchText(){return this.hasMapPitchAlign}_getTextFnTypeFormats(){const{textFillFn:e,textSizeFn:t,textHaloFillFn:n,textHaloRadiusFn:i,textHaloOpacityFn:s,textDxFn:o,textDyFn:a}=this._fnTypes,l=[];return e&&l.push({type:Uint8Array,width:4,name:"aTextFill"}),t&&l.push({type:Uint8Array,width:1,name:"aTextSize"}),n&&l.push({type:Uint8Array,width:4,name:"aTextHaloFill"}),(i||s)&&l.push({type:Uint8Array,width:2,name:"aTextHalo"}),o&&l.push({type:Int8Array,width:1,name:"aTextDx"}),a&&l.push({type:Int8Array,width:1,name:"aTextDy"}),l}_getMarkerFnTypeFormats(){const{markerWidthFn:e,markerHeightFn:t,markerDxFn:n,markerDyFn:i,textDxFn:s,textDyFn:o}=this._fnTypes,a=[];return e&&a.push({type:this.options.markerWidthType||Uint8Array,width:1,name:"aMarkerWidth"}),t&&a.push({type:this.options.markerHeightType||Uint8Array,width:1,name:"aMarkerHeight"}),(n||s)&&a.push({type:Int8Array,width:1,name:"aMarkerDx"}),(i||o)&&a.push({type:Int8Array,width:1,name:"aMarkerDy"}),a}_prepareFnTypes(){this.iconAtlas||(this._fnTypes.markerWidthFn=this._fnTypes.markerHeightFn=this._fnTypes.markerDxFn=this._fnTypes.markerDyFn=this._fnTypes.markerPitchAlignmentFn=this._fnTypes.markerRotationAlignmentFn=this._fnTypes.markerRotationFn=this._fnTypes.markerAllowOverlapFn=this._fnTypes.markerIgnorePlacementFn=this._fnTypes.markerOpacityFn=null),this.glyphAtlas||(this._fnTypes.textFillFn=this._fnTypes.textSizeFn=this._fnTypes.textHaloFillFn=this._fnTypes.textHaloRadiusFn=this._fnTypes.textHaloOpacityFn=this._fnTypes.textDxFn=this._fnTypes.textDyFn=this._fnTypes.textPitchAlignmentFn=this._fnTypes.textRotationAlignmentFn=this._fnTypes.textRotationFn=this._fnTypes.textAllowOverlapFn=this._fnTypes.textIgnorePlacementFn=this._fnTypes.textOpacityFn=null)}createDataPack(){if(!this.iconAtlas&&!this.glyphAtlas){if(!this.options.allowEmptyPack)return null;this.empty=!0}this._prepareFnTypes(),this.countOutOfAngle=0,this.lineVertex=[];const e=super.createDataPack.apply(this,arguments);return e?(e.lineVertex=new Int16Array(this.lineVertex),e.buffers.push(e.lineVertex.buffer),e):null}placeVector(e,t){const n=e.getShape(this.iconAtlas,this.glyphAtlas);if(!n)return;const{iconShape:i,textShape:s}=n,a=!i||!i.image,l=!s||!s.horizontal&&!s.vertical;if(!this.options.allowEmptyPack&&a&&l)return;const h=this._getAnchors(e,s||i,t);if(this.countOutOfAngle+=h.countOutOfAngle||0,0===h.length)return;const c=this.data,u=this.needAltitudeAttribute()?2:3;let f=this.data.aPosition.getLength()/u;const g=e.feature.properties,m="line"===this._textPlacement&&!e.symbol.isIconText,A=!l,w=!a,T=A&&m&&function(e){let t=0;for(let n=0;n<e.length;n++)if(Oo(e.charAt(n).charCodeAt(0)))t=0;else if(t++,t>=1)return!1;return!0}(e.getIconAndGlyph().glyph.text)?1:0,{textFillFn:S,textSizeFn:M,textHaloFillFn:C,textHaloRadiusFn:I,textHaloOpacityFn:E,textDxFn:z,textDyFn:U,textPitchAlignmentFn:j,textRotationAlignmentFn:W,textRotationFn:q,textAllowOverlapFn:Z,textIgnorePlacementFn:X,textOpacityFn:Y,markerWidthFn:J,markerHeightFn:Q,markerDxFn:$,markerDyFn:K,markerPitchAlignmentFn:ee,markerRotationAlignmentFn:te,markerRotationFn:re,markerAllowOverlapFn:se,markerIgnorePlacementFn:oe,markerOpacityFn:le}=this._fnTypes;let he,ue,fe,de,pe,me=[0,0,0,0],Ae=14,_e=[0,0,0,0],ve=0,xe=0,be=0,we=0,Te=0,Se=0,Me=0,Ce=0,Pe=0,Ie=0,ke=0,Oe=0,Ee=0,Re=0;if(A){const t=e.getIconAndGlyph().glyph.font;fe=function(e,t,n){const i=e.positionedGlyphs,s=[];for(let a=0;a<i.length;a++){const l=i[a],h=n[l.glyph];if(!h)continue;const c=h.rect;if(!c)continue;const u=4,f=h.metrics.advance/2,g=h.metrics.height/2,m=t?[l.x+f,0]:[0,0],A=t?[0,l.y-g]:[l.x+f,l.y-g],w=h.metrics.left-u-f+A[0],T=h.metrics.top-u+A[1],S=w+c.w,M=T+c.h,C=new o(w,T),I=new o(S,T),E=new o(w,M),D=new o(S,M);if(t&&l.vertical){const e=new o(-f,f),t=-Math.PI/2,n=new o(5,0);C._rotateAround(t,e)._add(n),I._rotateAround(t,e)._add(n),E._rotateAround(t,e)._add(n),D._rotateAround(t,e)._add(n)}s.push({tl:C,tr:I,bl:E,br:D,tex:c,writingMode:e.writingMode,glyphOffset:m})}return s}(s.horizontal,m,this.glyphAtlas.positions[t]),S&&(me=S(null,g),ye(me)?this.dynamicAttrs.aTextFill=1:me=Pt([],me)),M&&(Ae=M(this.options.zoom,g),N(Ae)&&(Ae=14)),C&&(_e=C(null,g),ye(_e)?this.dynamicAttrs.aTextHaloFill=1:_e=Pt([],_e)),I&&(ve=I(null,g)),E&&(xe=255*E(null,g)),z&&(be=z(null,g)||0),U&&(we=U(null,g)||0),j&&(Ie=+("map"===j(null,g))),W&&(Oe=+("map"===W(null,g))),q&&(Re=B(q(null,g),0,360)*Math.PI/180)}w&&(de=i?function(e){const t=e.image,n=e.top-1/t.pixelRatio,i=e.left-1/t.pixelRatio,s=e.bottom+1/t.pixelRatio,a=e.right+1/t.pixelRatio;let l,h,c,u;return l=new o(i,n),h=new o(a,n),c=new o(a,s),u=new o(i,s),[{tl:l,tr:h,bl:u,br:c,tex:{x:t.tl[0],y:t.tl[1],w:t.displaySize[0],h:t.displaySize[1]},writingMode:void 0,glyphOffset:[0,0]}]}(i):function(){const e=new o(0,0),t=new o(0,0),n=new o(0,0);return[{tl:e,tr:t,bl:new o(0,0),br:n,tex:{x:0,y:0,w:0,h:0},writingMode:void 0,glyphOffset:[0,0]}]}(),J&&(Te=J(null,g)),N(Te)&&(Te=de[0].tex.w),Q&&(Se=Q(null,g)),N(Se)&&(Se=de[0].tex.h),$&&(Me=$(null,g)),K&&(Ce=K(null,g)),ee&&(Pe=+("map"===ee(null,g))),te&&(ke=+("map"===te(null,g))),re&&(Ee=B(re(null,g),0,360)*Math.PI/180)),ye(Ae)&&(this.dynamicAttrs.aTextSize=1),(ye(ve)||ye(xe))&&(this.dynamicAttrs.aTextHalo=1),ye(Te)&&(this.dynamicAttrs.aMarkerWidth=1),ye(Se)&&(this.dynamicAttrs.aMarkerHeight=1),(ye(Me)||ye(be))&&(this.dynamicAttrs.aDxDy=1),(ye(Ce)||ye(be))&&(this.dynamicAttrs.aDxDy=1),(ye(Pe)||ye(Ie))&&(this.dynamicAttrs.aPitchAlign=1),(ye(ke)||ye(Oe))&&(this.dynamicAttrs.aRotationAlign=1),(ye(Ee)||ye(Re))&&(this.dynamicAttrs.aRotation=1),(se||Z)&&(se&&(he=se(null,g)||0),!he&&Z&&(he=Z(null,g)||0)),(oe||X)&&(oe&&(ue=oe(null,g)||0),!ue&&X&&(ue=X(null,g)||0)),le&&(pe=255*(le(this.options.zoom,g)||0));let Le=0;Y&&(Le=255*(Y(this.options.zoom,g)||0));const De=fe&&fe.length||0;this.ensureDataCapacity(4*(De+(de&&de.length||0)),h.length);const Fe=this.options.EXTENT,{altitudeScale:He,altitudeProperty:Ne,defaultAltitude:Be}=this.options,{altitude:ze}=D(e.feature,He,Ne,Be),Ge=this.needAltitudeAttribute(),Ue=(e,t,n,i,s,o,a)=>{if(!t)return;const l=e?De:1;for(let h=0;h<t.length;h++){const u=t[h],{tl:g,tr:A,bl:w,br:S,tex:M}=u;let C;this._fillPos(c,n,i,s,10*g.x,10*g.y,M.x,M.y+M.h,e,a),this._fillTextData(c,m,l,u.glyphOffset,o,T,o.axis,o.angleR),this._fillFnTypeData(c,me,Ae,_e,ve,xe,be,we,Te,Se,Me,Ce,pe,Le,Pe,Ie,ke,Oe,Ee,Re,he,ue),this._fillPos(c,n,i,s,10*A.x,10*A.y,M.x+M.w,M.y+M.h,e,a),this._fillTextData(c,m,l,u.glyphOffset,o,T,o.axis,o.angleR),this._fillFnTypeData(c,me,Ae,_e,ve,xe,be,we,Te,Se,Me,Ce,pe,Le,Pe,Ie,ke,Oe,Ee,Re,he,ue),this._fillPos(c,n,i,s,10*w.x,10*w.y,M.x,M.y,e,a),this._fillTextData(c,m,l,u.glyphOffset,o,T,o.axis,o.angleR),this._fillFnTypeData(c,me,Ae,_e,ve,xe,be,we,Te,Se,Me,Ce,pe,Le,Pe,Ie,ke,Oe,Ee,Re,he,ue),this._fillPos(c,n,i,s,10*S.x,10*S.y,M.x+M.w,M.y,e,a),this._fillTextData(c,m,l,u.glyphOffset,o,T,o.axis,o.angleR),this._fillFnTypeData(c,me,Ae,_e,ve,xe,be,we,Te,Se,Me,Ce,pe,Le,Pe,Ie,ke,Oe,Ee,Re,he,ue),this.addElements(f,f+1,f+2),this.addElements(f+1,f+2,f+3),f+=4,C=Ge?Math.max(Math.abs(n),Math.abs(i)):Math.max(Math.abs(n),Math.abs(i),Math.abs(s)),C>this.maxPos&&(this.maxPos=C)}},Ve="text"===this.options.pluginType;for(let e=0;e<h.length;e++){const t=h[e],n=t.z||ze||0;if(Fe!==1/0&&H(t,Fe))continue;const i=t.x,s=t.y;w&&Ue(!1,de,i,s,n,t),A&&(Ve||Ue(!0,fe,i,s,n,t,!0),Ue(!0,fe,i,s,n,t,!1))}}_fillPos(e,t,n,i,s,o,a,l,h,c){this.fillPosition(e,t,n,i);let u=e.aShape.currentIndex;e.aShape[u++]=s,e.aShape[u++]=o,e.aShape.currentIndex=u,e.aTexCoord?(u=e.aTexCoord.currentIndex,e.aTexCoord[u++]=a,e.aTexCoord[u++]=l,e.aTexCoord.currentIndex=u):(u=e.aShape.currentIndex,"text"!==this.options.pluginType?(e.aShape[u++]=+!!h+(a<<1),e.aShape[u++]=+!!c+(l<<1)):(e.aShape[u++]=a,e.aShape[u++]=l),e.aShape.currentIndex=u)}_fillTextData(e,t,n,i,s,o,a,l){let h=e.aCount.currentIndex;if(e.aCount[h++]=n,e.aCount.currentIndex=h,t){h=e.aGlyphOffset.currentIndex,e.aGlyphOffset[h++]=i[0],e.aGlyphOffset[h++]=i[1],e.aGlyphOffset.currentIndex=h,this._is3DPitchText()&&(h=e.aPitchRotation.currentIndex,e.aPitchRotation[h++]=a[0],e.aPitchRotation[h++]=a[1],e.aPitchRotation[h++]=l,e.aPitchRotation.currentIndex=h);const t=s.startIndex;h=e.aSegment.currentIndex,e.aSegment[h++]=s.segment+t,e.aSegment[h++]=t,e.aSegment[h++]=s.line.length,e.aSegment.currentIndex=h,h=e.aVertical.currentIndex,e.aVertical[h++]=o,e.aVertical.currentIndex=h}}_fillFnTypeData(e,t,n,i,s,o,a,l,h,c,u,f,g,m,A,w,T,S,M,C,I,E){const{textFillFn:D,textSizeFn:H,textHaloFillFn:B,textHaloRadiusFn:z,textDxFn:U,textDyFn:j,textPitchAlignmentFn:W,textRotationAlignmentFn:q,textRotationFn:Z,textAllowOverlapFn:X,textIgnorePlacementFn:Y,textOpacityFn:J,textHaloOpacityFn:Q,markerWidthFn:$,markerHeightFn:K,markerDxFn:ee,markerDyFn:te,markerPitchAlignmentFn:re,markerRotationAlignmentFn:se,markerRotationFn:oe,markerAllowOverlapFn:le,markerIgnorePlacementFn:he,markerOpacityFn:ue}=this._fnTypes;if(D){let n=e.aTextFill.currentIndex;e.aTextFill[n++]=t[0],e.aTextFill[n++]=t[1],e.aTextFill[n++]=t[2],e.aTextFill[n++]=t[3],e.aTextFill.currentIndex=n}if(H){let t=e.aTextSize.currentIndex;e.aTextSize[t++]=n,e.aTextSize.currentIndex=t}if(B){let t=e.aTextHaloFill.currentIndex;e.aTextHaloFill[t++]=i[0],e.aTextHaloFill[t++]=i[1],e.aTextHaloFill[t++]=i[2],e.aTextHaloFill[t++]=i[3],e.aTextHaloFill.currentIndex=t}if(z||Q){let t=e.aTextHalo.currentIndex;e.aTextHalo[t++]=s||0,e.aTextHalo.currentIndex=t,t=e.aTextHalo.currentIndex,e.aTextHalo[t++]=255*(N(o)?1:o),e.aTextHalo.currentIndex=t}if(U){let t=e.aTextDx.currentIndex;e.aTextDx[t++]=a,e.aTextDx.currentIndex=t}if(j){let t=e.aTextDy.currentIndex;e.aTextDy[t++]=l,e.aTextDy.currentIndex=t}if($){let t=e.aMarkerWidth.currentIndex;e.aMarkerWidth[t++]=h,e.aMarkerWidth.currentIndex=t}if(K){let t=e.aMarkerHeight.currentIndex;e.aMarkerHeight[t++]=c,e.aMarkerHeight.currentIndex=t}if(ee){let t=e.aMarkerDx.currentIndex;e.aMarkerDx[t++]=u,e.aMarkerDx.currentIndex=t}if(te){let t=e.aMarkerDy.currentIndex;e.aMarkerDy[t++]=f,e.aMarkerDy.currentIndex=t}const fe="text"===this.options.pluginType;if(!fe&&(ue||J)){ue||(g=255);let t=e.aColorOpacity.currentIndex;e.aColorOpacity[t++]=g,e.aColorOpacity.currentIndex=t,t=e.aColorOpacity.currentIndex,e.aColorOpacity[t++]=g=J?m:255,e.aColorOpacity.currentIndex=t}if(fe&&J){let t=e.aColorOpacity.currentIndex;e.aColorOpacity[t++]=m,e.aColorOpacity.currentIndex=t}if(W||re)if(fe){let t=e.aPitchAlign.currentIndex;e.aPitchAlign[t++]=w,e.aPitchAlign.currentIndex=t}else{let t=e.aPitchAlign.currentIndex;e.aPitchAlign[t++]=A,e.aPitchAlign.currentIndex=t,t=e.aPitchAlign.currentIndex,e.aPitchAlign[t++]=w,e.aPitchAlign.currentIndex=t}if(se||q)if(fe){let t=e.aRotationAlign.currentIndex;e.aRotationAlign[t++]=S,e.aRotationAlign.currentIndex=t}else{let t=e.aRotationAlign.currentIndex;e.aRotationAlign[t++]=T,e.aRotationAlign.currentIndex=t,t=e.aRotationAlign.currentIndex,e.aRotationAlign[t++]=S,e.aRotationAlign.currentIndex=t}if(oe||Z)if(fe){let t=e.aRotation.currentIndex;e.aRotation[t++]=9362*C,e.aRotation.currentIndex=t}else{let t=e.aRotation.currentIndex;e.aRotation[t++]=9362*M,e.aRotation.currentIndex=t,t=e.aRotation.currentIndex,e.aRotation[t++]=9362*C,e.aRotation.currentIndex=t}const de=le||X,pe=he||Y;if(de||pe){let t=e.aOverlap.currentIndex;e.aOverlap[t++]=(de?8:0)+4*I+((pe?2:0)+E),e.aOverlap.currentIndex=t}s>0&&(this.properties.hasHalo=1)}_getAnchors(e,t,n){const{feature:i,symbol:s}=e,o=this._getPlacement(e,s),a=i.properties,{markerSpacingFn:l,textSpacingFn:h,textMaxAngleFn:c}=this._fnTypes,u=((l?l(null,a):s.markerSpacing)||(h?h(null,a):s.textSpacing)||250)*n;let f=c?c(this.options.zoom,a):s.textMaxAngle;N(f)&&(f=80),f*=Math.PI/180;const g=this.options.EXTENT,m=this.options.altitudeToTileScale,A=this._is3DPitchText();return ga(e,this.lineVertex,f,t,n,g,o,u,A,m)}_getPlacement(e,t){let n;return n=this._fnTypes.markerPlacementFn?this._fnTypes.markerPlacementFn(this.options.zoom,e.feature.properties):t.markerPlacement||this._textPlacement,this._packMarkerPlacement||!t.markerPlacement&&!t.isIconText||(this._packMarkerPlacement=n),!this._textPlacement||t.isIconText||this._packTextPlacement||(this._packTextPlacement=n),n}getPackSDFFormat(e){if("line"!==this._textPlacement||e.isIconText)return[...this.getPositionFormat(),{type:Int16Array,width:4,name:"aShape"},{type:Uint8Array,width:1,name:"aCount"}];{const e=[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"},{type:Uint8Array,width:1,name:"aCount"},{type:Int16Array,width:2,name:"aGlyphOffset"},{type:Uint16Array,width:3,name:"aSegment"},{type:Uint8Array,width:1,name:"aVertical"}];return this._is3DPitchText()&&e.push({type:Float32Array,width:3,name:"aPitchRotation"}),e}}}class bs{constructor(e){this.x=e.x,this.y=e.y,this.z=e.z||0}clone(){return new bs(this)}_unit(){return this._div(this.mag()),this}_div(e){return this.x/=e,this.y/=e,this.z/=e,this}_perp(){var e=this.y;return this.y=this.x,this.x=-e,this}mag(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}add(e){return this.clone()._add(e)}sub(e){return this.clone()._sub(e)}_add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}_sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}mult(e){return this.clone()._mult(e)}_mult(e){return this.x*=e,this.y*=e,this.z*=e,this}dist(e){return Math.sqrt(this.distSqr(e))}distSqr(e){var t=e.x-this.x,n=e.y-this.y,i=e.z-this.z;return t*t+n*n+i*i}_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}angleTo(e){return Math.atan2(this.y-e.y,this.x-e.x)}}var xa,Ta="undefined"!=typeof Float32Array?Float32Array:Array;function Sa(e,t,n,i){return e[0]=t,e[1]=n,e[2]=i,e}function Ma(e,t){var n=t[0],i=t[1],s=t[2],o=n*n+i*i+s*s;return o>0&&(o=1/Math.sqrt(o)),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e}function Ca(e,t,n){var i=t[0],s=t[1],o=t[2],a=n[0],l=n[1],h=n[2];return e[0]=s*h-o*l,e[1]=o*a-i*h,e[2]=i*l-s*a,e}function Pa(e,t,n,i,s){return e[0]=t,e[1]=n,e[2]=i,e[3]=s,e}function Ia(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e}function ka(e,t,n){return e[0]=t,e[1]=n,e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),xa=new Ta(3),Ta!=Float32Array&&(xa[0]=0,xa[1]=0,xa[2]=0),function(){var e=new Ta(4);Ta!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0)}(),function(){var e=new Ta(2);Ta!=Float32Array&&(e[0]=0,e[1]=0)}();const Oa=63,Ea=Math.cos(Math.PI/180*37.5),Ra=Math.pow(2,16)/1,La=new o,Da=new o,Fa=new o;class Ns extends mo{static mergeLineFeatures(e,t,n,i){return va(e,t,n,i)}constructor(e,t,n){super(e,t,n);let i=!1;const{lineDasharrayFn:s,lineDashColorFn:o}=this._fnTypes;this.hasGradient=this.symbol.lineGradientProperty,s&&(i=function(e,t,n){for(let i=0;i<e.length;i++)if(n(t,e[i].properties))return!0;return!1}(e,this.options.zoom,s),i&&(this.dasharrayFn=s)),this.hasDasharray=Ba(this.symbol.lineDasharray)||i,this.hasDasharray&&o&&(this.dashColorFn=o)}createStyledVector(e,t,n,i,s){const o=new dt(e,t,n,i),a=o.getLineResource();return!this.options.atlas&&a&&(s[a]=[0,0]),o}getFormat(){const{lineWidthFn:e,lineStrokeWidthFn:t,lineStrokeColorFn:n,lineColorFn:i,lineOpacityFn:s,lineDxFn:o,lineDyFn:a,linePatternAnimSpeedFn:l,linePatternGapFn:h}=this._fnTypes,c=[...this.getPositionFormat()];if(c.push(this.iconAtlas||this.hasDasharray?{type:Int8Array,width:3,name:"aExtrude"}:{type:Int8Array,width:2,name:"aExtrude"}),c.push({type:this.options.positionType||Uint16Array,width:1,name:"aLinesofar"}),e&&c.push({type:Uint8Array,width:1,name:"aLineWidth"}),t&&c.push({type:Uint8Array,width:1,name:"aLineStrokeWidth"}),i&&c.push({type:Uint8Array,width:4,name:"aColor"}),n&&c.push({type:Uint8Array,width:4,name:"aStrokeColor"}),s&&c.push({type:Uint8Array,width:1,name:"aOpacity"}),this.dasharrayFn&&c.push({type:Uint8Array,width:4,name:"aDasharray"}),this.dashColorFn&&c.push({type:Uint8Array,width:4,name:"aDashColor"}),this.iconAtlas){const e=this.getIconAtlasMaxValue();c.push({type:e>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return(o||a)&&c.push({type:Int8Array,width:2,name:"aLineDxDy"}),(l||h)&&c.push({type:Int8Array,width:2,name:"aLinePattern"}),c}placeVector(e){const{lineJoinFn:t,lineCapFn:n,lineWidthFn:i,lineHeightFn:s,lineStrokeWidthFn:o,lineStrokeColorFn:a,lineColorFn:l,lineOpacityFn:h,lineDxFn:c,lineDyFn:u,linePatternAnimSpeedFn:f,linePatternGapFn:g}=this._fnTypes,m=this.symbol,A=e.feature,w=A.properties;let T=m.lineJoin||"miter",S=m.lineCap||"butt";if(t&&(T=t(this.options.zoom,w)||"miter"),n&&(S=n(this.options.zoom,w)||"butt"),i){let e=i(this.options.zoom,w);ye(e)&&(this.dynamicAttrs.aLineWidth=1,e=4),pt(e)&&(e=4),this.feaLineWidth=+e}else this.feaLineWidth=+m.lineWidth;if(s){let e=s(this.options.zoom,w);ye(e)&&(this.dynamicAttrs.aLineHeight=1),pt(e)&&(e=this.feaLineWidth),this.feaLineHeight=+e}else this.feaLineHeight=+m.lineHeight||this.feaLineWidth;if(o){let e=o(this.options.zoom,w);ye(e)&&(this.dynamicAttrs.aLineStrokeWidth=1,e=0),pt(e)&&(e=0),this.feaLineStrokeWidth=e}else this.feaLineStrokeWidth=m.lineStrokeWidth||0;if(l&&(this.feaColor=l(this.options.zoom,w)||[255,255,255,255],ye(this.feaColor)?(this.dynamicAttrs.aColor=1,this.feaColor=[0,0,0,0]):this.feaColor=Pt([],this.feaColor)),a&&(this.feaStrokeColor=a(this.options.zoom,w)||[0,0,0,255],ye(this.feaStrokeColor)?(this.dynamicAttrs.aStrokeColor=1,this.feaStrokeColor=[0,0,0,0]):this.feaStrokeColor=Pt([],this.feaStrokeColor)),h){let e=h(this.options.zoom,w);ye(e)&&(this.dynamicAttrs.aOpacity=1,e=1),pt(e)&&(e=1),this.feaOpacity=255*e}if(this.dasharrayFn){let e=this.dasharrayFn(this.options.zoom,w)||[0,0,0,0];if(ye(e)&&(this.dynamicAttrs.aDasharray=1,e=[0,0,0,0]),e.length<4){const t=e;1===e.length?e=[t[0],t[0],t[0],t[0]]:2===e.length?e=[t[0],t[1],t[0],t[1]]:3===e.length&&(e=[t[0],t[1],t[2],t[2]])}this.feaDash=e}if(this.dashColorFn){let e=(this.dashColorFn?this.dashColorFn(this.options.zoom,w):this.symbol.lineDashColor)||[0,0,0,0];ye(e)&&(this.dynamicAttrs.aDashColor=1,e=[0,0,0,0]),e=Pt([],e),this.feaDashColor=e}if(this.iconAtlas){const t=e.getLineResource(),n=this.iconAtlas.glyphMap[t];if(this.feaTexInfo=this.feaTexInfo||[0,0,0,0],n){const{tl:e,displaySize:n}=this.iconAtlas.positions[t];this.feaTexInfo[0]=e[0]+1,this.feaTexInfo[1]=e[1]+1,this.feaTexInfo[2]=n[0]-3,this.feaTexInfo[3]=n[1]-3}else this.feaTexInfo[0]=this.feaTexInfo[1]=this.feaTexInfo[2]=this.feaTexInfo[3]=0}if(c){let e=c(this.options.zoom,w);ye(e)&&(this.dynamicAttrs.aLineDxDy=1,e=0),pt(e)&&(e=0),this.feaLineDx=e}if(u){let e=u(this.options.zoom,w);ye(e)&&(this.dynamicAttrs.aLineDxDy=1,e=0),pt(e)&&(e=0),this.feaLineDy=e}if(f){let e=f(this.options.zoom,w);ye(e)&&(this.dynamicAttrs.aLinePatternAnimSpeed=1,e=0),pt(e)&&(e=0),0!==e&&(this.properties.hasPatternAnim=1),this.feaPatternAnimSpeed=e}if(g){let e=g(this.options.zoom,w);ye(e)&&(this.dynamicAttrs.aLinePatternGap=1,e=0),pt(e)&&(e=0),this.feaLinePatternGap=e}const M=this.options.EXTENT;let C=A.geometry;if(M!==1/0){C=[];const e=[];for(let t=0;t<A.geometry.length;t++){e[0]=A.geometry[t];const n=Ko(e,-1,-1,M+1,M+1);if(3===A.type&&n.length>1){const e=n[0],t=n[n.length-1];Wa(e[0],t[t.length-1])&&(n[0]=t.concat(e.slice(1)),n.length=n.length-1)}C.push(...n)}}const I=this.needAltitudeAttribute()?2:3;for(let e=0;e<C.length;e++){this.offset=this.data.aPosition.getLength()/I;this._addLine(C[e],A,T,S,2,1.05)}}_hasPattern(){return this.iconAtlas&&this.feaTexInfo[2]&&this.feaTexInfo[3]}_addLine(e,t,n,i,s,o){const a=this._hasPattern()||Ba(this.feaDash)||Ba(this.symbol.lineDasharray),l=this.options.isTube;l&&(e=e.map((e=>new bs(e)))),this.overscaling=1;const h=this.options.EXTENT;if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.prevVertex=null,this.symbol.lineGradientProperty&&t.properties&&gt(t.properties.mapbox_clip_start)&&gt(t.properties.mapbox_clip_end)){this.clipStart=+t.properties.mapbox_clip_start,this.clipEnd=+t.properties.mapbox_clip_end;for(let t=0;t<e.length-1;t++)this.totalDistance+=e[t].dist(e[t+1]);this.updateScaledDistance()}const c=3===t.type&&!e.clipped;let u=e.length;for(;u>=2&&Wa(e[u-1],e[u-2]);)u--;let f=0;for(;f<u-1&&Wa(e[f],e[f+1]);)f++;if(u<(c?3:2))return;"bevel"===n&&(s=1.05);const g=this.overscaling<=16?15*h/(512*this.overscaling):0,m={vertexLength:0,primitiveLength:0,currentNormal:null};let A,w,T,S,M;this.e1=this.e2=-1,c&&(A=e[u-2],M=e[f].sub(A)._unit()._perp()),this.ensureDataCapacity(n,u,360,2);for(let t=f;t<u;t++){if(T=t===u-1?c?e[f+1]:void 0:e[t+1],T&&Wa(e[t],T))continue;M&&(S=M),A&&(w=A),A=e[t],T&&A.x===T.x&&A.y===T.y&&(A.x+=1e-4),M=T?T.sub(A)._unit()._perp():S,m.dir=w?A.sub(w)._unit():T.sub(A)._unit(),S=S||M,m.currentNormal=S;let h=S.add(M);0===h.x&&0===h.y||h._unit();const C=S.x*M.x+S.y*M.y,I=h.x*M.x+h.y*M.y,E=0!==I?1/I:1/0,D=2*Math.sqrt(2-2*I),H=I<Ea&&w&&T,N=S.x*M.y-S.y*M.x>0;if(!l&&H&&t>f){const e=A.dist(w);if(e>2*g){const t=A.sub(A.sub(w)._mult(g/e)._round());t.z=A.z,this.updateDistance(w,t),this.addCurrentVertex(t,S,0,0,m),w=t}}const B=w&&T;m.middleVertex=B;let z=B?n:c?"butt":i;if(B&&"round"===z&&(E<o?z="miter":E<=2&&(z="fakeround")),"miter"===z&&E>s&&!l&&(z="bevel"),"bevel"===z&&(E>2&&(z="flipbevel"),E<s&&(z="miter")),w&&this.updateDistance(w,A),"miter"===z)l?(this.addCurrentVertex(A,S,0,0,m),m.dir=T.sub(A)._unit(),this.addCurrentVertex(A,M,0,0,m)):(h._mult(E),this.addCurrentVertex(A,h,0,0,m),a&&(m.currentNormal=M,m.dir=T.sub(A)._unit(),this.addCurrentVertex(A,h,0,0,m)));else if("flipbevel"===z){if(E>100)h=M.mult(-1);else{const e=E*S.add(M).mag()/S.sub(M).mag();h._perp()._mult(e*(N?-1:1))}this.addCurrentVertex(A,h,0,0,m),this.addCurrentVertex(A,h.mult(-1),0,0,m)}else if("bevel"===z||"fakeround"===z){const e=-Math.sqrt(E*E-1),t=N?e:0,n=N?0:e;if(w&&this.addCurrentVertex(A,S,t,n,m),"fakeround"===z){const e=Math.round(180*D/Math.PI/20);for(let t=1;t<e;t++){let n=t/e;if(.5!==n){const e=n-.5;n+=n*e*(n-1)*((1.0904+C*(C*(3.55645-1.43519*C)-3.2452))*e*e+(.848013+C*(.215638*C-1.06021)))}const i=M.sub(S)._mult(n)._add(S)._unit()._mult(N?-1:1);this.addHalfVertex(A,i.x,i.y,!1,N,0,m)}}T&&(m.currentNormal=M,m.dir=T.sub(A)._unit(),this.addCurrentVertex(A,M,-t,-n,m))}else if("butt"===z)this.addCurrentVertex(A,h,0,0,m);else if("square"===z){const e=w?1:-1;this.addCurrentVertex(A,h,e,e,m)}else"round"===z&&(w&&(this.addCurrentVertex(A,S,0,0,m),this.addCurrentVertex(A,S,1,1,m,!0)),T&&(this.addCurrentVertex(A,M,-1,-1,m,!0),this.addCurrentVertex(A,M,0,0,m)));if(!l&&H&&t<u-1){const e=A.dist(T);if(e>2*g){const t=A.add(T.sub(A)._mult(g/e)._round());t.z=A.z,this.updateDistance(A,t),this.addCurrentVertex(t,M,0,0,m),A=t}}}}ensureDataCapacity(e,t,n,i){const s="round"===e?Math.round(n/20)-1:0;super.ensureDataCapacity((6+s)*i,t)}addCurrentVertex(e,t,n,i,s,o=!1){const a=t.x+t.y*n,l=t.y-t.x*n,h=t.y*i-t.x,c=-t.y-t.x*i;let u=0,f=0;if(s.middleVertex){La.x=a,La.y=l;const e=s.currentNormal;if(u=ja(e,La,s.dir),0===n&&0===i)f=-u;else{const t=Da;t.x=e.x,t.y=e.y,t._mult(-1),Fa.x=h,Fa.y=c,f=ja(t,Fa,s.dir)}}this.addHalfVertex(e,a,l,o,!1,n,s,u),this.addHalfVertex(e,h,c,o,!0,-i,s,f),this.prevVertex&&Wa(e,this.prevVertex)||(this.prevVertex=e),this.distance>Ra/2&&0===this.totalDistance&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(e,t,n,i,s,o))}addHalfVertex({x:e,y:t,z:n},i,s,o,a,l,h,c){this.fillData(this.data,e,t,n||0,i,s,o,a,1*this.scaledDistance,c);const u=h.vertexLength++;this.e1>=0&&this.e2>=0&&(this.addElements(this.e1,this.e2,u),h.primitiveLength++),a?this.e2=u:this.e1=u}fillData(e,t,n,i,s,o,a,l,h,c){const{lineWidthFn:u,lineStrokeWidthFn:f,lineStrokeColorFn:g,lineColorFn:m,lineOpacityFn:A,lineDxFn:w,lineDyFn:T,linePatternAnimSpeedFn:S,linePatternGapFn:M}=this._fnTypes;this.fillPosition(e,t,n,i);let C=Oa*s;C=(Math.sign(C)||1)*((Math.floor(Math.abs(C))>>1<<1)+ +a);let I=Oa*o;I=(Math.sign(I)||1)*((Math.floor(Math.abs(I))>>1<<1)+ +l);let E=e.aExtrude.currentIndex;e.aExtrude[E++]=C,e.aExtrude[E++]=I,(this.iconAtlas||this.hasDasharray)&&(e.aExtrude[E++]=Oa*c),e.aExtrude.currentIndex=E,E=e.aLinesofar.currentIndex,e.aLinesofar[E++]=h,e.aLinesofar.currentIndex=E,u&&(E=e.aLineWidth.currentIndex,e.aLineWidth[E++]=Math.round(2*this.feaLineWidth),e.aLineWidth.currentIndex=E),f&&(E=e.aLineStrokeWidth.currentIndex,e.aLineStrokeWidth[E++]=Math.round(2*this.feaLineStrokeWidth),e.aLineStrokeWidth.currentIndex=E),m&&(E=e.aColor.currentIndex,e.aColor[E++]=this.feaColor[0],e.aColor[E++]=this.feaColor[1],e.aColor[E++]=this.feaColor[2],e.aColor[E++]=this.feaColor[3],e.aColor.currentIndex=E),g&&(E=e.aStrokeColor.currentIndex,e.aStrokeColor[E++]=this.feaStrokeColor[0],e.aStrokeColor[E++]=this.feaStrokeColor[1],e.aStrokeColor[E++]=this.feaStrokeColor[2],e.aStrokeColor[E++]=this.feaStrokeColor[3],e.aStrokeColor.currentIndex=E),A&&(E=e.aOpacity.currentIndex,e.aOpacity[E++]=this.feaOpacity,e.aOpacity.currentIndex=E),this.dasharrayFn&&(E=e.aDasharray.currentIndex,e.aDasharray[E++]=this.feaDash[0],e.aDasharray[E++]=this.feaDash[1],e.aDasharray[E++]=this.feaDash[2],e.aDasharray[E++]=this.feaDash[3],e.aDasharray.currentIndex=E),this.dashColorFn&&(E=e.aDashColor.currentIndex,e.aDashColor[E++]=this.feaDashColor[0],e.aDashColor[E++]=this.feaDashColor[1],e.aDashColor[E++]=this.feaDashColor[2],e.aDashColor[E++]=this.feaDashColor[3],e.aDashColor.currentIndex=E),this.iconAtlas&&(E=e.aTexInfo.currentIndex,e.aTexInfo[E++]=this.feaTexInfo[0],e.aTexInfo[E++]=this.feaTexInfo[1],e.aTexInfo[E++]=this.feaTexInfo[2],e.aTexInfo[E++]=this.feaTexInfo[3],e.aTexInfo.currentIndex=E),(w||T)&&(E=e.aLineDxDy.currentIndex,e.aLineDxDy[E++]=this.feaLineDx||0,e.aLineDxDy[E++]=this.feaLineDy||0,e.aLineDxDy.currentIndex=E),(S||M)&&(E=e.aLinePattern.currentIndex,e.aLinePattern[E++]=127*(this.feaPatternAnimSpeed||0),e.aLinePattern[E++]=10*(this.feaLinePatternGap||0),e.aLinePattern.currentIndex=E),this.maxPos=Math.max(this.maxPos,Math.abs(t)+1,Math.abs(n)+1)}addElements(e,t,n){super.addElements(this.offset+e,this.offset+t,this.offset+n)}_filterPolygonEdges(e){const t=this.options.EXTENT,n=this.elements;for(let i=0;i<n.length;i+=3)if(t===1/0||!Na(this.data.aPosition,n[i],n[i+1],3,t)&&!Na(this.data.aPosition,n[i+1],n[i+2],3,t)){let t=e.currentIndex;e[t++]=n[i],e[t++]=n[i+1],e[t++]=n[i+2],e.currentIndex=t}}_filterLine(e){if(e.length<=1)return e;const t=[],n=this.options.EXTENT;let i,s=!0;for(i=0;i<e.length-1;i++){const o=Ha(e[i],e[i+1],n);o&&s||(t.push(e[i]),s=o)}return s||t.push(e[i]),t}updateDistance(e,t){if(this.options.isTube){const n=e.dist(t),i=Tt(this.options)*(t.z-e.z);this.distance+=Math.sqrt(n*n+i*i)}else this.distance+=e.dist(t);this.updateScaledDistance()}updateScaledDistance(){this.scaledDistance=this.totalDistance>0?(this.clipStart+(this.clipEnd-this.clipStart)*this.distance/this.totalDistance)*(Ra-1):this.distance}}function Ha(e,t,n){return n!==1/0&&(e.x<0&&t.x<0||e.x>n&&t.x>n||e.y<0&&t.y<0||e.y>n&&t.y>n)}function Na(e,t,n,i,s){if(s===1/0)return!1;const o=Math.floor(.5*e[t*i]),a=Math.floor(.5*e[t*i+1]),l=Math.floor(.5*e[n*i]),h=Math.floor(.5*e[n*i+1]);return o===l&&(o<0||o>s)&&a!==h||a===h&&(a<0||a>s)&&o!==l}function Ba(e){if(!Array.isArray(e))return!1;for(let t=0;t<e.length;t++)if(e[t])return!0;return!1}const za=[],Ua=[];function ja(e,t,n){const i=e.mag(),s=t.mag();ka(za,n.x,n.y),ka(Ua,t.x,t.y);const o=(a=za)[0]*(l=Ua)[0]+a[1]*l[1];var a,l;return-Math.sign(o)*Math.sqrt(s*s-i*i)}function Wa(e,t){return e.equals(t)&&e.z===t.z}var qa="undefined"!=typeof Float32Array?Float32Array:Array;function Za(e,t,n,i){return e[0]=t,e[1]=n,e[2]=i,e}var Xa=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e};!function(){var e=new qa(3);qa!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0)}();const Ya=[],$a=[],Ka=[],el=[],nl=[],il=[],ol=[],al=[];function ll(e,t,n,i,s,o){Za(nl,e[3*t],e[3*t+1],e[3*t+2]),Za(il,e[3*n],e[3*n+1],e[3*n+2]),Za(ol,e[3*i],e[3*i+1],e[3*i+2]);const a=Xa($a,ol,il),l=Xa(Ka,nl,il),h=function(e,t,n){var i=t[0],s=t[1],o=t[2],a=n[0],l=n[1],h=n[2];return e[0]=s*h-o*l,e[1]=o*a-i*h,e[2]=i*l-s*a,e}(el,a,l);!function(e,t){var n=t[0],i=t[1],s=t[2],o=n*n+i*i+s*s;o>0&&(o=1/Math.sqrt(o),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o)}(al,h),s[3*t]=s[3*t]||0,s[3*n]=s[3*n]||0,s[3*i]=s[3*i]||0,s[3*t+1]=s[3*t+1]||0,s[3*n+1]=s[3*n+1]||0,s[3*i+1]=s[3*i+1]||0,s[3*t+2]=s[3*t+2]||0,s[3*n+2]=s[3*n+2]||0,s[3*i+2]=s[3*i+2]||0,s[3*t]+=al[0],s[3*n]+=al[0],s[3*i]+=al[0],s[3*t+1]+=al[1],s[3*n+1]+=al[1],s[3*i+1]+=al[1],s[3*t+2]+=al[2],s[3*n+2]+=al[2],s[3*i+2]+=al[2],o[t]+=1,o[n]+=1,o[i]+=1}const hl=Math.pow(2,16)/1,cl=45*Math.PI/100;function ul(e,t,n=2){const i=t&&t.length,s=i?t[0]*n:e.length;let o=fl(e,0,s,n,!0);const a=[];if(!o||o.next===o.prev)return a;let l,h,c;if(i&&(o=function(e,t,n,i){const s=[];for(let n=0,o=t.length;n<o;n++){const a=fl(e,t[n]*i,n<o-1?t[n+1]*i:e.length,i,!1);a===a.next&&(a.steiner=!0),s.push(wl(a))}s.sort(_l);for(let e=0;e<s.length;e++)n=vl(s[e],n);return n}(e,t,o,n)),e.length>80*n){l=1/0,h=1/0;let t=-1/0,i=-1/0;for(let o=n;o<s;o+=n){const n=e[o],s=e[o+1];n<l&&(l=n),s<h&&(h=s),n>t&&(t=n),s>i&&(i=s)}c=Math.max(t-l,i-h),c=0!==c?32767/c:0}return pl(o,a,n,l,h,c,0),a}function fl(e,t,n,i,s){let o;if(s===function(e,t,n,i){let s=0;for(let o=t,a=n-i;o<n;o+=i)s+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return s}
/*!
  	 * from @turf/bboxClip
  	 * https://github.com/Turfjs/turf
  	 * MIT LICENSE
  	 */(e,t,n,i)>0)for(let s=t;s<n;s+=i)o=Dl(s/i|0,e[s],e[s+1],o);else for(let s=n-i;s>=t;s-=i)o=Dl(s/i|0,e[s],e[s+1],o);return o&&Pl(o,o.next)&&(Fl(o),o=o.next),o}function dl(e,t){if(!e)return e;t||(t=e);let n,i=e;do{if(n=!1,i.steiner||!Pl(i,i.next)&&0!==Cl(i.prev,i,i.next))i=i.next;else{if(Fl(i),i=t=i.prev,i===i.next)break;n=!0}}while(n||i!==t);return t}function pl(e,t,n,i,s,o,a){if(!e)return;!a&&o&&function(e,t,n,i){let s=e;do{0===s.z&&(s.z=bl(s.x,s.y,t,n,i)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==e);s.prevZ.nextZ=null,s.prevZ=null,function(e){let t,n=1;do{let i,s=e;e=null;let o=null;for(t=0;s;){t++;let a=s,l=0;for(let e=0;e<n&&(l++,a=a.nextZ,a);e++);let h=n;for(;l>0||h>0&&a;)0!==l&&(0===h||!a||s.z<=a.z)?(i=s,s=s.nextZ,l--):(i=a,a=a.nextZ,h--),o?o.nextZ=i:e=i,i.prevZ=o,o=i;s=a}o.nextZ=null,n*=2}while(t>1)}(s)}(e,i,s,o);let l=e;for(;e.prev!==e.next;){const h=e.prev,c=e.next;if(o?ml(e,i,s,o):gl(e))t.push(h.i,e.i,c.i),Fl(e),e=c.next,l=c.next;else if((e=c)===l){a?1===a?pl(e=Al(dl(e),t),t,n,i,s,o,2):2===a&&yl(e,t,n,i,s,o):pl(dl(e),t,n,i,s,o,1);break}}}function gl(e){const t=e.prev,n=e,i=e.next;if(Cl(t,n,i)>=0)return!1;const s=t.x,o=n.x,a=i.x,l=t.y,h=n.y,c=i.y,u=Math.min(s,o,a),f=Math.min(l,h,c),g=Math.max(s,o,a),m=Math.max(l,h,c);let A=i.next;for(;A!==t;){if(A.x>=u&&A.x<=g&&A.y>=f&&A.y<=m&&Sl(s,l,o,h,a,c,A.x,A.y)&&Cl(A.prev,A,A.next)>=0)return!1;A=A.next}return!0}function ml(e,t,n,i){const s=e.prev,o=e,a=e.next;if(Cl(s,o,a)>=0)return!1;const l=s.x,h=o.x,c=a.x,u=s.y,f=o.y,g=a.y,m=Math.min(l,h,c),A=Math.min(u,f,g),w=Math.max(l,h,c),T=Math.max(u,f,g),S=bl(m,A,t,n,i),M=bl(w,T,t,n,i);let C=e.prevZ,I=e.nextZ;for(;C&&C.z>=S&&I&&I.z<=M;){if(C.x>=m&&C.x<=w&&C.y>=A&&C.y<=T&&C!==s&&C!==a&&Sl(l,u,h,f,c,g,C.x,C.y)&&Cl(C.prev,C,C.next)>=0)return!1;if(C=C.prevZ,I.x>=m&&I.x<=w&&I.y>=A&&I.y<=T&&I!==s&&I!==a&&Sl(l,u,h,f,c,g,I.x,I.y)&&Cl(I.prev,I,I.next)>=0)return!1;I=I.nextZ}for(;C&&C.z>=S;){if(C.x>=m&&C.x<=w&&C.y>=A&&C.y<=T&&C!==s&&C!==a&&Sl(l,u,h,f,c,g,C.x,C.y)&&Cl(C.prev,C,C.next)>=0)return!1;C=C.prevZ}for(;I&&I.z<=M;){if(I.x>=m&&I.x<=w&&I.y>=A&&I.y<=T&&I!==s&&I!==a&&Sl(l,u,h,f,c,g,I.x,I.y)&&Cl(I.prev,I,I.next)>=0)return!1;I=I.nextZ}return!0}function Al(e,t){let n=e;do{const i=n.prev,s=n.next.next;!Pl(i,s)&&kl(i,n,n.next,s)&&Rl(i,s)&&Rl(s,i)&&(t.push(i.i,n.i,s.i),Fl(n),Fl(n.next),n=e=s),n=n.next}while(n!==e);return dl(n)}function yl(e,t,n,i,s,o){let a=e;do{let e=a.next.next;for(;e!==a.prev;){if(a.i!==e.i&&Ml(a,e)){let l=Ll(a,e);return a=dl(a,a.next),l=dl(l,l.next),pl(a,t,n,i,s,o,0),void pl(l,t,n,i,s,o,0)}e=e.next}a=a.next}while(a!==e)}function _l(e,t){let n=e.x-t.x;return 0===n&&(n=e.y-t.y,0===n)&&(n=(e.next.y-e.y)/(e.next.x-e.x)-(t.next.y-t.y)/(t.next.x-t.x)),n}function vl(e,t){const n=function(e,t){let n=t;const i=e.x,s=e.y;let o,a=-1/0;if(Pl(e,n))return n;do{if(Pl(e,n.next))return n.next;if(s<=n.y&&s>=n.next.y&&n.next.y!==n.y){const e=n.x+(s-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(e<=i&&e>a&&(a=e,o=n.x<n.next.x?n:n.next,e===i))return o}n=n.next}while(n!==t);if(!o)return null;const l=o,h=o.x,c=o.y;let u=1/0;n=o;do{if(i>=n.x&&n.x>=h&&i!==n.x&&Tl(s<c?i:a,s,h,c,s<c?a:i,s,n.x,n.y)){const t=Math.abs(s-n.y)/(i-n.x);Rl(n,e)&&(t<u||t===u&&(n.x>o.x||n.x===o.x&&xl(o,n)))&&(o=n,u=t)}n=n.next}while(n!==l);return o}(e,t);if(!n)return t;const i=Ll(n,e);return dl(i,i.next),dl(n,n.next)}function xl(e,t){return Cl(e.prev,e,t.prev)<0&&Cl(t.next,e,e.next)<0}function bl(e,t,n,i,s){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*s|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*s|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function wl(e){let t=e,n=e;do{(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next}while(t!==e);return n}function Tl(e,t,n,i,s,o,a,l){return(s-a)*(t-l)>=(e-a)*(o-l)&&(e-a)*(i-l)>=(n-a)*(t-l)&&(n-a)*(o-l)>=(s-a)*(i-l)}function Sl(e,t,n,i,s,o,a,l){return!(e===a&&t===l)&&Tl(e,t,n,i,s,o,a,l)}function Ml(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){let n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&kl(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&(Rl(e,t)&&Rl(t,e)&&function(e,t){let n=e,i=!1;const s=(e.x+t.x)/2,o=(e.y+t.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&s<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==e);return i}(e,t)&&(Cl(e.prev,e,t.prev)||Cl(e,t.prev,t))||Pl(e,t)&&Cl(e.prev,e,e.next)>0&&Cl(t.prev,t,t.next)>0)}function Cl(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function Pl(e,t){return e.x===t.x&&e.y===t.y}function kl(e,t,n,i){const s=El(Cl(e,t,n)),o=El(Cl(e,t,i)),a=El(Cl(n,i,e)),l=El(Cl(n,i,t));return s!==o&&a!==l||!(0!==s||!Ol(e,n,t))||!(0!==o||!Ol(e,i,t))||!(0!==a||!Ol(n,e,i))||!(0!==l||!Ol(n,t,i))}function Ol(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function El(e){return e>0?1:e<0?-1:0}function Rl(e,t){return Cl(e.prev,e,e.next)<0?Cl(e,t,e.next)>=0&&Cl(e,e.prev,t)>=0:Cl(e,t,e.prev)<0||Cl(e,e.next,t)<0}function Ll(e,t){const n=Hl(e.i,e.x,e.y),i=Hl(t.i,t.x,t.y),s=e.next,o=t.prev;return e.next=t,t.prev=e,n.next=s,s.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function Dl(e,t,n,i){const s=Hl(e,t,n);return i?(s.next=i.next,s.prev=i,i.next.prev=s,i.next=s):(s.prev=s,s.next=s),s}function Fl(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function Hl(e,t,n){return{i:e,x:t,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}const Nl=[],Bl=[];function zl(e,t){var n,i,s,a,l,h,c;for(i=1;i<=8;i*=2){for(n=[],a=!(Ul(s=e[e.length-1],t)&i),l=0;l<e.length;l++){if((c=!(Ul(h=e[l],t)&i))!==a){const e=Gl(s,h,i,t);n.push(void 0!==h.x?new o(e[0],e[1]):e)}c&&n.push(h),s=h,a=c}if(!(e=n).length)break}return n}function Gl(e,t,n,i){return Nl[0]=void 0===e.x?e[0]:e.x,Nl[1]=void 0===e.y?e[1]:e.y,e=Nl,Bl[0]=void 0===t.x?t[0]:t.x,Bl[1]=void 0===t.y?t[1]:t.y,t=Bl,8&n?[e[0]+(t[0]-e[0])*(i[3]-e[1])/(t[1]-e[1]),i[3]]:4&n?[e[0]+(t[0]-e[0])*(i[1]-e[1])/(t[1]-e[1]),i[1]]:2&n?[i[2],e[1]+(t[1]-e[1])*(i[2]-e[0])/(t[0]-e[0])]:1&n?[i[0],e[1]+(t[1]-e[1])*(i[0]-e[0])/(t[0]-e[0])]:null}function Ul(e,t){Nl[0]=void 0===e.x?e[0]:e.x,Nl[1]=void 0===e.y?e[1]:e.y;var n=0;return(e=Nl)[0]<t[0]?n|=1:e[0]>t[2]&&(n|=2),e[1]<t[1]?n|=4:e[1]>t[3]&&(n|=8),n}const Vl=[0,0,0,0],jl=-9999999,Wl=[{type:Int16Array,width:3,name:"aPosition"}];class Va extends Ns{constructor(e,t,n){(t=ut({},t)).lineJoin="miter",t.lineCap="butt",super(e,t,n),this.options.radialSegments%2==1&&this.options.radialSegments--}getFormat(){const{lineWidthFn:e,lineColorFn:t,lineOpacityFn:n,linePatternAnimSpeedFn:i,linePatternGapFn:s}=this._fnTypes,o=[...this.getPositionFormat(),{type:Int8Array,width:4,name:"aTubeNormal"},{type:this.options.positionType||Uint16Array,width:1,name:"aLinesofar"}];if(this.iconAtlas){o.push({type:Int8Array,width:1,name:"aNormalDistance"});const e=this.getIconAtlasMaxValue();o.push({type:e>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return e&&o.push({type:Uint16Array,width:1,name:"aLineWidth"}),t&&o.push({type:Uint8Array,width:4,name:"aColor"}),n&&o.push({type:Uint8Array,width:1,name:"aOpacity"}),i&&o.push({type:Int8Array,width:1,name:"aLinePatternAnimSpeed"}),s&&o.push({type:Int8Array,width:1,name:"aLinePatternGap"}),o}ensureDataCapacity(e,t,n,i){return super.ensureDataCapacity(e,t,n,i*(this.options.radialSegments/2))}addHalfVertex(e,t,n,i,s,o,a,l){const{x:h,y:c,z:u}=e,f=1*this.scaledDistance,g=this.options.radialSegments/2,{x:m,y:A,z:w}=a.dir,T=function(e,t,n,i,s,o,a,l){Sa(ql,n,i,s),Sa(Zl,o,a,0),Ca(Xl,ql,Zl),Ma(Zl,Zl),Ma(Xl,Xl),Yl[t]||(Yl[t]=[]);const h=Yl[t];for(var c=0;c<t;c++){const e=Math.PI*c/t,n=1-Math.abs(e-0)/(Math.PI/2);h[c]=h[c]||[],Jl(Zl,Xl,h[c],1,e,n*(l?-1:1))}return h}(0,g,m,A,w,t,n,s);this.prevVertex&&this.fillTubeElements(s),this.fillData(this.data,h,c,u||0,T,s,f,l)}fillTubeElements(e){const t=this.options.radialSegments/2,n=this.needAltitudeAttribute()?2:3,i=this.data.aPosition.getLength()/n;for(let n=0;n<t;n++){const s=n+i-2*t;let o,a;n===t-1&&e?(o=n+i-2*t+1,a=n+i-2*t-2*t+1):(o=n+i+1,a=n+i+1-2*t),super.addElements(n+i-this.offset,o-this.offset,s-this.offset),super.addElements(s-this.offset,o-this.offset,a-this.offset)}}fillData(e,t,n,i,s,o,a,l){const{lineWidthFn:h,lineColorFn:c,lineOpacityFn:u,linePatternAnimSpeedFn:f,linePatternGapFn:g}=this._fnTypes,m=s.length;for(let o=0;o<m;o++){this.fillPosition(e,t,n,i),Ia(s[o],s[o],Oa);let m=e.aTubeNormal.currentIndex;for(let t=0;t<s[o].length;t++)e.aTubeNormal[m++]=s[o][t];if(e.aTubeNormal.currentIndex=m,m=e.aLinesofar.currentIndex,e.aLinesofar[m++]=a,e.aLinesofar.currentIndex=m,this.iconAtlas&&(m=e.aNormalDistance.currentIndex,e.aNormalDistance[m++]=Oa*l,e.aNormalDistance.currentIndex=m,m=e.aTexInfo.currentIndex,e.aTexInfo[m++]=this.feaTexInfo[0],e.aTexInfo[m++]=this.feaTexInfo[1],e.aTexInfo[m++]=this.feaTexInfo[2],e.aTexInfo[m++]=this.feaTexInfo[3],e.aTexInfo.currentIndex=m),h){const t=Mt(this.options.metric);let n=this.feaLineWidth*t;isNaN(n)&&(n=0),m=e.aLineWidth.currentIndex,e.aLineWidth[m++]=Math.round(n),e.aLineWidth.currentIndex=m}c&&(m=e.aColor.currentIndex,e.aColor[m++]=this.feaColor[0],e.aColor[m++]=this.feaColor[1],e.aColor[m++]=this.feaColor[2],e.aColor[m++]=this.feaColor[3],e.aColor.currentIndex=m),u&&(m=e.aOpacity.currentIndex,e.aOpacity[m++]=this.feaOpacity,e.aOpacity.currentIndex=m),f&&(m=e.aLinePatternAnimSpeed.currentIndex,e.aLinePatternAnimSpeed[m++]=127*(this.feaPatternAnimSpeed||0),e.aLinePatternAnimSpeed.currentIndex=m),g&&(m=e.aLinePatternGap.currentIndex,e.aLinePatternGap[m++]=10*(this.feaLinePatternGap||0),e.aLinePatternGap.currentIndex=m)}this.maxPos=Math.max(this.maxPos,Math.abs(t)+1,Math.abs(n)+1)}createDataPack(e,t){const n=super.createDataPack(e,t);return n&&(n.is2D=!1),n}}const ql=[],Zl=[],Xl=[],Yl={};function Jl(e,t,n,i,s,o){return Pa(n,i*(Math.cos(s)*e[0]+Math.sin(s)*t[0]),i*(Math.cos(s)*e[1]+Math.sin(s)*t[1]),i*(Math.cos(s)*e[2]+Math.sin(s)*t[2]),o),n}const Ql=[],$l=[],Kl=[],eh=[],th=[];class Ja{constructor(e){this.max=e,this.reset()}reset(){return this.data={},this.order=[],this}clear(){this.reset()}add(e,t){return this.has(e)?(this.order.splice(this.order.indexOf(e),1),this.data[e]=t,this.order.push(e)):(this.data[e]=t,this.order.push(e),this.order.length>this.max&&this.getAndRemove(this.order[0])),this}has(e){return e in this.data}keys(){return this.order}getAndRemove(e){if(!this.has(e))return null;const t=this.data[e];return delete this.data[e],this.order.splice(this.order.indexOf(e),1),t}get(e){return this.has(e)?this.data[e]:null}remove(e){return this.has(e)?(delete this.data[e],this.order.splice(this.order.indexOf(e),1),this):this}setMaxSize(e){for(this.max=e;this.order.length>this.max;)this.getAndRemove(this.order[0]);return this}}
/*!
  	 * based on @mapbox/tiny-sdf
  	 * https://github.com/mapbox/tiny-sdf
  	 * @License BSD 2-Clause
  	 */var nh=1e20;function rh(e,t,n,i,s,o,a){this.fontSize=e||24,this.buffer=void 0===t?3:t,this.cutoff=i||.25,this.fontFamily=s||"sans-serif",this.fontWeight=o||"normal",this.fontStyle=a||"normal",this.radius=n||8;var l=this.size=this.fontSize+2*this.buffer;this.canvas="undefined"==typeof document?new OffscreenCanvas(l,l):document.createElement("canvas"),this.canvas.width=this.canvas.height=l,this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),this.ctx.font=this.fontStyle+" "+this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(l*l),this.gridInner=new Float64Array(l*l),this.f=new Float64Array(l),this.z=new Float64Array(l+1),this.v=new Uint16Array(l),this.middle=Math.round(l/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}function ih(e,t,n,i,s,o){for(var a=0;a<t;a++)sh(e,a,t,n,i,s,o);for(var l=0;l<n;l++)sh(e,l*t,1,t,i,s,o)}function sh(e,t,n,i,s,o,a){var l,h,c,u;for(o[0]=0,a[0]=-nh,a[1]=nh,l=0;l<i;l++)s[l]=e[t+l*n];for(l=1,h=0,c=0;l<i;l++){do{c=(s[l]-s[u=o[h]]+l*l-u*u)/(l-u)/2}while(c<=a[h]&&--h>-1);o[++h]=l,a[h]=c,a[h+1]=nh}for(l=0,h=0;l<i;l++){for(;a[h+1]<l;)h++;e[t+l*n]=s[u=o[h]]+(l-u)*(l-u)}}rh.prototype.draw=function(e,t,n){this.ctx.clearRect(0,0,this.size,this.size),this.ctx.textBaseline="top",this.ctx.fillText(e,this.buffer,this.buffer);for(var i=this.ctx.getImageData(0,0,t,n),s=new Uint8ClampedArray(t*n),o=0;o<t*n;o++){var a=i.data[4*o+3]/255;this.gridOuter[o]=1===a?0:0===a?nh:Math.pow(Math.max(0,.5-a),2),this.gridInner[o]=1===a?nh:0===a?0:Math.pow(Math.max(0,a-.5),2)}for(ih(this.gridOuter,t,n,this.f,this.v,this.z),ih(this.gridInner,t,n,this.f,this.v,this.z),o=0;o<t*n;o++){var l=Math.sqrt(this.gridOuter[o])-Math.sqrt(this.gridInner[o]);s[o]=Math.round(255-255*(l/this.radius+this.cutoff))}return s};let oh=0;function ah(e){const t={width:e.bitmap.width,height:e.bitmap.height,data:new Uint8ClampedArray(e.bitmap.data)};return{charCode:e.charCode,bitmap:t,metrics:ut({},e.metrics)}}var hh=Object.freeze({__proto__:null,calculateSignedArea:C,clipPolygon:zl,convertGeometry:Y,convertRTLText:Yo,generatePickingIndiceIndex:z,getFeaAltitudeAndHeight:D,getIndexArrayType:W,getPosArrayType:q,getUnsignedArrayType:Z,packPosition:Dt,unpackPosition:function(e,t,n,i){const s=(Math.sign(t)||1)*(Math.abs(t)%Ht),o=(Math.sign(n)||1)*(Math.abs(n)%Ht),a=Math.floor(Math.abs(t)/Ht),l=Math.floor(Math.abs(n)/Ht);return e[0]=s,e[1]=o,e[2]=Math.sign(i+1e-5)*(2*a+l)*Nt+i,e}});const ch={},uh={},fh=[];var dh=Object.freeze({__proto__:null,loadSymbolFnTypes:function e(t,n){if(!t)return null;var i=!1;if(Array.isArray(t)){var s,o=[];for(let a=0;a<t.length;a++)(s=e(t[a],n))?(o.push(s),i=!0):o.push(t[a]);return i?o:t}var a={__fn_types_loaded:!0};const l=[];for(const e in t)xt(t,e)&&l.push(e);const h=function(e){Object.defineProperty(a,e,{get:function(){return this["__fn_"+e]||(this["__fn_"+e]=_e(this["_"+e])),this["__fn_"+e].apply(this,n())},set:function(t){this["_"+e]=t},configurable:!0,enumerable:!0})},c={},u=function(e,t){Object.defineProperty(a,e,{get:function(){this["__fn_"+e]||(this["__fn_"+e]=zs(this["_"+e],t));const i=n()[0];c.zoom=i;try{return this["__fn_"+e].evaluateWithoutErrorHandling(c,ch,uh,null,fh)}catch(e){return null}},set:function(t){this["_"+e]=t},configurable:!0,enumerable:!0})};for(let e=0,n=l.length;e<n;e++){const n=l[e];if(ye(t[n]))i=!0,a["_"+n]=t[n],h(n);else if(Gs(t[n])){i=!0;const e=Zs(n);a["_"+n]=t[n],u(n,e)}else a[n]=t[n]}return i?a:t}});const gh={polygonPatternFile:1,markerFile:1,markerPlacement:1,markerSpacing:1,textName:1,textFaceName:1,textPlacement:1,textSpacing:1,lineJoin:1,lineCap:1,linePatternFile:1},mh={textHorizontalAlignment:1,textVerticalAlignment:1,textWrapWidth:1,markerHorizontalAlignment:1,markerVerticalAlignment:1},Ah={lineDasharray:1,topPolygonFill:1,bottomPolygonFill:1};Object.assign(mh,gh),Object.assign(Ah,gh),e.ArrayPool=oo,e.CirclePack=class extends mo{getFormat(){return Wl}placeVector(e,t){const n=this._getAnchors(e,t);if(0===n.length)return;const i=this.data,s=this.getAltitude(e.feature.properties);let o=i.aPosition.getLength()/Wl[0].width;for(let e=0;e<n.length;e++){const t=n[e];i.aPosition.push(2*t.x+0,2*t.y+0,s),i.aPosition.push(2*t.x+1,2*t.y+0,s),i.aPosition.push(2*t.x+1,2*t.y+1,s),i.aPosition.push(2*t.x+0,2*t.y+1,s),this.addElements(o,o+1,o+2),this.addElements(o,o+2,o+3),o+=4;const a=Math.max(Math.abs(2*t.x+1),Math.abs(2*t.y+1));a>this.maxPos&&(this.maxPos=a)}}_getAnchors(e,t){const{feature:n,symbol:i}=e,s=this._getPlacement(e,i),o=n.properties,{markerSpacingFn:a}=this._fnTypes,l=((a?a(null,o):i.markerSpacing)||250)*t;return ga(e,null,null,t,this.options.EXTENT,s,l)}_getPlacement(e,t){return this._fnTypes.markerPlacementFn?this._fnTypes.markerPlacementFn(this.options.zoom,e.feature.properties):t.markerPlacement}},e.DEFAULT_TEX_WIDTH=23.25,e.FilterUtil=Xs,e.FuncTypeUtil=dh,e.GlyphRequestor=class{constructor(e,t=15,n,i){this.entries={},this._cachedFont={},this._cache=new Ja(2048,(function(){})),this._framer=e,this._limit=t,this._isCompactChars=n,this._sdfURL=i}_isValidSDFURL(e){return e&&e.indexOf("{stack}")>=0&&e.indexOf("{range}")>0}getGlyphs(e,t){if(!e||!Object.keys(e).length)return void t(null,{glyphs:null});if(this._isValidSDFURL(this._sdfURL))return void this._requestRemoteSDF(e,t);const n=this.entries,i=e.options;let s=!0;i&&(s=!1!==i.isCharsCompact),s=s||this._isCompactChars;const o=(i,o,l)=>{let h=0,c=0;for(const t in e)if("options"!==t){n[t]=n[t]||{},o[t]=o[t]||{};for(const u in e[t]){if(c++,c<=i)continue;const e=s&&!Oo(+u),f=t+":"+u+":"+e;let g;if(this._cache.has(f)?g=this._cache.get(f):(g=this._tinySDF(n[t],t,u,e),this._cache.add(f,g),h++),g=ah(g),o[t][u]=g,l.push(g.bitmap.data.buffer),this._framer&&h>this._limit)return void this._framer(a(c,o,l))}}t(null,{glyphs:o,buffers:l})};function a(e,t,n){return()=>{o(e,t,n)}}o(0,{},[])}_requestRemoteSDF(e,t){const n=[];for(const t in e)for(const i of e[t])n.push(this._requestGlyph(t,i));Promise.all(n).then((e=>{t(null,e)}))}_requestGlyph(){return Promise.resolve(null)}_tinySDF(e,t,n,i){const s=t;let o=e.tinySDF;const a=i?-1:2;if(!o){let t="400";/bolder/i.test(s)?t="1000":/bold/i.test(s)?t="900":/medium/i.test(s)?t="500":/light/i.test(s)&&(t="200"),o=e.tinySDF=new rh(24,2,8,.25,s,t)}const l=String.fromCodePoint(n),h=o.ctx.measureText(l),c=Math.round(h.width),u=o.draw(l,c+4,28);if(oh<4){const e="undefined"!=typeof document&&document.getElementById("sdf-debug-"+oh++);e&&(e.width=c+4,e.height=o.canvas.height,e.getContext("2d").drawImage(o.canvas,0,0))}return{charCode:n,bitmap:{width:c+4,height:28,data:u},metrics:{width:c,height:24,left:1,top:-2,advance:c+2+a}}}},e.INVALID_TEX_COORD=jl,e.LRUCache=Ja,e.LineExtrusionPack=class extends Ns{constructor(e,t,n){super(e,t,n),this._hasALineHeight=n.altitudeProperty}getFormat(){const{lineColorFn:e,lineWidthFn:t}=this._fnTypes,n=[{type:Math.max(Math.abs(this.maxPosZ),Math.abs(this.minPosZ))>=Math.pow(2,15)?Float32Array:Int16Array,width:3,name:"aPosition"},{type:Uint16Array,width:1,name:"aLinesofar"},{type:Uint8Array,width:1,name:"aUp"},{type:Int16Array,width:3,name:"aExtrudedPosition"},{type:Int8Array,width:2,name:"aExtrude"}];return e&&n.push({type:Uint8Array,width:4,name:"aColor"}),t&&n.push({type:Uint8Array,width:1,name:"aLineWidth"}),this._hasALineHeight&&n.push({type:Float32Array,width:1,name:"aLineHeight"}),n}placeVector(e){const t=e.feature;if(this._hasALineHeight){const{altitudeScale:e,altitudeProperty:n,defaultAltitude:i,heightProperty:s,defaultHeight:o,minHeightProperty:a}=this.options,{altitude:l,height:h}=D(t,e,n,i,s,o,a);this.feaAltitude=l,this.feaMinHeight=(l-h)/l*32767,l>this.maxAltitude&&(this.maxAltitude=l)}return super.placeVector(e)}needAltitudeAttribute(){return!1}_addLine(e,t,n,i,s,o){const a=this.data.aPosition.getLength()/3;super._addLine(e,t,n,i,s,o);const l=this.data.aPosition.getLength()/3,h=this.data.aPosition.getLength()/3-this.offset;if(!(3===t.type)&&h>0&&!1!==this.options.side){const e=!1!==this.options.top?1:0,t=e+4;let n=this.data.aPosition.getLength()/3;for(const e in this.data){const t=this.data[e],i=t.getLength()/n;let s=t.currentIndex;for(let e=0;e<i;e++)t[s++]=t[a*i+3*i+e];t.currentIndex=s}n=this.data.aPosition.getLength()/3;for(const e in this.data){const i=this.data[e],s=i.getLength()/n;let o=i.currentIndex;for(let e=0;e<s;e++)i[o++]=i[a*s+s*t+e];i.currentIndex=o}n=this.data.aPosition.getLength()/3;for(const e in this.data){const i=this.data[e],s=i.getLength()/n;let o=i.currentIndex;for(let e=0;e<s;e++)i[o++]=i[a*s+s*(t+3)+e];i.currentIndex=o}super.addElements(e+1,h+1,h),super.addElements(h,h+1,h+2);const i=this.data.aPosition.getLength()/3-this.offset;n=this.data.aPosition.getLength()/3;for(const e in this.data){const t=this.data[e],i=t.getLength()/n;let s=t.currentIndex;for(let e=0;e<i;e++)t[s++]=t[l*i-i+e];t.currentIndex=s}n=this.data.aPosition.getLength()/3;for(const e in this.data){const i=this.data[e],s=i.getLength()/n;let o=i.currentIndex;for(let e=0;e<s;e++)i[o++]=i[l*s-t*s-s+e];i.currentIndex=o}n=this.data.aPosition.getLength()/3;for(const e in this.data){const i=this.data[e],s=i.getLength()/n;let o=i.currentIndex;for(let e=0;e<s;e++)i[o++]=i[l*s-t*s-3*s+e];i.currentIndex=o}super.addElements(i,h-3,i+1),super.addElements(h-3,i+2,i+1)}}fillData(e,t,n,i,s,o,a,l,h){const c=!1!==this.options.top,u=!1!==this.options.side,f=this.feaLineWidth||this.symbol.lineWidth/2*(this.options.EXTENT/this.options.tileSize),g=Oa*s,m=Oa*o,A=f*s+t,w=f*o+n;this._fillTop(e,t,n,s,o,a,l,h,A,w,g,m),u&&(c&&this._fillTop(e,t,n,s,o,a,l,h,A,w,g,m),this._fillTop(e,t,n,s,o,a,l,h,A,w,g,m),this._fillBottom(e,t,n,s,o,a,l,h,A,w,g,m),this._fillBottom(e,t,n,s,o,a,l,h,A,w,g,m)),this.maxPos=Math.max(this.maxPos,Math.abs(t),Math.abs(n))}_fillTop(e,t,n,i,s,o,a,l,h,c,u,f){const{lineColorFn:g,lineWidthFn:m}=this._fnTypes;let A=e.aPosition.currentIndex;e.aPosition[A++]=t,e.aPosition[A++]=n,e.aPosition[A++]=32767,e.aPosition.currentIndex=A,A=e.aLinesofar.currentIndex,e.aLinesofar[A++]=l,e.aLinesofar.currentIndex=A,A=e.aUp.currentIndex,e.aUp[A++]=+a,e.aUp.currentIndex=A,A=e.aExtrudedPosition.currentIndex,e.aExtrudedPosition[A++]=h,e.aExtrudedPosition[A++]=c,e.aExtrudedPosition[A++]=1,e.aExtrudedPosition.currentIndex=A,A=e.aExtrude.currentIndex,e.aExtrude[A++]=u,e.aExtrude[A++]=f,e.aExtrude.push(u,f),g&&(A=e.aColor.currentIndex,e.aColor[A++]=this.feaColor[0],e.aColor[A++]=this.feaColor[1],e.aColor[A++]=this.feaColor[2],e.aColor[A++]=this.feaColor[3],e.aColor.currentIndex=A),m&&(A=e.aLineWidth.currentIndex,e.aLineWidth[A++]=Math.round(2*this.feaLineWidth),e.aLineWidth.currentIndex=A),this._hasALineHeight&&(A=e.aLineHeight.currentIndex,e.aLineHeight[A++]=this.feaAltitude,e.aLineHeight.currentIndex=A)}_fillBottom(e,t,n,i,s,o,a,l,h,c,u,f){const{lineColorFn:g,lineWidthFn:m}=this._fnTypes;let A=e.aPosition.currentIndex;e.aPosition[A++]=t,e.aPosition[A++]=n,e.aPosition[A++]=this.feaMinHeight||0,e.aPosition.currentIndex=A,A=e.aLinesofar.currentIndex,e.aLinesofar[A++]=l,e.aLinesofar.currentIndex=A,A=e.aUp.currentIndex,e.aUp[A++]=+a,e.aUp.currentIndex=A,A=e.aExtrudedPosition.currentIndex,e.aExtrudedPosition[A++]=h,e.aExtrudedPosition[A++]=c,e.aExtrudedPosition[A++]=1,e.aExtrudedPosition.currentIndex=A,A=e.aExtrude.currentIndex,e.aExtrude[A++]=u,e.aExtrude[A++]=f,e.aExtrude.push(u,f),g&&(A=e.aColor.currentIndex,e.aColor[A++]=this.feaColor[0],e.aColor[A++]=this.feaColor[1],e.aColor[A++]=this.feaColor[2],e.aColor[A++]=this.feaColor[3],e.aColor.currentIndex=A),m&&(A=e.aLineWidth.currentIndex,e.aLineWidth[A++]=Math.round(2*this.feaLineWidth),e.aLineWidth.currentIndex=A),this._hasALineHeight&&(A=e.aLineHeight.currentIndex,e.aLineHeight[A++]=this.feaAltitude,e.aLineHeight.currentIndex=A)}addElements(e,t,n){const i=!1!==this.options.top,s=!1!==this.options.side,o=(i?1:0)+(s?4:0);if(e*=o,t*=o,this.data.aUp[this.offset+(n*=o)+4]){if(i&&super.addElements(t,e,n),s){const e=i?1:0;super.addElements(t+e,n+e,n+e+2),super.addElements(t+e+1,n+e+1+2,t+e+1+2)}}else if(i&&super.addElements(e,n,t),s){const t=i?1:0;super.addElements(e+t,e+t+2,n+t),super.addElements(e+t+1+2,n+t+1+2,n+t+1)}}createDataPack(e,t){this.maxAltitude=0;const n=super.createDataPack(e,t);if(!n)return n;const{data:i,indices:s}=n;this.getFormat().reduce(((e,t)=>(e[t.name]={size:t.width},e)),{}).aPickingId={size:1};const{aExtrudedPosition:o,aPosition:a,aLinesofar:l,aUp:h,aExtrude:c,aColor:u,aLineHeight:f,aLineWidth:g}=i,m={},A=function(e,t,n){const i=[];i.setLength&&i.setLength(e.length);const s=Ya;s.length<e.length/3&&(s.length=e.length/3),s.fill(0,0,e.length/3);const o=void 0===t.length?t:t.length;for(let n=0;n<o/3;n++)void 0===t.length?ll(e,3*n,3*n+1,3*n+2,i,s):ll(e,t[3*n],t[3*n+1],t[3*n+2],i,s);for(let e=0;e<i.length;e+=3){const t=s[e/3];0!==t?(i[e]/=t,i[e+1]/=t,i[e+2]/=t):(i[e]=0,i[e+1]=0,i[e+2]=0)}return i}(o,s);let w,T=!0;for(let e=0;e<A.length;e++)A[e]=-A[e],A[e]%1!=0&&(T=!1);if(!1!==this.options.top&&this.symbol.material&&function(e){for(const t in e)if(t.indexOf("Texture")>=0&&e[t])return!0;return!1}(this.symbol.material)&&(w=function(e,t,n){const i=[];for(let s=0;s<e.length;s+=3){const e=t[s/3];i.push(e/256,n[s/3]?1:0)}return i}(o,l,h)),m.aPosition=a,w&&(m.aTexCoord0=new Float32Array(w)),m.aNormal=T?new Int8Array(A):new Float32Array(A),m.aPickingId=i.aPickingId,m.aExtrude=c,u&&(m.aColor=u),g&&(m.aLineWidth=g),f){const e=q(this.maxAltitude);m.aLineHeight=new e(f)}const S=[];for(const e in m)S.push(m[e].buffer);return n.data=m,n.buffers=S,n}},e.LinePack=Ns,e.NativeLinePack=class extends mo{getFormat(){return[...this.getPositionFormat()]}placeVector(e){const t=e.feature,n=3===t.type,i=t.geometry,s=this.elements;n&&(this.elements=this._arrayPool.get());const o=this.needAltitudeAttribute()?2:3;for(let e=0;e<i.length;e++)this.offset=this.data.aPosition.getLength()/o,this._addLine(i[e],t),n&&(this._filterPolygonEdges(s),this.elements=this._arrayPool.get());n&&(this.elements=s)}_addLine(e,t){const n=3===t.type;let i=e.length;for(;i>=2&&e[i-1].equals(e[i-2]);)i--;let s,o,a,l=0;for(;l<i-1&&e[l].equals(e[l+1]);)l++;if(!(i<(n?3:2))){this.distance=0,this.vertexLength=0,this.primitiveLength=0,this.e1=this.e2=this.e3=-1,n&&(s=e[i-2]);for(let t=l;t<i;t++)a=n&&t===i-1?e[l+1]:e[t+1],a&&e[t].equals(a)||(s&&(o=s),s=e[t],o&&(this.distance+=s.dist(o)),this.addCurrentVertex(s,this.distance))}}addCurrentVertex(e,t){const n=this.vertexLength++;this.addLineVertex(this.data,e,t),n>=1&&this.addElements(n-1,n),t>hl&&(this.distance=0,this.addCurrentVertex(e,this.distance))}addLineVertex(e,t){const n=this.needAltitudeAttribute();this.fillPosition(e,t.x,t.y,t.z||0),this.maxPos=n?Math.max(this.maxPos,Math.abs(t.x),Math.abs(t.y)):Math.max(this.maxPos,Math.abs(t.x),Math.abs(t.y),Math.abs(t.z||0))}addElements(e,t){this.maxIndex=Math.max(this.maxIndex,this.offset+e,this.offset+t);let n=this.elements.currentIndex;this.elements[n++]=this.offset+e,this.elements[n++]=this.offset+t,this.elements.currentIndex=n}_filterPolygonEdges(e){const t=this.options.EXTENT,n=this.elements,i=n.getLength();for(let s=0;s<i;s+=2)if(!I(this.data.aPosition,n[s],n[s+1],3,t)){let t=e.currentIndex;e[t++]=n[s],e[t++]=n[s+1],e.currentIndex=t}}},e.NativePointPack=class extends mo{getFormat(){const{markerFillFn:e}=this._fnTypes;let t;return t="line"===this.symbol.markerRotationAlignment?[...this.getPositionFormat(),{type:Float32Array,width:1,name:"aXYRotation"},{type:Float32Array,width:1,name:"aZRotation"}]:[...this.getPositionFormat()],e&&t.push({type:Uint8Array,width:4,name:"aColor"}),t}placeVector(e){const t=e.feature.properties,{markerFillFn:n}=this._fnTypes;let i;n&&(i=n(this.options.zoom,t)||[255,255,255,255],ye(i)?(this.dynamicAttrs.aColor=1,i=[0,0,0,0]):i=Pt([],i));const s=this.data,o="line"===this.symbol.markerRotationAlignment,a=this._getAnchors(e,this.symbol.markerSpacing||250,this.symbol.markerPlacement||"point",o),l=this.needAltitudeAttribute();for(let e=0;e<a.length;e++){const t=a[e];if(this.fillPosition(this.data,t.x,t.y,t.z),o){let e=s.aXYRotation.currentIndex;s.aXYRotation[e++]=t.xyRotation||0,s.aXYRotation.currentIndex=e,e=s.aZRotation.currentIndex,s.aZRotation[e++]=t.zRotation||0,s.aZRotation.currentIndex=e}if(i){let e=s.aColor.currentIndex;s.aColor[e++]=i[0],s.aColor[e++]=i[1],s.aColor[e++]=i[2],s.aColor[e++]=i[3],s.aColor.currentIndex=e}let n;n=l?Math.max(Math.abs(t.x),Math.abs(t.y)):Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z||0)),n>this.maxPos&&(this.maxPos=n)}}_getAnchors(e,t,n,i){const s=e.feature,o=this.options.EXTENT;if("line"===n){const e=[];let n=s.geometry;o&&(n=Ko(s.geometry,0,0,o,o));for(let i=0;i<n.length;i++){const s=ta(n[i],t,cl,null,0,24,1,1,o||1/0);e.push.apply(e,s)}return e}return ma(s,n,o,i,this.options.altitudeToTileScale)}hasElements(){return!1}},e.PackUtil=hh,e.PointPack=Ts,e.PolygonPack=class extends mo{constructor(...e){super(...e),this.lineElements=[]}createStyledVector(e,t,n,i,s){const o=new dt(e,t,n,i),a=o.getPolygonResource();return!this.options.atlas&&a&&(s[a]=[0,0]),o}getFormat(){const e=[...this.getPositionFormat()],{polygonFillFn:t,polygonOpacityFn:n,uvScaleFn:i,uvOffsetFn:s,polygonPatternUVFn:o}=this._fnTypes;if(this.iconAtlas){const t=this.getIconAtlasMaxValue();e.push({type:t>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return t&&e.push({type:Uint8Array,width:4,name:"aColor"}),n&&e.push({type:Uint8Array,width:1,name:"aOpacity"}),i&&e.push({type:Uint16Array,width:2,name:"aUVScale"}),s&&e.push({type:Uint8Array,width:2,name:"aUVOffset"}),o&&e.push({type:Float32Array,width:2,name:"aTexCoord"}),e}placeVector(e,t){const n=e.feature;this._addPolygon(n.geometry,n,t)}_addPolygon(e,t){let n,i,s,o;const{polygonFillFn:a,polygonOpacityFn:l,uvScaleFn:h,uvOffsetFn:c,uvOffsetInMeterFn:u,polygonPatternUVFn:f}=this._fnTypes,g=t.properties;a&&(n=a(this.options.zoom,g)||Pa([],255,255,255,255),ye(n)?(this.dynamicAttrs.aColor=1,n=Vl):n=Pt([],n)),l&&(i=l(this.options.zoom,g),ye(i)?(this.dynamicAttrs.aOpacity=1,i=255):(pt(i)&&(i=1),i*=255)),h&&(s=h(this.options.zoom,g),ye(s)?(s=[255,255],this.dynamicAttrs.aUVScale=1):(pt(s)&&(s=[1,1]),s=[255*s[0],255*s[1]])),c&&(u&&u(null,g)?o=[0,0]:(o=c(this.options.zoom,g),ye(o)?(o=[0,0],this.dynamicAttrs.aUVOffset=1):(pt(o)&&(o=[0,0]),o=[255*o[0],255*o[1]])));const m=!!this.iconAtlas,A=la(e,500),w=[0,0],T=[0,0];if(m){const{polygonPatternFileFn:e}=this._fnTypes,t=e?e(null,g):this.symbol.polygonPatternFile;if(this.iconAtlas.glyphMap[t]){const e=this.iconAtlas.positions[t],n=!U(e.displaySize[0])||!U(e.displaySize[1]);w[0]=e.tl[0]+(n?1:0),w[1]=e.tl[1]+(n?1:0),T[0]=e.displaySize[0]-1-(n?2:0),T[1]=e.displaySize[1]-1-(n?2:0)}}let S,M=0;f&&(S=f(this.options.zoom,g));const C=this.needAltitudeAttribute()?2:3,I=[-1,-1,t.extent+1,t.extent+1],E=this._flattened=this._flattened||this._arrayPool.getProxy(),D=this._holeIndices=this._holeIndices||this._arrayPool.getProxy();for(let e=0;e<A.length;e++){const t=A[e],a=this.data.aPosition.getLength()/C;E.setLength(0),D.setLength(0);for(let e=0;e<t.length;e++){let a=t[e];if(this.options.EXTENT!==1/0&&0===this.maxPosZ&&0===this.minPosZ&&(a=zl(a,I)),0===a.length)continue;0!==e&&D.push(E.length/3),this.ensureDataCapacity(a.length);const l=this.data;for(let e=0;e<a.length;e++){const t=a[e].x,h=a[e].y,c=a[e].z||0;if(this.fillPosition(this.data,t,h,c),m){let e=l.aTexInfo.currentIndex;l.aTexInfo[e++]=w[0],l.aTexInfo[e++]=w[1],l.aTexInfo[e++]=T[0],l.aTexInfo[e++]=T[1],l.aTexInfo.currentIndex=e}if(void 0!==n){let e=l.aColor.currentIndex;l.aColor[e++]=n[0],l.aColor[e++]=n[1],l.aColor[e++]=n[2],l.aColor[e++]=n[3],l.aColor.currentIndex=e}if(void 0!==i){let e=l.aOpacity.currentIndex;l.aOpacity[e++]=i,l.aOpacity.currentIndex=e}if(void 0!==s){let e=l.aUVScale.currentIndex;l.aUVScale[e++]=s[0],l.aUVScale[e++]=s[1],l.aUVScale.currentIndex=e}if(void 0!==o){let e=l.aUVOffset.currentIndex;l.aUVOffset[e++]=o[0],l.aUVOffset[e++]=o[1],l.aUVOffset.currentIndex=e}if(f){let e=l.aTexCoord.currentIndex;if(S){const t=pt(S[2*M])?S[0]:S[2*M],n=pt(S[2*M]+1)?S[1]:S[2*M+1];l.aTexCoord[e++]=t,l.aTexCoord[e++]=n}else l.aTexCoord[e++]=jl,l.aTexCoord[e++]=jl;l.aTexCoord.currentIndex=e,M++}const u=Math.abs(t),g=Math.abs(h);u>this.maxPos&&(this.maxPos=u),g>this.maxPos&&(this.maxPos=g),E.push(t,h,c)}}let l=ul(E,D,3);if(E.length&&!l.length){const e=[];for(let t=0;t<E.length;t+=3)e[t]=E[t],e[t+1]=E[t+2],e[t+2]=E[t+1];if(l=ul(e,D,3),!l.length){for(let t=0;t<E.length;t+=3)e[t]=E[t+1],e[t+1]=E[t+2],e[t+2]=E[t];l=ul(e,D,3)}}for(let e=0;e<l.length;e+=3)this.addElements(a+l[e],a+l[e+1],a+l[e+2])}}ensureDataCapacity(e){super.ensureDataCapacity(1,e)}},e.RoundTubePack=Va,e.SYMBOLS_NEED_REBUILD_IN_VECTOR=Ah,e.SYMBOLS_NEED_REBUILD_IN_VT=mh,e.SquareTubePack=class extends Va{addHalfVertex(e,t,n,i,s,o,a,l){const{x:h,y:c,z:u}=e,f=1*this.scaledDistance,{x:g,y:m,z:A}=a.dir,w=function(e,t,n,i,s,o,a,l){Sa($l,n,i,s),Sa(Kl,o,a,0),Ca(eh,$l,Kl),Ma(Kl,Kl),Ma(eh,eh),ka(Ql,e,t);const h=function(e){return Math.hypot(e[0],e[1])}(Ql)/e,c=Math.atan(t/e);let u=Math.PI/2+(Math.PI/2-c);return th[0]||(th[0]=[]),Jl(Kl,eh,th[0],h,u,l?1:-1),u+=2*c,th[1]||(th[1]=[]),Jl(Kl,eh,th[1],h,u,l?1:-1),th}(this.feaLineWidth,this.feaLineHeight,g,m,A,t,n,s);this.prevVertex&&this.fillTubeElements(s),this.fillData(this.data,h,c,u||0,w,s,f,l)}ensureDataCapacity(e,t,n,i){return super.ensureDataCapacity(e,t,n,2*i)}},e.StyleUtil=Rt,e.StyledPoint=Jo,e.StyledVector=dt,e.TEXT_MAX_ANGLE=80,e.TextUtil=Co,e.VectorPack=mo,t().maptalks_vt_packers=e}function eL(){return function(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}().maptalks_vt_packers}KR({});let tL=0;function nL(){return tL++}const rL="function"==typeof Object.assign;function iL(e,...t){if(rL)return Object.assign(e,...t),e;for(let n=0;n<t.length;n++){const i=t[n];for(const t in i)e[t]=i[t]}return e}function sL(e){return!hL(e)&&("string"==typeof e||null!==e.constructor&&e.constructor===String)}function oL(e){return"number"==typeof e&&!isNaN(e)}function aL(e){return!hL(e)&&("function"==typeof e||null!==e.constructor&&e.constructor===Function)}function lL(e){return!Array.isArray(e)&&"object"==typeof e&&!!e}function hL(e){return null==e}function cL(e){for(let t=1;t<arguments.length;t++){const n=arguments[t];if(n)for(let t=0,i=n.length;t<i;t++)e.push(n[t])}return e.length}function uL(e){return SE(e)&&e.property}function fL(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function dL(e,t){return t.altitudeToPoint(100,e)/100/100}function pL(e,t,n){for(let i=0;i<e.length;i++){const s=e[i],o=iL({},s),{renderPlugin:a}=s,l=iL({},a);l.sceneConfig&&!Object.keys(l.sceneConfig).length&&delete l.sceneConfig;let h=-1;for(let e=n.length-1;e>=0;e--)if(Zv(l,n[e])){h=e;break}h<0&&(h=n.length,n.push(l)),o.renderPlugin=h,t.push(o)}}const gL="function"==typeof fetch&&"function"==typeof AbortController,mL={jsonp:function(e,t){const n="_maptalks_jsonp_"+nL();e.match(/\?/)?e+="&callback="+n:e+="?callback="+n;let i=document.createElement("script");return i.type="text/javascript",i.src=e,window[n]=function(e){t(null,e),document.getElementsByTagName("head")[0].removeChild(i),i=null,delete window[n]},document.getElementsByTagName("head")[0].appendChild(i),this},get:function(e,t,n){if(aL(t)){const e=n;n=t,t=e}let i=(t=t||{}).errorLog;hL(i)&&(i=!0),t.method&&(t.method=t.method.toUpperCase());const s="POST"===t.method;if(gL){const s=new AbortController,o=t;o.signal=s.signal,o.referrerPolicy=o.referrerPolicy||"origin",o.method=o.method||"GET";const a=new Request(e,o);return t.returnJSON&&a.headers.set("Accept","application/json"),fetch(a).then((s=>{const o=this._parseResponse(s,t.returnJSON,t.responseType);o.message?(o.url=e,n(o)):o.then((e=>{n(null,"arraybuffer"===t.responseType?{data:e,cacheControl:s.headers.get("Cache-Control"),expires:s.headers.get("Expires"),contentType:s.headers.get("Content-Type")}:e)})).catch((t=>{t.code&&t.code===DOMException.ABORT_ERR||(i&&console.error("Fetch error:",e,t),n(t))}))})).catch((t=>{t.code&&t.code===DOMException.ABORT_ERR||(i&&console.error("Fetch error:",e,t),n(t))})),s}{const i=mL._getClient(n);if(i.open(t.method||"GET",e,!0),t){for(const e in t.headers)i.setRequestHeader(e,t.headers[e]);i.withCredentials="include"===t.credentials,t.responseType&&(i.responseType=t.responseType)}return i.send(s?t.body:null),i}},_parseResponse:(e,t,n)=>200!==e.status?{status:e.status,statusText:e.statusText,message:`incorrect http request with status code(${e.status}): ${e.statusText}`}:"arraybuffer"===n?e.arrayBuffer():t?e.json():e.text(),_wrapCallback:function(e,t){return function(){4===e.readyState&&(200===e.status?"arraybuffer"===e.responseType?0===e.response.byteLength?t({status:200,statusText:e.statusText,message:"http status 200 returned without content."}):t(null,{data:e.response,cacheControl:e.getResponseHeader("Cache-Control"),expires:e.getResponseHeader("Expires"),contentType:e.getResponseHeader("Content-Type")}):t(null,e.responseText):t({status:e.status,statusText:e.statusText,message:`incorrect http request with status code(${e.status}): ${e.statusText}`}))}},_getClient:function(e){let t;try{t=new XMLHttpRequest}catch(e){try{t=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{t=new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}}return t.onreadystatechange=mL._wrapCallback(t,e),t},getArrayBuffer(e,t,n){if(aL(t)){const e=n;n=t,t=e}return t||(t={}),t.responseType="arraybuffer",mL.get(e,t,n)},getJSON:function(e,t,n){if(aL(t)){const e=n;n=t,t=e}const i=function(e,t){const i="string"==typeof t?JSON.parse(t):t||null;n(e,i)};return t&&t.jsonp?mL.jsonp(e,i):((t=t||{}).returnJSON=!0,mL.get(e,t,i))}};let AL=class ne{constructor(e){this.max=e,this.reset()}reset(){return this.data={},this.order=[],this}clear(){this.reset()}add(e,t){return this.has(e)?(this.order.splice(this.order.indexOf(e),1),this.data[e]=t,this.order.push(e)):(this.data[e]=t,this.order.push(e),this.order.length>this.max&&this.getAndRemove(this.order[0])),this}has(e){return e in this.data}keys(){return this.order}getAndRemove(e){if(!this.has(e))return null;const t=this.data[e];return delete this.data[e],this.order.splice(this.order.indexOf(e),1),t}get(e){return this.has(e)?this.data[e]:null}remove(e){return this.has(e)?(delete this.data[e],this.order.splice(this.order.indexOf(e),1),this):this}setMaxSize(e){for(this.max=e;this.order.length>this.max;)this.getAndRemove(this.order[0]);return this}},yL=class ie{constructor(e){this.options=e||{},this._requesting={},this._cache=new AL(256,(function(){}));const t=document.createElement("canvas");this.ctx=t.getContext("2d",{willReadFrequently:!0})}getIcons(e,t){if(!e||!Object.keys(e).length)return void t(null,{icons:null});const n=Object.keys(e),i={},s=[];let o=0,a=0;const l=this;function h(e,n){i[e]=l._getCache(e,n),i[e]&&"error"!==i[e]?s.push(i[e].data.data.buffer):delete i[e],a++,a===o&&t(null,{icons:i,buffers:s})}function c(e){const t=l._requesting[e.url];for(let n=0;n<t.length;n++)t[n].call(e,e.url,e.size);delete l._requesting[e.url]}function u(){const e=l.ctx;let t,n;try{t=this.width,n=this.height,this.size[0]=t,this.size[1]=n,l._ensureMaxSize(null,this.size),t=this.size[0],n=this.size[1];const i=e.canvas;i.width=t,i.height=n,e.imageSmoothingEnabled=!1,e.drawImage(this,0,0,t,n);const s=e.getImageData(0,0,i.width,i.height).data;l._addCache(this.url,s,i.width,i.height)}catch(e){console.warn(e)}c(this)}function f(e){console.warn(`failed loading icon(${this.index}) at "${this.url}"`),console.warn(e),l.options.iconErrorUrl?this.src=l.options.iconErrorUrl:(l._addCache(this.url),c(this))}const g=this.options.urlModifier;let m,A=!1;for(let t=0;t<n.length;t++){const a=n[t],l=e[a];this._ensureMaxSize(a,l);const c=this._getCache(a,l);if(c&&"error"!==c){i[a]=this._getCache(a,l);continue}if("error"===c)continue;let w,T=a;if(0===a.indexOf("vector://")&&(w=JSON.parse(a.substring(9)),"path"===w.markerType&&(T=Zi.getMarkerPathBase64(w,w.markerWidth,w.markerHeight))),0===a.indexOf("vector://")&&"path"!==w.markerType){m=m||new mf([0,0]);const{markerFill:e,markerLineColor:t}=w;e&&Array.isArray(e)&&(w.markerFill=_L(e)),t&&Array.isArray(t)&&(w.markerLineColor=_L(t)),delete w.markerHorizontalAlignment,delete w.markerVerticalAlignment,delete w.markerDx,delete w.markerDy,delete w.markerPlacement,delete w.markerFile,w.markerWidth=l[0],w.markerHeight=l[1],m.setSymbol(w);const n=m["_getSprite".trim()]();if(n){const e=n.canvas,t=e.width,o=e.height,l=e.getContext("2d",{willReadFrequently:!0}).getImageData(0,0,t,o).data;i[a]={data:{data:new Uint8ClampedArray(l),width:t,height:o},url:a},s.push(i[a].data.data.buffer),this._addCache(a,l,t,o)}}else{if(this._requesting[a]){A=!0,o++,this._requesting[a].push(h);continue}this._requesting[a]=[],this._requesting[a].push(h);const e=new Image;e.index=t,e.size=l,e.onload=u,e.onerror=f,e.onabort=f,e.url=a,e.crossOrigin="Anonymous",A=!0,o++,e.src=g&&g(T)||T}}A||t(null,{icons:i,buffers:s})}_hasCache(e,t,n){const i=this._cache.get(e);return i&&"error"!==i&&i.data.width>=t&&i.data.height>=n}_addCache(e,t,n,i){this._hasCache(e,n,i)||this._cache.add(e,t?{data:{data:t,width:n,height:i},url:e}:"error")}_getCache(e,t){if(!this._hasCache(e,t[0],t[1]))return null;const n=this._cache.get(e);return n?"error"===n?n:{data:{data:new Uint8ClampedArray(n.data.data),width:n.data.width,height:n.data.height},url:n.url}:null}_ensureMaxSize(e,t){if(!t[0]||!t[1])return;const n=this.options.maxSize||2048;let[i,s]=t;const o=i/s;if(e){const t=this._cache.get(e);if(t&&"error"!==t){const{width:e,height:n}=t.data;e>i&&(i=e),n>s&&(s=n)}}i>n&&(s=n/o,i=n),s>n&&(i=n*o,s=n),t[0]=Math.floor(i),t[1]=Math.floor(s)}};function _L(e){return 3===e.length&&e.push(1),e.reduce(((e,t,n)=>e+(n<3?255*t+",":t+")")),"rgba(")}const{GlyphRequestor:vL}=eL(),xL=["GeoJSONVectorTileLayer"];let bL=class ae extends Um.Actor{constructor(e,t){super(e);const n=t.getMap().id;this._layer=t,this._mapId=n,this._workerLayerId="vt_"+nL();const i=t.getJSONType();this._isDedicated=xL.indexOf(i)>=0,this._dedicatedVTWorkers={},this._iconRequestor=new yL({iconErrorUrl:t.options.iconErrorUrl,maxSize:t.options.maxIconSize,urlModifier:e=>{const n=t.getURLModifier();return n&&n(e)||e}});const s=!t.getRenderer().isEnableWorkAround("win-intel-gpu-crash");this._glyphRequestor=new vL((e=>{t.getMap().getRenderer().callInNextFrame(e)}),t.options.glyphSdfLimitPerFrame,s)}initialize(e){e(null)}addLayer(e){const t=this._layer,n=t.getWorkerOptions()||{},i=this._workerLayerId,s=t.getJSONType(),o={mapId:this._mapId,layerId:i,command:"addLayer",params:{type:s,options:JSON.parse(JSON.stringify(n))}};this._isDedicated?(void 0===this._dedicatedVTWorkers[i]&&(this._dedicatedVTWorkers[i]=this.getDedicatedWorker()),this.send(o,null,e,this._dedicatedVTWorkers[i])):this.broadcast(o,null,e)}abortTile(e,t){const n=this._workerLayerId,i={mapId:this._mapId,layerId:n,command:"abortTile",params:{url:e}};this._isDedicated?(void 0===this._dedicatedVTWorkers[n]&&(this._dedicatedVTWorkers[n]=this.getDedicatedWorker()),this.send(i,null,t,this._dedicatedVTWorkers[n])):this.broadcast(i,null,t)}removeLayer(e){const t=this._workerLayerId,n={mapId:this._mapId,layerId:t,command:"removeLayer"};this._isDedicated?(void 0!==this._dedicatedVTWorkers[t]&&this.send(n,null,e,this._dedicatedVTWorkers[t]),delete this._dedicatedVTWorkers[t]):this.broadcast(n,null,e)}updateStyle(e,t){const n=this._workerLayerId,i={mapId:this._mapId,layerId:n,command:"updateStyle",params:JSON.parse(JSON.stringify(e))};this._isDedicated?void 0!==this._dedicatedVTWorkers[n]&&this.send(i,null,t,this._dedicatedVTWorkers[n]):this.broadcast(i,null,t)}updateOptions(e,t){const n=this._workerLayerId,i={mapId:this._mapId,layerId:n,command:"updateOptions",params:JSON.parse(JSON.stringify(e))};this._isDedicated?void 0!==this._dedicatedVTWorkers[n]&&this.send(i,null,t,this._dedicatedVTWorkers[n]):this.broadcast(i,null,t)}loadTile(e,t){const n=iL({},e);n.tileInfo=function(e){const t={};for(const n in e)null!=e[n]&&(t[n]=e[n].toJSON?e[n].toJSON():e[n]);return t}(e.tileInfo);const i=this._workerLayerId,s={mapId:this._mapId,layerId:i,command:"loadTile",params:n},{x:o,y:a}=e.tileInfo,l=(o+a)%this.workers.length,h=[],c=n.tileArrayBuffer;c&&c instanceof ArrayBuffer&&h.push(c),this.send(s,h,t,void 0===this._dedicatedVTWorkers[i]?this.workers[l].id:this._dedicatedVTWorkers[i])}remove(){super.remove(),this._dedicatedVTWorkers={}}fetchIconGlyphs({icons:e,glyphs:t},n){this._glyphRequestor.getGlyphs(t,((t,i)=>{if(t)throw t;const s=i.buffers||[];this._iconRequestor.getIcons(e,((e,t)=>{if(e)throw e;t.buffers&&t.buffers.length&&s.push(...t.buffers),n(null,{icons:t.icons,glyphs:i.glyphs},s)}))}))}setData(e,t){const n=this._workerLayerId;this.send({mapId:this._mapId,layerId:n,command:"setData",params:{data:e}},null,t,this._dedicatedVTWorkers[n])}clearData(e){const t=this._workerLayerId;this.send({mapId:this._mapId,layerId:t,command:"clearData"},null,e,this._dedicatedVTWorkers[t])}_getTileKey(e){return e.id}};const wL={},TL={collision:!0,fading:!1,fadingDuration:224,fadeInDelay:600,fadeOutDelay:100,uniquePlacement:!1,depthFunc:"always"};let SL=class ce{constructor(e,t,n){this._regl=e,this._map=t,this._color=n||[0,1,0]}draw(e,t,n,i,s){if(this._command||this._init(),!this._data){this._data=this._regl.buffer(ML(i));this._textData=this._regl.buffer(CL(i,i/n))}if(i!==this._extent){const e=i/n;this._data(ML(i)),this._textData(CL(i,e))}this._extent=i;let o=this._debugInfoCanvas;if(!o){const e=this._map.getDevicePixelRatio()>1?2:1;o=this._debugInfoCanvas=document.createElement("canvas"),o.width=512*e,o.height=64*e;const t=o.getContext("2d");t.font="36px monospace",t.scale(e,e),this._texture=this._regl.texture({width:o.width,height:o.height,data:o})}const a=o.getContext("2d");a.clearRect(0,0,o.width,o.height),a.fillStyle=`rgba(${this._color.map((e=>255*e)).join()})`,a.fillText(e,20,36),this._texture({width:o.width,height:o.height,data:o}),this._command({transform:t,data:this._data,texData:this._texCoordData,debugLine:1,primitive:"lines",framebuffer:s||null,image:this._texture,count:8}),this._command({transform:t,data:this._textData,texData:this._texCoordData,debugLine:0,primitive:"triangle strip",framebuffer:s||null,image:this._texture,count:4})}delete(){this._texture&&(this._texture.destroy(),delete this._texture),this._texCoordData&&(this._texCoordData.destroy(),delete this._texCoordData),this._data&&(this._data.destroy(),this._textData.destroy(),delete this._data,delete this._textData),this._command&&(this._command.destroy(),delete this._command)}_init(){this._texCoordData=this._regl.buffer(new Uint8Array([0,0,0,1,1,0,1,1,0,0,0,1,1,0,1,1])),this._command=this._regl({vert:"\n                attribute vec2 aPosition;\n                attribute vec2 aTexCoord;\n                uniform mat4 transform;\n\n                varying vec2 vTexCoord;\n                void main()\n                {\n                    gl_Position = transform * vec4(aPosition, 0.0, 1.0);\n                    vTexCoord = aTexCoord;\n                }\n            ",frag:"\n                precision mediump float;\n                uniform sampler2D uImage;\n                uniform vec3 uColor;\n                uniform float uOpacity;\n                uniform float uDebugLine;\n\n                varying vec2 vTexCoord;\n\n                void main()\n                {\n                    if (uDebugLine == 1.) {\n                        gl_FragColor = vec4(uColor, 1.0) * uOpacity;\n                    } else {\n                        gl_FragColor = texture2D(uImage, vTexCoord) * uOpacity;\n                    }\n                    gl_FragColor *= gl_FragColor.a;\n                }\n            ",attributes:{aPosition:this._regl.prop("data"),aTexCoord:this._regl.prop("texData")},uniforms:{transform:this._regl.prop("transform"),uColor:this._color,uOpacity:1,uDebugLine:this._regl.prop("debugLine"),uImage:this._regl.prop("image")},count:this._regl.prop("count"),primitive:this._regl.prop("primitive"),depth:{enable:!1,mask:!1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},viewport:{x:0,y:0,width:()=>this._map.getRenderer().canvas.width,height:()=>this._map.getRenderer().canvas.height},framebuffer:this._regl.prop("framebuffer")})}};function ML(e){return new Uint16Array([0,0,0,e,0,e,e,e,e,e,e,0,e,0,0,0])}function CL(e,t){return new Uint16Array([0,e-64*t,0,e,512*t,e-64*t,512*t,e])}const PL=new Uint16Array([0,0,0,1,1,0,1,0,0,1,1,1]),IL=[];let kL=class ge{constructor(e,t,n){this._regl=e,(this._geometry=new CM.Geometry({aPosition:PL},null,PL.length/2,{positionSize:2})).generateBuffers(e),this._scene=new CM.Scene,this._meshes=[],this._counter=0,this._canvas=t,this._map=n,this._init(e)}start(){this._counter=0,this._scene.clear()}add(e,t,n){const i=this._getMesh(n);i.setUniform("ref",e),ZA(IL,t,t,1);const s=i.localTransform;SA(s,IL),GA(s,n,s),i.setLocalTransform(s),this._scene.addMesh(i)}render(e){this._renderer.render(this._shader,{projViewMatrix:this._map.projViewMatrix},this._scene,e)}_getMesh(){const e=this._counter++;return this._meshes[e]||(this._meshes[e]=new CM.Mesh(this._geometry)),this._meshes[e]}_init(e){const t=this._canvas,n={viewport:{x:0,y:0,width:()=>t.width,height:()=>t.height},stencil:{enable:!0,func:{cmp:"always",ref:(e,t)=>t.ref},op:{fail:"replace",zfail:"replace",zpass:"replace"}},depth:{enable:!0,func:"always",mask:!1},colorMask:[!1,!1,!1,!1]};this._shader=new CM.MeshShader({name:"tile-stencil",vert:"\n#define SHADER_NAME TILE_STENCIL_VERT\nattribute vec2 aPosition;\nuniform mat4 projViewModelMatrix;\n\nvoid main()\n{\n    gl_Position = projViewModelMatrix * vec4(aPosition, 0.0, 1.0);\n}\n",frag:"\n#define SHADER_NAME TILE_STENCIL_FRAG\nvoid main()\n{\n    gl_FragColor = vec4(1.0, 0.0, 0.0, 0.1);\n}\n",wgslVert:"\n@group(0) @binding(0) var<uniform> projViewModelMatrix : mat4x4f;\n@vertex\nfn main(\n    @location(0) aPosition : vec2u\n    ) -> @builtin(position) vec4f {\n    return projViewModelMatrix * vec4f(vec2f(aPosition), 0.0, 1.0);\n}\n",wgslFrag:"\n@fragment\nfn main() -> @location(0) vec4f {\n  return vec4(1.0, 0.0, 0.0, 0.1);\n}\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,t){const n=[];return vA(n,t.projViewMatrix,t.modelMatrix),n}}],extraCommandProps:n}),this._renderer=new CM.Renderer(e)}remove(){this._geometry.dispose();for(let e=0;e<this._meshes.length;e++)this._meshes[e].dispose();this._meshes.length=0,this._shader.dispose()}};const OL="__fea_idx",EL=-999999,RL=new Float32Array([-1e12])[0],LL="maptalks_ombb",DL=(OL+"").trim();function FL(e,t,n,i,s,o){const a={};if(function(e){if(!e)return!1;for(const t in e)if(null!=e[t])return!0;return!1}(e))for(let l=0,h=(t||e).length;l<h;l++){let h=t?e[t[l]]:e[l];"id"===s.options.features&&s.getFeature&&(h=s.getFeature(h),h.layer=n),s instanceof Up&&(h=GL(h,o)),a[t?t[l]:h[DL]]={feature:h,symbol:i}}return a}const HL="__original_properties",NL="__external_properties",BL={get:function(e,t){return t in e?e[t]:e[HL][t]||e[NL]&&e[NL][t]},has:function(e,t){return t in e||t in e[HL]||e[NL]&&t in e[NL]}},zL={};function GL(e,t){const n=e.properties;if(n&&n[HL])return e;t&&(e=iL({},e)),e.customProps=e.customProps||{};const i=e.customProps;return i.$layer=e.layer,i.$type=e.type,i[HL]=n||zL,e.properties=new Proxy(i,BL),e}function UL(e){for(let t=1;t<arguments.length;t++){const n=arguments[t];for(const t in n)e[t]=n[t]}return e}function VL(e,t,n){return Math.min(n,Math.max(t,e))}function jL(e,t,n){if(e===n||e===t)return e;const i=n-t;return((e-t)%i+i)%i+t}function WL(e){return null==e}function qL(e){const t=JSON.parse(JSON.stringify(e));if(Array.isArray(e))for(let n=0;n<e.length;n++){if(!t[n])continue;const{symbol:i}=t[n];if(!i)continue;const s=e[n].symbol;for(const e in s)i[e]||(i[e]=s[e])}else if(e){if(e.style){const n=qL(e.style);return t.style=n,t}if(e.symbol){const n=qL(e.symbol);return t.symbol=n,t}for(const n in e)t[n]||(t[n]=e[n])}return t}function ZL(e,t,n,i,s,o){t in e||Object.defineProperty(e,t,{enumerable:!0,get:function(){const e=WL(n[i])||SE(n[i])?s:n[i];return o?o(e):e}})}const XL=[];function YL(e){for(let t=0;t<e.length;t++)XL[t]=e[t],XL[t]*=255;return 3===e.length&&(XL[3]=255),XL}function JL(e,t=4){return QL.bind(this,e,t)}function QL(e,t,n){if(Array.isArray(n))return 3===n.length&&4===t&&n.push(1),n;if(e&&e[n])return e[n];if(void 0!==n.r&&void 0!==n.g&&void 0!==n.b&&void 0!==n.a)return[n.r,n.g,n.b,n.a];const i=oE(n).unitArray();return 3===i.length&&4===t&&i.push(1),e&&(e[n]=i),i}function $L(e,t,n,i){if(e.fill)e.fill(t,n,i);else for(let s=n;s<i;s++)e[s]=t}function KL(e){return"number"==typeof e&&!isNaN(e)}function eD(e){return e&&(e.markerFile||e.markerType)&&void 0!==e.textName}function tD(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function nD(e,t){if(t){let t=e[e.length-1];const n=[t];for(let i=e.length-2;i>=0;i--)e[i]!==t&&(n.push(e[i]),t=e[i]);return n}{let t=e[e[0]];const n=[t];for(let i=1;i<e.length;i++)e[i]!==t&&(n.push(e[i]),t=e[i]);return n}}const rD=new fl(0,0);function iD(e,t,n,i,s){const o=e.distanceToPointAtRes(t,t,i,n,rD);return s?o.y:o.x}const{TileLayerRendererable:sD,LayerAbstractRenderer:oD}=Om,{FilterUtil:aD}=eL(),lD=[],hD=new Re(0,0),cD=[],uD={color:[0,0,0,0],depth:1,stencil:0},fD=e=>e.isTerrainSkin(),dD=e=>e.isTerrainVector();let pD=class Qe extends(OP(sD(oD))){supportRenderMode(){return!0}constructor(e){super(e),this._workerCacheIndex=0,this.ready=!1,this._styleCounter=1,this._requestingMVT={},this._plugins={},this._featurePlugins={},this.init()}getTileLevelValue(e,t){if(this.isBackTile(e.id)){const n=e.z,i=5;return n-t>=0?t+i-n:i+(t-n)}return 0}getWorkerConnection(){return this._workerConn}getStyleCounter(){return this._styleCounter}clearData(){this.clear(),this._workerConn?(this._workersyncing=!0,this._workerConn.clearData((()=>{this._workersyncing=!1,this._needRetire=!0,this.setToRedraw(),this.layer.fire("cleardata")}))):this.layer.fire("cleardata")}clear(){this.clearTileCaches(),super.clear()}setStyle(){this._groundPainter&&this._groundPainter.update(),this._workerConn?(this._workerUpdateTimeout&&clearTimeout(this._workerUpdateTimeout),this._workerUpdateTimeout=setTimeout((()=>{if(!this.layer)return;this._styleCounter++,this._preservePrevTiles();const e=this.layer._getComputedStyle();e.styleCounter=this._styleCounter,this._workersyncing=!0,this._workerConn.updateStyle(e,(e=>{if(this._workersyncing=!1,e)throw new Error(e);this._needRetire=!0,this._initPlugins(),this.setToRedraw(),this.layer.fire("refreshstyle")}))}),10)):this._initPlugins()}_preservePrevTiles(){if(this._prevTilesInView)for(const e in this._prevTilesInView){const t=this._prevTilesInView[e];t&&this.deleteTile(t)}this._prevTilesInView=this.tilesInView;const e=this.tileCache;for(const t in this._prevTilesInView){const n=this._prevTilesInView[t];n&&n.info&&e.getAndRemove(n.info.id)}e.reset(),this.tilesInView={},this.tilesLoading={},this._requestingMVT={},this._parentTiles=[],this._childTiles=[],this._tileZoom=void 0}updateOptions(e){this._workerConn&&this._workerConn.updateOptions(this.layer.getWorkerOptions(),(t=>{if(t)throw new Error(t);e&&(e.features||e.pickingGeometry||e.altitudeProperty)&&(this.clear(),this._clearPlugin(),this._initPlugins()),this.setToRedraw()}))}updateSceneConfig(e,t,n){const i=0===e?this._getStylePlugins():this._getFeaturePlugins();if(!i||!i[t])return;this._needRetire=!0;const s=this.layer._getComputedStyle(),o=this.layer._getTargetStyle(e,s);i[t].config=o[t].renderPlugin,i[t].updateSceneConfig({sceneConfig:n}),this.setToRedraw()}updateDataConfig(e,t,n,i){const s=0===e?this._getStylePlugins():this._getFeaturePlugins();s&&s[t]&&(this._needRetire=!0,s[t].updateDataConfig(n,i)?this.setStyle():this.setToRedraw())}updateSymbol(e,t,n){const i=0===e?this._getStylePlugins():this._getFeaturePlugins();if(!i||!i[t])return!1;const s=this.layer._getComputedStyle(),o=this.layer._getTargetStyle(e,s),a=i[t];a.style=o[t];const l=a.updateSymbol(n,o[t].symbol);return!l&&yD(n)&&this.setStyle(),this.setToRedraw(),l}testIfNeedRedraw(){const e=this._getFramePlugins();for(let t=0;t<e.length;t++)if(e[t]&&e[t].needToRedraw())return!0;return super.testIfNeedRedraw()}needRetireFrames(){if(this._needRetire)return!0;const e=this._getFramePlugins();for(let t=0;t<e.length;t++)if(e[t]&&e[t].needToRetireFrames())return!0;return!1}getCurrentTiles(){return this._vtCurrentTiles}isAnimating(){const e=this.getMap().getRenderer(),t=e.getFrameTimestamp&&e.getFrameTimestamp()||e._frameTimestamp;if(this._highlightUpdated&&(this._highlightFrametime=t,delete this._highlightUpdated),this._highlightFrametime===t)return!0;const n=this._getFramePlugins();for(let e=0;e<n.length;e++)if(n[e]&&n[e].isAnimating())return!0;return!1}needToRefreshTerrainTileOnZooming(){const e=this._getFramePlugins();for(let t=0;t<e.length;t++)if(e[t]&&e[t].needToRefreshTerrainTileOnZooming())return!0;return!1}initContext(){super.initContext();const{regl:e,device:t,reglGL:n}=this.context,i=e||t;this.regl=e,this.gl=n,this.device=t||e;this.canvas.pickingFBO=this.canvas.pickingFBO||i.framebuffer({colorFormat:t?"bgra8unorm":"rgba",depthStencil:!0,width:this.canvas.width,height:this.canvas.height}),this.pickingFBO=this.canvas.pickingFBO,this._debugPainter=new SL(i,this.getMap()),this._prepareWorker(),this._groundPainter=new GroundPainter(i,this.layer),this.layer.fire("contextcreate",{regl:e,device:t})}_prepareWorker(){this._workerConn||(this._workerConn=new bL("@maptalks/vt",this.layer)),this._workerConn.addLayer(((e,t)=>{this.layer&&(this.ready=!0,this.layer.onWorkerReady(e,t),this.layer.fire("workerready"),this.setToRedraw())}))}_incrWorkerCacheIndex(){this._workerCacheIndex++}isDrawable(){return!0}checkResources(){return lD}_drawTiles(e,t,n,i,s){if(super._drawTiles(e,t,n,i,s),this._prevTilesInView)if(Object.keys(this._prevTilesInView).length)for(const e in this._prevTilesInView){const t=this._prevTilesInView[e];t&&t.info&&t.info.id&&!this.tileCache.has(t.info.id)&&this._drawTile(t.info,t.image,s)}else this._deletePrevPlugins(),delete this._prevTilesInView}_deletePrevPlugins(){const e=this._styleCounter,t=[],n=[];for(const n in this._plugins)+n!==e&&(t.push(n),this._getStylePlugins(n).forEach((e=>{e.remove()})));for(const t in this._featurePlugins)+t!==e&&(n.push(t),this._getFeaturePlugins(t).forEach((e=>{e.remove()})));for(let e=0;e<t.length;e++)delete this._plugins[t[e]];for(let e=0;e<n.length;e++)delete this._featurePlugins[n[e]]}draw(e,t){this._currentTimestamp!==e&&(this._needRetire=!1,this._setPluginIndex());const n=this.layer;if(this.prepareCanvas(),!this.ready||!n.ready)return;let i=this._plugins[this._styleCounter];i||(this._initPlugins(),this._setPluginIndex(),i=this._getStylePlugins());const s=this._getFeaturePlugins();n.isDefaultRender()||i.length||s.length?(n.options.collision&&n.clearCollisionIndex(),this._frameTime=e,this._zScale=this._getCentiMeterScale(this.getMap().getGLRes()),this._parentContext=t||{},this._startFrame(e),super.draw(e),this._currentTimestamp!==e&&this._prepareRender(e),this._endFrame(e),this._currentTimestamp=e):this.completeRender()}_setPluginIndex(){this._getFramePlugins().forEach(((e,t)=>{e&&(e.renderIndex=t)}))}_prepareRender(){const e=this._getFramePlugins();this._pluginOffsets=this._pluginOffsets||[];let t=0;for(let n=e.length-1;n>=0;n--){const i=e[n];i.isVisible()&&i.hasMesh()&&(this._pluginOffsets[n]=t,i.needPolygonOffset()&&t++)}this._groundPainter.isEnable()&&t++,this._polygonOffsetIndex=t}getFrameTimestamp(){return this._frameTime}drawOnInteracting(e,t,n){this.draw(t,n)}drawOutline(e){(this._outline||this._outlineAll)&&(this._outlineAll?this.paintOutlineAll(e):this._outline.forEach((t=>{this[t[0]](e,...t[1])})))}getAnalysisMeshes(){return this.getShadowMeshes()}getShadowMeshes(){const e=[];return this._getAllPlugins().forEach((t=>{if(!t)return;if(!this._isVisible(t))return;const n=t.getShadowMeshes();if(Array.isArray(n))for(let t=0;t<n.length;t++)e.push(n[t])})),e}isForeground(e){return!(!this._vtCurrentTiles||!this._vtCurrentTiles[e.properties.tile.id])}_getTileZoomDiff(e){const t=this.layer;let n=t._getTileZoom(this.getMap().getZoom());const i=t.getMinZoom(),s=t.getMaxZoom();return n=Zi.clamp(n,i,s),n-e.properties.tile.z}isTileNearCamera(e){return this._getTileZoomDiff(e)<=1}isBackTile(e){return!(!this._vtBgTiles||!this._vtBgTiles[e])}loadTileQueue(e){this._workersyncing||super.loadTileQueue(e)}loadTile(e){const{url:t}=e,n=this._requestingMVT[t];if(n)n.keys[e.id]||(n.tiles.push(e),n.keys[e.id]=1);else{const n=this.getMap(),i=hD.set(e.extent2d.xmin,e.extent2d.ymax),s=n.pointAtResToCoord(new Re(i),e.res),o=[iD(n,1,s,e.res)/100,iD(n,1,s,e.res,1)/100],a=this.getCentimeterToPoint(e.z),l=this.getTileGLScale(e.z);this._requestingMVT[t]={keys:{},tiles:[e]},this._requestingMVT[t].keys[e.id]=1;const h=this.layer.options.fetchOptions,c=window&&window.location.href,u=this.layer.options.altitudePropertyName,f=this.layer.options.disableAltitudeWarning,g=this.layer.options.loadTileErrorLog,m=this.layer.options.loadTileErrorLogIgnoreCodes,A={tileInfo:{res:e.res,x:e.x,y:e.y,z:e.z,url:xD(e),id:e.id,extent2d:e.extent2d},glScale:l,disableAltitudeWarning:f,loadTileErrorLog:g,loadTileErrorLogIgnoreCodes:m,altitudePropertyName:u,zScale:this._zScale,centimeterToPoint:o,verticalCentimeterToPoint:a,fetchOptions:h,styleCounter:this._styleCounter,referrer:c,workerCacheIndex:this._workerCacheIndex,command:"loadTile"};this.loadTileArrayBuffer&&aL(this.loadTileArrayBuffer)?this.loadTileArrayBuffer(A.tileInfo.url,e,((e,n)=>{e?this._onReceiveMVTData(t,e):n&&n instanceof ArrayBuffer?(A.tileArrayBuffer=n,this._workerConn.loadTile(A,this._onReceiveMVTData.bind(this,t))):console.error("loadTileArrayBuffer return data is not ArrayBuffer:",n)}),A):this._workerConn.loadTile(A,this._onReceiveMVTData.bind(this,t))}return{}}getTileGLScale(e){const t=this.getMap();return this.layer.getSpatialReference().getResolution(e)/t.getGLRes()}getCentimeterToPoint(e){const t=this.getMap();return dL(this.layer.getSpatialReference().getResolution(e),t)}getRenderedFeatures(){const e=this.tileCache.keys();return this._getFeaturesByKeys(e)}getCurrentRenderedFeatures(){const e=this._vtCurrentTiles&&Object.keys(this._vtCurrentTiles);return this._getFeaturesByKeys(e)}_getFeaturesByKeys(e){const t=[];for(let n=0;n<e.length;n++){const i=this.tileCache.get(e[n]);if(!i||!i.info||!i.image)continue;const{info:s,image:o}=i,a=vD(o);t.push({tile:{id:s.id,x:s.x,y:s.y,z:s.z,url:s.url},current:!!this.tilesInView[s.id],features:a})}return t}_onReceiveMVTData(e,t,n){if(this.setToRedraw(),!this._requestingMVT[e])return;if(n&&n.canceled)return;const i=this.layer,s=i.isDefaultRender(),{tiles:o}=this._requestingMVT[e];if(delete this._requestingMVT[e],t){if(t.status&&(404===t.status||204===t.status))for(let e=0;e<o.length;e++){this.onTileError(wL,o[e])}return}if(!n){for(let e=0;e<o.length;e++){this.consumeTile({_empty:!0},o[e])}return}if(n.styleCounter!==this._styleCounter)return;let a=!1;const l=n.features,h=[];for(let e=0;e<n.data.length;e++){const t=n.data[e];if(!t||!t.data||!t.styledFeatures.length)continue;const{isUpdated:i,layer:s}=this._parseTileData(0,e,t,l,h);h.push(s),i&&(a=i)}for(let e=0;e<n.featureData.length;e++){const t=n.featureData[e];t&&t.data&&t.styledFeatures.length&&this._parseTileData(1,e,t,l)}a&&i._compileStyle();const c=this.layer.getDataSchema(o[0].z);if(this._updateSchema(c,n.schema),delete n.features,s&&n.data.length!==h.length){const e=n.data;n.data=[];for(let t=0;t<e.length;t++)e[t]&&e[t].features&&n.data.push(e[t])}const u=i.options.debugTileData;n.layers=h;for(let e=0;e<o.length;e++){const t=o[e];if(0===e&&u){const{x:e,y:n,z:s}=t;(!0===u||u.x===e&&u.y===n&&u.z===s)&&console.log("tile",{layerId:i.getId(),x:e,y:n,z:s,layers:AD(Object.values(l))})}const s=0===e?n:gD(n);for(let e=0;e<s.data.length;e++){if(!s.data[e])continue;const n=s.data[e].features;for(const e in n)n[e].tile=t}t.extent=s.extent,this._receivedTileExtent||(this._receivedTileExtent=t.extent),s.features=Object.values(l),s.styleCounter=n.styleCounter,this.onTileLoad(s,t)}this.layer.fire("datareceived",{url:e})}_parseTileData(e,t,n,i){const{style:s,isUpdated:o}=this._updatePluginIfNecessary(e,t,n.data),a=this.layer,l=a.isDefaultRender(),h=FL(i,n.styledFeatures,t,s.symbol,a,!(!a.getData||!a.getData()));delete n.styledFeatures,n.features=h;let c=n.data;return Array.isArray(c)&&(c=c[0]),{isUpdated:o,layer:l?{layer:c.layer,type:c.type}:null}}_updateSchema(e,t){for(const n in t){e[n]||(e[n]={types:t[n].types,properties:{}});const i=t[n].properties,s=e[n].properties;for(const e in i)(!s[e]||s[e]&&"object"!==i[e]&&"object"===s[e])&&(s[e]=i[e])}}_updatePluginIfNecessary(e,t,n){Array.isArray(n)&&(n=n[0]);const i=this.layer;let s,o=!1;if(i.isDefaultRender()&&0===e){let e=this._layerPlugins;e||(e=this._layerPlugins={});const t=n.layer,i=n.type;e[t]||(e[t]=[]);const a=("plugin_"+i).trim();e[t][a]?s=e[t][a]:(s=this._getDefaultRenderPlugin(i),s.filter=n.filter,e[t].push(s),e[t][a]=s,o=!0)}else{const a=i._getComputedStyle(),l=i._getTargetStyle(e,a),h=this._getStylePlugins();if(s=l[t],!s.renderPlugin){o=!0;const{plugin:e,symbol:i,renderPlugin:a}=this._getDefaultRenderPlugin(n.type);h[t]=e,s.symbol=i,s.renderPlugin=a}}return{style:s,isUpdated:o}}_getFramePlugins(e){const t=e&&e.style;let n=this._getStylePlugins(t)||[];this.layer.isDefaultRender()&&this._layerPlugins&&(n=[],e?e.layers&&e.layers.forEach((e=>{if(!e)return;const t=("plugin_"+e.type).trim();n.push(this._layerPlugins[e.layer][t].plugin)})):Object.keys(this._layerPlugins).forEach((e=>{for(let t=0;t<this._layerPlugins[e].length;t++)n.push(this._layerPlugins[e][t].plugin)})));const i=this._getFeaturePlugins(t);return i&&i.length&&(n=n.slice(),cL(n,i)),n}_getAllPlugins(){if(this.layer.isDefaultRender()&&this._layerPlugins){const e=[];return Object.keys(this._layerPlugins).forEach((t=>{for(let n=0;n<this._layerPlugins[t].length;n++)e.push(this._layerPlugins[t][n].plugin)})),e}const e=[];for(const t in this._plugins)e.push(...this._plugins[t]);for(const t in this._featurePlugins)e.push(...this._featurePlugins[t]);return e}_getStylePlugins(e){return hL(e)&&(e=this._styleCounter),this._plugins[e]||lD}_getFeaturePlugins(e){return hL(e)&&(e=this._styleCounter),this._featurePlugins[e]||lD}_startFrame(e,t){const n=this._isRenderingTerrain(),i=this.layer.isDefaultRender()&&this._layerPlugins,s=this._parentContext;this._getAllPlugins().forEach(((o,a)=>{if(!o||t&&!t(o))return;if(!this._isVisible(a))return;const l={regl:this.regl||this.device,layer:this.layer,symbol:i?o.defaultSymbol:o.style&&o.style.symbol,gl:this.gl,isRenderingTerrain:n,sceneConfig:o.config?o.config.sceneConfig:null,dataConfig:o.config?o.config.dataConfig:null,pluginIndex:a,timestamp:e};s&&iL(l,s),o.startFrame(l)}))}_endFrame(e){const t=this._parentContext,n=t.renderMode,i=t&&t.renderTarget&&t.renderTarget.fbo,s=this.getMap().cameraPosition,o=this._getAllPlugins(),a=this._isRenderingTerrain(),l=!t.timestamp||t.isFinalRender;o.forEach(this.layer.options.collision&&!t.isPostProcess?t=>{if(!this._isVisible(t)||!t.hasMesh())return;if(n&&"default"!==n&&!t.supportRenderMode(n))return;if(a&&!dD(t))return;const i=this._getPluginContext(t,0,s,e);t.prepareRender(i),t.updateCollision(i)}:t=>{if(!this._isVisible(t)||!t.hasMesh())return;if(n&&"default"!==n&&!t.supportRenderMode(n))return;if(a&&!dD(t))return;const i=this._getPluginContext(t,0,s,e);t.prepareRender(i)});let h=!1;if(this._currentTimestamp!==t.timestamp&&!a){const t=this.layer.getPolygonOffset()+this.layer.getPolygonOffsetCount(),n=this._getPluginContext(null,t,s,e);n.offsetFactor=t,n.offsetUnits=t,this._groundPainter.paint(n)}o.forEach(((t,o)=>{if(!this._isVisitable(t))return;if(n&&"default"!==n&&!t.supportRenderMode(n))return;if(a&&!dD(t))return;this.device.clear({stencil:255,framebuffer:i});const l=this._getPluginContext(t,this._pluginOffsets[o]||0,s,e);t.painter&&t.painter.isEnableTileStencil(l)&&this._drawTileStencil(i,t.painter);const c=t.endFrame(l);c&&c.redraw&&this.setToRedraw(),h=!0})),h&&this.layer.fire("canvasisdirty"),l&&this._drawDebug()}getPolygonOffsetCount(){return this._polygonOffsetIndex||0}_drawDebug(){if(this.layer.options.debug){const e=this._parentContext,t=[],n=this.getMap().projViewMatrix;for(const i in this.tilesInView){const s=this.tilesInView[i].info,o=this.tilesInView[i].image;if(o._empty)continue;const a=s.transform,l=o.extent,h=e&&e.renderTarget;if(a&&l){const e=this.getDebugInfo(s.id),i=vA(t,n,a),o=this.layer.getTileSize().width;this._debugPainter.draw(e,i,o,l,h&&h.fbo)}}}}_isVisitable(e){if(!e)return!0;const t=this._parentContext,n=this._isVisible(e),i=t&&t.states&&t.states.includesChanged,s=this._hasMesh(e.painter.scene.getMeshes());return n&&(i||s)?s?2:1:0}_getPluginContext(e,t,n,i){const s=this._isRenderingTerrain(),o=s&&e&&fD(e),a={regl:this.regl||this.device,layer:this.layer,gl:this.gl,isRenderingTerrain:s,isRenderingTerrainSkin:o,sceneConfig:e&&e.config.sceneConfig,pluginIndex:e&&e.renderIndex,polygonOffsetIndex:t,cameraPosition:n,timestamp:i},l=this._parentContext;return l&&iL(a,l),a}_hasMesh(e){if(!e)return!1;const t=this._parentContext&&this._parentContext.sceneFilter;return t?e.filter((e=>t(e)||e.properties.hlBloomMesh&&t(e.properties.hlBloomMesh))).length>0:e.length>0}_drawTileStencil(e,t){const n=t.isUniqueStencilRefPerTile(),i=this.getCurrentTileZoom();let s=this._stencilRenderer;s||(s=this._stencilRenderer=new kL(this.regl||this.device,this.canvas,this.getMap())),s.start();const{tiles:o}=this._stencilTiles;let{parentTiles:a,childTiles:l}=this._stencilTiles,h=1;l=l.sort(mD);for(let e=0;e<l.length;e++){const t=n?h:this.getTileLevelValue(l[e].info,i);this._addTileStencil(l[e].info,t),h++}a=a.sort(mD);for(let e=0;e<a.length;e++){const t=n?h:this.getTileLevelValue(a[e].info,i);this._addTileStencil(a[e].info,t),h++}const c=o.sort(mD);for(let e=c.length-1;e>=0;e--){const t=n?h:this.getTileLevelValue(c[e].info,i);this._addTileStencil(c[e].info,t),h++}s.render(e)}_addTileStencil(e,t){const n=hD.set(e.extent2d.xmin,e.extent2d.ymax),i=e.extent||this._receivedTileExtent||8192,s=e.transform=e.transform||this.calculateTileMatrix(n,e.z,i);e.stencilRef=t,this._stencilRenderer.add(t,i,s)}onDrawTileStart(e){super.onDrawTileStart(e);const{tiles:t,childTiles:n,parentTiles:i}=e;this._vtCurrentTiles={},this._vtBgTiles={};for(let e=0;e<t.length;e++)this._vtCurrentTiles[t[e].info.id]=1;for(let e=0;e<n.length;e++)this._vtBgTiles[n[e].info.id]=1;for(let e=0;e<i.length;e++)this._vtBgTiles[i[e].info.id]=1;this._stencilTiles=e}isEnableTileStencil(){if(this.layer.options.altitude)return!1;const e=this._getFramePlugins();for(let t=0;t<e.length;t++)if(e[t]&&e[t].painter&&!e[t].painter.isOnly2D())return!1;return!0}setTerrainHelper(e){this._terrainLayer=e}getTerrainHelper(){return this._terrainLayer}drawTileOnTerrain(...e){Qe.prototype.drawTile.call(this,...e)}createTerrainTexture(e){const t=this.layer.getTileSize().width,n=2*t,i=2*t,s=e.texture({min:"linear",mag:"linear",type:"uint8",width:n,height:i});this._terrainDepthStencil||(this._terrainDepthStencil=e.texture({width:n,height:i,format:"depth stencil"}));const o={width:n,height:i,colors:[s],colorFormat:"rgba",ignoreStatusCheck:!0};o.depthStencil=this._terrainDepthStencil;const a=e.framebuffer(o);return a.colorTex=s,a}deleteTerrainTexture(e){e.destroy(),e.colorTex&&(e.colorTex.destroy(),delete e.colorTex)}renderTerrainSkin(e,t,n){this.isRenderingTerrainSkin=!0;const i=this._currentTimestamp,s=this._parentContext,o=this.layer.getTileSize().width;this._startFrame(i);for(let t=0;t<n.length;t++){const i=n[t],s=i.texture;this._parentContext={terrainMaskFBO:i.terrainMaskFBO,renderTarget:{fbo:s}},uD.framebuffer=s,e.clear(uD),this._parentContext.viewport=_D(o),this._drawTerrainTile(i.tile)}this._endTerrainFrame(n),this._parentContext=s,this.isRenderingTerrainSkin=!1}_drawTerrainTile(e){const{info:t,image:n}=e;this.drawTile(t,n,fD)}_endTerrainFrame(e){const t=this._getAllPlugins(),n=this.getMap().cameraPosition,i=this._currentTimestamp||0;t.forEach(this.layer.options.collision?e=>{if(!this._isVisible(e)||!e.hasMesh())return;if(!fD(e)||!this.layer.options.awareOfTerrain)return;const t=this._getPluginContext(e,0,n,i);t.isRenderingTerrainSkin=!0,e.prepareRender(t),e.updateCollision(t)}:e=>{if(!this._isVisible(e)||!e.hasMesh())return;if(!fD(e)||!this.layer.options.awareOfTerrain)return;const t=this._getPluginContext(e,0,n,i);t.isRenderingTerrainSkin=!0,e.prepareRender(t)}),t.forEach(((t,n)=>{if(!this._isVisitable(t)||!fD(t))return;for(let t=0;t<e.length;t++){this.device.clear({stencil:255,framebuffer:e[t].texture})}const i=this._getPluginContext(t,this._pluginOffsets[n]||0,[0,0,0],this._currentTimestamp);i.isRenderingTerrainSkin=!0,t.endFrame(i)}))}drawTile(e,t,n){if(!t.cache)return;const i=this._isRenderingTerrain(),s=t.cache,o=hD.set(e.extent2d.xmin,e.extent2d.ymax),a=e.extent||this._receivedTileExtent||8192,l=e.transform=e.transform||this.calculateTileMatrix(o,e.z,a),h=e.tileTranslationMatrix=e.tileTranslationMatrix||this.calculateTileTranslationMatrix(o,e.z),c=e.terrainTransform=e.terrainTransform||this.calculateTerrainTileMatrix(o,e.z,a),u=this._parentContext,f=[];cL(f,t.data),cL(f,t.featureData);const g=this._getFramePlugins(t);n||!i||this.isRenderingTerrainSkin||(n=dD),g.forEach(((o,a)=>{if(!o||n&&!n(o))return;if(!f[a])return;if(!s[a])return;if(this.drawingParentTiles&&!o.painter.shouldDrawParentTile())return;const g=i&&fD(o),m={regl:this.regl||this.device,layer:this.layer,gl:this.gl,sceneConfig:o.config.sceneConfig,pluginIndex:a,tileCache:s[a],tileData:f[a],tileTransform:g?c:l,tileVectorTransform:l,tileTranslationMatrix:h,tileExtent:t.extent,timestamp:this._frameTime,tileInfo:e,tileZoom:this._tileZoom,bloom:this._parentContext&&this._parentContext.bloom,isRenderingTerrain:i,isRenderingTerrainSkin:g};g&&u&&u.renderTarget&&(m.renderTarget=u.renderTarget,o.isTerrainMask()&&(m.renderTarget={fbo:u.terrainMaskFBO}));const A=o.paintTile(m);!this._needRetire&&(A.retire||A.redraw)&&o.supportRenderMode("taa")&&(this._needRetire=!0),A.redraw&&this.setToRedraw()})),t&&t.style===this._styleCounter&&this._retirePrevTile(e)}_createOneTile(e,t){if(!t.loadTime||t._empty)return;let n=t.cache;n||(n=t.cache={});const i=this._isRenderingTerrain(),s=hD.set(e.extent2d.xmin,e.extent2d.ymax),o=e.transform=e.transform||this.calculateTileMatrix(s,e.z,t.extent),a=e.tileTranslationMatrix=e.tileTranslationMatrix||this.calculateTileTranslationMatrix(s,e.z),l=e.terrainTransform=e.terrainTransform||this.calculateTerrainTileMatrix(s,e.z,e.extent),h=[];cL(h,t.data),cL(h,t.featureData),this._getFramePlugins(t).forEach(((s,c)=>{if(!s)return;if(!h[c])return;const u=i&&fD(s),f=this.regl||this.device,g=this.gl;n[c]||(n[c]={});const m=s.createTile({regl:f,layer:this.layer,gl:g,sceneConfig:s.config.sceneConfig,pluginIndex:c,tileCache:n[c],tileData:h[c],tileTransform:u?l:o,tileVectorTransform:o,isRenderingTerrain:i,isRenderingTerrainSkin:u,tileTranslationMatrix:a,tileExtent:t.extent,timestamp:this._frameTime,tileInfo:e,tileZoom:this._tileZoom});n[c].geometry&&(t.data[c]="geometry created"),!this._needRetire&&m.retire&&s.supportRenderMode("taa")&&(this._needRetire=!0)}))}checkTileInQueue(e){return e.styleCounter===this._styleCounter}pick(e,t,n){const i=[];return this.layer.isVisible()?(this._getFramePlugins().forEach((s=>{if(!s)return;if(!1===(s.painter&&s.painter.sceneConfig).picking)return;if(!s.isVisible())return;const o=s.pick(e,t,n.tolerance);o&&(o.type=s.getType(),i.push(o))})),i):i}deleteTile(e){if(e){if(e.image&&!e.image._empty){const t=this._getStylePlugins(e.image&&e.image.style);t&&t.forEach(((t,n)=>{t&&t.deleteTile({pluginIndex:n,regl:this.regl,layer:this.layer,gl:this.gl,tileCache:e.image.cache?e.image.cache[n]:{},tileInfo:e.info,tileData:e.image})})),e.image.cache={}}e.info&&(delete e.info.completeTerrainQuery,delete e.info.terrainQueryStatus),super.deleteTile(e)}}abortTileLoading(e,t){const n=t?xD(t):"";t&&t.url&&(this._workerConn&&this._workerConn.abortTile(n),delete this._requestingMVT[t.url]),this.loadTileArrayBuffer&&aL(this.loadTileArrayBuffer)?this.loadTileArrayBuffer(n,t,(()=>{}),{command:"abortTile"}):super.abortTileLoading(e,t)}resizeCanvas(e){super.resizeCanvas(e);const t=this.canvas;t&&(!this.pickingFBO||this.pickingFBO.width===t.width&&this.pickingFBO.height===t.height||(this.pickingFBO.resize(t.width,t.height),this._getFramePlugins().forEach((e=>{e&&e.resize(t.width,t.height)}))))}onRemove(){this._stencilRenderer&&this._stencilRenderer.remove(),this._workerConn&&(this._workerConn.removeLayer((e=>{if(e)throw e})),this._workerConn.remove(),delete this._workerConn),this.pickingFBO&&(this.canvas.pickingFBO||this.pickingFBO.destroy(),delete this.pickingFBO),this._debugPainter&&(this._debugPainter.delete(),delete this._debugPainter),this._terrainDepthStencil&&(this._terrainDepthStencil.destroy(),delete this._terrainDepthStencil),this._groundPainter&&(this._groundPainter.dispose(),delete this._groundPainter),delete this.gl,delete this.regl,super.onRemove&&super.onRemove(),this._clearPlugin()}_clearPlugin(){this._getAllPlugins().forEach((e=>{e.remove()})),this.plugins={}}hitDetect(e){if(!this.gl||!this.layer.options.hitDetect)return!1;const t=this.gl,n=new Uint8Array(4);return t.readPixels(e.x,this.canvas.height-e.y,1,1,t.RGBA,t.UNSIGNED_BYTE,n),n[3]>0}_initPlugins(){const{style:e,featureStyle:t}=this.layer._getComputedStyle(),n=e.map(((e,t)=>{const n=e.renderPlugin;if(!n)return null;if(!n.type)throw new Error("invalid plugin type for style at "+t);const i=this._createRenderPlugin(n);return i.styleCounter=this._styleCounter,i.style=e,i})),i=[];t.forEach(((e,t)=>{const n=e.renderPlugin;if(!n)return null;if(!n.type)throw new Error("invalid plugin type for features at "+t);const s=this._createRenderPlugin(n);return s.style=e,s.styleCounter=this._styleCounter,i.push(s),s}));const s=this._styleCounter;return this._plugins[s]=n,this._featurePlugins[s]=i,this.layer.fire("pluginsinited"),(this._highlighted&&this._highlighted.size||this.layer._highlighted)&&(this.layer._highlighted&&this.layer._resumeHighlights(),this.getMap().getRenderer().callInNextFrame((()=>{this._getFramePlugins().forEach((e=>{e.highlight(this._highlighted)}))}))),n}_createRenderPlugin(e){const t=this.layer.constructor.getPlugins()[e.type];if(!t)throw new Error(`Plugin for (${e.type}) is not loaded.`);const n=new t;return n.config=e,n.config.sceneConfig||(n.config.sceneConfig={}),n}_createGLContext(e,t){const n=["webgl","experimental-webgl"];let i=null;for(let s=0;s<n.length;++s){try{i=e.getContext(n[s],t)}catch(e){}if(i)break}return i}_getCentiMeterScale(e){return dL(e,this.getMap())}debugFBO(e,t){const n=document.getElementById(e),i=t.width,s=t.height;n.width=i,n.height=s;const o=n.getContext("2d"),a=this.regl.read({framebuffer:t}),l=s/2|0,h=4*i;for(let e=0;e<a.length;e++)a[e]*=255;const c=new Uint8Array(4*i);for(let e=0;e<l;++e){const t=e*h,n=(s-e-1)*h;c.set(a.subarray(t,t+h)),a.copyWithin(t,n,n+h),a.set(c,n)}const u=new ImageData(i,s);u.data.set(a),o.putImageData(u,0,0)}_getDefaultRenderPlugin(e){let t;switch(e){case"native-line":t={type:"native-line",dataConfig:{type:"native-line",only2D:!0}};break;case"native-point":t={type:"native-point",dataConfig:{type:"native-point",only2D:!0}};break;case"fill":t={type:"fill",dataConfig:{type:"fill",only2D:!0},sceneConfig:{antialias:!0}};break;default:t=null}const n=function(e){switch(e){case"native-point":return{markerFill:"#f00",markerSize:6,markerOpacity:.5};case"native-line":return{lineColor:"#bbb",lineOpacity:.5};case"fill":return{polygonFill:"#76a6f0",polygonOpacity:.8}}return null}(e),i=this._createRenderPlugin(t);return i.defaultSymbol=n,{plugin:i,symbol:n,renderPlugin:t}}_isVisible(){return!0}isEnableWorkAround(e){return"win-intel-gpu-crash"===e&&this.layer.options.workarounds["win-intel-gpu-crash"]&&function(e){const t=e.getExtension("WEBGL_debug_renderer_info");if(t&&"undefined"!=typeof navigator){const n=e.getParameter(t.UNMASKED_RENDERER_WEBGL),i="Win32"===navigator.platform||"Win64"===navigator.platform;if(n&&n.toLowerCase().indexOf("intel")>=0&&i)return!0}return!1}(this.gl)}getZScale(){return this._zScale}outline(e,t){t&&(Array.isArray(t)||(t=[t]),this._outline||(this._outline=[]),this._outline.push(["paintOutline",[e,t]]),this.setToRedraw())}outlineFeatures(e){e&&(Array.isArray(e)||(e=[e]),this._outline||(this._outline=[]),this._outline.push(["paintOutline",[null,e]]),this.setToRedraw())}outlineBatch(e){this._outline||(this._outline=[]),this._outline.push(["paintBatchOutline",[e]]),this.setToRedraw()}outlineAll(){this._outlineAll=!0,this.setToRedraw()}paintOutlineAll(e){const t=this._getFramePlugins();for(let n=0;n<t.length;n++)t[n].outlineAll(e)}paintOutline(e,t,n){if(!hL(t)){const i=t,s=this._getFramePlugins();if(!s[i]||s[i].painter&&!s[i].painter.isVisible())return;return void s[i].outline(e,n)}const i=this._getFramePlugins();for(let t=0;t<n.length;t++){const s=n[t];for(let t=0;t<i.length;t++)i[t].style&&i[t].style.id===s&&i[t].outline(e,[s])}}paintBatchOutline(e,t){const n=this._getFramePlugins();!n[t]||n[t].painter&&!n[t].painter.isVisible()||n[t].outlineAll(e)}cancelOutline(){delete this._outline,delete this._outlineAll,this.setToRedraw()}setZIndex(){return this.setToRedraw(),this._needRetire=!0,super.setZIndex.apply(this,arguments)}consumeTile(e,t){if(e&&!e._empty){const[n,i]=this._findTileAltitude(e);t.minAltitude=n,t.maxAltitude=i}if(this._retirePrevTile(t),super.consumeTile(e,t),"transient"===this.layer.options.features&&e.data){for(let t=0;t<e.data.length;t++){if(!e.data[t])continue;const n=e.data[t].features;if(n)for(const e in n){const t=n[e]&&n[e].feature;t&&(t.fnTypeProps?t.customProps[HL]=t.fnTypeProps:n[e]=null)}}this.layer.fire("_transientfeature",{tileImage:e})}e&&e.features&&(e.features=[]),this._createOneTile(t,e)}_findTileAltitude(e){const t=e.data;let n=-1/0,i=1/0;for(let e=0;e<t.length;e++){if(!t[e])continue;const s=t[e].data;if(s)for(let e=0;e<s.length;e++){const t=s[e];if(!t||!t.properties)continue;const{maxAltitude:o,minAltitude:a}=t.properties;o>n&&(n=o),a<i&&(i=a)}}return cD[0]=i===1/0?0:i,cD[1]=n===-1/0?0:n,cD}onTileError(e,t){this._retirePrevTile(t),super.onTileError(e,t)}_retirePrevTile(e){const{id:t}=e;if(this._prevTilesInView&&this._prevTilesInView[t]){this.deleteTile(this._prevTilesInView[t]),delete this._prevTilesInView[t]}}highlight(e){if(this._highlighted||(this._highlighted=new Map),Array.isArray(e))for(let t=0;t<e.length;t++)hL(e[t].name)&&!hL(e[t].id)&&(e[t]=iL({},e[t]),e[t].name=e[t].id),this._highlighted.set(e[t].name,e[t]);else hL(e.name)&&!hL(e.id)&&((e=iL({},e)).name=e.id),this._highlighted.set(e.name,e);this._getFramePlugins().forEach((e=>{e.highlight(this._highlighted)})),this._highlightUpdated=!0}cancelHighlight(e){if(this._highlighted){if(Array.isArray(e))for(let t=0;t<e.length;t++)this._highlighted.delete(e[t]);else this._highlighted.delete(e);this._getFramePlugins().forEach((e=>{e.highlight(this._highlighted)})),this._highlightUpdated=!0}}cancelAllHighlight(){this._highlighted&&(delete this._highlighted,this._getFramePlugins().forEach((e=>{e.cancelAllHighlight()})),this._highlightUpdated=!0)}_getLayerOpacity(){const e=this.layer.options.opacity;return hL(e)?1:e}_isRenderingTerrain(){return!!this._terrainLayer&&this.layer.options.awareOfTerrain}};function gD(e){let t;Array.isArray(e.data)?(t=[],cL(t,e.data)):(t={},iL(t,e.data));const n=iL({},e);return n.data=t,n}function mD(e,t){return t.info.z-e.info.z}function AD(e){const t={};for(let n=0;n<e.length;n++){const i=e[n].layer||"default";t[i]||(t[i]=[]),t[i].push(e[n])}return t}function yD(e){if(Array.isArray(e)){const t=e;for(let e=0;e<t.length;e++)if(yD(t[e]))return!0}for(const t in e)if(SE(e[t])||aD.isExpression(e[t]))return!0;return!1}function _D(e){return{x:0,y:0,width:2*e,height:2*e}}function vD(e){if(!e.cache)return[];for(const t in e.cache){const n=e.cache[t];if(n.geometry)for(let e=0;e<n.geometry.length;e++){const t=n.geometry[e]&&n.geometry[e].geometry;if(t&&t.properties&&t.properties.features){const e=t.properties.features.empty;delete t.properties.features.empty;const n=Object.values(t.properties.features);return void 0!==e&&(t.properties.features.empty=e),n}}}return[]}function xD(e){return Zi.getAbsoluteURL(e.url)}pD.include({calculateTileMatrix:function(){const e=new Array(3),t=new Array(3),n=new Array(3);return function(i,s,o){const a=this.getTileGLScale(s),l=i,h=this.layer.getTileSize().width,c=AA([]);return bA(c,c,ZA(e,a,a,this._zScale)),xA(c,c,ZA(t,l.x,l.y,0)),bA(c,c,ZA(n,h/o,-h/o,1)),c}}(),calculateTerrainTileMatrix:function(){const e=new Array(3);return function(t,n,i){const s=AA([]),o=i/2;return bA(s,s,ZA(e,1/o,-1/o,0)),xA(s,s,ZA(e,-o,-o,0)),s}}(),calculateTileTranslationMatrix:function(){const e=new Array(3);return function(t,n){const i=this.getTileGLScale(n),s=t,o=AA([]);return xA(o,o,ZA(e,s.x*i,s.y*i,0)),o}}()});const{PackUtil:bD}=eL(),wD=new Re(0,0),TD=new fl(0,0),SD=[null,0],MD=[];let CD=class ft extends Up{static loadFrom(e,t){return fetch(e,t||{}).then((e=>e.json())).then((e=>ft.fromJSON(e)))}constructor(e,t){super(e,t),this.isVectorTileLayer=!0,this.hasTerrainMask=!0,this._schema={},this.VERSION=ft.VERSION;this.setStyle(t&&t.style)}setURLModifier(e){this._urlModifier=e;const t=this.getRenderer();return t&&t.updateOptions(),this}getURLModifier(){return this._urlModifier}onAdd(){const e=this.getMap();this._prepareOptions();const t=this.getSpatialReference().toJSON().projection,n=e.getSpatialReference().toJSON().projection;if((t&&t.toLowerCase())!==(n&&n.toLowerCase()))throw new Error(`VectorTileLayer's projection(${t}) must be the same with map(${n}).`)}setFeatureState(e,t){if(hL(e.id))throw new Error("missing id in first parameter of setFeatureState.");this._featureStates||(this._featureStates={});const n=e.layer||"0";let i=this._featureStates[n];return this._featureStates[n]||(i=this._featureStates[n]=new Map),i.set(e.id,t),this._markFeatureState(),this}removeFeatureState(e,t){if(hL(e.id))throw new Error("missing id in first parameter of removeFeatureState.");if(!this._featureStates)return this;const n=this._featureStates[e.layer||"0"];if(!n)return this;if(t){const i=n.get(e.id);if(lL(t))for(const e in t)delete i[e];else delete i[t];n.set(e.id,i)}else n.delete(e.id);return this._markFeatureState(),this}getFeatureState(e){if(hL(e.id))throw new Error("missing id in first parameter of getFeatureState.");if(!this._featureStates)return null;return this._featureStates[e.layer||"0"].get(e.id)}_markFeatureState(){const e=this.getRenderer();if(!e)return;const t=e.getFrameTimestamp();this._featureStamp=t}_getFeatureStateStamp(){return this._featureStamp}_isFeatureStateDirty(e){return this._featureStamp&&this._featureStamp!==e}_prepareOptions(){const e=this.options,t=this.getMap().getProjection(),n="EPSG:4326"===t.code||"EPSG:4490"===t.code,i="EPSG:3857"===t.code;e.spatialReference||512===this.getTileSize().width&&(i?e.spatialReference="preset-vt-3857":n&&(e.spatialReference="preset-vt-4326")),e.tileSystem||(e.tms?i?e.tileSystem=[1,1,-6378137*Math.PI,-6378137*Math.PI]:n&&(e.tileSystem=[1,1,-180,-90]):n&&(e.tileSystem=[1,-1,-180,90]))}forceReload(){const e=this.getRenderer();return e&&e._incrWorkerCacheIndex(),super.forceReload()}onWorkerReady(){}onConfig(e){const t=this.getRenderer();t&&t.updateOptions(e)}getWorkerOptions(){const e=this.getMap().getRenderer().isWebGPU();return{debug:this.options.debug,debugTile:this.options.debugTile,altitudeProperty:this.options.altitudeProperty,tileSize:this.getTileSize().width,style:this.isDefaultRender()?{style:[],featureStyle:[]}:this._getComputedStyle(),features:this.options.debugTileData||this.options.features,schema:this.options.schema,pickingGeometry:this.options.pickingGeometry,projectionCode:this.getSpatialReference().getProjection().code,workerGlyph:this.options.workerGlyph&&!this.getURLModifier(),featureIdProperty:this.options.featureIdProperty,isWebGPU:e}}setStyle(e){if(e&&(sL(e)||e.url)){const t=e,n=t.lastIndexOf("/"),i=n<0?".":t.substring(0,n);return this.ready=!1,mL.getJSON(e.url?e.url:e,e.url?e:{},((e,n)=>{if(e)throw this.setStyle([]),e;let s;n.style?(s=n,s.$root||(s.$root=i)):s={$root:i,style:n},this.options.style=t,this._setStyle(s)})),this}return this.options.style=e,this._setStyle(e),this}_tilePointToPoint(e,t,n,i){const s=i/this.getTileSize().width;return e.set(n.x+t.x/s,n.y-t.y/s)}queryTilePointTerrain(e,t,n,i,s){const o=this.getRenderer(),a=o&&o.getTerrainHelper();if(!o||!a)return SD[0]=null,SD[1]=0,SD;const l=this._tilePointToPoint(wD,e,n,i);return t&&a.queryTileTerrainByPointAtRes?a.queryTileTerrainByPointAtRes(l,s,t.id,t,MD):(SD[0]=null,SD[1]=0,SD)}queryTerrainTiles(e){const t=this.getRenderer(),n=t&&t.getTerrainHelper();return t&&n?n.getTerrainTiles(this,e):null}_setStyle(e){if(e&&e.$root){let t=e.$root;t&&"/"===t[t.length-1]&&(t=t.substring(0,t.length-1)),this._replacer=function(e){return"{$root}"===e?t:null}}this.ready=!0,e=e||[],Array.isArray(e)?e={style:e}:e.renderPlugin&&(e={style:[e]}),e=function(e){if(!e.plugins)return e;const{plugins:t,styles:n}=e;let{style:i,featureStyle:s}=n;i=i||[],s=s||[];const o=new Array(i.length);for(let e=0;e<i.length;e++)o[e]=iL({},i[e]),o[e].renderPlugin=t[i[e].renderPlugin];const a=new Array(s.length);for(let e=0;e<s.length;e++)a[e]=iL({},s[e]),a[e].renderPlugin=t[s[e].renderPlugin];const l={style:o,featureStyle:a};return e.$root&&(l.$root=e.$root),l}(e=qL(e)),this._originFeatureStyle=e.featureStyle||[],this._featureStyle=function(e){if(!e||!Array.isArray(e))return[];const t=[];for(let n=0;n<e.length;n++){const i=e[n].style;if(i&&Array.isArray(i)&&i.length)for(let s=0;s<i.length;s++){const o=iL({},e[n],i[s]);i[s]._renderIdx=t.length,delete o.style,t.push(o)}else t.push(iL({},e[n]))}return t}(e.featureStyle),this._vtStyle=e.style||[];const t=e.background||{};this._background={enable:t.enable||!1,color:ID(t.color)||[0,0,0,0],opacity:kD(t.opacity,1),patternFile:t.patternFile,depthRange:t.depthRange},this.validateStyle(),this._replacer&&this._parseStylePath(),this._compileStyle();const n=this.getRenderer();n&&n.setStyle(),this.fire("setstyle",{style:this.getStyle(),computedStyle:this.getComputedStyle()})}getPolygonOffsetCount(){const e=this.getRenderer();return e?e.getPolygonOffsetCount():0}getPolygonOffset(){return this._polygonOffset||0}setPolygonOffset(e,t){return this._polygonOffset=e,this._totalPolygonOffset=t,this}getTotalPolygonOffset(){return this._totalPolygonOffset}_convertTileFeatuers(e){for(let t=0,n=e.length;t<n;t++){const n=e[t];if(!n)continue;this._convertFeatures(n.features||[])}return e}_convertFeatures(e){if(!e||!e.length)return;const t=this._getTileConfig();let n;for(let i=0,s=e.length;i<s;i++){const{feature:s,tile:o}=e[i],a=s.geometry;if(!s||!o||!a)continue;if(a.type)continue;const{x:l,y:h,res:c,extent:u}=o;void 0===l&&void 0===h&&void 0===c||(n=t.getTilePointNW(l,h,c));const f=this._convertGeometry(s.type,a,n,u,c);s.geometry=f}}getCurrentRenderedFeatures(){const e=this.getRenderer();if(!e)return[];const t=e.getCurrentRenderedFeatures()||[];return this._convertTileFeatuers(t)}getRenderedFeatures(){const e=this.getRenderer();if(!e)return[];const t=e.getRenderedFeatures()||[];return this._convertTileFeatuers(t)}getRenderedFeaturesAsync(e={}){return new Promise(((t,n)=>{const i=this.getRenderer();if(i)if(Do){const n=i.getRenderedFeatures()||[],s=[];n.forEach((e=>{const t=e.features||[];t.length&&cL(s,t)}));const o=(e=Object.assign({},{countPerTime:1e4},e)).countPerTime,a=Math.ceil(s.length/o);let l=1;const h=()=>{const e=s.slice((l-1)*o,l*o);this._convertFeatures(e),l++};Do.runTaskAsync({count:a,run:h}).then((()=>{t(n)}))}else t(this.getRenderedFeatures());else t([])}))}outlineAll(){const e=this.getRenderer();return e?(e.outlineAll(),this):this}outline(e,t){const n=this.getRenderer();return n?(n.outline(e,t),this):this}outlineBatch(e){const t=this.getRenderer();return t?(t.outlineBatch(e),this):this}outlineFeatures(e){const t=this.getRenderer();return t?(t.outlineFeatures(e),this):this}cancelOutline(){const e=this.getRenderer();return e?(e.cancelOutline(),this):this}highlight(e){this._validateHighlight(e);const t=this.getRenderer();return t?(t.highlight(e),this):(this._highlighted||(this._highlighted=[]),this._highlighted.push(e),this)}_validateHighlight(e){if(Array.isArray(e))for(let t=0;t<e.length;t++)this._validateHighlight(e[t]);else{if(e.filter){if(!this.options.features)throw new Error("options.features must be turned on to support filter in highlight");if(!e.name)throw new Error("A name is required for highlight with filter")}if(hL(e.filter)&&hL(e.id))throw new Error("id or filter must be provided for highlight")}}_resumeHighlights(){if(this._highlighted){for(let e=0;e<this._highlighted.length;e++)this.highlight(this._highlighted[e]);delete this._highlighted}}cancelHighlight(e){const t=this.getRenderer();return t?(t.cancelHighlight(e),this):this}cancelAllHighlight(){const e=this.getRenderer();return e?(e.cancelAllHighlight(),this):this}_parseStylePath(){Zi.convertStylePath(this._vtStyle,this._replacer),Zi.convertStylePath(this._featureStyle,this._replacer)}updateSceneConfig(e,t){return sL(e)&&(e=this._getStyleIndex(e)),this._updateSceneConfig(0,e,t)}updateFeatureSceneConfig(e,t,n){return this._updateSceneConfig(1,e,n,t)}_updateSceneConfig(e,t,n,i){const s=this._getTargetStyle(e);if(!s)return this;let o,a=t;if(s[t].renderPlugin.sceneConfig||(s[t].renderPlugin.sceneConfig={}),iL(s[t].renderPlugin.sceneConfig,n),void 0!==i){OD(this._originFeatureStyle,t,i),a=this._originFeatureStyle[t].style[i]._renderIdx;const e=s[a].renderPlugin;e.sceneConfig||(e.sceneConfig={}),o=e.sceneConfig}else ED(s,t),o=s[t].renderPlugin.sceneConfig;if(iL(o,n),Array.isArray(this.options.style)){const e=this.options.style[t].renderPlugin;e.sceneConfig||(e.sceneConfig={}),iL(e.sceneConfig,n)}else{const s=this._getTargetStyle(e,this.options.style);let o;void 0!==i?(OD(s,t,i),o=s[t].style[i].renderPlugin):(ED(s,t),o=s[t].renderPlugin),o.sceneConfig||(o.sceneConfig={}),iL(o.sceneConfig,n)}const l=this.getRenderer();return l&&l.updateSceneConfig(e,a,n),0===e?this.fire("updatesceneconfig",{index:t,sceneConfig:n}):1===e&&this.fire("updatefeaturesceneconfig",{index:t,styleIdx:i,sceneConfig:n}),this}updateDataConfig(e,t){return sL(e)&&(e=this._getStyleIndex(e)),this._updateDataConfig(0,e,t)}updateFeatureDataConfig(e,t,n){return this._updateDataConfig(1,e,n,t)}_updateDataConfig(e,t,n,i){const s=this._getTargetStyle(e);if(!s)return this;let o,a=t;void 0!==i?(OD(this._originFeatureStyle,t,i),a=this._originFeatureStyle[t].style[i]._renderIdx,o=s[a].renderPlugin.dataConfig):(ED(s,t),o=s[t].renderPlugin.dataConfig);const l=iL({},o);if(iL(o,n),Array.isArray(this.options.style))iL(this.options.style[t].renderPlugin.dataConfig,n);else{const s=this._getTargetStyle(e,this.options.style);let o;void 0!==i?(OD(s,t,i),o=s[t].style[i].renderPlugin):(ED(s,t),o=s[t].renderPlugin),o.dataConfig||(o.dataConfig={}),iL(o.dataConfig,n)}const h=this.getRenderer();return h&&h.updateDataConfig(e,a,n,l),0===e?this.fire("updatedataconfig",{index:t,dataConfig:n}):1===e&&this.fire("updatefeaturedataconfig",{index:t,styleIdx:i,dataConfig:n}),this}updateSymbol(e,t){return sL(e)&&(e=this._getStyleIndex(e)),this._updateSymbol(0,e,t)}updateFeatureSymbol(e,t,n){return this._updateSymbol(1,e,n,t)}_updateSymbol(e,t,n,i){const s=this._getTargetStyle(e);if(!s)return this;let o=t;void 0!==i&&(OD(this._originFeatureStyle,t,i),o=this._originFeatureStyle[t].style[i]._renderIdx);const a=s[o];if(!a)throw new Error(`No style defined at ${t}`);const l=this,h=this._replacer;function c(n,s,o){if(!n)return!1;h&&(n=JSON.parse(JSON.stringify(n)),Zi.parseSymbolPath(n,h));const a=Object.keys(n);let c=!1;for(let e=0;e<a.length;e++){const t=a[e];if(PD(s[t])||PD(n[t])){c=!0;break}}for(const e in n)fL(n,e)&&(!Zi.isObject(n[e])||Array.isArray(n[e])||SE(n[e])?s[e]=n[e]:(s[e]||(s[e]={}),iL(s[e],n[e])));let u=l.options.style;if(sL(u))return c;Array.isArray(u)||(u=l._getTargetStyle(e,l.options.style));const f=JSON.parse(JSON.stringify(s));return void 0!==i?(OD(u,t,i),void 0===o?u[t].style[i].symbol=f:u[t].style[i].symbol[o]=f):(ED(u,t),void 0===o?u[t].symbol=f:u[t].symbol[o]=f),c}const u=this.getRenderer();if(!u)return c(),this._compileStyle(),this;let f=!1;const g=a.symbol;if(Array.isArray(n))for(let e=0;e<n.length;e++){const t=c(n[e],g[e],e);t&&(f=t)}else c(n,g);return this._compileStyle(),f?u.setStyle():(f=u.updateSymbol(e,o,n),f&&u.setStyle()),0===e?this.fire("updatesymbol",{index:t,symbol:n}):1===e&&this.fire("updatefeaturesymbol",{index:t,featureStyleIndex:i,symbol:n}),this}_getTargetStyle(e,t){return t?0===e?t.style:t.featureStyle:0===e?this._vtStyle:this._featureStyle}isDefaultRender(){return!!this._isDefaultRender&&this.options.defaultRendering}validateStyle(){this._isDefaultRender=!1;let e=this._vtStyle;this.options.style||(this._isDefaultRender=!0,e=this._vtStyle=[]),Array.isArray(e)||(e=this._vtStyle=[e]);for(let t=0;t<e.length;t++){let n=e[t].filter;if(n&&n.value&&(n=n.value),n||console.warn(`render plugin at ${t} doesn't define filter, its filter will be set to 'default' by default.`),void 0!==n&&"default"!==n&&!0!==n&&!Array.isArray(n)&&void 0===n.condition)throw new Error(`Invalid filter at ${t} : ${JSON.stringify(n)}`);e[t].symbol||(e[t].symbol={})}}getStyle(){return this.options.style?JSON.parse(JSON.stringify(this.options.style)):null}_getStyleIndex(e){const t=this._vtStyle;if(!t)return-1;for(let n=0;n<t.length;n++)if(t[n].name===e)return n;throw new Error(`No style defined with name: ${e}`)}getGroundConfig(){this._backgroundConfig||(this._backgroundConfig={enable:!0,renderPlugin:{type:"fill",sceneConfig:{}},symbol:{polygonFill:[0,0,0,0],polygonOpacity:1}});const e=this._getComputedStyle().background||{};return this._backgroundConfig.enable=e.enable,this._backgroundConfig.symbol.polygonFill=e.color,this._backgroundConfig.symbol.polygonOpacity=e.opacity,this._backgroundConfig.symbol.polygonPatternFile=e.patternFile,this._backgroundConfig.renderPlugin.sceneConfig.depthRange=e.depthRange,this._backgroundConfig}getComputedStyle(){return JSON.parse(JSON.stringify(this._getComputedStyle()))}_getComputedStyle(){return{background:this._background,style:this._vtStyle||[],featureStyle:this._featureStyle||[]}}identify(e,t={}){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];const s=n.coordToContainerPoint(new fl(e));return this.identifyAtPoint(s,t)}identifyAtPoint(e,t={}){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];const s=n.getDevicePixelRatio();let o=i.pick(e.x*s,e.y*s,t);return this.options.features&&"id"!==this.options.features&&(o=this._convertPickedFeature(o)),t&&t.filter?o.filter((e=>t.filter(e))):o}_convertPickedFeature(e){if(!this.getRenderer())return e;const t=this._getTileConfig(),n=this.getSpatialReference();for(let i=0;i<e.length;i++){let s=e[i];if(!s||!s.data)continue;const{tile:o}=s.data,{x:a,y:l,z:h,extent:c}=o,u=n.getResolution(h),f=t.getTilePointNW(a,l,u),g=s.data.feature&&s.data.feature.geometry;if(g){s.data=iL({},s.data),s.data.feature=iL({},s.data.feature);const e=s.data.feature.type;s.data.feature.type="Feature",s.data.feature.geometry=this._convertGeometry(e,g,f,c,u)}}return e}_convertGeometry(e,t,n,i,s){if(t.type&&t.coordinates)return t;let o,a;if(1===e)t.length<=1?(o="Point",a=this._convertGeometryCoords(t,n,i,s)||[]):(o="MultiPoint",a=this._convertGeometryCoords(t,n,i,s));else if(2===e)t.length<=1?(o="LineString",a=this._convertGeometryCoords(t,n,i,s)||[]):(o="MultiLineString",a=this._convertGeometryCoords(t,n,i,s));else if(3===e){a=[];let e=[],l=0;for(let o=0;o<t.length;o++)bD.calculateSignedArea(t[o])>0&&(l++,e&&e.length&&a.push(e),e=[]),e.push(this._convertGeometryCoords(t[o],n,i,s));e.length&&a.push(e),l<=1?(o="Polygon",a=a[0]):o="MultiPolygon"}return{type:o,coordinates:a}}_convertGeometryCoords(e,t,n,i){const s=n/this.getTileSize().width,o=this.getMap(),a=e=>{const n=[];lL(e)&&(e=[e]);for(let a=0,l=e.length;a<l;a++){const l=e[a];wD.x=t.x+l.x/s,wD.y=t.y-l.y/s,o.pointAtResToCoord(wD,i,TD),n.push(TD.toArray())}return 1===e.length?n[0]:n};if(lL(e))return a(e);const l=e.length;if(1===l)return a(e[0]);{let t=[];for(let n=0;n<l;n++)t.push(a(e[n]));return t}}getDataSchema(e){return this._schema||(this._schema={}),hL(e)||this._schema[e]||(this._schema[e]={}),hL(e)?this._schema:this._schema[e]}onRemove(){super.onRemove()}clear(){const e=this.getRenderer();return e&&e.clearData(),super.clear()}static fromJSON(e){return e&&"VectorTileLayer"===e.type?new ft(e.id,e.options):null}_compileStyle(){}static registerPlugin(e){ft.plugins||(ft.plugins={}),ft.plugins[e.type]=e}static getPlugins(){return ft.plugins||{}}static compressStyleJSON(e){return Array.isArray(e)&&e.length?function(e){Array.isArray(e)&&(e={style:e,featureStyle:[]});const t=[],n=[],i=[];pL(e.style,t,i),pL(e.featureStyle,n,i);const s={plugins:i,styles:{style:t,featureStyle:n}};return e.$root&&(s.$root=e.$root),s}(e):e}};function PD(e){return!(!e||!e.properties)}function ID(e){return e?(Array.isArray(e)||(e=oE(e).unitArray()),3===e.length&&e.push(1),e):null}function kD(e,t){return null==e?t:e}function OD(e,t,n){if(!e[t]||!e[t].style||!e[t].style[n])throw new Error(`No plugin defined at feature style of ${t} - ${n}`)}function ED(e,t){if(!e[t])throw new Error(`No plugin defined at style of ${t}`)}CD.prototype._getTileZoom=function(e){return e=Math.floor(e),Up.prototype._getTileZoom.call(this,e)},CD.registerJSONType("VectorTileLayer"),CD.mergeOptions({urlTemplate:null,renderer:"gl",altitudeProperty:"altitude",forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,tileSize:[512,512],features:!1,schema:!1,cascadeTiles:!0,collision:!0,collisionBuffserSize:0,picking:!0,pickingPoint:!0,pickingGeometry:!1,glyphSdfLimitPerFrame:15,tileLimitPerFrame:1,loadingLimitOnInteracting:5,loadingLimit:0,antialias:!1,iconErrorUrl:null,collisionFrameLimit:1.5,defaultRendering:!0,textGamma:1,maxIconSize:254,workarounds:{"win-intel-gpu-crash":!1},pyramidMode:1,styleScale:1,enableAltitude:!0,fadeAnimation:!1,debugTileData:!1,fetchOptions:null,awareOfTerrain:!0,altitudeQueryTimeLimitPerFrame:3,workerGlyph:!0,featureIdProperty:null,currentTilesFirst:!0,tileStackStartDepth:3,tileStackDepth:2,altitudePropertyName:null,disableAltitudeWarning:!1,loadTileErrorLog:!0,loadTileErrorLogIgnoreCodes:[404,204]}),CD.registerRenderer("gl",pD),CD.registerRenderer("canvas",null);const RD=new Ot(1,1);let LD=class _t extends ed{static registerPainter(e,t){_t.painters||(_t.painters={}),_t.painters[e]=t}static get3DPainterClass(e){return _t.painters[e]}setURLModifier(e){return this._urlModifier=e,this}getURLModifier(){return this._urlModifier}getEvents(){let e;return e=super.getEvents?super.getEvents():{},e.spatialreferencechange=this._onSpatialReferenceChange,e}onConfig(e){if(super.onConfig(e),void 0!==e.enableBloom){const t=this.getRenderer();t&&t.updateBloom(e.enableBloom)}}updateSymbol(e,t){if(!this.options.style)throw new Error("can't call update symbol when style is not set");const n=Array.isArray(this.options.style)?this.options.style:this.options.style.style;if(!n[e])throw new Error(`invalid style at ${e}`);return iL(n[e].symbol,t),this.setStyle(this.options.style),this}getPolygonOffsetCount(){return this.isEmpty()||this.options.altitude?0:1}getPolygonOffset(){return this.options.altitude?0:this._polygonOffset||0}setPolygonOffset(e,t){return this._polygonOffset=e,this._totalPolygonOffset=t,this}getTotalPolygonOffset(){return this._totalPolygonOffset}identify(e,t={}){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];const s=n.coordToContainerPoint(new fl(e));return this.identifyAtPoint(s,t)}identifyAtPoint(e,t={}){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];const s=this.getMap().getDevicePixelRatio(),o=i.pick(e.x*s,e.y*s,t);return t&&t.filter?o.filter((e=>t.filter(e))):o}getComputedStyle(){return{style:this.getStyle()||[]}}outlineAll(){const e=this.getRenderer();return e?(e.outlineAll(),this):this}outline(e){if(!Array.isArray(e)||!e.length)return this;const t=this.getRenderer();return t?(t.outline(e),this):this}cancelOutline(){const e=this.getRenderer();return e?(e.cancelOutline(),this):this}toJSON(){const e={type:this.getJSONType(),id:this.getId(),options:this.config(),geometries:[]},t=this.getGeometries();for(let n=0,i=t.length;n<i;n++){const i=t[n].toJSON();e.geometries.push(i)}return e}getTileSize(){return RD}_onSpatialReferenceChange(){const e=this.getRenderer();e&&e._onSpatialReferenceChange()}};LD.mergeOptions({picking:!0,pickingPoint:!0,renderer:"gl",collision:!1,collisionBufferSize:0,textGamma:1,geometryEvents:!0,styleScale:1,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,meshRenderOrder:0,enableBloom:!1,enableAltitude:!0,workarounds:{"win-intel-gpu-crash":!0}});const DD={redraw:!1,retire:!1},FD=[];let HD=1;function ND(e,t){const n=rR.extend(e,{init:function(){this._meshCache={}},isVisible(){return this.painter&&this.painter.isVisible()},supportRenderMode:function(e){return this.painter.supportRenderMode(e)},hasMesh(){return this.painter&&this.painter.hasMesh()},startFrame:function(e){const n=e.sceneConfig;let i=this.painter;if(!i){i=this.painter=new t(e.regl,e.layer,e.symbol,n,e.pluginIndex,e.dataConfig)}this._meshCache||(this._meshCache={});const s=n.excludes;this._excludes?s!==this._excludes&&(this._excludesFunc=s?WE(s):null,this._excludes=s):s&&(this._excludes=s),i.startFrame(e),this._frameCache={}},updateCollision:function(e){const t=this.painter;return t&&t.isVisible()?t.updateCollision(e):null},prepareRender:function(e){const t=this.painter;return t&&t.isVisible()?t.prepareRender(e):null},endFrame:function(e){const t=this.painter;return t&&t.isVisible()?t.render(e):null},getShadowMeshes(){const e=this.painter;return e&&e.getShadowMeshes&&e.getShadowMeshes()||FD},createTile:function(e){const{tileCache:t,tileData:n,tileInfo:i}=e;let s=!1;const o=this.painter;if(!o)return{retire:s};const a=this._getMeshKey(e);let l=t.geometry;if(!l){const a=n.features,h=n.data;if(!h||!h.length)return{retire:s};const c=h;for(let e=0;e<h.length;e++)c[e].tileInfo=i;if(this.painter.colorSymbol&&!function(e){if(!e)return!0;for(const t in e)return!1;return!0}(a))for(let e=0;e<h.length;e++){const t=this._generateColorArray(a,h[e].data.aPickingId,h[e].indices,h[e].data.aPosition,h[e].positionSize);h[e].data.aColor=t}l=t.geometry=o.createGeometries(c,a);for(let t=0;t<l.length;t++)l[t]&&l[t].geometry&&(s=!0,l[t].geometry.properties.features=a,this._fillCommonProps(l[t].geometry,e))}let h=this._getMesh(a);if(!h){const{meshes:t,retire:n}=this._createMeshes(l,e);s||(s=n),h=t}return{retire:s}},_createMeshes(e,t){const{tileInfo:n,tileExtent:i,tileTransform:s,tileTranslationMatrix:o,tileVectorTransform:a,tileZoom:l,sceneConfig:h}=t;let c=!1;const u=this.painter,f=u.createMeshes(e,s,{tileExtent:i,tilePoint:[n.extent2d.xmin,n.extent2d.ymax],tileZoom:l,tileTranslationMatrix:o,tileVectorTransform:a},t);if(f.length){for(let e=0;e<f.length;e++)f[e]&&(c=!0,this._fillMeshProps(f[e],s,t.timestamp,HD++,u.isEnableTileStencil()));h.animation&&(f._animationTime=t.timestamp);const e=this._getMeshKey(t);this._meshCache[e]=f}return{meshes:f,retire:c}},paintTile:function(e){const{tileCache:t,tileInfo:n,tileZoom:i,sceneConfig:s}=e,o=this.painter;if(!o)return DD;let a=t.geometry;if(!a)return DD;let l=!1;const h=this._getMeshKey(e);let c=this._getMesh(h);if(!c){const{meshes:t,retire:n}=this._createMeshes(a,e);l||(l=n),c=t}if(!c.length)return DD;const u=o.getTileLevelValue(n,i);c.forEach((e=>{e.properties.tile=n,e.properties.level=u}));let f=!1;if(!this._frameCache[h]){let t=null,n=s.animation;if(n){const i=e.sceneConfig.animationDuration||800,s=(e.timestamp-c._animationTime)/i;c._animationTime-c[0].properties.createTime<i&&s<1&&(!0!==n&&1!==n||(n="linear"),t="linear"===n?s:UE(n,s),f=!0)}o.addMesh(c,t,e),this._frameCache[h]=1}return{redraw:f,retire:l}},_fillMeshProps:function(e,t,n,i,s){if(e.properties.tileTransform=t,e.properties.createTime=n,e.properties.meshKey=i,e.needUpdateShadow=!0,s){const t=e.defines||{};t.ENABLE_TILE_STENCIL=1,e.setDefines(t)}"stencilRef"in e.uniforms||Object.defineProperty(e.uniforms,"stencilRef",{enumerable:!0,get:function(){return e.properties.tile&&void 0!==e.properties.tile.stencilRef?e.properties.tile.stencilRef:e.properties.level}})},_fillCommonProps:function(e,t){const{layer:n,tileInfo:i}=t,s=n.getMap(),o=(n.getSpatialReference?n.getSpatialReference():s.getSpatialReference()).getResolution(i.z),a=t.tileExtent/n.getTileSize().width;e.properties.tileResolution=o,e.properties.tileRatio=a,e.properties.z=i.z,e.properties.tileExtent=t.tileExtent},updateSceneConfig:function(e){const t=this.painter;t&&t.updateSceneConfig(e.sceneConfig)},updateDataConfig:function(e,t){const n=this.painter;return!n||n.updateDataConfig(e,t)},updateSymbol:function(e,t){const n=this.painter;if(!n)return!1;if(n.shouldDeleteMeshOnUpdateSymbol(e)){if(this._meshCache)for(const e in this._meshCache)n.deleteMesh(this._meshCache[e],!0);delete this._meshCache,delete this._frameCache}return n.updateSymbol(e,t)},pick:function(e,t,n){return this.painter&&this.painter.pick?this.painter.pick(e,t,n):null},deleteTile:function(e){if(!this._meshCache)return;const t=this._getMeshKey(e),n=this._meshCache[t];n&&this.painter&&this.painter.deleteMesh(n),delete this._meshCache[t],this._frameCache&&delete this._frameCache[t]},remove:function(){const e=this.painter;if(e&&this._meshCache){for(const t in this._meshCache)e.deleteMesh(this._meshCache[t]);e.delete(),delete this.painter}delete this._meshCache,delete this._frameCache},resize:function(e,t){const n=this.painter;n&&n.resize(e,t)},needToRedraw:function(){return!!this.painter&&this.painter.needToRedraw()},needToRetireFrames:function(){return!!this.painter&&this.painter.needToRetireFrames()},isAnimating(){return!!this.painter&&this.painter.isAnimating()},needToRefreshTerrainTileOnZooming:function(){return!!this.painter&&this.painter.needToRefreshTerrainTileOnZooming()},isTerrainSkin:function(){return!!this.painter&&this.painter.isTerrainSkin()},isTerrainVector:function(){return!!this.painter&&this.painter.isTerrainVector()},isTerrainMask:function(){return!!this.painter&&this.painter.isTerrainMask()},_generateColorArray:function(e,t,n,i,s=3){if(!i||!e||!t.length)return null;const o=new Uint8Array(i.length/s*4);let a,l;const h=this.painter.colorSymbol,c={};let u;for(let n=0,i=t.length;n<i;n++){const i=t[n];if(a=e[i].symbol,l=c[i],!l)if(h){let t;t="function"==typeof h?h(e[i].feature&&e[i].feature.properties):h,t=oE(t),l=c[i]=t.array()}else l=c[i]=[255,255,255];u=4*n,o[u]=l[0],o[u+1]=l[1],o[u+2]=l[2],o[u+3]=255*(a[this.painter.opacitySymbol]||1)}return o},_getMeshKey:function(e){const t=e.tileInfo;return t.meshKey||(t.meshKey=HD++),t.meshKey},_getMesh:function(e){return this._meshCache[e]},_filterElements(e,t){if(Array.isArray(e))e.forEach(((e,n)=>{const{features:i}=e.properties;this._filterGeoElements(e,t[n],i)}));else{const{features:n}=e.properties;this._filterGeoElements(e,Array.isArray(t)?t[0]:t,n)}},_filterGeoElements(e,t,n){const i=t.featureIndexes||t.data.featureIndexes;if(i)if(this._excludesFunc){const s=t.indices;let o=null,a=!1;const l=[];for(let e=0;e<s.length;e++){null!==o&&o===s[e]||(a=this._excludesFunc(n[i[s[e]]].feature),o=s[e]),a||l.push(s[e])}e.setElements(new t.indices.constructor(l))}else e.setElements(t.indices)},outline(e,t){const n=this.painter;n&&n.outline(e,t)},outlineAll(e){const t=this.painter;t&&t.outlineAll(e)},needPolygonOffset(){const e=this.painter;return e&&e.needPolygonOffset()},highlight(e){const t=this.painter,n=this.style.name,i=this.renderIndex;if(e){const t=[];if(e.forEach(((e,s)=>{null!=e.plugin&&(Array.isArray(e.plugin)?e.plugin.length&&e.plugin.indexOf(n)<0&&e.plugin.indexOf(i)<0&&t.push(s):e.plugin!==n&&e.plugin!==i&&t.push(s))})),t.length){const n=new Map(e);for(let e=0;e<t.length;e++)n.delete(t[e]);e=n}}return t&&t.highlight(e)},cancelAllHighlight(){const e=this.painter;return e&&e.cancelAllHighlight()}});return n}function BD(e){return!e||(void 0!==e.empty||(e.empty=function(e){for(const t in e)return!1;return!0}(e)),e.empty)}const{StyleUtil:zD}=eL(),GD="_fn_type_",UD="__current_fn_types";function VD(e,t,n,i){if(!BD(e.properties.features))for(let s=0;s<n.length;s++){const{symbolName:o}=n[s];(e[UD]=e[UD]||{})[o]=t[o],jD(e,t,n[s],i)}}function jD(e,t,n,i){const s=function(e){const t=e.properties;let n=t.aPickingId;return n||(n=t.aPickingId=new e.data.aPickingId.constructor(e.data.aPickingId)),n}(e),{attrName:o,symbolName:a,related:l}=n;let h=e.data[o];return h?eF(t[a])||function(e,t){if(!Array.isArray(e))return!1;for(let n=0;n<e.length;n++)if(eF(t[e[n]]))return!0;return!1}(l,t)?(eF(t[a])&&WD(e,t,n),h):(void 0===n.index&&(e.deleteData(o),qD(e,o)),null):eF(t[a])&&function(e,t){return!(e.startsWith("marker")&&!t.properties.iconAtlas)&&!(e.startsWith("text")&&!t.properties.glyphAtlas)}(a,e)?(h=e.data[o]=new n.type(n.width*s.length),function(e,t,n,i,s){const{attrName:o}=i,a=(GD+o+"Index").trim();WD(t,n,i);QD(t,t.properties[a],i,s)}(0,e,t,n,i),h):null}function WD(e,t,n){const{attrName:i,symbolName:s}=n,o=e.properties,a=(GD+i+"Index").trim(),l=(GD+i).trim();if(o[a]&&o[l])return;const h=function(e){if(!e)return JD;const t=[];for(let n=0;n<e.length;n++)SE(e[n][1])&&!CE(e[n][1]).isZoomConstant&&t.push(e[n][0]);return t}(t[s].stops),c="identity"===t[s].type&&zD.checkIfIdentityZoomDependent(s,t[s].property,o.features);if(!c&&!h.length)return void(void 0===n.index&&qD(e,i));const{features:u,aPickingId:f}=o,g=function(e,t,n,i,s){const o=[];let a=0,l=t[0];for(let h=1,c=t.length;h<c;h++)!e[l]||t[h]===l&&h!==c-1||((s||YD(e[l].feature,n,i))&&o.push(a,h===c-1?c:h),l=t[h],a=h);return o}(u,f,t[s].property,h,c);if(!g.length)return void(void 0===n.index&&qD(e,i));if(o[a]=g,o[l])return;const m=e.data[i];o[l]=m.BYTES_PER_ELEMENT?new m.constructor(m):new n.type(m.length)}function qD(e,t){const n=e.properties,i=(GD+t+"Index").trim(),s=(GD+t).trim();delete n[i],delete n[s]}function ZD(e,t,n,i,s,o){if(!s)return;const a=s.geometry;if(!a)return;if(BD(a.properties.features))return;for(let l=0;l<i.length;l++){const h=i[l],c=h.attrName;if(!(XD(a,n,h)||t._isFeatureStateDirty&&t._isFeatureStateDirty(s.geometry._featureTimestamp))){const{aPickingId:e}=a.properties;if(!e||a._fnDataZoom===o)continue;const n=(GD+c+"Index").trim(),i=a.properties[n];if(!i)continue;QD(a,i,h,t);continue}const u=jD(a,n,h,t),f=h.define;if(u){const n=(GD+c+"Index").trim();if(QD(a,a.properties[n],h,t),t._getFeatureStateStamp&&(a._featureTimestamp=t._getFeatureStateStamp()),f){const e=s.defines;e[f]=1,s.setDefines(e)}a.generateBuffers(e)}else if(f){const e=s.defines;e[f]&&(delete e[f],s.setDefines(e))}}s.setDefines(s.defines),a._fnDataZoom=o}function XD(e,t,n){const i=t[n.symbolName],s=e[UD];return!Zv(i,s[n.symbolName])&&(s[n.symbolName]=i,!0)}function YD(e,t,n){for(let i=0;i<n.length;i++)if("$"===t[0]&&e[t.substring(1)]===n[i]||e.properties[t]===n[i])return!0;return!1}const JD=[];function QD(e,t,n,i){const{attrName:s,evaluate:o,index:a,width:l}=n,{aPickingId:h,features:c}=e.properties;let u;if(t){const n=(GD+s).trim();u=e.properties[n];const f=l,g=t.length;for(let n=0;n<g;n+=2){const s=t[n];let l=c[h[s]];l&&l.feature&&KD(u,l,o,s,t[n+1],f,a,e,i)}}else{if(u=e.data[s],function(e){return Array.isArray(e)||e.constructor===Float32Array||e.constructor===Float64Array||e.constructor===Uint8Array||e.constructor===Int8Array||e.constructor===Uint16Array||e.constructor===Int16Array||e.constructor===Uint32Array||e.constructor===Int32Array||e.constructor===Uint8ClampedArray}(u))u.dirty=!0;else{const t=(GD+s).trim();u=e.properties[t],u||(u=e.properties[t]=new n.type(n.width*h.length),u.dirty=!0)}const t=u.length/h.length,l=h.length;let f=0;for(let n=0;n<l;n++){if(h[n]===h[f]&&n<l-1)continue;let s=c[h[f]];s&&s.feature&&(KD(u,s,o,f,n===l-1?l:n,t,a,e,i),f=n)}}u.dirty&&(e.updateData(s,u),u.dirty=!1)}const $D={};function KD(e,t,n,i,s,o,a,l,h){const c=(t=t.feature).properties||{};if(void 0===c.$layer&&(t.properties||(t.properties=c),c.$layer=t.layer,c.$type=t.type),h.getFeatureState&&($D.layer=t.layer,$D.id=t.id,t[NL]&&(t[NL]=null),!WL(t.id))){const e=h.getFeatureState($D);t.properties[NL]=e}const u=n(c,l,e,i*o);if(Array.isArray(u)){let t=!1;for(let n=0;n<o;n++)if(e[i*o+n]!==u[n]){t=!0;break}if(t){for(let t=i*o;t<s*o;t+=o)e.set(u,t);e.dirty=!0}}else if(o>1)for(let t=i*o;t<s*o;t+=o)e[t+a]!==u&&(e[t+a]=u,e.dirty=!0);else e[i]!==u&&($L(e,u,i,s),e.dirty=!0)}function eF(e){return zD.isFnTypeSymbol(e)}var tF=nF;function nF(e,t){this.x=e,this.y=t}nF.prototype={clone:function(){return new nF(this.x,this.y)},add:function(e){return this.clone()._add(e)},sub:function(e){return this.clone()._sub(e)},multByPoint:function(e){return this.clone()._multByPoint(e)},divByPoint:function(e){return this.clone()._divByPoint(e)},mult:function(e){return this.clone()._mult(e)},div:function(e){return this.clone()._div(e)},rotate:function(e){return this.clone()._rotate(e)},rotateAround:function(e,t){return this.clone()._rotateAround(e,t)},matMult:function(e){return this.clone()._matMult(e)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(e){return this.x===e.x&&this.y===e.y},dist:function(e){return Math.sqrt(this.distSqr(e))},distSqr:function(e){var t=e.x-this.x,n=e.y-this.y;return t*t+n*n},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith:function(e){return this.angleWithSep(e.x,e.y)},angleWithSep:function(e,t){return Math.atan2(this.x*t-this.y*e,this.x*e+this.y*t)},_matMult:function(e){var t=e[2]*this.x+e[3]*this.y;return this.x=e[0]*this.x+e[1]*this.y,this.y=t,this},_add:function(e){return this.x+=e.x,this.y+=e.y,this},_sub:function(e){return this.x-=e.x,this.y-=e.y,this},_mult:function(e){return this.x*=e,this.y*=e,this},_div:function(e){return this.x/=e,this.y/=e,this},_multByPoint:function(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint:function(e){return this.x/=e.x,this.y/=e.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var e=this.y;return this.y=this.x,this.x=-e,this},_rotate:function(e){var t=Math.cos(e),n=Math.sin(e),i=n*this.x+t*this.y;return this.x=t*this.x-n*this.y,this.y=i,this},_rotateAround:function(e,t){var n=Math.cos(e),i=Math.sin(e),s=t.y+i*(this.x-t.x)+n*(this.y-t.y);return this.x=t.x+n*(this.x-t.x)-i*(this.y-t.y),this.y=s,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},nF.convert=function(e){return e instanceof nF?e:Array.isArray(e)?new nF(e[0],e[1]):e};var rF=function(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}(tF);const iF=[];function sF(e,t,n,i,s){return Sy(iF,t[0],t[1],t[2],1),Ny(iF,iF,n),e[2]=iF[3],ky(iF,iF,1/iF[3]),e[0]=(iF[0]+1)*i/2,e[1]=(1-iF[1])*s/2,e}const oF=[],aF=[],lF=[],hF=[-99999,-99999],cF=new Re(0,0),uF=[];function fF(e,t,n,i,s,o,a,l){const{res:h,extent:c,extent2d:u}=n.properties.tile,{xmin:f,ymax:g}=u,m=f+i.x*s,A=g-i.y*s;let w=null;if(l)for(let e=0;e<l.length;e++)if(dF(l[e],m,A,h)){w=l[e];break}if(!w)return hF;const T=cF.set(f,g),S=o.queryTilePointTerrain(i,w,T,c,h),M=null===S[0]?RL:S[0];if(M){let n=ZA(uF,i.x,i.y,0);return n[2]+=100*M,n=sF(e,n,a,t.width,t.height),n}return e[0]=i.x,e[1]=i.y,e}function dF(e,t,n,i){const s=cF.set(t,n)._multi(i/e.res);return e.extent2d.contains(s)}const{SYMBOLS_NEED_REBUILD_IN_VT:pF,StyleUtil:gF,FuncTypeUtil:mF}=eL(),{loginIBLResOnCanvas:AF,logoutIBLResOnCanvas:yF,getIBLResOnCanvas:_F}=CM.pbr.PBRUtils,vF="__gl_textures",xF=[],bF=new Re(0,0),wF=new Re(0,0),TF=new Float32Array(1),SF=[],MF=e=>0===e.properties.level,CF=e=>e.properties.level>0;let PF=class gn{static getBloomSymbol(){return["bloom"]}constructor(e,t,n,i,s,o){this._is2D=!0,this.regl=e,this.layer=t,this.canvas=(e._gl||e.context).canvas,this.sceneConfig=i||{},this.dataConfig=o||{},this.pluginIndex=s,this.scene=new CM.Scene,this.pickingFBO=t.getRenderer().pickingFBO,this.level0Filter=MF,this.levelNFilter=CF,this.loginTextureCache(),this.symbolDef=Array.isArray(n)?n.map((e=>qL(e))):[qL(n)],this._compileSymbols(),this.pickingViewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},this.sortByCommandKey=IF.bind(this),this.colorCache={},this._invisibleWhenCreated=this.symbolDef.map((e=>!(!e||!1!==e.visible)))}isWebGPU(){return!this.regl._gl}hasMesh(){const e=this.scene&&this.scene.getMeshes();return this.isVisible()&&e&&!!e.length}getMap(){return this.layer?this.layer.getMap():null}getTileLevelValue(e,t){const n=this.layer.getRenderer();return n.getTileLevelValue&&n.getTileLevelValue(e,t)||0}getAnalysisMeshes(){return this.getShadowMeshes?this.getShadowMeshes():SF}isVisible(){const{minZoom:e,maxZoom:t}=this.sceneConfig,n=this.getMap().getZoom();if(!WL(e)&&n<e)return!1;if(!WL(t)&&n>t)return!1;const i=this._visibleFn;if(i.length)for(let e=0;e<i.length;e++)if(i[e]&&!i[e].isFeatureConstant)return!0;const s=this.getSymbols();for(let e=0;e<s.length;e++){const t=s[e].visible;if(!1!==t&&0!==t)return!0}return!1}isMeshVisible(e){const t=e&&e.properties&&e.properties.symbolIndex;if(!t)return!1;const n=this._visibleFn,i=t.index;let s;if(n[i]){if(!n[i].isFeatureConstant)return!0;s=n[i](this.getMap().getZoom())}else s=this.getSymbol(t).visible;return!1!==s&&0!==s}isAnimating(){return!1}needToRedraw(){return this.isAnimating()||this._redraw}needToRetireFrames(){return this._needRetire}needToRefreshTerrainTileOnZooming(){return!0}isTerrainSkin(){return this.layer.options.awareOfTerrain}isTerrainMask(){return!1}isTerrainVector(){return!1}isShadowIncludeChanged(e){const t=e&&e.isRenderingTerrain&&this.isTerrainSkin();return e&&e.states&&e.states.includesChanged.shadow||t&&this._includeKeys}fillIncludes(e,t,n){if(delete this._includeKeys,n&&n.isRenderingTerrain&&this.isTerrainSkin())return;const i=n&&n.includes;if(i){let s="";for(const o in i)i[o]&&(s+=o,n[o].uniformDeclares&&t.push(...n[o].uniformDeclares),n[o].defines&&UL(e,n[o].defines));this._includeKeys=s}}setIncludeUniformValues(e,t){if(t&&t.isRenderingTerrain&&this.isTerrainSkin())return;const n=t&&t.includes;if(n)for(const i in n)n[i]&&t[i].renderUniforms&&UL(e,t[i].renderUniforms)}createGeometries(e,t){if(!e.length)return SF;const n=[];for(let i=0;i<e.length;i++)if(e[i])if(void 0!==e[i].ref)n.push(n[e[i].ref]?{geometry:n[e[i].ref].geometry,symbolIndex:e[i].symbolIndex,ref:e[i].ref}:null);else{e[i]&&!e[i].is2D&&(this._is2D=!1);const s=this.createGeometry(e[i],t,i);if(s&&s.geometry){const o=s.geometry.properties,{feaIdToPickingIdMap:a,pickingIdToFeaIdMap:l,hasFeaIds:h}=this._getIdMap(e[i]);h&&(o.feaIdPickingMap=a,o.feaPickingIdMap=l),o.symbolIndex=s.symbolIndex,o.features=t,o.is2D=e[i].is2D,o.layer=this.layer,o.positionBounding=e[i].positionBounding,this.postCreateGeometry(s,n)}n.push(s)}return n}isOnly2D(){return this._is2D}postCreateGeometry(){}_getIdMap(e){if(!e)return{};if(Array.isArray(e)&&!(e=e[0]))return{};const t=e.featureIds,n={},i={},s=t&&t.length;if(s)for(let s=0;s<t.length;s++){const o=e.data.aPickingId[s];void 0===n[o]&&(n[o]=t[s],i[t[s]]||(i[t[s]]=[]),i[t[s]].push(e.data.aPickingId[s]))}return{hasFeaIds:s,pickingIdToFeaIdMap:n,feaIdToPickingIdMap:i}}createGeometry(){throw new Error("not implemented")}createMeshes(e,t,n,i){const s=this.layer.options.awareOfTerrain,o=[];for(let a=0;a<e.length;a++){if(!e[a])continue;if(s&&i&&i.isRenderingTerrain&&this.isTerrainVector()){const t=e[a],n=t&&t.geometry;this._updateTerrainAltitude(n,n.data,n.properties,n.positionSize||n.desc.positionSize,i)}let l=this.createMesh(e[a],t,n,i||{});Array.isArray(l)?(l=l.filter((e=>!!e)),o.push(...l)):l&&o.push(l)}return o}createMesh(){throw new Error("not implemented")}getAltitudeOffsetMatrix(){const e=100*(this.dataConfig.altitudeOffset||0),t=AA([]);return ZA(xF,0,0,e),xA(t,t,xF),t}isBloom(e){return!!this.getSymbol(e.properties.symbolIndex).bloom}forbiddenTerrainUpscale(){return!0}addMesh(e,t,n){if(n.isRenderingTerrain&&this.isTerrainSkin()&&this.forbiddenTerrainUpscale()){const e=this.getMap().getResolution();if(n.tileInfo.res/e>3)return}const i=n.isRenderingTerrain&&this.isTerrainVector(),s=this.getRenderFBO(n);e=e.filter((e=>this.isMeshVisible(e))),i&&(e=e.filter((e=>e.geometry&&e.geometry.data.aTerrainAltitude)));const o=void 0===this.sceneConfig.castShadow||!!this.sceneConfig.castShadow,a=!(!n||!n.bloom);e.forEach((e=>{const t=this.isBloom(e)&&a;e.bloom=t,e.castShadow=o;let l=!1;const h=e.defines||{};if(!!h.HAS_BLOOM!==t&&(l=!0,t?h.HAS_BLOOM=1:delete h.HAS_BLOOM),i){if(e.geometry.data.aTerrainAltitude){const t=e.geometry;this._updateTerrainAltitude(t,t.data,t.properties,t.desc.positionSize,n)}e.geometry.data.aTerrainAltitude&&!h.HAS_TERRAIN_ALTITUDE&&(h.HAS_TERRAIN_ALTITUDE=1,l=!0)}else h.HAS_TERRAIN_ALTITUDE&&(delete h.HAS_TERRAIN_ALTITUDE,l=!0);l&&e.setDefines(h),s?e.setUniform("targetFramebuffer",s):e.uniforms.targetFramebuffer&&(e.uniforms.targetFramebuffer=null),this._highlightMesh(e)})),this.scene.addMesh(e)}updateCollision(){}render(e){return this.pluginIndex=e.pluginIndex,this.polygonOffsetIndex=e.polygonOffsetIndex,this.paint(e),{redraw:this._redraw,drawCount:this._drawCount}}prepareRender(e){if(this._currentTimestamp===e.timestamp)return;if(!this.createFnTypeConfig)return;const t=this.scene.getMeshes();if(!t||!t.length)return;const n=e&&e.sceneFilter,i=this.getMap().getZoom();for(let s=0;s<t.length;s++){if(!t[s]||!t[s].geometry)continue;if(n&&!n(t[s]))continue;const{symbolIndex:o}=t[s].properties,a=this.getSymbolDef(o);if(!a)continue;this._currentTimestamp=e.timestamp;const l=this.getFnTypeConfig(o);ZD(this.regl,this.layer,a,l,t[s],i),this.limitMeshDefines(t[s])}}limitMeshDefines(e){return e}paint(e){const t=this.layer.getMap();if(!t)return{redraw:!1};this._renderContext=e;const n=this.getUniformValues(t,e);return this.callShader(n,e),{redraw:this._redraw}}setToRedraw(e){e&&(this._needRetire=e),this._redraw=!0}callShader(e,t){this.callCurrentTileShader(e,t),this.callBackgroundTileShader(e,t)}callCurrentTileShader(e,t){this.shader&&(this.shader.filter=t&&t.sceneFilter?[this.level0Filter,t.sceneFilter]:this.level0Filter),this.callRenderer(this.shader,e,t)}callBackgroundTileShader(e,t){this.shader&&(this.shader.filter=t&&t.sceneFilter?[this.levelNFilter,t.sceneFilter]:this.levelNFilter),this.scene.getMeshes().sort(kF),this.callRenderer(this.shader,e,t)}callRenderer(e,t,n){const i=this.scene.getMeshes(),s=[];i.forEach((e=>{e.properties.hlBloomMesh&&n&&n.bloom&&s.push(e.properties.hlBloomMesh),s.push(e)})),this._setLayerUniforms(t),this.scene.setMeshes(s),t.painterContext=n,this._drawCount+=this.renderer.render(e,t,this.scene,this.getRenderFBO(n)),this.scene.setMeshes(i)}_setLayerUniforms(e){const t=this.layer.options.altitude||0,n=this.layer.getRenderer();e.layerOpacity=n._getLayerOpacity(),e.minAltitude=t}getRenderFBO(e){return e&&e.renderTarget&&e.renderTarget.fbo}needPolygonOffset(){return!1}needRebuildOnGometryPropertiesChanged(){return!0}onFeatureChange(){}getPolygonOffset(){const e=this.layer;return{factor:()=>e.getPolygonOffset()+(this.polygonOffsetIndex||0),units:()=>e.getPolygonOffset()+(this.polygonOffsetIndex||0)}}getBlendFunc(){return{src:()=>this.sceneConfig.blendSrc||"one",dst:()=>this.sceneConfig.blendDst||"one minus src alpha"}}pick(e,t,n=3){if(!this.layer.options.picking||!1===this.sceneConfig.picking)return null;if(!this.pickingFBO||!this.picking)return null;const i=this.getMap(),s=this.getUniformValues(i);this._setLayerUniforms(s);for(let o=0;o<this.picking.length;o++){const a=this.picking[o];a.render(this.scene.getMeshes(),s,!0);let l={};a.getRenderedMeshes().length&&(l=a.pick(e,t,n,s,{viewMatrix:i.viewMatrix,projMatrix:i.projMatrix,returnPoint:this.layer.options.pickingPoint&&!1!==this.sceneConfig.pickingPoint,logDepthBufFC:2/(Math.log(i.cameraFar+1)/Math.LN2)}));const{meshId:h,pickingId:c,point:u}=l,f=(0===h||h)&&a.getMeshAt(h);if(!f||!f.geometry)continue;let g=f.geometry.properties;g.features||(g=f.properties),u&&u.length&&(u[0]=Math.round(1e5*u[0])/1e5,u[1]=Math.round(1e5*u[1])/1e5,u[2]=Math.round(1e5*u[2])/1e5);const m={data:this._convertProxyFeature(g&&g.features&&g.features[c]),point:u,coordinate:l.coordinate,plugin:this.pluginIndex};return WL(f.properties.nodeIndex)||(m.data||(m.data={}),m.data.nodeIndex=f.properties.nodeIndex),m}return null}_convertProxyFeature(e){const t=e&&e.feature;if(!t||!t.customProps)return e;const n=UL({},e);return n.feature=UL({},e.feature),delete n.feature.customProps,n.feature.properties=UL({},t.properties,t.properties[HL],t.properties[NL]),delete n.feature.properties[NL],delete n.feature.properties[HL],delete n.feature.properties.$layer,delete n.feature.properties.$type,n}updateSceneConfig(){}updateDataConfig(e){return UL(this.dataConfig,e),!0}deleteMesh(e,t){if(e)if(this.scene.removeMesh(e),Array.isArray(e))for(let n=0;n<e.length;n++){if(!e[n].isValid())continue;const i=e[n].geometry;!t&&i&&i.dispose(),e[n].material&&e[n].material.dispose(),e[n].dispose(),Vk.deleteHighlightBloomMesh(e[n])}else{if(!e.isValid())return;!t&&e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose(),e.dispose(),Vk.deleteHighlightBloomMesh(e)}}startFrame(e){this._inited||(this.init(e),this._inited=!0),this._currentTimestamp!==e.timestamp&&(this._redraw=!1,this._needRetire=!1,this._drawCount=0),this.scene.clear()}resize(){}delete(){if(this.scene.clear(),this.shader&&this.shader.dispose(),this.picking){for(let e=0;e<this.picking.length;e++)this.picking[e].dispose();delete this.picking}if(this._outlineShaders){for(let e=0;e<this._outlineShaders.length;e++)this._outlineShaders[e].dispose();delete this._outlineShaders}delete this._terrainAltitudeCache,this.logoutTextureCache()}updateSymbol(e,t){Array.isArray(e)||(e=[e],t=[t]);let n=!1;for(let i=0;i<e.length;i++)if(e[i]){const s=this._updateChildSymbol(i,e[i],t[i]);s&&(n=s)}return delete this._fnTypeConfigs,this.setToRedraw(!1),n}_isNeedRefreshStyle(e,t){for(const n in t)if(tD(t,n)){if(gF.isFnTypeSymbol(t[n])&&!this.layer.options.features&&(!e[n]||e[n].property!==t[n].property))return!0;if(pF[n]&&!Zv(t[n],e[n]))return!0}return!1}_updateChildSymbol(e,t,n){if(!this._symbol)return!1;const i=this._isNeedRefreshStyle(this.symbolDef[e]||{},n);if(this._invisibleWhenCreated[e]&&!1!==n.visible)return this._invisibleWhenCreated[e]=!1,!0;this.symbolDef[e]=qL(n);const s=this._symbol[e];for(const e in s)delete s[e];const o=this.getMap(),a=[],l=mF.loadSymbolFnTypes(this.symbolDef[e],(()=>(a[0]=o.getZoom(),a)));for(const e in l){const t=Object.getOwnPropertyDescriptor(l,e);t.get?Object.defineProperty(s,e,{get:t.get,set:t.set,configurable:!0,enumerable:!0}):s[e]=l[e]}return SE(n.visible)&&(this._visibleFn[e]=CE(n.visible)),i}getSymbolDef(e){return this.symbolDef[e.index]}getSymbols(){return this._symbol}getSymbol(e){return this._symbol[e.index]}_compileSymbols(){const e=this.getMap(),t=[],n=()=>(t[0]=e.getZoom(),t);this._symbol=[],this._visibleFn=[];for(let e=0;e<this.symbolDef.length;e++)this._symbol[e]=mF.loadSymbolFnTypes(UL({},this.symbolDef[e]),n),this.symbolDef[e]&&SE(this.symbolDef[e].visible)&&(this._visibleFn[e]=CE(this.symbolDef[e].visible))}getFnTypeConfig(e){this._fnTypeConfigs||(this._fnTypeConfigs=[]);const t=e.index;if(!this._fnTypeConfigs[t]){const n=this.getSymbolDef(e),i=this.getMap();this._fnTypeConfigs[t]=this.createFnTypeConfig(i,n)}return this._fnTypeConfigs[t]}_deleteFnTypeConfigs(){delete this._fnTypeConfigs}loginTextureCache(){const e=(vF+"").trim(),t=this.getMap();t[e]||(t[e]={count:0}),t[e].count++}logoutTextureCache(){const e=(vF+"").trim(),t=this.getMap(),n=this._myTextures;if(n)for(const i in n)tD(n,i)&&t[e][i]&&(t[e][i].count--,t[e][i].count<=0&&delete t[e][i]);t[e].count--,t[e].count<=0&&(t[e]={})}getCachedTexture(e){const t=(vF+"").trim(),n=this.getMap()[t][e];return n?n.data:null}addCachedTexture(e,t){const n=(vF+"").trim(),i=this.getMap();let s=i[n][e];s?s.data=t:s=i[n][e]={data:t,count:0},this._myTextures||(this._myTextures={}),s.data.then||this._myTextures[e]||(s.count++,this._myTextures[e]=1)}disposeCachedTexture(e){let t;if(t="string"==typeof e?e:e.url,!this._myTextures||!this._myTextures[t])return;const n=(vF+"").trim();delete this._myTextures[t];const i=this.getMap();i[n][t]&&(i[n][t].count--,i[n][t].count<=0&&delete i[n][t])}shouldDeleteMeshOnUpdateSymbol(){return!1}isEnableTileStencil(){return!0}isUniqueStencilRefPerTile(){return this.isOnly2D()}supportRenderMode(e){return"taa"===e||"fxaa"===e}outline(e,t){const n={};for(let i=0;i<t.length;i++)WL(t[i])||n[t[i]]||(this._outlineOne(e,t[i]),n[t[i]]=1)}_outlineOne(e,t){if(!this.picking)return;if(this._outlineScene||(this._outlineScene=new CM.Scene),!this._outlineShaders&&(this._initOutlineShaders(),!this._outlineShaders))return void console.warn(`Plugin at ${this.pluginIndex} doesn't support outline.`);const n=this.getUniformValues(this.getMap(),this._renderContext);this._setLayerUniforms(n);const i=this._findMeshesHasFeaId(t);if(i.length)for(let s=0;s<i.length;s++){const o=i[s].geometry.properties.feaIdPickingMap;if(o){const a=o[t];if(a){const t={};this._outlineScene.setMeshes(i[s]);for(let i=0;i<a.length;i++){const s=a[i];if(!t[s]){t[s]=1,n.highlightPickingId=s;for(let t=0;t<this._outlineShaders.length;t++)this.renderer.render(this._outlineShaders[t],n,this._outlineScene,e)}}}}}}_findMeshesHasFeaId(e){const t=[],n=this.scene.getMeshes();for(let i=0;i<n.length;i++){const s=n[i],o=s.geometry.properties.feaIdPickingMap;o&&void 0!==o[e]&&t.push(s)}return t}outlineAll(e){if(!this.picking)return;if(!this._outlineShaders&&(this._initOutlineShaders(),!this._outlineShaders))return void console.warn(`Plugin at ${this.pluginIndex} doesn't support outline.`);const t=this.getUniformValues(this.getMap(),this._renderContext);this._setLayerUniforms(t),t.highlightPickingId=-1;for(let n=0;n<this._outlineShaders.length;n++)this.renderer.render(this._outlineShaders[n],t,this.scene,e)}_initOutlineShaders(){if(!this.picking)return;const e=this.layer.getRenderer().canvas;this._outlineShaders=[];for(let t=0;t<this.picking.length;t++){const n=this.picking[t].getPickingVert(),i=this.picking[t].getPickingWGSLVert(),s={PICKING_MODE:1,ENABLE_PICKING:1,HAS_PICKING_ID:1},o=this.picking[t].getUniformDeclares().slice(0);void 0!==o.uPickingId&&(s.HAS_PICKING_ID=2),this._outlineShaders[t]=new CM.MeshShader({vert:n,frag:"precision highp float;\nuniform float highlightPickingId;\nvarying float vPickingId;\nvoid main() {\n  if(highlightPickingId < .0 || floor(highlightPickingId + .5) == floor(vPickingId + .5)) {\n    gl_FragColor = vec4(1.);\n  } else {\n    discard;\n  }\n}",wgslVert:i,wgslFrag:"struct OutlineUniforms {\n    highlightPickingId: f32,\n}\n@group(0) @binding($b) var<uniform> uniforms: OutlineUniforms;\nstruct VertexOutput {\n    @location($i) vPickingId: f32,\n};\n@fragment\nfn main(vertexOutput: VertexOutput) -> @location(0) vec4f {\n    if (uniforms.highlightPickingId < 0.0 ||\n        floor(uniforms.highlightPickingId + 0.5) == floor(vertexOutput.vPickingId + 0.5)) {\n        return vec4f(1.0);\n    } else {\n        discard;\n        return vec4f(0.0);\n    }\n}",uniforms:o,defines:s,extraCommandProps:{viewport:{x:0,y:0,width:()=>e.width,height:()=>e.height},depth:{enable:!0,mask:!1,func:"always"},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}}),this._outlineShaders[t].filter=this.picking[t].filter}}hasIBL(){const e=this.getMap().getLightManager();return!(!e||!e.getAmbientResource())}updateIBLDefines(e){const t=e.shaderDefines;let n=!1;this.hasIBL()?t[["HAS_IBL_LIGHTING"]]||(t.HAS_IBL_LIGHTING=1,n=!0):t[["HAS_IBL_LIGHTING"]]&&(delete t.HAS_IBL_LIGHTING,n=!0),n&&(e.shaderDefines=t)}getIBLRes(){const e=this.layer.getRenderer().canvas;return _F(e)}createIBLTextures(){const e=this.layer.getRenderer().canvas;AF(e,this.regl,this.getMap()),this.setToRedraw(!0),this.layer.fire("iblupdated")}disposeIBLTextures(){const e=this.layer.getRenderer().canvas;yF(e,this.getMap())}evaluateInFnTypeConfig(e,t,n,i,s){let o=this._fnCaches;o||(o=this._fnCaches={});const a=function(e){let t=0;const n=e&&e.length||0;if(!n)return t;let i;for(let s=0;s<n;s++)i=e.codePointAt(s),t=(t<<5)-t+i,t|=0;return t}(JSON.stringify(e));let l=o[a];return l||(l=o[a]=s?PE(e):CE(e)),l(n.getZoom(),i)}highlight(e){this._highlighted=e,this._highlightTimestamp=this.layer.getRenderer().getFrameTimestamp(),this.setToRedraw(!0)}cancelAllHighlight(){this._highlighted=null,this._highlightTimestamp=this.layer.getRenderer().getFrameTimestamp(),this.setToRedraw(!0)}_prepareFeatureIds(e,t){const{featureIds:n,pickingIdIndiceMap:i}=t;e.properties.aFeaIds=n,e.properties.pickingIdIndiceMap=i}_highlightMesh(e){if(e&&e.properties.isHalo)return;const t=e instanceof CM.InstancedMesh?e.properties:e.geometry.properties,{pickingIdIndiceMap:n}=t,i=this._highlighted?function(e,t,n){const i=e instanceof CM.InstancedMesh?e.properties:e.geometry.properties,{aPickingId:s,feaIdPickingMap:o,features:a}=i,l=new Map,h=n.keys();for(const e of h){const i=n.get(e);if(i)if(WL(i.id)){if(i.filter&&s){let e=null;for(let n=0;n<s.length;n++){s[n]!==e&&(e=s[n]);const o=a[e];i.filter(o&&o.feature,t)&&l.set(e,i)}}}else{const e=o[i.id];if(!e||!e.length)continue;for(let t=0;t<e.length;t++)l.set(e[t],i)}}return l}(e,this.layer,this._highlighted):null;Vk.highlightMesh(this.regl,e,i,this._highlightTimestamp,n)}_updateTerrainAltitude(e,t,n,i,s){let o=n.aAnchor;if(!o){const{aPosition:e}=t;o=n.aAnchor=e.slice(0)}let a=n.aTerrainAltitude;a||(a=n.aTerrainAltitude=new Float32Array(o.length/i),a.fill(RL)),this._fillTerrainAltitude(a,o,s.tileInfo,0,a.length-1),t.aTerrainAltitude?a.dirty&&this._updateATerrainAltitude(e,a):t.aTerrainAltitude=a,a.dirty=!1}_updateATerrainAltitude(e,t){e&&e.updateData&&e.updateData("aTerrainAltitude",t)}_fillTerrainAltitude(e,t,n,i,s){const{res:o,extent:a,extent2d:l,id:h}=n,c=this.pluginIndex,u=h+"-"+c;if(n.completeTerrainQuery||(n.completeTerrainQuery=[]),n.completeTerrainQuery[c])return;if(!n.completeTerrainQuery[c]&&this._terrainAltitudeCache&&this._terrainAltitudeCache.has(u)){const t=this._terrainAltitudeCache.getAndRemove(u);return this._terrainAltitudeCache.add(u,t),e.set(t.altitudeData),n.terrainTileInfos=t.terrainTileInfos,e.dirty=!0,void(n.completeTerrainQuery[c]=!0)}const f=this.layer,g=f.getMap(),m=f.getRenderer(),A=m&&m.getTerrainHelper();let w=n.terrainTileInfos;w||(w=n.terrainTileInfos=this.layer.queryTerrainTiles(n)),n.terrainQueryStatus||(n.terrainQueryStatus=[]);let T=!1,S=[];for(let e=0;e<n.terrainTileInfos.length;e++)if(S[e]=+A.isTerrainTileLoaded(n.terrainTileInfos[e].id),S[e]&&n.terrainQueryStatus[c]&&!n.terrainQueryStatus[c][e]){T=!0;break}if(!T&&n.terrainQueryStatus[c])return;const M=f.constructor;if(g.isInteracting()){const e=m.getFrameTimestamp();M.altitudeQueryFrameTimestamp!==e&&(M.altitudeQueryFrameTimestamp=e,M.altitudeQueryFrameTime=0);if(M.altitudeQueryFrameTime>f.options.altitudeQueryTimeLimitPerFrame)return}const C=performance.now();n.terrainQueryStatus[c]=S;const{xmin:I,ymax:E}=l,D=bF.set(I,E),H=this.layer.getTileSize().width/n.extent,N=t.length/e.length;let B=e.queryResult;B||(B=e.queryResult=new Map);let z=!0;for(let n=i;n<=s;n++){let i=t[n*N];i<0?i=0:i>a&&(i=a);let s=t[n*N+1];s<0?s=0:s>a&&(s=a);const l=i+s*a;let h,c,u=B.get(l);if(u||0===u)e[n]!==u&&(e[n]=u,e.dirty=!0);else{for(let e=0;e<w.length;e++)if(dF(w[e],I+H*i,E-H*s,o)){h=w[e];break}h&&(A.getRenderer().isTileCached(h.id)||e[n]===RL)&&(wF.set(i,s),c=this.layer.queryTilePointTerrain(wF,h,D,a,o)),u=e[n],c&&(u=null===c[0]?RL:c[0],TF[0]=u,u=TF[0]),e[n]!==u&&(e[n]=u,e.dirty=!0),c&&c[1]?B.set(l,u):z=!1}}M.altitudeQueryFrameTime=(M.altitudeQueryFrameTime||0)+(performance.now()-C),n.completeTerrainQuery[c]=z,z&&(this._terrainAltitudeCache||(this._terrainAltitudeCache=new Fo(4*this.layer.options.maxCacheSize)),this._terrainAltitudeCache.add(u,{altitudeData:e,terrainTileInfos:w}))}shouldDrawParentTile(){return!0}};function IF(e,t){const n=e&&e.getCommandKey(this.regl)||"",i=t&&t.getCommandKey(this.regl)||"";return n.localeCompare(i)}function kF(e,t){return e.properties.level-t.properties.level}let OF=class xn extends PF{createGeometry(e,t){const n=this.layer.options.debugTileData;if(n&&!WL(n.x)){const{x:t,y:i,z:s}=e.tileInfo;n.x===t&&n.y===i&&n.z===s&&console.log("glData",{layerId:this.layer.getId(),x:t,y:i,z:s,glData:e})}if(!e.data)return{geometry:null,symbolIndex:e.symbolIndex};e.iconAtlas&&e.iconAtlas.image&&(e.iconAtlas.image.dataType=e.type,e.iconAtlas.image.type="icon"),e.glyphAtlas&&e.glyphAtlas.image&&(e.glyphAtlas.image.type="glyph");const i=UL({},e.data),s={primitive:this.getPrimitive(),positionSize:e.positionSize};i.aAltitude&&(s.altitudeAttribute="aAltitude");const o=new CM.Geometry(i,e.indices,0,s);return o.properties={features:t},e.iconAtlas&&(o.properties.iconAtlas=e.iconAtlas.image,o.properties.iconPositions=e.iconAtlas.positions),e.glyphAtlas&&(o.properties.glyphAtlas=e.glyphAtlas.image),BD(t)||(o.properties.aFeaIds=e.featureIds,this._prepareFeatureIds(o,e)),e.markerPlacement&&(o.properties.markerPlacement=e.markerPlacement),e.textPlacement&&(o.properties.textPlacement=e.textPlacement),UL(o.properties,e.properties),{geometry:o,symbolIndex:e.symbolIndex}}getRayCastData(e,t){const{features:n,aFeaIds:i}=e.geometry.properties;return n&&i?n[i[t]]:null}getPrimitive(){return"triangles"}getRenderFBO(e){return e&&e.renderTarget&&e.renderTarget.fbo}supportRenderMode(e){return"noAa"===e}drawDebugAtlas(e){if(document.getElementById("MAPTALKS_ICON_DEBUG")){const t=document.getElementById("MAPTALKS_ICON_DEBUG");let n;if(t.width=e.width,t.height=e.height,t.style.width=e.width+"px",t.style.height=e.height+"px","alpha"===e.format){n=new Uint8ClampedArray(4*e.data.length);for(let t=0;t<e.data.length;t++)n[4*t+3]=e.data[t]}else n=new Uint8ClampedArray(e.data);const i=t.getContext("2d");i.imageSmoothingEnabled=!1,i.putImageData(new ImageData(n,e.width,e.height),0,0)}}};var EF="#include <gl2_vert>\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nuniform mat4 projViewModelMatrix;\nuniform mat4 positionMatrix;\n#include <fbo_picking_vert>\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n  gl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);\n  fbo_picking_setData(gl_Position.w, true);\n}";function RF(e,t,n,i){if(i){const e=CM.Util.resizeToPowerOfTwo(t.data,t.width,t.height);t.data=e}const s={width:t.width,height:t.height,data:t.data,format:t.format,mag:"linear",min:i?"linear mipmap linear":"linear",flipY:n,premultiplyAlpha:!0};if("icon"===t.type){const e="point"!==t.dataType?"repeat":"clamp";s.wrapS=e,s.wrapT=e}return e.texture(s)}const LF=[0,0],DF=[];function FF(e){if(!e.properties.iconPositions)return LF;let t,n=0;for(const i in e.properties.iconPositions)if(t=i,n++,n>1)return LF;if(!t)return LF;const i=e.properties.iconPositions[t],s=i.displaySize[1];return DF[0]=i.displaySize[0],DF[1]=s,DF}function HF(e){const t=new Set;for(const n of e)if(n.includes("&&")||n.includes("||")){const e=NF(n);for(const n of e)t.add(n.trim())}else t.add(n);return t}function NF(e){return e.split(/&&|\|\|/)}function BF(e,t,n,i,s){if(!e.wgpu)return t;const o=e.wgpu.limits.maxVertexBuffers;let a=0,l={};for(let e=0;e<n.length;e++){const i=n[e];if(CM.WGSLParseDefines.getDefineConditionValue(i,t)&&(a++,a+s<=o)){const e=NF(i);for(const n of e)t[n]&&(l[n]=t[n])}}for(const e in t)i.has(e)||(l[e]=t[e]);return l}const zF=["HAS_ALTITUDE","HAS_OFFSET_Z","HAS_TEXT_SIZE","HAS_MARKER_WIDTH || HAS_MARKER_HEIGHT","HAS_TEXT_FILL","HAS_MARKER_DX || HAS_MARKER_DY || HAS_TEXT_DX || HAS_TEXT_DY","HAS_OPACITY","HAS_MARKER_PITCH_ALIGN || HAS_TEXT_PITCH_ALIGN","HAS_MARKER_ROTATION_ALIGN || HAS_TEXT_ROTATION_ALIGN","HAS_MARKER_ROTATION || HAS_TEXT_ROTATION","HAS_TEXT_HALO_FILL","HAS_HALO_ATTR || HAS_TEXT_HALO_RADIUS || HAS_TEXT_HALO_OPACITY"],GF=HF(zF);function UF(e,t){return BF(e,t,zF,GF,2)}const VF=["HAS_ALTITUDE","HAS_COLOR","HAS_OPACITY","HAS_LINE_WIDTH","HAS_PATTERN || HAS_DASHARRAY || HAS_GRADIENT || HAS_TRAIL","HAS_PATTERN","HAS_GRADIENT","HAS_DASHARRAY && HAS_DASHARRAY_ATTR","HAS_DASHARRAY && HAS_DASHARRAY_COLOR","HAS_LINE_DX || HAS_LINE_DY","HAS_STROKE_WIDTH","HAS_STROKE_COLOR"],jF=HF(VF),WF=["HAS_ALTITUDE","HAS_COLOR","HAS_OPACITY","HAS_PATTERN","HAS_PATTERN && HAS_PATTERN_WIDTH","HAS_PATTERN && HAS_PATTERN_ORIGIN","HAS_PATTERN && HAS_PATTERN_OFFSET","HAS_PATTERN && HAS_UV_SCALE","HAS_PATTERN && HAS_UV_OFFSET","HAS_PATTERN && HAS_TEX_COORD"],qF=HF(WF),{INVALID_TEX_COORD:ZF}=eL(),XF=AA([]),YF={polygonFill:[1,1,1,1],polygonOpacity:1,uvScale:[1,1],uvOffset:[0,0],patternWidth:[0,0],patternOffset:[0,0]},JF=[],QF=new fl(0,0),$F=new fl(0,0),KF=new fl(0,0),eH=[];let tH=class Gn extends OF{static getBloomSymbol(){return["polygonBloom"]}prepareSymbol(e){const t=e.polygonFill;Array.isArray(t)&&(3===t.length&&t.push(1),e.polygonFill=t.map((e=>255*e)))}supportRenderMode(e){return this.sceneConfig.antialias||void 0===this.sceneConfig.antialias?"fxaa"===e||"fxaaBeforeTaa"===e:super.supportRenderMode(e)}isBloom(e){return!!this.getSymbol(e.properties.symbolIndex)[Gn.getBloomSymbol()[0]]}forbiddenTerrainUpscale(){return!0}needPolygonOffset(){return!0}getAnalysisMeshes(){return this.isVisible()?this.scene.getMeshes().filter((e=>0===e.properties.level)):JF}createMesh(e,t,n){const i=this.getMap(),{tilePoint:s}=n,{geometry:o,symbolIndex:a,ref:l}=e,h=this.layer instanceof Up,c=this.layer.getTileSize().width,u=o.properties.tileExtent/c,f=o.properties.tileResolution,g=i.pointAtResToCoord(QF.set(s[0],s[1]),f),m={tileExtent:o.properties.tileExtent,tileRatio:u},A=this.getSymbol(a),w=this.getSymbolDef(a);if(SE(w.polygonPatternFileOrigin)&&this._preparePatternOrigin(w,e,h?[0,0]:s,f),(SE(w.polygonPatternFileWidth)||SE(w.polygonPatternFileWidth))&&this._preparePatternWidth(w,e,h?u:1,g,f),w.uvOffsetInMeter&&SE(w.uvOffset)&&this._preparePatternOffset(w,e,g,f),ZL(m,"polygonFill",A,"polygonFill",YF.polygonFill,JL(this.colorCache)),ZL(m,"polygonOpacity",A,"polygonOpacity",YF.polygonOpacity),ZL(m,"uvScale",A,"uvScale",YF.uvScale),void 0===l){const e=this.getFnTypeConfig(a);VD(o,w,e,this.layer),o.generateBuffers(this.regl)}const T=o.properties.iconAtlas,S=2048;if(T&&o.data.aTexInfo){const e=[];Object.defineProperty(m,"uvOrigin",{enumerable:!0,get:()=>{const t=m.tileScale;if(o.data.aPatternOrigin)return e[0]=s[0]*t%S,e[1]=s[1]*t%S,e;const n=A.polygonPatternFileOrigin;return n?(QF.set(n[0],n[1]),i.coordToPointAtRes(QF,f,$F),U_(e,s[0]-$F.x,s[1]-$F.y)):(e[0]=s[0]*t%S,e[1]=s[1]*t%S,e)}});const t=[];Object.defineProperty(m,"patternWidth",{enumerable:!0,get:()=>{if(o.data.aPatternWidth)return YF.patternWidth;const e=w.polygonPatternFileWidth,n=w.polygonPatternFileHeight;if(!e&&!n)return YF.patternWidth;const[i,s]=this._computePatternWidth(eH,e,n,h?u:1,g,f);return U_(t,i,s)}}),Object.defineProperty(m,"uvOffset",{enumerable:!0,get:()=>o.data.aPatternOffset||w.uvOffsetInMeter?YF.uvOffset:A.uvOffset||YF.uvOffset});const n=[];Object.defineProperty(m,"patternOffset",{enumerable:!0,get:()=>{if(o.data.aPatternOffset)return YF.uvOffset;if(!w.uvOffsetInMeter)return YF.uvOffset;const e=w.uvOffset;if(!e)return YF.uvOffset;const t=iD(i,e[0],g,f),s=iD(i,e[1],g,f);return U_(n,t,s)}}),Object.defineProperty(m,"tileScale",{enumerable:!0,get:function(){return w.polygonPatternFileWidth||w.polygonPatternFileHeight?1:o.properties.tileResolution/i.getResolution()}}),m.polygonPatternFile=RF(this.regl,T,!1,!1),m.atlasSize=[T.width,T.height],this.drawDebugAtlas(T)}const M=new CM.Material(m,YF),C=new CM.Mesh(o,M,{castShadow:!1,picking:!0}),I={};return T&&o.data.aTexInfo&&(I.HAS_PATTERN=1),T&&o.data.aTexCoord&&(I.HAS_TEX_COORD=1,I.INVALID_TEX_COORD=ZF+".0"),o.data.aAltitude&&(I.HAS_ALTITUDE=1),o.data.aColor&&(I.HAS_COLOR=1),o.data.aOpacity&&(I.HAS_OPACITY=1),o.data.aUVScale&&(I.HAS_UV_SCALE=1),o.data.aUVOffset&&(I.HAS_UV_OFFSET=1),o.data.aPatternOrigin&&(I.HAS_PATTERN_ORIGIN=1),o.data.aPatternWidth&&(I.HAS_PATTERN_WIDTH=1),o.data.aPatternOffset&&(I.HAS_PATTERN_OFFSET=1),h&&(I.IS_VT=1),C.setDefines(I),C.positionMatrix=this.getAltitudeOffsetMatrix(),C.setLocalTransform(t),C.properties.symbolIndex=a,C}_preparePatternWidth(e,t,n,i,s){if(!(t=t&&t.geometry))return;const o=t.properties.features;if(BD(o))return;const a=e.polygonPatternFileWidth,l=e.polygonPatternFileHeight,h=CE(e.polygonPatternFileOrigin);let c,u;SE(a)&&(c=CE(a)),SE(l)&&(u=CE(l));const{aPickingId:f,aPatternOrigin:g}=t.data,m=new Float32Array(2*f.length);let A,w,T;for(let e=0,t=f.length;e<t;e++){let t,S;if(f[e]===A){m[2*e]=w,m[2*e+1]=T;continue}const M=o[f[e]];if(t=c?c(null,M.feature.properties):a,S=u?u(null,M.feature.properties):l,A=f[e],t||S){let o=i;if(g){const e=h(null,M.feature.properties);e&&(o=KF.set(e[0],e[1]))}const[a,l]=this._computePatternWidth(eH,t,S,n,o,s);w=m[2*e]=a,T=m[2*e+1]=l}else w=m[2*e]=0,T=m[2*e+1]=0}t.data.aPatternWidth=m}_preparePatternOffset(e,t,n,i){if(!(t=t&&t.geometry))return;const s=t.properties.features;if(BD(s))return;const o=this.getMap();let a=SE(e.uvOffsetInMeter)&&PE(e.uvOffsetInMeter);const l=CE(e.uvOffset),h=CE(e.polygonPatternFileOrigin),{aPickingId:c,aPatternOrigin:u}=t.data,f=new Float32Array(2*c.length);let g,m,A;for(let e=0,t=c.length;e<t;e++){if(c[e]===g){f[2*e]=m,f[2*e+1]=A;continue}const t=s[c[e]],w=l(null,t.feature.properties);let T=!0;if(a&&(T=a(null,t.feature.properties)),g=c[e],w&&T){let s=n;if(u){const e=h(null,t.feature.properties);e&&(s=KF.set(e[0],e[1]))}const a=iD(o,w[0],s,i),l=iD(o,w[0],s,i);m=f[2*e]=a,A=f[2*e+1]=l}else m=f[2*e]=0,A=f[2*e+1]=0}t.data.aPatternOffset=f}_preparePatternOrigin(e,t,n,i){if(!(t=t&&t.geometry))return;const s=t.properties.features;if(BD(s))return;const o=this.getMap(),a=CE(e.polygonPatternFileOrigin),l=t.data.aPickingId,h=new Float32Array(2*l.length);let c,u,f;for(let e=0,t=l.length;e<t;e++){if(l[e]===c){h[2*e]=u,h[2*e+1]=f;continue}c=l[e];const t=a(null,s[c].feature.properties);t?(QF.set(t[0],t[1]),o.coordToPointAtRes(QF,i,$F),u=h[2*e]=$F.x,f=h[2*e+1]=$F.y):(u=h[2*e]=n[0],f=h[2*e+1]=n[1])}t.data.aPatternOrigin=h}createFnTypeConfig(e,t){const n=PE(t.polygonFill),i=CE(t.polygonOpacity),s=CE(t.uvScale),o=CE(t.uvOffset),a=new Uint8Array(1),l=new Uint16Array(2),h=new Uint8Array(2);return[{attrName:"aColor",symbolName:"polygonFill",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(t,i)=>{let s=n(e.getZoom(),t);return SE(s)&&(s=this.evaluateInFnTypeConfig(s,i,e,t,!0)),Array.isArray(s)||(s=this.colorCache[s]=this.colorCache[s]||oE(s).unitArray()),s=YL(s),s}},{attrName:"aOpacity",symbolName:"polygonOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(t,n)=>{let s=i(e.getZoom(),t);return SE(s)&&(s=this.evaluateInFnTypeConfig(s,n,e,t)),a[0]=255*s,a[0]}},{attrName:"aUVScale",symbolName:"uvScale",type:Uint16Array,width:2,define:"HAS_UV_SCALE",evaluate:t=>{const n=s(e.getZoom(),t);return l[0]=255*n[0],l[1]=255*n[1],l}},{attrName:"aUVOffset",symbolName:"uvOffset",type:Uint8Array,width:2,define:"HAS_UV_OFFSET",evaluate:t=>{const n=o(e.getZoom(),t);return h[0]=255*n[0],h[1]=255*n[1],h}}]}paint(e){if(this.isShadowIncludeChanged(e)){this.shader.dispose();const t=this._getExtraCommandProps();this._createShader(e,t)}super.paint(e)}isEnableTileStencil(e){const t="VectorTileLayer"===this.layer.getJSONType(),n=this.layer instanceof Up;return!(e&&e.isRenderingTerrain&&this.isTerrainSkin())&&(t||n&&this.isOnly2D())}_getExtraCommandProps(){const e=this.canvas,t={x:(e,t)=>t.viewport?t.viewport.x:0,y:(e,t)=>t.viewport?t.viewport.y:0,width:(t,n)=>n.viewport?n.viewport.width:e?e.width:1,height:(t,n)=>n.viewport?n.viewport.height:e?e.height:1};return this.renderer=new CM.Renderer(this.regl),{viewport:t,stencil:{enable:(e,t)=>t.geometryProperties.is2D&&this.isEnableTileStencil(t.painterContext),func:{cmp:()=>this.isOnly2D()?"=":"<=",ref:(e,t)=>t.stencilRef},op:{fail:"keep",zfail:"keep",zpass:()=>{const e="VectorTileLayer"===this.layer.getJSONType(),t=this.isOnly2D();return e&&t?"zero":"replace"}}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],mask:(e,t)=>{if(!WL(this.sceneConfig.depthMask))return!!this.sceneConfig.depthMask;if(t.hasSSRGround)return!0;if(t.meshConfig.transparent)return!1;const n=t.polygonOpacity;return!(KL(n)&&n<1)},func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}init(e){const t=this._getExtraCommandProps();if(this._createShader(e,t),this.pickingFBO){const e=[],n=this.layer instanceof Up;this.picking=[new CM.FBORayPicking(this.renderer,{name:"fill-picking",vert:EF,wgslVert:"struct VertexInput {\n#ifdef HAS_ALTITUDE\n        @location($i) aPosition: vec2i,\n        @location($i) aAltitude: f32,\n#else\n        @location($i) aPosition: vec4i,\n#endif\n}\nstruct UniformsStruct {\n    projViewModelMatrix: mat4x4f,\n    positionMatrix: mat4x4f,\n}\n@group(0) @binding($b) var<uniform> uniforms: UniformsStruct;\nstruct VertexOutput {\n    @builtin(position) position: vec4f,\n}\n#include <fbo_picking_vert>\n#include <vt_position_vert>\n@vertex\nfn main(\n    input: VertexInput,\n) -> VertexOutput {\n    let position = unpackVTPosition(input);\n    var output: VertexOutput;\n    output.position = uniforms.projViewModelMatrix * uniforms.positionMatrix * vec4f(position, 1.0);\n    fbo_picking_setData(input, &output, output.position.w, true);\n    return output;\n}",defines:{PICKING_MODE:1},uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,n){return vA(e,n.projViewMatrix,n.modelMatrix),e}}],extraCommandProps:t,enableStencil:()=>n&&this.isOnly2D()},this.pickingFBO,this.getMap())]}}_createShader(e,t){const n=[],i=[{name:"projViewModelMatrix",type:"function",fn:function(e,t){return vA(n,t.projViewMatrix,t.modelMatrix),n}}],s={};this.fillIncludes(s,i,e);this.shader=new CM.MeshShader({name:"vt-fill",vert:"#define SHADER_NAME FILL\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\n#ifdef HAS_COLOR\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#ifdef HAS_OPACITY\nattribute float aOpacity;\nvarying float vOpacity;\n#endif\nuniform mat4 projViewModelMatrix;\nuniform mat4 positionMatrix;\n#ifndef IS_VT\nuniform mat4 modelMatrix;\n#endif\n#ifdef HAS_PATTERN\n#ifdef HAS_TEX_COORD\nattribute vec2 aTexCoord;\n#endif\nattribute vec4 aTexInfo;\nuniform vec2 patternWidth;\nuniform vec2 patternOffset;\nuniform vec2 uvOrigin;\nuniform vec2 uvScale;\n#ifdef IS_VT\nuniform float tileRatio;\nuniform float tileScale;\n#else\nuniform float glScale;\n#endif\n#ifdef HAS_UV_SCALE\nattribute vec2 aUVScale;\nvarying vec2 vUVScale;\n#endif\n#ifdef HAS_UV_OFFSET\nattribute vec2 aUVOffset;\nvarying vec2 vUVOffset;\n#endif\n#ifdef HAS_PATTERN_WIDTH\nattribute vec2 aPatternWidth;\n#endif\n#ifdef HAS_PATTERN_ORIGIN\nattribute vec2 aPatternOrigin;\n#endif\n#ifdef HAS_PATTERN_OFFSET\nattribute vec2 aPatternOffset;\n#endif\nvarying vec2 vTexCoord;\nvarying vec4 vTexInfo;\nvec2 c(vec2 d, vec2 e) {\n  \n#ifdef IS_VT\nfloat f = d.x / e.x;\n  float h = d.y / e.y;\n  return vec2(f, h);\n#else\nfloat i = glScale;\n#ifdef HAS_PATTERN_WIDTH\nfloat j = sign(length(aPatternWidth));\n  i = mix(glScale, 1., j);\n#endif\nvec2 k = uvOrigin;\n#ifdef HAS_PATTERN_ORIGIN\nk = aPatternOrigin;\n#endif\n#ifdef HAS_PATTERN_OFFSET\nvec2 l = aPatternOffset;\n#else\nvec2 l = patternOffset;\n#endif\nk += l;\n  float f = (d.x - k.x) * i / e.x;\n  float h = (d.y - k.y) * i / e.y;\n  return vec2(f, -h);\n#endif\n}\nvec2 m(vec4 n, vec2 o) {\n  \n#ifdef IS_VT\n#ifdef HAS_PATTERN_OFFSET\nvec2 l = aPatternOffset;\n#else\nvec2 l = patternOffset;\n#endif\nvec2 k = uvOrigin + l;\n#ifdef HAS_PATTERN_ORIGIN\nk = k - aPatternOrigin * tileScale;\n#endif\nfloat j = sign(length(patternWidth));\n  vec2 A = mix(o, patternWidth, j);\n#ifdef HAS_PATTERN_WIDTH\nA = aPatternWidth;\n#endif\nvec2 B = k * vec2(1., -1.) / A;\n  return mod(B, 1.) + c(n.xy * tileScale / tileRatio, A);\n#else\nvec2 A = o;\n#ifdef HAS_PATTERN_WIDTH\nfloat j = sign(length(aPatternWidth));\n  A = mix(o, aPatternWidth, j);\n#endif\nvec4 C = modelMatrix * n;\n  return c(C.xy, A);\n#endif\n}\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#include <vt_position_vert>\n#include <highlight_vert>\nvoid main() {\n  vec3 D = unpackVTPosition();\n  vec4 n = vec4(D, 1.);\n  gl_Position = projViewModelMatrix * positionMatrix * n;\n#ifdef HAS_PATTERN\nvec2 o = aTexInfo.zw + 1.;\n  vTexInfo = vec4(aTexInfo.xy, o);\n#ifdef HAS_TEX_COORD\nif(aTexCoord.x == INVALID_TEX_COORD) {\n    vTexCoord = m(n, o);\n  } else {\n    vTexCoord = aTexCoord;\n  }\n#else\nvTexCoord = m(n, o);\n#endif\n#ifdef HAS_UV_SCALE\nvUVScale = aUVScale / 255.;\n#endif\n#ifdef HAS_UV_OFFSET\nvUVOffset = aUVOffset / 255.;\n#endif\n#endif\n#ifdef HAS_COLOR\nvColor = aColor / 255.;\n#endif\nhighlight_setVarying();\n#ifdef HAS_OPACITY\nvOpacity = aOpacity / 255.;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(n);\n#endif\n}",frag:"#define SHADER_NAME FILL\nprecision mediump float;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#ifdef HAS_PATTERN\n#ifdef HAS_UV_SCALE\nvarying vec2 vUVScale;\n#else\nuniform highp vec2 uvScale;\n#endif\n#ifdef HAS_UV_OFFSET\nvarying vec2 vUVOffset;\n#else\nuniform vec2 uvOffset;\n#endif\n#endif\n#ifdef HAS_PATTERN\nuniform sampler2D polygonPatternFile;\nuniform vec2 atlasSize;\nvarying vec2 vTexCoord;\nvarying vec4 vTexInfo;\nvec2 c() {\n  \n#ifdef HAS_UV_SCALE\nvec2 d = vUVScale;\n#else\nvec2 d = uvScale;\n#endif\n#ifdef HAS_UV_OFFSET\nvec2 e = vUVOffset;\n#else\nvec2 e = uvOffset;\n#endif\nvec2 f = mod(vTexCoord * d + e, 1.);\n  vec2 h = vTexInfo.xy;\n  vec2 i = vTexInfo.zw;\n  return (h + f * i) / atlasSize;\n}\n#endif\n#ifdef HAS_COLOR\nvarying vec4 vColor;\n#else\nuniform vec4 polygonFill;\n#endif\n#include <highlight_frag>\n#ifdef HAS_OPACITY\nvarying float vOpacity;\n#else\nuniform lowp float polygonOpacity;\n#endif\nuniform float layerOpacity;\nuniform float tileExtent;\nvoid main() {\n  \n#ifdef HAS_COLOR\nvec4 j = vColor;\n#else\nvec4 j = polygonFill;\n#endif\n#ifdef HAS_PATTERN\nif(vTexInfo.z * vTexInfo.w > 1.) {\n    vec2 f = c();\n    j = texture2D(polygonPatternFile, f);\n  }\n#endif\n#ifdef HAS_OPACITY\ngl_FragColor = j * vOpacity;\n#else\ngl_FragColor = j * polygonOpacity;\n#endif\ngl_FragColor *= layerOpacity;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat k = shadow_computeShadow();\n  gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, k);\n#endif\ngl_FragColor = highlight_blendColor(gl_FragColor);\n}",wgslVert:`#define POSITION_TYPE ${this.layer instanceof Up?"vec2i":"vec2f"}\n`+"#define SHADER_NAME FILL\nstruct VertexInput {\n#ifdef HAS_ALTITUDE\n    @location($i) aPosition: POSITION_TYPE,\n    @location($i) aAltitude: f32,\n#else\n    @location($i) aPosition: vec4i,\n#endif\n#ifdef HAS_COLOR\n    @location($i) aColor: vec4u,\n#endif\n#ifdef HAS_OPACITY\n    @location($i) aOpacity: u32,\n#endif\n#ifdef HAS_PATTERN\n    #ifdef HAS_TEX_COORD\n        @location($i) aTexCoord: vec2f,\n    #endif\n    @location($i) aTexInfo: vec4u,\n    #ifdef HAS_UV_SCALE\n        @location($i) aUVScale: vec2u,\n    #endif\n    #ifdef HAS_UV_OFFSET\n        @location($i) aUVOffset: vec2u,\n    #endif\n    #ifdef HAS_PATTERN_WIDTH\n        @location($i) aPatternWidth: vec2f,\n    #endif\n    #ifdef HAS_PATTERN_ORIGIN\n        @location($i) aPatternOrigin: vec2f,\n    #endif\n    #ifdef HAS_PATTERN_OFFSET\n        @location($i) aPatternOffset: vec2f,\n    #endif\n#endif\n}\nstruct VertexOutput {\n    @builtin(position) position : vec4f,\n#ifdef HAS_COLOR\n    @location($o) vColor: vec4f,\n#endif\n#ifdef HAS_OPACITY\n    @location($o) vOpacity: f32,\n#endif\n#ifdef HAS_PATTERN\n    @location($o) vTexCoord: vec2f,\n    @location($o) vTexInfo: vec4f,\n    #ifdef HAS_UV_SCALE\n        @location($o) vUVScale: vec2f,\n    #endif\n    #ifdef HAS_UV_OFFSET\n        @location($o) vUVOffset: vec2f,\n    #endif\n#endif\n}\nstruct ModelUniforms {\n    projViewModelMatrix: mat4x4f,\n    positionMatrix: mat4x4f,\n#ifdef IS_VT\n#else\n    modelMatrix: mat4x4f,\n#endif\n#ifdef HAS_PATTERN\n    patternWidth: vec2f,\n    patternOffset: vec2f,\n    uvOrigin: vec2f,\n    uvScale: vec2f,\n#ifdef IS_VT\n    tileRatio: f32,\n    tileScale: f32,\n#else\n    glScale: f32,\n#endif\n#endif\n};\n#ifdef HAS_PATTERN && IS_VT\n#else\nstruct Uniforms {\n    glScale: f32,\n}\n#endif\n@group(0) @binding($b) var<uniform> uniforms: ModelUniforms;\n#ifdef HAS_PATTERN && IS_VT\n#else\n@group(0) @binding($b) var<uniform> shaderUniforms: Uniforms;\n#endif\n#ifdef HAS_PATTERN\n    fn computeUV(vertex: vec2f, patternWidth: vec2f) -> vec2f {\n        #ifdef IS_VT\n            let u = vertex.x / patternWidth.x;\n            let v = vertex.y / patternWidth.y;\n            return vec2f(u, v);\n        #else\n            let glScale = shaderUniforms.glScale;\n            var mapGLScale = glScale;\n            #ifdef HAS_PATTERN_WIDTH\n                let hasPatternWidth = sign(length(aPatternWidth));\n                mapGLScale = mix(glScale, 1.0, hasPatternWidth);\n            #endif\n            var origin = uniforms.uvOrigin;\n            #ifdef HAS_PATTERN_ORIGIN\n                origin = aPatternOrigin;\n            #endif\n            #ifdef HAS_PATTERN_OFFSET\n                let myPatternOffset = aPatternOffset;\n            #else\n                let myPatternOffset = uniforms.patternOffset;\n            #endif\n            origin += myPatternOffset;\n            let u = (vertex.x - origin.x) * mapGLScale / patternWidth.x;\n            let v = (vertex.y - origin.y) * mapGLScale / patternWidth.y;\n            return vec2f(u, -v);\n        #endif\n    }\n    fn computeTexCoord(localVertex: vec4f, patternSize: vec2f) -> vec2f {\n        #ifdef IS_VT\n            #ifdef HAS_PATTERN_OFFSET\n                let myPatternOffset = aPatternOffset;\n            #else\n                let myPatternOffset = uniforms.patternOffset;\n            #endif\n            var origin = uniforms.uvOrigin + myPatternOffset;\n            #ifdef HAS_PATTERN_ORIGIN\n                origin = origin - aPatternOrigin * uniforms.tileScale;\n            #endif\n            let hasPatternWidth = sign(length(uniforms.patternWidth));\n            var myPatternWidth = mix(patternSize, uniforms.patternWidth, hasPatternWidth);\n            #ifdef HAS_PATTERN_WIDTH\n                myPatternWidth = aPatternWidth;\n            #endif\n            let originOffset = origin * vec2f(1.0, -1.0) / myPatternWidth;\n            return (originOffset % 1.0) + computeUV(localVertex.xy * uniforms.tileScale / uniforms.tileRatio, myPatternWidth);\n        #else\n            var myPatternWidth = patternSize;\n            #ifdef HAS_PATTERN_WIDTH\n                let hasPatternWidth = sign(length(aPatternWidth));\n                myPatternWidth = mix(patternSize, aPatternWidth, hasPatternWidth);\n            #endif\n            let position = uniforms.modelMatrix * localVertex;\n            return computeUV(position.xy, myPatternWidth);\n        #endif\n    }\n#endif\n#if HAS_SHADOWING && !HAS_BLOOM\n    #include <vsm_shadow_vert>\n#endif\n#include <vt_position_vert>\n#include <highlight_vert>\n@vertex\nfn main(vertexInput: VertexInput) -> VertexOutput {\n    let myPosition = unpackVTPosition(vertexInput);\n    let localVertex = vec4f(myPosition, 1.0);\n    var out: VertexOutput;\n    var position = uniforms.projViewModelMatrix * uniforms.positionMatrix * localVertex;\n    out.position = position;\n    #ifdef HAS_PATTERN\n        let aTexInfo: vec4f = vec4f(vertexInput.aTexInfo);\n        let patternSize = aTexInfo.zw + 1.0;\n        out.vTexInfo = vec4f(aTexInfo.xy, patternSize);\n        #ifdef HAS_TEX_COORD\n            if (vertexInput.aTexCoord.x == INVALID_TEX_COORD) {\n                out.vTexCoord = computeTexCoord(localVertex, patternSize);\n            } else {\n                out.vTexCoord = vertexInput.aTexCoord;\n            }\n        #else\n            out.vTexCoord = computeTexCoord(localVertex, patternSize);\n        #endif\n        #ifdef HAS_UV_SCALE\n            out.vUVScale = vec2f(vertexInput.aUVScale) / 255.0;\n        #endif\n        #ifdef HAS_UV_OFFSET\n            out.vUVOffset = vec2f(vertexInput.aUVOffset) / 255.0;\n        #endif\n    #endif\n    #ifdef HAS_COLOR\n        out.vColor = vec4f(vertexInput.aColor) / 255.0;\n    #endif\n    #if HAS_HIGHLIGHT_COLOR || HAS_HIGHLIGHT_OPACITY\n        highlight_setVarying(vertexInput, out);\n    #endif\n    #ifdef HAS_OPACITY\n        out.vOpacity = f32(vertexInput.aOpacity) / 255.0;\n    #endif\n    #if HAS_SHADOWING && !HAS_BLOOM\n        shadow_computeShadowPars(localVertex);\n    #endif\n    return out;\n}",wgslFrag:"#define SHADER_NAME FILL\n#if HAS_SHADOWING && !HAS_BLOOM\n    #include <vsm_shadow_frag>\n#endif\nstruct FragmentUniforms {\n    #ifdef HAS_PATTERN\n        #ifndef HAS_UV_SCALE\n            uvScale: vec2f,\n        #endif\n        #ifndef HAS_UV_OFFSET\n            uvOffset: vec2f,\n        #endif\n        atlasSize: vec2f,\n    #endif\n    #ifndef HAS_COLOR\n        polygonFill: vec4f,\n    #endif\n    #ifndef HAS_OPACITY\n        polygonOpacity: f32,\n    #endif\n    tileExtent: f32,\n}\nstruct ShaderUniforms {\n    layerOpacity: f32,\n}\n@group(0) @binding($b) var<uniform> fragmentUniforms: FragmentUniforms;\n@group(0) @binding($b) var<uniform> uniforms: ShaderUniforms;\n#if HAS_PATTERN\n    @group(0) @binding($b) var polygonPatternFile: texture_2d<f32>;\n    @group(0) @binding($b) var polygonPatternFileSampler: sampler;\n#endif\n#ifdef HAS_PATTERN || HAS_COLOR || HAS_OPACITY || HAS_UV_SCALE || HAS_UV_OFFSET || HAS_HIGHLIGHT_COLOR || HAS_HIGHLIGHT_OPACITY\n    struct VertexOutput {\n    #ifdef HAS_PATTERN\n        @location($i) vTexCoord: vec2f,\n        @location($i) vTexInfo: vec4f,\n    #endif\n    #ifdef HAS_COLOR\n        @location($i) vColor: vec4f,\n    #endif\n    #ifdef HAS_OPACITY\n        @location($i) vOpacity: f32,\n    #endif\n    #ifdef HAS_PATTERN && HAS_UV_SCALE\n        @location($i) vUVScale: vec2f,\n    #endif\n    #ifdef HAS_PATTERN && HAS_UV_OFFSET\n        @location($i) vUVOffset: vec2f,\n    #endif\n    }\n#endif\n#include <highlight_frag>\n#ifdef HAS_PATTERN\n    fn computeUV(vertexOutput: VertexOutput) -> vec2f {\n        #ifdef HAS_UV_SCALE\n            let myUVScale = vertexOutput.vUVScale;\n        #else\n            let myUVScale = fragmentUniforms.uvScale;\n        #endif\n        #ifdef HAS_UV_OFFSET\n            let myUVOffset = vertexOutput.vUVOffset;\n        #else\n            let myUVOffset = fragmentUniforms.uvOffset;\n        #endif\n        let uv = (vertexOutput.vTexCoord * myUVScale + myUVOffset) % 1.0;\n        let uvStart = vertexOutput.vTexInfo.xy;\n        let uvSize = vertexOutput.vTexInfo.zw;\n        return (uvStart + uv * uvSize) / fragmentUniforms.atlasSize;\n    }\n#endif\n@fragment\nfn main(\n    #ifdef HAS_PATTERN || HAS_COLOR || HAS_OPACITY || HAS_UV_SCALE || HAS_UV_OFFSET || HAS_HIGHLIGHT_COLOR || HAS_HIGHLIGHT_OPACITY\n    vertexOutput: VertexOutput\n    #endif\n) -> @location(0) vec4f {\n    #ifdef HAS_COLOR\n        var color = vertexOutput.vColor;\n    #else\n        var color = fragmentUniforms.polygonFill;\n    #endif\n    #ifdef HAS_PATTERN\n        let uv = computeUV(vertexOutput);\n        var texColor = textureSample(polygonPatternFile, polygonPatternFileSampler, uv);\n        if (vertexOutput.vTexInfo.z * vertexOutput.vTexInfo.w > 1.0) {\n            color = texColor;\n        }\n    #endif\n    #ifdef HAS_OPACITY\n        var outputColor = color * vertexOutput.vOpacity;\n    #else\n        var outputColor = color * fragmentUniforms.polygonOpacity;\n    #endif\n    outputColor *= uniforms.layerOpacity;\n    #if HAS_SHADOWING && !HAS_BLOOM\n        let shadowCoeff = shadow_computeShadow();\n        outputColor.rgb = shadow_blend(outputColor.rgb, shadowCoeff);\n    #endif\n    #if HAS_HIGHLIGHT_COLOR || HAS_HIGHLIGHT_OPACITY\n        outputColor = highlight_blendColor(outputColor, vertexOutput);\n    #endif\n    return outputColor;\n}",uniforms:i,defines:s,extraCommandProps:t})}limitMeshDefines(e){let t=e.defines;t=function(e,t){return BF(e,t,WF,qF,1)}(this.regl,t),e.setDefines(t)}getUniformValues(e,t){const n=t&&t.isRenderingTerrainSkin,i={projViewMatrix:n?XF:e.projViewMatrix,glScale:t&&t.isRenderingTerrainSkin?1:1/e.getGLScale(),viewport:n&&t&&t.viewport,hasSSRGround:t&&t.hasSSRGround};return this.setIncludeUniformValues(i,t),i}_computePatternWidth(e,t,n,i,s,o){let a,l;const h=this.getMap();return t&&(a=iD(h,t,s,o)),n&&(l=iD(h,n,s,o,1)),a=a||l,l=l||a,e[0]=a,e[1]=l,e}};var nH="#define SHADER_NAME LINE\n#define AA_CLIP_LIMIT 2.0\n#define AA_LINE_WIDTH 16.0\n#define DEVICE_PIXEL_RATIO 1.0\n#define ANTIALIASING 1.0 / DEVICE_PIXEL_RATIO / 2.0\n#define EXTRUDE_SCALE 63.0\n#define EXTRUDE_MOD 64.0\n#define MAX_LINE_DISTANCE 65535.0\n#ifdef PICKING_MODE\n#include <gl2_vert>\n#endif\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY)\nattribute vec3 aExtrude;\n#else\nattribute vec2 aExtrude;\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT) || defined(HAS_TRAIL)\nattribute float aLinesofar;\nvarying highp float vLinesofar;\n#endif\nuniform float cameraToCenterDistance;\n#if defined(HAS_STROKE_WIDTH)\nattribute float aLineStrokeWidth;\n#else\nuniform float lineStrokeWidth;\n#endif\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform mat4 modelMatrix;\nuniform float tileResolution;\nuniform float resolution;\nuniform float tileRatio;\nuniform float isRenderingTerrain;\n#if defined(HAS_LINE_DX) || defined(HAS_LINE_DY)\nattribute vec2 aLineDxDy;\n#endif\n#ifndef HAS_LINE_DX\nuniform float lineDx;\n#endif\n#ifndef HAS_LINE_DY\nuniform float lineDy;\n#endif\nuniform vec2 canvasSize;\nuniform float layerScale;\nvarying vec2 vNormal;\nvarying vec2 vWidth;\nvarying float vGammaScale;\n#ifndef ENABLE_TILE_STENCIL\nvarying vec2 vPosition;\n#endif\n#ifdef USE_LINE_OFFSET\nattribute vec2 aExtrudeOffset;\n#endif\n#ifdef HAS_LINE_WIDTH\nattribute float aLineWidth;\n#else\nuniform float lineWidth;\n#endif\n#ifndef PICKING_MODE\n#ifndef HAS_GRADIENT\n#ifdef HAS_COLOR\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#ifdef HAS_PATTERN\n#if defined(HAS_PATTERN_ANIM) || defined(HAS_PATTERN_GAP)\nattribute vec2 aLinePattern;\n#endif\n#ifdef HAS_PATTERN_ANIM\nvarying float vLinePatternAnimSpeed;\n#endif\n#ifdef HAS_PATTERN_GAP\nvarying float vLinePatternGap;\n#endif\nattribute vec4 aTexInfo;\nvarying vec4 vTexInfo;\n#endif\n#ifdef HAS_DASHARRAY\n#ifdef HAS_DASHARRAY_ATTR\nattribute vec4 aDasharray;\nvarying vec4 vDasharray;\n#endif\n#ifdef HAS_DASHARRAY_COLOR\nattribute vec4 aDashColor;\nvarying vec4 vDashColor;\n#endif\n#endif\n#endif\n#ifdef HAS_STROKE_COLOR\nattribute vec4 aStrokeColor;\nvarying vec4 vStrokeColor;\n#endif\n#ifdef HAS_OPACITY\nattribute float aOpacity;\nvarying float vOpacity;\n#endif\n#ifdef HAS_GRADIENT\nattribute float aGradIndex;\nvarying float vGradIndex;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#include <highlight_vert>\n#else\n#include <fbo_picking_vert>\n#endif\nvarying vec3 vVertex;\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n  float d = mod(abs(aExtrude.x), 2.);\n  float e = mod(abs(aExtrude.y), 2.);\n  vNormal = vec2(d, e * 2. - 1.);\n  vec4 f = vec4(c, 1.);\n  vec4 h = projViewModelMatrix * positionMatrix * f;\n  if(isRenderingTerrain == 1.) {\n    vVertex = (positionMatrix * f).xyz;\n  } else {\n    vVertex = (modelMatrix * positionMatrix * f).xyz;\n  }\n#ifdef HAS_STROKE_WIDTH\nfloat i = aLineStrokeWidth / 2. * layerScale;\n#else\nfloat i = lineStrokeWidth;\n#endif\n#ifdef HAS_LINE_WIDTH\nfloat j = aLineWidth / 2. * layerScale;\n#else\nfloat j = lineWidth * layerScale;\n#endif\nfloat k = j / 2. + i;\n  float l = sign(i) * j / 2.;\n  float m = l + sign(l) * ANTIALIASING;\n  float n = k + sign(k) * ANTIALIASING;\n#ifdef USE_LINE_OFFSET\nvec2 o = lineOffset * (vNormal.y * (aExtrude.xy - aExtrudeOffset) + aExtrudeOffset);\n  vec2 u = (n * aExtrude.xy + o) / EXTRUDE_SCALE;\n#else\nvec2 v = aExtrude.xy / EXTRUDE_SCALE;\n  vec2 u = n * v;\n#endif\nfloat A = tileResolution / resolution;\n  vec4 B = vec4(c + vec3(u, .0) * tileRatio / A, 1.);\n  gl_Position = projViewModelMatrix * positionMatrix * B;\n#ifdef HAS_LINE_DX\nfloat C = aLineDxDy[0];\n#else\nfloat C = lineDx;\n#endif\n#ifdef HAS_LINE_DY\nfloat D = aLineDxDy[1];\n#else\nfloat D = lineDy;\n#endif\nfloat E = gl_Position.w;\n  gl_Position.xy += vec2(C, D) * 2. / canvasSize * E;\n#ifndef PICKING_MODE\nvWidth = vec2(n, m);\n  if(isRenderingTerrain == 1.) {\n    vGammaScale = 1.;\n  } else {\n    vGammaScale = E / cameraToCenterDistance;\n  }\n#ifndef ENABLE_TILE_STENCIL\nvPosition = c.xy;\n#ifdef USE_LINE_OFFSET\nvPosition += tileRatio * o / EXTRUDE_SCALE;\n#endif\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT)\n#ifdef HAS_GRADIENT\nvLinesofar = aLinesofar / MAX_LINE_DISTANCE;\n  vGradIndex = aGradIndex;\n#else\nfloat F = aLinesofar - k * aExtrude.z / EXTRUDE_SCALE / A * tileRatio;\n  vLinesofar = F / tileRatio * A;\n#endif\n#endif\n#ifndef HAS_GRADIENT\n#ifdef HAS_COLOR\nvColor = aColor;\n#endif\n#ifdef HAS_DASHARRAY\n#ifdef HAS_DASHARRAY_ATTR\nvDasharray = aDasharray;\n#endif\n#ifdef HAS_DASHARRAY_COLOR\nvDashColor = aDashColor / 255.;\n#endif\n#endif\n#ifdef HAS_PATTERN\nvTexInfo = vec4(aTexInfo.xy, aTexInfo.zw + 1.);\n#ifdef HAS_PATTERN_ANIM\nvLinePatternAnimSpeed = aLinePattern[0] / 127.;\n#endif\n#ifdef HAS_PATTERN_GAP\nvLinePatternGap = aLinePattern[1] / 10.0;\n#endif\n#endif\n#endif\n#ifdef HAS_STROKE_COLOR\nvStrokeColor = aStrokeColor;\n#endif\n#ifdef HAS_OPACITY\nvOpacity = aOpacity / 255.;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(B);\n#endif\nhighlight_setVarying();\n#else\nfbo_picking_setData(E, true);\n#endif\n}",rH="#define AA_CLIP_LIMIT 2.0\n#define AA_LINE_WIDTH 16.0\n#define DEVICE_PIXEL_RATIO 1.0\n#define ANTIALIASING 1.0 / 1.0 / 2.0\n#define EXTRUDE_SCALE 63.0\n#define EXTRUDE_MOD 64.0\n#define MAX_LINE_DISTANCE 65535.0\nstruct LineUniforms {\n    lineStrokeWidth: f32,\n    positionMatrix: mat4x4f,\n    projViewModelMatrix: mat4x4f,\n    modelMatrix: mat4x4f,\n    tileResolution: f32,\n    tileRatio: f32,\n    lineDx: f32,\n    lineDy: f32,\n    lineWidth: f32\n};\nstruct ShaderUniforms {\n    resolution: f32,\n    cameraToCenterDistance: f32,\n    canvasSize: vec2f,\n    layerScale: f32,\n    isRenderingTerrain: f32,\n}\n@group(0) @binding($b) var<uniform> uniforms: LineUniforms;\n@group(0) @binding($b) var<uniform> shaderUniforms: ShaderUniforms;\nstruct VertexInput {\n#ifdef HAS_ALTITUDE\n    @location($i) aPosition: POSITION_TYPE,\n    @location($i) aAltitude: f32,\n#else\n    @location($i) aPosition: vec4i,\n#endif\n@location($i) aExtrude: vec4i,\n#if HAS_PATTERN || HAS_DASHARRAY || HAS_GRADIENT || HAS_TRAIL\n    @location($i) aLinesofar: LINESOFAR_TYPE,\n#endif\n#ifdef HAS_STROKE_WIDTH\n    @location($i) aLineStrokeWidth: u32,\n#endif\n#if HAS_LINE_DX || HAS_LINE_DY\n    @location($i) aLineDxDy: vec2i,\n#endif\n#ifdef USE_LINE_OFFSET\n    @location($i) aExtrudeOffset: vec2f,\n#endif\n#ifdef HAS_LINE_WIDTH\n    @location($i) aLineWidth: u32,\n#endif\n#ifndef PICKING_MODE\n    #ifndef HAS_GRADIENT\n        #ifdef HAS_COLOR\n            @location($i) aColor: vec4u,\n        #endif\n        #ifdef HAS_PATTERN\n            #if HAS_PATTERN_ANIM || HAS_PATTERN_GAP\n                @location($i) aLinePattern: vec2i,\n            #endif\n                @location($i) aTexInfo: vec4u,\n        #endif\n        #ifdef HAS_DASHARRAY\n            #ifdef HAS_DASHARRAY_ATTR\n                @location($i) aDasharray: vec4u,\n            #endif\n            #ifdef HAS_DASHARRAY_COLOR\n                @location($i) aDashColor: vec4u,\n            #endif\n        #endif\n    #endif\n    #ifdef HAS_STROKE_COLOR\n        @location($i) aStrokeColor: vec4u,\n    #endif\n    #ifdef HAS_OPACITY\n        @location($i) aOpacity: u32,\n    #endif\n    #ifdef HAS_GRADIENT\n        @location($i) aGradIndex: u32,\n    #endif\n#endif\n};\nstruct VertexOutput {\n    @builtin(position) position: vec4f,\n    @location($o) vNormal: vec2f,\n    @location($o) vWidth: vec2f,\n    @location($o) vGammaScale: f32,\n#ifndef ENABLE_TILE_STENCIL\n    @location($o) vPosition: vec2f,\n#endif\n    @location($o) vVertex: vec3f,\n#if HAS_PATTERN || HAS_DASHARRAY || HAS_GRADIENT || HAS_TRAIL\n    @location($o) vLinesofar: f32,\n#endif\n#ifndef PICKING_MODE\n    #ifndef HAS_GRADIENT\n        #ifdef HAS_COLOR\n            @location($o) vColor: vec4f,\n        #endif\n        #ifdef HAS_PATTERN\n            #ifdef HAS_PATTERN_ANIM\n                @location($o) vLinePatternAnimSpeed: f32,\n            #endif\n            #ifdef HAS_PATTERN_GAP\n                @location($o) vLinePatternGap: f32,\n            #endif\n            @location($o) vTexInfo: vec4f,\n        #endif\n        #ifdef HAS_DASHARRAY\n            #ifdef HAS_DASHARRAY_ATTR\n                @location($o) vDasharray: vec4f,\n            #endif\n            #ifdef HAS_DASHARRAY_COLOR\n                @location($o) vDashColor: vec4f,\n            #endif\n        #endif\n    #endif\n    #ifdef HAS_STROKE_COLOR\n        @location($o) vStrokeColor: vec4f,\n    #endif\n    #ifdef HAS_OPACITY\n        @location($o) vOpacity: f32,\n    #endif\n    #ifdef HAS_GRADIENT\n        @location($o) vGradIndex: f32,\n    #endif\n#else\n#endif\n};\n#ifndef PICKING_MODE\n    #if HAS_SHADOWING && !HAS_BLOOM\n        #include <vsm_shadow_vert>\n    #endif\n#else\n    #include <fbo_picking_vert>\n#endif\n#include <highlight_vert>\n#include <vt_position_vert>\n@vertex\nfn main(input: VertexInput) -> VertexOutput {\n    var output: VertexOutput;\n    let position = unpackVTPosition(input);\n    let round = abs(f32(input.aExtrude.x)) % 2.0;\n    let up = abs(f32(input.aExtrude.y)) % 2.0;\n    output.vNormal = vec2f(round, up * 2.0 - 1.0);\n    let pos4 = vec4f(position, 1.0);\n    let vertex = uniforms.projViewModelMatrix * uniforms.positionMatrix * pos4;\n    if (shaderUniforms.isRenderingTerrain == 1.0) {\n        output.vVertex = (uniforms.positionMatrix * pos4).xyz;\n    } else {\n        output.vVertex = (uniforms.modelMatrix * uniforms.positionMatrix * pos4).xyz;\n    }\n#ifdef HAS_STROKE_WIDTH\n    let strokeWidth = f32(input.aLineStrokeWidth) / 2.0 * shaderUniforms.layerScale;\n#else\n    let strokeWidth = uniforms.lineStrokeWidth;\n#endif\n#ifdef HAS_LINE_WIDTH\n    let myLineWidth = f32(input.aLineWidth) / 2.0 * shaderUniforms.layerScale;\n#else\n    let myLineWidth = uniforms.lineWidth * shaderUniforms.layerScale;\n#endif\n    let halfwidth = myLineWidth / 2.0 + strokeWidth;\n    let gapwidth = sign(strokeWidth) * myLineWidth / 2.0;\n    let inset = gapwidth + sign(gapwidth) * ANTIALIASING;\n    var outset = halfwidth + sign(halfwidth) * ANTIALIASING;\n    let extrudeXY = vec2f(input.aExtrude.xy);\n#ifdef USE_LINE_OFFSET\n    let offset = lineOffset * (output.vNormal.y * (extrudeXY - input.aExtrudeOffset) + input.aExtrudeOffset);\n    var dist = (outset * extrudeXY + offset) / EXTRUDE_SCALE;\n#else\n    let extrude = extrudeXY / EXTRUDE_SCALE;\n    var dist = outset * extrude;\n#endif\n    let resScale = uniforms.tileResolution / shaderUniforms.resolution;\n    var localVertex = vec4f(position + vec3f(dist, 0.0) * uniforms.tileRatio / resScale, 1.0);\n    output.position = uniforms.projViewModelMatrix * uniforms.positionMatrix * localVertex;\n#ifdef HAS_LINE_DX\n    let myLineDx = f32(input.aLineDxDy.x);\n#else\n    let myLineDx = uniforms.lineDx;\n#endif\n#ifdef HAS_LINE_DY\n    let myLineDy = f32(input.aLineDxDy.y);\n#else\n    let myLineDy = uniforms.lineDy;\n#endif\n    let projDistance = output.position.w;\n    output.position.x += f32(myLineDx) * 2.0 / shaderUniforms.canvasSize.x * projDistance;\n    output.position.y += f32(myLineDy) * 2.0 / shaderUniforms.canvasSize.y * projDistance;\n#ifndef PICKING_MODE\n    output.vWidth = vec2f(outset, inset);\n    if (shaderUniforms.isRenderingTerrain == 1.0) {\n        output.vGammaScale = 1.0;\n    } else {\n        output.vGammaScale = projDistance / shaderUniforms.cameraToCenterDistance;\n    }\n    #ifndef ENABLE_TILE_STENCIL\n        output.vPosition = position.xy;\n        #ifdef USE_LINE_OFFSET\n            output.vPosition += uniforms.tileRatio * offset / EXTRUDE_SCALE;\n        #endif\n    #endif\n    #if HAS_PATTERN || HAS_DASHARRAY || HAS_GRADIENT\n        #ifdef HAS_GRADIENT\n            output.vLinesofar = input.aLinesofar / MAX_LINE_DISTANCE;\n            output.vGradIndex = f32(input.aGradIndex);\n        #else\n            let linesofar = input.aLinesofar - halfwidth * input.aExtrude.z / EXTRUDE_SCALE / resScale * uniforms.tileRatio;\n            output.vLinesofar = linesofar / uniforms.tileRatio * resScale;\n        #endif\n    #endif\n    #ifndef HAS_GRADIENT\n        #ifdef HAS_COLOR\n            output.vColor = vec4f(input.aColor);\n        #endif\n        #ifdef HAS_DASHARRAY\n            #ifdef HAS_DASHARRAY_ATTR\n                output.vDasharray = vec4f(input.aDasharray);\n            #endif\n            #ifdef HAS_DASHARRAY_COLOR\n                output.vDashColor = vec4f(input.aDashColor) / 255.0;\n            #endif\n        #endif\n        #ifdef HAS_PATTERN\n            output.vTexInfo = vec4f(vec2f(input.aTexInfo.xy), vec2f(input.aTexInfo.zw) + 1.0);\n            #ifdef HAS_PATTERN_ANIM\n                output.vLinePatternAnimSpeed = f32(input.aLinePattern.x) / 127.0;\n            #endif\n            #ifdef HAS_PATTERN_GAP\n                output.vLinePatternGap = f32(input.aLinePattern.y) / 10.0;\n            #endif\n        #endif\n    #endif\n    #ifdef HAS_STROKE_COLOR\n        output.vStrokeColor = vec4f(input.aStrokeColor);\n    #endif\n    #ifdef HAS_OPACITY\n        output.vOpacity = f32(input.aOpacity) / 255.0;\n    #endif\n    #if HAS_SHADOWING && !HAS_BLOOM\n        shadow_computeShadowPars(localVertex);\n    #endif\n    #if HAS_HIGHLIGHT_COLOR || HAS_HIGHLIGHT_OPACITY\n        highlight_setVarying(input, output);\n    #endif\n#else\n    fbo_picking_setData(input, &output, projDistance, true);\n#endif\n    return output;\n}";const iH=AA([]),sH=[];let oH=class $n extends OF{static getBloomSymbol(){return["lineBloom"]}isUniqueStencilRefPerTile(){return!1}prepareSymbol(e){const t=e.lineColor;Array.isArray(t)&&(3===t.length&&t.push(1),e.lineColor=t.map((e=>255*e)));const n=e.lineStrokeColor;Array.isArray(n)&&(3===n.length&&n.push(1),e.lineStrokeColor=n.map((e=>255*e)));const i=e.lineDashColor;Array.isArray(i)&&(3===i.length&&i.push(1),e.lineDashColor=i.map((e=>255*e)))}isAnimating(){if(this._hasPatternAnim)return!0;const e=this.getSymbols(),t=this.sceneConfig.trailAnimation;if(t&&t.enable)return!0;for(let t=0;t<e.length;t++)if(e[t].linePatternFile&&e[t].linePatternAnimSpeed)return!0;return!1}needToRedraw(){return!!super.needToRedraw()||!!this.isAnimating()}isBloom(e){return!!this.getSymbol(e.properties.symbolIndex)[$n.getBloomSymbol()[0]]}needPolygonOffset(){return!0}createMesh(e,t){if(!e.geometry)return null;const{geometry:n,symbolIndex:i,ref:s}=e,o=this.getSymbolDef(i);void 0===s&&VD(n,o,this.getFnTypeConfig(i),this.layer);const a=this.getSymbol(i),l={tileResolution:n.properties.tileResolution,tileRatio:n.properties.tileRatio,tileExtent:n.properties.tileExtent};this.setLineUniforms(a,l),ZL(l,"lineColor",a,"lineColor","#fff",JL(this.colorCache)),ZL(l,"linePatterGapColor",a,"linePatterGapColor",[0,0,0,0],JL(this.colorCache)),ZL(l,"lineStrokeColor",a,"lineStrokeColor",[0,0,0,0],JL(this.colorCache)),ZL(l,"lineDasharray",a,"lineDasharray",[0,0,0,0],(e=>{let t;if(e&&e.length){1===e.length?t=[e[0],e[0],e[0],e[0]]:2===e.length?t=[e[0],e[1],e[0],e[1]]:3===e.length?t=[e[0],e[1],e[2],e[2]]:4===e.length?t=e:e.length>4&&(t=e.slice(0,4))}return t||[0,0,0,0]})),ZL(l,"lineDashColor",a,"lineDashColor",[0,0,0,0],JL(this.colorCache));const h=n.properties.iconAtlas,c=this.layer instanceof Up;h&&(l.linePatternFile=RF(this.regl,h,!1,!1),l.atlasSize=h?[h.width,h.height]:[0,0],l.flipY=c?-1:1,this.drawDebugAtlas(h)),void 0===s&&n.generateBuffers(this.regl);const u=new CM.Material(l),f=new CM.Mesh(n,u,{castShadow:!1,picking:!0});f.setLocalTransform(t),f.positionMatrix=this.getAltitudeOffsetMatrix();const g={};return h&&(g.HAS_PATTERN=1),f.properties.symbolIndex=i,this._prepareDashDefines(f,g),n.data.aColor&&(g.HAS_COLOR=1),n.data.aStrokeColor&&(g.HAS_STROKE_COLOR=1),this.setMeshDefines(g,n,o),n.data.aAltitude&&(g.HAS_ALTITUDE=1),f.setDefines(g),f}addMesh(...e){delete this._hasPatternAnim;const t=e[0];Array.isArray(t)?t.forEach((e=>{this._prepareMesh(e)})):this._prepareMesh(t),super.addMesh(...e)}_prepareMesh(e){if(!e.geometry.aLineWidth&&e.material.get("lineWidth")<=0||!e.geometry.aOpacity&&e.material.get("lineOpacity")<=0)return;const t=e.defines;this._prepareDashDefines(e,t),e.setDefines(t),e.geometry.properties.hasPatternAnim&&(this._hasPatternAnim=1)}_prepareDashDefines(e,t){const n=e.geometry,i=this.getSymbol(e.properties.symbolIndex);n.data.aDasharray||Array.isArray(i.lineDasharray)&&i.lineDasharray.reduce(((e,t)=>e+t),0)>0?(t.HAS_DASHARRAY=1,n.data.aDasharray&&(t.HAS_DASHARRAY_ATTR=1),n.data.aDashColor&&(t.HAS_DASHARRAY_COLOR=1)):t.HAS_DASHARRAY&&delete t.HAS_DASHARRAY}setLineUniforms(e,t){ZL(t,"lineWidth",e,"lineWidth",2),ZL(t,"lineOpacity",e,"lineOpacity",1),ZL(t,"lineStrokeWidth",e,"lineStrokeWidth",0),ZL(t,"lineBlur",e,"lineBlur",.7),ZL(t,"lineOffset",e,"lineOffset",0),ZL(t,"lineDx",e,"lineDx",0),ZL(t,"lineDy",e,"lineDy",0),ZL(t,"linePatternAnimSpeed",e,"linePatternAnimSpeed",0),ZL(t,"linePatternGap",e,"linePatternGap",0)}setMeshDefines(e,t,n){t.data.aOpacity&&(e.HAS_OPACITY=1),t.data.aLineWidth&&(e.HAS_LINE_WIDTH=1),t.data.aLineStrokeWidth&&(e.HAS_STROKE_WIDTH=1),eF(n.lineDx)&&(e.HAS_LINE_DX=1),eF(n.lineDy)&&(e.HAS_LINE_DY=1),eF(n.linePatternAnimSpeed)&&(e.HAS_PATTERN_ANIM=1),eF(n.linePatternGap)&&(e.HAS_PATTERN_GAP=1)}paint(e){this.isShadowIncludeChanged(e)&&(this.shader.dispose(),this.createShader(e)),super.paint(e)}createFnTypeConfig(e,t){const n=PE(t.lineColor),i=PE(t.aLinePatternAnimSpeed),s=PE(t.aLinePatternGap),o=this.createShapeFnTypeConfigs(e,t),a=new Int8Array(2);return[{attrName:"aColor",symbolName:"lineColor",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(t,i)=>{let s=n(e.getZoom(),t);return SE(s)&&(s=this.evaluateInFnTypeConfig(s,i,e,t,!0)),Array.isArray(s)||(s=this.colorCache[s]=this.colorCache[s]||oE(s).unitArray()),s=YL(s),s}},{attrName:"aLinePattern",symbolName:"linePatternAnimSpeed",type:Int8Array,width:2,related:["linePatternGap"],define:"HAS_LINE_PATTERN",evaluate:(t,n,s,o)=>{let l=i(e.getZoom(),t);return WL(l)&&(l=0),0!==l&&(n.properties.hasPatternAnim=1),a[0]=l/127,a[1]=s[o+1],a}},{attrName:"aLinePattern",symbolName:"linePatternGap",type:Int8Array,width:2,related:["linePatternAnimSpeed"],define:"HAS_LINE_PATTERN",evaluate:(t,n,i,o)=>{let l=s(e.getZoom(),t);return WL(l)&&(l=0),a[1]=10*l,a[0]=i[o],a}}].concat(o)}createShapeFnTypeConfigs(e,t){const n=CE(t.lineWidth),i=CE(t.lineOpacity),s=CE(t.lineStrokeWidth),o=CE(t.lineDx),a=CE(t.lineDy),l=new Uint16Array(1),h=new Int8Array(1);return[{attrName:"aLineWidth",symbolName:"lineWidth",type:Uint8Array,width:1,define:"HAS_LINE_WIDTH",evaluate:(t,i)=>{let s=n(e.getZoom(),t);return SE(s)&&(s=this.evaluateInFnTypeConfig(s,i,e,t)),l[0]=Math.round(2*s),l[0]}},{attrName:"aLineStrokeWidth",symbolName:"lineStrokeWidth",type:Uint8Array,width:1,define:"HAS_STROKE_WIDTH",evaluate:t=>{const n=s(e.getZoom(),t);return l[0]=Math.round(2*n),l[0]}},{attrName:"aLineDxDy",symbolName:"lineDx",type:Int8Array,width:2,index:0,define:"HAS_LINE_DX",evaluate:t=>{const n=o(e.getZoom(),t);return h[0]=n,h[0]}},{attrName:"aLineDxDy",symbolName:"lineDy",type:Int8Array,width:2,index:1,define:"HAS_LINE_DY",evaluate:t=>{const n=a(e.getZoom(),t);return h[0]=n,h[0]}},{attrName:"aOpacity",symbolName:"lineOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(t,n)=>{let s=i(e.getZoom(),t);return SE(s)&&(s=this.evaluateInFnTypeConfig(s,n,e,t)),l[0]=255*s,l[0]}}]}updateSceneConfig(e){e.trailAnimation&&this.createShader(this._context)}init(e){if(this.renderer=new CM.Renderer(this.regl),this.createShader(e),this.pickingFBO){const e=this.layer instanceof Up;this.picking=[new CM.FBORayPicking(this.renderer,{name:"line-picking",vert:nH,wgslVert:`#define POSITION_TYPE ${e?"vec2i":"vec2f"}\n#define LINESOFAR_TYPE ${e?"u32":"f32"}\n`+rH,defines:{PICKING_MODE:1},uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,t){const n=[];return vA(n,t.projViewMatrix,t.modelMatrix),n}}],extraCommandProps:this.getExtraCommandProps()},this.pickingFBO,this.getMap())]}}createShader(e){this._context=e;const t=[],n={};this.fillIncludes(n,t,e),this.sceneConfig.trailAnimation&&this.sceneConfig.trailAnimation.enable&&(n.HAS_TRAIL=1);const i=[];t.push({name:"projViewModelMatrix",type:"function",fn:function(e,t){return vA(i,t.projViewMatrix,t.modelMatrix),i}});const s=this.layer instanceof Up;this.shader=new CM.MeshShader({name:"vt-line",vert:nH,frag:"#define SHADER_NAME LINE\n#define DEVICE_PIXEL_RATIO 1.0\nprecision highp float;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\nuniform lowp float blendSrcIsOne;\nuniform lowp float lineBlur;\nuniform float isRenderingTerrain;\n#ifdef HAS_COLOR\nvarying vec4 vColor;\n#else\nuniform lowp vec4 lineColor;\n#endif\n#include <highlight_frag>\n#ifdef HAS_STROKE_COLOR\nvarying vec4 vStrokeColor;\n#else\nuniform lowp vec4 lineStrokeColor;\n#endif\n#ifdef HAS_OPACITY\nvarying float vOpacity;\n#else\nuniform lowp float lineOpacity;\n#endif\nuniform float layerOpacity;\n#ifdef HAS_PATTERN\nuniform sampler2D linePatternFile;\nuniform vec2 atlasSize;\nuniform float flipY;\n#ifdef HAS_PATTERN_ANIM\nvarying float vLinePatternAnimSpeed;\n#else\nuniform float linePatternAnimSpeed;\n#endif\n#ifdef HAS_PATTERN_GAP\nvarying float vLinePatternGap;\n#else\nuniform float linePatternGap;\n#endif\nuniform vec4 linePatterGapColor;\nvarying vec4 vTexInfo;\nvec2 c(vec2 d) {\n  vec2 e = mod(d, 1.);\n  vec2 f = vTexInfo.xy;\n  vec2 h = vTexInfo.zw;\n  return (f + e * h) / atlasSize;\n}\n#endif\nvarying vec2 vNormal;\nvarying vec2 vWidth;\nvarying float vGammaScale;\n#ifndef ENABLE_TILE_STENCIL\nvarying vec2 vPosition;\n#endif\nuniform float tileExtent;\n#ifdef HAS_DASHARRAY\n#ifdef HAS_DASHARRAY_ATTR\nvarying vec4 vDasharray;\n#else\nuniform vec4 lineDasharray;\n#endif\n#ifdef HAS_DASHARRAY_COLOR\nvarying vec4 vDashColor;\n#else\nuniform vec4 lineDashColor;\n#endif\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT) || defined(HAS_TRAIL)\nvarying highp float vLinesofar;\n#endif\n#ifdef HAS_TRAIL\nuniform float trailSpeed;\nuniform float trailLength;\nuniform float trailCircle;\n#endif\n#if defined(HAS_TRAIL) || defined(HAS_PATTERN)\nuniform float currentTime;\n#endif\nfloat i(float j, float k) {\n  float l = k / 2.;\n  float m = abs(j - l);\n  float n = (.1 + 1. / DEVICE_PIXEL_RATIO) * vGammaScale;\n  return clamp(min(m + n, l - m) / n, .0, 1.);\n}\nvarying vec3 vVertex;\nuniform vec3 cameraPosition;\nuniform float cameraToCenterDistance;\nuniform float fogFactor;\nvoid main() {\n  \n#ifndef ENABLE_TILE_STENCIL\nfloat o = sign(tileExtent - min(tileExtent, abs(vPosition.x))) * sign(1. + sign(vPosition.x)) * sign(tileExtent - min(tileExtent, abs(vPosition.y))) * sign(1. + sign(vPosition.y));\n  if(o == .0) {\n    discard;\n  }\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT) || defined(HAS_TRAIL)\nfloat u = vLinesofar;\n#endif\nfloat v = length(vNormal) * vWidth.s;\n#ifdef HAS_PATTERN\nvec2 h = vTexInfo.zw;\n  float A = sign(h.x * h.y);\n  float B = mix(lineBlur, .0, A);\n#else\nfloat B = lineBlur;\n#endif\nfloat n = (B + 1. / DEVICE_PIXEL_RATIO) * vGammaScale;\n  float C = clamp(min(v - (vWidth.t - n), vWidth.s - v) / n, .0, 1.);\n#ifdef HAS_COLOR\nvec4 D = vColor / 255.;\n#else\nvec4 D = lineColor;\n#endif\n#ifdef HAS_PATTERN\nif(A == 1.) {\n    \n#ifdef HAS_PATTERN_GAP\nfloat E = vLinePatternGap;\n#else\nfloat E = linePatternGap;\n#endif\n#ifdef HAS_PATTERN_ANIM\nfloat F = vLinePatternAnimSpeed;\n#else\nfloat F = linePatternAnimSpeed;\n#endif\nfloat G = h.x * vWidth.s * 2. / h.y;\n    float H = G * (1. + E);\n    u += mod(currentTime * -F * .2, H);\n    float I = mod(u / H, 1.);\n    float J = mod((flipY * vNormal.y + 1.) / 2., 1.);\n    vec4 K = texture2D(linePatternFile, c(vec2(I * (1. + E), J)));\n    float L = clamp(sign(1. / (1. + E) - I) + .000001, .0, 1.);\n    K = mix(linePatterGapColor, K, L);\n    D *= K;\n  }\n#endif\n#ifdef HAS_DASHARRAY\n#ifdef HAS_DASHARRAY_ATTR\nvec4 M = vDasharray;\n#else\nvec4 M = lineDasharray;\n#endif\n#ifdef HAS_DASHARRAY_COLOR\nvec4 N = vDashColor;\n#else\nvec4 N = lineDashColor;\n#endif\nfloat k = M[0] + M[1] + M[2] + M[3];\n  float j = mod(u, k);\n  float O = max(sign(M[0] - j), .0);\n  float P = j - M[0] - M[1];\n  float Q = max(sign(P), .0) * max(sign(M[2] - P), .0);\n  float R = O + Q;\n  float S = i(j, M[0]);\n  float T = i(P, M[2]);\n  float U = S * O + T * Q;\n  D = D * (1. - U) + N * U;\n#endif\n#ifdef HAS_STROKE_COLOR\nvec4 V = vStrokeColor / 255.;\n#else\nvec4 V = lineStrokeColor;\n#endif\nV = mix(D, V, sign(vWidth.t));\n  D = V * C + max(sign(vWidth.t - v), .0) * D * (1. - C);\n#ifdef HAS_TRAIL\nfloat W = mod(u - currentTime * trailSpeed * .1, trailCircle);\n  float X = W < trailLength ? mix(.0, 1., W / trailLength) : .0;\n  D *= X;\n#endif\n#ifdef HAS_OPACITY\nfloat Y = vOpacity;\n#else\nfloat Y = lineOpacity;\n#endif\ngl_FragColor = D * Y * layerOpacity;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat Z = shadow_computeShadow();\n  gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, Z);\n#endif\nfloat ba;\n  if(isRenderingTerrain == 1.) {\n    ba = 1.;\n  } else {\n    ba = clamp(cameraToCenterDistance * 1.5 / distance(vVertex, cameraPosition), .0, 1.);\n  }\n  gl_FragColor *= ba;\n  gl_FragColor = highlight_blendColor(gl_FragColor);\n  if(fogFactor > .0) {\n    vec3 bb = vec3(vVertex[0] - cameraPosition[0], vVertex[1] - cameraPosition[1], vVertex[2] - cameraPosition[2]);\n    float bc = length(bb);\n    float bd = clamp(1. - (bc * 1.2) / fogFactor, .0, 1.);\n    gl_FragColor *= bd;\n  }\n}",wgslVert:`#define POSITION_TYPE ${s?"vec2i":"vec2f"}\n#define LINESOFAR_TYPE ${s?"u32":"f32"}\n`+rH,wgslFrag:"#define DEVICE_PIXEL_RATIO 1.0\n#if HAS_SHADOWING && !HAS_BLOOM\n    #include <vsm_shadow_frag>\n#endif\nstruct LineFragmentUniforms {\n    lineBlur: f32,\n    lineColor: vec4f,\n    lineStrokeColor: vec4f,\n    lineOpacity: f32,\n    tileExtent: f32,\n    lineDasharray: vec4f,\n    lineDashColor: vec4f,\n    #ifdef HAS_PATTERN\n        atlasSize: vec2f,\n        flipY: f32,\n        linePatternAnimSpeed: f32,\n        linePatternGap: f32,\n        linePatterGapColor: vec4f,\n    #endif\n}\nstruct ShaderUniforms {\n    layerOpacity: f32,\n    isRenderingTerrain: f32,\n    trailSpeed: f32,\n    trailLength: f32,\n    trailCircle: f32,\n    currentTime: f32,\n    cameraPosition: vec3f,\n    cameraToCenterDistance: f32,\n    fogFactor: f32\n}\n@group(0) @binding($b) var<uniform> uniforms: LineFragmentUniforms;\n@group(0) @binding($b) var<uniform> shaderUniforms: ShaderUniforms;\n#ifdef HAS_PATTERN\n    @group(0) @binding($b) var linePatternFile: texture_2d<f32>;\n    @group(0) @binding($b) var linePatternFileSampler: sampler;\n#endif\nstruct VertexOutput {\n    @location($i) vNormal: vec2f,\n    @location($i) vWidth: vec2f,\n    @location($i) vGammaScale: f32,\n#ifndef ENABLE_TILE_STENCIL\n    @location($i) vPosition: vec2f,\n#endif\n    @location($i) vVertex: vec3f,\n#if HAS_PATTERN || HAS_DASHARRAY || HAS_GRADIENT || HAS_TRAIL\n    @location($i) vLinesofar: f32,\n#endif\n#ifndef HAS_GRADIENT\n    #ifdef HAS_COLOR\n        @location($i) vColor: vec4f,\n    #endif\n    #ifdef HAS_PATTERN\n        #ifdef HAS_PATTERN_ANIM\n            @location($i) vLinePatternAnimSpeed: f32,\n        #endif\n        #ifdef HAS_PATTERN_GAP\n            @location($i) vLinePatternGap: f32,\n        #endif\n        @location($i) vTexInfo: vec4f,\n    #endif\n    #ifdef HAS_DASHARRAY\n        #ifdef HAS_DASHARRAY_ATTR\n            @location($i) vDasharray: vec4f,\n        #endif\n        #ifdef HAS_DASHARRAY_COLOR\n            @location($i) vDashColor: vec4f,\n        #endif\n    #endif\n#endif\n#ifdef HAS_STROKE_COLOR\n    @location($i) vStrokeColor: vec4f,\n#endif\n#ifdef HAS_OPACITY\n    @location($i) vOpacity: f32,\n#endif\n#ifdef HAS_GRADIENT\n    @location($i) vGradIndex: f32,\n#endif\n};\n#include <highlight_frag>\n#if HAS_SHADOWING && !HAS_BLOOM\n    #include <vsm_shadow_frag>\n#endif\n#ifdef HAS_PATTERN\nfn computeUV(texCoord: vec2f) -> vec2f {\n    let uv = texCoord % 1.0;\n    let uvStart = input.vTexInfo.xy;\n    let uvSize = input.vTexInfo.zw;\n    return (uvStart + uv * uvSize) / uniforms.atlasSize;\n}\n#endif\nfn dashAntialias(input: VertexOutput, dashMod: f32, dashWidth: f32) -> f32 {\n    let dashHalf = dashWidth / 2.0;\n    let dashDist = abs(dashMod - dashHalf);\n    let blur2 = (0.1 + 1.0 / DEVICE_PIXEL_RATIO) * input.vGammaScale;\n    return clamp(min(dashDist + blur2, dashHalf - dashDist) / blur2, 0.0, 1.0);\n}\n@fragment\nfn main(input: VertexOutput) -> @location(0) vec4f {\n    #ifndef ENABLE_TILE_STENCIL\n        let clip = sign(uniforms.tileExtent - min(uniforms.tileExtent, abs(input.vPosition.x))) *\n            sign(1.0 + sign(input.vPosition.x)) *\n            sign(uniforms.tileExtent - min(uniforms.tileExtent, abs(input.vPosition.y))) *\n            sign(1.0 + sign(input.vPosition.y));\n        if (clip == 0.0) {\n            discard;\n        }\n    #endif\n    #if HAS_PATTERN || HAS_DASHARRAY || HAS_GRADIENT || HAS_TRAIL\n        let linesofar = input.vLinesofar;\n    #endif\n    let dist = length(input.vNormal) * input.vWidth.x;\n    #ifdef HAS_PATTERN\n        let uvSize = input.vTexInfo.zw;\n        let hasPattern = sign(uvSize.x * uvSize.y);\n        let blur = mix(uniforms.lineBlur, 0.0, hasPattern);\n    #else\n        let blur = uniforms.lineBlur;\n    #endif\n    let blur2 = (blur + 1.0 / DEVICE_PIXEL_RATIO) * input.vGammaScale;\n    let alpha = clamp(min(dist - (input.vWidth.y - blur2), input.vWidth.x - dist) / blur2, 0.0, 1.0);\n    #ifdef HAS_COLOR\n        var color = input.vColor / 255.0;\n    #else\n        var color = uniforms.lineColor;\n    #endif\n    #ifdef HAS_PATTERN\n        if (hasPattern == 1.0) {\n            #ifdef HAS_PATTERN_GAP\n                let myGap = input.vLinePatternGap;\n            #else\n                let myGap = uniforms.linePatternGap;\n            #endif\n            #ifdef HAS_PATTERN_ANIM\n                let myAnimSpeed = input.vLinePatternAnimSpeed;\n            #else\n                let myAnimSpeed = uniforms.linePatternAnimSpeed;\n            #endif\n            let patternWidth = uvSize.x * input.vWidth.x * 2.0 / uvSize.y;\n            let plusGapWidth = patternWidth * (1.0 + myGap);\n            let animatedLinesofar = linesofar + ((shaderUniforms.currentTime * -myAnimSpeed * 0.2) % plusGapWidth);\n            let patternx = (animatedLinesofar / plusGapWidth) % 1.0;\n            let patterny = ((uniforms.flipY * input.vNormal.y + 1.0) / 2.0) % 1.0;\n            let patternColor = textureSample(\n                linePatternFile,\n                linePatternFileSampler,\n                computeUV(vec2f(patternx * (1.0 + myGap), patterny))\n            );\n            let inGap = clamp(sign(1.0 / (1.0 + myGap) - patternx) + 0.000001, 0.0, 1.0);\n            let finalPatternColor = mix(uniforms.linePatterGapColor, patternColor, inGap);\n            color *= finalPatternColor;\n        }\n    #endif\n    #ifdef HAS_DASHARRAY\n        #ifdef HAS_DASHARRAY_ATTR\n            let dasharray = input.vDasharray;\n        #else\n            let dasharray = uniforms.lineDasharray;\n        #endif\n        #ifdef HAS_DASHARRAY_COLOR\n            let dashColor = input.vDashColor;\n        #else\n            let dashColor = uniforms.lineDashColor;\n        #endif\n        let dashWidth = dasharray[0] + dasharray[1] + dasharray[2] + dasharray[3];\n        let dashMod = linesofar % dashWidth;\n        let firstInDash = max(sign(dasharray[0] - dashMod), 0.0);\n        let secondDashMod = dashMod - dasharray[0] - dasharray[1];\n        let secondInDash = max(sign(secondDashMod), 0.0) * max(sign(dasharray[2] - secondDashMod), 0.0);\n        let isInDash = firstInDash + secondInDash;\n        let firstDashAlpha = dashAntialias(input, dashMod, dasharray[0]);\n        let secondDashAlpha = dashAntialias(input, secondDashMod, dasharray[2]);\n        let dashAlpha = firstDashAlpha * firstInDash + secondDashAlpha * secondInDash;\n        color = color * (1.0 - dashAlpha) + dashColor * dashAlpha;\n    #endif\n    #ifdef HAS_STROKE_COLOR\n        var strokeColor = input.vStrokeColor / 255.0;\n    #else\n        var strokeColor = uniforms.lineStrokeColor;\n    #endif\n    strokeColor = mix(color, strokeColor, sign(input.vWidth.y));\n    color = strokeColor * alpha + max(sign(input.vWidth.y - dist), 0.0) * color * (1.0 - alpha);\n    #ifdef HAS_TRAIL\n        let trailMod = (linesofar - shaderUniforms.currentTime * shaderUniforms.trailSpeed * 0.1) % shaderUniforms.trailCircle;\n        let trailAlpha = select(0.0, mix(0.0, 1.0, trailMod / shaderUniforms.trailLength), trailMod < shaderUniforms.trailLength);\n        color *= trailAlpha;\n    #endif\n    #ifdef HAS_OPACITY\n        let opacity = input.vOpacity;\n    #else\n        let opacity = uniforms.lineOpacity;\n    #endif\n    var fragColor = color * opacity * shaderUniforms.layerOpacity;\n    #if HAS_SHADOWING && !HAS_BLOOM\n        let shadowCoeff = shadow_computeShadow();\n        fragColor.rgb = shadow_blend(fragColor.rgb, shadowCoeff);\n    #endif\n    let cameraPosition = shaderUniforms.cameraPosition;\n    let perspectiveAlpha = select(\n        clamp(shaderUniforms.cameraToCenterDistance * 1.5 / distance(input.vVertex, cameraPosition), 0.0, 1.0),\n        1.0,\n        shaderUniforms.isRenderingTerrain == 1.0\n    );\n    fragColor *= perspectiveAlpha;\n    #if HAS_HIGHLIGHT_COLOR || HAS_HIGHLIGHT_OPACITY\n    fragColor = highlight_blendColor(fragColor, input);\n    #endif\n    if (shaderUniforms.fogFactor > 0.0) {\n        let dir = vec3f(input.vVertex.x - cameraPosition.x, input.vVertex.y - cameraPosition.y, input.vVertex.z - cameraPosition.z);\n        let fog_dist = length(dir);\n        let fog_alpha = clamp(1.0 - (fog_dist * 1.2) / shaderUniforms.fogFactor, 0.0, 1.0);\n        fragColor *= fog_alpha;\n    }\n    return fragColor;\n}",uniforms:t,defines:n,extraCommandProps:this.getExtraCommandProps(e)})}isEnableTileStencil(e){return!(e&&e.isRenderingTerrain&&this.isTerrainSkin())}getExtraCommandProps(){const e=this.canvas;return{viewport:{x:(e,t)=>t.viewport?t.viewport.x:0,y:(e,t)=>t.viewport?t.viewport.y:0,width:(t,n)=>n.viewport?n.viewport.width:e?e.width:1,height:(t,n)=>n.viewport?n.viewport.height:e?e.height:1},stencil:{enable:(e,t)=>this.isEnableTileStencil(t.painterContext),func:{cmp:()=>"<=",ref:(e,t)=>t.stencilRef},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],mask:this.sceneConfig.depthMask||!1,func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}limitMeshDefines(e){let t=e.defines;t=function(e,t){return BF(e,t,VF,jF,2)}(this.regl,t),e.setDefines(t)}getUniformValues(e,t){const n=t&&t.isRenderingTerrainSkin,i=this.layer.getTileSize().width,s=n?iH:e.projViewMatrix,o=e.viewMatrix,a=e.cameraToCenterDistance,l=e.getResolution(),h=U_(sH,e.width,e.height);n&&U_(h,i,i);const c=this.getBlendFunc().src(),u=this.sceneConfig.trailAnimation||{},f={layerScale:this.layer.options.styleScale||1,projViewMatrix:s,viewMatrix:o,cameraToCenterDistance:a,resolution:l,canvasSize:h,trailSpeed:u.speed||1,trailLength:u.trailLength||500,trailCircle:u.trailCircle||1e3,currentTime:this.layer.getRenderer().getFrameTimestamp()||0,blendSrcIsOne:+!(1!==c&&"one"!==c),cameraPosition:e.cameraPosition,viewport:n&&t&&t.viewport,isRenderingTerrain:+!!n,fogFactor:this.layer.options.fogFactor||0};return this.setIncludeUniformValues(f,t),f}};const aH={markerFile:{type:"identity",default:null,property:"_symbol_markerFile"},markerWidth:{type:"identity",default:null,property:"_symbol_markerWidth"},markerHeight:{type:"identity",default:null,property:"_symbol_markerHeight"},markerPathWidth:{type:"identity",default:20,property:"_symbol_markerPathWidth"},markerPathHeight:{type:"identity",default:20,property:"_symbol_markerPathHeight"},markerDx:{type:"identity",default:null,property:"_symbol_markerDx"},markerDy:{type:"identity",default:null,property:"_symbol_markerDy"},markerType:{type:"identity",default:null,property:"_symbol_markerType"},markerPath:{type:"identity",default:null,property:"_symbol_markerPath"},markerFill:{type:"identity",default:null,property:"_symbol_markerFill"},markerFillPatternFile:{type:"identity",default:null,property:"_symbol_markerFillPatternFile"},markerFillOpacity:{type:"identity",default:null,property:"_symbol_markerFillOpacity"},markerLineColor:{type:"identity",default:null,property:"_symbol_markerLineColor"},markerLineWidth:{type:"identity",default:null,property:"_symbol_markerLineWidth"},markerLineOpacity:{type:"identity",default:null,property:"_symbol_markerLineOpacity"},markerLineDasharray:{type:"identity",default:null,property:"_symbol_markerLineDasharray"},markerLinePatternFile:{type:"identity",default:null,property:"_symbol_markerLinePatternFile"},markerVerticalAlignment:{type:"identity",default:"top",property:"_symbol_markerVerticalAlignment"},markerHorizontalAlignment:{type:"identity",default:"middle",property:"_symbol_markerHorizontalAlignment"},markerOpacity:{type:"identity",default:1,property:"_symbol_markerOpacity"},markerPitchAlignment:{type:"identity",default:"viewport",property:"_symbol_markerPitchAlignment"},markerRotationAlignment:{type:"identity",default:"viewport",property:"_symbol_markerRotationAlignment"},markerRotation:{type:"identity",default:0,property:"_symbol_markerRotation"},markerAllowOverlap:{type:"identity",default:0,property:"_symbol_markerAllowOverlap"},markerIgnorePlacement:{type:"identity",default:0,property:"_symbol_markerIgnorePlacement"},markerTextFit:{type:"identity",default:null,property:"_symbol_markerTextFit"},markerSpacing:{type:"identity",default:250,property:"_symbol_markerSpacing"},markerTextFitPadding:{type:"identity",default:null,property:"_symbol_markerTextFitPadding"},markerPlacement:{type:"identity",default:"point",property:"_symbol_markerPlacement"}},lH={textName:{type:"identity",default:null,property:"_symbol_textName"},textFaceName:{type:"identity",default:null,property:"_symbol_textFaceName"},textWrapWidth:{type:"identity",default:null,property:"_symbol_textWrapWidth"},textHorizontalAlignment:{type:"identity",default:null,property:"_symbol_textHorizontalAlignment"},textVerticalAlignment:{type:"identity",default:null,property:"_symbol_textVerticalAlignment"},textFill:{type:"identity",default:null,property:"_symbol_textFill"},textSize:{type:"identity",default:null,property:"_symbol_textSize"},textHaloRadius:{type:"identity",default:null,property:"_symbol_textHaloRadius"},textHaloFill:{type:"identity",default:null,property:"_symbol_textHaloFill"},textHaloOpacity:{type:"identity",default:255,property:"_symbol_textHaloOpacity"},textDx:{type:"identity",default:0,property:"_symbol_textDx"},textDy:{type:"identity",default:0,property:"_symbol_textDy"},textOpacity:{type:"identity",default:1,property:"_symbol_textOpacity"},textPitchAlignment:{type:"identity",default:"viewport",property:"_symbol_textPitchAlignment"},textRotationAlignment:{type:"identity",default:"viewport",property:"_symbol_textRotationAlignment"},textRotation:{type:"identity",default:0,property:"_symbol_textRotation"},textAllowOverlap:{type:"identity",default:0,property:"_symbol_textAllowOverlap"},textIgnorePlacement:{type:"identity",default:0,property:"_symbol_textIgnorePlacement"},textSpacing:{type:"identity",default:250,property:"_symbol_textSpacing"},textPlacement:{type:"identity",default:"point",property:"_symbol_textPlacement"}},hH={lineWidth:{type:"identity",default:2,property:"_symbol_lineWidth"},lineStrokeWidth:{type:"identity",default:0,property:"_symbol_lineStrokeWidth"},lineColor:{type:"identity",default:[1,1,1,1],property:"_symbol_lineColor"},lineStrokeColor:{type:"identity",default:[0,0,0,0],property:"_symbol_lineStrokeColor"},lineDx:{type:"identity",default:0,property:"_symbol_lineDx"},lineDy:{type:"identity",default:0,property:"_symbol_lineDy"},linePatternFile:{type:"identity",default:null,property:"_symbol_linePatternFile"},linePatternAnimSpeed:{type:"identity",default:0,property:"_symbol_linePatternAnimSpeed"},linePatternGap:{type:"identity",default:0,property:"_symbol_linePatternGap"},lineOpacity:{type:"identity",default:1,property:"_symbol_lineOpacity"},lineJoin:{type:"identity",default:null,property:"_symbol_lineJoin"},lineCap:{type:"identity",default:null,property:"_symbol_lineCap"},lineDasharray:{type:"identity",default:null,property:"_symbol_lineDasharray"},lineDashColor:{type:"identity",default:null,property:"_symbol_lineDashColor"}},cH="_line_gradient_property",{PackUtil:uH}=eL(),fH=new Re(0,0),dH="_vector3dlayer_id",pH=(cH+"").trim();function gH(e,t,n){const i=(OL+"").trim(),s=e.getMap(),o=s.getGLRes();let a=e.getCoordinates();const l=[],h=[];let c=1;if(e instanceof mf||e instanceof Tf){e instanceof mf&&(a=[a]);for(let e=0;e<a.length;e++)s.coordToPointAtRes(a[e],o,fH),l.push([fH.x,fH.y,a[e].z||0]),h.push([a[e].x,a[e].y])}else if(e instanceof yf||e instanceof Mf){c=2,e instanceof yf&&(a=[a]);for(let e=0;e<a.length;e++){l[e]=[],h[e]=[];for(let t=0;t<a[e].length;t++)s.coordToPointAtRes(a[e][t],o,fH),l[e].push([fH.x,fH.y,a[e][t].z||0]),h[e].push([a[e][t].x,a[e][t].y])}}else if(e instanceof df||e instanceof Cf){c=3,e instanceof Lf||e instanceof Hf||e instanceof Ff||e instanceof Nf?a=[[e.getShell()]]:e instanceof df&&(a=[a]);let t=0;for(let e=0;e<a.length;e++){let n=!1;for(let i=0;i<a[e].length;i++){if(l[t]=[],h[t]=[],n)for(let n=a[e][i].length-1;n>=0;n--)s.coordToPointAtRes(a[e][i][n],o,fH),l[t].push([fH.x,fH.y,a[e][i][n].z||0]),h[t].push([a[e][i][n].x,a[e][i][n].y]);else for(let n=0;n<a[e][i].length;n++)s.coordToPointAtRes(a[e][i][n],o,fH),l[t].push([fH.x,fH.y,a[e][i][n].z||0]),h[t].push([a[e][i][n].x,a[e][i][n].y]);0===i&&(n=uH.calculateSignedArea(l[t])<0,n&&(l[t]=l[t].reverse(),h[t]=h[t].reverse())),t++}}}const u=e.getProperties()?Object.assign({},e.getProperties()):{},f=e._getInternalSymbol()||function(e){return e instanceof mf||e instanceof Tf?{markerType:"ellipse",markerWidth:8,markerHeight:0,markerFill:"#000"}:e instanceof yf||e instanceof Mf?{lineColor:"#000",lineWidth:1}:e instanceof df||e instanceof Cf?{polygonFill:"#fff",lineColor:"#000",lineWidth:1}:void 0}(e),g=n?Array.isArray(n)?n[0].id:n.id:t.id++;if(Array.isArray(f)&&f.length){const s=[],o=f.length;for(let a=0;a<o;a++){const m=a===o-1?u:iL({},u),A=mH(f[a],m);for(const e in f[a])fL(f[a],e)&&(m[("_symbol_"+e).trim()]=f[a][e]);A&&(f[a].lineGradientProperty=A);const w=n&&n[a]?n[a][i]:t.pickingId++,T={type:c,id:g,properties:m,visible:e.isVisible(),geometry:l,coordinates:h,extent:1/0};T[i]=w,s.push(T)}return s}if(f){const e=mH(f,u);for(const e in f)fL(f,e)&&(u[("_symbol_"+e).trim()]=f[e]);e&&(f.lineGradientProperty=e)}const m=n?n.id:t.pickingId++,A={type:c,id:g,properties:u,visible:e.isVisible(),geometry:l,coordinates:h,extent:1/0};return A[i]=m,A}function mH(e,t){const n=e.lineGradientProperty;return n&&(t[pH]=t[n],t.mapbox_clip_start=0,t.mapbox_clip_end=1,delete t[n]),n}let AH=class ri extends oH{postCreateGeometry(e){this.generateGradProperties(e)}startFrame(...e){super.startFrame(...e),this._updateMeshGradient()}_updateMeshGradient(){if(this._changedMeshes){for(let e=0;e<this._changedMeshes.length;e++){if(!this._changedMeshes[e]||!this._changedMeshes[e].isValid())continue;const{geometry:t,material:n}=this._changedMeshes[e],{symbolIndex:i}=t.properties;this.generateGradProperties({geometry:t,symbolIndex:i});const s=this._genGradientTexture(t.properties.gradients),o=n.get("lineGradientTexture");o&&o.destroy(),t.generateBuffers(this.regl),n.set("lineGradientTexture",s),n.set("lineGradientTextureHeight",s.height)}delete this._changedMeshes}}onFeatureChange(e,t){this._changedMeshes||(this._changedMeshes=[]);for(let n=0;n<t.length;n++){if(!t[n]||!t[n].isValid())continue;const i=t[n].geometry,{features:s}=i.properties;if(!s)continue;const o=e&&e[dH];s[o]&&(s[o].feature.properties[cH]=e.properties[cH],this._changedMeshes.push(t[n]),this.setToRedraw())}}needRebuildOnGometryPropertiesChanged(){return!1}generateGradProperties(e){const{symbolIndex:t,geometry:n}=e,{features:i}=n.properties,s=this.getSymbol(t).lineGradientProperty,o=n.properties.aPickingId||n.data.aPickingId,a=new Uint8Array(o.length),l=[],h=new Map;function c(e){let t=e&&e[s];Array.isArray(t)||(t=[0,"black",1,"black"]);let n,i=t.join();return h.has(i)?n=h.get(i):(n=l.length,h.set(i,n),l.push(t)),n}let u=o[0],f=i[u].feature.properties,g=c(f);for(let e=1;e<o.length;e++)o[e]!==u&&(u=o[e],f=i[u].feature.properties,g=c(f)),a[e]=g;if(n.data.aGradIndex){const e=n.data.aGradIndex;e&&e.buffer&&e.buffer.destroy&&e.buffer.destroy()}n.data.aGradIndex=a,n.properties.gradients=l}createMesh(e,t){const{geometry:n,symbolIndex:i,ref:s}=e,o=this.getSymbolDef(i);void 0===s&&VD(n,o,this.getFnTypeConfig(i),this.layer);const a={tileResolution:n.properties.tileResolution,tileRatio:n.properties.tileRatio,tileExtent:n.properties.tileExtent},l=this.getSymbol(i);this.setLineUniforms(l,a);const h=this._genGradientTexture(n.properties.gradients);a.lineGradientTexture=h,a.lineGradientTextureHeight=h.height,void 0===s&&n.generateBuffers(this.regl);const c=new CM.Material(a),u=new CM.Mesh(n,c,{castShadow:!1,picking:!0});u.setLocalTransform(t);const f={HAS_GRADIENT:1};return n.data.aAltitude&&(f.HAS_ALTITUDE=1),this.setMeshDefines(f,n,o),u.setDefines(f),u.properties.symbolIndex=i,u}_genGradientTexture(e){return this.regl.texture({width:256,height:2*e.length,data:yH(e),format:"rgba",mag:"linear",min:"linear",flipY:!1})}createFnTypeConfig(e,t){return this.createShapeFnTypeConfigs(e,t)}createShader(e){this._context=e;const t=[],n={};this.fillIncludes(n,t,e),this.sceneConfig.trailAnimation&&this.sceneConfig.trailAnimation.enable&&(n.HAS_TRAIL=1);const i=[];t.push({name:"projViewModelMatrix",type:"function",fn:function(e,t){return vA(i,t.projViewMatrix,t.modelMatrix),i}}),this.shader=new CM.MeshShader({vert:nH,frag:"#define SHADER_NAME LINE_GRADIENT\n#define DEVICE_PIXEL_RATIO 1.0\n#define MAX_LINE_COUNT 128.0\nprecision mediump float;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#ifdef HAS_OPACITY\nvarying float vOpacity;\n#else\nuniform lowp float lineOpacity;\n#endif\nuniform float layerOpacity;\nuniform lowp float lineBlur;\nuniform float lineGradientTextureHeight;\nuniform float tileExtent;\nuniform sampler2D lineGradientTexture;\nvarying vec2 vNormal;\nvarying vec2 vWidth;\nvarying float vGammaScale;\nvarying highp float vLinesofar;\nvarying float vGradIndex;\n#ifndef ENABLE_TILE_STENCIL\nvarying vec2 vPosition;\n#endif\n#ifdef HAS_TRAIL\nuniform float trailSpeed;\nuniform float trailLength;\nuniform float trailCircle;\nuniform float currentTime;\n#endif\n#include <highlight_frag>\nvoid main() {\n  \n#ifndef ENABLE_TILE_STENCIL\nfloat c = sign(tileExtent - min(tileExtent, abs(vPosition.x))) * sign(1. + sign(vPosition.x)) * sign(tileExtent - min(tileExtent, abs(vPosition.y))) * sign(1. + sign(vPosition.y));\n  if(c == .0) {\n    discard;\n  }\n#endif\nfloat d = length(vNormal) * vWidth.s;\n  float e = (lineBlur + 1. / DEVICE_PIXEL_RATIO) * vGammaScale;\n  float f = clamp(min(d - (vWidth.t - e), vWidth.s - d) / e, .0, 1.);\n  float h = vLinesofar;\n  vec4 i = texture2D(lineGradientTexture, vec2(h, (vGradIndex * 2. + .5) / lineGradientTextureHeight)) * f;\n  i *= max(sign(MAX_LINE_COUNT - vGradIndex), .0);\n#ifdef HAS_TRAIL\nfloat j = mod(h - currentTime * trailSpeed * .1, trailCircle);\n  float k = j < trailLength ? mix(.0, 1., j / trailLength) : .0;\n  i *= k;\n#endif\n#ifdef HAS_OPACITY\nfloat l = vOpacity;\n#else\nfloat l = lineOpacity;\n#endif\ngl_FragColor = i * l * layerOpacity;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat m = shadow_computeShadow();\n  gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, m);\n#endif\ngl_FragColor = highlight_blendColor(gl_FragColor);\n}",uniforms:t,defines:n,extraCommandProps:this.getExtraCommandProps()})}};function yH(e){e.length>2048&&console.warn(`Gradients count is (${e.length}), it may be slow to render.`);const t=document.createElement("canvas"),n=t.getContext("2d");t.width=256,t.height=2*e.length;for(let t=0;t<e.length;t++){const i=e[t],s=n.createLinearGradient(0,0,256,0);for(let e=0;e<i.length;e+=2)s.addColorStop(+i[e],i[e+1]);n.fillStyle=s;const o=t%256;n.fillRect(0,2*o,256,2*o+2)}return n.canvas}let _H=class si{constructor(e){this._meshes=e||[],this.properties={}}set meshes(e){this._meshes=e}get meshes(){return this._meshes}};const vH=224,xH=100,bH=new Uint8Array(1),wH=[],TH={collides:0,boxes:[]},SH=[],MH=[];class gi extends OF{createGeometry(...e){const t=super.createGeometry(...e);if(!t||!t.geometry)return t;const{geometry:n}=t,i=e[0];n.properties.collideIds=i.featureIds&&i.featureIds.length&&i.isIdUnique?i.featureIds:i.data.aPickingId;return n.properties.uniqueCollideIds=nD(n.properties.collideIds,!(this.layer instanceof Up)),t}supportRenderMode(e){const t=this.sceneConfig.renderToPointRenderTarget;return t||void 0===t?"point"===e:"fxaa"===e||"fxaaAfterTaa"===e}addMesh(e,t,n){if(e&&!this.isEnableCollision()){let t=e;Array.isArray(t)||(SH[0]=e,t=SH);for(let e=0;e<t.length;e++){const n=t[e].defines;delete n.ENABLE_COLLISION,t[e].setDefines(n);const{elements:i,visElemts:s}=t[e].geometry.properties;s&&void 0!==s.count&&s.count!==i.length&&(t[e].geometry.setElements(i),s.count=i.length)}}return super.addMesh(e,t,n)}startMeshCollision(e){const{meshKey:t}=e.properties,{renderer:n}=this._cachedInstances,i=n.isForeground(e instanceof _H?e.meshes[0]:e);if(e.properties.isForeground=i,e instanceof _H&&e.meshes.length)for(let t=0;t<e.meshes.length;t++)e.meshes[t].properties.isForeground=i;this._startTime=performance.now(),this._canProceed=this._canProceedCollision(),this._meshCollisionStale=this._isCachedCollisionStale(t)}endMeshCollision(e){const t=this._collisionContext.tags[e];if(this._canProceed&&t&&this._meshCollisionStale){const e=this.getMap();this._anchorCoord0||(this._anchorCoord0=new fl(0,0),this._anchorCoord1=new fl(0,0)),t.anchor0=e.containerPointToCoord(this._containerAnchor0,this._anchorCoord0),t.anchor1=e.containerPointToCoord(this._containerAnchor1,this._anchorCoord1),t.anchor0.z=e.getZoom(),t.anchor0.width=e.width,t.anchor0.height=e.height,t.anchor0.pitch=e.getPitch()}this.getMap().collisionFrameTime+=performance.now()-this._startTime}_isCachedCollisionStale(e){const t=this.getMap(),n=t.getZoom(),i=t.getPitch(),[s,o]=this._getMeshAnchor(e);return!s||!o||s.z!==n||s.width!==t.width||s.height!==t.height||s.pitch!==i||s.distanceTo(this._containerAnchor0)>3||o.distanceTo(this._containerAnchor1)>3}_startCollision(){const e=this.getMap();this._coordCache={},this._containerAnchor0=new Re(e.width/3,e.height/2),this._containerAnchor1=new Re(2*e.width/3,e.height/2),delete this._canProceed,this._collisionContext||(this._collisionContext={tags:{}}),this._cachedInstances={layer:this.layer,renderer:this.layer.getRenderer(),frameTimestamp:this.layer.getRenderer().getFrameTimestamp(),map:this.getMap(),zoom:e.getZoom(),collisionTags:this._collisionContext.tags,isEnableUniquePlacement:this.isEnableUniquePlacement()}}_endCollision(){}_getCachedCollision(e,t){const n=this._collisionContext;return n.tags[e]&&n.tags[e][t]}_setCollisionCache(e,t,n){const i=this._collisionContext;i.tags[e]=i.tags[e]||[],i.tags[e][t]=n}_canProceedCollision(){const e=this.getMap();if(!e.isInteracting())return!0;return e.collisionFrameTime<=this.layer.options.collisionFrameLimit}_getMeshAnchor(e){const t="__meshAnchorKey".trim(),n=this._collisionContext.tags[e];if(n&&n.anchor0){const{anchor0:e,anchor1:i}=n,s=e[t]=e[t]||e.x+","+e.y,o=i[t]=i[t]||i.x+","+i.y;let a=this._coordCache[s],l=this._coordCache[o];if(!a||!l){const t=this.getMap();a=this._coordCache[s]=t.coordToContainerPoint(e),l=this._coordCache[o]=t.coordToContainerPoint(i)}return a.z=e.z,wH[0]=a,wH[1]=l,a.width=e.width,a.height=e.height,wH}return wH[0]=wH[1]=null,wH}updateBoxCollisionFading(e,t,n,i,s){const{layer:o,renderer:a,zoom:l,collisionTags:h,isEnableUniquePlacement:c}=this._cachedInstances,{meshKey:u,isForeground:f}=t.properties;if(c&&this._isReplacedPlacement(u,s))return!1;const g=n.length;let m=h[u]&&h[u][s];const A=m,w=this._zooming&&m;if((!w||0===m.collides)&&e){if(this._canProceed||w&&0===m.collides)if((this._meshCollisionStale||m&&m.z!==l)&&(m=null),m){if(m.boxes&&m.boxes.length){const{boxes:e,isAllowOverlap:t}=m;let n=0;if(!t){let t=0;for(let i=0;i<e.length;i++)if(!n){const s=this.isCollides(e[i]);if(-1===s)t++;else if(1===s){n=1;break}}t===e.length&&(n=-1)}m.collides=n}}else{m=A||{collides:0,boxes:[]},m.boxes.length=0,m.z=l;let e=0;for(let t=0;t<g;t++){const{mesh:o,allElements:a,boxCount:l,start:h,end:c}=n[t],u=this._isBoxVisible(o,a,l,h,c,i,s);u.isAllowOverlap&&(m.isAllowOverlap=1),0===e&&(e=u.collides),u.boxes&&m.boxes.push(...u.boxes)}m.collides=e,this._setCollisionCache(u,s,m)}}let T=e&&m&&0===m.collides,S=1,M=!1;if(this.sceneConfig.fading){const e=this._getBoxTimestamps(t);if(this._zoomingOut)e[s]=T?1:-1;else if(f&&delete t._fadeOutStartTime,S=this._getBoxFading(f,T,e,s),f?(S>0&&(T=!0),M=this.isBoxFading(t,s),M&&this.setToRedraw()):T||(this._markFadingCollided(e,s),S=0),T){const n=t._fadeOutStartTime;if(n&&1===S&&e[s]>0){let{fadeOutDelay:e,fadingDuration:t}=this.sceneConfig;WL(t)&&(t=vH),WL(e)&&(e=xH);const i=VL(1-(a.getFrameTimestamp()-n-e)/t,0,1);S*=i,i>0&&this.setToRedraw()}}}if(m&&o.options.debugCollision&&this.addCollisionDebugBox(m.boxes,m.collides?0:1),T||M){const{mesh:e,start:t}=n[0],i=this.getSymbol(e.properties.symbolIndex);!this._isIgnorePlacement(i,e,t)&&m&&m.boxes&&this._fillCollisionIndex(m.boxes,e)}if(T){const e=bH[0]=255*S;for(let t=0;t<g;t++){const{mesh:i,allElements:s,start:o,boxStart:a,end:l,boxIndex:h}=n[t];this.setCollisionOpacity(i,s,e,void 0===a?o:a,l,h)}}return T&&S>0}isMeshIterable(){return!0}setCollisionOpacity(e,t,n,i,s){this._updateOpacityData(e,n,t[i],t[s-1])}_updateOpacityData(e,t,n,i){const{aOpacity:s}=e.geometry.properties;if(!s)return;const o=n;if(s[o]!==t){const e=i;for(let n=o;n<=e;n++)s[n]=t;s.dirty=!0}}isBoxFading(e,t){const{frameTimestamp:n}=this._cachedInstances;let i=this.sceneConfig.fadingDuration;return WL(i)&&(i=vH),n-Math.abs(this._getBoxTimestamps(e)[t])<i}_isBoxVisible(e,t,n,i,s,o,a){const l=this.getSymbol(e.properties.symbolIndex),h=this._isIgnorePlacement(l,e,t[i]),c=this._isAllowOverlap(l,e,t[i]);if(!this.isEnableCollision()||h&&c)return TH;const u=this.isBoxCollides(e,t,n,i,s,o,a);return c&&(u.collides=0,u.isAllowOverlap=1),u}_isIgnorePlacement(e,t,n){if(!this.isEnableCollision())return!0;const i=t.geometry.properties.aOverlap;if(!i)return 1==+e[this.propIgnorePlacement];const s=i[n];return s<2?1==+e[this.propIgnorePlacement]:s%8%2}_isAllowOverlap(e,t,n){if(!this.isEnableCollision())return!0;const i=t.geometry.properties.aOverlap;if(!i)return 1==+e[this.propAllowOverlap];const s=i[n];return s<2?1==+e[this.propAllowOverlap]:(s>>2)%2}_fillCollisionIndex(e){if(Array.isArray(e[0]))for(let t=0;t<e.length;t++)this.insertCollisionBox(e[t]);else this.insertCollisionBox(e)}_getBoxFading(e,t,n,i){let{fadingDuration:s,fadeInDelay:o,fadeOutDelay:a}=this.sceneConfig;WL(s)&&(s=vH),WL(o)&&(o=600),WL(a)&&(a=xH);const{frameTimestamp:l}=this._cachedInstances;let h=n[i],c=t?1:0;if(!h)return t&&e&&(n[i]=l+o),0;if(l<Math.abs(h)&&(!t&&h>0||t&&h<0)){const e=l-s;n[i]=h=t?e:-e}return l-Math.abs(h)<s?c=h>0?(l-h)/s:1-(l+h)/s:t?(h<0&&(n[i]=h=l+o),c=(l-h)/s):(h>0&&(n[i]=h=-(l+a)),c=1-(l+h)/s),(c<0||c>1)&&(c=VL(c,0,1)),c}_getBoxTimestamps(e){this._boxTimestamps||(this._boxTimestamps={});const{meshKey:t}=e.properties;if(!this._boxTimestamps[t]){const{frameTimestamp:e}=this._cachedInstances;this._boxTimestamps[t]={timestamp:e}}return this._boxTimestamps[t]}_refreshTimeStamps(e){if(!this._prevTimestamp)return void(this._prevTimestamp=e);const t=this.scene.getMeshes();if(t&&t.length){for(let n=0;n<t.length;n++){const i=this._getBoxTimestamps(t[n]);i.timestamp<this._prevTimestamp?delete t[n]._fading_timestamps:i.timestamp=e}this._prevTimestamp=e}}_markFadingCollided(e,t){if(!e)return;const{frameTimestamp:n}=this._cachedInstances;let{fadingDuration:i}=this.sceneConfig;WL(i)&&(i=vH),e[t]=-(n-i-1)}deleteMesh(e,t){if(e){if(Array.isArray(e))for(let t=0;t<e.length;t++){const n=e[t].properties.meshKey;this._collisionContext&&delete this._collisionContext.tags[n],this._boxTimestamps&&delete this._boxTimestamps[n]}else{const t=e.properties.meshKey;this._collisionContext&&delete this._collisionContext.tags[t],this._boxTimestamps&&delete this._boxTimestamps[t]}super.deleteMesh(e,t)}}delete(e){this._collisionMesh&&(this._collisionMesh.geometry.dispose(),this._collisionShader.dispose(),this._collisionMesh.dispose(),delete this._collisionMesh,delete this._collisionShader,delete this._collisionRenderer),delete this._collisionContext,super.delete(e)}isCollides(e){const t=this.layer,n=t.getMap(),i=n.getDevicePixelRatio();if(ky(MH,e,1/i),n.isOffscreen(MH))return-1;const s=t.getCollisionIndex(),o=this.sceneConfig.collisionBufferSize||t.options.collisionBufferSize||0;return o&&(e=kH(MH,e,o)),+s.collides(e)}insertCollisionBox(e){const t=this.layer,n=t.getCollisionIndex(),i=this.sceneConfig.collisionBufferSize||t.options.collisionBufferSize||0;let s=e;i&&(s=e._buffered=e._buffered||[],e=kH(s,e,i)),n.insertBox(s)}addCollisionDebugBox(e,t){if(e&&e.length)if(Array.isArray(e[0]))for(let n=0;n<e.length;n++){this._addCollisionBox(e[n],t)}else this._addCollisionBox(e,t)}_addCollisionBox(e,t){if(!e)return;const n=this._collisionBoxes=this._collisionBoxes||{aPosition:[],aVisible:[],indices:[]},i=this.sceneConfig.collisionBufferSize||this.layer.options.collisionBufferSize||0;i&&(e=kH(MH,e,i));const s=this.getMap(),o=s.getDevicePixelRatio();if(ky(MH,e,1/o),s.isOffscreen(MH))return;const a=n.aPosition.length/2;n.aPosition.push(e[0],e[1],e[2],e[1],e[2],e[3],e[0],e[3]),n.aVisible.push(t,t,t,t),n.indices.push(a,a+1,a+1,a+2,a+2,a+3,a+3,a)}updateCollision(e){super.updateCollision(e),this._startCollision(),this._prepareZoomEndMeshes(),this._zoomEndMeshes&&this._zoomEndMeshes.length&&(this._updateZoomMeshesLevel(),this._zoomEndMeshes&&(this.setToRedraw(),this.scene.addMesh(this._zoomEndMeshes))),(this.getMap().isZooming()||this._zoomEndMeshes&&this._zoomEndMeshes.length)&&(this._updateUniquePlacements(),this._mergeUniquePlacements(this.scene.getMeshes()))}paint(e){const t=super.paint(e);return this._renderCollisionBox(e),!1===this._canProceed&&this.setToRedraw(),t}shouldIgnoreBackground(){return!this.getMap().isZooming()&&!this._zoomEndMeshes}_prepareZoomEndMeshes(){const e=this.getMap(),t=e.isZooming();if(!t&&this._zooming){const e=this.layer.getRenderer();this._zoomEndMeshes=this.scene.getMeshes().filter((t=>!e.isForeground(t)&&!t.properties.isLinePlacement))}else t&&!this._zooming&&(this._preRes=e.getResolution());if(t)this._clearTimeout&&(clearTimeout(this._clearTimeout),delete this._zoomingOut,delete this._clearTimeout),this._zoomingOut=this._preRes&&e.getResolution()>this._preRes;else if(this._zooming&&!this._clearTimeout){let{fadeOutDelay:e,fadingDuration:t}=this.sceneConfig;WL(e)&&(e=xH),WL(t)&&(t=vH),this._clearTimeout=setTimeout((()=>{delete this._zoomingOut,delete this._clearTimeout}),e+t+1)}this._zooming=t}_renderCollisionBox(e){if(!this._collisionBoxes||!this.layer.options.debugCollision)return;this._collisionRenderer||this._initCollisionShader();const{aPosition:t,aVisible:n,indices:i}=this._collisionBoxes;if(!this._collisionMesh){const e=new CM.Geometry({aPosition:[],aVisible:[]},[],0,{positionSize:2,primitive:"lines"});this._collisionMesh=new CM.Mesh(e),this._collisionScene=new CM.Scene,this._collisionScene.addMesh(this._collisionMesh)}const s=this._collisionMesh.geometry;s.updateData("aPosition",new Float32Array(t)),s.updateData("aVisible",new Uint8Array(n)),s.setElements(i),this._collisionRenderer.render(this._collisionShader,{size:[this.canvas.width,this.canvas.height]},this._collisionScene,this.getRenderFBO(e)),delete this._collisionBoxes}_initCollisionShader(){this._collisionRenderer=new CM.Renderer(this.regl);const e=this.canvas;this._collisionShader=new CM.MeshShader({vert:"attribute vec2 aPosition;\nattribute float aVisible;\nuniform vec2 size;\nvarying vec4 vColor;\nvoid main() {\n  vec2 c = (aPosition / size - .5) * 2. * vec2(1., -1.);\n  gl_Position = vec4(c, .0, 1.);\n  vColor = mix(vec4(1., .0, .0, 1.5) * .5, vec4(.0, 1., .0, 1.) * .4, aVisible);\n}",frag:"precision mediump float;\nvarying vec4 vColor;\nvoid main() {\n  gl_FragColor = vec4(vColor.rgb, .5);\n}",uniforms:["size"],extraCommandProps:{viewport:{x:0,y:0,width:()=>e?e.width:1,height:()=>e?e.height:1},depth:{enable:!1},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}})}_updateZoomMeshesLevel(){let{fadeOutDelay:e,fadingDuration:t}=this.sceneConfig;WL(e)&&(e=xH),WL(t)&&(t=vH);const n=this.layer.getRenderer(),i=n.getCurrentTileZoom(),s=n.getFrameTimestamp(),o=[];for(let a=0;a<this._zoomEndMeshes.length;a++){const l=this._zoomEndMeshes[a],h=l.properties.tile;!l._fadeOutStartTime&&n.isBackTile(h.id)&&(l._fadeOutStartTime=s);l.properties.level=h.z-i>0?2*(h.z-i)-1:2*(i-h.z),n.isForeground(l)||l._fadeOutStartTime&&s-l._fadeOutStartTime>e+t?delete l._fadeOutStartTime:o.push(l)}delete this._zoomEndMeshes,o.length&&(this._zoomEndMeshes=o)}isEnableCollision(){return this.layer.options.collision&&!!this.sceneConfig.collision}isEnableUniquePlacement(){return this.isEnableCollision()&&this.sceneConfig.uniquePlacement}isMeshUniquePlaced(e){return this.isMeshIterable(e)}_updateUniquePlacements(){if(!this.isEnableUniquePlacement())return;const e=this.scene.getMeshes(),t=(e,t,n,i)=>{const{start:s,end:o}=t[0],a=e.geometry.properties,l=a.elements;let h=a.uniquePlacements;if(h||(h=a.uniquePlacements=[]),void 0===h[i]){const t=this.getUniqueEntryKey(e,l[s],i);h[i]=t?{key:t,index:i,start:l[s],end:l[o-1]}:null}};for(let n=0;n<e.length;n++){const i=e[n];this.isMeshUniquePlaced(i)&&this.forEachBox(i,t)}}_mergeUniquePlacements(e){if(!this.isEnableUniquePlacement())return;const t=this.getMap().getZoom();let n=!this._mergedMeshes||this._mergedMehesZoom!==t;if(!n)for(let t=0;t<e.length;t++)if(!this._mergedMeshes[e[t].properties.meshKey]){n=!0;break}if(!n)return;this._mergedMehesZoom=t,this._replacedPlacements={},this._mergedMeshes={},e=e.sort(IH);const i=this.getMap().getGLScale(),s={};for(let t=0;t<e.length;t++){const n=e[t];if(!n.geometry)continue;const{meshKey:o}=n.properties;this._mergedMeshes[o]=1;const{uniquePlacements:a}=n.geometry.properties;if(a)for(let e=0;e<a.length;e++){if(!a[e])continue;const{key:t,index:o}=a[e],l=this._getBoxTimestamps(n),h=PH(t,i),c=s[h];if(c){const e=c.length,t=c[e-3].properties.meshKey,i=c[e-2],s=c[e-1];this._replacedPlacements[t]=this._replacedPlacements[t]||{},this._replacedPlacements[t][s]=1,this._updatePlacementStamps(l,o,i,s),c.push(n,l,o)}else s[h]=[n,l,o]}}for(const e in s){const t=s[e];if(t.length<=6)continue;const n=t.length,i=t[n-2][t[n-1]];if(t[1][t[2]]!==i)for(let e=0;e<n-6;e+=3)t[e+1][t[e+2]]=i}}_updatePlacementStamps(e,t,n,i){if(void 0!==n[i])if(void 0===e[t])e[t]=n[i];else{let s=e[t];Math.abs(n[i])>Math.abs(s)?e[t]=n[i]:n[i]=e[t]}else void 0!==e[t]&&(n[i]=e[t])}_isReplacedPlacement(e,t){return this._replacedPlacements&&this._replacedPlacements[e]&&this._replacedPlacements[e][t]}_getCollideBoxes(e,t){const{symbolIndex:n}=e.properties,i=n.type||0;let s=e.properties._collidesBoxes;s||(s=e.properties._collidesBoxes=[]);let o=s[n.index];o||(o=e.properties._collidesBoxes=[]),o[i]||(o[i]=[]),o=o[i];const a=t/6;if(!o[a]){const e=[];o[a]={boxes:e,collision:{boxes:e}}}return o[a]}_getMeshBoxes(e){let t=this._MeshBoxes;if(t||(t=this._MeshBoxes=[]),!t[e]){t[e]=[];for(let n=0;n<e;n++)t[e][n]={}}return t[e]}_isHalo0(e){if(!e||!e.geometry)return!0;const t=eF(this.getSymbolDef(e.geometry.properties.symbolIndex).textHaloRadius);return!(!e.geometry.properties.glyphAtlas||!e.material.get("isHalo")||t&&e.geometry.properties.hasHalo)&&(!(!t||e.geometry.properties.hasHalo)||!this.getSymbol(e.geometry.properties.symbolIndex).textHaloRadius)}}const CH=10;function PH(e,t){return Math.round(e[0]/t/CH)*Math.round(e[1]/t/CH)*(e[2]?Math.round(e[2]/CH):1)+"-"+e[3]}function IH(e,t){const n=t.properties.level-e.properties.level;return 0===n?e.properties.meshKey-t.properties.meshKey:n}function kH(e,t,n){return e[0]=t[0]-n,e[1]=t[1]-n,e[2]=t[2]+n,e[3]=t[3]+n,e}var OH="#include <gl2_vert>\n#define SHADER_NAME MARKER\n#define RAD 0.0174532925\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec4 aShape;\n#ifdef ENABLE_COLLISION\nattribute float aOpacity;\n#endif\n#ifdef HAS_OPACITY\nattribute vec2 aColorOpacity;\n#endif\n#ifdef HAS_TEXT_SIZE\nattribute float aTextSize;\n#else\nuniform float textSize;\n#endif\n#if defined(HAS_TEXT_DX) || defined(HAS_TEXT_DY) || defined(HAS_MARKER_DX) || defined(HAS_MARKER_DY)\nattribute vec4 aDxDy;\n#endif\n#ifndef HAS_MARKER_DX\nuniform float markerDx;\n#endif\n#ifndef HAS_MARKER_DY\nuniform float markerDy;\n#endif\n#ifndef HAS_TEXT_DX\nuniform float textDx;\n#endif\n#ifndef HAS_TEXT_DY\nuniform float textDy;\n#endif\n#ifdef HAS_MARKER_WIDTH\nattribute float aMarkerWidth;\n#else\nuniform float markerWidth;\n#endif\n#ifdef HAS_MARKER_HEIGHT\nattribute float aMarkerHeight;\n#else\nuniform float markerHeight;\n#endif\n#if defined(HAS_MARKER_PITCH_ALIGN) || defined(HAS_TEXT_PITCH_ALIGN)\nattribute vec2 aPitchAlign;\n#endif\n#ifndef HAS_MARKER_PITCH_ALIGN\nuniform float markerPitchWithMap;\n#endif\n#ifndef HAS_TEXT_PITCH_ALIGN\nuniform float textPitchWithMap;\n#endif\n#if defined(HAS_MARKER_ROTATION_ALIGN) || defined(HAS_TEXT_ROTATION_ALIGN)\nattribute vec2 aRotationAlign;\n#endif\n#ifndef HAS_MARKER_ROTATION_ALIGN\nuniform float markerRotateWithMap;\n#endif\n#ifndef HAS_TEXT_ROTATION_ALIGN\nuniform float textRotateWithMap;\n#endif\nuniform float flipY;\n#if defined(HAS_MARKER_ROTATION) || defined(HAS_TEXT_ROTATION)\nattribute vec2 aRotation;\n#endif\n#ifndef HAS_MARKER_ROTATION\nuniform float markerRotation;\n#endif\n#ifndef HAS_TEXT_ROTATION\nuniform float textRotation;\n#endif\n#ifdef HAS_PAD_OFFSET\nattribute vec2 aPadOffset;\n#endif\nuniform float cameraToCenterDistance;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float textPerspectiveRatio;\nuniform float markerPerspectiveRatio;\nuniform float glyphSize;\nuniform vec2 iconSize;\nuniform vec2 canvasSize;\nuniform vec2 iconTexSize;\nuniform vec2 glyphTexSize;\nuniform float mapPitch;\nuniform float mapRotation;\nuniform float zoomScale;\nuniform float tileRatio;\nuniform float layerScale;\nuniform float isRenderingTerrain;\n#include <vt_position_vert>\nvarying float vIsText;\n#ifndef PICKING_MODE\nvarying vec2 vTexCoord;\nvarying float vOpacity;\nvarying float vGammaScale;\nvarying float vTextSize;\nvarying float vHalo;\n#ifdef HAS_TEXT_FILL\nattribute vec4 aTextFill;\nvarying vec4 vTextFill;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nattribute vec4 aTextHaloFill;\nvarying vec4 vTextHaloFill;\n#endif\n#if defined(HAS_TEXT_HALO_RADIUS) || defined(HAS_TEXT_HALO_OPACITY)\nattribute vec2 aTextHalo;\nvarying vec2 vTextHalo;\n#endif\n#include <highlight_vert>\n#else\n#include <fbo_picking_vert>\n#endif\nvoid main() {\n  vec3 c = unpackVTPosition();\n#ifdef HAS_TEXT_SIZE\nfloat d = aTextSize * layerScale;\n#else\nfloat d = textSize * layerScale;\n#endif\n#ifdef HAS_TEXT_DX\nfloat e = aDxDy.z;\n#else\nfloat e = textDx;\n#endif\n#ifdef HAS_TEXT_DY\nfloat f = aDxDy.w;\n#else\nfloat f = textDy;\n#endif\n#ifdef HAS_MARKER_WIDTH\nfloat h = aMarkerWidth;\n#else\nfloat h = markerWidth;\n#endif\n#ifdef HAS_MARKER_HEIGHT\nfloat i = aMarkerHeight;\n#else\nfloat i = markerHeight;\n#endif\n#ifdef HAS_MARKER_DX\nfloat j = aDxDy.x;\n#else\nfloat j = markerDx;\n#endif\n#ifdef HAS_MARKER_DY\nfloat k = aDxDy.y;\n#else\nfloat k = markerDy;\n#endif\nfloat l = mod(aShape.z, 2.);\n  float m;\n  if(l > .5) {\n    \n#ifdef HAS_TEXT_PITCH_ALIGN\nm = aPitchAlign.y;\n#else\nm = textPitchWithMap;\n#endif\n  } else {\n    \n#ifdef HAS_MARKER_PITCH_ALIGN\nm = aPitchAlign.x;\n#else\nm = markerPitchWithMap;\n#endif\n  }\n  float n;\n  if(l > .5) {\n    \n#ifdef HAS_TEXT_ROTATION_ALIGN\nn = aRotationAlign.y;\n#else\nn = textRotateWithMap;\n#endif\n  } else {\n    \n#ifdef HAS_MARKER_ROTATION_ALIGN\nn = aRotationAlign.x;\n#else\nn = markerRotateWithMap;\n#endif\n  }\n  gl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);\n  float o = gl_Position.w;\n  float u;\n  if(isRenderingTerrain == 1. && m == 1.) {\n    u = 1.;\n  } else {\n    float v = (1. - cameraToCenterDistance / o) * markerPerspectiveRatio;\n    u = clamp(.5 + .5 * (1. - v), .0, 4.);\n  }\n  float A;\n  if(l > .5) {\n    \n#ifdef HAS_TEXT_ROTATION\nA = -aRotation.y / 9362. - mapRotation * n;\n#else\nA = -textRotation - mapRotation * n;\n#endif\n  } else {\n    \n#ifdef HAS_MARKER_ROTATION\nA = -aRotation.x / 9362. - mapRotation * n;\n#else\nA = -markerRotation - mapRotation * n;\n#endif\n  }\n  if(m == 1.) {\n    \n#ifdef REVERSE_MAP_ROTATION_ON_PITCH\nA += mapRotation;\n#else\nif(l > .5) {\n      A -= mapRotation;\n    } else {\n      A += mapRotation;\n    }\n#endif\n  }\n  float B = sin(A);\n  float C = cos(A);\n  mat2 D = mat2(C, -1. * B, B, C);\n  vec2 E = (aShape.xy / 10.0);\n  if(m == 1. && flipY == .0) {\n    E *= vec2(1., -1.);\n  }\n  vIsText = l;\n  if(l > .5) {\n    E = E / glyphSize * d;\n  } else {\n    \n#ifdef HAS_PAD_OFFSET\nfloat F = aPadOffset.x - 1.;\n    float G = aPadOffset.y;\n#else\nfloat F = .0;\n    float G = .0;\n#endif\nE = (E / iconSize * vec2(h, i) + vec2(F, G)) * layerScale;\n  }\n  E = D * E;\n  float H;\n  if(isRenderingTerrain == 1.) {\n    H = 1.;\n  } else {\n    H = o / cameraToCenterDistance;\n  }\n  if(m == .0) {\n    vec2 I = E * 2. / canvasSize;\n    gl_Position.xy += I * u * o;\n  } else if(l > .5) {\n    float J;\n    if(isRenderingTerrain == 1.) {\n      J = tileRatio / zoomScale;\n    } else {\n      J = tileRatio / zoomScale * H * u;\n    }\n    vec2 I = E;\n    gl_Position = projViewModelMatrix * positionMatrix * vec4(c + vec3(I, .0) * J, 1.);\n  } else {\n    vec2 I = E;\n    gl_Position = projViewModelMatrix * positionMatrix * vec4(c + vec3(I, .0) * tileRatio / zoomScale * H * u, 1.);\n  }\n  if(l > .5) {\n    gl_Position.xy += vec2(e, -f) * 2. / canvasSize * o;\n  } else {\n    gl_Position.xy += vec2(j, -k) * 2. / canvasSize * o;\n  }\n#ifndef PICKING_MODE\nif(m == .0) {\n    vGammaScale = mix(1., H, textPerspectiveRatio);\n  } else {\n    vGammaScale = H + mapPitch / 4.;\n  }\n  vGammaScale = clamp(vGammaScale, .0, 1.);\n  vec2 K = floor(aShape.zw / 2.);\n  if(l > .5) {\n    vTexCoord = K / glyphTexSize;\n  } else {\n    vTexCoord = K / iconTexSize;\n  }\n  vHalo = mod(aShape.w, 2.);\n  vTextSize = d;\n#ifdef ENABLE_COLLISION\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\n#ifdef HAS_OPACITY\nif(l > .5) {\n    vOpacity *= aColorOpacity.y / 255.;\n  } else {\n    vOpacity *= aColorOpacity.x / 255.;\n  }\n#endif\n#ifdef HAS_TEXT_FILL\nvTextFill = aTextFill / 255.;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nvTextHaloFill = aTextHaloFill / 255.;\n#endif\n#if defined(HAS_TEXT_HALO_RADIUS) || defined(HAS_TEXT_HALO_OPACITY)\nvTextHalo = aTextHalo;\n#endif\nhighlight_setVarying();\n#else\n#ifdef ENABLE_COLLISION\nbool L = aOpacity == 255.;\n#else\nbool L = true;\n#endif\nfbo_picking_setData(gl_Position.w, L);\n#endif\n}",EH="#define RAD 0.0174532925\nstruct MarkerUniforms {\n    positionMatrix: mat4x4f,\n    projViewModelMatrix: mat4x4f,\n    textSize: f32,\n    markerDx: f32,\n    markerDy: f32,\n    textDx: f32,\n    textDy: f32,\n    markerWidth: f32,\n    markerHeight: f32,\n    markerPitchWithMap: f32,\n    textPitchWithMap: f32,\n    markerRotateWithMap: f32,\n    textRotateWithMap: f32,\n    markerRotation: f32,\n    textRotation: f32,\n    flipY: f32,\n    textPerspectiveRatio: f32,\n    markerPerspectiveRatio: f32,\n    iconTexSize: vec2f,\n    glyphTexSize: vec2f,\n    tileRatio: f32,\n    zoomScale: f32\n}\nstruct ShaderUniforms {\n    cameraToCenterDistance: f32,\n    glyphSize: f32,\n    iconSize: vec2f,\n    canvasSize: vec2f,\n    layerScale: f32,\n    isRenderingTerrain: f32,\n    mapPitch: f32,\n    mapRotation: f32\n}\n@group(0) @binding($b) var<uniform> uniforms: MarkerUniforms;\n@group(0) @binding($b) var<uniform> shaderUniforms: ShaderUniforms;\nstruct VertexInput {\n#ifdef HAS_ALTITUDE\n    @location($i) aPosition: vec2f,\n    @location($i) aAltitude: f32,\n#else\n    @location($i) aPosition: vec3f,\n#endif\n    @location($i) aShape: vec4i,\n#ifdef ENABLE_COLLISION\n    @location($i) aOpacity: u32,\n#endif\n#ifdef HAS_OPACITY\n    @location($i) aColorOpacity: vec2u,\n#endif\n#ifdef HAS_TEXT_SIZE\n    @location($i) aTextSize: u32,\n#endif\n#if HAS_TEXT_DX || HAS_TEXT_DY || HAS_MARKER_DX || HAS_MARKER_DY\n    @location($i) aDxDy: vec4i,\n#endif\n#ifdef HAS_MARKER_WIDTH\n    @location($i) aMarkerWidth: u32,\n#endif\n#ifdef HAS_MARKER_HEIGHT\n    @location($i) aMarkerHeight: u32,\n#endif\n#if HAS_MARKER_PITCH_ALIGN || HAS_TEXT_PITCH_ALIGN\n    @location($i) aPitchAlign: vec2u,\n#endif\n#if HAS_MARKER_ROTATION_ALIGN || HAS_TEXT_ROTATION_ALIGN\n    @location($i) aRotationAlign: vec2u,\n#endif\n#if HAS_MARKER_ROTATION || HAS_TEXT_ROTATION\n    @location($i) aRotation: vec2u,\n#endif\n#ifdef HAS_PAD_OFFSET\n    @location($i) aPadOffset: vec2f,\n#endif\n#ifdef HAS_TEXT_FILL\n    @location($i) aTextFill: vec4u,\n#endif\n#ifdef HAS_TEXT_HALO_FILL\n    @location($i) aTextHaloFill: vec4u,\n#endif\n#if HAS_TEXT_HALO_RADIUS || HAS_TEXT_HALO_OPACITY\n    @location($i) aTextHalo: vec2u,\n#endif\n};\nstruct VertexOutput {\n    @builtin(position) position: vec4f,\n#ifndef PICKING_MODE\n    @location($o) vTexCoord: vec2f,\n    @location($o) vOpacity: f32,\n    @location($o) vGammaScale: f32,\n    @location($o) vTextSize: f32,\n    @location($o) vHalo: f32,\n    @location($o) vIsText: f32,\n    #ifdef HAS_TEXT_FILL\n        @location($o) vTextFill: vec4f,\n    #endif\n    #ifdef HAS_TEXT_HALO_FILL\n        @location($o) vTextHaloFill: vec4f,\n    #endif\n    #if HAS_TEXT_HALO_RADIUS || HAS_TEXT_HALO_OPACITY\n        @location($o) vTextHalo: vec2f,\n    #endif\n#endif\n};\n#include <vt_position_vert>\n#ifndef PICKING_MODE\n#include <highlight_vert>\n#else\n#include <fbo_picking_vert>\n#endif\n@vertex\nfn main(vertexInput: VertexInput) -> VertexOutput {\n    var output: VertexOutput;\n    var position = unpackVTPosition(vertexInput);\n#ifdef HAS_TEXT_SIZE\n    var myTextSize = f32(vertexInput.aTextSize) * shaderUniforms.layerScale;\n#else\n    var myTextSize = uniforms.textSize * shaderUniforms.layerScale;\n#endif\n#ifdef HAS_TEXT_DX\n    var myTextDx = f32(vertexInput.aDxDy.z);\n#else\n    var myTextDx = uniforms.textDx;\n#endif\n#ifdef HAS_TEXT_DY\n    var myTextDy = f32(vertexInput.aDxDy.w);\n#else\n    var myTextDy = uniforms.textDy;\n#endif\n#ifdef HAS_MARKER_WIDTH\n    var myMarkerWidth = f32(vertexInput.aMarkerWidth);\n#else\n    var myMarkerWidth = uniforms.markerWidth;\n#endif\n#ifdef HAS_MARKER_HEIGHT\n    var myMarkerHeight = f32(vertexInput.aMarkerHeight);\n#else\n    var myMarkerHeight = uniforms.markerHeight;\n#endif\n#ifdef HAS_MARKER_DX\n    var myMarkerDx = f32(vertexInput.aDxDy.x);\n#else\n    var myMarkerDx = uniforms.markerDx;\n#endif\n#ifdef HAS_MARKER_DY\n    var myMarkerDy = f32(vertexInput.aDxDy.y);\n#else\n    var myMarkerDy = uniforms.markerDy;\n#endif\n    var isText = f32(vertexInput.aShape.z) % 2.0;\n    var isPitchWithMap: f32;\n    if (isText > 0.5) {\n#ifdef HAS_TEXT_PITCH_ALIGN\n        isPitchWithMap = f32(vertexInput.aPitchAlign.y);\n#else\n        isPitchWithMap = uniforms.textPitchWithMap;\n#endif\n    } else {\n#ifdef HAS_MARKER_PITCH_ALIGN\n        isPitchWithMap = f32(vertexInput.aPitchAlign.x);\n#else\n        isPitchWithMap = uniforms.markerPitchWithMap;\n#endif\n    }\n    var isRotateWithMap: f32;\n    if (isText > 0.5) {\n#ifdef HAS_TEXT_ROTATION_ALIGN\n        isRotateWithMap = f32(vertexInput.aRotationAlign.y);\n#else\n        isRotateWithMap = uniforms.textRotateWithMap;\n#endif\n    } else {\n#ifdef HAS_MARKER_ROTATION_ALIGN\n        isRotateWithMap = f32(vertexInput.aRotationAlign.x);\n#else\n        isRotateWithMap = uniforms.markerRotateWithMap;\n#endif\n    }\n    let positionMatrix = uniforms.positionMatrix;\n    let projViewModelMatrix = uniforms.projViewModelMatrix;\n    output.position = projViewModelMatrix * positionMatrix * vec4f(position, 1.0);\n    var projDistance = output.position.w;\n    var perspectiveRatio: f32;\n    if (shaderUniforms.isRenderingTerrain == 1.0 && isPitchWithMap == 1.0) {\n        perspectiveRatio = 1.0;\n    } else {\n        var distanceRatio = (1.0 - shaderUniforms.cameraToCenterDistance / projDistance) * uniforms.markerPerspectiveRatio;\n        perspectiveRatio = clamp(\n            0.5 + 0.5 * (1.0 - distanceRatio),\n            0.0,\n            4.0);\n    }\n    var rotation: f32;\n    let mapRotation = shaderUniforms.mapRotation;\n    if (isText > 0.5) {\n#ifdef HAS_TEXT_ROTATION\n        rotation = -f32(vertexInput.aRotation.y) / 9362.0 - mapRotation * isRotateWithMap;\n#else\n        rotation = -uniforms.textRotation - mapRotation * isRotateWithMap;\n#endif\n    } else {\n#ifdef HAS_MARKER_ROTATION\n        rotation = -f32(vertexInput.aRotation.x) / 9362.0 - mapRotation * isRotateWithMap;\n#else\n        rotation = -uniforms.markerRotation - mapRotation * isRotateWithMap;\n#endif\n    }\n    if (isPitchWithMap == 1.0) {\n#ifdef REVERSE_MAP_ROTATION_ON_PITCH\n        rotation += mapRotation;\n#else\n        if (isText > 0.5) {\n            rotation -= mapRotation;\n        } else {\n            rotation += mapRotation;\n        }\n#endif\n    }\n    var angleSin = sin(rotation);\n    var angleCos = cos(rotation);\n    var shapeMatrix = mat2x2f(angleCos, -1.0 * angleSin, angleSin, angleCos);\n    var shape = vec2f(vertexInput.aShape.xy) / 10.0;\n    if (isPitchWithMap == 1.0 && uniforms.flipY == 0.0) {\n        shape *= vec2f(1.0, -1.0);\n    }\n    output.vIsText = isText;\n    if (isText > 0.5) {\n        shape = shape / shaderUniforms.glyphSize * myTextSize;\n    } else {\n#ifdef HAS_PAD_OFFSET\n        var padOffsetX = vertexInput.aPadOffset.x - 1.0;\n        var padOffsetY = vertexInput.aPadOffset.y;\n#else\n        var padOffsetX = 0.0;\n        var padOffsetY = 0.0;\n#endif\n        shape = (shape / shaderUniforms.iconSize * vec2f(myMarkerWidth, myMarkerHeight) + vec2f(padOffsetX, padOffsetY)) * shaderUniforms.layerScale;\n    }\n    shape = shapeMatrix * shape;\n    var cameraScale: f32;\n    if (shaderUniforms.isRenderingTerrain == 1.0) {\n        cameraScale = 1.0;\n    } else {\n        cameraScale = projDistance / shaderUniforms.cameraToCenterDistance;\n    }\n    let canvasSize = shaderUniforms.canvasSize;\n    if (isPitchWithMap == 0.0) {\n        var offset = shape * 2.0 / canvasSize;\n        output.position.x += offset.x * perspectiveRatio * projDistance;\n        output.position.y += offset.y * perspectiveRatio * projDistance;\n    } else if (isText > 0.5) {\n        var offsetScale: f32;\n        if (shaderUniforms.isRenderingTerrain == 1.0) {\n            offsetScale = uniforms.tileRatio / uniforms.zoomScale;\n        } else {\n            offsetScale = uniforms.tileRatio / uniforms.zoomScale * cameraScale * perspectiveRatio;\n        }\n        var offset = shape;\n        output.position = projViewModelMatrix * positionMatrix * vec4f(position + vec3f(offset, 0.0) * offsetScale, 1.0);\n    } else {\n        var offset = shape;\n        output.position = projViewModelMatrix * positionMatrix * vec4f(position + vec3f(offset, 0.0) * uniforms.tileRatio / uniforms.zoomScale * cameraScale * perspectiveRatio, 1.0);\n    }\n    if (isText > 0.5) {\n        output.position.x += myTextDx * 2.0 / canvasSize.x * projDistance;\n        output.position.y += -myTextDy * 2.0 / canvasSize.y * projDistance;\n    } else {\n        output.position.x += myMarkerDx * 2.0 / canvasSize.x * projDistance;\n        output.position.y += -myMarkerDy * 2.0 / canvasSize.y * projDistance;\n    }\n#ifndef PICKING_MODE\n    if (isPitchWithMap == 0.0) {\n        output.vGammaScale = mix(1.0, cameraScale, uniforms.textPerspectiveRatio);\n    } else {\n        output.vGammaScale = cameraScale + shaderUniforms.mapPitch / 4.0;\n    }\n    output.vGammaScale = clamp(output.vGammaScale, 0.0, 1.0);\n    var texCoord = floor(vec2f(vertexInput.aShape.zw) / 2.0);\n    if (isText > 0.5) {\n        output.vTexCoord = texCoord / uniforms.glyphTexSize;\n    } else {\n        output.vTexCoord = texCoord / uniforms.iconTexSize;\n    }\n    output.vHalo = f32(vertexInput.aShape.w) % 2.0;\n    output.vTextSize = myTextSize;\n#ifdef ENABLE_COLLISION\n    output.vOpacity = vertexInput.aOpacity / 255.0;\n#else\n    output.vOpacity = 1.0;\n#endif\n#ifdef HAS_OPACITY\n    if (isText > 0.5) {\n        output.vOpacity *= f32(vertexInput.aColorOpacity.y) / 255.0;\n    } else {\n        output.vOpacity *= f32(vertexInput.aColorOpacity.x) / 255.0;\n    }\n#endif\n#ifdef HAS_TEXT_FILL\n    output.vTextFill = vec4f(vertexInput.aTextFill) / 255.0;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\n    output.vTextHaloFill =  vec4f(vertexInput.aTextHaloFill) / 255.0;\n#endif\n#if HAS_TEXT_HALO_RADIUS || HAS_TEXT_HALO_OPACITY\n    output.vTextHalo = vec2f(vertexInput.aTextHalo);\n#endif\n#if HAS_HIGHLIGHT_COLOR || HAS_HIGHLIGHT_OPACITY\n    highlight_setVarying(vertexInput, output);\n#endif\n#else\n#ifdef ENABLE_COLLISION\n    var visible = f32(vertexInput.aOpacity) == 255.0;\n#else\n    var visible = true;\n#endif\n    fbo_picking_setData(output, output.position.w, visible);\n#endif\n    return output;\n}";const RH=[],LH=[],DH=[],FH=[],HH=[],NH=[];function BH(e,t,n,i,s,o,a,l,h,c,u,f,g,m){const{tileRatio:A,tileResolution:w}=h,T=A/(w/c.getResolution())*(u/c.cameraToCenterDistance)*f;Z_(n,n,T),Z_(i,i,T),Z_(s,s,T),Z_(o,o,T),ZA(RH,n[0],n[1],g?n[2]/m:0),ZA(LH,i[0],i[1],g?i[2]/m:0),ZA(DH,s[0],s[1],g?s[2]/m:0),ZA(FH,o[0],o[1],g?o[2]/m:0),XA(RH,RH,t),XA(LH,LH,t),XA(DH,DH,t),XA(FH,FH,t),sF(n,RH,a,c.width,c.height),sF(i,LH,a,c.width,c.height),sF(s,DH,a,c.width,c.height),sF(o,FH,a,c.width,c.height),U_(HH,Math.min(n[0],i[0],s[0],o[0]),Math.min(n[1],i[1],s[1],o[1])),U_(NH,Math.max(n[0],i[0],s[0],o[0]),Math.max(n[1],i[1],s[1],o[1])),Sy(e,HH[0]+l[0],HH[1]+l[1],NH[0]+l[0],NH[1]+l[1])}function zH(e,t,n,i,s,o,a,l){1!==l&&(Z_(n,n,l),Z_(i,i,l),Z_(s,s,l),Z_(o,o,l)),U_(HH,Math.min(n[0],i[0],s[0],o[0]),Math.min(n[1],i[1],s[1],o[1])),U_(NH,Math.max(n[0],i[0],s[0],o[0]),Math.max(n[1],i[1],s[1],o[1])),Sy(e,t[0]+HH[0]+a[0],t[1]+HH[1]-a[1],t[0]+NH[0]+a[0],t[1]+NH[1]-a[1])}function GH(e,t,n,i,s){t-=n*i,1===s&&(t+=n);const o=Math.sin(t),a=Math.cos(t);return Qm(e,a,-o,o,a)}const UH=15,VH=15,jH=2048,WH=24,qH=.01,ZH=[],XH=[],YH=[],JH=[],QH=[],$H=[],KH=[],eN=[],tN=[1,-1],nN=[1,1];function rN(e,t,n,i,s){const o=t.material.uniforms,a=s.cameraToCenterDistance,l=t.geometry.properties,h=this.getSymbol(l.symbolIndex),c=t.geometry.desc.positionSize,u=l.aAnchor,f=ZA(ZH,u[n*c],u[n*c+1],2===c?0:u[n*c+2]),{aTerrainAltitude:g}=l;if(g){const e=100*g[2*n];e&&(f[2]+=e)}let m=sF(XH,f,i,s.width,s.height);const A=m[2];let w=1;o.markerPerspectiveRatio&&(w=VL(.5+.5*(1-(1-a/A)*o.markerPerspectiveRatio),0,4));const{aShape:T,aMarkerDx:S,aMarkerDy:M,aMarkerWidth:C,aMarkerHeight:I,aPitchAlign:E,aRotationAlign:D,aRotation:H}=l,N=E?E[2*n]:o.markerPitchWithMap,B=D?D[2*n]:o.markerRotateWithMap,z=U_(eN,(S?S[n]:h.markerDx)||0,-((M?M[n]:h.markerDy)||0));let U=U_(JH,T[2*n]/10,T[2*n+1]/10),j=U_(QH,T[2*n+2]/10,T[2*n+3]/10),W=U_($H,T[2*n+4]/10,T[2*n+5]/10),q=U_(KH,T[2*n+6]/10,T[2*n+7]/10);0===o.flipY&&1===N&&(W_(U,U,tN),W_(j,j,tN),W_(W,W,tN),W_(q,q,tN));const[Z,X]=FF(t.geometry);let Y=C?C[n]:h.markerWidth;WL(Y)&&(Y=Z||UH);let J=I?I[n]:h.markerHeight;WL(J)&&(J=X||VH);const Q=U_(nN,Y/jH,J/jH);let $;rv(U,U,Q),rv(j,j,Q),rv(W,W,Q),rv(q,q,Q),$=H?H[2*n]/9362:-(h.markerRotation||0)*Math.PI/180;const K=-$,ee=s.getBearing()*Math.PI/180;if(ee*B||K){const e=GH(YH,K,ee,B,N);U=$_(U,U,e),j=$_(j,j,e),W=$_(W,W,e),q=$_(q,q,e)}1===N?BH(e,f,U,j,W,q,i,z,o,s,A,w):(W_(U,U,tN),W_(j,j,tN),W_(W,W,tN),W_(q,q,tN),zH(e,m,U,j,W,q,z,w));const te=this.getMap().getDevicePixelRatio();return 1!==te&&(e[0]*=te,e[1]*=te,e[2]*=te,e[3]*=te),e}const{PackUtil:iN}=eL(),sN=1,oN=[],aN=[],lN=[],hN=[],cN=[],uN=[],fN=[1,-1];function dN(e,t,n,i,s,o,a,l,h){const c=i.material.uniforms,u=h.cameraToCenterDistance,f=i.geometry.properties,g=this.getSymbol(f.symbolIndex),m="line"===g.textPlacement&&!eD(g),A=WH,w=n[2];let T=1;c.textPerspectiveRatio&&(T=VL(.5+.5*(1-(1-u/w)*c.textPerspectiveRatio),0,4));const{aTextDx:S,aTextDy:M,aPitchAlign:C,aRotationAlign:I,aRotation:E,aType:D,aDxDy:H}=i.geometry.properties;let N,B,z;H?(N=H[4*a+2],B=H[4*a+3]):(N=S?S[a]:g.textDx,B=M?M[a]:g.textDy),C&&(z=D?C[2*a+1]:C[a]);const U=C?z:c.textPitchWithMap;let j;I&&(j=D?I[2*a+1]:I[a]);const W=I?j:c.textRotateWithMap,q=U_(uN,N||0,-(B||0));if(m){const{aOffset:i,aShape:s}=f,o=i.length!==s.length;let u,g,m,A;if(o?(u=ZA(aN,i[3*a]/10,i[3*a+1]/10,i[3*a+2]/10),g=ZA(lN,i[3*a+3]/10,i[3*a+4]/10,i[3*a+5]/10),m=ZA(hN,i[3*a+6]/10,i[3*a+7]/10,i[3*a+8]/10),A=ZA(cN,i[3*a+9]/10,i[3*a+10]/10,i[3*a+11]/10)):(u=U_(aN,i[2*a]/10,i[2*a+1]/10),g=U_(lN,i[2*a+2]/10,i[2*a+3]/10),m=U_(hN,i[2*a+4]/10,i[2*a+5]/10),A=U_(cN,i[2*a+6]/10,i[2*a+7]/10)),1===U){const n=dL(h.getResolution(),h);BH(e,t,u,g,m,A,l,q,c,h,w,T,o,n)}else W_(u,u,fN),W_(g,g,fN),W_(m,m,fN),W_(A,A,fN),zH(e,n,u,g,m,A,q,T)}else{const{aShape:i}=f;let o,u=U_(aN,i[2*a]/10,-i[2*a+1]/10),S=U_(lN,i[2*a+2]/10,-i[2*a+3]/10),M=U_(hN,i[2*a+4]/10,-i[2*a+5]/10),C=U_(cN,i[2*a+6]/10,-i[2*a+7]/10);0===c.flipY&&1===U&&(W_(u,u,fN),W_(S,S,fN),W_(M,M,fN),W_(C,C,fN)),o=E?D&&E.length>D.length?E[2*a+1]/9362:E[a]/9362:(g.textRotation||0)*Math.PI/180;const I=m?0:h.getBearing()*Math.PI/180;if(o||I){const e=GH(oN,o,I,W,U);u=$_(u,u,e),S=$_(S,S,e),M=$_(M,M,e),C=$_(C,C,e)}const H=s/A;Z_(u,u,H),Z_(S,S,H),Z_(M,M,H),Z_(C,C,H),1===U?BH(e,t,u,S,M,C,l,q,c,h,w,T):zH(e,n,u,S,M,C,q,T)}e[0]-=(o=o||0)+sN,e[1]-=o+sN,e[2]+=o+sN,e[3]+=o+sN;const Z=this.getMap().getDevicePixelRatio();return 1!==Z&&(e[0]*=Z,e[1]*=Z,e[2]*=Z,e[3]*=Z),e}function pN(e,t,n){const i=t.geometry.desc.positionSize,{aAnchor:s,aAltitude:o,aTerrainAltitude:a}=t.geometry.properties,l=n*i;if(o?ZA(e,s[l],s[l+1],o[n]):3===i?iN.unpackPosition(e,s[l],s[l+1],s[l+2]):ZA(e,s[l],s[l+1],0),a){const t=100*a[2*n];t&&(e[2]+=t)}return e}const gN={textFill:[0,0,0,1],textOpacity:1,textPitchAlignment:0,textRotationAlignment:0,textHaloRadius:0,textHaloFill:[1,1,1,1],textHaloBlur:0,textHaloOpacity:1,textPerspectiveRatio:0,textSize:14,textDx:0,textDy:0,textRotation:0};function mN(e,t,n,i,s,o,a,l,h){const c=[];if(t.isDisposed()||0===t.data.aPosition.length)return c;const u=t.properties.glyphAtlas;if(!u)return c;if(0===i.textSize||0===i.textOpacity)return c;yN.call(this,t,i,o,a,l,h);const f=_N.call(this,{},e,t,s);let g=!1;s.textOpacity<1&&(g=!0),t.properties.memorySize=t.getMemorySize(),t.generateBuffers(e,{excludeElementsInVAO:!0});const m=new CM.Material(f,gN),A=new CM.Mesh(t,m,{disableVAO:!0,transparent:g,castShadow:!1,picking:!0});if(A.setLocalTransform(n),A.setUniform("alphaTest",qH),f.isHalo&&(A.properties.isHalo=!0),a&&A.setDefines({ENABLE_COLLISION:1}),c.push(A),f.isHalo){const e=AN.call(this,t,s,f.glyphTex,u,a,n);e.properties.haloMesh=A,c.push(e)}return c.forEach((e=>{const n=e.defines||{};vN.call(this,n,e),e.setDefines(n),e.properties.symbolIndex=t.properties.symbolIndex})),c}function AN(e,t,n,i,s,o){let a=!1;t.textOpacity<1&&(a=!0);const l={flipY:0,tileResolution:e.properties.tileResolution,tileRatio:e.properties.tileRatio,glyphTex:n,glyphTexSize:[i.width,i.height],isHalo:0};bN(e,l,t);const h=new CM.Material(l,gN),c=new CM.Mesh(e,h,{disableVAO:!0,transparent:a,castShadow:!1,picking:!0});return c.setUniform("alphaTest",qH),Object.defineProperty(c.properties,"textSize",{enumerable:!0,get:function(){return l.textSize}}),s&&c.setDefines({ENABLE_COLLISION:1}),c.setLocalTransform(o),c}function yN(e,t,n,i,s,o){VD(e,t,n,this.layer);const a=e.properties;if(!a.textInitialized){xN.call(this,e,i||o,s),a.textInitialized=!0;const{aTextSize:t,aTextDx:n,aTextDy:l,aPitchAlign:h,aRotationAlign:c,aRotation:u,aOverlap:f,aAltitude:g}=e.data;if(t){const e=(GD+"aTextSize").trim();a.aTextSize=a[e]||new t.constructor(t)}if(n){const e=(GD+"aTextDx").trim();a.aTextDx=a[e]||new n.constructor(n)}if(l){const e=(GD+"aTextDy").trim();a.aTextDy=a[e]||new l.constructor(l)}if(h){const e=(GD+"aPitchAlign").trim();a.aPitchAlign=a[e]||new h.constructor(h)}if(c){const e=(GD+"aRotationAlign").trim();a.aRotationAlign=a[e]||new c.constructor(c)}if(u){const e=(GD+"aRotation").trim();a.aRotation=a[e]||new u.constructor(u)}if(f){const e=(GD+"aOverlap").trim();a.aOverlap=a[e]||new f.constructor(f)}if(g){const e=(GD+"aAltitude").trim();a.aAltitude=a[e]||new g.constructor(g)}}}function _N(e,t,n,i){const s=n.properties.glyphAtlas,o=s&&RF(t,s,!1);return UL(e=e||{},{flipY:0,tileResolution:n.properties.tileResolution,tileRatio:n.properties.tileRatio,glyphTex:o||this._emptyTexture,glyphTexSize:[s&&s.width||0,s&&s.height||0]}),bN(n,e,i),e}function vN(e,t){const n=t.geometry;n.data.aTextFill&&(e.HAS_TEXT_FILL=1),n.data.aTextSize&&(e.HAS_TEXT_SIZE=1),n.data.aColorOpacity&&(e.HAS_OPACITY=1),n.data.aTextHaloFill&&t.material.uniforms.isHalo&&(e.HAS_TEXT_HALO_FILL=1);const i=this.getSymbolDef(n.properties.symbolIndex);eF(i.textHaloRadius)&&t.material.uniforms.isHalo&&(e.HAS_TEXT_HALO_RADIUS=1),eF(i.textHaloOpacity)&&t.material.uniforms.isHalo&&(e.HAS_TEXT_HALO_OPACITY=1),eF(i.textDx)&&(e.HAS_TEXT_DX=1),eF(i.textDy)&&(e.HAS_TEXT_DY=1),n.data.aPitchAlign&&(e.HAS_PITCH_ALIGN=1),eF(i.textRotationAlignment)&&(e.HAS_TEXT_ROTATION_ALIGN=1),n.data.aRotation&&(e.HAS_TEXT_ROTATION=1),n.data.aAltitude&&(e.HAS_ALTITUDE=1),n.properties.aOffset&&n.properties.aShape&&n.properties.aOffset.length!==n.properties.aShape.length&&(e.HAS_OFFSET_Z=1)}function xN(e,t,n){const i=e.properties,s=this.getSymbol(i.symbolIndex),o="line"===i.textPlacement&&!eD(s),{aPosition:a,aShape:l}=e.data,h=a.length/e.desc.positionSize;if(i.vertexCount=h,i.aPickingId=e.data.aPickingId,i.aCount||(i.aCount=e.data.aCount,delete e.data.aCount),t||o){let e=l;if(l.length===4*h){e=new l.constructor(2*h);for(let t=0;t<h;t++)e[2*t]=l[4*t],e[2*t+1]=l[4*t+1]}i.aAnchor=a,i.aShape=e}if(i.visElemts||(i.elements=e.elements,i.visElemts=new e.elements.constructor(e.elements.length)),o){const{aVertical:t,aSegment:n,aGlyphOffset:s,aPitchRotation:o}=e.data,a=!!o;i.aGlyphOffset=s,i.aPitchRotation=o,i.aSegment=n,i.aVertical=t,delete e.data.aSegment,delete e.data.aVertical,delete e.data.aGlyphOffset,delete e.data.aPitchRotation;const l=h*(a?3:2);e.data.aOffset={usage:"dynamic",data:new Int16Array(l)},i.aOffset=new Int16Array(l)}if(t){e.data.aOpacity={usage:"dynamic",data:new Uint8Array(h)},i.aOpacity=new Uint8Array(h),n&&(i.aOpacity.fill(255,0),e.data.aOpacity.data.fill(255,0));const{aTextHalo:t}=e.data;if(t&&!i.aTextHalo){const e=(GD+"aTextHalo").trim();i.aTextHalo=i[e]||new t.constructor(t)}}}function bN(e,t,n){void 0===t.isHalo&&(t.isHalo=1),ZL(t,"textOpacity",n,"textOpacity",gN.textOpacity),ZL(t,"textFill",n,"textFill",gN.textFill,JL()),ZL(t,"textHaloFill",n,"textHaloFill",gN.textHaloFill,JL()),ZL(t,"textHaloBlur",n,"textHaloBlur",gN.textHaloBlur),ZL(t,"textHaloRadius",n,"textHaloRadius",gN.textHaloRadius),ZL(t,"textHaloOpacity",n,"textHaloOpacity",gN.textHaloOpacity),ZL(t,"textPerspectiveRatio",n,"textPerspectiveRatio",gN.textPerspectiveRatio,(t=>"line"===e.properties.textPlacement?1:t)),ZL(t,"textRotateWithMap",n,"textRotationAlignment",gN.textRotationAlignment,(e=>+("map"===e))),ZL(t,"textPitchWithMap",n,"textPitchAlignment",gN.textPitchAlignment,(e=>+("map"===e))),ZL(t,"textSize",n,"textSize",gN.textSize),ZL(t,"textDx",n,"textDx",gN.textDx),ZL(t,"textDy",n,"textDy",gN.textDy),ZL(t,"textRotation",n,"textRotation",gN.textRotation,(e=>e*Math.PI/180))}function wN(e){const t=[];return{uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,n){return vA(t,n.projViewMatrix,n.modelMatrix)}},{name:"zoomScale",type:"function",fn:function(e,t){return t.tileResolution/t.resolution}}],extraCommandProps:{viewport:{x:0,y:0,width:()=>e?e.width:1,height:()=>e?e.height:1},stencil:{enable:!0,mask:255,func:{cmp:"<=",ref:(e,t)=>t.stencilRef,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},depth:{enable:!0,range:()=>this.sceneConfig.depthRange||[0,1],func:()=>this.sceneConfig.depthFunc||"always",mask:!1},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}}function TN(e,t){const n=CE(t.textFill),i=CE(t.textSize),s=CE(t.textHaloFill),o=CE(t.textHaloRadius),a=CE(t.textHaloOpacity),l=CE(t.textDx),h=CE(t.textDy),c=CE(t.textOpacity),u=PE(t.textPitchAlignment),f=PE(t.textRotationAlignment),g=CE(t.textRotation),m=PE(t.textAllowOverlapFn),A=PE(t.textIgnorePlacement),w={},T=new Int16Array(1),S=new Uint16Array(1);return[{attrName:"aTextFill",symbolName:"textFill",define:"HAS_TEXT_FILL",type:Uint8Array,width:4,evaluate:(t,i)=>{let s=n(e.getZoom(),t);return SE(s)&&(s=this.evaluateInFnTypeConfig(s,i,e,t,!0)),Array.isArray(s)||(s=w[s]=w[s]||oE(s).unitArray()),s=YL(s),s}},{attrName:"aTextSize",symbolName:"textSize",define:"HAS_TEXT_SIZE",type:Uint8Array,width:1,evaluate:(t,n)=>{let s=i(e.getZoom(),t)||gN.textSize;return SE(s)&&(s=this.evaluateInFnTypeConfig(s,n,e,t)),T[0]=s,T[0]}},{attrName:"aTextHaloFill",symbolName:"textHaloFill",define:"HAS_TEXT_HALO_FILL",type:Uint8Array,width:4,evaluate:t=>{let n=s(e.getZoom(),t);return Array.isArray(n)||(n=w[n]=w[n]||oE(n).unitArray()),n=YL(n),n}},{attrName:"aTextHalo",symbolName:"textHaloRadius",define:"HAS_TEXT_HALO_RADIUS",type:Uint8Array,index:0,width:2,evaluate:t=>{const n=o(e.getZoom(),t);return T[0]=n,T[0]}},{attrName:"aTextHalo",symbolName:"textHaloOpacity",define:"HAS_TEXT_HALO_OPACITY",type:Uint8Array,index:1,width:2,evaluate:t=>{const n=a(e.getZoom(),t);return T[0]=255*n,T[0]}},{attrName:"aTextDx",symbolName:"textDx",define:"HAS_TEXT_DX",type:Uint8Array,width:1,evaluate:(t,n)=>{let i=l(e.getZoom(),t);return SE(i)&&(i=this.evaluateInFnTypeConfig(i,n,e,t)),T[0]=i,T[0]}},{attrName:"aTextDy",symbolName:"textDy",define:"HAS_TEXT_DY",type:Uint8Array,width:1,evaluate:(t,n)=>{let i=h(e.getZoom(),t);return SE(i)&&(i=this.evaluateInFnTypeConfig(i,n,e,t)),T[0]=i,T[0]}},{attrName:"aColorOpacity",symbolName:"textOpacity",define:"HAS_OPACITY",type:Uint8Array,width:1,evaluate:(t,n)=>{let i=c(e.getZoom(),t);return SE(i)&&(i=this.evaluateInFnTypeConfig(i,n,e,t)),T[0]=255*i,T[0]}},{attrName:"aPitchAlign",symbolName:"textPitchAlignment",type:Uint8Array,width:1,define:"HAS_PITCH_ALIGN",evaluate:t=>+("map"===u(e.getZoom(),t))},{attrName:"aRotationAlign",symbolName:"textRotationAlignment",type:Uint8Array,width:1,define:"HAS_ROTATION_ALIGN",evaluate:t=>+("map"===f(e.getZoom(),t))},{attrName:"aRotation",symbolName:"textRotation",type:Uint16Array,width:1,define:"HAS_TEXT_ROTATION",evaluate:t=>{const n=jL(g(e.getZoom(),t),0,360)*Math.PI/180;return S[0]=9362*n,S[0]}},{attrName:"aOverlap",symbolName:"textAllowOverlap",type:Uint8Array,width:1,evaluate:n=>{let i=m(e.getZoom(),n)||0,s=(A?A(e.getZoom(),n):t.textIgnorePlacement)||0;return i=1<<3+4*i,s=(A?2:0)+s,i+s}},{attrName:"aOverlap",symbolName:"textIgnorePlacement",type:Uint8Array,width:1,evaluate:n=>{let i=(m?m(e.getZoom(),n):t.textAllowOverlap)||0,s=A(e.getZoom(),n)||0;return i=(m?8:0)+4*i,s=1<<1+s,i+s}}]}const SN=[],MN=[],CN=[],PN=[];function IN(e,t,n,i,s,o,a){e=1===e?1:0;const l=this.getMap(),h=t.geometry.properties,c=this.getSymbol(h.symbolIndex),u="line"===h.textPlacement&&!eD(c),{aTextSize:f,aTextHalo:g,aShape:m}=h;let A=f?f[n[s]]:c.textSize;null==A&&(A=gN.textSize);const w=g?g[2*n[s]]:t.properties.textHaloRadius,T=pN(CN,t,n[s]),{aProjectedAnchor:S}=t.geometry.properties;let M=PN;const C=3*n[s];S&&S[C]!==EL?(PN[0]=S[C],PN[1]=S[C+1],PN[2]=S[C+2]):M=sF(PN,T,a,l.width,l.height);const I=i,{boxes:E,collision:D}=this._getCollideBoxes(t,s);let H=0;if(u||1===t.material.uniforms.textRotateWithMap||c.textRotation){let i=0;for(let o=s;o<s+6*I;o+=6){const s=E[H]=E[H]||[];H++;const h=dN.call(this,s,T,M,t,A,w,n[o],a,l);if(!e){const t=this.isCollides(h);1===t?e=1:-1===t&&i++}}i===I&&(e=-1)}else{let i=n[s],h=m[2*i+1];for(let c=s;c<o;c+=6){const s=m[2*n[c]+1];if(h!==s||c===o-6){const u=n[c===o-6?c:c-6],f=dN.call(this,SN,T,M,t,A,w,i,a,l),g=dN.call(this,MN,T,M,t,A,w,u,a,l),m=E[H]=E[H]||[];H++,m[0]=Math.min(f[0],g[0]),m[1]=Math.min(f[1],g[1]),m[2]=Math.max(f[2],g[2]),m[3]=Math.max(f[3],g[3]),i=n[c],h=s,!e&&this.isCollides(m)&&(e=1)}}}return D.collides=e,D}function kN(e,t){const n=function(e,t){const{aPickingId:n,features:i}=e.geometry.properties,s=n[t],o=i&&i[s]&&i[s].feature;return o&&o.label}(e,t);return n?function(e,t,n){if(!n)return null;const i=e.localTransform,s=pN(ON,e,t);Sy(EN,s[0],s[1],s[2],1);const o=Ny(EN,EN,i);let a=0;for(const e of n)a+=e.codePointAt(0);return[Math.floor(o[0]),Math.floor(o[1]),Math.floor(o[2]),a]}(e,t,n):null}const ON=[],EN=[],RN=6,LN=4,DN=new Uint16Array(1),FN=new Int8Array(1);function HN(e,t,n,i,s,o,a,l,h){if(t.isDisposed()||0===t.data.aPosition.length)return null;const c=!!t.properties.glyphAtlas;if(!!!t.properties.iconAtlas&&!c&&!t.properties.isEmpty)return null;
//!geometry.properties.aShape 以避免重复创建collision数据
if(!t.properties.aShape){const{aPosition:e,aShape:n}=t.data,i=t.data.aPosition.length/t.desc.positionSize,s=new Uint8Array(i);l&&s.fill(255,0),t.data.aOpacity={usage:"dynamic",data:s},t.properties.aOpacity=new Uint8Array(i),l&&t.properties.aOpacity.fill(255,0),t.properties.aAnchor=e;const o=n.length/4,a=new n.constructor(2*o);for(let e=0;e<o;e++)a[2*e]=n[4*e],a[2*e+1]=n[4*e+1];t.properties.aShape=a}t.properties.visElemts||(t.properties.elements=t.elements,t.properties.visElemts=new t.elements.constructor(t.elements.length)),c&&yN.call(this,t,i,o.text,a,l,h),t.properties.memorySize=t.getMemorySize(),t.generateBuffers(e,{excludeElementsInVAO:!0});const u={flipY:0,tileResolution:t.properties.tileResolution,tileRatio:t.properties.tileRatio};BN.call(this,u,e,t,s),_N.call(this,u,e,t,s),u.isHalo=0;const f=[],g={disableVAO:!0,transparent:!0,castShadow:!1,picking:!0};let m;if(c){const e=UL({},u);e.isHalo=1;const i=new CM.Material(e);m=new CM.Mesh(t,i,g),m.properties.isHalo=1,m.setUniform("alphaTest",qH),m.setLocalTransform(n)}const A=new CM.Material(u),w=new CM.Mesh(t,A,g);let T={HAS_HALO_ATTR:1};if(a&&(T.ENABLE_COLLISION=1),zN.call(this,t,T),m){const e=UL({},T);vN.call(this,T,m),m.setDefines(e)}return c&&vN.call(this,T,w),T=UF(e,T),w.setDefines(T),w.setUniform("alphaTest",qH),w.setLocalTransform(n),w.properties.symbolIndex=t.properties.symbolIndex,f.push(w),f}function NN(e){const{aMarkerDx:t,aMarkerDy:n,aTextDx:i,aTextDy:s}=e.data,o=i||s||t||n;if(o){const a=new o.constructor(4*o.length);for(let e=0;e<a.length;e+=4){const o=e/4;t&&(a[e]=t[o]),n&&(a[e+1]=n[o]),i&&(a[e+2]=i[o]),s&&(a[e+3]=s[o])}e.data.aDxDy=a,e.properties.aDxDy=a.slice(),t&&(e.properties.aMarkerDx=t),n&&(e.properties.aMarkerDy=n),i&&(e.properties.aTextDx=i),s&&(e.properties.aTextDy=s)}}function BN(e,t,n,i){const[s,o]=FF(n);ZL(e,"markerOpacity",i,"markerOpacity",1),ZL(e,"markerPerspectiveRatio",i,"markerPerspectiveRatio",i.markerTextFit?0:1),ZL(e,"markerWidth",i,"markerWidth",s||UH),ZL(e,"markerHeight",i,"markerHeight",o||VH),ZL(e,"markerDx",i,"markerDx",0),ZL(e,"markerDy",i,"markerDy",0),ZL(e,"markerRotation",i,"markerRotation",0,(e=>e*Math.PI/180)),ZL(e,"markerPitchWithMap",i,"markerPitchAlignment",0,(e=>"map"===e?1:0)),ZL(e,"markerRotateWithMap",i,"markerRotationAlignment",0,(e=>"map"===e?1:0));const a=n.properties.iconAtlas;e.iconTex=a?RF(t,a,!1):this._emptyTexture,e.iconTexSize=a?[a.width,a.height]:[0,0]}function zN(e,t){e.data.aAltitude&&(t.HAS_ALTITUDE=1),e.data.aMarkerWidth&&(t.HAS_MARKER_WIDTH=1),e.data.aMarkerHeight&&(t.HAS_MARKER_HEIGHT=1),e.data.aColorOpacity&&(t.HAS_OPACITY=1);const n=this.getSymbolDef(e.properties.symbolIndex);eF(n.markerDx)&&(t.HAS_MARKER_DX=1),eF(n.markerDy)&&(t.HAS_MARKER_DY=1),eF(n.textDx)&&(t.HAS_TEXT_DX=1),eF(n.textDy)&&(t.HAS_TEXT_DY=1),eF(n.markerPitchAlignment)&&(t.HAS_MARKER_PITCH_ALIGN=1),eF(n.textPitchAlignment)&&(t.HAS_TEXT_PITCH_ALIGN=1),eF(n.markerRotationAlignment)&&(t.HAS_MARKER_ROTATION_ALIGN=1),eF(n.textRotationAlignment)&&(t.HAS_TEXT_ROTATION_ALIGN=1),eF(n.markerRotation)&&(t.HAS_MARKER_ROTATION=1),eF(n.textRotation)&&(t.HAS_TEXT_ROTATION=1),e.data.aPadOffset&&(t.HAS_PAD_OFFSET=1)}function GN(e,t){const n=CE(t.markerWidth),i=CE(t.markerHeight),s=CE(t.markerDx),o=CE(t.markerDy),a=CE(t.markerOpacity),l=CE(t.markerTextFit),h=PE(t.markerPitchAlignment),c=PE(t.textPitchAlignment),u=PE(t.markerRotationAlignment),f=PE(t.textRotationAlignment),g=CE(t.markerRotation),m=CE(t.textRotation),A=PE(t.markerAllowOverlapFn),w=PE(t.markerIgnorePlacement),T=CE(t.textOpacity),S=CE(t.textDx),M=CE(t.textDy),C=new Int16Array(1),I=new Uint16Array(1);return[{attrName:"aMarkerWidth",symbolName:"markerWidth",type:Uint16Array,width:1,define:"HAS_MARKER_WIDTH",evaluate:(i,s,o,a)=>{const h=o[a],c=t.markerTextFit,u=l?l(e.getZoom(),i):c;if("both"===u||"width"===u)return h;let f=n(e.getZoom(),i);return SE(f)&&(f=this.evaluateInFnTypeConfig(f,s,e,i)),C[0]=f,C[0]}},{attrName:"aMarkerHeight",symbolName:"markerHeight",type:Uint16Array,width:1,define:"HAS_MARKER_HEIGHT",evaluate:(n,s,o,a)=>{const h=o[a],c=t.markerTextFit,u=l?l(e.getZoom(),n):c;if("both"===u||"height"===u)return h;let f=i(e.getZoom(),n);return SE(f)&&(f=this.evaluateInFnTypeConfig(f,s,e,n)),C[0]=f,C[0]}},{attrName:"aDxDy",symbolName:"markerDx",type:Int8Array,width:4,index:0,define:"HAS_MARKER_DX",evaluate:(t,n,i,o)=>{let a=s(e.getZoom(),t);SE(a)&&(a=this.evaluateInFnTypeConfig(a,n,e,t));const{aMarkerDx:l}=n.properties;return l&&(l[o/4]=a),C[0]=a,C[0]}},{attrName:"aDxDy",symbolName:"markerDy",type:Int8Array,width:4,index:1,define:"HAS_MARKER_DY",evaluate:(t,n,i,s)=>{let a=o(e.getZoom(),t);SE(a)&&(a=this.evaluateInFnTypeConfig(a,n,e,t));const{aMarkerDy:l}=n.properties;return l&&(l[Math.floor(s/4)]=a),C[0]=a,C[0]}},{attrName:"aDxDy",symbolName:"textDx",type:Int8Array,width:4,index:2,define:"HAS_TEXT_DX",evaluate:(t,n,i,s)=>{let o=S(e.getZoom(),t);SE(o)&&(o=this.evaluateInFnTypeConfig(o,n,e,t));const{aTextDx:a}=n.properties;return a&&(a[Math.floor(s/4)]=o),C[0]=o,C[0]}},{attrName:"aDxDy",symbolName:"textDy",type:Int8Array,width:4,index:3,define:"HAS_TEXT_DY",evaluate:(t,n,i,s)=>{let o=M(e.getZoom(),t);SE(o)&&(o=this.evaluateInFnTypeConfig(o,n,e,t));const{aTextDy:a}=n.properties;return a&&(a[Math.floor(s/4)]=o),C[0]=o,C[0]}},{attrName:"aColorOpacity",symbolName:"markerOpacity",type:Uint8Array,width:2,index:0,define:"HAS_OPACITY",evaluate:(t,n)=>{let i=1;return a&&(i=a(e.getZoom(),t),SE(i)&&(i=this.evaluateInFnTypeConfig(i,n,e,t))),C[0]=255*i,C[0]}},{attrName:"aColorOpacity",symbolName:"textOpacity",type:Uint8Array,width:2,index:1,define:"HAS_OPACITY",evaluate:(t,n)=>{let i=1;return T&&(i=T(e.getZoom(),t),SE(i)&&(i=this.evaluateInFnTypeConfig(i,n,e,t))),C[0]=255*i,C[0]}},{attrName:"aPitchAlign",symbolName:"markerPitchAlignment",type:Uint8Array,width:2,index:0,define:"HAS_PITCH_ALIGN",evaluate:t=>+("map"===h(e.getZoom(),t))},{attrName:"aPitchAlign",symbolName:"textPitchAlignment",type:Uint8Array,width:2,index:1,define:"HAS_PITCH_ALIGN",evaluate:t=>+("map"===c(e.getZoom(),t))},{attrName:"aRotationAlign",symbolName:"markerRotationAlignment",type:Uint8Array,width:2,index:0,define:"HAS_MARKER_ROTATION_ALIGN",evaluate:t=>+("map"===u(e.getZoom(),t))},{attrName:"aRotationAlign",symbolName:"textRotationAlignment",type:Uint8Array,width:2,index:1,define:"HAS_TEXT_ROTATION_ALIGN",evaluate:t=>+("map"===f(e.getZoom(),t))},{attrName:"aRotation",symbolName:"markerRotation",type:Uint16Array,width:2,index:0,define:"HAS_MARKER_ROTATION",evaluate:t=>{const n=jL(g(e.getZoom(),t),0,360)*Math.PI/180;return I[0]=9362*n,I[0]}},{attrName:"aRotation",symbolName:"textRotation",type:Uint16Array,width:2,index:1,define:"HAS_TEXT_ROTATION",evaluate:t=>{const n=jL(m(e.getZoom(),t),0,360)*Math.PI/180;return I[0]=9362*n,I[0]}},{attrName:"aOverlap",symbolName:"markerAllowOverlap",type:Uint8Array,width:1,evaluate:n=>{let i=A(e.getZoom(),n)||0,s=(w?w(e.getZoom(),n):t.markerIgnorePlacement)||0;return i=1<<3+4*i,s=(w?2:0)+s,i+s}},{attrName:"aOverlap",symbolName:"markerIgnorePlacement",type:Uint8Array,width:1,evaluate:n=>{let i=(A?A(e.getZoom(),n):t.markerAllowOverlap)||0,s=w(e.getZoom(),n)||0;return i=(A?8:0)+4*i,s=2+s,i+s}}]}function UN(e,t,n){if(!t||!n||"none"===n)return;const{iconAtlas:i,glyphAtlas:s}=t.properties;if(!i||!s)return;!function(e){if(e.properties.iconElements)return;const t=[],n=[],i=e.elements,s=e.properties.aType;for(let e=0;e<i.length;e++){const o=i[e];0===s[o]?t.push(o):n.push(o)}e.properties.iconElements=new i.constructor(t),e.properties.textElements=new i.constructor(n)}(t);const o=function(e,t){let n=e.properties.textFitFn;SE(t)&&(n=e.properties.textFitFn=PE(t));const i="none"!==t,s=[],o=e.properties.iconElements,a=e.data.aPickingId,l=e.properties.textElements,h=e.data.aPickingId,c=e.properties.aCount,u=e.properties.features;let f,g=l[0];f={pickingId:h[g],start:0,end:c[g]*RN};let m=!1,A=!1,w=0;const T=new Set;for(let e=0;e<o.length;e+=RN){const g=a[o[e]];if(!m&&f)for(;f.pickingId<g&&f.end<l.length;){const e=f.end,t=l[e];f.start=e,f.end=e+c[t]*RN,f.pickingId=h[t]}if(!m&&f&&f.pickingId<g&&(m=!0,!i)){if(!A)return[];for(let t=e;t<o.length;t+=RN)s[w++]=[-1,-1];return s}const S=u[g]&&u[g].feature,M=n?n(null,S&&S.properties||{}):t;if(f&&g===f.pickingId){s[w++]=[f.start,f.end];const e=f.end,t=l[e];f.start=e,f.end=e+c[t]*RN,f.pickingId=h[t],A=!0}else if(M&&"none"!==M)for(let t=e;t<e+RN;t++)T.add(t);else s[w++]=[-1,-1]}if(T.size)if(T.size===o.length)e.setElements([]);else{const t=[];for(let e=0;e<o.length;e++)T.has(e)||t.push(o[e]);e.setElements(new o.constructor(t))}return A?s:[]}(t,n);if(t.getElements().length&&o.length&&(t.properties.labelIndex=o,o.length&&n&&"none"!==n)){const n=function(e){const t=[],n=e.properties.labelIndex,{aShape:i}=e.data;let s=!1;for(let o=0;o<n.length;o++){const[a,l]=n[o];if(-1===a)t.push(0,0,0,0);else{s=!0;let n=1/0,o=1/0,h=-1/0,c=-1/0;const u=e.properties.textElements;for(let e=a;e<l;e++){const t=u[e],s=i[4*t],a=i[4*t+1];s<n&&(n=s),s>h&&(h=s),a<o&&(o=a),a>c&&(c=a)}t.push(n,o,h,c)}}return s?t:[]}(t);n.length&&(t.properties.labelShape=n,VN.call(this,e,t))}}function VN(e,t){const n=this.getSymbolDef(t.properties.symbolIndex),i=n.markerTextFit,s=t.properties;let o="both"===i||"width"===i,a="both"===i||"height"===i;if(SE(n.markerTextFit)){let e=t.properties.textFitFn;e||(e=t.properties.textFitFn=CE(n.markerTextFit));const{features:i}=t.properties,l=t.properties.iconElements,{aPickingId:h}=t.data,c=[],u=[];let f=!0;for(let t=0;t<l.length;t+=RN){const n=i[h[l[t]]],s=(n&&n.feature||{}).properties||{};let o=e(null,s);SE(o)&&(o=(s.textFitFn=s.textFitFn||CE(o))(null,s)),"both"===o?(c.push(t/RN),u.push(t/RN)):"width"===o?(f=!1,c.push(t/RN)):"height"===o&&(f=!1,u.push(t/RN))}f?(s.fitIcons=c,o=!0,a=!0):(c.length&&(s.fitWidthIcons=c,o=!0),u.length&&(s.fitHeightIcons=u,a=!0))}s.aPickingId||(s.aPickingId=new t.data.aPickingId.constructor(t.data.aPickingId));const{aMarkerWidth:l,aMarkerHeight:h,aPickingId:c}=s,u=c.length;if(o)if(l){const e=t.data.aMarkerWidth;t.data.aMarkerWidth=new Uint16Array(e),s.aMarkerWidth=new Uint16Array(e);const n=(GD+"aMarkerWidth").trim();s[n]&&(s[n]=s.aMarkerWidth)}else{const e=this.getSymbol(t.properties.symbolIndex).markerWidth||0;s.aMarkerWidth=new Uint16Array(u),s.aMarkerWidth.fill(e),e&&(s.aMarkerWidth.dirty=!0),t.data.aMarkerWidth=new Uint16Array(u)}if(a)if(h){const e=t.data.aMarkerHeight;t.data.aMarkerHeight=new Uint16Array(e),s.aMarkerHeight=new Uint16Array(e);const n=(GD+"aMarkerHeight").trim();s[n]&&(s[n]=s.aMarkerHeight)}else{const e=this.getSymbol(t.properties.symbolIndex).markerHeight||0;s.aMarkerHeight=new Uint16Array(u),s.aMarkerHeight.fill(e),e&&(s.aMarkerHeight.dirty=!0),t.data.aMarkerHeight=new Uint16Array(u)}const f=this.getSymbolDef(t.properties.symbolIndex),g=CE(f.textSize);WN.call(this,e,t),(!SE(f.textSize)||g.isZoomConstant&&g.isFeatureConstant)&&(s.isFitConstant=!0)}const jN=[0,0,0,0];function WN(e,t){const n=t.properties;if(!n.glyphAtlas||!n.textElements||!n.textElements.length)return;const i=t.properties;if(i.isFitConstant||!i.labelShape||!i.labelShape.length)return;const s=this.getSymbolDef(t.properties.symbolIndex),o=s.textSize;let a;SE(o)&&(a=n._textSizeFn?n._textSizeFn:n._textSizeFn=CE(o));const l=s.markerTextFitPadding||jN;let h;SE(l)&&(h=i._paddingFn?i._paddingFn:i._paddingFn=PE(l));const c=e.getZoom(),{fitIcons:u,fitWidthIcons:f,fitHeightIcons:g}=i,{aMarkerWidth:m,aMarkerHeight:A,labelShape:w}=i,T=t.properties.iconElements,{features:S,aPickingId:M}=i,C=(e,t,n,s)=>{const u=w[4*t],f=w[4*t+1],g=w[4*t+2],T=w[4*t+3];if(!(u||f||g||T))return;const C=M[e],I=S[C]&&S[C].feature,E=I&&I.properties||{};let D=a?a(c,E):o;SE(D)&&(D=(E.textSizeFn=E.textSizeFn||CE(D))(c,E)),D/=WH;let H,N=h&&h(c,E)||l;if(SE(N)&&(N=(E.fitPaddingFn=E.fitPaddingFn||PE(N))(c,E)),N=N||jN,N[0]===N[2]&&N[1]===N[3]||(H=i.aPadOffset,H||(H=i.aPadOffset=new Int8Array(2*m.length))),m&&n){const t=Math.abs((g-u)/10*D)+(N[1]+N[3]||0);if(DN[0]=t,m[e]!==DN[0]&&($L(m,DN[0],e,e+LN),m.dirty=!0),H){const t=(N[1]+N[3])/2-N[3];if(FN[0]=t,H[2*e]!==FN[0]){for(let n=e;n<e+LN;n++)H[2*n]=t;H.dirty=!0}}}if(A&&s){const t=Math.abs((T-f)/10*D)+(N[0]+N[2]||0);if(DN[0]=t,A[e]!==DN[0]&&($L(A,DN[0],e,e+LN),A.dirty=!0),H){const t=N[0]-(N[0]+N[2])/2;if(FN[0]=t,H[2*e+1]!==FN[0]){for(let n=e;n<e+LN;n++)H[2*n+1]=t;H.dirty=!0}}}};if(u||f||g){if(u)for(let e=0;e<u.length;e++){const t=u[e];C(T[t*RN],t,!0,!0)}else if(f||g){if(f)for(let e=0;e<f.length;e++){const t=f[e];C(T[t*RN],t,!0,!1)}if(g)for(let e=0;e<g.length;e++){const t=g[e];C(T[t*RN],t,!1,!0)}}}else for(let e=0;e<T.length;e+=RN){C(T[e],e/RN,!0,!0)}const{aPadOffset:I}=i;I&&(t.data.aPadOffset=I)}const{FilterUtil:qN}=eL(),ZN=[],XN={collides:-1},YN=[jH,jH],JN=AA([]),QN=[];let $N=class Gr extends gi{static getBloomSymbol(){return["markerBloom","textBloom"]}constructor(e,t,n,i,s,o){super(e,t,n,i,s,o),this.propAllowOverlap="markerAllowOverlap",this.propIgnorePlacement="markerIgnorePlacement",this._fnTypeConfigs={},this.isLabelCollides=IN.bind(this),this._meshesToCheck=[],this._emptyTexture=e.texture(2)}needToRefreshTerrainTileOnZooming(){for(let e=0;e<this.symbolDef.length;e++){const t=this.symbolDef[e].markerPitchAlignment;if("map"===t||SE(t)||qN.isExpression(t))return!0}return!1}isTerrainVector(){return this.layer.options.awareOfTerrain&&!this.needToRefreshTerrainTileOnZooming()}isTerrainSkin(){return super.isTerrainSkin()&&this.needToRefreshTerrainTileOnZooming()}setShaderDefines(e){this._shaderDefines=e}createFnTypeConfig(e,t){const n=GN.call(this,e,t),i=TN.call(this,e,t);for(let e=i.length-1;e>=0;e--){const t=i[e].attrName;"aTextDx"!==t&&"aTextDy"!==t&&"aPitchAlign"!==t&&"aRotation"!==t&&"aRotationAlign"!==t&&"aColorOpacity"!==t&&"aOverlap"!==t||i.splice(e,1)}const s=n.concat(i);return s.text=i,s.icon=n,s}startFrame(...e){return this._meshesToCheck.length=0,super.startFrame(...e)}createGeometry(e,t){return e&&e.empty&&(e.data={aPosition:new Uint8Array(e.data.aPosition),aPickingId:e.data.aPickingId}),super.createGeometry(e,t)}postCreateGeometry(e){const{geometry:t,symbolIndex:n}=e,i=this.getSymbolDef(n),s=this.getFnTypeConfig(n),{iconAtlas:o,glyphAtlas:a}=t.properties;if(o||a){if(this._prepareRequiredProps(t),o&&(this.drawDebugAtlas(o),function(e,t,n,i){VD(e,t,n,i),function(e){const{aMarkerWidth:t,aMarkerHeight:n,aMarkerDx:i,aMarkerDy:s,aPitchAlign:o,aRotationAlign:a,aRotation:l,aOverlap:h}=e.data;if(t){const n=(GD+"aMarkerWidth").trim();e.properties.aMarkerWidth=e.properties[n]||new t.constructor(t)}if(n){const t=(GD+"aMarkerHeight").trim();e.properties.aMarkerHeight=e.properties[t]||new n.constructor(n)}if(i){const t=(GD+"aMarkerDx").trim();e.properties.aMarkerDx=e.properties[t]||new i.constructor(i)}if(s){const t=(GD+"aMarkerDy").trim();e.properties.aMarkerDy=e.properties[t]||new s.constructor(s)}if(o){const t=(GD+"aPitchAlign").trim();e.properties.aPitchAlign=e.properties[t]||new o.constructor(o)}if(a){const t=(GD+"aRotationAlign").trim();e.properties.aRotationAlign=e.properties[t]||new a.constructor(a)}if(l){const t=(GD+"aRotation").trim();e.properties.aRotation=e.properties[t]||new l.constructor(l)}if(h){const t=(GD+"aOverlap").trim();e.properties.aOverlap=e.properties[t]||new h.constructor(h)}}(e)}(t,i,s.icon,this.layer)),a){const e=i.markerTextFit;if(e){const n=this.getMap();UN.call(this,n,t,e)}}}else t.properties.isEmpty=!0}_prepareRequiredProps(e){const{aCount:t,aShape:n}=e.data;e.properties.aCount=t,delete e.data.aCount;const i=n.length/4,s=new Uint8Array(i),o=new Uint8Array(i);for(let e=0;e<i;e++)s[e]=n[4*e+2]%2,o[e]=n[4*e+3]%2;e.properties.aType=s,e.properties.aHalo=o,NN.call(this,e)}prepareCollideIndex(e){const{collideIds:t,elements:n,aCount:i,aType:s}=e.properties;if(!t)return;const o={};if(!n)return void(e.properties.collideBoxIndex=o);let a=0,l=n[0],h=0,c=t[l],u=s[0],f=1;i&&(f=i[n[h]]);for(let e=0;e<=n.length;e+=RN)if(l=n[e],t[l]!==c||u!==s[l]||e===n.length){o[c]||(o[c]=[]);let g=h;1===u&&(g=h+(e-h)/2),o[c].push([g,e,(e-g)/(f*RN),a++,h]),c=t[l],u=s[l],h=e,i&&(f=i[n[h]])}e.properties.collideBoxIndex=o}createMesh(e,t){const n=this.isEnableCollision(),i=this.layer,{geometry:s,symbolIndex:o}=e;s.properties.symbolIndex=o;const a=this.getSymbolDef(o),l=this.getSymbol(o),h=this.getFnTypeConfig(o),c=[],u=this.isEnableUniquePlacement(),f=HN.call(this,this.regl,s,t,a,l,h,i.options.collision,!n,u);if(f.length){const e=this.getAltitudeOffsetMatrix();f[0].positionMatrix=e,f[1]&&(f[1].positionMatrix=e),c.push(...f)}return"line"===s.properties.markerPlacement&&(this._rebuildCollideIds(s),c.forEach((e=>e.properties.isLinePlacement=!0))),this.prepareCollideIndex(s),c}_rebuildCollideIds(e){const t=this.layer instanceof Up,{collideIds:n,glyphAtlas:i,iconAtlas:s}=e.properties,o=new Uint16Array(n.length),a=!!i;if(s){const{collideIds:n,aType:s}=e.properties;if(i){let e=0,t=s[0],i=0;for(let a=1;a<n.length;a++)0===s[a]&&1===t&&(o.fill(e++,i,a),i=a),t=s[a];i<n.length&&o.fill(e++,i,n.length)}else{let e=0;for(let t=0;t<n.length;t+=LN)o.fill(e++,t,t+LN)}e.properties.collideIds=o,e.properties.uniqueCollideIds=nD(o,!t)}else if(a){const{collideIds:n,aCount:i}=e.properties;if(!i)return;let s=0,o=i[0];for(let e=0;e<n.length;){const t=e+o*LN;n.fill(s++,e,t),e+=o*LN,t<n.length&&(o=i[t])}e.properties.uniqueCollideIds=nD(n,!t)}}addMesh(e){if(this.isEnableCollision()&&e.length>0){const t=new _H(e);t.properties.uniqueCollideIds=e[0].geometry.properties.uniqueCollideIds,t.properties.meshKey=e[0].properties.meshKey,t.properties.level=e[0].properties.level,this._meshesToCheck.push(t)}for(let t=0;t<e.length;t++){if(!this.isMeshIterable(e[t]))continue;const n=e[t].geometry,{symbolIndex:i}=n.properties;eD(this.getSymbolDef(i))&&WN.call(this,this.getMap(),n)}const t=this.getMap().getZoom();for(let n=0;n<e.length;n++){if(!this.isMeshIterable(e[n]))continue;const i=e[n].geometry,{symbolIndex:s}=i.properties,o=this.getSymbolDef(s),a=this.getFnTypeConfig(s);ZD(this.regl,this.layer,o,a,e[n],t);const{aMarkerWidth:l,aMarkerHeight:h,aPadOffset:c}=i.properties;l&&l.dirty&&(i.updateData("aMarkerWidth",l),l.dirty=!1),h&&h.dirty&&(i.updateData("aMarkerHeight",h),h.dirty=!1),c&&c.dirty&&(i.updateData("aPadOffset",c),c.dirty=!1)}super.addMesh(...arguments)}limitMeshDefines(e){let t=e.defines;t=UF(this.regl,t),e.setDefines(t)}updateCollision(e){if(!this.isEnableCollision())return;super.updateCollision(e);const t=this.scene.getMeshes();t&&t.length?(this._updateIconCollision(e.timestamp),this._meshesToCheck=[],this._endCollision()):this._endCollision()}isMeshIterable(e){return e&&e.geometry&&!e.geometry.properties.isEmpty&&e.material&&this.isMeshVisible(e)&&!(this.shouldIgnoreBackground()&&!this.layer.getRenderer().isForeground(e))}_updateIconCollision(){if(!this.isEnableCollision())return;let e=this._meshesToCheck;e&&e.length&&this._updateIconAndText(e)}_updateBox(e,t,n,i){return this.updateBoxCollisionFading(!0,e,t,n,i)}isEnableUniquePlacement(){return this.isEnableCollision()&&!0===this.sceneConfig.uniquePlacement}_updateIconAndText(e){const t=this.layer.getRenderer();e=e.sort(KN);for(let n=0;n<e.length;n++){const i=e[n];if(!i||!i.meshes.length)continue;let s=!1;if(1===i.meshes.length)s=this.isMeshIterable(i.meshes[0]);else for(let e=0;e<i.meshes.length;e++)if(this.isMeshIterable(i.meshes[e])){s=!0;break}if(!s)continue;const o=t.isForeground(i.meshes[0]);if(this.shouldIgnoreBackground()&&!o)continue;const a=i.properties.meshKey;this.startMeshCollision(i),this._startCheckMesh(i),this.forEachBox(i,this._updateBox),this._endCheckMesh(i),this.endMeshCollision(a);for(let e=0;e<i.meshes.length;e++)this._updateOpacity(i.meshes[e])}}_updateOpacity(e){const t=e&&e.geometry&&e.geometry.properties.aOpacity;t&&t.dirty&&(e.geometry.updateData("aOpacity",t),t.dirty=!1)}forEachBox(e,t){const n=e.properties.uniqueCollideIds;if(!n)return;const i={boxIndex:0},s=n.length;for(let o=0;o<s;o++)this._iterateMeshBox(e,n[o],t,i)}_iterateMeshBox(e,t,n,i){const s=this.getMap(),{collideBoxIndex:o}=e.meshes[0].geometry.properties,a=o&&o[t];if(!a||!a.length)return!1;const l=vA(ZN,s.projViewMatrix,e.meshes[0].localTransform);let h,c=!1;const u=e.meshes;let f=0;for(let e=0;e<u.length;e++){if(!this.isMeshIterable(u[e]))continue;const{collideBoxIndex:n}=u[e].geometry.properties,i=n[t];i&&(f+=i.length)}if(!f)return!1;h=this._getMeshBoxes(f);let g=0;for(let e=0;e<u.length;e++){const n=u[e];if(!this.isMeshIterable(n))continue;c=!0;const i=n.geometry.properties,{elements:s,aCount:o,collideBoxIndex:a}=i,l=a[t];if(l)for(let e=0;e<l.length;e++){const[t,a,c]=l[e];let u=1;o&&(u=o[s[t]]);const f=t+0*u*RN;h[g].mesh=n,h[g].start=f,h[g].end=a,h[g].boxStart=l[e][4],h[g].boxCount=i.glyphAtlas?u:c,h[g].allElements=s,g++}}return!!c&&(n.call(this,e,h,l,i.boxIndex++)&&this._markerVisible(e,t),!0)}_startCheckMesh(e){const t=e.meshes;for(let e=0;e<t.length;e++){const n=t[e],i=n&&n.geometry;i&&(i.properties.visElemts.count=0)}}_markerVisible(e,t){const n=e.meshes;for(let e=0;e<n.length;e++){const i=n[e],s=i&&i.geometry;if(!s||s.properties.isEmpty)continue;const{collideBoxIndex:o,elements:a,visElemts:l}=s.properties,h=o[t];if(h&&h.length)for(let e=0;e<h.length;e++){const t=h[e][4],n=h[e][1];let i=l.count;for(let e=t;e<n;e++)l[i++]=a[e];l.count=i}}}_endCheckMesh(e){const t=e.meshes;for(let e=0;e<t.length;e++){const n=t[e],i=n&&n.geometry;if(!i)continue;const{visElemts:s}=i.properties;i.setElements(s,s.count)}}isBoxCollides(e,t,n,i,s,o){if(this._isTextGeo(e,t,i))return IN.call(this,0,e,t,n,i,s,o);if(e.geometry.properties.isEmpty)return XN;const{aTerrainAltitude:a}=e.geometry.properties;if(a&&a[2*t[i]]===RL)return XN;const l=this.getMap(),{boxes:h,collision:c}=this._getCollideBoxes(e,i);let u=0,f=0,g=0;for(let n=i;n<s;n+=RN){const i=h[g]=h[g]||[];g++;const s=rN.call(this,i,e,t[n],o,l);if(!u){const e=this.isCollides(s);1===e?u=1:-1===e&&f++}}return f===n&&(u=-1),c.collides=u,c}deleteMesh(e,t){e&&(e instanceof _H&&(e=e.meshes),t&&(Array.isArray(e)?e.forEach((e=>{e&&e.material&&delete e.material.uniforms.iconTex})):e.material&&delete e.material.uniforms.iconTex),super.deleteMesh(e,t))}isBloom(e){const t=e&&e.material&&!WL(e.material.get("markerOpacity")),n=this.getSymbol(e.properties.symbolIndex);return!!(t?n.markerBloom:n.textBloom)}isUniqueStencilRefPerTile(){return!1}init(){const e=this.canvas;this.renderer=new CM.Renderer(this.regl);const t={viewport:{x:(e,t)=>t.viewport?t.viewport.x:0,y:(e,t)=>t.viewport?t.viewport.y:0,width:(t,n)=>n.viewport?n.viewport.width:e?e.width:1,height:(t,n)=>n.viewport?n.viewport.height:e?e.height:1},stencil:{enable:!0,func:{cmp:"<=",ref:(e,t)=>t.stencilRef},op:{fail:"keep",zfail:"keep",zpass:"replace"}},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},depth:{enable:!0,range:()=>this.sceneConfig.depthRange||[0,1],func:()=>this.sceneConfig.depthFunc||"always",mask:!!WL(this.sceneConfig.depthMask)||this.sceneConfig.depthMask},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}};if(this.shader=new CM.MeshShader({name:"marker",vert:OH,frag:"#define SHADER_NAME MARKER\n#define HAS_HIGHLIGHT_COLOR_POINT 1\nprecision mediump float;\n#include <gl2_frag>\nuniform float alphaTest;\nuniform sampler2D iconTex;\nuniform lowp float markerOpacity;\nuniform lowp float blendSrcIsOne;\nuniform float layerOpacity;\n#include <highlight_frag>\nvarying vec2 vTexCoord;\nvarying float vOpacity;\nvarying float vIsText;\nvarying float vHalo;\n#include <text_render_frag>\nvoid main() {\n  vec4 c;\n  if(vIsText > .5) {\n    c = renderText(vTexCoord);\n  } else {\n    c = texture2D(iconTex, vTexCoord) * markerOpacity;\n  }\n  c = c * vOpacity * layerOpacity;\n  if(c.a < .05) {\n    discard;\n  }\n  glFragColor = c;\n  if(glFragColor.a < alphaTest) {\n    discard;\n  }\n  glFragColor = highlight_blendColor(glFragColor);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",wgslVert:EH,wgslFrag:"#define HAS_HIGHLIGHT_COLOR_POINT 1\nstruct MarkerFragUniforms {\n    alphaTest: f32,\n    markerOpacity: f32\n};\nstruct ShaderUniforms {\n    layerOpacity: f32\n}\n@group(0) @binding($b) var<uniform> uniforms: MarkerFragUniforms;\n@group(0) @binding($b) var<uniform> shaderUniforms: ShaderUniforms;\n@group(0) @binding($b) var iconTex: texture_2d<f32>;\n@group(0) @binding($b) var iconTexSampler: sampler;\n#include <highlight_frag>\nstruct VertexOutput {\n    @location($i) vTexCoord: vec2f,\n    @location($i) vOpacity: f32,\n    @location($i) vGammaScale: f32,\n    @location($i) vTextSize: f32,\n    @location($i) vHalo: f32,\n    @location($i) vIsText: f32,\n    #ifdef HAS_TEXT_FILL\n        @location($i) vTextFill: vec4f,\n    #endif\n    #ifdef HAS_TEXT_HALO_FILL\n        @location($i) vTextHaloFill: vec4f,\n    #endif\n    #if HAS_TEXT_HALO_RADIUS || HAS_TEXT_HALO_OPACITY\n        @location($i) vTextHalo: vec2f,\n    #endif\n}\n#include <text_render_frag>\n@fragment\nfn main(input: VertexOutput) -> @location(0) vec4f {\n    var fragColor: vec4f;\n    let isText = input.vIsText > 0.5;\n    let textColor = renderText(input);\n    let iconColor = textureSample(iconTex, iconTexSampler, input.vTexCoord) * uniforms.markerOpacity;\n    if (isText) {\n        fragColor = textColor;\n    } else {\n        fragColor = iconColor;\n    }\n    fragColor = fragColor * input.vOpacity * shaderUniforms.layerOpacity;\n    if (fragColor.a < 0.05) {\n        discard;\n    }\n    var color: vec4f;\n    color = fragColor;\n    if (color.a < uniforms.alphaTest) {\n        discard;\n    }\n    #if HAS_HIGHLIGHT_OPACITY || HAS_HIGHLIGHT_COLOR\n        return highlight_blendColor(color, input);\n    #else\n        return color;\n    #endif\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,t){return vA([],t.projViewMatrix,t.modelMatrix)}},{name:"zoomScale",type:"function",fn:function(e,t){return t.tileResolution/t.resolution}}],extraCommandProps:t,defines:this._shaderDefines||{}}),this.shader.version=300,this.pickingFBO){const e=new CM.FBORayPicking(this.renderer,{name:"marker-picking",vert:"#define PICKING_MODE 1\n"+OH,wgslVert:EH,defines:{PICKING_MODE:1},uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,t){return vA([],t.projViewMatrix,t.modelMatrix)}},{name:"zoomScale",type:"function",fn:function(e,t){return t.tileResolution/t.resolution}}],extraCommandProps:t},this.pickingFBO,this.getMap());this.picking=[e]}}getUniformValues(e,t){const n=t&&t.isRenderingTerrainSkin,i=this.layer.getTileSize().width,s=n?JN:e.projViewMatrix,o=e.cameraToCenterDistance,a=U_(QN,e.width,e.height);n&&U_(a,i,i);const l=this.getBlendFunc(),h=Zi.isFunction(l.src)?l.src():l.src;return{layerScale:this.layer.options.styleScale||1,mapPitch:e.getPitch()*Math.PI/180,mapRotation:e.getBearing()*Math.PI/180,projViewMatrix:s,cameraToCenterDistance:o,canvasSize:a,iconSize:YN,resolution:e.getResolution(),glyphSize:WH,gammaScale:1,blendSrcIsOne:+!("one"!==h&&1!==h),viewport:n&&t&&t.viewport,isRenderingTerrain:+!!n}}getUniqueEntryKey(e,t){if(!this._isTextGeo(e.geometry))return null;const{elements:n}=e.geometry.properties;return kN(e,n[t])}_isTextGeo(e,t,n){const{aType:i}=e.geometry.properties;return 1===i[t[n]]}delete(){return this._emptyTexture&&(CM.Util.isTextureDestroyed(this._emptyTexture)||this._emptyTexture.destroy(),this._emptyTexture=null),super.delete()}};function KN(e,t){return e.properties.level-t.properties.level||e.properties.meshKey-t.properties.meshKey}const eB=[],tB=[],nB=[];function rB(e,t,n,i,s,o,a,l,h,c,u,f,g){const{aGlyphOffset:m,aSegment:A,aTextDx:w,aTextDy:T,symbolIndex:S}=t.geometry.properties,M=this.getSymbol(S),C=U_(nB,(w?w[s]:M.textDx)||0,(T?T[s]:M.textDy)||0),I=U_(eB,m[2*s],m[2*s+1]),E=ZA(tB,A[3*s],A[3*s+1],A[3*s+2]),D=function(e,t,n,i,s,o,a,l,h,c,u,f,g,m,A,w,T,S){A||(A=i);const M=t.geometry.properties.line,C=o[0]*f,I=g?C-a:C+a;let E=I>0?1:-1,D=0;g&&(E*=-1,D=Math.PI),E<0&&(D+=Math.PI);const H=c+u,N=Math.abs(I);let B=E>0?h:h+1,z=rF.convert(i),U=rF.convert(i),j=rF.convert(s),W=rF.convert(s),q=0,Z=0;for(;q+Z<=N;){if(B+=E,B<c||B>=H)return null;U.x=z.x,U.y=z.y,W.x=j.x,W.y=j.y,z.x=n[3*B],z.y=n[3*B+1],j.x=M[3*B],j.y=M[3*B+1],q+=Z,Z=U.dist(z)/m}const X=(N-q)/Z,Y=w&&w.getRenderer(),J=Y&&Y.getTerrainHelper(),Q=t.properties.tile.terrainTileInfos;if(!S&&J){const{extent:n}=t.properties.tile,i=w.getTileSize().width/n,s=w.getMap();let o=j.sub(W).mult(X)._add(W);z=fF(oF,s,t,j,i,w,T,Q),U=fF(aF,s,t,W,i,w,T,Q),o=fF(lF,s,t,o,i,w,T,Q);const a=D+Math.atan2(z[1]-U[1],z[0]-U[0]);return e[0]=(o[0]-A[0])/m,e[1]=(o[1]-A[1])/m,e[2]=a,e}const $=z.sub(U),K=$.mult(X)._add(U);K._add($._unit()._perp()._mult(l*E));const ee=D+Math.atan2(z.y-U.y,z.x-U.x);return e[0]=(K.x-i[0])/m,e[1]=(K.y-i[1])/m,e[2]=ee,e}(e,t,i,o,a,I,C[0],C[1],E[0],E[1],E[2],n/24,h,l,c,u,f,g);return D}const iB=[],sB=[];function oB(e,t,n,i,s,o,a,l,h,c,u,f,g){const{aVertical:m}=n.geometry.properties,A=m[o];let w,T,S=rB.call(this,iB,n,i,s,o,l,h,c,!1);if(!S)return null;if(qA(e,S),S=rB.call(this,sB,n,i,s,a,l,h,c,!1),g=Math.PI*g/180,!S||Math.abs(S[2])>g)return null;if(qA(t,S),f&&($_(iB,iB,f),$_(sB,sB,f)),A){const e=Math.abs(sB[1]-iB[1]),t=Math.abs(sB[0]-iB[0])*u;T=iB[0]>sB[0]?1:0,e>t?(w=1,T=iB[1]<sB[1]?0:1):w=0}else w=0,T=iB[0]>sB[0]?1:0;return 2*T+w}var aB="#define SHADER_NAME TEXT_VERT\n#define RAD 0.0174532925\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec4 aShape;\n#ifdef ENABLE_COLLISION\nattribute float aOpacity;\n#endif\n#ifdef HAS_OPACITY\nattribute float aColorOpacity;\n#endif\n#ifdef HAS_TEXT_SIZE\nattribute float aTextSize;\n#else\nuniform float textSize;\n#endif\n#ifdef HAS_TEXT_DX\nattribute float aTextDx;\n#else\nuniform float textDx;\n#endif\n#ifdef HAS_TEXT_DY\nattribute float aTextDy;\n#else\nuniform float textDy;\n#endif\n#if defined(HAS_PITCH_ALIGN)\nattribute float aPitchAlign;\n#else\nuniform float textPitchWithMap;\n#endif\n#if defined(HAS_TEXT_ROTATION_ALIGN)\nattribute float aRotationAlign;\n#else\nuniform float textRotateWithMap;\n#endif\nuniform float flipY;\n#if defined(HAS_TEXT_ROTATION)\nattribute float aRotation;\n#else\nuniform float textRotation;\n#endif\nuniform float cameraToCenterDistance;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float textPerspectiveRatio;\nuniform vec2 glyphTexSize;\nuniform vec2 canvasSize;\nuniform float glyphSize;\nuniform float mapPitch;\nuniform float mapRotation;\nuniform float zoomScale;\nuniform float tileRatio;\nuniform float layerScale;\nuniform float isRenderingTerrain;\n#ifndef PICKING_MODE\nvarying vec2 vTexCoord;\nvarying float vGammaScale;\nvarying float vTextSize;\nvarying float vOpacity;\n#ifdef HAS_TEXT_FILL\nattribute vec4 aTextFill;\nvarying vec4 vTextFill;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nattribute vec4 aTextHaloFill;\nvarying vec4 vTextHaloFill;\n#endif\n#if defined(HAS_TEXT_HALO_RADIUS) || defined(HAS_TEXT_HALO_OPACITY)\nattribute vec2 aTextHalo;\nvarying vec2 vTextHalo;\n#endif\n#include <highlight_vert>\n#else\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n#ifdef HAS_TEXT_SIZE\nfloat d = aTextSize * layerScale;\n#else\nfloat d = textSize * layerScale;\n#endif\n#ifdef HAS_TEXT_DX\nfloat e = aTextDx;\n#else\nfloat e = textDx;\n#endif\n#ifdef HAS_TEXT_DY\nfloat f = aTextDy;\n#else\nfloat f = textDy;\n#endif\n#if defined(HAS_PITCH_ALIGN)\nfloat h = aPitchAlign;\n#else\nfloat h = textPitchWithMap;\n#endif\n#if defined(HAS_ROTATION_ALIGN)\nfloat i = aRotationAlign;\n#else\nfloat i = textRotateWithMap;\n#endif\ngl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);\n  float j = gl_Position.w;\n  float k;\n  if(isRenderingTerrain == 1. && h == 1.) {\n    k = 1.;\n  } else {\n    float l = (1. - cameraToCenterDistance / j) * textPerspectiveRatio;\n    k = clamp(.5 + .5 * (1. - l), .0, 4.);\n  }\n#ifdef HAS_TEXT_ROTATION\nfloat m = -aRotation / 9362. - mapRotation * i;\n#else\nfloat m = -textRotation - mapRotation * i;\n#endif\nif(h == 1.) {\n    \n#ifdef REVERSE_MAP_ROTATION_ON_PITCH\nm += mapRotation;\n#else\nm -= mapRotation;\n#endif\n  }\n  float n = sin(m);\n  float o = cos(m);\n  mat2 u = mat2(o, -1. * n, n, o);\n  vec2 v = aShape.xy / 10.0;\n  if(h == 1. && flipY == .0) {\n    v = v * vec2(1., -1.);\n  }\n  vec2 A = aShape.zw;\n  v = u * (v / glyphSize * d);\n  float B;\n  if(isRenderingTerrain == 1.) {\n    B = 1.;\n  } else {\n    B = j / cameraToCenterDistance;\n  }\n  if(h == .0) {\n    vec2 C = v * 2. / canvasSize;\n    gl_Position.xy += C * k * j;\n  } else {\n    float D;\n    if(isRenderingTerrain == 1.) {\n      D = tileRatio / zoomScale;\n    } else {\n      D = tileRatio / zoomScale * B * k;\n    }\n    vec2 C = v;\n    gl_Position = projViewModelMatrix * positionMatrix * vec4(c + vec3(C, .0) * D, 1.);\n  }\n  gl_Position.xy += vec2(e, -f) * 2. / canvasSize * j;\n#ifndef PICKING_MODE\nif(h == .0) {\n    vGammaScale = mix(1., B, textPerspectiveRatio);\n  } else {\n    vGammaScale = B + mapPitch / 4.;\n  }\n  vTexCoord = A / glyphTexSize;\n  vGammaScale = clamp(vGammaScale, .0, 1.);\n  vTextSize = d;\n#ifdef ENABLE_COLLISION\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity *= aColorOpacity / 255.;\n#endif\n#ifdef HAS_TEXT_FILL\nvTextFill = aTextFill / 255.;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nvTextHaloFill = aTextHaloFill / 255.;\n#endif\n#if defined(HAS_TEXT_HALO_RADIUS) || defined(HAS_TEXT_HALO_OPACITY)\nvTextHalo = aTextHalo;\n#endif\nhighlight_setVarying();\n#else\n#ifdef ENABLE_COLLISION\nbool E = aOpacity == 255.;\n#else\nbool E = true;\n#endif\nfbo_picking_setData(gl_Position.w, E);\n#endif\n}",lB="#define SHADER_NAME TEXT_LINE\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec2 aTexCoord;\n#ifdef HAS_OFFSET_Z\nattribute vec3 aOffset;\nuniform float altitudeScale;\n#else\nattribute vec2 aOffset;\n#endif\n#ifdef ENABLE_COLLISION\nattribute float aOpacity;\n#endif\n#ifdef HAS_OPACITY\nattribute float aColorOpacity;\n#endif\n#ifdef HAS_TEXT_SIZE\nattribute float aTextSize;\n#else\nuniform float textSize;\n#endif\n#ifdef HAS_TEXT_DX\nattribute float aTextDx;\n#else\nuniform float textDx;\n#endif\n#ifdef HAS_TEXT_DY\nattribute float aTextDy;\n#else\nuniform float textDy;\n#endif\n#if defined(HAS_PITCH_ALIGN)\nattribute float aPitchAlign;\n#else\nuniform float textPitchWithMap;\n#endif\nuniform float zoomScale;\nuniform float cameraToCenterDistance;\nuniform mat4 projViewModelMatrix;\nuniform float textPerspectiveRatio;\nuniform float mapPitch;\nuniform vec2 glyphTexSize;\nuniform vec2 canvasSize;\nuniform float tileRatio;\nuniform float layerScale;\nuniform float isRenderingTerrain;\nuniform float textPitchFilter;\n#ifndef PICKING_MODE\nvarying vec2 vTexCoord;\nvarying float vGammaScale;\nvarying float vTextSize;\nvarying float vOpacity;\n#ifdef HAS_TEXT_FILL\nattribute vec4 aTextFill;\nvarying vec4 vTextFill;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nattribute vec4 aTextHaloFill;\nvarying vec4 vTextHaloFill;\n#endif\n#if defined(HAS_TEXT_HALO_RADIUS) || defined(HAS_TEXT_HALO_OPACITY)\nattribute vec2 aTextHalo;\nvarying vec2 vTextHalo;\n#endif\n#include <highlight_vert>\n#else\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n#ifdef HAS_TEXT_DX\nfloat d = aTextDx;\n#else\nfloat d = textDx;\n#endif\n#ifdef HAS_TEXT_DY\nfloat e = aTextDy;\n#else\nfloat e = textDy;\n#endif\n#ifdef HAS_TEXT_SIZE\nfloat f = aTextSize * layerScale;\n#else\nfloat f = textSize * layerScale;\n#endif\n#ifdef HAS_PITCH_ALIGN\nfloat h = aPitchAlign;\n#else\nfloat h = textPitchWithMap;\n#endif\ngl_Position = projViewModelMatrix * vec4(c, 1.);\n  float i = gl_Position.w;\n  float j = i / cameraToCenterDistance;\n  float k;\n  if(isRenderingTerrain == 1.) {\n    k = 1.;\n  } else {\n    float l = (1. - cameraToCenterDistance / i) * textPerspectiveRatio;\n    k = clamp(.5 + .5 * (1. - l), .0, 4.);\n  }\n#ifdef HAS_OFFSET_Z\nvec3 m = aOffset / 10.0;\n  m[2] /= altitudeScale;\n#else\nvec3 m = vec3(aOffset / 10.0, .0);\n#endif\nvec2 n = aTexCoord;\n  if(h == 1.) {\n    float o;\n    if(isRenderingTerrain == 1.) {\n      o = tileRatio;\n    } else {\n      o = tileRatio / zoomScale * j * k;\n    }\n    m.xy *= o;\n    gl_Position = projViewModelMatrix * vec4(c + m, 1.);\n  } else {\n    gl_Position.xy += m.xy * 2. / canvasSize * k * i;\n  }\n  gl_Position.xy += vec2(d, -e) * 2. / canvasSize * i;\n  if(textPitchFilter > .0) {\n    if(textPitchFilter == 1. && h == .0 || textPitchFilter == 2. && h == 1.) {\n      gl_Position = vec4(-9999., -9999., .0, 1.);\n    }\n  }\n#ifndef PICKING_MODE\nif(h == 1.) {\n    vGammaScale = j + mapPitch / 4.;\n  } else {\n    vGammaScale = mix(1., j, textPerspectiveRatio);\n  }\n  vGammaScale = clamp(vGammaScale, .0, 1.);\n  vTexCoord = n / glyphTexSize;\n  vTextSize = f;\n#ifdef ENABLE_COLLISION\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity *= aColorOpacity / 255.;\n#endif\n#ifdef HAS_TEXT_FILL\nvTextFill = aTextFill / 255.;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nvTextHaloFill = aTextHaloFill / 255.;\n#endif\n#if defined(HAS_TEXT_HALO_RADIUS) || defined(HAS_TEXT_HALO_OPACITY)\nvTextHalo = aTextHalo;\n#endif\nhighlight_setVarying();\n#else\n#ifdef ENABLE_COLLISION\nbool u = aOpacity == 255.;\n#else\nbool u = true;\n#endif\nfbo_picking_setData(gl_Position.w, u);\n#endif\n}",hB="#define SHADER_NAME TEXT_FRAG\nprecision mediump float;\nuniform float layerOpacity;\nvarying vec2 vTexCoord;\nvarying float vOpacity;\nuniform float alphaTest;\n#include <text_render_frag>\n#include <highlight_frag>\nvoid main() {\n  gl_FragColor = renderText(vTexCoord) * vOpacity * layerOpacity;\n  if(gl_FragColor.a < alphaTest) {\n    discard;\n  }\n  gl_FragColor = highlight_blendColor(gl_FragColor);\n}";const{TextUtil:cB,PackUtil:uB,FilterUtil:fB,TEXT_MAX_ANGLE:dB}=eL(),pB=function(e){const t=this.layer.getRenderer();return!this._isHalo0(e)&&t.isTileNearCamera(e)&&"line"!==e.geometry.properties.textPlacement},gB=function(e){const t=this.layer.getRenderer();return!this._isHalo0(e)&&!t.isForeground(e)&&"line"!==e.geometry.properties.textPlacement},mB=function(e){const t=this.layer.getRenderer();return!this._isHalo0(e)&&t.isTileNearCamera(e)&&"line"===e.geometry.properties.textPlacement},AB=function(e){const t=this.layer.getRenderer(),n=e.properties.tile.z,i=t.getCurrentTileZoom();return!this._isHalo0(e)&&!t.isForeground(e)&&"line"===e.geometry.properties.textPlacement&&n<i},yB=[0,0,3],_B=[],vB=[],xB=[],bB=[],wB=[],TB=[],SB=[],MB=[],CB=[1,-1],PB=new Int16Array(3),IB=[],kB=[],OB=[],EB=[],RB=[],LB=[],DB=[],FB={},HB={},NB={},BB=[],zB=[],GB=AA([]),UB=[];class Eo extends gi{static getBloomSymbol(){return["textBloom"]}constructor(e,t,n,i,s,o){super(e,t,n,i,s,o),this.propAllowOverlap="textAllowOverlap",this.propIgnorePlacement="textIgnorePlacement",this.colorCache={},this._filter0=pB.bind(this),this._filter1=gB.bind(this),this._lineFilter0=mB.bind(this),this._lineFilter1=AB.bind(this),this.isLabelCollides=IN.bind(this),this._genTextNames()}prepareRender(...e){super.prepareRender(...e);const t=this.scene.getMeshes();if(t&&t.length)for(let e=0;e<t.length;e++){if(t[e].properties.isHalo)continue;const{haloMesh:n}=t[e].properties;n.dirtyDefines&&t[e].setDefines(n.defines)}}updateSymbol(...e){this._tagTerrainVector=void 0,this._tagTerrainSkin=void 0;const t=super.updateSymbol(...e);return this._genTextNames(),t}isTerrainVector(){if(!super.isTerrainSkin())return!1;if(void 0!==this._tagTerrainVector)return this._tagTerrainVector;for(let e=0;e<this.symbolDef.length;e++)if("map"!==this.symbolDef[e].textPitchAlignment)return this._tagTerrainVector=!0,!0;return this._tagTerrainVector=!1,!1}isTerrainSkin(){if(!super.isTerrainSkin())return!1;if(void 0!==this._tagTerrainSkin)return this._tagTerrainSkin;for(let e=0;e<this.symbolDef.length;e++){const t=this.symbolDef[e].textPitchAlignment;if("map"===t||SE(t)||fB.isExpression(t))return this._tagTerrainSkin=!0,!0}return this._tagTerrainSkin=!1,!1}_genTextNames(){this._textNameFn=[];for(let e=0;e<this.symbolDef.length;e++){const t=this.symbolDef[e];if(fB.isExpression(t.textName)){const n=fB.createExpression(t.textName,"string");this._textNameFn[e]=(e,t)=>{let i;FB.zoom=e,HB.properties=t;try{i=n.evaluateWithoutErrorHandling(FB,HB,NB,null,BB)}catch(e){i=null}return i}}else SE(t.textName)&&(this._textNameFn[e]=CE(t.textName))}}shouldDeleteMeshOnUpdateSymbol(e){if(!Array.isArray(e))return(0===e.textHaloRadius||0===this.symbolDef[0].textHaloRadius)&&e.textHaloRadius!==this.symbolDef[0].textHaloRadius;for(let t=0;t<e.length;t++)if(e[t]&&(0===e[t].textHaloRadius||0===this.symbolDef[t].textHaloRadius)&&e[t].textHaloRadius!==this.symbolDef[t].textHaloRadius)return!0;return!1}createFnTypeConfig(e,t){return TN(e,t)}isBloom(e){return!!this.getSymbol(e.properties.symbolIndex)[Eo.getBloomSymbol()[0]]}createGeometry(e,t,n){const i=e;if(!i.glyphAtlas)return null;const s=super.createGeometry(i,t);if(!s||!s.geometry)return null;const{geometry:o}=s;return o.properties.glyphAtlas&&this.drawDebugAtlas(o.properties.glyphAtlas),o&&i.lineVertex&&(o.properties.line=i.lineVertex,o.properties.line.id=n),s}createMesh(e,t,{tileVectorTransform:n}){const i=this.isEnableCollision(),s=this.isEnableUniquePlacement(),{geometry:o,symbolIndex:a}=e;o.properties.symbolIndex=a;const l=this.getSymbol(a),h=this.getSymbolDef(a),c=this.getFnTypeConfig(a),u=mN.call(this,this.regl,o,t,h,l,c,this.layer.options.collision,!i,s);return u.length&&("line"===o.properties.textPlacement?this._hasLineText=!0:this._hasNormalText=!0),u.forEach((e=>{e.positionMatrix=this.getAltitudeOffsetMatrix(),e.properties.tileVectorTransform=n})),u}updateCollision(e){super.updateCollision(e);const t=this.scene.getMeshes();t&&t.length?(this._projectedLinesCache={},this._updateLabels(e.timestamp),this._endCollision()):this._endCollision()}callCurrentTileShader(e,t){this.shader.filter=t.sceneFilter?[this._filter0,t.sceneFilter]:this._filter0,this.callRenderer(this.shader,e,t),this._shaderAlongLine.filter=t.sceneFilter?[this._lineFilter0,t.sceneFilter]:this._lineFilter0,this.callRenderer(this._shaderAlongLine,e,t)}callBackgroundTileShader(e,t){this.shader.filter=t.sceneFilter?[this._filter1,t.sceneFilter]:this._filter1,this.callRenderer(this.shader,e,t),this._shaderAlongLine.filter=t.sceneFilter?[this._lineFilter1,t.sceneFilter]:this._lineFilter1,this.callRenderer(this._shaderAlongLine,e,t)}callRenderer(e,t,n){n&&n.isRenderingTerrain&&SE(this.symbolDef.textPitchAlignment)&&(t.textPitchFilter=n.isRenderingTerrainSkin?1:2),super.callRenderer(e,t,n)}_updateLabels(){let e=this.scene.getMeshes();if(!e||!e.length)return;const t=-this.getMap().getBearing()*Math.PI/180,n=Km(xB,t),i=(e,t,n,i)=>{const{start:s,end:o,mesh:a,allElements:l}=t[0];if(this.updateBoxCollisionFading(!0,a,t,n,i)){let t=e.count;for(let n=s;n<o;n++)e[t++]=l[n];e.count=t}},s=this.isEnableCollision(),o=this.layer.getRenderer();e=e.sort(jB);for(let t=0;t<e.length;t++){const a=e[t];if(!this.isMeshIterable(a))continue;if(!o.isTileNearCamera(a)){const{visElemts:e}=a.geometry.properties;e&&(e.count=0),a.geometry.setElements(e,0);continue}const l=a.geometry,h=this.getSymbol(a.properties.symbolIndex);a.properties.textHaloRadius=WL(h.textHaloRadius)?gN.textHaloRadius:h.textHaloRadius;const c=a.properties.meshKey;if("line"===l.properties.textPlacement){if(!l.properties.line)continue;s&&this.startMeshCollision(a),this._updateLineLabel(a,n);const{aOffset:e,aOpacity:t}=l.properties;e.dirty&&(l.updateData("aOffset",e),e.dirty=!1),t&&t.dirty&&(l.updateData("aOpacity",t),t.dirty=!1),s&&this.endMeshCollision(c)}else if(s){this.startMeshCollision(a);const{elements:e,aOpacity:t,visElemts:n}=l.properties;n.count=0,this.forEachBox(a,((e,t,s,o,a)=>{i(n,t,s,o)})),t&&t.dirty&&l.updateData("aOpacity",t);n.count===e.length&&l.count===e.length||!n.count&&!l.count||l.setElements(n,n.count),this.endMeshCollision(c)}}}isMeshIterable(e){return e.isValid()&&e.material&&!e.material.get("isHalo")&&!(this.shouldIgnoreBackground()&&!this.layer.getRenderer().isForeground(e))}isMeshUniquePlaced(e){return!!this.isMeshIterable(e)&&"line"!==this.getSymbol(e.properties.symbolIndex).textPlacement}getUniqueEntryKey(e,t){return kN(e,t)}_updateLineLabel(e,t){const n=this.getMap(),i=e.geometry,s=i.properties;let o=s.line;if(!o)return;const a=n.getPitch(),l=n.getBearing(),{lineTextPitch:h,lineTextBearing:c}=e.properties,u=1===e.material.uniforms.textPitchWithMap,f=s.elements;if(!u){const t=vA(_B,n.projViewMatrix,e.localTransform),i=o.id+"-"+t.join();let a;this._projectedLinesCache[i]?o=this._projectedLinesCache[i]:(a=s.projectedLine=s.projectedLine||new Array(o.length),o=this._projectLine(a,o,t,n.width,n.height),this._projectedLinesCache[i]=a)}const g=this.isEnableCollision(),m=i.properties.visElemts=i.properties.visElemts||new f.constructor(f.length),A=i.properties.visCache=i.properties.visCache||[];g&&(m.count=0);const w=void 0===h||!n.isInteracting()||Math.abs(a-h)>2||Math.abs(l-c)>2;w&&(this._meshCollisionStale=!0),this.forEachBox(e,((e,n,i,s)=>{const{start:a,end:l}=n[0];let h=A[s];if((void 0===h||w)&&(h=this._updateLabelAttributes(e,f,a,l,o,i,u?t:null,s)),A[s]=h,g&&(h=this.updateBoxCollisionFading(h,e,n,i,s),h)){let e=m.count;for(let t=a;t<l;t++)m[e++]=f[t];m.count=e}})),w&&(e.properties.lineTextPitch=a,e.properties.lineTextBearing=l);const T=e.geometry.properties.aAltitude;T&&T.dirty&&(i.updateData("aAltitude",T),T.dirty=!1),!g||m.count===f.length&&i.count===m.count||i.setElements(m,m.count)}_projectLine(e,t,n,i,s){const o=function(e,t,n,i,s){for(let o=0;o<t.length;o+=3)Sy(iF,t[o],t[o+1],t[o+2],1),sF(iF,iF,n,i,s),e[o]=iF[0],e[o+1]=iF[1],e[o+2]=t[o+2];return e}(e,t,n,i,s);return o}forEachBox(e,t){const n=this.getMap(),i=vA(_B,n.projViewMatrix,e.properties.tileVectorTransform),{collideIds:s,aCount:o,features:a,elements:l}=e.geometry.properties;if(!s)return;const h=this.isEnableUniquePlacement(),c=this._getMeshBoxes(1);c[0].allElements=l,c[0].mesh=e;let u=0,f=l[0],g=0,m=s[f];for(let n=0;n<=l.length;n+=6)if(f=l[n],s[f]!==m||n===l.length){const A=a[m]&&a[m].feature;if(h&&this.isMeshUniquePlaced(e)&&A&&!A.label){const t=A.properties||{},{symbolIndex:n}=e.properties,i=n&&this._textNameFn[n.index]?this._textNameFn[n.index](e.properties.z,t):this.getSymbol(e.properties.symbolIndex).textName,s=cB.resolveText(i,t);A.label=s}const w=n,T=o[l[g]];for(let n=g;n<w;n+=6*T)c[0].start=n,c[0].end=n+6*T,c[0].boxCount=T,t.call(this,e,c,i,u++);m=s[f],g=n}}_updateLabelAttributes(e,t,n,i,s,o,a){const l=this.layer.getRenderer(),h=e.material.uniforms,c=1===h.textPitchWithMap,u=!c&&l.getTerrainHelper&&l.getTerrainHelper(),f=this.isEnableCollision(),g=this.getMap(),m=e.geometry,A=m.desc.positionSize,{aShape:w,aOffset:T,aAnchor:S,aAltitude:M,aPitchRotation:C}=m.properties;let{aProjectedAnchor:I}=m.properties;I||(I=m.properties.aProjectedAnchor=new Array(S.length/A*3));const E=m.properties.aTextSize,D=!a,H=t[n],N=H*A;let B;B=m.data.aAltitude?ZA(bB,S[N],S[N+1],M[H]):uB.unpackPosition(bB,S[N],S[N+1],S[N+2]);const z=sF(wB,B,o,g.width,g.height),U=m.properties.aTerrainAltitude;let j;if(U){const e=U[H];if(e===RL)return I[3*H]=EL,I[3*H+1]=EL,I[3*H+2]=EL,!1;e?(j=ZA(zB,...B),j[2]=100*e,j=sF(j,j,o,g.width,g.height)):j=z}else j=z;const W=g.getDevicePixelRatio();if(ky(UB,j,1/W),g.isOffscreen(UB))return f||VB(T,t,n,i),I[3*H]=EL,I[3*H+1]=EL,I[3*H+2]=EL,!1;D&&(B=z),I[3*H]=j[0],I[3*H+1]=j[1],I[3*H+2]=j[2];const q=D?1:m.properties.tileExtent/this.layer.getTileSize().width;let Z=!0;const X=t[n],Y=t[i-1],J=E?E[X]:e.properties.textSize,Q=this._updateNormal(e,J,s,X,Y,B,bB,q,a);if(null===Q)return VB(T,t,n,i),!1;const $=Y-X<=3,K=Math.floor(Q/2),ee=Q%2;for(let a=n;a<i;a+=6){const l=t[a];let g;if(g=K||a!==n||$||u?K||a!==i-6||$||u?rB.call(this,vB,e,J,s,l,B,bB,q,K,j,this.layer,o,c):DB:LB,!g){Z=!1,f||VB(T,t,n,i);break}let m=g[2];ee&&(m-=Math.PI/2);const A=GH(TB,m,0,h.textRotateWithMap,h.textPitchWithMap),S=T.length>w.length;let M;if(S){ZA(EB,C[3*l],C[3*l+1],0);const e=ry(EB,EB),t=-C[3*l+2];if(t){const n=$y(IB,e,t);TA(kB,yB),RA(OB,n),M=vA(OB,OB,kB)}}for(let e=0;e<4;e++){const t=2*(l+e);U_(SB,w[t]/10,w[t+1]/10),Z_(SB,SB,J/24),$_(SB,SB,A),c?(W_(SB,SB,CB),V_(MB,SB,g),S&&(MB[2]=0,M&&oy(MB,MB,M))):(W_(MB,g,CB),V_(MB,SB,MB)),PB[0]=10*MB[0],PB[1]=10*MB[1],S&&(PB[2]=10*MB[2]);const n=(S?3:2)*(l+e);(T[n]!==PB[0]||T[n+1]!==PB[1]||S&&T[n+2]!==PB[2])&&(T.dirty=!0,T[n]=PB[0],T[n+1]=PB[1],S&&(T[n+2]=PB[2]))}}return Z}_updateNormal(e,t,n,i,s,o,a,l,h){const c=s-i<=3,u=this.getMap(),f=this.getSymbol(e.geometry.properties.symbolIndex);return c?0:oB.call(this,LB,DB,e,t,n,i,s,o,a,l,u.width/u.height,h,f.textMaxAngle||dB)}isBoxCollides(e,t,n,i,s,o){return this.isLabelCollides(0,e,t,n,i,s,o)}deleteMesh(e,t){e&&(t&&(Array.isArray(e)?e.forEach((e=>{e&&e.material&&delete e.material.uniforms.texture})):e.material&&delete e.material.uniforms.texture),super.deleteMesh(e,t))}delete(){super.delete(),this._shaderAlongLine.dispose(),delete this._projectedLinesCache,this._linePicking&&this._linePicking.dispose()}isUniqueStencilRefPerTile(){return!1}isEnableTileStencil(){return!this.layer.getRenderer().isEnableWorkAround("win-intel-gpu-crash")}init(){this.renderer=new CM.Renderer(this.regl);const{uniforms:e,extraCommandProps:t}=wN.call(this,this.canvas,this.sceneConfig),n=this.canvas,i={x:(e,t)=>t.viewport?t.viewport.x:0,y:(e,t)=>t.viewport?t.viewport.y:0,width:(e,t)=>t.viewport?t.viewport.width:n?n.width:1,height:(e,t)=>t.viewport?t.viewport.height:n?n.height:1};t.viewport=i,this.shader=new CM.MeshShader({vert:aB,frag:hB,uniforms:e,extraCommandProps:t});let s=t;if(this.layer.getRenderer().isEnableWorkAround("win-intel-gpu-crash")&&(s=UL({},t),s.stencil=UL({},t.stencil),s.stencil.enable=!0,s.stencil.func.cmp="<",s.stencil.func.ref=(e,t)=>2*t.level+(t.isHalo||0)+1),this._shaderAlongLine=new CM.MeshShader({vert:lB,frag:hB,uniforms:e,extraCommandProps:s}),this.pickingFBO){const t=new CM.FBORayPicking(this.renderer,{vert:"#define PICKING_MODE 1\n"+aB,uniforms:e,extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap());t.filter=e=>"line"!==this.getSymbol(e.properties.symbolIndex).textPlacement;const n=new CM.FBORayPicking(this.renderer,{vert:"#define PICKING_MODE 1\n"+lB,uniforms:e,extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap());n.filter=e=>"line"===e.geometry.properties.textPlacement,this.picking=[t,n]}}getUniformValues(e,t){const n=t&&t.isRenderingTerrainSkin,i=this.layer.getTileSize().width,s=n?GB:e.projViewMatrix,o=e.cameraToCenterDistance,a=U_(RB,e.width,e.height);n&&U_(a,i,i);const l=dL(e.getResolution(),e);return{layerScale:this.layer.options.styleScale||1,mapPitch:e.getPitch()*Math.PI/180,mapRotation:e.getBearing()*Math.PI/180,projViewMatrix:s,viewMatrix:e.viewMatrix,cameraToCenterDistance:o,canvasSize:a,glyphSize:WH,gammaScale:1*(this.layer.options.textGamma||1),resolution:e.getResolution(),altitudeScale:l,viewport:n&&t&&t.viewport,textPitchFilter:0,isRenderingTerrain:+!!n}}}function VB(e,t,n,i){for(let s=n;s<i;s+=6){const n=t[s];for(let t=0;t<4;t++){const i=3*(n+t);(e[i]||e[i+1]||e[i+2])&&(e.dirty=!0,e[i]=0,e[i+1]=0,e[i+2]=0)}}}function jB(e,t){const n=e.properties.level-t.properties.level;return 0===n?e.properties.meshKey-t.properties.meshKey:n}var WB="#define SHADER_NAME NATIVE_POINT\n#include <gl2_vert>\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\n#ifdef HAS_COLOR\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float markerSize;\n#ifdef PICKING_MODE\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n  gl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);\n  gl_PointSize = markerSize;\n#ifdef HAS_COLOR\nvColor = aColor / 255.;\n#endif\n#ifdef PICKING_MODE\nfbo_picking_setData(gl_Position.w, true);\n#endif\n}";const qB={markerFill:[0,0,0],markerOpacity:1,markerSize:10};class zo extends OF{getPrimitive(){return this.isWebGPU()?"triangles":"points"}isTerrainSkin(){return!1}isTerrainVector(){return this.layer.options.awareOfTerrain}isUniqueStencilRefPerTile(){return!1}createMesh(e,t){const{geometry:n,symbolIndex:i,ref:s}=e,o=this.getSymbol(i);void 0===s&&(VD(n,this.getSymbolDef(i),this.getFnTypeConfig(i),this.layer),this.isWebGPU()||n.generateBuffers(this.regl));const a={};ZL(a,"markerOpacity",o,"markerOpacity",1),ZL(a,"markerSize",o,"markerSize",10),ZL(a,"markerFill",o,"markerFill","#000",JL(this.colorCache,3));const l=new CM.Material(a,qB);l.createDefines=()=>"square"!==o.markerType?{USE_CIRCLE:1}:null,l.appendDefines=e=>("square"!==o.markerType&&(e.USE_CIRCLE=1),e);const h={castShadow:!1,picking:!0};let c;if(this.isWebGPU()){const{aPosition:e,aAltitude:t}=n.data,i=new Int16Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),s=new CM.Geometry({aPosition:i},6,0,{positionSize:2});s.generateBuffers(this.regl),c=new CM.InstancedMesh({instancePosition:e,instanceAltitude:t},n.getVertexCount(),s,l,h),c.generateInstancedBuffers(this.regl)}else c=new CM.Mesh(n,l,h);const u={};return c.geometry.data.aAltitude&&(u.HAS_ALTITUDE=1),n.data.aColor&&(u.HAS_COLOR=1),c.setDefines(u),c.positionMatrix=this.getAltitudeOffsetMatrix(),c.setLocalTransform(t),c.properties.symbolIndex=i,c}createFnTypeConfig(e,t){const n=PE(t.markerFill);return[{attrName:"aColor",symbolName:"markerFill",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(t,i)=>{let s=n(e.getZoom(),t);return SE(s)&&(s=this.evaluateInFnTypeConfig(s,i,e,t,!0)),Array.isArray(s)||(s=this.colorCache[s]=this.colorCache[s]||oE(s).unitArray()),s=YL(s),s}}]}init(){this.renderer=new CM.Renderer(this.regl);const e=[],t={name:"vt-native-point",vert:WB,frag:"#define SHADER_NAME NATIVE_POINT\nprecision mediump float;\n#include <gl2_frag>\n#ifdef USE_CIRCLE\n#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#define STANDARD_DERIVATIVES_ENABLED 1\n#extension GL_OES_standard_derivatives : enable\n#endif\n#else\n#define STANDARD_DERIVATIVES_ENABLED 1\n#endif\n#endif\n#ifdef HAS_COLOR\nvarying vec4 vColor;\n#else\nuniform vec3 markerFill;\n#endif\nuniform float markerOpacity;\nuniform float layerOpacity;\nvoid main() {\n  float c = 1.;\n#ifdef USE_CIRCLE\nfloat r = .0, d = .0;\n  vec2 e = 2. * gl_PointCoord - 1.;\n  r = dot(e, e);\n  if(r > 1.) {\n    discard;\n  }\n#ifdef STANDARD_DERIVATIVES_ENABLED\nd = fwidth(r);\n  c = 1. - smoothstep(1. - d, 1. + d, r);\n#endif\n#endif\n#ifdef HAS_COLOR\nvec4 f = vColor;\n#else\nvec4 f = vec4(markerFill, 1.);\n#endif\nglFragColor = f * markerOpacity * c * layerOpacity;\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",wgslVert:"struct InstanceInput {\n    @location($i) aPosition: vec2i,\n#ifdef HAS_ALTITUDE\n    @location($i) instancePosition: vec2i,\n    @location($i) instanceAltitude: f32,\n#else\n    @location($i) instancePosition: vec4i,\n#endif\n#ifndef PICKING_MODE\n    #ifdef HAS_COLOR\n        @location($i) aColor: vec4u,\n    #endif\n#endif\n};\nstruct VertexInput {\n#ifdef HAS_ALTITUDE\n    aPosition: vec2i,\n    aAltitude: f32,\n#else\n    aPosition: vec4i,\n#endif\n}\nstruct VertexOutput {\n    @builtin(position) position: vec4f,\n    #ifndef PICKING_MODE\n        #ifdef HAS_COLOR\n            @location($o) vColor: vec4f,\n        #endif\n    #endif\n};\nstruct MarkerUniforms {\n    positionMatrix: mat4x4f,\n    projViewModelMatrix: mat4x4f,\n    markerSize: f32,\n};\n@group(0) @binding($b) var<uniform> uniforms: MarkerUniforms;\n@group(0) @binding($b) var<uniform> resolution: vec2f;\n#ifdef PICKING_MODE\n    #include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\n@vertex\nfn main(\n    input: InstanceInput\n) -> VertexOutput {\n    var out: VertexOutput;\n    var inputVertex: VertexInput;\n    inputVertex.aPosition = input.instancePosition;\n    #ifdef HAS_ALTITUDE\n        inputVertex.aAltitude = input.instanceAltitude;\n    #endif\n    let position = unpackVTPosition(inputVertex);\n    out.position = uniforms.projViewModelMatrix * uniforms.positionMatrix * vec4f(position, 1.0);\n    let markerSize = uniforms.markerSize / resolution;\n    let w = out.position.w;\n    out.position.x += f32(input.aPosition.x) * markerSize.x * w;\n    out.position.y += f32(input.aPosition.y) * markerSize.y * w;\n    #ifndef PICKING_MODE\n        #ifdef HAS_COLOR\n            out.vColor = input.aColor / 255.0;\n        #endif\n    #endif\n    #ifdef PICKING_MODE\n        fbo_picking_setData(w, true);\n    #endif\n    return out;\n}",wgslFrag:"struct MarkerFragmentUniforms {\n    markerOpacity: f32,\n    #ifndef HAS_COLOR\n        markerFill: vec3f,\n    #endif\n}\n@group(0) @binding($b) var<uniform> uniforms: MarkerFragmentUniforms;\n@group(0) @binding($b) var<uniform> layerOpacity: f32;\n#ifdef HAS_COLOR\nstruct VertexOuput {\n    @location($i) vColor: vec4f,\n}\n#endif\n@fragment\nfn main(\n    #ifdef HAS_COLOR\n    vertexOutput: VertexOuput,\n    #endif\n) -> @location(0) vec4f {\n    var alpha: f32 = 1.0;\n    #ifdef USE_CIRCLE\n    #endif\n    var pointColor: vec4f;\n    #ifdef HAS_COLOR\n        pointColor = vertexOutput.vColor;\n    #else\n        pointColor = vec4f(uniforms.markerFill, 1.0);\n    #endif\n    return pointColor * uniforms.markerOpacity * alpha * layerOpacity;\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,n){return vA(e,n.projViewMatrix,n.modelMatrix),e}}],defines:null,extraCommandProps:{viewport:{x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},depth:{enable:!0,mask:!1,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"always"},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"}}};if(this.shader=new CM.MeshShader(t),this.shader.version=300,this.pickingFBO){const e=[];this.picking=[new CM.FBORayPicking(this.renderer,{vert:"#define PICKING_MODE 1\n"+WB,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,n){return vA(e,n.projViewMatrix,n.modelMatrix),e}}],extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap())]}}getUniformValues(e){return{projViewMatrix:e.projViewMatrix,resolution:[this.canvas.width,this.canvas.height]}}}var ZB="#define SHADER_NAME NATIVE_LINE\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nuniform mat4 projViewModelMatrix;\nuniform mat4 positionMatrix;\n#ifndef PICKING_MODE\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#else\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n  gl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);\n#ifndef PICKING_MODE\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#endif\n#else\nfbo_picking_setData(gl_Position.w, true);\n#endif\n}",XB="struct VertexInput {\n#ifdef HAS_ALTITUDE\n    @location($i) aPosition: vec2i,\n    @location($i) aAltitude: f32,\n#else\n    @location($o) aPosition: vec4i,\n#endif\n#ifndef PICKING_MODE\n    #if HAS_COLOR\n        @location($i) aColor: vec4u,\n    #endif\n#endif\n}\nstruct MyAppUniforms {\n    projViewModelMatrix: mat4x4f,\n    positionMatrix: mat4x4f,\n};\n@group(0) @binding($b) var<uniform> uniforms: MyAppUniforms;\nstruct VertexOutput {\n    @builtin(position) position: vec4f,\n#ifndef PICKING_MODE\n    #if HAS_COLOR\n        @location($o) vColor: vec4f,\n    #endif\n#endif\n}\n#ifndef PICKING_MODE\n    #include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\n@vertex\nfn main(\n    vertexInput: VertexInput\n) -> VertexOutput {\n    var out: VertexOutput;\n    let position = unpackVTPosition(vertexInput);\n    out.position = uniforms.projViewModelMatrix * uniforms.positionMatrix * vec4f(position, 1.0);\n    #ifndef PICKING_MODE\n        #if HAS_COLOR\n            out.vColor = vertexInputWithColor.aColor / 255.0;\n        #endif\n    #else\n        fbo_picking_setData(vertexInput, &out, out.position.w, true);\n    #endif\n    return out;\n}";const YB=AA([]);class Bo extends OF{constructor(e,t,n,i,s,o){if(super(e,t,n,i,s,o),this.primitive="lines",SE(this.symbolDef.lineColor)){const e=t.getMap(),n=PE(this.symbolDef.lineColor);this.colorSymbol=t=>n(e.getZoom(),t)}}needPolygonOffset(){return!0}createMesh(e,t){const{geometry:n,symbolIndex:i,ref:s}=e,o=this.getSymbol(i),a=this.getMeshUniforms(n,o);void 0===s&&n.generateBuffers(this.regl);const l=new CM.Material(a),h=new CM.Mesh(n,l,{castShadow:!1,picking:!0});h.setLocalTransform(t),h.properties.symbolIndex=i;const c={};return h.geometry.data.aAltitude&&(c.HAS_ALTITUDE=1),h.setDefines(c),h}getMeshUniforms(e,t){const n={};return ZL(n,"lineColor",t,"lineColor","#000",JL(this.colorCache)),ZL(n,"lineOpacity",t,"lineOpacity",1),n}isEnableTileStencil(e){return!(e&&e.isRenderingTerrain&&this.isTerrainSkin())}init(){this.renderer=new CM.Renderer(this.regl);const e=this.canvas,t=[{name:"projViewModelMatrix",type:"function",fn:function(e,t){const n=[];return vA(n,t.projViewMatrix,t.modelMatrix),n}}],n={name:"vt-native-line",vert:ZB,frag:"#define SHADER_NAME NATIVE_LINE\nprecision mediump float;\nuniform float lineOpacity;\nuniform vec4 lineColor;\nuniform float layerOpacity;\n#if defined(HAS_COLOR)\nvarying vec4 vColor;\n#endif\nvoid main() {\n  gl_FragColor = lineColor * lineOpacity;\n#if defined(HAS_COLOR)\ngl_FragColor *= vColor;\n#endif\ngl_FragColor *= layerOpacity;\n}",wgslVert:XB,wgslFrag:"struct Uniforms {\n    lineOpacity: f32,\n    lineColor: vec4f,\n};\n@group(0) @binding($b) var<uniform> uniforms: Uniforms;\n@group(0) @binding($b) var<uniform> layerOpacity: f32;\n#if HAS_COLOR\n    struct VertexOuput {\n        @location(0) vColor: vec4f,\n    };\n#endif\n@fragment\nfn main(\n    #if HAS_COLOR\n        input: VertexOuput\n    #endif\n) -> @location(0) vec4f {\n    var outputColor: vec4f = uniforms.lineColor * uniforms.lineOpacity;\n    #if HAS_COLOR\n        outputColor *= input.vColor;\n    #endif\n    outputColor *= layerOpacity;\n    return outputColor;\n}",uniforms:t,defines:null,extraCommandProps:{viewport:{x:(e,t)=>t.viewport?t.viewport.x:0,y:(e,t)=>t.viewport?t.viewport.y:0,width:(t,n)=>n.viewport?n.viewport.width:e?e.width:1,height:(t,n)=>n.viewport?n.viewport.height:e?e.height:1},stencil:{enable:(e,t)=>this.isEnableTileStencil(t.painterContext),func:{cmp:()=>this.isOnly2D()?"=":"<=",ref:(e,t)=>t.stencilRef},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}};this.shader=new CM.MeshShader(n),this.pickingFBO&&(this.picking=[new CM.FBORayPicking(this.renderer,{wgslVert:XB,vert:ZB,uniforms:t,defines:{PICKING_MODE:1},extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap())])}getUniformValues(e,t){const n=t&&t.isRenderingTerrainSkin;return{projViewMatrix:n?YB:e.projViewMatrix,viewport:n&&t&&t.viewport}}getPrimitive(){return"lines"}}const{DEFAULT_TEX_WIDTH:JB}=eL(),QB=[1,1,1],$B=[1,1,1,1],KB=[0,0],ez=[1,1],tz=[],nz=new fl(0,0),rz=new fl(0,0),iz=[],sz=[];let oz=class es extends PF{isEnableTileStencil(){return!1}supportRenderMode(e){return this.isAnimating()?"fxaa"===e||"fxaaAfterTaa"===e:"taa"===e||"fxaa"===e}isTerrainSkin(){return!1}isTerrainVector(){return this.layer.options.awareOfTerrain}isAnimating(){return!1}createMesh(e,t,{tilePoint:n}){if(!this.material)return this.setToRedraw(),null;const{geometry:i,symbolIndex:s}=e,o=this.layer instanceof Up,a=new CM.Mesh(i,this.material);if(this.sceneConfig.animation){QB[2]=.01;const e=[];SA(e,QB),vA(e,t,e),t=e}const l=this.getSymbolDef(s),h=this.getFnTypeConfig(s);VD(i,l,h,this.layer);const c=this.getShader(),u=c.getGeometryDefines?c.getGeometryDefines(i):{},f=this.getSymbol(s),g=JL(this.colorCache);if(i.data.aExtrude){u.IS_LINE_EXTRUSION=1;const{tileResolution:e,tileRatio:t}=i.properties,n=this.getMap();Object.defineProperty(a.uniforms,"linePixelScale",{enumerable:!0,get:function(){return t*n.getResolution()/e}}),ZL(a.uniforms,"lineWidth",f,"lineWidth",4),ZL(a.uniforms,"lineOpacity",f,"lineOpacity",1),ZL(a.uniforms,"lineColor",f,"lineColor","#fff",g),Object.defineProperty(a.uniforms,"lineHeight",{enumerable:!0,get:()=>{const e=this.dataConfig.defaultAltitude*(this.dataConfig.altitudeScale||1);return KL(e)?e:0}})}else{ZL(a.uniforms,"polygonFill",f,"polygonFill",$B,g),ZL(a.uniforms,"polygonOpacity",f,"polygonOpacity",1);const e=[];Object.defineProperty(a.uniforms,"vertexColorsOfType",{enumerable:!0,get:()=>{const t=g(f.bottomPolygonFill||$B),n=g(f.topPolygonFill||$B);e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=n[0],e[5]=n[1],e[6]=n[2],e[7]=n[3];const i=a.geometry.properties.vertexColors;if(i){let t=8;e.length=8+i.length;for(let n=0;n<i.length;n++)e[t++]=i[n][0],e[t++]=i[n][1],e[t++]=i[n][2],e[t++]=i[n][3]}return e}})}if(i.data.aColor&&(u.HAS_COLOR=1),i.data.aOpacity&&(u.HAS_OPACITY=1),i.data.aLineWidth&&(u.HAS_LINE_WIDTH=1),i.data.aLineHeight&&(u.HAS_LINE_HEIGHT=1),i.data.aTerrainAltitude&&(u.HAS_TERRAIN_ALTITUDE=1),i.data.aVertexColorType){const e=a.geometry.properties.vertexColors;let t=2;e&&(t+=e.length),u.VERTEX_TYPES_COUNT=t}if(i.data.aOpacity){const e=i.data.aOpacity;for(let t=0;t<e.length;t++)if(e[t]<255){i.properties.hasAlpha=!0;break}}u.HAS_MIN_ALTITUDE=1,u.HAS_LAYER_OPACITY=1,i.generateBuffers(this.regl),a.setDefines(u),a.setPositionMatrix(this.getAltitudeOffsetMatrix()),a.setLocalTransform(t),(i.properties.maxAltitude<=0||a.properties.level>=3)&&(a.castShadow=!1),a.setUniform("maxAltitude",a.geometry.properties.maxAltitude),Object.defineProperty(a.uniforms,"minAltitude",{enumerable:!0,get:()=>this.layer.options.altitude||0});const{tileResolution:m}=i.properties,A=this.getMap(),w=this.layer.getRenderer(),T=A.pointAtResToCoord(new Re(n),m),S=function(e,t,n,i,s){return e.pointAtResToDistance(1,0,i,n)}(A,0,T,m),M=[];Object.defineProperty(a.uniforms,"uvOrigin",{enumerable:!0,get:()=>this._computeUVOffset(M,s,n,m,S,o)}),a.setUniform("uvOffset",[0,0]),Object.defineProperty(a.uniforms,"hasAlpha",{enumerable:!0,get:()=>{const e=this.getSymbol(s);return i.properties.hasAlpha||e.polygonOpacity<1||e.lineOpacity<1||a.material&&(a.material.uniforms.baseColorTexture||a.material.uniforms.emissiveTexture)}});const C=this.layer.getMap().getMaxNativeZoom();return Object.defineProperty(a.uniforms,"stencilRef",{enumerable:!0,get:()=>w.isForeground(a)?0:C-a.properties.tile.z}),a.properties.symbolIndex=s,a}_computeUVOffset(e,t,n,i,s,o){if(1===this.dataConfig.topUVMode)return e[0]=0,e[1]=0,e;const a=this.getMap(),l=this.getSymbol(t).material;let h=n;!this.dataConfig.side&&l&&l.textureOrigin&&(nz.set(l.textureOrigin[0],l.textureOrigin[1]),a.coordToPointAtRes(nz,i,rz),h=U_(iz,n[0]-rz.x,n[1]-rz.y));const c=!!l&&l.uvOffsetInMeter;let u=l&&l.uvOffset||KB;const f=this.getUVOffsetAnim();f&&(u=this.getUVOffset(f));const g=l&&l.uvScale||ez;let m=this.dataConfig.side?0:h[0],A=this.dataConfig.side?0:h[1];const w=l&&l.textureWidth||JB;c&&(m+=u[0]/s,A+=u[1]/s);const T=U_(e,m*s*g[0]/w+(c?0:u[0]),A*s*g[1]/(w*g[1]/g[0])+(c?0:u[1]));return o||(T[1]*=-1),T}callShader(e,t){const n=this.sceneConfig.cullFace;this.sceneConfig.cullFace="front",this.callBackgroundTileShader(e,t),void 0===n?delete this.sceneConfig.cullFace:this.sceneConfig.cullFace=n,super.callShader(e,t)}getShadowMeshes(){if(!this.isVisible())return tz;this.shadowCount=this.scene.getMeshes().length;const e=this.scene.getMeshes().filter((e=>0===e.properties.level));for(let t=0;t<e.length;t++){const n=e[t];n.material!==this.material&&n.setMaterial(this.material)}return e}getUVOffsetAnim(){const e=this.getSymbols()[0];return e.material&&e.material.uvOffsetAnim}getUVOffset(e){const t=this.getSymbols()[0],n=t.material&&t.material.uvOffset||KB,i=!!t.material&&t.material.uvOffsetInMeter,s=performance.now()/1e3,o=U_(sz,n[0],n[1]);return o[0]=s*e[0],o[1]=s*e[0],i||(o[0]%=1,o[1]%=1),o}needPolygonOffset(){return this._needPolygonOffset}startFrame(...e){return delete this._needPolygonOffset,super.startFrame(...e)}addMesh(e,t){e.forEach((e=>{this._prepareMesh(e,t)})),super.addMesh(...arguments)}_prepareMesh(e,t){if(null!==t){const n=e.localTransform;0===t&&(t=.01),QB[2]=t,SA(n,QB),vA(n,e.properties.tileTransform,n),e.setLocalTransform(n)}else e.setLocalTransform(e.properties.tileTransform);e.material!==this.material&&e.setMaterial(this.material),e.geometry.properties.maxAltitude<=0&&(this._needPolygonOffset=!0),e.ssr=this.getSymbol(e.properties.symbolIndex).ssr?1:0}deleteMaterial(){this.material&&(this.material.dispose(),delete this.material)}deleteMesh(e,t){if(e)if(this.scene.removeMesh(e),Array.isArray(e))for(let n=0;n<e.length;n++)t||(e[n].geometry.dispose(),delete e[n].geometry.properties.layer),e[n].dispose();else t||(e.geometry.dispose(),delete e.geometry.properties.layer),e.dispose()}updateDataConfig(e,t){return!("line-extrusion"===this.dataConfig.type&&!e.altitudeProperty&&!t.altitudeProperty)}createFnTypeConfig(e,t){const n=PE(t.polygonFill||t.lineColor),i=CE(t.polygonOpacity||t.lineOpacity),s=CE(t.lineWidth),o=new Uint8Array(1),a=new Uint16Array(1);return[{attrName:"aColor",type:Uint8Array,width:4,symbolName:t.polygonFill?"polygonFill":t.lineColor?"lineColor":"polygonFill",define:"HAS_COLOR",evaluate:(t,i)=>{let s=n(e.getZoom(),t);return SE(s)&&(s=this.evaluateInFnTypeConfig(s,i,e,t,!0)),Array.isArray(s)||(s=this.colorCache[s]=this.colorCache[s]||oE(s).unitArray()),s=YL(s),s}},{attrName:"aOpacity",type:Uint8Array,width:1,symbolName:t.polygonOpacity?"polygonOpacity":t.lineOpacity?"lineOpacity":"polygonOpacity",evaluate:(t,n)=>{let s=i(e.getZoom(),t);return SE(s)&&(s=this.evaluateInFnTypeConfig(s,n,e,t,!1)),o[0]=255*s,o[0]<255&&(n.properties.hasAlpha=!0),o[0]}},{attrName:"aLineWidth",type:Uint8Array,width:1,symbolName:"lineWidth",define:"HAS_LINE_WIDTH",evaluate:t=>{const n=s(e.getZoom(),t);return a[0]=Math.round(2*n),a[0]}}]}updateSymbol(e,t){let n=!1;e&&e.material&&(n=function(e,t){for(const n in t)if(lz[n]&&t[n]!==e[n]&&(!e[n]||!t[n]))return!0;return!1}(this.symbolDef[0].material||{},e.material));const i=super.updateSymbol(e,t);return e&&e.material&&this._updateMaterial(e.material),n||i}_isNeedRefreshStyle(e,t){return az(e)!==az(t)}};function az(e){if(!e||!e.material)return!1;for(const t in e.material)if(t.indexOf("Texture")>0&&e.material[t])return!0;return!1}const lz={normalTexture:1,bumpTexture:1},hz=CM.ShaderLib.get("mesh_picking_vert"),cz=CM.WgslShaderLib.get("mesh_picking").vert;let uz=class os extends oz{createGeometry(e){const t=e.data,n=this.getSymbols()[0];if(n.material&&n.material.extrusionOpacity){const e=new Uint8Array(t.aPosition.length/3);for(let n=0;n<t.aPosition.length;n+=3)e[n/3]=t.aPosition[n+2]>0?0:1;t.aExtrusionOpacity=e}const i=new CM.Geometry(t,e.indices);return UL(i.properties,e.properties),this._prepareFeatureIds(i,e),{geometry:i,symbolIndex:{index:0}}}updateSceneConfig(e){let t;if(this.sceneConfig.cullFace!==e.cullFace&&(t=!0),UL(this.sceneConfig,e),t){const e=this.getShaderConfig();this.shader.dispose(),this.shader=new CM.PhongShader(e)}this.setToRedraw()}getShader(){return this.shader}delete(e){this.getMap().off("updatelights",this._updateLights,this),super.delete(e),this.material.dispose()}init(){this.getMap().on("updatelights",this._updateLights,this);this.renderer=new CM.Renderer(this.regl);const e=this.getShaderConfig();this.shader=new CM.PhongShader(e),this._updateMaterial();const t={vert:this.getPickingVert(),wgslVert:this.getPickingWGSLVert(),uniforms:["projViewMatrix","modelMatrix","positionMatrix",{name:"projViewModelMatrix",type:"function",fn:function(e,t){return vA([],t.projViewMatrix,t.modelMatrix)}}],extraCommandProps:{viewport:this.pickingViewport}};this.picking=[new CM.FBORayPicking(this.renderer,t,this.layer.getRenderer().pickingFBO,this.getMap())]}_updateLights(){this.setToRedraw()}getShaderConfig(){const e=this.canvas,t={x:0,y:0,width:()=>e?e.width:1,height:()=>e?e.height:1};return{extraCommandProps:{cull:{enable:()=>void 0===this.sceneConfig.cullFace||!!this.sceneConfig.cullFace,face:()=>{let e=this.sceneConfig.cullFace;return!0===e&&(e="back"),e||"back"}},stencil:{enable:!0,func:{cmp:"<=",ref:(e,t)=>t.level},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},viewport:t,polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}}_updateMaterial(){this.material&&this.material.dispose();const e=this.layer instanceof Up,t=this.getSymbols()[0].material,n={};for(const i in t)tD(t,i)&&(n[i]=t[i],"uvRotation"===i&&(n[i]=n[i]*Math.PI/180,e||(n[i]*=-1)));this.material=new CM.PhongMaterial(n)}getUniformValues(e,t){const n=e.viewMatrix,i=e.projMatrix,s=e.cameraPosition,o=this._getLightUniformValues(),a=UL({viewMatrix:n,projMatrix:i,cameraPosition:s,projViewMatrix:e.projViewMatrix},o);a.halton=t&&t.jitter?t.jitter:[0,0];const l=this.layer.getRenderer().canvas;return a.outSize=[l.width,l.height],a}getPickingVert(){return hz}getPickingWGSLVert(){return cz}_getLightUniformValues(){const e=this.getMap().getLightManager(),t=e&&e.getAmbientLight()||{},n=e&&e.getDirectionalLight()||{};return{ambientColor:t.color||[.2,.2,.2],light0_diffuse:[...n.color||[.1,.1,.1],1],lightSpecular:n.specular||[.8,.8,.8],light0_viewDirection:n.direction||[1,1,-1]}}};const fz=[1,1,1];let dz=class as extends PF{createGeometry(e){const{data:t,indices:n}=e,i=new CM.Geometry(t,n,0,{primitive:"lines"});return i.generateBuffers(this.regl),{geometry:i,symbolIndex:{index:0}}}createMesh(e,t){const{geometry:n}=e,i=new CM.Mesh(n);if(i.castShadow=!1,this.sceneConfig.animation){fz[2]=.01;const e=[];SA(e,fz),vA(e,t,e),t=e}return i.setLocalTransform(t),i.properties.symbolIndex={index:0},i}addMesh(e,t){if(!e.length)return this;let n;null!==t?(0===t&&(t=.01),n=e[0].localTransform,fz[2]=t,SA(n,fz),vA(n,e[0].properties.tileTransform,n)):n=e[0].properties.tileTransform;for(let t=0;t<e.length;t++)e[t].setLocalTransform(n);return this.scene.addMesh(e),this}init(){const e=this.regl;this.scene=new CM.Scene,this.renderer=new CM.Renderer(e);const t={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},n={vert:"\n    attribute vec3 aPosition;\n    attribute vec4 aColor;\n\n    uniform mat4 projViewModelMatrix;\n    uniform vec2 outSize;\n\n    varying vec4 vColor;\n\n    void main()\n    {\n        gl_Position = projViewModelMatrix * vec4(aPosition, 1.0);\n        vColor = aColor / 255.0;\n    }\n",frag:"\n    #ifdef GL_ES\n        precision lowp float;\n    #endif\n\n    uniform float opacity;\n\n    varying vec4 vColor;\n\n    void main()\n    {\n        gl_FragColor = vColor * opacity;\n    }\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,t){const n=[];return vA(n,t.projViewMatrix,t.modelMatrix),n}}],extraCommandProps:{stencil:{enable:!0,func:{cmp:"<=",ref:(e,t)=>t.level},op:{fail:"keep",zfail:"keep",zpass:"replace"}},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},viewport:t}};this.shader=new CM.MeshShader(n)}getUniformValues(e){const t=this.sceneConfig.opacity||.3,n=this.layer.getRenderer().canvas;return{projViewMatrix:e.projViewMatrix,outSize:[n.width,n.height],opacity:t}}};const pz=CM.ShaderLib.get("mesh_picking_vert"),gz=CM.WgslShaderLib.get("mesh_picking").vert,{getPBRUniforms:mz}=CM.pbr.PBRUtils;let Az=class us extends oz{constructor(...e){super(...e),this._loader=new CM.ResourceLoader(null,this.layer.getURLModifier())}supportRenderMode(e){return this.getSymbols()[0].ssr?"fxaa"===e||"fxaaAfterTaa"===e:super.supportRenderMode(e)}isAnimating(){const e=this._getUVOffsetAnim();if(e&&(e[0]||e[1]))return!0}needToRedraw(){const e=this._getUVOffsetAnim();return!(!e||!e[0]&&!e[1])||super.needToRedraw()}_getUVOffsetAnim(){const e=this.getSymbols()[0];return e.material&&e.material.uvOffsetAnim}createGeometry(e){if(!e.data||!e.data.aPosition||!e.data.aPosition.length)return null;const t={uv0Attribute:"aTexCoord0"};e.data.aAltitude&&(t.altitudeAttribute="aAltitude");const n=new CM.Geometry(e.data,e.indices,0,t);return UL(n.properties,e.properties),e.vertexColors&&(n.properties.vertexColors=e.vertexColors),this.material.uniforms.normalTexture&&!n.data[n.desc.tangentAttribute]&&n.data[n.desc.uv0Attribute]&&(n.data[n.desc.normalAttribute]||n.createNormal(),n.createTangent()),this._prepareFeatureIds(n,e),{geometry:n,symbolIndex:{index:0}}}paint(e){const t=!!e.shadow;e.states&&e.states.includesChanged&&(this.shader.dispose(),delete this.shader,this._updateDepthShader.dispose(),delete this._updateDepthShader,this._createShader(e));let n=!!e.ssr&&this.getSymbols()[0].ssr;const i=this.shader,s=i.shaderDefines;if(n){const t=UL({},s,e.ssr.defines);i.shaderDefines=t}if(e.onlyUpdateDepthInTaa&&(this.shader=this._updateDepthShader,!n&&this._previousSSR&&(this.shader=i,this.setToRedraw(!0))),this.updateIBLDefines(i),super.paint(e),void 0!==this.shadowCount&&t){const e=this.scene.getMeshes().length;this.shadowCount!==e&&this.setToRedraw()}this.shader=i,n&&(i.shaderDefines=s),delete this.shadowCount,this._previousSSR=n}updateSceneConfig(e){UL(this.sceneConfig,e),this.setToRedraw()}delete(){super.delete(),this.disposeIBLTextures(),this.material.dispose(),this._updateDepthShader&&(this._updateDepthShader.dispose(),delete this._updateDepthShader)}init(e){this.getMap().on("updatelights",this._onUpdatelights,this),this.createIBLTextures(),this._context=this._context||e;this.renderer=new CM.Renderer(this.regl),this._bindedOnTextureLoad=this._onTextureLoad.bind(this),this._bindDisposeCachedTexture=this.disposeCachedTexture.bind(this),this._bindOnMaterialComplete=this._onMaterialComplete.bind(this),this._updateMaterial(),this._createShader(e);const t={vert:pz,wgslVert:gz,uniforms:[{name:"projViewModelMatrix",type:"function",fn:(e,t)=>vA([],t.projViewMatrix,t.modelMatrix)}],extraCommandProps:{viewport:this.pickingViewport,depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<=",mask:!!WL(this.sceneConfig.depthMask)||this.sceneConfig.depthMask}}};this.picking=[new CM.FBORayPicking(this.renderer,t,this.layer.getRenderer().pickingFBO,this.getMap())]}_createShader(e){const t={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},n={},i=[];i.push(...CM.SsrPass.getUniformDeclares()),this.fillIncludes(n,i,e);const s={cull:{enable:(e,t)=>!(t.geometryProperties.hasNegativeHeight||void 0!==this.sceneConfig.cullFace&&!this.sceneConfig.cullFace),face:()=>this.sceneConfig.cullFace||"back"},viewport:t,depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},blend:{enable:(e,t)=>void 0===t.hasAlpha||!!t.hasAlpha,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}},o={uniforms:i,defines:this._getDefines(n),extraCommandProps:s};this.shader=new CM.pbr.StandardShader(o),o.frag="\n            precision mediump float;\n            #include <gl2_frag>\n            void main() {\n                glFragColor = vec4(0.0);\n                #if __VERSION__ == 100\n                    gl_FragColor = glFragColor;\n                #endif\n            }\n        ",o.wgslFrag="\n            fn main() -> @location(0) vec4f {\n                return vec4f(0);\n            }\n        ",this._updateDepthShader=new CM.pbr.StandardShader(o)}_onTextureLoad({resources:e}){for(let t=0;t<e.length;t++)this.addCachedTexture(e[t].url,e[t].data);this.setToRedraw(!0)}_onMaterialComplete(){this.setToRedraw(!0)}_updateMaterial(e){if(e){const t=this.getSymbols()[0].material;t&&UL(t,e)}const t=this.layer instanceof Up,n=this.dataConfig,i=e||this.getSymbols()[0].material,s={};let o=!1;for(const e in i)if(tD(i,e))if(e.indexOf("Texture")>0){let t=i[e];if(!t){s[e]=void 0;continue}const a="string"==typeof t?t:t.url,l=this.getCachedTexture(a);l?l.then?a===t?t={promise:l,wrap:"repeat"}:t.promise=l:a===t?t={data:l,wrap:"repeat"}:t.data=l:a===t&&(t={url:a,wrap:"repeat"}),t.flipY=!n.upsideUpTexture,t.min="linear mipmap linear",t.mag="linear",s[e]=new CM.Texture2D(t,this._loader),s[e].once("complete",this._bindedOnTextureLoad),s[e].once("disposed",this._bindDisposeCachedTexture),s[e].promise&&this.addCachedTexture(a,s[e].promise),o=!0}else s[e]=i[e],"uvRotation"===e&&(s[e]=Math.PI*s[e]/180,t||(s[e]*=-1));if(void 0===s.alphaTest&&this.getMaterialClazz&&(s.alphaTest=.05),this.material){for(let e in s)this.material.set(e,s[e]);this.setToRedraw(!0)}else this.material=new CM.pbr.StandardMaterial(s),this.material.once("complete",this._bindOnMaterialComplete);o||this._onMaterialComplete()}getShader(){return this.shader}getUniformValues(e,t){const{iblTexes:n,dfgLUT:i}=this.getIBLRes(),s=mz(e,n,i,t&&t.ssr,t&&t.jitter);return this.setIncludeUniformValues(s,t),s}_getDefines(e){return this.hasIBL()?e.HAS_IBL_LIGHTING=1:delete e.HAS_IBL_LIGHTING,e}_onUpdatelights(){if(!this.shader)return;const e=this.shader.shaderDefines;this._getDefines(e),this.shader.shaderDefines=e}};var yz="#include <gl2_vert>\n#define EXTRUDE_SCALE 63.0\n#define EXTRUDE_MOD 64.0\n#define MAX_LINE_DISTANCE 65535.0\nuniform mat4 projViewModelMatrix;\nuniform mat4 positionMatrix;\nuniform vec2 centiMeterToLocal;\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec4 aTubeNormal;\n#ifdef HAS_LINE_WIDTH\nattribute float aLineWidth;\n#else\nuniform float lineWidth;\n#endif\n#include <vt_position_vert>\n#ifdef PICKING_MODE\n#include <fbo_picking_vert>\n#else\nuniform mat4 modelViewMatrix;\nuniform mat3 modelNormalMatrix;\nuniform mat4 modelMatrix;\n#if defined(HAS_PATTERN)\nuniform float resolution;\nuniform float tileResolution;\nuniform float tileRatio;\nattribute float aLinesofar;\nvarying highp float vLinesofar;\nattribute vec4 aTexInfo;\nvarying vec4 vTexInfo;\nvarying float vNormalY;\nvarying float vPatternHeight;\nattribute float aNormalDistance;\n#if defined(HAS_PATTERN_ANIM)\nattribute float aLinePatternAnimSpeed;\nvarying float vLinePatternAnimSpeed;\n#endif\n#if defined(HAS_PATTERN_GAP)\nattribute float aLinePatternGap;\nvarying float vLinePatternGap;\n#endif\n#endif\n#ifdef HAS_COLOR\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#ifdef HAS_OPACITY\nattribute float aOpacity;\n#endif\nvarying float vOpacity;\nvarying vec3 vModelNormal;\nvarying vec4 vViewVertex;\nvarying vec3 vModelVertex;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#include <highlight_vert>\nvoid main() {\n  \n#ifdef HAS_LINE_WIDTH\nfloat c = aLineWidth;\n#else\nfloat c = lineWidth;\n#endif\nfloat d = c / 2.;\n  vec3 e = aTubeNormal.xyz / EXTRUDE_SCALE;\n  vec3 f = unpackVTPosition();\n  vec4 h = vec4(f, 1.);\n  h.xy += e.xy * d * centiMeterToLocal;\n  h.z += e.z * d;\n  gl_Position = projViewModelMatrix * h;\n#ifdef PICKING_MODE\nfbo_picking_setData(gl_Position.w, true);\n#else\nvViewVertex = modelViewMatrix * h;\n  vec3 i = normalize(e);\n  vModelNormal = modelNormalMatrix * i;\n  vModelVertex = (modelMatrix * h).xyz;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(h);\n#endif\n#ifdef HAS_COLOR\nvColor = aColor / 255.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\n#ifdef HAS_PATTERN\nfloat j = tileResolution / resolution;\n  float k = aLinesofar - d * centiMeterToLocal.y * aNormalDistance / EXTRUDE_SCALE;\n  vLinesofar = k / tileRatio * j;\n  vTexInfo = vec4(aTexInfo.xy, aTexInfo.zw + 1.);\n  vPatternHeight = c * centiMeterToLocal.x / tileRatio * j;\n  vNormalY = aTubeNormal.w / EXTRUDE_SCALE;\n#if defined(HAS_PATTERN_ANIM)\nvLinePatternAnimSpeed = aLinePatternAnimSpeed / 127.;\n#endif\n#if defined(HAS_PATTERN_GAP)\nvLinePatternGap = aLinePatternGap / 10.0;\n#endif\n#endif\nhighlight_setVarying();\n#endif\n}";const{StyleUtil:_z}=eL(),{getPBRUniforms:vz}=CM.pbr.PBRUtils;let xz=class gs extends OF{needToRedraw(){return super.needToRedraw()||this.isAnimating()}isTerrainSkin(){return!1}isTerrainVector(){return!0}isUniqueStencilRefPerTile(){return!1}supportRenderMode(e){return this.isAnimating()?"fxaa"===e||"fxaaAfterTaa"===e:"taa"===e||"fxaa"===e}isAnimating(){if(this._hasPatternAnim)return!0;const e=this.getSymbols();for(let t=0;t<e.length;t++)if(e[t].linePatternFile&&e[t].linePatternAnimSpeed)return!0;return!1}isBloom(e){return!!this.getSymbol(e.properties.symbolIndex).lineBloom}createMesh(e,t){if(!e.geometry)return null;const n=this.getMap(),{geometry:i,symbolIndex:s,ref:o}=e,a=this.getSymbolDef(s);void 0===o&&VD(i,a,this.getFnTypeConfig(s),this.layer);const l=this.getSymbol(s),{tileResolution:h,tileRatio:c}=i.properties,u={tileResolution:h,tileRatio:c};ZL(u,"lineColor",l,"lineColor","#fff",JL(this.colorCache)),ZL(u,"linePatternGapColor",l,"linePatternGapColor",[1,1,1,1],JL(this.colorCache)),ZL(u,"lineWidth",l,"lineWidth",2,(e=>_z.getTubeSizeScale(this.dataConfig.metric)*e)),ZL(u,"lineOpacity",l,"lineOpacity",1),ZL(u,"linePatternAnimSpeed",l,"linePatternAnimSpeed",0),ZL(u,"linePatternGap",l,"linePatternGap",0),ZL(u,"metallicFactor",l,"metallicFactor",0),ZL(u,"roughnessFactor",l,"roughnessFactor",.4),ZL(u,"emissiveFactor",l,"emissiveFactor",[0,0,0]),ZL(u,"uvScale",l,"uvScale",[1,1]);const f=i.properties.iconAtlas,g=this.layer instanceof Up;f&&(u.linePatternFile=RF(this.regl,f,!1),u.atlasSize=f?[f.width,f.height]:[0,0],u.flipY=g?-1:1,this.drawDebugAtlas(f)),void 0===o&&i.generateBuffers(this.regl),u.alphaTest=-1;const m=new CM.pbr.StandardMaterial(u),A=new CM.Mesh(i,m,{castShadow:!1,picking:!0}),w=n.distanceToPointAtRes(100,100,i.properties.tileResolution)._multi(c/1e4).toArray();A.setUniform("centiMeterToLocal",w);const T=n.getResolution(n.getMaxNativeZoom());A.setUniform("animSpeedScale",h/T),A.setLocalTransform(t);const S={IS_LINE_EXTRUSION:1,HAS_LAYER_OPACITY:1};return"square-tube"===this.dataConfig.type&&(S.IS_SQUARE_TUBE=1),f&&(S.HAS_PATTERN=1),A.properties.symbolIndex=s,i.data.aColor&&(S.HAS_COLOR=1),this.setMeshDefines(S,i,a),i.data.aAltitude&&(S.HAS_ALTITUDE=1),A.setDefines(S),A}setMeshDefines(e,t,n){t.data.aOpacity&&(e.HAS_OPACITY=1),t.data.aLineWidth&&(e.HAS_LINE_WIDTH=1),eF(n.linePatternAnimSpeed)&&(e.HAS_PATTERN_ANIM=1),eF(n.linePatternGap)&&(e.HAS_PATTERN_GAP=1)}paint(e){e.states&&e.states.includesChanged.shadow&&(this.shader.dispose(),this.createShader(e)),super.paint(e)}init(e){this.getMap().on("updatelights",this._onUpdatelights,this),this.createIBLTextures();if(this.renderer=new CM.Renderer(this.regl),this.createShader(e),this.pickingFBO){const e=[];this.picking=[new CM.FBORayPicking(this.renderer,{vert:"#define PICKING_MODE 1\n"+yz,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,t){const n=[];return vA(n,t.projViewMatrix,t.modelMatrix),n}},{name:"modelNormalMatrix",type:"function",fn:(t,n)=>oA(e,n.modelMatrix)}],extraCommandProps:this.getExtraCommandProps()},this.pickingFBO,this.getMap())]}}createShader(e){this._context=e;const t=[],n={};this.fillIncludes(n,t,e),t.push({name:"projViewModelMatrix",type:"function",fn:function(e,t){const n=[];return vA(n,t.projViewMatrix,t.modelMatrix),n}}),this.shader=new CM.pbr.StandardShader({vert:yz,uniforms:t,defines:this._getDefines(n),extraCommandProps:this.getExtraCommandProps()})}getExtraCommandProps(){const e=this.canvas;return{viewport:{x:0,y:0,width:()=>e?e.width:1,height:()=>e?e.height:1},stencil:{enable:!0,func:{cmp:()=>"<=",ref:(e,t)=>t.level},op:{fail:"keep",zfail:"keep",zpass:"replace"}},cull:{enable:()=>!!this.sceneConfig.cullFace,face:this.sceneConfig.cullFace||"back"},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],mask:this.sceneConfig.depthMask||!0,func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}getUniformValues(e,t){const{iblTexes:n,dfgLUT:i}=this.getIBLRes(),s=vz(e,n,i,null,t&&t.jitter),o=e.viewMatrix;return s.projViewMatrix=e.projViewMatrix,s.viewMatrix=o,s.resolution=e.getResolution(),s.currentTime=this.layer.getRenderer().getFrameTimestamp()||0,this.setIncludeUniformValues(s,t),s}createFnTypeConfig(e,t){const n=PE(t.lineColor),i=PE(t.aLinePatternAnimSpeed),s=PE(t.aLinePatternGap),o=this.createShapeFnTypeConfigs(e,t),a=new Int8Array(2);return[{attrName:"aColor",symbolName:"lineColor",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(t,i)=>{let s=n(e.getZoom(),t);return SE(s)&&(s=this.evaluateInFnTypeConfig(s,i,e,t,!0)),Array.isArray(s)||(s=this.colorCache[s]=this.colorCache[s]||oE(s).unitArray()),s=YL(s),s}},{attrName:"aLinePattern",symbolName:"linePatternAnimSpeed",type:Int8Array,width:2,related:["linePatternGap"],define:"HAS_LINE_PATTERN",evaluate:(t,n,s,o)=>{let l=i(e.getZoom(),t);return WL(l)&&(l=0),0!==l&&(n.properties.hasPatternAnim=1),a[0]=l/127,a[1]=s[o+1],a}},{attrName:"aLinePattern",symbolName:"linePatternGap",type:Int8Array,width:2,related:["linePatternAnimSpeed"],define:"HAS_LINE_PATTERN",evaluate:(t,n,i,o)=>{let l=s(e.getZoom(),t);return WL(l)&&(l=0),a[1]=10*l,a[0]=i[o],a}}].concat(o)}createShapeFnTypeConfigs(e,t){const n=CE(t.lineWidth),i=CE(t.lineOpacity),s=new Uint16Array(1);return[{attrName:"aLineWidth",symbolName:"lineWidth",type:Uint8Array,width:1,define:"HAS_LINE_WIDTH",evaluate:(t,i)=>{let o=n(e.getZoom(),t);return SE(o)&&(o=this.evaluateInFnTypeConfig(o,i,e,t)),s[0]=Math.round(2*o),s[0]}},{attrName:"aOpacity",symbolName:"lineOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(t,n)=>{let o=i(e.getZoom(),t);return SE(o)&&(o=this.evaluateInFnTypeConfig(o,n,e,t)),s[0]=255*o,s[0]}}]}_getDefines(e){return this.hasIBL()?e.HAS_IBL_LIGHTING=1:delete e.HAS_IBL_LIGHTING,e}_onUpdatelights(){if(!this.shader)return;const e=this.shader.shaderDefines;this._getDefines(e),this.shader.shaderDefines=e}delete(){super.delete(),this.disposeIBLTextures(),this.shader&&(this.shader.dispose(),delete this.shader)}};const bz=CM.ShaderLib.get("mesh_picking_vert"),wz=CM.WgslShaderLib.get("mesh_picking").vert,{PackUtil:Tz}=eL(),Sz=[],Mz=[],Cz=[],Pz=[],Iz=[],kz=[],Oz=[],Ez=[0,0,0],Rz=[0,0,0],Lz=[1,1,1],Dz=[],Fz=[1,1,1,1],Hz=[],Nz=[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1],Bz=e=>class extends e{constructor(e,t,n,i,s,o){super(e,t,n,i,s,o),this._ready=!1;const a=i.fetchOptions||{};a.referrer=window&&window.location.href,this._gltfManager=e.gltfManager=e.gltfManager||new CM.GLTFManager(e,{fetchOptions:a,urlModifier:e=>{const n=t.getURLModifier();return n&&n(e)||e}}),this._initTRSFuncType(),this._initGLTF()}isUniqueStencilRefPerTile(){return!1}isAnimating(){const e=this.getSymbols();for(let t=0;t<e.length;t++)if(e[t]&&this._gltfPack[t]&&this._isSkinAnimating(t))return!0;return!1}createGeometry(e,t){const{data:n,positionSize:i}=e;return{geometry:{properties:UL({},e.properties),data:n,positionSize:i,features:t},symbolIndex:e.symbolIndex}}getFnTypeConfig(){return Dz}createMesh(e,t,{tileTranslationMatrix:n,tileExtent:i,tilePoint:s},{timestamp:o}){if(!this._ready)return null;const a=this.getMap(),{geometry:l}=e,{positionSize:h,features:c}=l;if(!l.data.aPosition||0===l.data.aPosition.length)return null;"native-line"===this.dataConfig.type&&this._arrangeAlongLine(0,l,s);const{aPosition:u}=l.data;let f=u.length/h;const g={instance_vectorA:new Float32Array(4*f),instance_vectorB:new Float32Array(4*f),instance_vectorC:new Float32Array(4*f),aPickingId:[]},m=this._updateInstanceData(g,n,i,l.properties.z,l.data,h,c);l.data.aTerrainAltitude&&(g.aTerrainAltitude=l.data.aTerrainAltitude);const A={},w=g.aPickingId,T=function(e){const t=new Map;for(let n=0;n<e.length;n++){const i=e[n];let s=t.get(i);s||(s=[],t.set(i,s)),s.push(n)}return t}(w);for(const e in g)A[e]={buffer:this.regl.buffer({dimension:g[e].length/f,data:g[e]}),divisor:1};const S=this._hasFuncType(),M=this._getMeterScale(),C=AA([]);bA(C,C,[M,M,M]);const I=[],E=this.getSymbols();for(let e=0;e<E.length;e++){const t=E[e],i=this._gltfMeshInfos[e];if(!i)continue;const s=this._gltfPack[e][0],{fixSizeOnZoom:h}=t;let c=AA([]);S||(c=this._getSymbolTRSMatrix(c));let u=0;i.forEach((e=>{const{geometry:n,nodeMatrix:i}=e;vA(Hz,Nz,i),vA(Hz,c,Hz);const s=vA(Hz,C,Hz),o=n.boundingBox.copy();o.transform(s);const a=this._calAnchorTranslation(o,t);Math.abs(a)>Math.abs(u)&&(u=a)}));const M=[0,0,u],D=i.map(((i,S)=>{const{geometry:I,materialInfo:E,morphWeights:D,extraInfo:H,nodeIndex:N}=i;t.alphaTest&&(E.alphaTest=t.alphaTest);const B=new(this.getMaterialClazz(E))(E),z={},U=new CM.InstancedMesh(A,f,I,B,{transparent:!1,picking:!0});if(s.hasSkinAnimation()){const t=this._updateAnimation(U,e,0)[N];U.setUniform("jointTexture",t.jointTexture),U.setUniform("jointTextureSize",t.jointTextureSize),U.setUniform("numJoints",t.numJoints),U.setUniform("skinAnimation",+this._isSkinAnimating(e)),U.properties.startTime=o,z.HAS_SKIN=1}D&&(U.setUniform("morphWeights",D),z.HAS_MORPH=1),U.setUniform("hasAlpha",H.alphaMode&&"BLEND"===H.alphaMode.toUpperCase()),ZL(U.uniforms,"polygonFill",t,"markerFill",Fz,JL(this.colorCache)),ZL(U.uniforms,"polygonOpacity",t,"markerOpacity",1);const j=[];U.setPositionMatrix((()=>{const t=this._getMeshNodeMatrix(e,S,N);vA(j,Nz,t),vA(j,c,j),vA(j,C,j);const n=AA(Hz);if(0!==u&&(TA(n,M),vA(j,n,j)),KL(h)){const e=a.getGLScale()/a.getGLScale(h);return ZA(Sz,e,e,e),SA(n,Sz),vA(n,n,j)}return j}));const W=this.layer.getRenderer().getZScale(),q=[],Z=[];return U.setLocalTransform((()=>{const e=this.layer.options.altitude||0;return qA(Z,m),Z[2]+=100*e*W,xA(q,n,Z),q})),I.generateBuffers(this.regl,{excludeElementsInVAO:!0}),g.instance_color&&(z.HAS_INSTANCE_COLOR=1),g.aTerrainAltitude&&(z.HAS_INSTANCE_TERRAIN_ALTITUDE=1,U.setUniform("terrainAltitudeScale",100*this.layer.getRenderer().getZScale())),z.HAS_LAYER_OPACITY=1,UL(U.properties,l.properties),U.properties.aPickingId=w,U.properties.nodeIndex=N,U.properties.pickingIdIndiceMap=T,U.setDefines(z),U.properties.symbolIndex={index:e},U}));I.push(...D)}return I.insContext={instanceData:g,tileTranslationMatrix:n,tileExtent:i,aPosition:u,positionSize:h},I}_arrangeAlongLine(e,t){const{tileExtent:n,z:i}=t.properties,{data:s,positionSize:o}=t;let a=this._calGLTFScale(e);a=$A([],a,this._getMeterScale());const l={gapLength:this.dataConfig.gapLength||0,direction:this.dataConfig.direction||0,scaleVertex:!0},h=this._gltfPack[0][0],{aPosition:c,aAltitude:u,aPickingId:f}=s,g=new fl(0,0,0),m=new fl(0,0,0),A=[],w=u?[]:A,T=[],S=[],M=[],C=[],I=[],E=[],D=this.layer.getTileSize().width/n*this.layer.getRenderer().getTileGLScale(i),H=this.layer.getRenderer().getZScale();let N=f[0];for(let e=0;e<c.length-o;e+=o){const t=f[e/o+1];if(t!==N){N=t;continue}u?ZA(I,c[e],c[e+1],u[e/o]):Tz.unpackPosition(I,c[e],c[e+1],c[e+2]);const[n,i,s]=I;let B=e+o;u?ZA(E,c[B],c[B+1],u[B/o]):Tz.unpackPosition(E,c[B],c[B+1],c[B+2]);const[z,U,j]=E,W=f[e/o],q=g.set(n*D,i*D,s*H),Z=m.set(z*D,U*D,j*H),X=q.distanceTo(Z),Y=h.arrangeAlongLine(q,Z,X,a,1,l);for(let e=0;e<Y.length;e++){const t=Y[e];g.set(n,i,s),m.set(z,U,j);const o=zz(g,m,t.t);A.push(o.x,o.y),w.push(o.z),T.push(W),S.push(-t.rotationZ*Math.PI/180),M.push(t.rotationXY*Math.PI/180),C.push(...t.scale)}}t.data={aPosition:new c.constructor(A),aPickingId:new f.constructor(T),aZRotation:S,aXYRotation:M,aScaleXYZ:C},u&&(t.data.aAltitude=new u.constructor(w))}_calGLTFScale(e){const t=this.getSymbols()[e],n=[1,1,1],i=t.modelHeight;return i&&this._gltfPack[e][0].calModelHeightScale(n,i),ZA(Iz,t.scaleX||1,t.scaleY||1,t.scaleZ||1),JA(n,n,Iz)}_getMeshNodeMatrix(e,t,n){const i=this._gltfMeshInfos[e][t];return this._isSkinAnimating(e)&&this._nodeMatrixMap&&this._nodeMatrixMap[n]||i.nodeMatrix}_updateAnimation(e,t,n){if(!this._gltfPack)return;const i=this._gltfPack[t][0];this._skinMap||(this._skinMap={}),this._nodeMatrixMap={},this._skinMap[e.uuid]||(this._skinMap[e.uuid]={});const s=this.getSymbols()[t],o=this._gltfJSON[t],{loop:a,speed:l,animationName:h}=s;return i.updateAnimation(n,a||!1,l||1,h||o.animations[0].name,e.properties.startTime||0,this._nodeMatrixMap,this._skinMap[e.uuid]),this._skinMap[e.uuid]}_calAnchorTranslation(e,t){const n=t.anchorZ||"center";let i=0;const s=e.max[2]-e.min[2];return"bottom"===n?i=s/2:"top"===n&&(i=-s/2),i}addMesh(e,t,n){if(!e)return null;if(e[0].properties.level>2)return null;const i=n.timestamp;for(let t=0;t<e.length;t++){if(!e[t]||!e[t].geometry)continue;e[t].instancedData.aTerrainAltitude&&this._updateTerrainAltitude(e[t],e[t].instancedData,e[t].properties,3,n);const s=e[t].properties.symbolIndex.index,o=this._isSkinAnimating(s);o&&this._updateAnimation(e[t],s,i),e[t].setUniform("skinAnimation",+o),this._highlightMesh(e[t])}return this.scene.addMesh(e),this}_updateATerrainAltitude(e,t){e&&e.updateInstancedData&&e.updateInstancedData("aTerrainAltitude",t)}prepareRender(e){const t=this.getSymbols();let n=!1;for(let e=0;e<t.length;e++)if(t[e]&&this._gltfPack[e]&&this._isSkinAnimating(e)&&this._gltfPack[e]&&!n){n=!0;break}n&&this.setToRedraw(!0),super.prepareRender(e)}getShadowMeshes(){return this.isVisible()?(this.shadowCount=this.scene.getMeshes().length,this.scene.getMeshes().filter((e=>0===e.properties.level))):Dz}_isSkinAnimating(e){const t=this.getSymbols()[e];return!!(t&&t.animation&&this._gltfPack[e]&&this._gltfPack[e][0]&&this._gltfPack[e][0].hasSkinAnimation())}_updateInstanceData(e,t,n,i,s,o,a){function l(t,n,i,s){e[t][4*n]=i[s],e[t][4*n+1]=i[s+4],e[t][4*n+2]=i[s+8],e[t][4*n+3]=i[s+12]}const{aPosition:h,aPickingId:c,aXYRotation:u,aZRotation:f,aAltitude:g,aScaleXYZ:m}=s,A=h.length/o,w=this.layer.getTileSize().width/n*this.layer.getRenderer().getTileGLScale(i),T=this.layer.getRenderer().getZScale(),S=100*(this.dataConfig.altitudeOffset||0);let M=1/0,C=1/0,I=1/0,E=-1/0,D=-1/0,H=-1/0;const N=[],B=[];for(let e=0;e<A;e++){g?ZA(B,h[e*o],h[e*o+1],g[e]):Tz.unpackPosition(B,h[e*o],h[e*o+1],h[e*o+2]);const t=ZA(N,B[0]*w,-B[1]*w,(B[2]+S)*T);t[0]<M&&(M=t[0]),t[0]>E&&(E=t[0]),t[1]<C&&(C=t[1]),t[1]>D&&(D=t[1]),t[2]<I&&(I=t[2]),t[2]>H&&(H=t[2])}const z=(M+E)/2,U=(C+D)/2,j=(I+H)/2,W=[],q=this._hasFuncType(),Z=[0,0,1],X=[0,0,0];for(let t=0;t<A;t++){g?ZA(B,h[t*o],h[t*o+1],g[t]):Tz.unpackPosition(B,h[t*o],h[t*o+1],h[t*o+2]);const n=ZA(N,B[0]*w-z,-B[1]*w-U,(B[2]+S)*T-j),i=ZA(Iz,1,1,1);m&&(ZA(i,m[3*t],m[3*t+1],m[3*t+2]),SA(kz,i));const s=u&&u[t]||0,A=f&&f[t]||0;if(s||A){MA(W,A,Z);const e=ZA(Sz,Math.cos(A),Math.sin(A),0);wA(W,W,s,ay(e,e,X,90*Math.PI/180)),m&&vA(W,W,kz);vA(W,TA(Hz,n),W)}else TA(W,n),m&&vA(W,W,kz);if(q){vA(W,W,this._getSymbolTRSMatrix(Hz,a,c,t))}l("instance_vectorA",t,W,0),l("instance_vectorB",t,W,1),l("instance_vectorC",t,W,2),e.aPickingId[t]=c[t]}return ZA(N,z,U,j),N}_getMeterScale(){if(!this._meterScale){const e=this.getMap();this._meterScale=100*dL(e.getGLRes(),e)}return this._meterScale}_getSymbolTRSMatrix(e,t,n,i){const s=this.getMap(),o=this.symbolDef[0],a=this._getMeterScale();let l=o.translationX||0,h=o.translationY||0,c=o.translationZ||0,u=o.rotationX||0,f=o.rotationY||0,g=o.rotationZ||0,m=o.scaleX||1,A=o.scaleY||1,w=o.scaleZ||1;const T=t&&t[n&&n[i]],S=s.getZoom(),M=T&&T.feature&&T.feature.properties,C=this._getModelHeightScale(S,M);this._txFn&&(l=this._txFn(S,M)),this._tyFn&&(h=this._tyFn(S,M)),this._tzFn&&(c=this._tzFn(S,M));const I=ZA(Mz,l*a,h*a,c*a);this._rxFn&&(u=this._rxFn(S,M)),this._ryFn&&(f=this._ryFn(S,M)),this._rzFn&&(g=this._rzFn(S,M));const E=ZA(Cz,u,f,g);this._sxFn&&(m=this._sxFn(S,M)),this._syFn&&(A=this._syFn(S,M)),this._szFn&&(w=this._szFn(S,M));const D=ZA(Pz,m*C,A*C,w*C);return this._getGLTFMatrix(e,I,E,D)}_getModelHeightScale(e,t){const n=this.symbolDef[0];let i=this._modelHeightFn?this._modelHeightFn(e,t):n.modelHeight;if(hL(i))return 1;const s=this._gltfBBox[0];return i/Math.abs(s.max[1]-s.min[1])}getShaderConfig(){const e=super.getShaderConfig();return e.positionAttribute="POSITION",e.normalAttribute="NORMAL",e}init(e){super.init(e),this._initGLTF()}_initTRSFuncType(){const e=this.symbolDef[0];SE(e.modelHeight)&&(this._modelHeightFn=CE(e.modelHeight)),SE(e.translationX)&&(this._txFn=CE(e.translationX)),SE(e.translationY)&&(this._tyFn=CE(e.translationY)),SE(e.translationZ)&&(this._tzFn=CE(e.translationZ)),SE(e.rotationX)&&(this._rxFn=CE(e.rotationX)),SE(e.rotationY)&&(this._ryFn=CE(e.rotationY)),SE(e.rotationZ)&&(this._rzFn=CE(e.rotationZ)),SE(e.scaleX)&&(this._sxFn=CE(e.scaleX)),SE(e.scaleY)&&(this._syFn=CE(e.scaleY)),SE(e.scaleZ)&&(this._szFn=CE(e.scaleZ))}_hasFuncType(){return!!(this._modelHeightFn&&!this._modelHeightFn.isFeatureConstant||this._txFn&&!this._txFn.isFeatureConstant||this._tyFn&&!this._tyFn.isFeatureConstant||this._tzFn&&!this._tzFn.isFeatureConstant||this._rxFn&&!this._rxFn.isFeatureConstant||this._ryFn&&!this._ryFn.isFeatureConstant||this._rzFn&&!this._rzFn.isFeatureConstant||this._sxFn&&!this._sxFn.isFeatureConstant||this._syFn&&!this._syFn.isFeatureConstant||this._szFn&&!this._szFn.isFeatureConstant)}_initGLTF(){if(this._gltfPack)return;this._gltfPack=[],this._gltfJSON=[],this._gltfBBox=[],this._gltfMeshInfos=[];const e=this.getSymbols();this._loaded=0;for(let t=0;t<e.length;t++){const n=e[t].url||"pyramid";this._gltfManager.loginGLTF(n);const i=this._gltfManager.getGLTF(n);if(i.then)i.then((n=>{if(!n.gltfPack)return this._loaded++,void(this._loaded>=e.length&&(this._ready=!0,this.setToRedraw(!0)));const{gltfPack:i,json:s,bbox:o}=n;this._gltfPack[t]=[i],this._gltfMeshInfos[t]=i.getMeshesInfo(),this._gltfJSON[t]=s,this._gltfBBox[t]=o,this._loaded++,this._loaded>=e.length&&(this._ready=!0),this.setToRedraw(!0)}));else{const{gltfPack:e,json:n,bbox:s}=i;e&&(this._gltfPack[t]=[e],this._gltfMeshInfos[t]=e.getMeshesInfo(),this._gltfJSON[t]=n,this._gltfBBox[t]=s,this._loaded++)}}this._loaded>=e.length&&(this._ready=!0)}getPickingVert(){return bz}getPickingWGSLVert(){return wz}deleteMesh(e){if(e){this.scene.removeMesh(e);for(let t=0;t<e.length;t++){const n=this._skinMap&&this._skinMap[e[t].uuid];if(n){for(const e in n)n[e].jointTexture&&n[e].jointTexture.destroy();delete this._skinMap[e[t].uuid]}e[t].disposeInstancedData(),e[t].dispose()}}}delete(){super.delete();const e=this.getSymbols();for(let t=0;t<e.length;t++){this._gltfManager.logoutGLTF(e[t].url||"pyramid")}if(this._skinMap){for(const e in this._skinMap){const t=this._skinMap[e];for(const e in t)t[e].jointTexture&&t[e].jointTexture.destroy()}delete this._skinMap}delete this._nodeMatrixMap}_getGLTFMatrix(e,t,n,i){const s=ZA(Sz,...t||Ez),o=n||Rz,a=i||Lz;return EA(e,a_(Oz,o[0],o[1],o[2]),s,a)}shouldDrawParentTile(){return!1}};function zz(e,t,n){const i=Gz(e.x,t.x,n),s=Gz(e.y,t.y,n),o=Gz(e.z||0,t.z||0,n);return new e.constructor(i,s,o)}function Gz(e,t,n){return e+n*(t-e)}let Uz=class Hs extends(Bz(uz)){getMaterialClazz(e){return e.diffuseFactor?CM.PhongSpecularGlossinessMaterial:CM.PhongMaterial}},Vz=class Ls extends(Bz(Az)){getMaterialClazz(e){return e.specularGlossinessTexture||e.diffuseTexture?CM.pbr.StandardSpecularGlossinessMaterial:CM.pbr.StandardMaterial}};const{getPBRUniforms:jz}=CM.pbr.PBRUtils,Wz={color:[2.0303,2.028,2.028],direction:[0,-.2717,-1]},qz=.3737,Zz={index:0},Xz=[0,0,0],Yz=[2,2];let Jz=class Ws extends OF{supportRenderMode(e){return"fxaa"===e||"fxaaBeforeTaa"===e}needPolygonOffset(){return!0}isTerrainSkin(){return!1}isTerrainVector(){return!0}needToRedraw(){return!!super.needToRedraw()||this.getSymbol(Zz).animation}createMesh(e,t){const{geometry:n}=e;n.generateBuffers(this.regl);const i=new CM.Mesh(n,null,{castShadow:!1,picking:!0});return i.properties.symbolIndex=Zz,i.setLocalTransform(t),i}callShader(e,t){super.callShader(e,t),this.transformWater();const n=this._getWaterUniform(this.getMap(),t);this._drawCount+=this.renderer.render(this._waterShader,n,this._waterScene,this.getRenderFBO(t))}addMesh(e,t){this._prepareMesh(e,t),super.addMesh(...arguments)}_prepareMesh(e){const t=this.getSymbol(Zz).ssr;for(let n=0;n<e.length;n++)e[n].ssr=t?1:0}paint(e){e.states&&e.states.includesChanged&&(this.shader.dispose(),this._waterShader.dispose(),this._createShader(e));const t=!!e.ssr&&this.getSymbol(Zz).ssr,n=this._waterShader,i=n.shaderDefines;if(t){const t=UL({},i,e.ssr.defines);n.shaderDefines=t}this.updateIBLDefines(n),this._water.ssr=t?1:0,super.paint(e),t&&(n.shaderDefines=i)}isEnableTileStencil(){return!1}init(e){this.createIBLTextures();this.renderer=new CM.Renderer(this.regl),this.createGround(),this._createShader(e),this.pickingFBO&&(this.picking=[new CM.FBORayPicking(this.renderer,{vert:EF,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,t){const n=[];return vA(n,t.projViewMatrix,t.modelMatrix),n}}],extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap())]),this._loadTextures()}_loadTextures(){const e=this.regl;this._emptyTex||(this._emptyTex=e.texture(2));const t=this.layer.getURLModifier(),n=this.getSymbol({index:0}),i=n.texWaveNormal,s=this.getCachedTexture(i),o=this;if(s)this._normalTex||(s.isLoading?setTimeout((()=>{this.shader&&this._loadTextures()}),20):this._normalTex=this._createTex(e,s));else{const n=new Image;n.isLoading=!0,n.onload=function(){delete this.isLoading,o._normalTex=o._createTex(e,this),o.setToRedraw()},n.onerror=()=>{console.error("invalid water wave normal texture:"+i)},this.addCachedTexture(i,n),n.src=t&&t(i)||i}const a=n.texWavePerturbation,l=this.getCachedTexture(a);if(l)this._pertTex||(l.isLoading?setTimeout((()=>{this._loadTextures()}),20):this._pertTex=this._createTex(e,l));else{const n=new Image;n.isLoading=!0,n.onload=function(){delete this.isLoading,o._pertTex=o._createTex(e,this),o.setToRedraw()},n.onerror=()=>{console.error("invalid water wave perturbation texture:"+a)},this.addCachedTexture(a,n),n.src=t&&t(a)||a}}_createTex(e,t){return this._emptyTex?e.texture({width:t.width,height:t.height,mag:"linear",min:"linear mipmap linear",wrapS:"repeat",wrapT:"repeat",flipY:!0,data:t}):null}_createShader(e){const t=this.canvas,n=[],i=[{name:"projViewModelMatrix",type:"function",fn:function(e,t){const n=[];return vA(n,t.projViewMatrix,t.modelMatrix),n}},{name:"modelViewNormalMatrix",type:"function",fn:(e,t)=>{const n=vA([],t.viewMatrix,t.modelMatrix),i=_A(n,n);return oA([],yA(i,i))}},{name:"modelViewMatrix",type:"function",fn:(e,t)=>vA([],t.viewMatrix,t.modelMatrix)},{name:"environmentTransform",type:"function",fn:(e,t)=>uA(n,Math.PI*(t.environmentOrientation||0)/180)}],s={TIME_NOISE_TEXTURE_REPEAT:qz};this.fillIncludes(s,i,e);const o={x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1};this.shader=new CM.MeshShader({vert:"\n                attribute vec3 aPosition;\n\n                uniform mat4 projViewModelMatrix;\n                uniform float minAltitude;\n\n                void main() {\n                    vec3 position = aPosition;\n                    position.z += minAltitude * 100.0;\n                    gl_Position = projViewModelMatrix * vec4(position, 1.);\n                }\n            ",frag:"\n    #define SHADER_NAME WATER_STENCIL\n    precision mediump float;\n    void main() {\n        gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n    }\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,t){const n=[];return vA(n,t.projViewMatrix,t.modelMatrix),n}}],extraCommandProps:{viewport:o,colorMask:[!1,!1,!1,!1],stencil:{enable:!0,func:{cmp:"<=",ref:254},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}});const a={viewport:o,stencil:{enable:!0,func:{cmp:"==",ref:254},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!1}};i.push(...CM.SsrPass.getUniformDeclares()),this._waterShader=new CM.MeshShader({vert:"#define SHADER_NAME WATER\nuniform mat4 modelMatrix;\nuniform mat4 projViewModelMatrix;\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform vec2 uvOffset;\nuniform vec2 noiseUvOffset;\nuniform vec2 uvScale;\nvarying vec2 vUv;\nvarying vec2 vNoiseUv;\nvarying vec3 vPos;\nvarying mat3 vTbnMatrix;\n#ifdef HAS_SSR\nuniform mat4 modelViewMatrix;\nvarying vec4 vViewVertex;\n#endif\n#include <highlight_vert>\nmat3 c(in vec3 d) {\n  vec3 t = normalize(cross(d, vec3(.0, 1., .0)));\n  vec3 e = normalize(cross(d, t));\n  return mat3(t, e, d);\n}\n#if defined(HAS_SHADOWING)\n#include <vsm_shadow_vert>\n#endif\nconst vec3 f = vec3(0., 0., 1.);\nvoid main(void) {\n  vec4 h = vec4(aPosition, 1.);\n  vec4 i = modelMatrix * h;\n  vPos = i.xyz;\n  vTbnMatrix = c(f);\n  gl_Position = projViewModelMatrix * h;\n  vUv = aTexCoord * uvScale + uvOffset;\n  vNoiseUv = aTexCoord * uvScale * TIME_NOISE_TEXTURE_REPEAT + noiseUvOffset;\n#ifdef HAS_SSR\nvec4 j = modelViewMatrix * h;\n  vViewVertex = j;\n#endif\n#if defined(HAS_SHADOWING)\nshadow_computeShadowPars(h);\n#endif\nhighlight_setVarying();\n}",frag:"#define SHADER_NAME WATER\nprecision highp float;\nprecision highp sampler2D;\n#include <hsv_frag>\nuniform vec3 hsv;\nuniform float contrast;\nuniform float layerOpacity;\n#if defined(HAS_SHADOWING)\n#include <vsm_shadow_frag>\n#endif\n#include <highlight_frag>\n#if defined(HAS_IBL_LIGHTING)\nuniform vec3 hdrHSV;\nuniform samplerCube prefilterMap;\nuniform sampler2D brdfLUT;\nuniform mat3 environmentTransform;\nuniform vec3 diffuseSPH[9];\nvec3 c(const in vec3 d) {\n  vec3 e = environmentTransform * d;\n  float x = e.x;\n  float y = e.y;\n  float z = e.z;\n  vec3 f = (diffuseSPH[0] + diffuseSPH[1] * x + diffuseSPH[2] * y + diffuseSPH[3] * z + diffuseSPH[4] * z * x + diffuseSPH[5] * y * z + diffuseSPH[6] * y * x + diffuseSPH[7] * (3. * z * z - 1.) + diffuseSPH[8] * (x * x - y * y));\n  if(length(hdrHSV) > .0) {\n    f = hsv_apply(f, hdrHSV);\n  }\n  return max(f, vec3(.0));\n}\nvec3 h(const in vec3 i, const in float j, const in float k, const in float l) {\n  vec4 rgba = texture2D(brdfLUT, vec2(k, j));\n  float b = (rgba[3] * 65280.0 + rgba[2] * 255.);\n  float a = (rgba[1] * 65280.0 + rgba[0] * 255.);\n  const float m = 1. / 65535.;\n  return (i * a + b * l) * m;\n}\n#else\nuniform vec3 ambientColor;\n#endif\nstruct PBRShadingWater {\n  float NdotL;\n  float NdotV;\n  float NdotH;\n  float VdotH;\n  float LdotH;\n  float VdotN;\n};\nvec3 o(const in vec4 u, const in float v) {\n  if(v <= .0)\n    return u.rgb;\n  return v * u.rgb * u.a;\n}\n#ifdef HAS_SSR\nvarying vec4 vViewVertex;\nuniform mat3 modelViewNormalMatrix;\nuniform sampler2D TextureDepth;\nuniform highp vec2 outSize;\nuniform float ssrFactor;\nuniform float ssrQuality;\nuniform sampler2D TextureReflected;\nuniform highp mat4 projMatrix;\nuniform mat4 invProjMatrix;\nuniform vec4 outputFovInfo[2];\nuniform mat4 reprojViewProjMatrix;\nuniform vec2 cameraNearFar;\nfloat A(const in vec4 B) {\n  return B.r + B.g / 255.;\n}\nfloat C(const in vec2 D, const in float E) {\n  vec3 F = vec3(.06711056, .00583715, 52.9829189);\n  return fract(F.z * fract(dot(D.xy + E * vec2(47., 17.) * .695, F.xy))) * .5;\n}\nvec3 G(const in float H, const in float I, const in vec2 J) {\n  float K = min(I - .01, H);\n  float L = floor(K);\n  float M = min(I, L + 1.);\n  float N = pow(2., M);\n  vec2 O = 2. * N / J;\n  if(K - L > .5)\n    N *= 2.;\n  return vec3(O, N);\n}\nvec2 P(const in vec2 Q, const in vec3 R) {\n  vec2 S = max(R.xy, min(1. - R.xy, Q));\n  return vec2(2. * S.x, R.z - 1. - S.y) / R.z;\n}\nvec3 T(const in mat4 U, const in vec3 V) {\n  vec4 W = U * vec4(V, 1.);\n  return vec3(.5 + .5 * W.xy / W.w, W.w);\n}\nvec3 X(const in float Y, const in vec2 S) {\n  return texture2D(TextureReflected, S).rgb;\n}\nfloat Z(float ba) {\n  highp mat4 U = projMatrix;\n  highp float z = ba * 2. - 1.;\n  return -U[3].z / (z + U[2].z);\n}\nfloat bb(const vec2 S) {\n  float ba = A(texture2D(TextureDepth, S));\n  return ba;\n}\nvec3 bc(const in float E, const in vec3 bd, const in vec3 be, const in vec3 bf, const in vec3 bg, const in float bh) {\n  vec2 bi;\n  bi.x = C(gl_FragCoord.yx, E);\n  bi.y = fract(bi.x * 52.9829189);\n  bi.y = mix(bi.y, 1., .7);\n  float bj = 2. * 3.14159 * bi.x;\n  float bk = pow(max(bi.y, .000001), bh / (2. - bh));\n  float bl = sqrt(1. - bk * bk);\n  vec3 bm = vec3(bl * cos(bj), bl * sin(bj), bk);\n  bm = bm.x * bd + bm.y * be + bm.z * bf;\n  return normalize((2. * dot(bg, bm)) * bm - bg);\n}\nfloat bn(const in float E) {\n  return (C(gl_FragCoord.xy, E) - .5);\n}\nvec3 bo(const in vec3 bp, const in float bq, const in vec3 br) {\n  vec3 bs = T(projMatrix, vViewVertex.xyz + br * bq);\n  bs.z = 1. / bs.z;\n  bs -= bp;\n  float bt = min(1., .99 * (1. - bp.x) / max(1e-5, bs.x));\n  float bu = min(1., .99 * (1. - bp.y) / max(1e-5, bs.y));\n  float bv = min(1., .99 * bp.x / max(1e-5, -bs.x));\n  float bw = min(1., .99 * bp.y / max(1e-5, -bs.y));\n  return bs * min(bt, bu) * min(bv, bw);\n}\nfloat bx(const in vec3 bp, const in vec3 bs, inout float by, inout float bz) {\n  float bA = (bz + by) * .5;\n  vec3 bB = bp + bs * bA;\n  float z = bb(bB.xy);\n  float ba = Z(z);\n  float bC = -1. / bB.z;\n  by = ba > bC ? by : bA;\n  bz = ba > bC ? bA : bz;\n  return bA;\n}\nvec4 bD(const in vec3 bp, const in float bq, in float bE, const in vec3 br, const in float j, const in float E) {\n  const int bF = 20;\n  float bG = 1. / float(bF);\n  bE *= bG;\n  vec3 bs = bo(bp, bq, br);\n  float bH = bG;\n  vec3 bI = vec3(.0, bH, 1.);\n  vec3 bB;\n  float z, ba, bC, bJ, bK, bL;\n  bool bM;\n  float bN = 1.;\n  float bA;\n  for(int bO = 0; bO < bF; bO++) {\n    bB = bp + bs * bI.y;\n    z = bb(bB.xy);\n    ba = Z(z);\n    bC = -1. / bB.z;\n    bJ = bC - ba;\n    bJ *= clamp(sign(abs(bJ) - bq * bG * bG), .0, 1.);\n    bM = abs(bJ + bE) < bE;\n    bK = clamp(bI.x / (bI.x - bJ), .0, 1.);\n    bL = bM ? bI.y + bK * bG - bG : 1.;\n    bI.z = min(bI.z, bL);\n    bI.x = bJ;\n    if(bM) {\n      float by = bI.y - bG;\n      float bz = bI.y;\n      bA = bx(bp, bs, by, bz);\n      bA = bx(bp, bs, by, bz);\n      bA = bx(bp, bs, by, bz);\n      bN = bA;\n      break;\n    }\n    bI.y += bG;\n  }\n  return vec4(bp + bs * bN, 1. - bN);\n}\nvec3 bP(in vec4 bQ, const in float bR, const in vec3 bS, const in vec3 bT, const in float j) {\n  vec4 bU = mix(outputFovInfo[0], outputFovInfo[1], bQ.x);\n  bQ.xyz = vec3(mix(bU.xy, bU.zw, bQ.y), 1.) * -1. / bQ.z;\n  bQ.xyz = (reprojViewProjMatrix * vec4(bQ.xyz, 1.)).xyw;\n  bQ.xy /= bQ.z;\n  float bV = clamp(6. - 6. * max(abs(bQ.x), abs(bQ.y)), .0, 1.);\n  bQ.xy = .5 + .5 * bQ.xy;\n  return vec3(bQ.xy, 1.);\n}\nvec3 ssr(const in vec3 bS, const in vec3 bT, const in float j, const in vec3 d, const in vec3 bg) {\n  float bW = .0;\n  vec4 f = vec4(.0);\n  float bh = j * j;\n  bh = bh * bh;\n  vec3 bX = abs(d.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 bd = normalize(cross(bX, d));\n  vec3 be = cross(d, bd);\n  float bR = ssrFactor * clamp(-4. * dot(bg, d) + 3.8, .0, 1.);\n  bR *= clamp(4.7 - j * 5., .0, 1.);\n  vec3 bp = T(projMatrix, vViewVertex.xyz);\n  bp.z = 1. / bp.z;\n  vec3 br = bc(bW, bd, be, d, bg, bh);\n  float bq = mix(cameraNearFar.y + vViewVertex.z, -vViewVertex.z - cameraNearFar.x, br.z * .5 + .5);\n  float bE = .5 * bq;\n  vec4 bQ;\n  if(dot(br, d) > .001 && bR > .0) {\n    bQ = bD(bp, bq, bE, br, j, bW);\n    if(bQ.w > .0)\n      return bP(bQ, bR, bS, bT, j);\n    \n  }\n  return vec3(.0);\n}\n#endif\nconst vec3 bY = vec3(0., 0., 1.);\nuniform mat4 viewMatrix;\nuniform sampler2D normalTexture;\nuniform sampler2D heightTexture;\nuniform vec4 waveParams;\nuniform vec2 waterDir;\nuniform vec4 waterBaseColor;\nuniform vec3 lightDirection;\nuniform vec3 lightColor;\nuniform vec3 camPos;\nuniform float timeElapsed;\nvarying vec2 vUv;\nvarying vec2 vNoiseUv;\nvarying vec3 vPos;\nvarying mat3 vTbnMatrix;\nfloat bZ(vec3 e, float ca) {\n  float cb = max(.015, ca);\n  return max((e.x + e.y) * .3303545 / cb + .3303545, .0);\n}\nconst vec2 cc = vec2(6. / 25., 5. / 24.);\nvec2 cd(sampler2D ce, vec2 S) {\n  return 2. * texture2D(ce, S).rg - 1.;\n}\nfloat cf(vec2 S) {\n  return texture2D(heightTexture, S).b;\n}\nvec3 cg(sampler2D ce, vec2 S) {\n  return 2. * texture2D(ce, S).rgb - 1.;\n}\nfloat ch(vec2 S, float ci) {\n  return fract(ci);\n}\nfloat cj(vec2 S, float ci) {\n  float ck = ch(S, ci);\n  return 1. - abs(1. - 2. * ck);\n}\nvec3 cl(sampler2D cm, vec2 S, float ci, float cn) {\n  float co = waveParams[2];\n  float cp = waveParams[3];\n  vec2 cq = cd(cm, S) * co;\n  float ck = ch(S, ci + cn);\n  float cr = cj(S, ci + cn);\n  vec2 f = S;\n  f -= cq * (ck + cp);\n  f += cn;\n  f += (ci - ck) * cc;\n  return vec3(f, cr);\n}\nconst float cs = 7.77;\nvec3 ct(sampler2D cu, sampler2D cv, vec2 cw, vec2 cx, float ci) {\n  float ca = waveParams[0];\n  vec2 cy = ci * -cx;\n  float cz = cf(vNoiseUv) * cs;\n  vec3 cA = cl(cv, cw + cy, ci + cz, .0);\n  vec3 cB = cl(cv, cw + cy, ci + cz, .5);\n  vec3 cC = cg(cu, cA.xy) * cA.z;\n  vec3 cD = cg(cu, cB.xy) * cB.z;\n  vec3 cE = normalize(cC + cD);\n  cE.xy *= ca;\n  cE.z = sqrt(1. - dot(cE.xy, cE.xy));\n  return cE;\n}\nvec4 cF(vec2 cw, float cG) {\n  float cH = waveParams[1];\n  vec3 d = ct(normalTexture, heightTexture, cw * cH, waterDir, cG);\n  float cI = bZ(d, waveParams[0]);\n  return vec4(d, cI);\n}\nconst float cJ = 3.141592653589793;\nconst float cK = 1. / cJ;\nconst float cL = .3183098861837907;\nconst float cM = 1.570796326794897;\nconst float cN = .4;\nfloat cO = 2.2;\nvec3 cP(float cQ, vec3 cR, float l) {\n  return cR + (l - cR) * pow(1. - cQ, 5.);\n}\nfloat cS(float cT, float j) {\n  float cU = j * j;\n  float cV = cT * cT;\n  float cW = pow((cV * (cU - 1.) + 1.), cO) * cJ;\n  return cU / cW;\n}\nfloat cX(float cY) {\n  return .25 / (cY * cY);\n}\nvec3 cZ(const vec3 x) {\n  return (x * (2.51 * x + .03)) / (x * (2.43 * x + .59) + .14);\n}\nconst float da = 2.2;\nconst float db = .4545454545;\nvec4 dc(vec4 u) {\n  return vec4(pow(u.rgb, vec3(db)), u.w);\n}\nvec3 dd(vec3 u) {\n  return pow(u, vec3(da));\n}\nconst vec3 de = vec3(.02, 1., 5.);\nconst vec2 df = vec2(.02, .1);\nconst float j = .06;\nconst float dg = 1.7;\nconst vec3 dh = vec3(0, .6, .9);\nconst vec3 di = vec3(.72, .92, 1.);\nconst float dj = .65;\nconst float dk = 300000.0;\nconst float dl = 500000.0;\nconst float dm = .775;\nconst float dn = .8;\nPBRShadingWater dp;\nvec3 dq(in PBRShadingWater dr, float j, vec3 ds, float dt) {\n  vec3 du = cP(dr.VdotH, ds, dt);\n  float dv = cS(dr.NdotH, j);\n  float dw = cX(dr.LdotH);\n  float dx = mix(j + .045, j + .385, 1. - dr.VdotH);\n  float dy = 1.2;\n  float dz = cS(dr.NdotH, dx) * dy;\n  return ((dv + dz) * dw) * du;\n}\nvec3 dA(float dg, float dB, vec3 dh, float dC) {\n  return dg * (.075 * dh * pow(dB, 4.) + 50. * pow(dB, 23.)) * dC;\n}\nvec3 dD(in float bk, in vec3 dE, in vec3 dF) {\n  float dG = pow((1. - bk), de[2]);\n  return mix(dF, dE, dG);\n}\nvec3 dH(in vec3 e, in vec3 dI, in float dJ, in float j) {\n  \n#ifdef HAS_IBL_LIGHTING\nvec3 dK = reflect(-dI, e);\n  vec3 dL = textureCube(prefilterMap, environmentTransform * dK).rgb;\n  float dM = clamp(1. + dot(dK, e), .0, 1.);\n  dL *= dM * dM;\n  vec3 i = dL;\n  vec3 dN = c(e);\n  float l = clamp(50.0 * waterBaseColor.g, .0, 1.);\n  vec3 dO = h(waterBaseColor.rgb, j, dot(e, dI), l);\n  return i * dO + dN;\n#else\nvec3 dP = dd(di);\n  vec3 dQ = dd(dh);\n  vec3 di = dD(dJ, dP, dQ);\n  return di;\n#endif\n}\nvec3 dR(in vec3 e, in vec3 dI, in vec3 dS, vec3 u, in vec3 dT, in vec3 dU, in float dV, float dW, vec3 dX) {\n  float dY = 0.;\n  vec3 dZ = dd(u);\n  vec3 bm = normalize(dS + dI);\n  dp.NdotL = clamp(dot(e, dS), .0, 1.);\n  dp.NdotV = clamp(dot(e, dI), .001, 1.);\n  dp.VdotN = clamp(dot(dI, e), .001, 1.);\n  dp.NdotH = clamp(dot(e, bm), .0, 1.);\n  dp.VdotH = clamp(dot(dI, bm), .0, 1.);\n  dp.LdotH = clamp(dot(dS, bm), .0, 1.);\n  float dJ = max(dot(dU, dI), .0);\n  vec3 di = dH(e, dI, dJ, j);\n  float ea = max(dot(dU, dS), .0);\n  float eb = .1 + ea * .9;\n  di *= eb;\n  float ec = clamp(dV, .8, 1.);\n  vec3 ed = cP(dp.VdotN, vec3(de[0]), de[1]);\n  vec3 ee = ed * di * ec;\n  vec3 ef = dZ * mix(di, ea * dT * cK, 2. / 3.) * ec;\n  vec3 i = vec3(.0);\n  if(dJ > .0 && ea > .0) {\n    vec3 eg = dq(dp, j, vec3(df[0]), df[1]);\n    vec3 eh = dT * cK * dV;\n    i = dp.NdotL * eh * eg;\n  }\n  vec3 cI = vec3(.0);\n  if(dJ > .0) {\n    cI = dA(dg, dW, dh, eb);\n  }\n  vec3 ei = vec3(.0);\n#ifdef HAS_SSR\nfloat ej = smoothstep(dl, dk, -dX.z);\n  mat4 ek = viewMatrix;\n  vec4 el = vec4(dX.xyz, 1.);\n  vec3 em = normalize(el.xyz);\n  vec4 en = ek * vec4(e, .0);\n  vec3 eo = normalize(en.xyz);\n  vec4 ep = ek * vec4(dU, .0);\n  float eq = pow(max(dot(-em, ep.xyz), .0), cN);\n  vec3 er = mix(ep.xyz, eo, eq);\n  vec3 es = ssr(vec3(.0), vec3(1.), j, normalize(er), -normalize(vViewVertex.xyz));\n  if(es.z > .0) {\n    vec2 et = smoothstep(.3, .6, abs(vec2(.5) - es.xy));\n    dY = dm * clamp(1. - 1.3 * et.y, .0, 1.) * ej;\n    vec3 eu = X(.0, es.xy);\n    ei = dd(eu) * dY * ed.y * dj;\n  }\n#endif\nfloat ev = mix(dn, dn * .5, dY);\n  return cZ((1. - dY) * ee + ei + ef * ev + i + cI);\n}\nvoid main() {\n  vec3 dU = bY;\n  vec4 ew = cF(vUv, timeElapsed);\n  vec3 e = normalize(vTbnMatrix * ew.xyz);\n  vec3 dI = -normalize(vPos - camPos);\n  vec3 dS = normalize(-lightDirection);\n#if defined(HAS_SHADOWING)\nfloat dV = shadow_computeShadow();\n#else\nfloat dV = 1.;\n#endif\nvec4 ex = viewMatrix * vec4(vPos, 1.);\n  vec4 ey = vec4(dR(e, dI, dS, waterBaseColor.rgb, lightColor, dU, dV, ew.w, ex.xyz), waterBaseColor.a);\n  gl_FragColor = dc(ey);\n  if(contrast != 1.) {\n    gl_FragColor = contrastMatrix(contrast) * gl_FragColor;\n  }\n  if(length(hsv) > .0) {\n    gl_FragColor = hsv_apply(gl_FragColor, hsv);\n  }\n  gl_FragColor = highlight_blendColor(gl_FragColor) * layerOpacity;\n}",defines:s,uniforms:i,extraCommandProps:a})}getUniformValues(e){return{projViewMatrix:e.projViewMatrix,minAltitude:this.layer.options.altitude||0}}_getWaterUniform(e,t){const{iblTexes:n,dfgLUT:i}=this.getIBLRes(),s=jz(e,n,i,t&&t.ssr,t&&t.jitter),o=e.getLightManager();let a=o&&o.getDirectionalLight()||{};const l=o&&o.getAmbientLight()||{},h=this.getSymbol(Zz),c=this._waterDir=this._waterDir||[],u=this._waveParams=this._waveParams||[];Sy(u,.09,h.uvScale||3,.03,-.5),UL(s,{ambientColor:l.color||[.2,.2,.2],viewMatrix:e.viewMatrix,lightDirection:a.direction||Wz.direction,lightColor:a.color||Wz.color,camPos:e.cameraPosition,timeElapsed:h.animation?(this.layer.getRenderer().getFrameTimestamp()||0)/(1/(h.waterSpeed||1)*1e4):0,normalTexture:this._normalTex||this._emptyTex,heightTexture:this._pertTex||this._emptyTex,waveParams:u,waterDir:Qz(c,h.waterDirection||0),waterBaseColor:h.waterBaseColor||[.1451,.2588,.4863,1],contrast:h.contrast||1,hsv:h.hsv||Xz});const f=this.layer.getRenderer();return s.layerOpacity=f._getLayerOpacity(),this.setIncludeUniformValues(s,t),t&&t.ssr&&t.ssr.renderUniforms&&UL(s,t.ssr.renderUniforms),s}delete(){super.delete(),this._emptyTex&&(this._emptyTex.destroy(),delete this._emptyTex),this._normalTex&&this._normalTex.destroy(),this._pertTex&&this._pertTex.destroy(),this.shader&&(this.shader.dispose(),delete this.shader),this._waterShader&&this._waterShader.dispose(),this._water&&(this._water.geometry.dispose(),this._water.material&&this._water.material.dispose(),this._water.dispose(),delete this._water),this.disposeIBLTextures()}createGround(){const e=new CM.Plane;e.data.aTexCoord=new Uint8Array([0,1,1,1,0,0,1,0]),e.generateBuffers(this.renderer.device),this._water=new CM.Mesh(e,null,{castShadow:!1}),this._waterScene=new CM.Scene([this._water])}transformWater(){const e=this.getMap(),t=GroundPainter.getGroundTransform(this._water.localTransform,e);this._water.setLocalTransform(t);const n=e._get2DExtentAtRes(e.getGLRes()),i=n.getWidth(),s=n.getHeight(),o=e.cameraLookAt,a=(o[0]-i)/Yz[0],l=(o[1]+s)/Yz[1],h=a*qz%1,c=l*qz%1,u=i/Yz[0]*2,f=s/Yz[1]*2;this._water.setUniform("uvOffset",[a%1,l%1]),this._water.setUniform("noiseUvOffset",[h,c]),this._water.setUniform("uvScale",[u,-f])}};function Qz(e,t){return t=Math.PI*t/180,e[0]=Math.sin(t),e[1]=Math.cos(t),e}var $z="#define SHADER_NAME BILL_BOARD\n#include <gl2_vert>\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec2 aExtrude;\nattribute vec2 aTexCoord;\nattribute vec4 aQuat;\nvarying vec2 vTexCoord;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float extrudeScale;\n#ifdef PICKING_MODE\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\nmat4 c(vec4 q) {\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float d = x * x, e = y * y, f = z * z;\n  float xy = x * y, xz = x * z, yz = y * z;\n  float wx = w * x, wy = w * y, wz = w * z;\n  return mat4(1. - 2. * (e + f), 2. * (xy + wz), 2. * (xz - wy), .0, 2. * (xy - wz), 1. - 2. * (d + f), 2. * (yz + wx), .0, 2. * (xz + wy), 2. * (yz - wx), 1. - 2. * (d + e), .0, .0, .0, .0, 1.);\n}\nvoid main() {\n  vec4 h = vec4(aExtrude.x * extrudeScale, .0, aExtrude.y, 1.);\n  mat4 i = c(aQuat);\n  vec3 j = (i * h).xyz;\n  vec3 k = unpackVTPosition(j);\n  vTexCoord = aTexCoord;\n  gl_Position = projViewModelMatrix * positionMatrix * vec4(k, 1.);\n#ifdef PICKING_MODE\nfbo_picking_setData(gl_Position.w, true);\n#elif defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(vec4(k, 1.));\n#endif\n}";function Kz(e,t,n){n=n||{},this.w=e||64,this.h=t||64,this.autoResize=!!n.autoResize,this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0}function eG(e,t,n){this.x=0,this.y=e,this.w=this.free=t,this.h=n}function tG(e,t,n,i,s,o,a){this.id=e,this.x=t,this.y=n,this.w=i,this.h=s,this.maxw=o||i,this.maxh=a||s,this.refcount=0
/*!
   * Codes from mapbox-gl-js
   * github.com/mapbox/mapbox-gl-js
   * MIT License
   */}function nG(e,{width:t,height:n},i,s){if(s){if(s.length!==t*n*i)throw new RangeError("mismatched image size")}else s=new Uint8Array(t*n*i);return e.width=t,e.height=n,e.data=s,e}function rG(e,t,n,i,s,o){if(0===s.width||0===s.height)return t;if(s.width>e.width||s.height>e.height||n.x>e.width-s.width||n.y>e.height-s.height)throw new RangeError("out of range source coordinates for image copy");if(s.width>t.width||s.height>t.height||i.x>t.width-s.width||i.y>t.height-s.height)throw new RangeError("out of range destination coordinates for image copy");const a=e.data,l=t.data;if(a===l)return t;for(let h=0;h<s.height;h++){const c=((n.y+h)*e.width+n.x)*o,u=((i.y+h)*t.width+i.x)*o;for(let e=0;e<s.width*o;e++)l[u+e]=a[c+e]}return t}Kz.prototype.pack=function(e,t){e=[].concat(e),t=t||{};for(var n,i,s,o=[],a=0;a<e.length;a++)if(i=e[a].h||e[a].height,(n=e[a].w||e[a].width)&&i){if(!(s=this.packOne(n,i,e[a].id)))continue;t.inPlace&&(e[a].x=s.x,e[a].y=s.y,e[a].id=s.id),o.push(s)}return this.shrink(),o},Kz.prototype.packOne=function(e,t,n){var i,s,o,a,l,h,c,u,f={freebin:-1,shelf:-1,waste:1/0},g=0;if("string"==typeof n||"number"==typeof n){if(i=this.getBin(n))return this.ref(i),i;"number"==typeof n&&(this.maxId=Math.max(n,this.maxId))}else n=++this.maxId;for(a=0;a<this.freebins.length;a++){if(t===(i=this.freebins[a]).maxh&&e===i.maxw)return this.allocFreebin(a,e,t,n);t>i.maxh||e>i.maxw||t<=i.maxh&&e<=i.maxw&&(o=i.maxw*i.maxh-e*t)<f.waste&&(f.waste=o,f.freebin=a)}for(a=0;a<this.shelves.length;a++)if(g+=(s=this.shelves[a]).h,!(e>s.free)){if(t===s.h)return this.allocShelf(a,e,t,n);t>s.h||t<s.h&&(o=(s.h-t)*e)<f.waste&&(f.freebin=-1,f.waste=o,f.shelf=a)}return-1!==f.freebin?this.allocFreebin(f.freebin,e,t,n):-1!==f.shelf?this.allocShelf(f.shelf,e,t,n):t<=this.h-g&&e<=this.w?(s=new eG(g,this.w,t),this.allocShelf(this.shelves.push(s)-1,e,t,n)):this.autoResize?(l=h=this.h,((c=u=this.w)<=l||e>c)&&(u=2*Math.max(e,c)),(l<c||t>l)&&(h=2*Math.max(t,l)),this.resize(u,h),this.packOne(e,t,n)):null},Kz.prototype.allocFreebin=function(e,t,n,i){var s=this.freebins.splice(e,1)[0];return s.id=i,s.w=t,s.h=n,s.refcount=0,this.bins[i]=s,this.ref(s),s},Kz.prototype.allocShelf=function(e,t,n,i){var s=this.shelves[e].alloc(t,n,i);return this.bins[i]=s,this.ref(s),s},Kz.prototype.shrink=function(){if(this.shelves.length>0){for(var e=0,t=0,n=0;n<this.shelves.length;n++){var i=this.shelves[n];t+=i.h,e=Math.max(i.w-i.free,e)}this.resize(e,t)}},Kz.prototype.getBin=function(e){return this.bins[e]},Kz.prototype.ref=function(e){if(1==++e.refcount){var t=e.h;this.stats[t]=1+(0|this.stats[t])}return e.refcount},Kz.prototype.unref=function(e){return 0===e.refcount?0:(0==--e.refcount&&(this.stats[e.h]--,delete this.bins[e.id],this.freebins.push(e)),e.refcount)},Kz.prototype.clear=function(){this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0},Kz.prototype.resize=function(e,t){this.w=e,this.h=t;for(var n=0;n<this.shelves.length;n++)this.shelves[n].resize(e);return!0},eG.prototype.alloc=function(e,t,n){if(e>this.free||t>this.h)return null;var i=this.x;return this.x+=e,this.free-=e,new tG(n,i,this.y,e,t,e,this.h)},eG.prototype.resize=function(e){return this.free+=e-this.w,this.w=e,!0};let iG=class Js{constructor(e,t){nG(this,e,4,t)}resize(e){!function(e,{width:t,height:n},i){if(t===e.width&&n===e.height)return;const s=nG({},{width:t,height:n},i);rG(e,s,{x:0,y:0},{x:0,y:0},{width:Math.min(e.width,t),height:Math.min(e.height,n)},i),e.width=t,e.height=n,e.data=s.data}(this,e,4)}clone(){return new Js({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,t,n,i,s){rG(e,t,n,i,s,4)}};const sG=new Re(0,0),oG=[],aG=[];let lG;class ia extends OF{constructor(...e){super(...e),this._ready=!0;const t=this.getSymbolDef({index:0}),n=sL(t&&t.source);if(this._ready=!n,SE(t.width)?this._widthFn=CE(t.width):this._width=t.width,SE(t.height)?this._heightFn=CE(t.height):this._height=t.height,SE(t.rotationX)?this._rotationXFn=CE(t.rotationX):this._rotationX=t.rotationX,SE(t.rotationY)?this._rotationYFn=CE(t.rotationY):this._rotationY=t.rotationY,SE(t.rotationZ)?this._rotationZFn=CE(t.rotationZ):this._rotationZ=t.rotationZ,n){const e=this._image=new Image;e.onload=()=>{this._ready=!0},e.src=t.source}}needToRedraw(){const e=this.getSymbolDef({index:0});if(!e||!aL(e.source))return super.needToRedraw();const t=this.layer.getRenderer().getCurrentTiles();return!t||BD(t)?super.needToRedraw():this._checkIfSourceUpdated()||super.needToRedraw()}_checkIfSourceUpdated(){let e=!1;const t=this.layer.getRenderer(),n=t.getCurrentTiles(),i=this.getSymbolDef({index:0}).source,s=t.tileCache,o=[];for(const t in n){const n=s.get(t);if(!(n&&n.image&&n.image.cache&&n.image.cache[0]))continue;let{geometry:a}=n.image.cache[0];if(!a||!a[0]||!a[0].geometry)continue;a=a[0].geometry.properties.billGeometry;const{oldPickingId:l,contextCache:h,textureCache:c,features:u,billTexture:f}=a.properties;if(!l||!l.length)continue;let g=!1,m=!1;const A=l.length;for(let t=0;t<A;t++){const n=l[t],s=h[n]=h[n]||{},a=u[n]&&u[n].feature;if(!a)continue;const f=c[n];let A=0,w=0;f&&(A=f.width,w=f.height);let T,S=i(s,a.properties);S.redraw?(g=e=!0,T=c[n]=S.data,A===T.width&&w===T.height||(m=!0)):T=c[n],o.push({id:n,w:T.width,h:T.height})}if(g){const e=this._fillFnTextureData(m?a.properties.aTexCoord:null,a,o);f({width:e.width,height:e.height,data:e.data,format:e.format,mag:"linear",min:"linear",flipY:!1,premultiplyAlpha:!0}),m&&a.updateData("aTexCoord",a.properties.aTexCoord)}}return e}isTerrainSkin(){return!1}isTerrainVector(){return this.layer.options.awareOfTerrain}isUniqueStencilRefPerTile(){return!1}createMesh(e,t,{tilePoint:n}){if(!this._ready)return null;let{geometry:i}=e;const{features:s,tileResolution:o,tileRatio:a}=i.properties;if(!i.data.aPosition||0===i.data.aPosition.length)return null;const l=this._createBillboard(i,i.desc.positionSize,s);l.generateBuffers(this.regl),i.properties.billGeometry=l;const h=new CM.Material({billTexture:l.properties.billTexture}),c=new CM.Mesh(l,h,{castShadow:!1,picking:!0}),u=this.getMap();sG.set(n[0],n[1]);const f=u.altitudeToPoint(1,o)*a;c.setUniform("extrudeScale",f/100);const g=[];c.setFunctionUniform("textureSize",(()=>{const e=l.properties.billTexture;return g[0]=e.width,g[1]=e.height,g}));const m={};return c.geometry.data.aAltitude&&(m.HAS_ALTITUDE=1),c.setDefines(m),c.positionMatrix=this.getAltitudeOffsetMatrix(),c.setLocalTransform(t),c.properties.symbolIndex={index:0},c}_createBillboard(e,t,n){const i=e.properties.z,{aPosition:s,aPickingId:o}=e.data,a=e.properties;a.oldPickingId=o;const l=a.contextCache=[],h=a.textureCache=[],c=o.length,u=6*c,f=new s.constructor(u*t),g=new Int16Array(2*u),m=new Float32Array(4*u),A=new o.constructor(u),w=this.getSymbolDef({index:0}).source,T=[];for(let e=0;e<c;e++){const n=s.subarray(e*t,(e+1)*t),i=o[e];f.set(n,6*e*t),f.set(n,(6*e+1)*t),f.set(n,(6*e+2)*t),f.set(n,(6*e+3)*t),f.set(n,(6*e+4)*t),f.set(n,(6*e+5)*t),A[6*e]=i,A[6*e+1]=i,A[6*e+2]=i,A[6*e+3]=i,A[6*e+4]=i,A[6*e+5]=i}const S=aL(w);for(let e=0;e<c;e++){const t=o[e],s=n[t];let a;S?(a=w(l[t]=l[t]||{},s&&s.feature&&s.feature.properties).data,h[t]=a,T.push({id:t,w:a.width,h:a.height})):a=this._image,this._fillExtrude(g,e,s,i),this._fillQuat(m,e,s,i)}const M=new Int16Array(2*u);if(T.length){const t=this._fillFnTextureData(M,e,T);a.billTexture=RF(this.regl,t,!1,!1)}else{const e={x:0,y:0,w:this._image.width,h:this._image.height};for(let t=0;t<c;t++)this._fillTexCoord(M,t,e,1);const t=this._image;a.billTexture=this.regl.texture({width:t.width,height:t.height,data:t})}const C=6*c<65536?Uint16Array:Uint32Array,I=[];for(let e=0;e<c;e++){const t=6*e;I.push(t,t+1,t+2),I.push(t+3,t+4,t+5)}const E={aPosition:f,aPickingId:A,aExtrude:g,aQuat:m,aTexCoord:M},{feaPickingIdMap:D,aFeaIds:H}=e.properties,N=new H.constructor(u);for(let e=0;e<A.length;e++)N[e]=D[A[e]];a.aFeaIds=N,a.aTexCoord=M;const B=new CM.Geometry(E,new C(I),0,{positionSize:t});return B.properties=e.properties,B}_fillQuat(e,t,n,i){let s=this._rotationX||0,o=this._rotationY||0,a=this._rotationZ||0;const l=n&&n.feature&&n.feature.properties;this._rotationXFn&&(s=this._rotationXFn(i,l)),this._rotationYFn&&(o=this._rotationYFn(i,l)),this._rotationZFn&&(a=this._rotationZFn(i,l)),a_(aG,s,o,-a);const h=6*t;for(let t=0;t<6;t++)e.set(aG,4*(h+t))}_fillExtrude(e,t,n,i){let s=this._width||0,o=this._height||0;const a=n&&n.feature&&n.feature.properties;this._widthFn&&(s=this._widthFn(i,a)),this._heightFn&&(o=this._heightFn(i,a));const l=s/2*100,h=o/2*100;oG[0]=-l,oG[1]=-h;const c=12*t;e.set(oG,c),oG[0]=l,oG[1]=h,e.set(oG,c+2),oG[0]=-l,oG[1]=h,e.set(oG,c+4),oG[0]=-l,oG[1]=-h,e.set(oG,c+6),oG[0]=l,oG[1]=-h,e.set(oG,c+8),oG[0]=l,oG[1]=h,e.set(oG,c+10)}_fillFnTextureData(e,t,n){const i=t.properties,{textureCache:s,oldPickingId:o}=i,a=o.length,l=new Kz(0,0,{autoResize:!0}),h=(lG||(lG=document.createElement("canvas")),lG),c=h.getContext("2d");l.pack(n,{inPlace:!0});const u=this.sceneConfig.textureLimit||1024;let f=1;l.w*l.h>u*u&&(f=Math.sqrt(u*u/(l.w*l.h)),l.resize(Math.floor(l.w*f),Math.floor(l.h*f)));const g=new iG({width:l.w,height:l.h});for(let t=0;t<a;t++){const i=n[t];e&&this._fillTexCoord(e,t,i,f);const o=s[i.id];if(!o)continue;const a=Math.floor(i.w*f),l=Math.floor(i.h*f);h.width=a,h.height=l,c.drawImage(o,0,0,a,l);const u=c.getImageData(0,0,a,l);iG.copy(u,g,{x:0,y:0},{x:Math.floor(i.x*f),y:Math.floor(i.y*f)},{width:a,height:l})}return g.format="rgba",g}_fillTexCoord(e,t,n,i){const{x:s,y:o,w:a,h:l}=n,h=Math.floor(s*i),c=Math.floor((s+a)*i),u=Math.floor(o*i),f=Math.floor((o+l)*i),g=12*t;oG[0]=h,oG[1]=f,e.set(oG,g),oG[0]=c,oG[1]=u,e.set(oG,g+2),oG[0]=h,oG[1]=u,e.set(oG,g+4),oG[0]=h,oG[1]=f,e.set(oG,g+6),oG[0]=c,oG[1]=f,e.set(oG,g+8),oG[0]=c,oG[1]=u,e.set(oG,g+10)}init(){this.renderer=new CM.Renderer(this.regl);const e=[],t={vert:$z,frag:"#define SHADER_NAME BILL_BOARD\nprecision mediump float;\n#include <gl2_frag>\nuniform sampler2D billTexture;\nuniform vec2 textureSize;\nvarying vec2 vTexCoord;\nvoid main() {\n  glFragColor = texture2D(billTexture, vTexCoord / textureSize);\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat c = shadow_computeShadow();\n  glFragColor.rgb = shadow_blend(glFragColor.rgb, c);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,n){return vA(e,n.projViewMatrix,n.modelMatrix),e}}],defines:null,extraCommandProps:{viewport:{x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},cull:{enable:!1}}};if(this.shader=new CM.MeshShader(t),this.shader.version=300,this.pickingFBO){const e=[];this.picking=[new CM.FBORayPicking(this.renderer,{vert:"#define PICKING_MODE 1\n"+$z,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,n){return vA(e,n.projViewMatrix,n.modelMatrix),e}}],extraCommandProps:{viewport:this.pickingViewport,depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},cull:{enable:!1}}},this.pickingFBO,this.getMap())]}}getUniformValues(e){return{projViewMatrix:e.projViewMatrix}}deleteMesh(e,t){if(Array.isArray(e))for(let t=0;t<e.length;t++){const n=e[t];if(n.geometry){const e=n.geometry.properties;e.textureCache&&(delete e.billTexture,delete e.textureCache,delete e.contextCache)}}else if(e.geometry){const t=e.geometry.properties;t.textureCache&&(delete t.billTexture,delete t.textureCache,delete t.contextCache)}return super.deleteMesh(e,t)}}const hG=AA([]),cG={};class sa extends OF{isEnableTileStencil(){return!1}isTerrainMask(){return this.layer.options.awareOfTerrain}needPolygonOffset(){return!1}createMesh(e,t){const{geometry:n,symbolIndex:i}=e,s=new CM.Material({},cG),o=new CM.Mesh(n,s,{castShadow:!1,picking:!1});o.positionMatrix=this.getAltitudeOffsetMatrix(),o.setLocalTransform(t),o.properties.symbolIndex=i;const a={};return n.data.aAltitude&&(a.HAS_ALTITUDE=1),o.setDefines(a),o}init(e){const t=this.canvas,n={x:(e,t)=>t.viewport?t.viewport.x:0,y:(e,t)=>t.viewport?t.viewport.y:0,width:(e,n)=>n.viewport?n.viewport.width:t?t.width:1,height:(e,n)=>n.viewport?n.viewport.height:t?t.height:1};this.renderer=new CM.Renderer(this.regl);this._createShader(e,{viewport:n,depth:{enable:!0,func:">="}})}_createShader(e,t){const n=[],i=[{name:"projViewModelMatrix",type:"function",fn:function(e,t){return vA(n,t.projViewMatrix,t.modelMatrix),n}}];this.shader=new CM.MeshShader({name:"vt-terrain-flat-mask",vert:"#define SHADER_NAME VT_HEIGHT_MASK_VERT\n#include <gl2_vert>\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nuniform mat4 projViewModelMatrix;\nuniform mat4 positionMatrix;\n#include <vt_position_vert>\nvarying float vAltitude;\nvoid main() {\n  vec3 c = unpackVTPosition();\n  vec4 d = positionMatrix * vec4(c, 1.);\n  vAltitude = d.z / 100.0;\n  d.z = .0;\n  gl_Position = projViewModelMatrix * d;\n}",frag:"#define SHADER_NAME VT_HEIGHT_MASK_FRAG\nprecision highp float;\n#include <gl2_frag>\nvarying float vAltitude;\n#include <common_pack_float>\nvoid main() {\n  glFragColor = encodeFloat32(vAltitude);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:i,extraCommandProps:t})}getUniformValues(e,t){return{projViewMatrix:hG,viewport:t&&t.viewport}}}const uG=ND("fill",tH);uG.registerAt(CD);const fG=ND("line",oH);fG.registerAt(CD);const dG=ND("line-gradient",AH);dG.registerAt(CD);const pG=ND("icon",$N);pG.registerAt(CD);const gG=ND("text",Eo);gG.registerAt(CD);const mG=ND("native-line",Bo);mG.registerAt(CD),ND("native-point",zo).registerAt(CD);const AG=ND("phong",uz);AG.registerAt(CD);const yG=ND("wireframe",dz);yG.registerAt(CD);const _G=ND("lit",Az);_G.registerAt(CD);const vG=ND("tube",xz);vG.registerAt(CD);const xG=ND("gltf-phong",Uz);xG.registerAt(CD);const bG=ND("gltf-lit",Vz);bG.registerAt(CD);const wG=ND("heatmap",class extends OF{createFnTypeConfig(e,t){const n=CE(t.heatmapWeight),i=new Int16Array(1);return[{attrName:"aWeight",symbolName:"heatmapWeight",type:Int16Array,width:1,define:"HAS_HEAT_WEIGHT",evaluate:t=>{const s=n(e.getZoom(),t);return i[0]=255*s,i[0]}}]}createMesh(e,t){const{geometry:n,symbolIndex:i,ref:s}=e;void 0===s&&VD(n,this.getSymbolDef(i),this.getFnTypeConfig(i),this.layer);const o=this.getSymbol(i),a={tileRatio:n.properties.tileRatio,dataResolution:n.properties.tileResolution};ZL(a,"heatmapIntensity",o,"heatmapIntensity",1),ZL(a,"heatmapRadius",o,"heatmapRadius",6),ZL(a,"heatmapWeight",o,"heatmapWeight",1),ZL(a,"heatmapOpacity",o,"heatmapOpacity",1),n.generateBuffers(this.regl);const l=new CM.Material(a),h=new CM.Mesh(n,l,{transparent:!0,castShadow:!1,picking:!0}),c={};return n.data.aWeight&&(c.HAS_HEAT_WEIGHT=1),h.setDefines(c),h.setLocalTransform(t),h.properties.symbolIndex=i,h}callRenderer(e,t,n){const i=this.getRenderFBO(n);this._drawCount+=this._process.render(this.scene,t,i)}getUniformValues(e){const t=this.getSymbol({index:0}),{projViewMatrix:n}=e;return{glScale:1/e.getGLScale(),resolution:e.getResolution(),projViewMatrix:n,heatmapOpacity:t.heatmapOpacity}}getHeatmapMeshes(){return this.scene.getMeshes()}delete(){super.delete(...arguments),this._process.dispose(),delete this._process}init(){this.renderer=new CM.Renderer(this.regl);const e=this.getPolygonOffset(),t=this.getSymbols()[0];this._process=new HeatmapProcess(this.regl,this.sceneConfig,this.layer,t.heatmapColor,null,e)}});wG.registerAt(CD);const TG=ND("water",Jz);TG.registerAt(CD);const SG=ND("billboard",ia);SG.registerAt(CD);const MG=ND("terrain-flat-mask",sa);MG.registerAt(CD),LD.registerPainter("lit",Az),LD.registerPainter("icon",$N),LD.registerPainter("fill",tH),LD.registerPainter("line",oH),LD.registerPainter("line-gradient",AH),LD.registerPainter("water",Jz),LD.registerPainter("tube",xz),LD.registerPainter("billboard",ia);class ba extends CD{getTileUrl(e,t,n){const i=this.getMap().getResolution(n);return super.getTileUrl(e,t,function(e){return 19-Math.log(e/CG)/Math.LN2}(i))}static fromJSON(e){return e&&"MapboxVectorTileLayer"===e.type?new ba(e.id,e.options):null}}ba.registerJSONType("MapboxVectorTileLayer");const CG=12756274*Math.PI/(256*Math.pow(2,20));class wa extends CD{constructor(e,t){(t=t||{}).spatialReference=null,super(e,t),this.setData(t.data)}onAdd(){this._prepareOptions()}_prepareOptions(){const e=this.getMap(),t=e.getMaxNativeZoom(),n=e.getProjection(),i="EPSG:4326"===n.code||"EPSG:4490"===n.code;var s;i&&(this.options.tileSystem=[1,-1,-180,90]),this.options.spatialReference=i?function(e,t){return{projection:t,fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){const t=[];for(let n=0;n<=e+1;n++)t[n]=90/(128*Math.pow(2,n));return t}()}}(t,n.code):(s=t,{projection:"EPSG:3857",resolutions:function(){const e=[],t=6378137*Math.PI;for(let n=0;n<=s+1;n++)e[n]=t/(256*Math.pow(2,n));return e}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}})}getWorkerOptions(){const e=super.getWorkerOptions();let t=this.options.data;return sL(t)||t&&t.url?(t.url&&(t=JSON.parse(JSON.stringify(t))),t=IG(t,this.getURLModifier())):t=this.features,e.data=t,e.tileBuffer=this.options.tileBuffer,e.extent=this.options.extent,e.hasAltitude=this.options.enableAltitude,e.simplifyTolerance=this.options.simplifyTolerance,e.projection=this.getSpatialReference().getProjection().code,e.generateOMBB=this.options.generateOMBB,e.convertFn=this.options.convertFn?this.options.convertFn+"":null,e}setData(e){return this.options.data=e,e&&(sL(e)||e.url)?(!!this.getRenderer()&&this._updateWorker(),this):(this._setData(e),this._updateWorker(),this)}_setData(e){return this.options.convertFn&&(e=new Function("data",this.options.convertFn+"\nreturn convert(data)")(e)),this.features=e,this._generateIdMap(),this}_updateWorker(){const e=this.getRenderer();if(e){const t=e.getWorkerConnection();if(t){let n=this.options.data;sL(n)||n&&n.url?(n.url&&(n=JSON.parse(JSON.stringify(n))),n=IG(n,this.getURLModifier())):n=this.features,t.setData(n,((t,n)=>{e.clear(),this.onWorkerReady(null,n),e.setToRedraw(),setTimeout((()=>{e.setToRedraw()}),500)}))}}}getExtent(){return this._dataExtent}onWorkerReady(e,t){e?this.fire("dataerror",{error:e}):(t&&(t.extent&&this._setExtent(t.extent),t.idMap&&(this._idMaps=t.idMap)),this.fire("dataload",{extent:t&&t.extent}))}_setExtent(e){this._dataExtent=new Ml(...e)}_fetchData(e,t){sL(e)?mL.getJSON(e,t):mL.getJSON(e.url,e,t)}getData(){return this.features||null}getTileUrl(e,t,n){return this.getId()+","+e+","+t+","+n}getFeature(e){return this._idMaps[e]}static fromJSON(e){return e&&"GeoJSONVectorTileLayer"===e.type?new wa(e.id,e.options):null}getGeometryById(e){return this._idMaps?this._idMaps[e]:null}_generateIdMap(){if(!this.features)return;if(this.features=JSON.parse(JSON.stringify(this.features)),!this.features)return;let e=0;this._idMaps={};const t=this.options.featureIdProperty,n=this.features;Array.isArray(n)?n.forEach((n=>{if(n){if(oL(n.id)||(n.id=e++),t){let e=t;lL(t)&&(e=t[n.layer||"0"]),n.id=n.properties[e]}this._idMaps[n.id]=n}})):n.features&&n.features.forEach((n=>{if(n){if(oL(n.id)||(n.id=e++),t){let e=t;lL(t)&&(e=t[n.layer||"0"]),n.id=n.properties[e]}this._idMaps[n.id]=n}}))}}function PG(e){let t=document.createElement("a");return t.href=e,e=t.href,t=null,e}function IG(e,t){return e.url?e.url=t?t(e.url):PG(e.url):e=t?t(e):PG(e),e}wa.registerJSONType("GeoJSONVectorTileLayer"),wa.mergeOptions({features:"id",tileBuffer:64,extent:8192,pyramidMode:1,simplifyTolerance:3,tileStackDepth:0,generateOMBB:!0});const{LayerAbstractRenderer:kG}=Om,{SYMBOLS_NEED_REBUILD_IN_VECTOR:OG,GlyphRequestor:EG,PointPack:RG,LinePack:LG,StyledPoint:DG,VectorPack:FG,StyledVector:HG}=eL();let NG=!1,BG=1;const zG="_symbol_".trim(),GG=(OL+"").trim();let UG=new Float32Array(1);const VG=[];class Ga extends(OP(kG)){constructor(...e){super(...e),this.features={},this._geometries={},this._counter=0,this._allFeatures={},this._featureMapping={},this._markerFeatures={},this._textFeatures={},this._lineFeatures={},this._dirtyAll=!0,this._kidGen={id:0,pickingId:0},this._dirtyTargetsInCurrentFrame={}}setURLModifier(e){this._urlModifier=e}getURLModifier(){return this._urlModifier}needToRedraw(){return super.needToRedraw()||this.painter&&this.painter.needToRedraw()||this._markerPainter&&this._markerPainter.needToRedraw()||this._linePainter&&this._linePainter.needToRedraw()}getAnalysisMeshes(){return this.painter&&this.painter.getAnalysisMeshes()||VG}getRayCastData(){return null}draw(e,t){this._frameTime=e;const n=this.layer;this.prepareCanvas(),this._zScale=this._getCentiMeterScale(this.getMap().getGLRes()),this._parentContext=t||{};const i=this._parentContext.renderMode,s=this._preparePaintContext();if(this._startFrame(s,i),this._dirtyAll)this.buildMesh(),this._buildMarkerMesh(),this._buildLineMesh(),this._dirtyTargetsInCurrentFrame={},this._dirtyGeo=!1,this._dirtyAll=!1,this._dirtyLine=!1;else if(this._dirtyGeo){const e=this.atlas,t=this._markerAtlas,n=this._lineAtlas;delete this.atlas,delete this._markerAtlas,delete this._lineAtlas,this.buildMesh(e),this._buildMarkerMesh(t),this._buildLineMesh(n),this._dirtyGeo=!1,this._dirtyLine=!1}else if(this._dirtyLine){const e=this._lineAtlas;delete this._lineAtlas,this._buildLineMesh(e),this._dirtyLine=!1}if(!this.meshes&&!this._markerMeshes&&!this._lineMeshes)return void this.completeRender();this._showHideUpdated&&(this._updateMeshVisible(),this._showHideUpdated=!1),this._updateDirtyTargets();const o=!i||"default"===i;let a=0;0===this.layer.options.meshRenderOrder&&this._renderMeshes(s,a,i);let l=0;if(this._lineMeshes&&(o||this._linePainter.supportRenderMode(i))){this._linePainter.startFrame(s),this._linePainter.addMesh(this._lineMeshes,null,{bloom:this._parentContext.bloom}),this._linePainter.prepareRender(s);const e=s.polygonOffsetIndex||0;a=this.meshes&&this.meshes.length?a-1:a,s.polygonOffsetIndex=(s.polygonOffsetIndex||0)+a,l=this._linePainter.render(s).drawCount,s.polygonOffsetIndex=e}if(1===this.layer.options.meshRenderOrder&&this._renderMeshes(s,l?a-1:a,i),this._markerMeshes&&(o||this._markerPainter.supportRenderMode(i))){const t=!this._parentContext.timestamp||this._parentContext.isFinalRender,i=!this._collisionTimestamp||this._collisionTimestamp!==e;n.options.collision&&i&&n.clearCollisionIndex();const o=this.layer.options.sceneConfig;this._markerPainter.sceneConfig.collision=!o||!!hL(o.collision)||o.collision,this._markerPainter.startFrame(s),this._markerPainter.addMesh(this._markerMeshes,null,{bloom:this._parentContext.bloom}),this._markerPainter.prepareRender(s),n.options.collision&&i&&(this._markerPainter.updateCollision(s),t&&(this._collisionTimestamp=e)),this._markerPainter.render(s)}(o||t&&t.isFinalRender)&&(this.completeRender(),this.layer.fire("canvasisdirty"))}_startFrame(e,t){this.painter&&(!t||"default"===t||this.painter.supportRenderMode(t))&&this.painter.startFrame(e)}_renderMeshes(e,t,n){return this.painter&&this.meshes&&(!n||"default"===n||this.painter.supportRenderMode(n))?(this.painter.addMesh(this.meshes,null,{bloom:e&&e.bloom}),this.painter.prepareRender(e),e.polygonOffsetIndex=(e.polygonOffsetIndex||0)+t,this.painter.render(e)):{redraw:!1,drawCount:0}}supportRenderMode(){return!0}isForeground(){return!0}_preparePaintContext(){const e={regl:this.regl,layer:this.layer,symbol:this._layerSymbol,gl:this.gl,sceneConfig:this.layer.options.sceneConfig,pluginIndex:0,cameraPosition:this.getMap().cameraPosition,timestamp:this.getFrameTimestamp()};return this._parentContext&&iL(e,this._parentContext),e}drawOnInteracting(e,t,n){this.draw(t,n)}getFrameTimestamp(){return this._frameTime}_getFeaturesToRender(e,t){(e=e||t)===t&&(t=null);const n=[],i=[0,0,0,0];this.layer._sortGeometries();const s=this.layer.getGeometries();for(let o=0;o<s.length;o++){const a=s[o][dH];if(!this.features[a])continue;const l=this.features[a];if(Array.isArray(l))for(let s=0;s<l.length;s++){const o=l[s],a=o[GG];(!e||e[a]||t&&(!t||t[a]))&&(o.visible||(this._showHideUpdated=!0),this._addCoordsToCenter(o.geometry,i,o.coordinates),n.push(o))}else{l.visible||(this._showHideUpdated=!0);const s=l[GG];if(e&&!e[s]&&(!t||t&&!t[s]))continue;this._addCoordsToCenter(l.geometry,i,l.coordinates),n.push(l)}}if(n.length||(this.meshes&&this.painter&&(this.painter.deleteMesh(this.meshes),delete this.meshes),this._markerMeshes&&(this._markerPainter.deleteMesh(this._markerMeshes),delete this._markerMeshes),this._lineMeshes&&(this._linePainter.deleteMesh(this._lineMeshes),delete this._lineMeshes)),i[3]&&(i[0]/=i[3],i[1]/=i[3]),isNaN(i[0])||isNaN(i[1]))throw new Error(`invalid geometry coordinates for ${this.layer.getJSONType()}`);return{features:n,center:i}}buildMesh(){}createVectorPacks(e,t,n,i,s,o){return e&&i&&i.length?new t(i,n,{zoom:this.getMap().getZoom(),EXTENT:1/0,requestor:this.requestor,atlas:s,center:o,positionType:Float32Array}).load():Promise.resolve(null)}createMesh(e,t,n,i,s,o){return this.createVectorPacks(e,t,n,i,s,o).then((a=>this._createMesh(a,e,t,n,i,s,o)))}_createMesh(e,t,n,i,s,o,a){if(!e)return null;const l=t.createGeometries([e.data],FL(s,null,0,i,this.layer));for(let e=0;e<l.length;e++)l[e]&&this._fillCommonProps(l[e].geometry);const h=AA([]);xA(h,h,ZA([],a[0],a[1],0)),bA(h,h,ZA([],1,1,this._zScale));const c=t.createMeshes(l,h,{tilePoint:[a[0],a[1]]});for(let e=0;e<c.length;e++){const t=c[e];t.properties.level=0,t.properties.tileTransform=h;const n=t.defines;n.ENABLE_TILE_STENCIL=1,t.setDefines(n),t.properties.meshKey=this.layer.getId()}return{meshes:c,atlas:{iconAtlas:e.data.iconAtlas}}}_addCoordsToCenter(e,t,n){for(let i=0;i<e.length;i++)if(Array.isArray(e[i][0]))for(let s=0;s<e[i].length;s++)if(Array.isArray(e[i][s][0]))for(let o=0;o<e[i][s].length;o++)isNaN(+e[i][s][o][0])||isNaN(+e[i][s][o][1])||this._addCoord(t,e[i][s][o][0],e[i][s][o][1],e[i][s][o][2],1,n[i][s][o]);else isNaN(+e[i][s][0])||isNaN(+e[i][s][1])||this._addCoord(t,e[i][s][0],e[i][s][1],e[i][s][2],1,n[i][s]);else isNaN(+e[i][0])||isNaN(+e[i][1])||this._addCoord(t,e[i][0],e[i][1],e[i][2],1,n[i])}_addCoord(e,t,n,i,s,o){const a=this.getMap().getProjection().isSphere();let l=!1;(o[0]>180||o[0]<-180)&&a&&!NG&&(l=!0,NG=!0,console.warn(`Layer(${this.layer.getId()}) has invalid longitude value: ${o[0]}`)),(o[1]>90||o[1]<-90)&&a&&!NG&&(l=!0,NG=!0,console.warn(`Layer(${this.layer.getId()}) has invalid latitude value: ${o[1]}`)),l||(e[0]+=t,e[1]+=n,e[2]+=i||0,e[3]+=s)}_fillCommonProps(e){const t=this.getMap().getGLRes(),n=e.properties;n.tileResolution=t,n.tileRatio=1,n.z=1,n.tileExtent=1,n.elements=e.elements,n.aPickingId=e.data.aPickingId}_isEnableWorkAround(e){return"win-intel-gpu-crash"===e&&this.gl&&this.layer.options.workarounds["win-intel-gpu-crash"]&&WG(this.gl)}prepareRequestors(){if(this._iconRequestor)return;const e=this.layer;this._iconRequestor=new yL({iconErrorUrl:e.options.iconErrorUrl,urlModifier:t=>{const n=e.getURLModifier();return n&&n(t)||t}});const t=!this._isEnableWorkAround("win-intel-gpu-crash");this._glyphRequestor=new EG((t=>{e.getMap().getRenderer().callInNextFrame(t)}),e.options.glyphSdfLimitPerFrame,t),this.requestor=this._fetchPattern.bind(this),this._markerRequestor=this._fetchIconGlyphs.bind(this)}_fetchPattern(e,t,n){const i=[];this._iconRequestor.getIcons(e,((e,t)=>{if(e)throw e;t.buffers&&i.push(...t.buffers),n(null,{icons:t.icons},i)}))}_fetchIconGlyphs(e,t,n){this._glyphRequestor.getGlyphs(t,((t,i)=>{if(t)throw t;const s=i.buffers||[];this._iconRequestor.getIcons(e,((e,t)=>{if(e)throw e;t.buffers&&t.buffers.length&&s.push(...t.buffers),n(null,{icons:t.icons,glyphs:i.glyphs},s)}))}))}_buildMarkerMesh(e){const t=Object.keys(this._markerFeatures),n=Object.keys(this._textFeatures);if(!t.length&&!n.length)return void(this._markerMeshes&&(this._markerPainter.deleteMesh(this._markerMeshes),delete this._markerMeshes));const{features:i,center:s}=this._getFeaturesToRender(this._markerFeatures,this._textFeatures),o=[],a=[];for(let e=0;e<i.length;e++){const t=i[e][GG];this._markerFeatures[t]&&o.push(i[e]),this._textFeatures[t]&&a.push(i[e])}if(!o.length&&!a.length)return void(this._markerMeshes&&(this._markerPainter.deleteMesh(this._markerMeshes),delete this._markerMeshes));const l=this._showHideUpdated;this._markerCenter=s;const h=this._createPointPacks(o,a,e,s);this._markerAtlas={};const c=[],u=[];this._isCreatingMarkerMesh=!0,Promise.all(h).then((e=>{if(this._markerMeshes&&(this._markerPainter.deleteMesh(this._markerMeshes),delete this._markerMeshes),!e||!e.length)return void this.setToRedraw();const t=this._markerPainter.createGeometries(e.map((e=>(e&&e.data&&(e.data.isIdUnique=!0),e&&e.data))),this._allFeatures);for(let n=0;n<t.length;n++)this._fillCommonProps(t[n].geometry,e[n]&&e[n].data);const n=e[0]&&e[0].data.iconAtlas,i=e[0]&&e[0].data.glyphAtlas||e[1]&&e[1].data.glyphAtlas;n&&(this._markerAtlas.iconAtlas=n),i&&(this._markerAtlas.glyphAtlas=i);const o=AA([]);xA(o,o,ZA(u,s[0],s[1],0)),bA(o,o,ZA(c,1,1,this._zScale));const a=this._markerPainter.createMeshes(t,o);for(let e=0;e<a.length;e++)a[e].geometry.properties.originElements=a[e].geometry.properties.elements.slice(),a[e].properties.level=0,a[e].material.set("flipY",1),a[e].properties.meshKey=BG++;this._markerMeshes=a,l&&(this._showHideUpdated=!0),this._isCreatingMarkerMesh=!1,this.setToRedraw(),this.layer.fire("buildmarkermesh")}))}_updateMeshVisible(){if(this._markerMeshes&&(this._updateVisElements(this._markerMeshes[0],this._markerFeatures),this._updateVisElements(this._markerMeshes[1],this._textFeatures),this._markerMeshes[0]&&this._markerPainter.prepareCollideIndex(this._markerMeshes[0].geometry),this._markerMeshes[1]&&this._markerPainter.prepareCollideIndex(this._markerMeshes[1].geometry)),this._lineMeshes)for(let e=0;e<this._lineMeshes.length;e++)this._updateVisElements(this._lineMeshes[e],this._lineFeatures);if(this.meshes)for(let e=0;e<this.meshes.length;e++)this._updateVisElements(this.meshes[e],this._allFeatures)}_updateVisElements(e,t){if(!e)return;const{aPickingId:n,originElements:i}=e.geometry.properties,s=[];for(let e=0;e<i.length;e++){const o=n[i[e]];t[o]&&t[o].feature.visible&&s.push(i[e])}const o=e.geometry.properties.elements=new i.constructor(s);e.geometry.setElements(o)}_createPointPacks(e,t,n,i){const s={zoom:this.getMap().getZoom(),EXTENT:1/0,requestor:this._markerRequestor,atlas:n,center:i,positionType:Float32Array,defaultAltitude:0,forceAltitudeAttribute:!0,markerWidthType:Uint16Array,markerHeightType:Uint16Array,allowEmptyPack:1};return[this._markerSymbol].map(((n,i)=>new RG(0===i?e:t,n,s).load()))}updateMesh(){}_updateMarkerMesh(e){const t=e._getInternalSymbol(),n={zoom:this.getMap().getZoom(),isVector3D:!0},i=this._convertGeo(e);if(!this._markerMeshes)return!1;let s=this.features[i];Array.isArray(s)||(s=[s]);const o=[],a=[],l=[],h=this.getMap().getZoom();let c,u;c=Array.isArray(t)?t.map((e=>e?IE(e,(()=>(o[0]=h,o))):e)):IE(t,(()=>(o[0]=h,o))),u=Array.isArray(t)?t.map((e=>e?FG.genFnTypes(e):e)):FG.genFnTypes(t);for(let e=0;e<s.length;e++){if(!s[e])continue;const i=Array.isArray(t)?t[e]:t,o=Array.isArray(c)?c[e]:c,a=Array.isArray(u)?u[e]:u,l=new DG(s,i,o,a,n).getIconAndGlyph();if(!this._markerAtlas||!RG.isAtlasLoaded(l,this._markerAtlas))return this._markRebuild(),this.setToRedraw(),!1}for(let e=0;e<s.length;e++){const t=s[e][GG];this._markerFeatures[t]&&a.push(s[e]),this._textFeatures[t]&&l.push(s[e])}const f=s[0].id,g=this._createPointPacks(a,l,this._markerAtlas,this._markerCenter),m=this._markerMeshes;return Promise.all(g).then((e=>{for(let t=0;t<e.length;t++){if(!e[t])continue;e[t].data&&(e[t].data.isIdUnique=!0);const n=m[t],i=n.geometry.properties.aFeaIds.indexOf(f);if(i<0)continue;const s=e[t].data.featureIds.length,o=e[t].data.dynamicAttributes;for(const a in e[t].data.data){if("aPickingId"===a)continue;if(o[a])continue;const l=e[t].data.data[a];l&&n.geometry.updateSubData(a,l,i*l.length/s)}}this.setToRedraw()})),!0}_updateLineMesh(e){return this._updateMesh(e,this._lineMeshes,this._lineAtlas,this._lineCenter,this._linePainter,LG,hH,this._groupLineFeas)}_updateMesh(e,t,n,i,s,o,a,l){if(!t)return!1;if(!n)return this._markRebuild(),this.setToRedraw(),!1;const h=e._getInternalSymbol(),c={zoom:this.getMap().getZoom()};let u=this.features[e[dH]];Array.isArray(u)||(u=[u]);const f=[];for(let e=0;e<u.length;e++){const t=u[e];if(!t)continue;const i=Array.isArray(h)?h[e]:h,s=FG.genFnTypes(i),a=new HG(u,i,s,c),l=o===LG?a.getLineResource():a.getPolygonResource();if(!FG.isAtlasLoaded(l,n[e]))return this._markRebuild(),this.setToRedraw(),!1;f.push(t)}const g=u[0].id,m=l.call(this,f);for(let e=0;e<m.length;e++)if(m[e].length){const n=t.filter((t=>t.feaGroupIndex===e));if(!n.length)return this._markRebuild(),this.setToRedraw(),!1;if(n[0].geometry.properties.aFeaIds.indexOf(g)<0)return this._markRebuild(),this.setToRedraw(),!1}const A=iL({},a),w=m.map((e=>this.createVectorPacks(s,o,A,e,n[0],i)));return Promise.all(w).then((e=>{for(let n=0;n<e.length;n++){let i;if(Array.isArray(t)){for(let e=0;e<t.length;e++)if(t[e].feaGroupIndex===n){i=t[e];break}}else i=t;i&&this._updateMeshData(i,g,e[n])}})),!0}_updateMeshData(e,t,n){const i=e.geometry.properties.aFeaIds,s=i.indexOf(t);if(!(s<0)){if(n){const t=n.data.dynamicAttributes,i=n.data.featureIds.length,o=n.data.data;for(const n in o)if(!t[n]&&fL(o,n)&&o[n]){const t=o[n];e.geometry.updateSubData(n,t,s*t.length/i)}}else{let n=s+1;for(;i[n]===t;)n++;const o=n-s,a=e.geometry.desc.positionSize;UG.length!==3*o&&(UG=new Float32Array(o*a),UG.fill(-1/0,0)),e.geometry.updateSubData(e.geometry.desc.positionAttribute,UG,s*a)}this.layer.fire("updatemesh"),this.setToRedraw()}}_buildLineMesh(e){if(!Object.keys(this._lineFeatures).length)return void(this._lineMeshes&&(this._linePainter.deleteMesh(this._lineMeshes),delete this._lineMeshes));const{features:t,center:n}=this._getFeaturesToRender(this._lineFeatures);if(!t.length)return;const i=this._showHideUpdated;this._lineCenter=n;const s=this._groupLineFeas(t),o=iL({},hH),a=s.map(((t,i)=>this.createMesh(this._linePainter,LG,o,t,e&&e[i],n)));this._isCreatingLineMesh=!0,Promise.all(a).then((e=>{this._lineMeshes&&this._linePainter.deleteMesh(this._lineMeshes);const t=[],n=[];for(let i=0;i<e.length;i++){const s=e[i]&&e[i].meshes;if(s){for(let e=0;e<s.length;e++){const n=s[e];n.feaGroupIndex=i,t.push(n),n.geometry.properties.originElements=n.geometry.properties.elements.slice()}n[i]=e[i].atlas}}this._lineMeshes=t,this._lineAtlas=n,i&&(this._showHideUpdated=i),this._isCreatingLineMesh=!1,this.setToRedraw(),this.layer.fire("buildlinemesh")}))}_groupLineFeas(e){const t=(zG+"lineDasharray").trim(),n=(zG+"linePatternFile").trim(),i=[],s=[],o=[];for(let a=0;a<e.length;a++){const l=e[a],h=l.properties&&l.properties[t];h&&QG(h)?o.push(l):l.properties&&l.properties[n]?s.push(l):i.push(l)}return[i,s,o]}_markRebuildGeometry(){this._dirtyGeo=!0,this.setToRedraw()}_markRebuild(){this._dirtyAll=!0,this.setToRedraw()}_convertGeometries(e){const t=this.layer.getId();for(let n=0;n<e.length;n++){const i=e[n];let s=!1;for(let e=0;e<this.GeometryTypes.length;e++)if(i instanceof this.GeometryTypes[e]){s=!0;break}if(!s)throw new Error(`${i.getJSONType()} can't be added to ${this.layer.getJSONType()}(id:${t}).`);this._convertGeo(i)}}_convertGeo(e){void 0===e[dH]&&(e[dH]=this._counter++);const t=e[dH];this.features[t]&&this._removeFeatures(t),this.features[t]=gH(e,this._kidGen,this.features[t]);return this._refreshFeatures(this.features[t],t),this._geometries[t]=e,t}_refreshFeatures(e,t){if(!e)return;const n=Array.isArray(e)?e[0].id:e.id;if(this._featureMapping[n]=e,Array.isArray(e))for(let n=0;n<e.length;n++){const i=e[n][GG];if(e[n][dH]=t,this._allFeatures[i]={feature:e[n]},this._allFeatures[i][dH]=t,!this.needCheckPointLineSymbols())continue;const s={feature:e[n]};(qG(e[n])||ZG(e[n]))&&(this._markerFeatures[i]=s),ZG(e[n])&&(this._textFeatures[i]=s),JG(e[n])&&(this._lineFeatures[i]=s)}else{e[dH]=t;const n={feature:e},i=e[GG];if(this._allFeatures[i]=n,!this.needCheckPointLineSymbols())return;(qG(e)||ZG(e))&&(this._markerFeatures[i]=n),ZG(e)&&(this._textFeatures[i]=n),JG(e)&&(this._lineFeatures[i]=n)}}needCheckPointLineSymbols(){return!0}_removeFeatures(e){const t=this.features[e];if(t)if(Array.isArray(t))for(let e=0;e<t.length;e++){const n=t[e][GG];delete this._featureMapping[t[e].id],delete this._allFeatures[n],delete this._markerFeatures[n],delete this._textFeatures[n],delete this._lineFeatures[n]}else{const e=t[GG];delete this._featureMapping[t.id],delete this._allFeatures[e],delete this._markerFeatures[e],delete this._textFeatures[e],delete this._lineFeatures[e]}}pick(e,t,n){const i=[];return this.layer.isVisible()?([this.painter,this._markerPainter,this._linePainter].forEach((s=>{if(!s)return;const o=s.pick(e,t,n.tolerance);if(o&&o.data&&o.data.feature){const e=this._geometries[o.data.feature[dH]];n&&n.includeInternals?i.push(e):(o.geometry=e,delete o.plugin,delete o.data,delete o.point,i.push(o))}})),i):i}_getFeaKeyId(e){const t=this.features[e[dH]];return Array.isArray(t)?t[0][GG]:t[GG]}_updateDirtyTargets(){let e=!1;for(const t in this._dirtyTargetsInCurrentFrame){const n=this._dirtyTargetsInCurrentFrame[t],i=this._getFeaKeyId(n);if(!this._isCreatingMarkerMesh&&(this._markerFeatures[i]||this._textFeatures[i])){const t=this._updateMarkerMesh(n);e=e||t}if(!this._isCreatingLineMesh&&this._lineFeatures[i]){const t=this._updateLineMesh(n);e=e||t}if(!this._isCreatingMesh){const t=this.updateMesh(n);e=e||t}}this._dirtyTargetsInCurrentFrame={},e&&(jG(this),this.layer.fire("partialupdate"))}_convertAndRebuild(e){this._convertGeo(e),this._markRebuild(),jG(this)}onGeometryAdd(e){this.setToRedraw(),this.canvas&&e&&e.length&&(this._convertGeometries(e),this._markRebuild(),jG(this))}onGeometryRemove(e){if(e&&e.length){for(let t=0;t<e.length;t++){const n=e[t][dH];void 0!==n&&(delete this._geometries[n],this._removeFeatures(n),delete this.features[n])}this._markRebuild(),jG(this)}}onGeometrySymbolChange(e){const t=e.target._getParent()||e.target,n=t[dH];if(void 0===n)return;let i=e.properties;if(Array.isArray(i)){const e={};for(let t=0;t<i.length;t++)i[t]&&iL(e,i[t]);i=e}else if(i&&void 0!==i[0]){const e={};for(const t in i)i[t]&&iL(e,i[t]);i=e}for(const e in i)if(fL(i,e)&&OG[e])return void this._convertAndRebuild(t);const s=t._getInternalSymbol(),o=this.features[n];if(this._convertGeo(t),o)if(function(e,t){return Array.isArray(e)?!!Array.isArray(t)&&e.length===t.length:!Array.isArray(t)}(s,o)){if(Array.isArray(s)){for(let e=0;e<s.length;e++)if(!$G(s[e],o[e]))return void this._convertAndRebuild(t)}else if(!$G(s,o))return void this._convertAndRebuild(t);this.onGeometryPositionChange(e)}else this._convertAndRebuild(t);else this._convertAndRebuild(t)}onGeometryShapeChange(e){const t=e.target._getParent()||e.target;void 0!==t[dH]&&(this._convertGeometries([t]),this._markRebuildGeometry(),jG(this))}onGeometryPositionChange(e){const t=e.target._getParent()||e.target,n=t[dH];void 0!==n&&(this._convertGeometries([t]),this._dirtyTargetsInCurrentFrame[n]=t,jG(this))}onGeometryZIndexChange(e){void 0!==(e.target._getParent()||e.target)[dH]&&this._markRebuild()}onGeometryShow(e){void 0!==(e.target._getParent()||e.target)[dH]&&this._onShowHide(e)}onGeometryHide(e){void 0!==(e.target._getParent()||e.target)[dH]&&this._onShowHide(e)}_onShowHide(e){const t=e.target._getParent()||e.target,n=this.features[t[dH]];if(n){const e=t.isVisible();if(Array.isArray(n)){if(e===n[0].visible)return;for(let t=0;t<n.length;t++)n[t].visible=e}else{if(e===n.visible)return;n.visible=e}this._markShowHide(),jG(this)}}_markShowHide(){this._showHideUpdated=!0}onGeometryPropertiesChange(e){const t=e.target._getParent()||e.target,n=t[dH];void 0!==n&&this.painter&&(this.features[n]=gH(t,this._kidGen),this._refreshFeatures(this.features[n],n),this._markerMeshes&&this._markerMeshes.length&&this._markerPainter.needRebuildOnGometryPropertiesChanged()||this._lineMeshes&&this._lineMeshes.length&&this._linePainter.needRebuildOnGometryPropertiesChanged()||this.meshes&&this.meshes.length&&this.painter.needRebuildOnGometryPropertiesChanged()?this._markRebuild():this.painter.onFeatureChange(this.features[n],this.meshes),jG(this))}initContext(){super.initContext();const{regl:e,device:t,reglGL:n}=this.context,i=e||t;this.regl=e,this.gl=n,this.device=t;this.canvas.pickingFBO=this.canvas.pickingFBO||i.framebuffer({colorFormat:t?"bgra8unorm":"rgba",depthStencil:!0,width:this.canvas.width,height:this.canvas.height}),this.pickingFBO=this.canvas.pickingFBO,this.prepareRequestors(),this._initPainters()}_initPainters(){this.painter=this.createPainter();const e=LD.get3DPainterClass("icon");let t=e.getBloomSymbol();const n=iL({},aH,lH);n.markerPerspectiveRatio=this.layer.options.markerPerspectiveRatio||0,this._defineSymbolBloom(n,t),this._markerSymbol=n;const i=iL({},TL,this.layer.options.sceneConfig||{});this._markerPainter=new e(this.regl||this.device,this.layer,n,i,0),this._markerPainter.setShaderDefines({REVERSE_MAP_ROTATION_ON_PITCH:1});const s=LD.get3DPainterClass("line"),o=iL({},hH);t=s.getBloomSymbol(),this._defineSymbolBloom(o,t),this._lineSymbol=o;const a=iL({},this.layer.options.sceneConfig||{});void 0===a.depthMask&&(a.depthMask=!0),this._linePainter=new s(this.regl||this.device,this.layer,o,a,0),this.layer.getGeometries()&&this.onGeometryAdd(this.layer.getGeometries())}_defineSymbolBloom(e,t){for(let n=0;n<t.length;n++)e[t[n]]=this.layer.options.enableBloom}updateBloom(e){this._markerPainter&&this._updatePainterBloom(this._markerPainter,this._markerSymbol,e),this._linePainter&&this._updatePainterBloom(this._linePainter,this._lineSymbol,e),this.painter&&this._updatePainterBloom(this.painter,this.painterSymbol,e)}_updatePainterBloom(e,t,n){const i=e.constructor.getBloomSymbol().reduce(((e,i)=>(e[i]=n,t[i]=n,e)),{});e.updateSymbol(i,t)}createPainter(){}resizeCanvas(e){super.resizeCanvas(e);const t=this.canvas;t&&(!this.pickingFBO||this.pickingFBO.width===t.width&&this.pickingFBO.height===t.height||this.pickingFBO.resize(t.width,t.height),this.painter&&this.painter.resize(t.width,t.height))}onRemove(){super.onRemove(),this.painter&&(this.painter.delete(),delete this.painter),this._markerPainter&&(this._markerPainter.delete(),delete this._markerPainter),this._linePainter&&(this._linePainter.delete(),delete this._linePainter)}drawOutline(e){if(this._outlineAll&&(this.painter&&this.painter.outlineAll(e),this._markerPainter.outlineAll(e),this._linePainter.outlineAll(e)),this._outlineFeatures)for(let t=0;t<this._outlineFeatures.length;t++)this.painter&&this.painter.outline(e,this._outlineFeatures[t]),this._markerPainter.outline(e,this._outlineFeatures[t]),this._linePainter.outline(e,this._outlineFeatures[t])}outlineAll(){this._outlineAll=!0,this.setToRedraw()}outline(e){this._outlineFeatures||(this._outlineFeatures=[]);const t=[];for(let n=0;n<e.length;n++){const i=this.layer.getGeometryById(e[n]);if(i){const e=this.features[i[dH]];if(Array.isArray(e))for(let n=0;n<e.length;n++)t.push(e[n].id);else t.push(e.id)}}this._outlineFeatures.push(t),this.setToRedraw()}cancelOutline(){delete this._outlineAll,delete this._outlineFeatures,this.setToRedraw()}isEnableWorkAround(e){return"win-intel-gpu-crash"===e&&this.layer.options.workarounds["win-intel-gpu-crash"]&&WG(this.gl)}_getCentiMeterScale(e){return dL(e,this.getMap())}_onSpatialReferenceChange(){const e=this.layer.getGeometries();e&&this._convertGeometries(e),this._markRebuild()}_getLayerOpacity(){const e=this.layer.options.opacity;return hL(e)?1:e}}function jG(e){e.setToRedraw()}function WG(e){const t=e.getExtension("WEBGL_debug_renderer_info");if(t&&"undefined"!=typeof navigator){const n=e.getParameter(t.UNMASKED_RENDERER_WEBGL),i="Win32"===navigator.platform||"Win64"===navigator.platform;if(n&&n.toLowerCase().indexOf("intel")>=0&&i)return!0}return!1}function qG({properties:e}){const t=(zG+"markerFile").trim(),n=(zG+"markerType").trim();return e[t]||e[n]}function ZG({properties:e}){return e[(zG+"textName").trim()]}const XG=(zG+"lineWidth").trim(),YG=(cH+"").trim();function JG(e){return 2===e.type&&!e.properties[YG]||3===e.type&&void 0!==e.properties[XG]}function QG(e){if(!Array.isArray(e))return 0;let t=0;for(let n=0;n<e.length;n++)t+=e[n];return t}function $G(e,t){if(Object.keys(e).sort().join()!==Object.keys(t.properties||{}).filter((e=>0===e.indexOf(zG))).map((e=>e.substring(zG.length))).sort().join())return!1;for(const n in e)if(fL(e,n)){const i=(zG+n).trim();if(SE(e[n])!==SE(t.properties[i]))return!1}return!0}function KG(e,t,n){if(!e||e.type!==t)return null;const i=new n(e.id,e.options),s=e.geometries,o=[];for(let e=0;e<s.length;e++){const t=gu.fromJSON(s[e]);t&&o.push(t)}return i.addGeometry(o),i}class Qa extends LD{static fromJSON(e){return KG(e,"PointLayer",Qa)}constructor(...e){super(...e),this.options.sceneConfig||(this.options.sceneConfig=iL({},TL))}getPolygonOffsetCount(){return 0}getPolygonOffset(){return 0}}Qa.mergeOptions({glyphSdfLimitPerFrame:15,iconErrorUrl:null,workarounds:{"win-intel-gpu-crash":!0},collision:!1,collisionFrameLimit:1}),Qa.registerJSONType("PointLayer"),Qa.registerRenderer("canvas",null),Qa.registerRenderer("gl",class extends Ga{constructor(...e){super(...e),this.GeometryTypes=[mf,Tf]}onGeometryAdd(e){e&&(Array.isArray(e)?e.forEach((e=>{e.options.maxMarkerWidth=e.options.maxMarkerHeight=255})):e.options.maxMarkerWidth=e.options.maxMarkerHeight=255,super.onGeometryAdd(e))}});const{LinePack:eU}=eL();class tl extends LD{static fromJSON(e){return KG(e,"LineStringLayer",tl)}}tl.mergeOptions({meshRenderOrder:1}),tl.registerJSONType("LineStringLayer");const tU=(cH+"").trim();tl.registerRenderer("gl",class extends Ga{constructor(...e){super(...e),this.GeometryTypes=[yf,Mf]}createPainter(){const e=LD.get3DPainterClass("line-gradient");this.painterSymbol=iL({},{lineGradientProperty:tU},hH),this._defineSymbolBloom(this.painterSymbol,e.getBloomSymbol());const t=iL({},this.layer.options.sceneConfig||{});return void 0===t.depthMask&&(t.depthMask=!0),new e(this.device||this.regl,this.layer,this.painterSymbol,t,0)}buildMesh(){let{features:e,center:t}=this._getFeaturesToRender();if(e=e.filter((e=>!!e.properties[tU])),!e.length)return;const n=this._showHideUpdated;this._meshCenter=t;const i=iL({},this.painterSymbol),s=this.createMesh(this.painter,eU,i,e,null,t);this._isCreatingMesh=!0,s.then((e=>{this.meshes&&this.painter.deleteMesh(this.meshes);const t=[],i=e&&e.meshes;if(i){t.push(...i);for(let e=0;e<i.length;e++)i[e].feaGroupIndex=0,i[e].geometry.properties.originElements=i[e].geometry.properties.elements.slice()}this.meshes=t,n&&(this._showHideUpdated=n),this._isCreatingMesh=!1,this.setToRedraw()}))}}),tl.registerRenderer("canvas",null);const{PolygonPack:nU}=eL();class rl extends LD{static fromJSON(e){return KG(e,"PolygonLayer",rl)}}rl.registerJSONType("PolygonLayer");const rU={polygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_polygonFill"},polygonPatternFile:{type:"identity",default:void 0,property:"_symbol_polygonPatternFile"},polygonOpacity:{type:"identity",default:1,property:"_symbol_polygonOpacity"},uvScale:{type:"identity",default:[1,1],property:"_symbol_uvScale"},uvOffset:{type:"identity",default:[0,0],property:"_symbol_uvOffset"},uvOffsetInMeter:{type:"identity",default:!1,property:"_symbol_uvOffsetInMeter"},polygonPatternFileWidth:{type:"identity",default:void 0,property:"_symbol_polygonPatternFileWidth"},polygonPatternFileHeight:{type:"identity",default:void 0,property:"_symbol_polygonPatternFileHeight"},polygonPatternFileOrigin:{type:"identity",default:void 0,property:"_symbol_polygonPatternFileOrigin"},polygonPatternUV:{type:"identity",default:void 0,property:"_symbol_polygonPatternUV"}};class sl extends Ga{constructor(){super(...arguments),this.GeometryTypes=[df,Cf]}getPolygonOffsetCount(){return this.options.altitude>0?0:2}buildMesh(e){const{features:t,center:n}=this._getFeaturesToRender();if(!t.length)return;const i=this._showHideUpdated;this._meshCenter=n;const s=this._groupPolygonFeatures(t),o=iL({},rU),a=s.map(((t,i)=>this.createMesh(this.painter,nU,o,t,e&&e[i],n)));this._isCreatingMesh=!0,Promise.all(a).then((e=>{this.meshes&&this.painter.deleteMesh(this.meshes),e=function(e){const t=[];for(let n=0;n<e.length;n++)Array.isArray(e[n])?t.push(...e[n]):t.push(e[n]);return t}(e);const t=[],n=[];for(let i=0;i<e.length;i++){const s=e[i]&&e[i].meshes;if(s){t.push(...s);for(let e=0;e<s.length;e++)s[e].feaGroupIndex=i,s[e].geometry.properties.originElements=s[e].geometry.properties.elements.slice(),1===i&&(s[e].transparent=!0);n[i]=e[i].atlas}}this.meshes=t,this.atlas=n,i&&(this._showHideUpdated=i),this._isCreatingMesh=!1,this.setToRedraw(),this.layer.fire("buildmesh")}))}getRayCastData(e,t){const n=this.painter.getRayCastData(e,t);if(!n||!n.feature)return null;return this._geometries[n.feature[dH]]}_groupPolygonFeatures(e){const t=[],n=[];for(let i=0;i<e.length;i++){const s=e[i];s.properties&&s.properties._symbol_polygonOpacity<1?n.push(s):t.push(s)}return[t,n]}createPainter(){const e=LD.get3DPainterClass("fill"),t=this.painterSymbol=iL({},rU);return this._defineSymbolBloom(t,e.getBloomSymbol()),new e(this.regl||this.device,this.layer,t,this.layer.options.sceneConfig,0)}updateMesh(e){return this._updateMesh(e,this.meshes,this.atlas,this._meshCenter,this.painter,nU,rU,this._groupPolygonFeatures)}}function iU(e,t,n,i,s,o,a){const l=n&&Array.isArray(n[0]);for(let o=0,h=n.length;o<h;o++){e[t]=(l?n[o][0]:n[o].x)*i,e[t+1]=(l?n[o][1]:n[o].y)*i,a!==Float32Array&&(e[t]=Math.round(e[t]),e[t+1]=Math.round(e[t+1]));let h=s||0;Array.isArray(s)&&(h=s[o]),h=h?Math.round(i*h):0,e[t+2]=h,t+=3}return e.trySetLength&&e.trySetLength(t),t}rl.registerRenderer("gl",sl),rl.registerRenderer("canvas",null);const sU=Math.PI/180,oU=6378137*Math.PI/180,aU=85.0511287798;function lU(e,t,n){return function(e,t){const n=aU,i=t[0],s=Math.max(Math.min(n,t[1]),-n);let o;return o=0===s?0:Math.log(Math.tan((90+s)*sU/2))/sU,e[0]=i*oU,e[1]=o*oU,e}(e,t)}function hU(e,t,n,i){const s=n[0]-i[0],o=n[1]-i[1];let a=(t[0]-n[0])*(n[0]-i[0])+(t[1]-n[1])*(n[1]-i[1]);return a/=s*s+o*o,e[0]=n[0]+a*s,e[1]=n[1]+a*o,e}function cU(e,t,n,i,s){return o=i,a=s,l=e[3*t[n-1]],h=e[3*t[n-1]+1],Math.sqrt((l-o)*(l-o)+(h-a)*(h-a));var o,a,l,h}const{PackUtil:uU,ArrayPool:fU}=eL();function dU(e,t,n,i,s,o,a,l,h,c,u,f,g,m,A,w,T){const S=t.getLength(),M=s/3;for(let n=2,i=S;n<i;n+=3)e[s+n-2]=t[n-2],e[s+n-1]=t[n-1],e[s+n-0]=t[n]-a;s+=S;for(let n=2,i=S;n<i;n+=3)e[s+n-2]=t[n-2],e[s+n-1]=t[n-1],e[s+n-0]=t[n]-l;e.trySetLength((s+=S)+S),e.copyWithin(s,s-2*S,s-S),e.trySetLength((s+=S)+S),e.copyWithin(s,s-2*S,s-S),s+=S,(n=n||[]).push(S/3);const C=n.getLength();for(let t=0;t<C;t++)pU(M+(n[t-1]||0),M+n[t],e,S/3,h,i,c,u,f,g,o,m,A,w,T);return s}function pU(e,t,n,i,s,o,a,l,h,c,u,f,g,m,A){const w=o.getLength();let T,S;for(let n=e,a=t;n<a-1;n++)if(T=n,S=n+1,s===1/0)if((n-e)%2==1&&(T+=2*i,S+=2*i),A){let e=o.currentIndex;o[e++]=T+i,o[e++]=S,o[e++]=T,o[e++]=S+i,o[e++]=S,o[e++]=T+i,o.currentIndex=e}else{let e=o.currentIndex;o[e++]=T+i,o[e++]=T,o[e++]=S,o[e++]=S,o[e++]=S+i,o[e++]=T+i,o.currentIndex=e}a&&function(e,t,n,i,s,o,a,l,h,c,u,f){let g,m=0,A=0,w=0,T=0;const S=f?[1,3,4]:[2,3,4];for(let f=o.getLength()-1;f>=a;f--){const a=o[f],M=3*a+2,C=s[3*a],I=s[3*a+1],E=s[M];m||A||(m=Math.max(s[M],s[3*o[f-3]+2]),A=Math.min(s[M],s[3*o[f-3]+2]),g=m-A);let D=w;const H=f%6;0===e?(5===H&&(T=cU(s,o,f,C,I)),D=H===S[0]||H===S[1]||H===S[2]?w:w+T):1===e&&(H===S[0]||H===S[1]||H===S[2]?D=0:5===H?(T=cU(s,o,f,C,I),D=T):D=T);let N;N=1===t?E===m?1:0:"bottom"===n?E===m?g/100/h:0:E===m?0:-g/100/h,i[2*a]=D/c*(1/(100*u))/l,i[2*a+1]=N,0===H&&(w+=T)}}(l,h,c,u,n,o,w,f[0],f[1],g,m,A)}function gU(e){const t=[e[0]];let n=e[0];for(let i=1;i<e.length;i++)Array.isArray(e[i])?e[i][0]===n[0]&&e[i][1]===n[1]&&e[i][2]===n[2]||t.push(e[i]):e[i].x===n.x&&e[i].y===n.y&&e[i].z===n.z||t.push(e[i]),n=e[i];return t}const{StyleUtil:mU,PackUtil:AU,ArrayPool:yU}=eL(),_U=yU.getInstance();function vU(e,t,n,i,s,o,a,l,h,c,u,f,g,m,A,w){void 0===t.top&&(t.top=!0),void 0===t.side&&(t.side=!0),_U.reset();const{altitudeScale:T,altitudeProperty:S,defaultAltitude:M,heightProperty:C,minHeightProperty:I,defaultHeight:E,tangent:D,uv:H,topUVMode:N,sideUVMode:B,sideVerticalUVMode:z,top:U,side:j,textureYOrigin:W,topThickness:q}=t,Z=!!w,X=function(e,t,{altitudeScale:n,altitudeProperty:i,defaultAltitude:s,heightProperty:o,minHeightProperty:a,defaultHeight:l},{center:h,side:c,top:u,topThickness:f,uvOrigin:g,uv:m,uvSize:A,topUVMode:w,sideUVMode:T,sideVerticalUVMode:S,textureYOrigin:M,tileRatio:C,centimeterToPoint:I,verticalCentimeterToPoint:E,positionType:D,res:H,glScale:N,projectionCode:B},z,U){let j=t/e[0].extent;j=1;const W=t===1/0,q=U.get(),Z=U.get(),X=U.get(),Y=U.getProxy(),J=U.get(),Q=U.get(),$=U.get(),K=!!m,ee=!!u,te=!!c,re=K?U.get():null;function se(e,n,i,s,o,a){let l=n;if(ee){const c=aR(Y,i,3);if(0===c.length)return n;let u=Y.getLength(),m=J.currentIndex;for(let e=0;e<u;e++)J[m++]=Y[e];if(J.currentIndex=m,n+=Y.getLength(),a)for(let t=2,n=c.length;t<n;t+=3)c[t]+=e/3,c[t-1]+=e/3,c[t-2]+=e/3;u=c.length,m=Q.currentIndex;for(let e=0;e<u;e++)Q[m++]=c[e];Q.currentIndex=m,K&&function(e,t,n,i,s,o,a,l,h,c,u,f,g,m,A){0===e?function(e,t,n,i,s,o,a,l,h,c){const u=1/(100*o[0]),f=1/(100*o[1]),g=c&&c[0]||0,m=c&&c[1]||0,A=[0,0];for(let s=e;s<t;s+=3){const e=s/3*2,t=i[s+1]-m;n[e]=A[0]+(i[s]-g)/a*u/l,n[e+1]=A[1]-t/a*f/h}}(t,n,i,s,0,a,l,h,c,A):1===e&&function(e,t,n,i,s,o,a,l,h,c,u){if(!e)return;let f,g,m,A;0===e[4]?(f=e[0],g=e[1],m=e[2],A=e[3]):(f=e[1],g=e[2],m=e[3],A=e[0]);const w=X_(f,g),T=X_(g,m),S=[],M=[],C=[];for(let e=t;e<n;e+=3){const t=e/3*2;U_(S,(o.x/h+s[e]/a)*l,o.y/h*l+(u?s[e+1]:-s[e+1])/a*l),"EPSG:4326"!==c&&"EPSG:4490"!==c||lU(S,S),hU(M,S,f,g),hU(C,S,A,f),i[t]=X_(f,M)/w,i[t+1]=X_(f,C)/T}}(u,t,n,i,s,o,l,f,g,m,!!A)}(w||0,e,n,re,J,g,I,C,A[0],A[1],o,H,N,B,h),f>0&&!te&&(n=dU(J,Y,i,Q,n,re,0,f,t,K,T||0,S||0,M,A,C,E,s<0?!a:a)),$.setLength(n/3),$.fill(1,l/3,n/3)}if(te){ee&&(f=0),l=n,n=dU(J,Y,i,Q,n,re,f,s,t,K,T||0,S||0,M,A,C,E,s<0?!a:a),$.setLength(n/3);const e=Y.getLength()/3;$.fill(1,l/3,l/3+e),$.fill(0,l/3+e,l/3+2*e),$.fill(1,l/3+2*e,l/3+3*e),$.fill(0,l/3+3*e,n/3)}return n}let oe=-1/0,le=1/0,he=0,ue=0,fe=e.length;oL(z)&&(ue=z,fe=z+1);let de=0,pe=!1;const me=U.getProxy();let Ae=!1;for(;ue<fe;ue++){const t=e[ue],h=t.id;oL(h)&&(Math.abs(h)>de&&(de=Math.abs(h)),h<0&&(pe=!0));const c=t.geometry,u=t.properties[LL];let f=Array.isArray(u&&u[0]&&u[0][0])?u[0]:u;const{altitude:g,height:m}=uU.getFeaAltitudeAndHeight(t,n,i,s,o,l,a);m<0?(Ae=!0,le=Math.min(g,le),oe=Math.max(g-m,oe)):(oe=Math.max(g,oe),le=Math.min(g-m,le));const A=J.getLength();let w=0,T=he;me.setLength(0),Y.setLength(0);const S=uU.calculateSignedArea(c[0])<0;for(let e=0,t=c.length;e<t;e++){let n=c[e];S&&(n=n.reverse()),n=gU(n);const i=uU.calculateSignedArea(n)<0;if(!i&&e>0&&(w++,f=u&&u[w],he=se(T,he,me,1*m,f,W),Y.setLength(0),me.setLength(0),T=he),!n.length){e===t-1&&(he=se(T,he,me,1*m,f,W));continue}const s=n.length;if(Array.isArray(n[0])?n[0][0]===n[s-1][0]&&n[0][1]===n[s-1][1]||n.push([n[0][0],n[0][1]]):n[0].x===n[s-1].x&&n[0].y===n[s-1].y||n.push(n[0]),i){let e=me.currentIndex;me[e++]=Y.getLength()/3,me.currentIndex=e}iU(Y,Y.getLength(),n,1,g,0,D),e===t-1&&(he=se(T,he,me,1*m,f,W))}const M=J.getLength()-A,C=(OL+"").trim();for(let e=0;e<M/3;e++){let e=Z.currentIndex;Z[e++]=void 0===t[C]?ue:t[C],Z.currentIndex=e,e=q.currentIndex,q[e++]=ue,q.currentIndex=e,oL(h)&&(e=X.currentIndex,X[e++]=h,X.currentIndex=e)}}const ye=uU.getUnsignedArrayType(Z.getLength()?Z[Z.getLength()-1]:0),_e={hasNegativeHeight:Ae,maxAltitude:oe===-1/0?0:oe,minAltitude:le===1/0?0:le,vertices:J,verticeTypes:$,indices:Q,pickingIds:fU.createTypedArray(Z,ye),featureIndexes:q};if(X.getLength()){const e=pe?uU.getPosArrayType(de):uU.getUnsignedArrayType(de);_e.featureIds=fU.createTypedArray(X,e)}else _e.featureIds=[];return re&&(re.setLength(J.getLength()/3*2),_e.uvs=re),_e}(e,n,{altitudeScale:T,altitudeProperty:S,defaultAltitude:M||0,heightProperty:C,minHeightProperty:I,defaultHeight:E||0},{center:w,top:U,side:j,topThickness:10*q||0,uv:H||D,uvSize:[s,s],uvOrigin:i,topUVMode:N,sideUVMode:B,sideVerticalUVMode:z,textureYOrigin:W,tileRatio:l,centimeterToPoint:h,verticalCentimeterToPoint:c,positionType:A,res:o,glScale:a,projectionCode:g},m,_U),Y=[],J=X.vertices.getLength()/3,Q=AU.getIndexArrayType(J),$=yU.createTypedArray(X.indices,Q);delete X.indices,Y.push($.buffer,X.pickingIds.buffer);const K=Math.max(Math.abs(X.maxAltitude),Math.abs(X.minAltitude)),ee=A||AU.getPosArrayType(Math.max(512,K));X.vertices=yU.createTypedArray(X.vertices,ee);const te=D?_U.getProxy():new Float32Array(3*J);te.setLength&&te.setLength(3*J);const re=Ov(X.vertices,$,te);let se=!0;const oe=re.getLength?re.getLength():re.length;for(let e=0;e<oe;e++){Z||(re[e]=-re[e]);const t=re[e]%1;1-Math.abs(t)>1e-6?se=!1:0!==t&&(re[e]=Math.round(re[e]))}if(X.normals=re,D){let e=_U.get();e.setLength(4*J),e=zv(X.vertices,X.normals,X.uvs,$,e),e=function(e,t){const n=t.getLength(),i=new Float32Array(n),s=[],o=[],a=[];for(let l=0;l<n;l+=4){const n=l/4*3;ZA(o,e[n]||0,e[n+1]||0,e[n+2]||0),Sy(s,t[l]||0,t[l+1]||0,t[l+2]||0,t[l+3]||0),Iv(a,o,s),Ty(i.subarray(l,l+4),a)}return i}(X.normals,e),X.tangents=e,Y.push(e.buffer),delete X.normals}if(X.normals&&(se&&(X.normals=yU.createTypedArray(X.normals,Int8Array)),Y.push(X.normals.buffer)),X.uvs){X.uvs=yU.createTypedArray(X.uvs,Float32Array),Y.push(X.uvs.buffer)}if(w){const e=X.vertices,t=e.length;for(let n=0;n<t;n+=3)e[n]-=w[0],e[n+1]-=w[1]}const le=function(e,t,n,i){const s={},o={},a=i.getLength();if(uL(t.polygonFill)){let l=PE(t.polygonFill);const h=new Uint8Array(4*a);h.fill(255);for(let t=0;t<a;t++){const o=e[i[t]],a=o.properties||{};a.$layer=o.layer,a.$type=o.type;let c=l(n,a);SE(c)&&(s.aColor=1,l=PE(c),c=l(n,a)),delete a.$layer,delete a.$type,mU.normalizeColor(xU,c),h[4*t]=xU[0],h[4*t+1]=xU[1],h[4*t+2]=xU[2],h[4*t+3]=xU[3]}o.aColor=h}if(uL(t.polygonOpacity)){let l=CE(t.polygonOpacity);const h=new Uint8Array(a);h.fill(255);for(let t=0;t<a;t++){const o=e[i[t]],a=o.properties||{};a.$layer=o.layer,a.$type=o.type;let c=l(n,a);SE(c)&&(s.aOpacity=1,l=PE(c),c=l(n,a)),delete a.$layer,delete a.$type,h[t]=255*c}o.aOpacity=h}return o.dynamicAttributes=s,o}(e,u,f,X.featureIndexes),he=function(e,t,n,i,s){const o=[[],[]],a=uL(i.topPolygonFill),l=uL(i.bottomPolygonFill),h=[255,255,255,255],c=t.getLength();if(a||l){let u=a&&PE(i.topPolygonFill),f=l&&PE(i.bottomPolygonFill),g=null,m=null,A=null,w=null;for(let i=0;i<c;i++){if(1===e[i]&&!a||0===e[i]&&!l)continue;const c=1===e[i];if(c&&t[i]===g){e[i]=A;continue}if(!c&&t[i]===m){e[i]=w;continue}const T=n[t[i]],S=T.properties||{};S.$layer=T.layer,S.$type=T.type;let M=c?u:f,C=M(s,S);SE(C)&&(M=PE(C),C=M(s,S)),delete S.$layer,delete S.$type,mU.normalizeColor(xU,C),Iy(xU,xU,h);let I=bU(o,xU);I<0&&(I=o.length,o.push(Ty([],xU))),e[i]=I,c?(g=t[i],A=I):(m=t[i],w=I)}}return o.slice(2)}(X.verticeTypes,X.featureIndexes,e,u,f),ue={data:{data:{aVertexColorType:yU.createTypedArray(X.verticeTypes,he.length<=252?Uint8Array:Uint16Array),aPosition:X.vertices,aNormal:X.normals,aTexCoord0:X.uvs,aTangent:X.tangents,aPickingId:X.pickingIds},indices:$,properties:{maxAltitude:X.maxAltitude/100,minAltitude:X.minAltitude/100,hasNegativeHeight:X.hasNegativeHeight},dynamicAttributes:le.dynamicAttributes,vertexColors:he},buffers:Y};return X.featureIds.length?(ue.data.featureIds=X.featureIds,Y.push(ue.data.featureIds.buffer)):ue.data.featureIds=[],le.aColor&&(ue.data.data.aColor=le.aColor,ue.buffers.push(le.aColor.buffer)),le.aOpacity&&(ue.data.data.aOpacity=le.aOpacity,ue.buffers.push(le.aOpacity.buffer)),ue.buffers.push(ue.data.data.aPosition.buffer),ue.data.pickingIdIndiceMap=AU.generatePickingIndiceIndex(ue.data.data.aPickingId,ue.data.indices),ue}const xU=[];function bU(e,t){for(let n=0;n<e.length;n++)if(By(t,e[n]))return n;return-1}eL();class Il{constructor(e=[],t=wU){if(this.data=e,this.length=this.data.length,this.compare=t,this.length>0)for(let e=(this.length>>1)-1;e>=0;e--)this._down(e)}push(e){this.data.push(e),this.length++,this._up(this.length-1)}pop(){if(0===this.length)return;const e=this.data[0],t=this.data.pop();return this.length--,this.length>0&&(this.data[0]=t,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:t,compare:n}=this,i=t[e];for(;e>0;){const s=e-1>>1,o=t[s];if(n(i,o)>=0)break;t[e]=o,e=s}t[e]=i}_down(e){const{data:t,compare:n}=this,i=this.length>>1,s=t[e];for(;e<i;){let i=1+(e<<1),o=t[i];const a=i+1;if(a<this.length&&n(t[a],o)<0&&(i=a,o=t[a]),n(o,s)>=0)break;t[e]=o,e=i}t[e]=s}}function wU(e,t){return e<t?-1:e>t?1:0}var TU={exports:{}},SU=function(e,t,n,i){var s=e[0],o=e[1],a=!1;void 0===n&&(n=0),void 0===i&&(i=t.length);for(var l=(i-n)/2,h=0,c=l-1;h<l;c=h++){var u=t[n+2*h+0],f=t[n+2*h+1],g=t[n+2*c+1];f>o!=g>o&&s<(t[n+2*c+0]-u)*(o-f)/(g-f)+u&&(a=!a)}return a},MU=function(e,t,n,i){var s=e[0],o=e[1],a=!1;void 0===n&&(n=0),void 0===i&&(i=t.length);for(var l=i-n,h=0,c=l-1;h<l;c=h++){var u=t[h+n][0],f=t[h+n][1],g=t[c+n][1];f>o!=g>o&&s<(t[c+n][0]-u)*(o-f)/(g-f)+u&&(a=!a)}return a};TU.exports=function(e,t,n,i){return t.length>0&&Array.isArray(t[0])?MU(e,t,n,i):SU(e,t,n,i)};var CU=TU.exports.nested=MU;TU.exports.flat=SU;const PU=11102230246251565e-32,IU=134217729,kU=(3+8*PU)*PU;function OU(e,t,n,i,s){let o,a,l,h,c=t[0],u=i[0],f=0,g=0;u>c==u>-c?(o=c,c=t[++f]):(o=u,u=i[++g]);let m=0;if(f<e&&g<n)for(u>c==u>-c?(a=c+o,l=o-(a-c),c=t[++f]):(a=u+o,l=o-(a-u),u=i[++g]),o=a,0!==l&&(s[m++]=l);f<e&&g<n;)u>c==u>-c?(a=o+c,h=a-o,l=o-(a-h)+(c-h),c=t[++f]):(a=o+u,h=a-o,l=o-(a-h)+(u-h),u=i[++g]),o=a,0!==l&&(s[m++]=l);for(;f<e;)a=o+c,h=a-o,l=o-(a-h)+(c-h),c=t[++f],o=a,0!==l&&(s[m++]=l);for(;g<n;)a=o+u,h=a-o,l=o-(a-h)+(u-h),u=i[++g],o=a,0!==l&&(s[m++]=l);return 0===o&&0!==m||(s[m++]=o),m}function EU(e){return new Float64Array(e)}const RU=33306690738754716e-32,LU=22204460492503146e-32,DU=11093356479670487e-47,FU=EU(4),HU=EU(8),NU=EU(12),BU=EU(16),zU=EU(4);function GU(e,t,n,i,s,o,a){for(var l=new Il([],UU),h=e.data;h;){for(var c=0;c<h.children.length;c++){var u=h.children[c],f=h.leaf?JU(u,n,i):VU(n,i,u);f>o||l.push({node:u,dist:f})}for(;l.length&&!l.peek().node.children;){var g=l.pop(),m=g.node,A=JU(m,t,n),w=JU(m,i,s);if(g.dist<A&&g.dist<w&&WU(n,m,a)&&WU(i,m,a))return m}(h=l.pop())&&(h=h.node)}return null}function UU(e,t){return e.dist-t.dist}function VU(e,t,n){if(jU(e,n)||jU(t,n))return 0;var i=QU(e[0],e[1],t[0],t[1],n.minX,n.minY,n.maxX,n.minY);if(0===i)return 0;var s=QU(e[0],e[1],t[0],t[1],n.minX,n.minY,n.minX,n.maxY);if(0===s)return 0;var o=QU(e[0],e[1],t[0],t[1],n.maxX,n.minY,n.maxX,n.maxY);if(0===o)return 0;var a=QU(e[0],e[1],t[0],t[1],n.minX,n.maxY,n.maxX,n.maxY);return 0===a?0:Math.min(i,s,o,a)}function jU(e,t){return e[0]>=t.minX&&e[0]<=t.maxX&&e[1]>=t.minY&&e[1]<=t.maxY}function WU(e,t,n){for(var i,s,o,a,l=Math.min(e[0],t[0]),h=Math.min(e[1],t[1]),c=Math.max(e[0],t[0]),u=Math.max(e[1],t[1]),f=n.search({minX:l,minY:h,maxX:c,maxY:u}),g=0;g<f.length;g++)if(s=f[g].next.p,o=e,(i=f[g].p)!==(a=t)&&s!==o&&qU(i,s,o)>0!=qU(i,s,a)>0&&qU(o,a,i)>0!=qU(o,a,s)>0)return!1;return!0}function qU(e,t,n){return function(e,t,n,i,s,o){const a=(t-o)*(n-s),l=(e-s)*(i-o),h=a-l;if(0===a||0===l||a>0!=l>0)return h;const c=Math.abs(a+l);return Math.abs(h)>=RU*c?h:-function(e,t,n,i,s,o,a){let l,h,c,u,f,g,m,A,w,T,S,M,C,I,E,D,H,N;const B=e-s,z=n-s,U=t-o,j=i-o;I=B*j,g=IU*B,m=g-(g-B),A=B-m,g=IU*j,w=g-(g-j),T=j-w,E=A*T-(I-m*w-A*w-m*T),D=U*z,g=IU*U,m=g-(g-U),A=U-m,g=IU*z,w=g-(g-z),T=z-w,H=A*T-(D-m*w-A*w-m*T),S=E-H,f=E-S,FU[0]=E-(S+f)+(f-H),M=I+S,f=M-I,C=I-(M-f)+(S-f),S=C-D,f=C-S,FU[1]=C-(S+f)+(f-D),N=M+S,f=N-M,FU[2]=M-(N-f)+(S-f),FU[3]=N;let W=function(e,t){let n=t[0];for(let e=1;e<4;e++)n+=t[e];return n}(0,FU),q=LU*a;if(W>=q||-W>=q)return W;if(f=e-B,l=e-(B+f)+(f-s),f=n-z,c=n-(z+f)+(f-s),f=t-U,h=t-(U+f)+(f-o),f=i-j,u=i-(j+f)+(f-o),0===l&&0===h&&0===c&&0===u)return W;if(q=DU*a+kU*Math.abs(W),W+=B*u+j*l-(U*c+z*h),W>=q||-W>=q)return W;I=l*j,g=IU*l,m=g-(g-l),A=l-m,g=IU*j,w=g-(g-j),T=j-w,E=A*T-(I-m*w-A*w-m*T),D=h*z,g=IU*h,m=g-(g-h),A=h-m,g=IU*z,w=g-(g-z),T=z-w,H=A*T-(D-m*w-A*w-m*T),S=E-H,f=E-S,zU[0]=E-(S+f)+(f-H),M=I+S,f=M-I,C=I-(M-f)+(S-f),S=C-D,f=C-S,zU[1]=C-(S+f)+(f-D),N=M+S,f=N-M,zU[2]=M-(N-f)+(S-f),zU[3]=N;const Z=OU(4,FU,4,zU,HU);I=B*u,g=IU*B,m=g-(g-B),A=B-m,g=IU*u,w=g-(g-u),T=u-w,E=A*T-(I-m*w-A*w-m*T),D=U*c,g=IU*U,m=g-(g-U),A=U-m,g=IU*c,w=g-(g-c),T=c-w,H=A*T-(D-m*w-A*w-m*T),S=E-H,f=E-S,zU[0]=E-(S+f)+(f-H),M=I+S,f=M-I,C=I-(M-f)+(S-f),S=C-D,f=C-S,zU[1]=C-(S+f)+(f-D),N=M+S,f=N-M,zU[2]=M-(N-f)+(S-f),zU[3]=N;const X=OU(Z,HU,4,zU,NU);I=l*u,g=IU*l,m=g-(g-l),A=l-m,g=IU*u,w=g-(g-u),T=u-w,E=A*T-(I-m*w-A*w-m*T),D=h*c,g=IU*h,m=g-(g-h),A=h-m,g=IU*c,w=g-(g-c),T=c-w,H=A*T-(D-m*w-A*w-m*T),S=E-H,f=E-S,zU[0]=E-(S+f)+(f-H),M=I+S,f=M-I,C=I-(M-f)+(S-f),S=C-D,f=C-S,zU[1]=C-(S+f)+(f-D),N=M+S,f=N-M,zU[2]=M-(N-f)+(S-f),zU[3]=N;const Y=OU(X,NU,4,zU,BU);return BU[Y-1]}(e,t,n,i,s,o,c)}(e[0],e[1],t[0],t[1],n[0],n[1])}function ZU(e){var t=e.p,n=e.next.p;return e.minX=Math.min(t[0],n[0]),e.minY=Math.min(t[1],n[1]),e.maxX=Math.max(t[0],n[0]),e.maxY=Math.max(t[1],n[1]),e}function XU(e,t){var n={p:e,prev:null,next:null,minX:0,minY:0,maxX:0,maxY:0};return t?(n.next=t.next,n.prev=t,t.next.prev=n,t.next=n):(n.prev=n,n.next=n),n}function YU(e,t){var n=e[0]-t[0],i=e[1]-t[1];return n*n+i*i}function JU(e,t,n){var i=t[0],s=t[1],o=n[0]-i,a=n[1]-s;if(0!==o||0!==a){var l=((e[0]-i)*o+(e[1]-s)*a)/(o*o+a*a);l>1?(i=n[0],s=n[1]):l>0&&(i+=o*l,s+=a*l)}return(o=e[0]-i)*o+(a=e[1]-s)*a}function QU(e,t,n,i,s,o,a,l){var h,c,u,f,g=n-e,m=i-t,A=a-s,w=l-o,T=e-s,S=t-o,M=g*g+m*m,C=g*A+m*w,I=A*A+w*w,E=g*T+m*S,D=A*T+w*S,H=M*I-C*C,N=H,B=H;0===H?(c=0,N=1,f=D,B=I):(f=M*D-C*E,(c=C*D-I*E)<0?(c=0,f=D,B=I):c>N&&(c=N,f=D+C,B=I)),f<0?(f=0,-E<0?c=0:-E>M?c=N:(c=-E,N=M)):f>B&&(f=B,-E+C<0?c=0:-E+C>M?c=N:(c=-E+C,N=M));var z=(1-(u=0===f?0:f/B))*s+u*a-((1-(h=0===c?0:c/N))*e+h*n),U=(1-u)*o+u*l-((1-h)*t+h*i);return z*z+U*U}function $U(e,t){return e[0]===t[0]?e[1]-t[1]:e[0]-t[0]}const{PackUtil:KU}=eL();class lh{constructor(e,t){this.x=e,this.y=t}clone(){return new lh(this.x,this.y)}normalize(){const e=this.length();this.x/=e,this.y/=e}negate(){this.x=-this.x,this.y=-this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}diff(e){return new lh(this.x-e.x,this.y-e.y)}distance(e){const t=this.x-e.x,n=this.y-e.y;return Math.sqrt(t*t+n*n)}dot(e){return this.x*e.x+this.y*e.y}equals(e){return this.x===e.x&&this.y===e.y}orthogonal(){return new lh(this.y,-this.x)}}function eV(e,t,n,i){const s=((n.x-e.x)*i.y-(n.y-e.y)*i.x)/(t.x*i.y-t.y*i.x);return new lh(e.x+s*t.x,e.y+s*t.y)}const tV=[],nV=[];function rV(e){if(oL(e[0]&&e[0].x)){const t=[];let n=0;for(let i=0;i<e.length;i++)nV[n]?(nV[n][0]=e[i].x,nV[n][1]=e[i].y):nV[n]=[e[i].x,e[i].y],t.push(nV[n]),n++;e=t}try{const t=function(e,t,n){t=Math.max(0,void 0===t?2:t),n=n||0;var i=function(e){for(var t=e[0],n=e[0],i=e[0],s=e[0],o=0;o<e.length;o++){var a=e[o];a[0]<t[0]&&(t=a),a[0]>i[0]&&(i=a),a[1]<n[1]&&(n=a),a[1]>s[1]&&(s=a)}var l=[t,n,i,s],h=l.slice();for(o=0;o<e.length;o++)CU(e[o],l)||h.push(e[o]);return function(e){e.sort($U);for(var t=[],n=0;n<e.length;n++){for(;t.length>=2&&qU(t[t.length-2],t[t.length-1],e[n])<=0;)t.pop();t.push(e[n])}for(var i=[],s=e.length-1;s>=0;s--){for(;i.length>=2&&qU(i[i.length-2],i[i.length-1],e[s])<=0;)i.pop();i.push(e[s])}return i.pop(),t.pop(),t.concat(i)}(h)}(e),s=new RBush(16);s.toBBox=function(e){return{minX:e[0],minY:e[1],maxX:e[0],maxY:e[1]}},s.compareMinX=function(e,t){return e[0]-t[0]},s.compareMinY=function(e,t){return e[1]-t[1]},s.load(e);for(var o,a=[],l=0;l<i.length;l++){var h=i[l];s.remove(h),o=XU(h,o),a.push(o)}var c=new RBush(16);for(l=0;l<a.length;l++)c.insert(ZU(a[l]));for(var u=t*t,f=n*n;a.length;){var g=a.shift(),m=g.p,A=g.next.p,w=YU(m,A);if(!(w<f)){var T=w/u;(h=GU(s,g.prev.p,m,A,g.next.next.p,T,c))&&Math.min(YU(h,m),YU(h,A))<=T&&(a.push(g),a.push(XU(h,g)),s.remove(h),c.remove(g),c.insert(ZU(g)),c.insert(ZU(g.next)))}}g=o;var S=[];do{S.push(g.p),g=g.next}while(g!==o);return S.push(g.p),S}(e,1/0);let n=[1/0,1/0],i=[-1/0,-1/0];for(let e=0;e<t.length;e++)t[e][0]<n[0]&&(n[0]=t[e][0]),t[e][0]>i[0]&&(i[0]=t[e][0]),t[e][1]<n[1]&&(n[1]=t[e][1]),t[e][1]>i[1]&&(i[1]=t[e][1]);const s=[];let o=[],a=0;for(let e=0;e<t.length;e++)e===t.length-1&&t[e][0]===t[0][0]&&t[e][1]===t[0][1]||(lU(s,t[e]),tV[a]?(tV[a].x=s[0],tV[a].y=s[1]):tV[a]=new lh(s[0],s[1]),o.push(tV[a]),a++);KU.calculateSignedArea(o)<0&&(o=o.reverse());const l=function(e){let t,n=Number.MAX_VALUE;const i=function(e,i,s,o,a,l,h,c){var u=eV(e,i,a,l),f=eV(s,o,a,l),g=eV(h,c,e,i),m=eV(h,c,s,o),A=u.distance(f)*u.distance(g);0!==A&&A<n&&(t=[u,g,m,f],n=A)};var s=[];for(let t=0;t<e.length;t++)s.push(e[(t+1)%e.length].diff(e[t])),s[t].normalize();var o,a,l,h,c=new lh(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),u=new lh(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let t=0;t<e.length;t++){var f=e[t];f.x<c.x&&(c.x=f.x,o=t),f.x>u.x&&(u.x=f.x,a=t),f.y<c.y&&(c.y=f.y,h=t),f.y>u.y&&(u.y=f.y,l=t)}var g=new lh(0,-1),m=new lh(0,1),A=new lh(-1,0),w=new lh(1,0);for(let t=0;t<e.length;t++){var T=[Math.acos(g.dot(s[o])),Math.acos(m.dot(s[a])),Math.acos(A.dot(s[l])),Math.acos(w.dot(s[h]))];switch(T.indexOf(Math.min.apply(Math,T))){case 0:(m=(g=s[o].clone()).clone()).negate(),(w=(A=g.orthogonal()).clone()).negate(),o=(o+1)%e.length;break;case 1:(g=(m=s[a].clone()).clone()).negate(),(w=(A=g.orthogonal()).clone()).negate(),a=(a+1)%e.length;break;case 2:(w=(A=s[l].clone()).clone()).negate(),(m=(g=w.orthogonal()).clone()).negate(),l=(l+1)%e.length;break;case 3:(A=(w=s[h].clone()).clone()).negate(),(m=(g=w.orthogonal()).clone()).negate(),h=(h+1)%e.length}i(e[o],g,e[a],m,e[l],A,e[h],w)}return t}(o);if(!l||4!==l.length)return null;const h=l[0].distance(l[1]),c=l[1].distance(l[2]),u=l.map((e=>[e.x,e.y]));return u.push(+(c>h)),u}catch(e){return null}}const{DEFAULT_TEX_WIDTH:iV}=eL();class ph extends LD{static fromJSON(e){return KG(e,"ExtrudePolygonLayer",ph)}getPolygonOffsetCount(){return 0}getPolygonOffset(){return 0}onConfig(e){const t=this.getRenderer();return t&&t.onConfig(e),super.onConfig(e)}updateMaterial(e){this.options.material||(this.options.material={}),e?iL(this.options.material,e):this.options.material=null;const t=this.getRenderer();return t&&t.updateMaterial(e),this}updateSideMaterial(e){let t=!1;this.options.sideMaterial||(this.options.sideMaterial={},t=!0),e?iL(this.options.sideMaterial,e):this.options.sideMaterial=null;const n=this.getRenderer();return n&&(t&&n._deleteSideMaterial(),n.updateSideMaterial(e)),this}updateDataConfig(e){if(!e)return this;this.options.dataConfig||(this.options.dataConfig={});const t=JSON.parse(JSON.stringify(this.options.dataConfig));iL(this.options.dataConfig,e);const n=this.getRenderer();return n&&n.updateDataConfig(e,t),this}}ph.registerJSONType("ExtrudePolygonLayer"),ph.mergeOptions({cullFace:!1,castShadow:!0});const sV={polygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_polygonFill"},polygonOpacity:{type:"identity",default:1,property:"_symbol_polygonOpacity"},topPolygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_topPolygonFill"},bottomPolygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_bottomPolygonFill"}},oV={defaultAltitude:20},aV=e=>1===e.properties.top;ph.registerRenderer("gl",class extends sl{constructor(...e){super(...e),this.GeometryTypes=[df,Cf]}_groupPolygonFeatures(e){return[e]}onConfig(e){this.painter&&(hL(e.cullFace)||this.painter.updateSceneConfig({cullFace:e.cullFace}))}updateMaterial(e){this.painter&&(this.painter._updateMaterial(e),this.layer.options.sideMaterial||this.sidePainter._updateMaterial(e),this.setToRedraw())}_deleteSideMaterial(){this.sidePainter&&this.sidePainter.deleteMaterial()}updateSideMaterial(e){this.sidePainter&&(e?this.sidePainter._updateMaterial(e):(this.sidePainter.deleteMaterial(),this.sidePainter._updateMaterial(this.layer.options.material)),this.setToRedraw())}updateDataConfig(e,t){this.painter&&(this.painter.updateDataConfig(e,t),this._markRebuild())}updateBloom(e){super.updateBloom(e),this.sidePainter&&this._updatePainterBloom(this.sidePainter,this.sidePainterSymbol,e)}needCheckPointLineSymbols(){return!1}draw(e,t){return super.draw(e,t)}createPainter(){const e=LD.get3DPainterClass("lit");this.painterSymbol=iL({},sV),this.sidePainterSymbol=iL({},sV),this._defineSymbolBloom(this.painterSymbol,e.getBloomSymbol());const t=this.layer,n=iL({},oV,t.options.dataConfig||{});t.options.material&&(this.painterSymbol.material=t.options.material),this.sidePainterSymbol.material=t.options.sideMaterial?t.options.sideMaterial:t.options.material;const i={cullFace:t.options.cullFace};Object.defineProperty(i,"castShadow",{enumerable:!0,get:()=>t.options.castShadow}),Object.defineProperty(i,"depthMask",{enumerable:!0,get:()=>t.options.depthMask});const s=iL({},n);s.upsideUpTexture=!0;const o=new e(this.regl,t,this.painterSymbol,i,0,s);return this.sidePainter=new e(this.regl,t,this.sidePainterSymbol,i,0,n),o}_startFrame(...e){super._startFrame(...e);const t=this.painter;this.painter=this.sidePainter,super._startFrame(...e),this.painter=t}_renderMeshes(...e){const t=e[0],n=t.sceneFilter;t.sceneFilter=e=>(!n||n(e))&&aV(e);const i=super._renderMeshes(...e);t.sceneFilter=e=>(!n||n(e))&&aV(e);const s=this.painter;this.painter=this.sidePainter;const o=t.sceneFilter=e=>(!n||n(e))&&(e=>1===e.properties.side)(e);return super._renderMeshes(...e),this.painter=s,t.sceneFilter=n,{redraw:i.redraw||o.redraw,drawCount:(i.drawCount||0)+(o.drawCount||0)}}createMesh(e,t,n,i,s,o){const a=[];this._extrudeCenter=o;const l=this._createPackData(i,n,!0,!1),h=this._createPackData(i,n,!1,!0);if(l){const s=this._createMesh(l,e,t,n,i,null,o);s.meshes[0].properties.top=1,a.push(s)}if(h){const s=this._createMesh(h,e,t,n,i,null,o);s.meshes[0].properties.side=1,a.push(s)}return a}_createPackData(e,t,n,i){const s=this.getMap();t=sV;const o=this._extrudeCenter,a=s.getZoom(),l=new Re(0,0),h=new fl(0,0),c=iL({},oV,this.layer.options.dataConfig);if(c.uv=!0,c.top&&(c.top=n),c.side&&(c.side=i),!1===c.top&&!1===c.side)return null;if(!e.length)return null;const u=s.getGLRes(),f=s.getProjection().code,g=n?this.painterSymbol&&this.painterSymbol.material:this.sidePainterSymbol&&this.sidePainterSymbol.material,m=g&&g.textureWidth||iV,A=[iD(s,1,h,u)/100,iD(s,1,h,u,1)/100];return vU(e,c,1/0,l,m,s.getGLRes(),1,1,A,this._zScale,t,a,f,void 0,Float32Array,o)}updateMesh(e){let t=this.features[e[dH]];if(!t||!this.meshes)return;const n=this._createPackData([t],this.painterSymbol,!0,!1);let i=0;n&&n.data&&this._updateMeshData(this.meshes[i++],t.id,n);const s=this._createPackData([t],this.painterSymbol,!1,!0);s&&s.data&&this._updateMeshData(this.meshes[i++],t.id,s)}_convertGeo(e){if(e.getProperties()||e.setProperties({}),!e.getProperties()[LL]){const t=e.getCoordinates();if(e instanceof Cf){const n=[];for(let e=0;e<t.length;e++){n[e]=rV(t[e]&&t[e][0])}e.getProperties()[LL]=n}else{const n=rV(t[0]);e.getProperties()[LL]=n}}return super._convertGeo(e)}resizeCanvas(e){super.resizeCanvas(e),this.sidePainter&&this.sidePainter.resize(this.canvas.width,this.canvas.height)}onRemove(){super.onRemove(),this.sidePainter&&(this.sidePainter.delete(),delete this.sidePainter)}drawOutline(e){if(super.drawOutline(e),this._outlineAll&&this.sidePainter&&this.sidePainter.outlineAll(e),this._outlineFeatures)for(let t=0;t<this._outlineFeatures.length;t++)this.sidePainter&&this.sidePainter.outline(e,this._outlineFeatures[t])}getShadowMeshes(){return this.painter?this.painter.getShadowMeshes():[]}}),ph.registerRenderer("canvas",null);const{PackUtil:lV,FilterUtil:hV,SYMBOLS_NEED_REBUILD_IN_VT:cV,SYMBOLS_NEED_REBUILD_IN_VECTOR:uV}=eL();CM.ShaderLib.register("vt_position_vert","#ifdef HAS_TERRAIN_ALTITUDE\n    attribute float aTerrainAltitude;\n#endif\nuniform float minAltitude;\nvec3 unpackVTPosition(vec2 aPosition, float aAltitude) {\n    float altitude = aAltitude;\n    #ifdef HAS_TERRAIN_ALTITUDE\n        altitude += aTerrainAltitude * 100.0;\n    #endif\n    altitude += minAltitude * 100.0;\n    return vec3(aPosition, altitude);\n}\n#ifdef HAS_ALTITUDE\n    vec3 unpackVTPosition(vec3 offset) {\n        return unpackVTPosition(aPosition + offset.xy, aAltitude + offset.z);\n    }\n    vec3 unpackVTPosition() {\n        return unpackVTPosition(aPosition, aAltitude);\n    }\n#else\n    float position_modValue = 16384.0;\n    float position_delta = 0.00001;\n    vec3 unpackVTPosition(vec3 offset) {\n        float z = aPosition.z;\n        vec2 pos = sign(aPosition.xy + position_delta) * mod(abs(aPosition.xy), position_modValue);\n        vec2 highs = floor(abs(aPosition.xy) / position_modValue);\n        float altitude = sign(z + position_delta) * (highs.x * 2.0 + highs.y) * pow(2.0, 15.0) + z;\n        return unpackVTPosition(pos + offset.xy, altitude + offset.z);\n    }\n    vec3 unpackVTPosition() {\n        return unpackVTPosition(vec3(0.0));\n    }\n#endif"),CM.ShaderLib.register("text_render_frag","#define HAS_HIGHLIGHT_COLOR_POINT 1\n#define SDF_PX 8.0\n#define DEVICE_PIXEL_RATIO 1.0\n#define EDGE_GAMMA 0.105 / DEVICE_PIXEL_RATIO\nuniform sampler2D glyphTex;\nuniform float textOpacity;\nuniform highp float gammaScale;\nuniform float isHalo;\nuniform highp float textHaloBlur;\n#if defined(HAS_TEXT_HALO_OPACITY) || defined(HAS_TEXT_HALO_RADIUS)\n    varying vec2 vTextHalo;\n#endif\n#ifndef HAS_TEXT_HALO_OPACITY\n    uniform float textHaloOpacity;\n#endif\n#ifndef HAS_TEXT_HALO_RADIUS\n    uniform highp float textHaloRadius;\n#endif\nvarying float vTextSize;\nvarying float vGammaScale;\n#ifdef HAS_TEXT_FILL\n    varying vec4 vTextFill;\n#else\n    uniform vec4 textFill;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\n    varying vec4 vTextHaloFill;\n#else\n    uniform vec4 textHaloFill;\n#endif\nvec4 renderText(vec2 texCoord) {\n    #ifdef HAS_TEXT_FILL\n        vec4 myTextFill = vTextFill;\n    #else\n        vec4 myTextFill = textFill;\n    #endif\n    float fontScale = vTextSize / 24.0;\n    vec4 color = myTextFill;\n    highp float gamma = EDGE_GAMMA / (fontScale * gammaScale);\n    lowp float buff = 185.0 / 256.0;    bool isHaloText;\n    #ifdef HAS_HALO_ATTR\n        isHaloText = vHalo > 0.5;\n    #else\n        isHaloText = isHalo == 1.0;\n    #endif\n    if (isHaloText) {\n        #ifdef HAS_TEXT_HALO_FILL\n            vec4 haloFill = vTextHaloFill;\n        #else\n            vec4 haloFill = textHaloFill;\n        #endif\n        #ifdef HAS_TEXT_HALO_RADIUS\n            float haloRadius = vTextHalo.x;\n        #else\n            float haloRadius = textHaloRadius;\n        #endif\n        if (haloRadius == 0.0) {\n            discard;\n        }\n        color = haloFill;\n        gamma = (textHaloBlur * 1.19 / SDF_PX + EDGE_GAMMA) / (fontScale * gammaScale);\n        buff = (6.0 - haloRadius / fontScale) / SDF_PX;\n        #ifdef HAS_TEXT_HALO_OPACITY\n            float haloOpacity = vTextHalo.y / 255.0;\n        #else\n            float haloOpacity = textHaloOpacity;\n        #endif\n        color *= haloOpacity * 1.25;\n    }\n    float dist = texture2D(glyphTex, texCoord).a;\n    highp float gammaScaled = gamma * vGammaScale * 0.7;\n    float alpha = clamp(smoothstep(buff - gammaScaled, buff + gammaScaled, dist), 0.0, 1.0);\n    return color * (alpha * textOpacity);\n}"),CM.WgslShaderLib.register("vt_position",{vert:"\nstruct VTPUniforms {\n    minAltitude: f32,\n};\n\n@group(0) @binding($b) var<uniform> vtUniforms: VTPUniforms;\n\n#ifdef HAS_ALTITUDE\n    fn unpackVTPosition(vertexInput: VertexInput) -> vec3f {\n        var altitude: f32 = vertexInput.aAltitude;\n        #ifdef HAS_TERRAIN_ALTITUDE\n            // aTerrainAltitude的单位是米，在vt中需要转换为厘米\n            altitude += vertexInput.aTerrainAltitude * 100.0;\n        #endif\n        altitude += vtUniforms.minAltitude * 100.0;\n        return vec3f(vec2f(vertexInput.aPosition), altitude);\n    }\n#else\n    // 16384 is pow(2.0, 14.0)\n    const position_modValue: f32 = 16384.0;\n    const position_delta: f32 = 0.00001;\n\n    fn unpackVTPosition(vertexInput: VertexInput) -> vec3f {\n        let aPosition: vec3f = vec3f(vertexInput.aPosition.xyz);\n        let z: f32 = aPosition.z;\n        let pos: vec2f = sign(aPosition.xy + position_delta) * (abs(aPosition.xy) % position_modValue);\n        let highs: vec2f = floor(abs(aPosition.xy) / position_modValue);\n\n        var altitude: f32 = sign(z + position_delta) * (highs.x * 2.0 + highs.y) * pow(2.0, 15.0) + z;\n        #ifdef HAS_TERRAIN_ALTITUDE\n            // aTerrainAltitude的单位是米，在vt中需要转换为厘米\n            altitude += vertexInput.aTerrainAltitude * 100.0;\n        #endif\n        altitude += vtUniforms.minAltitude * 100.0;\n        return vec3f(pos, altitude);\n    }\n#endif\n",attributes:[{defines:["HAS_TERRAIN_ALTITUDE"],name:"aTerrainAltitude",type:"f32"}]}),CM.WgslShaderLib.register("text_render",{frag:"\n#define HAS_HIGHLIGHT_COLOR_POINT 1\n#define SDF_PX 8.0\n#define DEVICE_PIXEL_RATIO 1.0\n// 0.105 / DEVICE_PIXEL_RATIO\n#define EDGE_GAMMA 0.105 / 1.0\n\nstruct TextRenderShaderUniforms {\n    gammaScale: f32\n}\n\nstruct TextRenderUniforms {\n    textOpacity: f32,\n    isHalo: f32,\n    textHaloBlur: f32,\n    #ifndef HAS_TEXT_HALO_OPACITY\n        textHaloOpacity: f32,\n    #endif\n    #ifndef HAS_TEXT_HALO_RADIUS\n        textHaloRadius: f32,\n    #endif\n    #ifndef HAS_TEXT_FILL\n        textFill: vec4f,\n    #endif\n    #ifndef HAS_TEXT_HALO_FILL\n        textHaloFill: vec4f,\n    #endif\n};\n\n@group(0) @binding($b) var<uniform> textRenderUniforms: TextRenderUniforms;\n@group(0) @binding($b) var<uniform> textRenderShaderUniforms: TextRenderShaderUniforms;\n@group(0) @binding($b) var glyphTex: texture_2d<f32>;\n@group(0) @binding($b) var glyphTexSampler: sampler;\n\n\nfn renderText(input: VertexOutput) -> vec4f {\n    #ifdef HAS_TEXT_FILL\n        var myTextFill = input.vTextFill;\n    #else\n        var myTextFill = textRenderUniforms.textFill;\n    #endif\n    let gammaScale = textRenderShaderUniforms.gammaScale;\n    let fontScale = input.vTextSize / 24.0;\n    var color = myTextFill;\n    var gamma = EDGE_GAMMA / (fontScale * gammaScale);\n    let buff = 185.0 / 256.0; // (256.0 - 64.0) / 256.0\n\n    var isHaloText: bool;\n    #ifdef HAS_HALO_ATTR\n        // text halo in icon\n        isHaloText = input.vHalo > 0.5;\n    #else\n        isHaloText = textRenderUniforms.isHalo == 1.0;\n    #endif\n\n    if (isHaloText) {\n        #ifdef HAS_TEXT_HALO_FILL\n            var haloFill = input.vTextHaloFill;\n        #else\n            var haloFill = textRenderUniforms.textHaloFill;\n        #endif\n\n        #ifdef HAS_TEXT_HALO_RADIUS\n            let haloRadius = input.vTextHalo.x;\n        #else\n            let haloRadius = textRenderUniforms.textHaloRadius;\n        #endif\n\n        if (haloRadius == 0.0) {\n            discard;\n        }\n\n        color = haloFill;\n        gamma = (textRenderUniforms.textHaloBlur * 1.19 / SDF_PX + EDGE_GAMMA) / (fontScale * gammaScale);\n        let buff = (6.0 - haloRadius / fontScale) / SDF_PX;\n\n        #ifdef HAS_TEXT_HALO_OPACITY\n            let haloOpacity = input.vTextHalo.y / 255.0;\n        #else\n            let haloOpacity = textRenderUniforms.textHaloOpacity;\n        #endif\n\n        color *= haloOpacity * 1.25;\n    }\n\n    let dist = textureSampleLevel(glyphTex, glyphTexSampler, input.vTexCoord, 0.0).r;\n    let gammaScaled = gamma * input.vGammaScale * 0.7;\n\n    let alpha = clamp(smoothstep(buff - gammaScaled, buff + gammaScaled, dist), 0.0, 1.0);\n    return color * (alpha * textRenderUniforms.textOpacity);\n}\n"}),gA();const fV=function(e,t){const n=e.toString(),i=n.indexOf("{")+1,s=n.substring(0,i);let o=`${s}\n    (`+t.toString()+")({});\n";return o+="\n"+n.substring(s.length),o}($R,KR);if(ox){const e=zu.VERSION;if(e.indexOf("1.0.0-beta")>=0||e.indexOf("1.0.0-alpha")>=0){co("@maptalks/vt",ox.inject(fV))}else co("@maptalks/vt",(function(){return ox.inject(fV)}))}else co("@maptalks/vt",fV);"undefined"!=typeof console&&console.log("@maptalks/vt v0.109.0");for(
/*!
  * Contains code from THREE.js
  * MIT License
  * https://github.com/mrdoob/three.js
  */
var dV=[],pV=0;pV<6;pV++)dV[pV]=[];var gV=[];function mV(e,t,n){CV(e);for(var i=0;i<6;i++){var s=dV[i];if(gV[0]=s[0]>0?t[1][0]:t[0][0],gV[1]=s[1]>0?t[1][1]:t[0][1],gV[2]=s[2]>0?t[1][2]:t[0][2],IV(s,gV)<0)return!1}return!0}var AV=3,yV=4,_V=5,vV=6,xV=7,bV=8,wV=9,TV=10,SV=11;function MV(e,t){var n=t,i=t,s=e[0],o=e[1],a=e[2],l=Math.abs(s*i[AV]+o*i[yV]+a*i[_V])+Math.abs(s*i[vV]+o*i[xV]+a*i[bV])+Math.abs(s*i[wV]+o*i[TV]+a*i[SV]),h=IV(e,n);return!(h<=-l)}function CV(e){var t=e[0],n=e[1],i=e[2],s=e[3],o=e[4],a=e[5],l=e[6],h=e[7],c=e[8],u=e[9],f=e[10],g=e[11],m=e[12],A=e[13],w=e[14],T=e[15];PV(dV[0],s-t,h-o,g-c,T-m),PV(dV[1],s+t,h+o,g+c,T+m),PV(dV[2],s+n,h+a,g+u,T+A),PV(dV[3],s-n,h-a,g-u,T-A),PV(dV[4],s-i,h-l,g-f,T-w),PV(dV[5],s+i,h+l,g+f,T+w)}function PV(e,t,n,i,s){var o=1/Math.sqrt(t*t+n*n+i*i);return e[0]=t*o,e[1]=n*o,e[2]=i*o,e[3]=s*o,e}function IV(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]}
/*!
   * @maptalks/3dtiles v0.106.6
   * LICENSE : UNLICENSED
   * (c) 2016-2025 maptalks.org
   */const kV="${",OV=`function(t){\n/*!\n     * @maptalks/gl v0.110.0\n     * LICENSE : UNLICENSED\n     * (c) 2016-2025 maptalks.com\n     */\nconst e=function(){if("undefined"!=typeof undefinedThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof undefined)return global;throw new Error("unable to locate global object")},n=e(),r=n.gl_trans__coders=n.gl_trans__coders||{};function a(){return e().maptalks_gltf_loader}r.inject=function(t){const r=t.toString(),a=r.indexOf("{")+1,o=r.substring(0,a),i=n.gl_trans__coders=n.gl_trans__coders||{};let s=\`${kV}o}\\n    const _____getGlobal = ${kV}e.toString()};\\n    const g___lobals = _____getGlobal()\\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};\`;for(const t in i)"inject"!==t&&"getTranscoder"!==t&&"registerTranscoder"!==t&&(s+='tran_____scoders["'+t+'"] ='+i[t].toString()+"\\n;");return s+="\\n("+e().maptalks_gltf_loader_bundle.toString()+")({});\\n",s+="\\n"+r.substring(o.length),s},r.registerTranscoder=function(t,e){r[t]=e},r.getTranscoder=function(t){return r[t]};var o="undefined"!=typeof Float32Array?Float32Array:Array;function i(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function s(t,e,n){var r=e[0],a=e[1],o=e[2],i=e[3],s=e[4],c=e[5],u=e[6],l=e[7],f=e[8],h=e[9],y=e[10],d=e[11],b=e[12],m=e[13],p=e[14],g=e[15],v=n[0],w=n[1],M=n[2],T=n[3];return t[0]=v*r+w*s+M*f+T*b,t[1]=v*a+w*c+M*h+T*m,t[2]=v*o+w*u+M*y+T*p,t[3]=v*i+w*l+M*d+T*g,v=n[4],w=n[5],M=n[6],T=n[7],t[4]=v*r+w*s+M*f+T*b,t[5]=v*a+w*c+M*h+T*m,t[6]=v*o+w*u+M*y+T*p,t[7]=v*i+w*l+M*d+T*g,v=n[8],w=n[9],M=n[10],T=n[11],t[8]=v*r+w*s+M*f+T*b,t[9]=v*a+w*c+M*h+T*m,t[10]=v*o+w*u+M*y+T*p,t[11]=v*i+w*l+M*d+T*g,v=n[12],w=n[13],M=n[14],T=n[15],t[12]=v*r+w*s+M*f+T*b,t[13]=v*a+w*c+M*h+T*m,t[14]=v*o+w*u+M*y+T*p,t[15]=v*i+w*l+M*d+T*g,t}function c(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function u(){var t=new o(3);return o!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function l(t){var e=t[0],n=t[1],r=t[2];return Math.hypot(e,n,r)}function f(t,e,n){var r=new o(3);return r[0]=t,r[1]=e,r[2]=n,r}function h(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function y(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function d(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function b(t,e){var n=e[0],r=e[1],a=e[2],o=n*n+r*r+a*a;return o>0&&(o=1/Math.sqrt(o)),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o,t}function m(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function p(t,e,n){var r=e[0],a=e[1],o=e[2],i=n[3]*r+n[7]*a+n[11]*o+n[15];return i=i||1,t[0]=(n[0]*r+n[4]*a+n[8]*o+n[12])/i,t[1]=(n[1]*r+n[5]*a+n[9]*o+n[13])/i,t[2]=(n[2]*r+n[6]*a+n[10]*o+n[14])/i,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var g=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t},v=function(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t},w=l;function M(){var t=new o(4);return o!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}u(),function(){var t,e=(t=new o(4),o!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var T;function A(t){return t&&t.t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}u(),f(1,0,0),f(0,1,0),M(),M(),T=new o(9),o!=Float32Array&&(T[1]=0,T[2]=0,T[3]=0,T[5]=0,T[6]=0,T[7]=0),T[0]=1,T[4]=1,T[8]=1;var k={exports:{}},_={exports:{}},O=function(t){return!(!t||"string"==typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))},S=Array.prototype.concat,x=Array.prototype.slice,F=_.exports=function(t){for(var e=[],n=0,r=t.length;n<r;n++){var a=t[n];O(a)?e=S.call(e,x.call(a)):e.push(a)}return e};F.wrap=function(t){return function(){return t(F(arguments))}};var I=_.exports,C={"aliceblue":[240,248,255],"antiquewhite":[250,235,215],"aqua":[0,255,255],"aquamarine":[127,255,212],"azure":[240,255,255],"beige":[245,245,220],"bisque":[255,228,196],"black":[0,0,0],"blanchedalmond":[255,235,205],"blue":[0,0,255],"blueviolet":[138,43,226],"brown":[165,42,42],"burlywood":[222,184,135],"cadetblue":[95,158,160],"chartreuse":[127,255,0],"chocolate":[210,105,30],"coral":[255,127,80],"cornflowerblue":[100,149,237],"cornsilk":[255,248,220],"crimson":[220,20,60],"cyan":[0,255,255],"darkblue":[0,0,139],"darkcyan":[0,139,139],"darkgoldenrod":[184,134,11],"darkgray":[169,169,169],"darkgreen":[0,100,0],"darkgrey":[169,169,169],"darkkhaki":[189,183,107],"darkmagenta":[139,0,139],"darkolivegreen":[85,107,47],"darkorange":[255,140,0],"darkorchid":[153,50,204],"darkred":[139,0,0],"darksalmon":[233,150,122],"darkseagreen":[143,188,143],"darkslateblue":[72,61,139],"darkslategray":[47,79,79],"darkslategrey":[47,79,79],"darkturquoise":[0,206,209],"darkviolet":[148,0,211],"deeppink":[255,20,147],"deepskyblue":[0,191,255],"dimgray":[105,105,105],"dimgrey":[105,105,105],"dodgerblue":[30,144,255],"firebrick":[178,34,34],"floralwhite":[255,250,240],"forestgreen":[34,139,34],"fuchsia":[255,0,255],"gainsboro":[220,220,220],"ghostwhite":[248,248,255],"gold":[255,215,0],"goldenrod":[218,165,32],"gray":[128,128,128],"green":[0,128,0],"greenyellow":[173,255,47],"grey":[128,128,128],"honeydew":[240,255,240],"hotpink":[255,105,180],"indianred":[205,92,92],"indigo":[75,0,130],"ivory":[255,255,240],"khaki":[240,230,140],"lavender":[230,230,250],"lavenderblush":[255,240,245],"lawngreen":[124,252,0],"lemonchiffon":[255,250,205],"lightblue":[173,216,230],"lightcoral":[240,128,128],"lightcyan":[224,255,255],"lightgoldenrodyellow":[250,250,210],"lightgray":[211,211,211],"lightgreen":[144,238,144],"lightgrey":[211,211,211],"lightpink":[255,182,193],"lightsalmon":[255,160,122],"lightseagreen":[32,178,170],"lightskyblue":[135,206,250],"lightslategray":[119,136,153],"lightslategrey":[119,136,153],"lightsteelblue":[176,196,222],"lightyellow":[255,255,224],"lime":[0,255,0],"limegreen":[50,205,50],"linen":[250,240,230],"magenta":[255,0,255],"maroon":[128,0,0],"mediumaquamarine":[102,205,170],"mediumblue":[0,0,205],"mediumorchid":[186,85,211],"mediumpurple":[147,112,219],"mediumseagreen":[60,179,113],"mediumslateblue":[123,104,238],"mediumspringgreen":[0,250,154],"mediumturquoise":[72,209,204],"mediumvioletred":[199,21,133],"midnightblue":[25,25,112],"mintcream":[245,255,250],"mistyrose":[255,228,225],"moccasin":[255,228,181],"navajowhite":[255,222,173],"navy":[0,0,128],"oldlace":[253,245,230],"olive":[128,128,0],"olivedrab":[107,142,35],"orange":[255,165,0],"orangered":[255,69,0],"orchid":[218,112,214],"palegoldenrod":[238,232,170],"palegreen":[152,251,152],"paleturquoise":[175,238,238],"palevioletred":[219,112,147],"papayawhip":[255,239,213],"peachpuff":[255,218,185],"peru":[205,133,63],"pink":[255,192,203],"plum":[221,160,221],"powderblue":[176,224,230],"purple":[128,0,128],"rebeccapurple":[102,51,153],"red":[255,0,0],"rosybrown":[188,143,143],"royalblue":[65,105,225],"saddlebrown":[139,69,19],"salmon":[250,128,114],"sandybrown":[244,164,96],"seagreen":[46,139,87],"seashell":[255,245,238],"sienna":[160,82,45],"silver":[192,192,192],"skyblue":[135,206,235],"slateblue":[106,90,205],"slategray":[112,128,144],"slategrey":[112,128,144],"snow":[255,250,250],"springgreen":[0,255,127],"steelblue":[70,130,180],"tan":[210,180,140],"teal":[0,128,128],"thistle":[216,191,216],"tomato":[255,99,71],"turquoise":[64,224,208],"violet":[238,130,238],"wheat":[245,222,179],"white":[255,255,255],"whitesmoke":[245,245,245],"yellow":[255,255,0],"yellowgreen":[154,205,50]},E=I,U=Object.hasOwnProperty,N=Object.create(null);for(var z in C)U.call(C,z)&&(N[C[z]]=z);var L=k.exports={to:{},get:{}};function j(t,e,n){return Math.min(Math.max(e,t),n)}function D(t){var e=Math.round(t).toString(16).toUpperCase();return e.length<2?"0"+e:e}L.get=function(t){var e,n;switch(t.substring(0,3).toLowerCase()){case"hsl":e=L.get.hsl(t),n="hsl";break;case"hwb":e=L.get.hwb(t),n="hwb";break;default:e=L.get.rgb(t),n="rgb"}return e?{model:n,value:e}:null},L.get.rgb=function(t){if(!t)return null;var e,n,r,a=[0,0,0,1];if(e=t.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(r=e[2],e=e[1],n=0;n<3;n++){var o=2*n;a[n]=parseInt(e.slice(o,o+2),16)}r&&(a[3]=parseInt(r,16)/255)}else if(e=t.match(/^#([a-f0-9]{3,4})$/i)){for(r=(e=e[1])[3],n=0;n<3;n++)a[n]=parseInt(e[n]+e[n],16);r&&(a[3]=parseInt(r+r,16)/255)}else if(e=t.match(/^rgba?\\(\\s*([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/)){for(n=0;n<3;n++)a[n]=parseInt(e[n+1],0);e[4]&&(e[5]?a[3]=.01*parseFloat(e[4]):a[3]=parseFloat(e[4]))}else{if(!(e=t.match(/^rgba?\\(\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/)))return(e=t.match(/^(\\w+)$/))?"transparent"===e[1]?[0,0,0,0]:U.call(C,e[1])?((a=C[e[1]])[3]=1,a):null:null;for(n=0;n<3;n++)a[n]=Math.round(2.55*parseFloat(e[n+1]));e[4]&&(e[5]?a[3]=.01*parseFloat(e[4]):a[3]=parseFloat(e[4]))}for(n=0;n<3;n++)a[n]=j(a[n],0,255);return a[3]=j(a[3],0,1),a},L.get.hsl=function(t){if(!t)return null;var e=t.match(/^hsla?\\(\\s*([+-]?(?:\\d{0,3}\\.)?\\d+)(?:deg)?\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*(?:[,|\\/]\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,j(parseFloat(e[2]),0,100),j(parseFloat(e[3]),0,100),j(isNaN(n)?1:n,0,1)]}return null},L.get.hwb=function(t){if(!t)return null;var e=t.match(/^hwb\\(\\s*([+-]?\\d{0,3}(?:\\.\\d+)?)(?:deg)?\\s*,\\s*([+-]?[\\d\\.]+)%\\s*,\\s*([+-]?[\\d\\.]+)%\\s*(?:,\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,j(parseFloat(e[2]),0,100),j(parseFloat(e[3]),0,100),j(isNaN(n)?1:n,0,1)]}return null},L.to.hex=function(){var t=E(arguments);return"#"+D(t[0])+D(t[1])+D(t[2])+(t[3]<1?D(Math.round(255*t[3])):"")},L.to.rgb=function(){var t=E(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},L.to.rgb.percent=function(){var t=E(arguments),e=Math.round(t[0]/255*100),n=Math.round(t[1]/255*100),r=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+e+"%, "+n+"%, "+r+"%)":"rgba("+e+"%, "+n+"%, "+r+"%, "+t[3]+")"},L.to.hsl=function(){var t=E(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},L.to.hwb=function(){var t=E(arguments),e="";return t.length>=4&&1!==t[3]&&(e=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+e+")"},L.to.keyword=function(t){return N[t.slice(0,3)]};var P=k.exports,B={exports:{}},q={"aliceblue":[240,248,255],"antiquewhite":[250,235,215],"aqua":[0,255,255],"aquamarine":[127,255,212],"azure":[240,255,255],"beige":[245,245,220],"bisque":[255,228,196],"black":[0,0,0],"blanchedalmond":[255,235,205],"blue":[0,0,255],"blueviolet":[138,43,226],"brown":[165,42,42],"burlywood":[222,184,135],"cadetblue":[95,158,160],"chartreuse":[127,255,0],"chocolate":[210,105,30],"coral":[255,127,80],"cornflowerblue":[100,149,237],"cornsilk":[255,248,220],"crimson":[220,20,60],"cyan":[0,255,255],"darkblue":[0,0,139],"darkcyan":[0,139,139],"darkgoldenrod":[184,134,11],"darkgray":[169,169,169],"darkgreen":[0,100,0],"darkgrey":[169,169,169],"darkkhaki":[189,183,107],"darkmagenta":[139,0,139],"darkolivegreen":[85,107,47],"darkorange":[255,140,0],"darkorchid":[153,50,204],"darkred":[139,0,0],"darksalmon":[233,150,122],"darkseagreen":[143,188,143],"darkslateblue":[72,61,139],"darkslategray":[47,79,79],"darkslategrey":[47,79,79],"darkturquoise":[0,206,209],"darkviolet":[148,0,211],"deeppink":[255,20,147],"deepskyblue":[0,191,255],"dimgray":[105,105,105],"dimgrey":[105,105,105],"dodgerblue":[30,144,255],"firebrick":[178,34,34],"floralwhite":[255,250,240],"forestgreen":[34,139,34],"fuchsia":[255,0,255],"gainsboro":[220,220,220],"ghostwhite":[248,248,255],"gold":[255,215,0],"goldenrod":[218,165,32],"gray":[128,128,128],"green":[0,128,0],"greenyellow":[173,255,47],"grey":[128,128,128],"honeydew":[240,255,240],"hotpink":[255,105,180],"indianred":[205,92,92],"indigo":[75,0,130],"ivory":[255,255,240],"khaki":[240,230,140],"lavender":[230,230,250],"lavenderblush":[255,240,245],"lawngreen":[124,252,0],"lemonchiffon":[255,250,205],"lightblue":[173,216,230],"lightcoral":[240,128,128],"lightcyan":[224,255,255],"lightgoldenrodyellow":[250,250,210],"lightgray":[211,211,211],"lightgreen":[144,238,144],"lightgrey":[211,211,211],"lightpink":[255,182,193],"lightsalmon":[255,160,122],"lightseagreen":[32,178,170],"lightskyblue":[135,206,250],"lightslategray":[119,136,153],"lightslategrey":[119,136,153],"lightsteelblue":[176,196,222],"lightyellow":[255,255,224],"lime":[0,255,0],"limegreen":[50,205,50],"linen":[250,240,230],"magenta":[255,0,255],"maroon":[128,0,0],"mediumaquamarine":[102,205,170],"mediumblue":[0,0,205],"mediumorchid":[186,85,211],"mediumpurple":[147,112,219],"mediumseagreen":[60,179,113],"mediumslateblue":[123,104,238],"mediumspringgreen":[0,250,154],"mediumturquoise":[72,209,204],"mediumvioletred":[199,21,133],"midnightblue":[25,25,112],"mintcream":[245,255,250],"mistyrose":[255,228,225],"moccasin":[255,228,181],"navajowhite":[255,222,173],"navy":[0,0,128],"oldlace":[253,245,230],"olive":[128,128,0],"olivedrab":[107,142,35],"orange":[255,165,0],"orangered":[255,69,0],"orchid":[218,112,214],"palegoldenrod":[238,232,170],"palegreen":[152,251,152],"paleturquoise":[175,238,238],"palevioletred":[219,112,147],"papayawhip":[255,239,213],"peachpuff":[255,218,185],"peru":[205,133,63],"pink":[255,192,203],"plum":[221,160,221],"powderblue":[176,224,230],"purple":[128,0,128],"rebeccapurple":[102,51,153],"red":[255,0,0],"rosybrown":[188,143,143],"royalblue":[65,105,225],"saddlebrown":[139,69,19],"salmon":[250,128,114],"sandybrown":[244,164,96],"seagreen":[46,139,87],"seashell":[255,245,238],"sienna":[160,82,45],"silver":[192,192,192],"skyblue":[135,206,235],"slateblue":[106,90,205],"slategray":[112,128,144],"slategrey":[112,128,144],"snow":[255,250,250],"springgreen":[0,255,127],"steelblue":[70,130,180],"tan":[210,180,140],"teal":[0,128,128],"thistle":[216,191,216],"tomato":[255,99,71],"turquoise":[64,224,208],"violet":[238,130,238],"wheat":[245,222,179],"white":[255,255,255],"whitesmoke":[245,245,245],"yellow":[255,255,0],"yellowgreen":[154,205,50]},R={};for(var V in q)q.hasOwnProperty(V)&&(R[q[V]]=V);var G=B.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var $ in G)if(G.hasOwnProperty($)){if(!("channels"in G[$]))throw new Error("missing channels property: "+$);if(!("labels"in G[$]))throw new Error("missing channel labels property: "+$);if(G[$].labels.length!==G[$].channels)throw new Error("channel and label counts mismatch: "+$);var X=G[$].channels,H=G[$].labels;delete G[$].channels,delete G[$].labels,Object.defineProperty(G[$],"channels",{value:X}),Object.defineProperty(G[$],"labels",{value:H})}G.rgb.hsl=function(t){var e,n,r=t[0]/255,a=t[1]/255,o=t[2]/255,i=Math.min(r,a,o),s=Math.max(r,a,o),c=s-i;return s===i?e=0:r===s?e=(a-o)/c:a===s?e=2+(o-r)/c:o===s&&(e=4+(r-a)/c),(e=Math.min(60*e,360))<0&&(e+=360),n=(i+s)/2,[e,100*(s===i?0:n<=.5?c/(s+i):c/(2-s-i)),100*n]},G.rgb.hsv=function(t){var e,n,r,a,o,i=t[0]/255,s=t[1]/255,c=t[2]/255,u=Math.max(i,s,c),l=u-Math.min(i,s,c),f=function(t){return(u-t)/6/l+.5};return 0===l?a=o=0:(o=l/u,e=f(i),n=f(s),r=f(c),i===u?a=r-n:s===u?a=1/3+e-r:c===u&&(a=2/3+n-e),a<0?a+=1:a>1&&(a-=1)),[360*a,100*o,100*u]},G.rgb.hwb=function(t){var e=t[0],n=t[1],r=t[2];return[G.rgb.hsl(t)[0],100*(1/255*Math.min(e,Math.min(n,r))),100*(r=1-1/255*Math.max(e,Math.max(n,r)))]},G.rgb.cmyk=function(t){var e,n=t[0]/255,r=t[1]/255,a=t[2]/255;return[100*((1-n-(e=Math.min(1-n,1-r,1-a)))/(1-e)||0),100*((1-r-e)/(1-e)||0),100*((1-a-e)/(1-e)||0),100*e]},G.rgb.keyword=function(t){var e=R[t];if(e)return e;var n,r,a,o=1/0;for(var i in q)if(q.hasOwnProperty(i)){var s=q[i],c=(r=t,a=s,Math.pow(r[0]-a[0],2)+Math.pow(r[1]-a[1],2)+Math.pow(r[2]-a[2],2));c<o&&(o=c,n=i)}return n},G.keyword.rgb=function(t){return q[t]},G.rgb.xyz=function(t){var e=t[0]/255,n=t[1]/255,r=t[2]/255;return[100*(.4124*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92)),100*(.2126*e+.7152*n+.0722*r),100*(.0193*e+.1192*n+.9505*r)]},G.rgb.lab=function(t){var e=G.rgb.xyz(t),n=e[0],r=e[1],a=e[2];return r/=100,a/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116)-16,500*(n-r),200*(r-(a=a>.008856?Math.pow(a,1/3):7.787*a+16/116))]},G.hsl.rgb=function(t){var e,n,r,a,o,i=t[0]/360,s=t[1]/100,c=t[2]/100;if(0===s)return[o=255*c,o,o];e=2*c-(n=c<.5?c*(1+s):c+s-c*s),a=[0,0,0];for(var u=0;u<3;u++)(r=i+1/3*-(u-1))<0&&r++,r>1&&r--,o=6*r<1?e+6*(n-e)*r:2*r<1?n:3*r<2?e+(n-e)*(2/3-r)*6:e,a[u]=255*o;return a},G.hsl.hsv=function(t){var e=t[0],n=t[1]/100,r=t[2]/100,a=n,o=Math.max(r,.01);return n*=(r*=2)<=1?r:2-r,a*=o<=1?o:2-o,[e,100*(0===r?2*a/(o+a):2*n/(r+n)),100*((r+n)/2)]},G.hsv.rgb=function(t){var e=t[0]/60,n=t[1]/100,r=t[2]/100,a=Math.floor(e)%6,o=e-Math.floor(e),i=255*r*(1-n),s=255*r*(1-n*o),c=255*r*(1-n*(1-o));switch(r*=255,a){case 0:return[r,c,i];case 1:return[s,r,i];case 2:return[i,r,c];case 3:return[i,s,r];case 4:return[c,i,r];case 5:return[r,i,s]}},G.hsv.hsl=function(t){var e,n,r,a=t[0],o=t[1]/100,i=t[2]/100,s=Math.max(i,.01);return r=(2-o)*i,n=o*s,[a,100*(n=(n/=(e=(2-o)*s)<=1?e:2-e)||0),100*(r/=2)]},G.hwb.rgb=function(t){var e,n,r,a,o,i,s,c=t[0]/360,u=t[1]/100,l=t[2]/100,f=u+l;switch(f>1&&(u/=f,l/=f),r=6*c-(e=Math.floor(6*c)),1&e&&(r=1-r),a=u+r*((n=1-l)-u),e){default:case 6:case 0:o=n,i=a,s=u;break;case 1:o=a,i=n,s=u;break;case 2:o=u,i=n,s=a;break;case 3:o=u,i=a,s=n;break;case 4:o=a,i=u,s=n;break;case 5:o=n,i=u,s=a}return[255*o,255*i,255*s]},G.cmyk.rgb=function(t){var e=t[0]/100,n=t[1]/100,r=t[2]/100,a=t[3]/100;return[255*(1-Math.min(1,e*(1-a)+a)),255*(1-Math.min(1,n*(1-a)+a)),255*(1-Math.min(1,r*(1-a)+a))]},G.xyz.rgb=function(t){var e,n,r,a=t[0]/100,o=t[1]/100,i=t[2]/100;return n=-.9689*a+1.8758*o+.0415*i,r=.0557*a+-.204*o+1.057*i,e=(e=3.2406*a+-1.5372*o+-.4986*i)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r,[255*(e=Math.min(Math.max(0,e),1)),255*(n=Math.min(Math.max(0,n),1)),255*(r=Math.min(Math.max(0,r),1))]},G.xyz.lab=function(t){var e=t[0],n=t[1],r=t[2];return n/=100,r/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(e-n),200*(n-(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116))]},G.lab.xyz=function(t){var e,n,r,a=t[0];e=t[1]/500+(n=(a+16)/116),r=n-t[2]/200;var o=Math.pow(n,3),i=Math.pow(e,3),s=Math.pow(r,3);return n=o>.008856?o:(n-16/116)/7.787,e=i>.008856?i:(e-16/116)/7.787,r=s>.008856?s:(r-16/116)/7.787,[e*=95.047,n*=100,r*=108.883]},G.lab.lch=function(t){var e,n=t[0],r=t[1],a=t[2];return(e=360*Math.atan2(a,r)/2/Math.PI)<0&&(e+=360),[n,Math.sqrt(r*r+a*a),e]},G.lch.lab=function(t){var e,n=t[0],r=t[1];return e=t[2]/360*2*Math.PI,[n,r*Math.cos(e),r*Math.sin(e)]},G.rgb.ansi16=function(t){var e=t[0],n=t[1],r=t[2],a=1 in arguments?arguments[1]:G.rgb.hsv(t)[2];if(0===(a=Math.round(a/50)))return 30;var o=30+(Math.round(r/255)<<2|Math.round(n/255)<<1|Math.round(e/255));return 2===a&&(o+=60),o},G.hsv.ansi16=function(t){return G.rgb.ansi16(G.hsv.rgb(t),t[2])},G.rgb.ansi256=function(t){var e=t[0],n=t[1],r=t[2];return e===n&&n===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(n/255*5)+Math.round(r/255*5)},G.ansi16.rgb=function(t){var e=t%10;if(0===e||7===e)return t>50&&(e+=3.5),[e=e/10.5*255,e,e];var n=.5*(1+~~(t>50));return[(1&e)*n*255,(e>>1&1)*n*255,(e>>2&1)*n*255]},G.ansi256.rgb=function(t){if(t>=232){var e=10*(t-232)+8;return[e,e,e]}var n;return t-=16,[Math.floor(t/36)/5*255,Math.floor((n=t%36)/6)/5*255,n%6/5*255]},G.rgb.hex=function(t){var e=(((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))).toString(16).toUpperCase();return"000000".substring(e.length)+e},G.hex.rgb=function(t){var e=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!e)return[0,0,0];var n=e[0];3===e[0].length&&(n=n.split("").map((function(t){return t+t})).join(""));var r=parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},G.rgb.hcg=function(t){var e,n=t[0]/255,r=t[1]/255,a=t[2]/255,o=Math.max(Math.max(n,r),a),i=Math.min(Math.min(n,r),a),s=o-i;return e=s<=0?0:o===n?(r-a)/s%6:o===r?2+(a-n)/s:4+(n-r)/s+4,e/=6,[360*(e%=1),100*s,100*(s<1?i/(1-s):0)]},G.hsl.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=1,a=0;return(r=n<.5?2*e*n:2*e*(1-n))<1&&(a=(n-.5*r)/(1-r)),[t[0],100*r,100*a]},G.hsv.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=e*n,a=0;return r<1&&(a=(n-r)/(1-r)),[t[0],100*r,100*a]},G.hcg.rgb=function(t){var e=t[0]/360,n=t[1]/100,r=t[2]/100;if(0===n)return[255*r,255*r,255*r];var a,o=[0,0,0],i=e%1*6,s=i%1,c=1-s;switch(Math.floor(i)){case 0:o[0]=1,o[1]=s,o[2]=0;break;case 1:o[0]=c,o[1]=1,o[2]=0;break;case 2:o[0]=0,o[1]=1,o[2]=s;break;case 3:o[0]=0,o[1]=c,o[2]=1;break;case 4:o[0]=s,o[1]=0,o[2]=1;break;default:o[0]=1,o[1]=0,o[2]=c}return a=(1-n)*r,[255*(n*o[0]+a),255*(n*o[1]+a),255*(n*o[2]+a)]},G.hcg.hsv=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e),r=0;return n>0&&(r=e/n),[t[0],100*r,100*n]},G.hcg.hsl=function(t){var e=t[1]/100,n=t[2]/100*(1-e)+.5*e,r=0;return n>0&&n<.5?r=e/(2*n):n>=.5&&n<1&&(r=e/(2*(1-n))),[t[0],100*r,100*n]},G.hcg.hwb=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e);return[t[0],100*(n-e),100*(1-n)]},G.hwb.hcg=function(t){var e=t[1]/100,n=1-t[2]/100,r=n-e,a=0;return r<1&&(a=(n-r)/(1-r)),[t[0],100*r,100*a]},G.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},G.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},G.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},G.gray.hsl=G.gray.hsv=function(t){return[0,0,t[0]]},G.gray.hwb=function(t){return[0,100,t[0]]},G.gray.cmyk=function(t){return[0,0,0,t[0]]},G.gray.lab=function(t){return[t[0],0,0]},G.gray.hex=function(t){var e=255&Math.round(t[0]/100*255),n=((e<<16)+(e<<8)+e).toString(16).toUpperCase();return"000000".substring(n.length)+n},G.rgb.gray=function(t){return[(t[0]+t[1]+t[2])/3/255*100]};var J=B.exports,Y=J;function K(t){var e=function(){for(var t={},e=Object.keys(Y),n=e.length,r=0;r<n;r++)t[e[r]]={distance:-1,parent:null};return t}(),n=[t];for(e[t].distance=0;n.length;)for(var r=n.pop(),a=Object.keys(Y[r]),o=a.length,i=0;i<o;i++){var s=a[i],c=e[s];-1===c.distance&&(c.distance=e[r].distance+1,c.parent=r,n.unshift(s))}return e}function Q(t,e){return function(n){return e(t(n))}}function Z(t,e){for(var n=[e[t].parent,t],r=Y[e[t].parent][t],a=e[t].parent;e[a].parent;)n.unshift(e[a].parent),r=Q(Y[e[a].parent][a],r),a=e[a].parent;return r.conversion=n,r}var W=J,tt=function(t){for(var e=K(t),n={},r=Object.keys(e),a=r.length,o=0;o<a;o++){var i=r[o];null!==e[i].parent&&(n[i]=Z(i,e))}return n},et={};Object.keys(W).forEach((function(t){et[t]={},Object.defineProperty(et[t],"channels",{value:W[t].channels}),Object.defineProperty(et[t],"labels",{value:W[t].labels});var e=tt(t);Object.keys(e).forEach((function(n){var r=e[n];et[t][n]=function(t){var e=function(e){if(null==e)return e;arguments.length>1&&(e=Array.prototype.slice.call(arguments));var n=t(e);if("object"==typeof n)for(var r=n.length,a=0;a<r;a++)n[a]=Math.round(n[a]);return n};return"conversion"in t&&(e.conversion=t.conversion),e}(r),et[t][n].raw=function(t){var e=function(e){return null==e?e:(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),t(e))};return"conversion"in t&&(e.conversion=t.conversion),e}(r)}))}));var nt=P,rt=et,at=[].slice,ot=["keyword","gray","hex"],it={};Object.keys(rt).forEach((function(t){it[at.call(rt[t].labels).sort().join("")]=t}));var st={};function ct(t,e){if(!(this instanceof ct))return new ct(t,e);if(e&&e in ot&&(e=null),e&&!(e in rt))throw new Error("Unknown model: "+e);var n,r;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof ct)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"==typeof t){var a=nt.get(t);if(null===a)throw new Error("Unable to parse color from string: "+t);this.model=a.model,r=rt[this.model].channels,this.color=a.value.slice(0,r),this.valpha="number"==typeof a.value[r]?a.value[r]:1}else if(t.length){this.model=e||"rgb",r=rt[this.model].channels;var o=at.call(t,0,r);this.color=ft(o,r),this.valpha="number"==typeof t[r]?t[r]:1}else if("number"==typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var i=Object.keys(t);"alpha"in t&&(i.splice(i.indexOf("alpha"),1),this.valpha="number"==typeof t.alpha?t.alpha:0);var s=i.sort().join("");if(!(s in it))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=it[s];var c=rt[this.model].labels,u=[];for(n=0;n<c.length;n++)u.push(t[c[n]]);this.color=ft(u)}if(st[this.model])for(r=rt[this.model].channels,n=0;n<r;n++){var l=st[this.model][n];l&&(this.color[n]=l(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function ut(t,e,n){return(t=Array.isArray(t)?t:[t]).forEach((function(t){(st[t]||(st[t]=[]))[e]=n})),t=t[0],function(r){var a;return arguments.length?(n&&(r=n(r)),(a=this[t]()).color[e]=r,a):(a=this[t]().color[e],n&&(a=n(a)),a)}}function lt(t){return function(e){return Math.max(0,Math.min(t,e))}}function ft(t,e){for(var n=0;n<e;n++)"number"!=typeof t[n]&&(t[n]=0);return t}function ht(t){return null==t}function yt(t){return"object"==typeof t&&!!t}function dt(t){return t/Math.PI*180}ct.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var e=this.model in nt.to?this:this.rgb(),n=1===(e=e.round("number"==typeof t?t:1)).valpha?e.color:e.color.concat(this.valpha);return nt.to[e.model](n)},percentString:function(t){var e=this.rgb().round("number"==typeof t?t:1),n=1===e.valpha?e.color:e.color.concat(this.valpha);return nt.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},e=rt[this.model].channels,n=rt[this.model].labels,r=0;r<e;r++)t[n[r]]=this.color[r];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new ct(this.color.map(function(t){return function(e){return function(t,e){return Number(t.toFixed(e))}(e,t)}}(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new ct(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:ut("rgb",0,lt(255)),green:ut("rgb",1,lt(255)),blue:ut("rgb",2,lt(255)),hue:ut(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:ut("hsl",1,lt(100)),lightness:ut("hsl",2,lt(100)),saturationv:ut("hsv",1,lt(100)),value:ut("hsv",2,lt(100)),chroma:ut("hcg",1,lt(100)),gray:ut("hcg",2,lt(100)),white:ut("hwb",1,lt(100)),wblack:ut("hwb",2,lt(100)),cyan:ut("cmyk",0,lt(100)),magenta:ut("cmyk",1,lt(100)),yellow:ut("cmyk",2,lt(100)),black:ut("cmyk",3,lt(100)),x:ut("xyz",0,lt(100)),y:ut("xyz",1,lt(100)),z:ut("xyz",2,lt(100)),l:ut("lab",0,lt(100)),a:ut("lab",1),b:ut("lab",2),keyword:function(t){return arguments.length?new ct(t):rt[this.model].keyword(this.color)},hex:function(t){return arguments.length?new ct(t):nt.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,e=[],n=0;n<t.length;n++){var r=t[n]/255;e[n]=r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4)}return.2126*e[0]+.7152*e[1]+.0722*e[2]},contrast:function(t){var e=this.luminosity(),n=t.luminosity();return e>n?(e+.05)/(n+.05):(n+.05)/(e+.05)},level:function(t){var e=this.contrast(t);return e>=7.1?"AAA":e>=4.5?"AA":""},isDark:function(){var t=this.rgb().color;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),e=0;e<3;e++)t.color[e]=255-t.color[e];return t},lighten:function(t){var e=this.hsl();return e.color[2]+=e.color[2]*t,e},darken:function(t){var e=this.hsl();return e.color[2]-=e.color[2]*t,e},saturate:function(t){var e=this.hsl();return e.color[1]+=e.color[1]*t,e},desaturate:function(t){var e=this.hsl();return e.color[1]-=e.color[1]*t,e},whiten:function(t){var e=this.hwb();return e.color[1]+=e.color[1]*t,e},blacken:function(t){var e=this.hwb();return e.color[2]+=e.color[2]*t,e},grayscale:function(){var t=this.rgb().color,e=.3*t[0]+.59*t[1]+.11*t[2];return ct.rgb(e,e,e)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var e=this.hsl(),n=e.color[0];return n=(n=(n+t)%360)<0?360+n:n,e.color[0]=n,e},mix:function(t,e){if(!t||!t.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof t);var n=t.rgb(),r=this.rgb(),a=void 0===e?.5:e,o=2*a-1,i=n.alpha()-r.alpha(),s=((o*i==-1?o:(o+i)/(1+o*i))+1)/2,c=1-s;return ct.rgb(s*n.red()+c*r.red(),s*n.green()+c*r.green(),s*n.blue()+c*r.blue(),n.alpha()*a+r.alpha()*(1-a))}},Object.keys(rt).forEach((function(t){if(-1===ot.indexOf(t)){var e=rt[t].channels;ct.prototype[t]=function(){if(this.model===t)return new ct(this);if(arguments.length)return new ct(arguments,t);var n,r="number"==typeof arguments[e]?e:this.valpha;return new ct((n=rt[this.model][t].raw(this.color),Array.isArray(n)?n:[n]).concat(r),t)},ct[t]=function(n){return"number"==typeof n&&(n=ft(at.call(arguments),e)),new ct(n,t)}}}));const bt=[1,1,1,1,2,2,3,0];function mt(t){const e=t.length;let n="";for(let r=0;r<e;){let a=t[r++];if(128&a){let n=bt[a>>3&7];if(!(64&a)||!n||r+n>e)return null;for(a&=63>>n;n>0;n-=1){const e=t[r++];if(128!=(192&e))return null;a=a<<6|63&e}}n+=String.fromCharCode(a)}return n}new Array(3),new Array(3);const pt=[1/6378137,1/6378137,1/6356752.314245179],gt=[1/40680631590769,1/40680631590769,1/40408299984661.445],vt=new Array(3),wt=new Array(3),Mt=new Array(3);function Tt(t,e){const n=gt,r=function(t,e,n,r,a){const o=e[0],i=e[1],s=e[2],c=n[0],u=n[1],l=n[2],f=o*o*c*c,h=i*i*u*u,y=s*s*l*l,d=f+h+y,b=Math.sqrt(1/d),m=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}(At,e,b);if(d<a)return isFinite(b)?m:void 0;const p=r[0],g=r[1],v=r[2],w=kt;w[0]=m[0]*p*2,w[1]=m[1]*g*2,w[2]=m[2]*v*2;let M,T,A,k,_,O,S,x,F,I,C,E=(1-b)*Ot(e)/(.5*Ot(w)),U=0;do{E-=U,A=1/(1+E*p),k=1/(1+E*g),_=1/(1+E*v),O=A*A,S=k*k,x=_*_,F=O*A,I=S*k,C=x*_,M=f*O+h*S+y*x-1,T=f*F*p+h*I*g+y*C*v;U=M/(-2*T)}while(Math.abs(M)>_t);return t[0]=o*A,t[1]=i*k,t[2]=s*_,t}(vt,e,pt,n,.1);let a=v(wt,r,n);a=function(t,e){const n=e[0],r=e[1],a=e[2];let o=n*n+r*r+a*a;o>0&&(o=Math.sqrt(o),t[0]=e[0]/o,t[1]=e[1]/o,t[2]=e[2]/o);return t}(a,a);const o=g(Mt,e,r),i=Math.atan2(a[1],a[0]),s=Math.asin(a[2]),c=(u=m(o,e),(Math.sign?Math.sign(u):0==(u=+u)||isNaN(u)?Number(u):u>0?1:-1)*Ot(o));var u;return t[0]=dt(i),t[1]=dt(s),t[2]=c,t}const At=new Array(3),kt=new Array(3),_t=1e-12;function Ot(t){return l(t)}function St(t,e){let n="";for(let r=0;r<4;r++){const a=t.getUint8(e+r);n+=String.fromCharCode(a)}return n}const xt="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function Ft(t,e,n){const r=new Uint8Array(t,e,n);return xt?JSON.parse(xt.decode(r)):JSON.parse(mt(r))}function It(t,e,n){const r=new Uint8Array(t,e,n);return xt?JSON.parse(xt.decode(r)):JSON.parse(mt(r))}function Ct(t,e,n){return{offset:e,byteLength:n}}function Et(t,e,n,r){const{byteOffset:a,componentType:o,type:i}=t,{ctor:s,type:c}=function(t){return zt[t]}(o||"UNSIGNED_SHORT"),u=function(t){if(!t)return 1;return Nt[t]}(i);return{byteStride:0,byteOffset:a+n,itemSize:u,count:r*u,componentType:c,array:new s(e,n+a,r*u)}}function Ut(t,e,n,r){const a=Et(t,e,n,r);return a.array.buffer.byteLength!==e.byteLength&&(a.array=a.array.slice()),a}const Nt={"SCALAR":1,"VEC2":2,"VEC3":3,"VEC4":4};const zt={"BYTE":{ctor:Int8Array,type:5120,name:"Int8Array"},"UNSIGNED_BYTE":{ctor:Uint8Array,type:5121,name:"Uint8Array"},"SHORT":{ctor:Int16Array,type:5122,name:"Int16Array"},"UNSIGNED_SHORT":{ctor:Uint16Array,type:5123,name:"Uint16Array"},"INT":{ctor:Int32Array,type:5124,name:"Int32Array"},"UNSIGNED_INT":{ctor:Uint32Array,type:5125,name:"Uint32Array"},"FLOAT":{ctor:Float32Array,type:5126,name:"Float32Array"},"DOUBLE":{ctor:Float64Array,type:5126,name:"Float64Array"}};function Lt(t){for(const e in zt)if(t===zt[e].ctor)return zt[e].type;throw new Error("unrecognized ctor:"+t)}function jt(t,e,n,r){const a=t,o=e.length/3;for(let t=0;t<o;t++)a[3*t]=e[3*t]/65535*r[0]+n[0],a[3*t+1]=e[3*t+1]/65535*r[1]+n[1],a[3*t+2]=e[3*t+2]/65535*r[2]+n[2];return a}function Dt(t,e,n){const r=t.getUint32(12,!0),a=t.getUint32(16,!0),o=t.getUint32(20,!0),i=t.getUint32(24,!0),s=t.buffer;let c,u={},l={},f=null;r>0&&(u=Ft(s,e,r),e+=r),a>0&&(c=function(t,e,n){return{offset:e,byteLength:n}}(0,e,a),e+=a),o>0&&(l=It(s,e,o),e+=o);const h=Ct(0,e,i);return f=s.slice(h.offset,h.offset+h.byteLength),n.push(f),{featureTable:u,featureTableBin:c,batchTable:l,batchTableBin:f}}const Pt={5120:Int8Array,5122:Int16Array,5124:Int32Array,5121:Uint8Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function Bt(t){for(const e in Pt)if(t===Pt[e])return+e;throw new Error("unrecognized ctor:"+t)}let qt=null;function Rt(){return qt||(qt={"image/crn":r.crn&&r.crn(),"image/ktx2":r.ktx2&&r.ktx2(),"image/cttf":r.ktx2&&r.ktx2(),"draco":r.draco&&r.draco()}),qt}const{Ajax:Vt,GLTFLoader:Gt}=a();class $t{constructor(t,e,n){this.o=t,this.i=e||Gt,this.u=n,this.h=Rt()}static createEmptyB3DM(){return{featureTable:null,batchTable:null,gltf:{}}}load(t,e,n=0,r=0,a){return e?(r||(r=e.byteLength),this.m(t,e,n,r,a)):Vt.getArrayBuffer(t,{}).then((e=>{const a=e.data;return r||(r=a.byteLength),this.m(t,a,n,r)}))}m(t,e,n,r,a){const o=a&&a.maxTextureSize,i=this.p(e,n,r,t);if(i.error)return Promise.resolve(i);const s=t.substring(0,t.lastIndexOf("/"));let c;try{c=new this.i(s,i.glb,{transferable:!0,requestImage:this.o,decoders:this.h,supportedFormats:this.u,maxTextureSize:o})}catch(t){return Promise.resolve({error:t})}return c.load({skipAttributeTransform:!1}).then((e=>{e.url=\`${kV}t}-${kV}n}-${kV}r}\`;const a=c.transferables;for(let t=0;t<i.transferables.length;t++)a.indexOf(i.transferables[t])<0&&a.push(i.transferables[t]);return{magic:"b3dm",count:i.count,transferables:a,featureTable:i.featureTable,batchTable:i.batchTable,batchTableBin:i.batchTableBin,gltf:e}}))}p(t,e,n,r){const a=new DataView(t,e,n),o=a.getUint32(4,!0);if(1!==o){const t="Unsupported b3dm version: "+o+", url:"+r;return console.warn(t),{error:t}}if(a.getUint32(8,!0)!==a.byteLength){const t="Length in b3dm header is inconsistent with b3dm's byte length, url: "+r;return console.warn(t),{error:t}}let i,s=a.getUint32(12,!0),c=a.getUint32(16,!0),u=a.getUint32(20,!0),l=a.getUint32(24,!0),f=28+e;u>=570425344?(f-=8,i=s,u=c,l=0,s=0,c=0):l>=570425344&&(f-=4,i=u,u=s,l=c,s=0,c=0);const h=[t];let y,d,b;if(s>0?(y=Ft(t,f,s),f+=s,i=y.BATCH_LENGTH):y={"BATCH_LENGTH":i},c>0&&(f+=c),u>0&&(d=It(t,f,u),f+=u,l>0)){const e=Ct(0,f,l);b=t.slice(e.offset,e.offset+e.byteLength),f+=l,h.push(b)}const m=y.BATCH_LENGTH,p={};if(y&&y.BATCH_ID){p.BATCH_ID=Ut(y.BATCH_ID,t,undefined.offset,m);const e=p.BATCH_ID.array&&p.BATCH_ID.array.buffer;e&&h.indexOf(e)<0&&h.push(e)}return{count:i,transferables:h,featureTable:y,batchTable:d,batchTableBin:b,b3dm:p,glb:{buffer:t,byteOffset:f,byteLength:a.byteLength+a.byteOffset-f}}}v(){return null}}const{Ajax:Xt,GLTFLoader:Ht}=a();class Jt{constructor(t,e,n,r){this.o=t,this.i=e||Ht,this.u=n,this.h=Rt(),this.M=r}load(t,e,n=0,r=0,a){return e?(r||(r=e.byteLength),this.m(t,e,n,r,a)):Xt.getArrayBuffer(t,{}).then((e=>{const a=e.data;return r||(r=a.byteLength),this.m(t,a,n,r)}))}m(t,e,n,r,a){return this.T(t,e,n,r,a).then((({gltf:a,transferables:o})=>{const i=this.A(e,n,r,t);if(i.error)return Promise.resolve(i);for(let t=0;t<o.length;t++)-1===i.transferables.indexOf(o[t])&&i.transferables.push(o[t]);return delete a.transferables,Promise.resolve({magic:"i3dm",count:i.count,transferables:i.transferables,featureTable:i.featureTable,batchTable:i.batchTable,batchTableBin:i.batchTableBin,i3dm:i.i3dm,gltf:a})}))}T(t,e,n,r,a){const o=a&&a.maxTextureSize,i={transferable:!0,requestImage:this.o,decoders:this.h,supportedFormats:this.u,maxTextureSize:o},s=new DataView(e,n,r),c=32+s.getUint32(12,!0)+s.getUint32(16,!0)+s.getUint32(20,!0)+s.getUint32(24,!0);if(0===s.getUint32(28,!0)){let r=mt(new Uint8Array(e,c+n,s.byteLength-c));-1==r.indexOf("://")&&(r=t.substring(0,t.lastIndexOf("/"))+"/"+r);return r.indexOf(".glb")>0?Xt.getArrayBuffer(r,{}).then((t=>this.k(r,{buffer:t.data,byteOffset:0},i))):Xt.getJSON(r,{}).then((t=>this.k(r,t,i)))}{const r={buffer:e,byteOffset:c+n,byteLength:s.byteLength-c};return this.k(t,r,i)}}k(t,e,n){const r=t.substring(0,t.lastIndexOf("/")),a=new this.i(r,e,n);return a.load({skipAttributeTransform:!0}).then((n=>{let r=0,o=0;return e.buffer&&(r=e.byteOffset||0,o=e.byteLength||0),n.url=\`${kV}t}-${kV}r}-${kV}o}\`,{transferables:a.transferables,gltf:n}}))}A(t,e,n,r){const a=new DataView(t,e,n),o=a.getUint32(4,!0);if(1!==o){const t="Unsupported pnts version: "+o+", url:"+r;return console.warn(t),{error:t}}if(a.getUint32(8,!0)!==a.byteLength){const t="Length in pnts header is inconsistent with pnts's byte length, url: "+r;return console.warn(t),{error:t}}const i=[t],{featureTable:s,featureTableBin:c,batchTable:u,batchTableBin:l}=Dt(a,32+e,i),f={},h=s.INSTANCES_LENGTH;if(s.POSITION){const{byteOffset:e}=s.POSITION;f.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:new Float32Array(t,e+c.offset,3*h).slice()},i.push(f.POSITION.array.buffer)}else if(s.POSITION_QUANTIZED){const e=s.QUANTIZED_VOLUME_OFFSET,n=s.QUANTIZED_VOLUME_SCALE,{byteOffset:r}=s.POSITION_QUANTIZED;f.POSITION={byteStride:12,byteOffset:0,itemSize:3,count:h,componentType:5126,array:this._(new Uint16Array(t,r+c.offset,3*h),e,n)},i.push(f.POSITION.array.buffer)}if(s.BATCH_ID){f.BATCH_ID=Ut(s.BATCH_ID,t,c.offset,h);const e=f.BATCH_ID.array&&f.BATCH_ID.array.buffer;e&&i.indexOf(e)<0&&i.push(e)}if(s.NORMAL_UP){let{byteOffset:e}=s.NORMAL_UP;f.NORMAL_UP={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:new Float32Array(t,e+c.offset,3*h).slice()},i.push(f.NORMAL_UP.array.buffer),e=s.NORMAL_RIGHT.byteOffset,f.NORMAL_RIGHT={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:new Float32Array(t,e+c.offset,3*h).slice()},i.push(f.NORMAL_RIGHT.array.buffer)}else if(s.NORMAL_UP_OCT32P){let{byteOffset:e}=s.NORMAL_UP_OCT32P;f.NORMAL_UP={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:this.O(new Uint16Array(t,e+c.offset,2*h))},i.push(f.NORMAL_UP.array.buffer),e=s.NORMAL_RIGHT_OCT32P.byteOffset,f.NORMAL_RIGHT={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:this.O(new Uint16Array(t,e+c.offset,2*h))},i.push(f.NORMAL_RIGHT.array.buffer)}if(s.SCALE){const{byteOffset:e}=s.SCALE;f.SCALE={byteStride:0,byteOffset:0,itemSize:1,count:h,componentType:5126,array:new Float32Array(t,e+c.offset,h).slice()},i.push(f.SCALE.array.buffer)}else if(s.SCALE_NON_UNIFORM){const{byteOffset:e}=s.SCALE_NON_UNIFORM;f.SCALE_NON_UNIFORM={byteStride:0,byteOffset:0,itemSize:3,count:h,componentType:5126,array:new Float32Array(t,e+c.offset,3*h).slice()},i.push(f.SCALE_NON_UNIFORM.array.buffer)}return{count:h,batchTable:u,batchTableBin:l,featureTable:s,i3dm:f,transferables:i}}O(t){const e=t.length/2,n=new Float32Array(3*e),r=[];for(let a=0;a<e;a++)Yt(r,t[2*a],t[2*a+1],65535),n[3*a]=r[0],n[3*a+1]=r[1],n[3*a+2]=r[2];return n}_(t,e,n){return jt(new Float32Array(t.length),t,e,n)}v(){return null}}function Yt(t,e,n,r){if(t[0]=Kt(e,r),t[1]=Kt(n,r),t[2]=1-(Math.abs(t[0])+Math.abs(t[1])),t[2]<0){const e=t[0];t[0]=(1-Math.abs(t[1]))*Qt(e),t[1]=(1-Math.abs(e))*Qt(t[1])}return b(t,t)}function Kt(t,e){return function(t,e,n){return t<e?e:t>n?n:t}(t,0,e=function(t,e){if(null!=t)return t;return e}(e,255))/e*2-1}function Qt(t){return t<0?-1:1}const{Ajax:Zt}=a();class Wt{constructor(){}load(t,e,n=0,r=0){return e?(r||(r=e.byteLength),this.m(t,e,n,r)):Zt.getArrayBuffer(t,{}).then((e=>{const a=e.data;return r||(r=a.byteLength),this.m(t,a,n,r)}))}m(t,e,n,r){return this.S(e,n,r,t).then((t=>t.error?t:{magic:"pnts",count:t.count,transferables:t.transferables,featureTable:t.featureTable,batchTable:t.batchTable,batchTableBin:t.batchTableBin,pnts:t.pnts}))}S(t,e,n,r){const a=new DataView(t,e,n),o=a.getUint32(4,!0);if(1!==o){const t="Unsupported pnts version: "+o+", url:"+r;return console.warn(t),{error:t}}if(a.getUint32(8,!0)!==a.byteLength){const t="Length in pnts header is inconsistent with pnts's byte length, url: "+r;return console.warn(t),{error:t}}const i=[t],{featureTable:s,featureTableBin:c,batchTable:u,batchTableBin:l}=Dt(a,e+28,i),f=s.QUANTIZED_VOLUME_OFFSET,h=s.QUANTIZED_VOLUME_SCALE,y=s.POINTS_LENGTH;let d,b={};if(s.extensions&&s.extensions["3DTILES_draco_point_compression"]){b=s.extensions["3DTILES_draco_point_compression"],d=new DataView(t,b.byteOffset+c.offset,b.byteLength);const e={attributes:b.properties,useUniqueIDs:!1};return this.F||(this.F=Rt().draco),this.F(d,e).then((e=>{const n=e.attributes;!s.POSITION&&!s.POSITION_QUANTIZED||n.POSITION||n.POSITION_QUANTIZED||(n.POSITION=s.POSITION,n.POSITION_QUANTIZED=s.POSITION_QUANTIZED),!(s.RGB||s.RGBA||s.RGB565)||n.RGB||n.RGBA||n.RGB565||(n.RGB=s.RGB,n.RGBA=s.RGBA,n.RGB565=s.RGB565),!s.NORMAL&&!s.NORMAL_OCT16P||n.NORMAL||n.NORMAL_OCT16P||(n.NORMAL=s.NORMAL,n.NORMAL_OCT16P=s.NORMAL_OCT16P);const r=this.I(t,e.attributes,c.offset,y,i,f,h);if(e.attributes.BATCH_ID){const t=e.attributes.BATCH_ID.array;r.BATCH_ID={byteStride:0,byteOffset:0,itemSize:1,count:t.length,componentType:Lt(t.constructor),array:t},i.push(t.buffer)}else if(s.BATCH_ID||Object.keys(u).length){s.BATCH_ID?r.BATCH_ID=Ut(s.BATCH_ID,t,c.offset,y):r.BATCH_ID=te(y);const e=r.BATCH_ID.array&&r.BATCH_ID.array.buffer;e&&i.indexOf(e)<0&&i.push(e)}return{count:y,batchTable:u,batchTableBin:l,featureTable:s,pnts:r,transferables:i}}))}const m=this.I(t,s,c.offset,y,i,f,h);if(s.BATCH_ID||Object.keys(u).length){s.BATCH_ID?m.BATCH_ID=Ut(s.BATCH_ID,t,c.offset,y):m.BATCH_ID=te(y);const e=m.BATCH_ID.array&&m.BATCH_ID.array.buffer;e&&i.indexOf(e)<0&&i.push(e)}return Promise.resolve({count:y,batchTable:u,batchTableBin:l,featureTable:s,pnts:m,transferables:i})}I(t,e,n,r,a,o,i){const s={};if(e.POSITION){let{byteOffset:o,array:i}=e.POSITION;o=o||0;const c=i?0:n;if(!i){const e=t.slice(o+c,o+c+3*r*4);i=new Float32Array(e)}s.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:r,componentType:5126,array:i},a.push(i.buffer)}else if(e.POSITION_QUANTIZED){let{byteOffset:c}=e.POSITION_QUANTIZED;const{array:u}=e.POSITION_QUANTIZED;c=c||0;const l=u?0:n;s.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:r,componentType:5126,array:this._(u||new Uint16Array(t,c+l,3*r),o,i)},a.push(s.POSITION.array.buffer)}if(e.RGBA){let{byteOffset:o,array:i}=e.RGBA;o=o||0;const c=i?0:n;if(!i){const e=t.slice(o+c,o+c+4*r);i=new Uint8Array(e)}s.RGBA={byteStride:0,byteOffset:0,itemSize:4,count:r,componentType:5121,array:i},a.push(i.buffer)}else if(e.RGB){let{byteOffset:o,array:i}=e.RGB;o=o||0;const c=i?0:n;if(!i){const e=t.slice(o+c,o+c+3*r);i=new Uint8Array(e)}s.RGB={byteStride:0,byteOffset:0,itemSize:3,count:r,componentType:5121,array:i},a.push(i.buffer)}else if(e.RGB565){let{byteOffset:o,array:i}=e.RGB565;o=o||0;const c=i?0:n;if(!i){const e=t.slice(o+c,o+c+2*r);i=new Uint16Array(e)}s.RGB565={byteStride:0,byteOffset:0,itemSize:1,count:r,componentType:5123,array:i},a.push(i.buffer)}if(e.NORMAL){let{byteOffset:o,array:i}=e.NORMAL;o=o||0;const c=i?0:n;if(!i){const e=t.slice(o+c,o+c+3*r*4);i=new Float32Array(e)}s.NORMAL={byteStride:0,byteOffset:0,itemSize:3,count:r,componentType:5126,array:i},a.push(i.buffer)}else if(e.NORMAL_OCT16P){let{byteOffset:o,array:i}=e.NORMAL_OCT16P;o=o||0;const c=i?0:n;if(!i){const e=t.slice(o+c,o+c+2*r);i=new Uint8Array(e)}s.NORMAL_OCT16P={byteStride:0,byteOffset:0,itemSize:2,count:r,componentType:5121,array:i},a.push(i.buffer)}return s}_(t,e,n){return jt(new Float32Array(t.length),t,e,n)}v(){return null}}function te(t){const e=(n=t)<256?Uint8Array:n<65536?Uint16Array:Uint32Array;var n;const r=new e(t);for(let e=0;e<t;e++)r[e]=e;return{byteStride:0,byteOffset:0,itemSize:1,count:t,componentType:Lt(e),array:r}}const{Ajax:ee,GLTFLoader:ne}=a();class re{constructor(t,e,n,r){this.u=n,this.o=t,this.i=e||ne,this.M=r}load(t,e,n=0,r=0,a){return e?this.m(t,e,n,r,a):ee.getArrayBuffer(t,{}).then((e=>{const a=e.data;return this.m(t,a,n,r)}))}m(t,e,n,r,a){r||(r=e.byteLength);const o=this.C(e,t,n,r),i=[];for(let n=0;n<o.length;n++){let r;if("b3dm"===o[n].magic)r=new $t(this.o,this.i,this.u);else if("i3dm"===o[n].magic)r=new Jt(this.o,this.i,this.u,this.M);else if("pnts"===o[n].magic)r=new Wt;else{if("cmpt"!==o[n].magic){console.warn("Unsupported magic in CMPT tile:",o[n].magic);continue}r=new re(this.o,this.i,this.u,this.M)}i.push(r.load(t,e,o[n].offset,o[n].byteLength,a).then((t=>t)))}return Promise.all(i).then((t=>({magic:"cmpt",tiles:t})))}C(t,e,n,r){const a=new DataView(t,n,r),o=a.getUint32(4,!0);if(1!==o){const t="Unsupported cmpt version: "+o+", url:"+e;return console.warn(t),{error:t}}if(16===a.byteLength)return[];const i=[],s=a.getUint32(12,!0);let c=16;for(let e=0;e<s;e++){const e=St(a,c),r=a.getUint32(c+8,!0);i.push({magic:e,buffer:t,offset:c+n,byteLength:r}),c+=r}return i}}const{GLTFLoader:ae}=a();function oe(t,e){if(t.scenes&&t.scenes.length)for(let n=0,r=t.scenes.length;n<r;n++){const r=t.scenes[n].nodes;for(let n=0,a=r.length;n<a;n++){const a=[];he(r[n],a,t,e)}}}const ie=[],se=[],ce=[],ue=[0,0,0],le=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}([]),fe=[1,1,1];function he(t,e,n,r){const a=e.slice(0);if(t.matrix)a.push(t.matrix);else if(t.rotation||t.translation||t.scale){const e=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}(ie,t.translation||ue),n=function(t,e){var n=e[0],r=e[1],a=e[2],o=e[3],i=n+n,s=r+r,c=a+a,u=n*i,l=r*i,f=r*s,h=a*i,y=a*s,d=a*c,b=o*i,m=o*s,p=o*c;return t[0]=1-f-d,t[1]=l+p,t[2]=h-m,t[3]=0,t[4]=l-p,t[5]=1-u-d,t[6]=y+b,t[7]=0,t[8]=h+m,t[9]=y-b,t[10]=1-u-f,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(se,t.rotation||le),r=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(ce,t.scale||fe);s(r,n,r);const o=s([],e,r);a.push(o)}if(t.children&&t.children.length)for(let e=0,o=t.children.length;e<o;e++)he(t.children[e],a,n,r);if(void 0!==t.mesh){const e=t.mesh,o=n.meshes[e];if(o){const t=a.slice(0),i=o.primitives;for(let a=0,o=i.length;a<o;a++){const o=i[a];o&&(o.matrices=t,r(o,e,a,n))}}}}function ye(t,e){let{byteOffset:n,byteStride:r,count:a}=t;const{componentType:o,itemSize:i}=t,s=t.array.buffer,c=o?ae.getTypedArrayCtor(o):t.array.constructor;if(n=void 0===n?t.array.byteOffset:n,r=r||0,a=a||t.array.length/i,(!r||r===i*c.BYTES_PER_ELEMENT)&&n%c.BYTES_PER_ELEMENT==0){const t=new c(s,n,a*i);for(let r=0;r<a*i;r+=i){e(new c(t.buffer,n+r*c.BYTES_PER_ELEMENT,i),r/i)}return}const u=new Uint8Array(i*c.BYTES_PER_ELEMENT);r||(r=i*c.BYTES_PER_ELEMENT);for(let t=0;t<a;t++){const a=new Uint8Array(s,r*t+n,i*c.BYTES_PER_ELEMENT);u.set(a);e(new c(u.buffer),t),a.set(u)}}var de=ge("DXT1"),be=ge("DXT3"),me=ge("DXT5"),pe=ge("DX10");function ge(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}var ve=A((function(t){var e,n,r=new Int32Array(t,0,31);if(542327876!==r[0])throw new Error("Invalid magic number in DDS header");if(4&!r[20])throw new Error("Unsupported format, must contain a FourCC code");var a=r[21];switch(a){case de:e=8,n="dxt1";break;case be:e=16,n="dxt3";break;case me:e=16,n="dxt5";break;case 116:n="rgba32f";break;case pe:var o=new Uint32Array(t.slice(128,148));n=o[0];var i=o[1];if(o[2],o[3],o[4],3!==i||2!==n)throw new Error("Unsupported DX10 texture format "+n);n="rgba32f";break;default:throw new Error("Unsupported FourCC code: "+(s=a,String.fromCharCode(255&s,s>>8&255,s>>16&255,s>>24&255)))}var s;var c=r[2],u=1;131072&c&&(u=Math.max(1,r[7]));var l=!1;512&r[28]&&(l=!0);var f,h=r[4],y=r[3],d=r[1]+4,b=h,m=y,p=[];a===pe&&(d+=20);if(l)for(var g=0;g<6;g++){if("rgba32f"!==n)throw new Error("Only RGBA32f cubemaps are supported");h=b,y=m;for(var v=Math.log(h)/Math.log(2)+1,w=0;w<v;w++)f=h*y*16,p.push({offset:d,length:f,shape:[h,y]}),w<u&&(d+=f),h=Math.floor(h/2),y=Math.floor(y/2)}else for(w=0;w<u;w++)f=Math.max(4,h)/4*Math.max(4,y)/4*e,p.push({offset:d,length:f,shape:[h,y]}),d+=f,h=Math.floor(h/2),y=Math.floor(y/2);return{shape:[b,m],images:p,format:n,flags:c,cubemap:l}})),we=Math.abs,Me=Math.sin,Te=Math.cos,Ae=Math.tan,ke=Math.atan,_e=Math.atan2,Oe=Math.sqrt,Se=Math.log,xe=Math.hypot,Fe=Math.sinh,Ie=Math.cosh,Ce=1/0;function Ee(t){var e,n,r,a,o,i,s=[],c=[],u=[],l=[];function f(t,e){for(var n,r=2*Te(2*e),a=t.length-1,o=t[a],i=0;--a>=0;)n=r*o-i+t[a],i=o,o=n;return e+n*Me(2*e)}function h(t,e,n){for(var r,a,o=Me(e),i=Te(e),s=Fe(n),c=Ie(n),u=2*i*c,l=-2*o*s,f=t.length-1,h=t[f],y=0,d=0,b=0;--f>=0;)r=d,a=y,h=u*(d=h)-r-l*(y=b)+t[f],b=l*d-a+u*y;return[(u=o*c)*h-(l=i*s)*b,u*b+l*h]}t.es,o=a=(r=t.es/(1+Oe(1-t.es)))/(2-r),s[0]=a*(2+a*(-2/3+a*(a*(116/45+a*(26/45+a*(-2854/675)))-2))),c[0]=a*(a*(2/3+a*(4/3+a*(-82/45+a*(32/45+a*(4642/4725)))))-2),o*=a,s[1]=o*(7/3+a*(a*(-227/45+a*(2704/315+a*(2323/945)))-1.6)),c[1]=o*(5/3+a*(-16/15+a*(-13/9+a*(904/315+a*(-1522/945))))),o*=a,s[2]=o*(56/15+a*(-136/35+a*(-1262/105+a*(73814/2835)))),c[2]=o*(-26/15+a*(34/21+a*(1.6+a*(-12686/2835)))),o*=a,s[3]=o*(4279/630+a*(-332/35+a*(-399572/14175))),c[3]=o*(1237/630+a*(a*(-24832/14175)-2.4)),o*=a,s[4]=o*(4174/315+a*(-144838/6237)),c[4]=o*(-734/315+a*(109598/31185)),o*=a,s[5]=o*(601676/22275),c[5]=o*(444337/155925),o=a*a,e=t.k0/(1+a)*(1+o*(1/4+o*(1/64+o/256))),u[0]=a*(a*(2/3+a*(-37/96+a*(1/360+a*(81/512+a*(-96199/604800)))))-.5),l[0]=a*(.5+a*(-2/3+a*(5/16+a*(41/180+a*(-127/288+a*(7891/37800)))))),u[1]=o*(-1/48+a*(-1/15+a*(437/1440+a*(-46/105+a*(1118711/3870720))))),l[1]=o*(13/48+a*(a*(557/1440+a*(281/630+a*(-1983433/1935360)))-.6)),o*=a,u[2]=o*(-17/480+a*(37/840+a*(209/4480+a*(-5569/90720)))),l[2]=o*(61/240+a*(-103/140+a*(15061/26880+a*(167603/181440)))),o*=a,u[3]=o*(-4397/161280+a*(11/504+a*(830251/7257600))),l[3]=o*(49561/161280+a*(-179/168+a*(6601661/7257600))),o*=a,u[4]=o*(-4583/161280+a*(108847/3991680)),l[4]=o*(34729/80640+a*(-3418889/1995840)),o*=a,u[5]=o*(-20648693/638668800),l[5]=.6650675310896665*o,i=f(c,t.phi0),n=-e*(i+function(t,e){var n,r=2*Te(e),a=t.length-1,o=t[a],i=0;for(;--a>=0;)n=r*o-i+t[a],i=o,o=n;return Me(e)*n}(l,2*i)),t.fwd=function(t,r){var a,o,i,s,u,y=t.phi,d=t.lam;y=f(c,y),a=Me(y),o=Te(y),s=Me(d),i=Te(d),y=_e(a,i*o),d=_e(s*o,xe(a,o*i)),d=function(t){var e=we(t);return e=function(t){var e=1+t,n=e-1;return 0===n?t:t*Se(e)/n}(e*(1+e/(xe(1,e)+1))),t<0?-e:e}(Ae(d)),u=h(l,2*y,2*d),y+=u[0],d+=u[1],we(d)<=2.623395162778?(r.y=e*y+n,r.x=e*d):r.x=r.y=Ce},t.inv=function(t,r){var a,o,i,c,l,y=t.y,d=t.x;y=(y-n)/e,we(d/=e)<=2.623395162778?(y+=(l=h(u,2*y,2*d))[0],d+=l[1],d=ke(Fe(d)),a=Me(y),o=Te(y),c=Me(d),i=Te(d),d=_e(c,i*o),y=_e(a*i,xe(c,i*o)),r.phi=f(s,y),r.lam=d):r.phi=r.lam=Ce}}const Ue=Math.PI/180,Ne=6378137*Math.PI/180,ze=85.0511287798,Le={};function je(t,e,n,r){if("EPSG:3857"===n)return function(t,e){const n=ze,r=e[0],a=Math.max(Math.min(n,e[1]),-n);let o;o=0===a?0:Math.log(Math.tan((90+a)*Ue/2))/Ue;return t[0]=r*Ne,t[1]=o*Ne,t}(t,e);if(!n||"EPSG:9807"!==n.code&&"Traverse_Mercator"!==n.code){if("EPSG:4326"===n||"EPSG:4490"===n||"identity"===n)return De(t,e);if("baidu"===n)return De(t,e);throw new Error("unsupported projection:"+n)}{if(!(!r||4326===r.wkid))return function(t,e){return t[0]=e[0],t[1]=e[1],t}(t,e);const a=JSON.stringify(n);let o=Le[a];return o||(o=Le[a]=function(t){const e={a:Be,es:qe,x0:ht(t.falseEasting)?5e5:t.falseEasting,y0:ht(t.falseNorthing)?0:t.falseNorthing,k0:t.scaleFactor||.9996,lam0:(t.centralMeridian||0)*Pe,phi0:(t.latitudeOfOrigin||0)*Pe,originLam0:t.startLongtitude||0,originPhi0:t.startLatitude||0};Ee(e);const n={lam:0,phi:0},r={};let a=0,o=0;(e.originLam0||e.originPhi0)&&(n.lam=e.originLam0*Pe-e.lam0,n.phi=e.originPhi0*Pe,e.fwd(n,r),a=e.a*r.x+e.x0,o=e.a*r.y+e.y0);return{project:function(t,i){n.lam=t[0]*Pe-e.lam0,n.phi=t[1]*Pe,e.fwd(n,r);const s=e.a*r.x+e.x0-a,c=e.a*r.y+e.y0-o;return i[0]=s,i[1]=c,i}}}(n)),o.project(e,t)}}function De(t,e){return t[0]=e[0],t[1]=e[1],t}const Pe=.017453292519943295,Be=6378137,qe=.0066943799901413165;const{Ajax:Re}=a(),Ve=i([]),Ge=Rt().draco,$e=Rt().ktx2,Xe={"pbrMetallicRoughness":{"baseColorFactor":[.5,.5,.5,1],"metallicFactor":0,"roughnessFactor":.5}},He={"position":{name:"POSITION",accessor:{"componentType":5126,"type":"VEC3"}},"normal":{name:"NORMAL",accessor:{"componentType":5126,"type":"VEC3"}},"uv0":{name:"TEXCOORD_0",accessor:{"componentType":5126,"type":"VEC2"}},"color":{name:"COLOR_0",accessor:{"componentType":5121,"type":"VEC4"}},"uv-region":{name:"uvRegion",accessor:{"componentType":5123,"type":"VEC4"}},"feature-index":{name:"_BATCHID",accessor:{"componentType":5125,"type":"SCALAR"}},"faceRange":{name:"faceRange",accessor:{"componentType":5125,"type":"VEC2"}}};function Je(t,e,n,r,a,o){const s=[],c=[],u=[];for(let e=0;e<t.meshes.length;e++){const{geometry:n,material:r}=t.meshes[e],a=Re.getArrayBuffer(n.url,o);a.xhr.url=n.url,u.push(a.xhr);const i=a.then((t=>({buffer:t})));s.push(i);const l=[];if(nn(r,l),l.length){const t=l.map((t=>{const e=Re.getArrayBuffer(t.url,o);return e.xhr.url=t.url,u.push(e.xhr),e.then((e=>e&&e.status?null:{buffer:e,mimeType:t.mimeType,format:t.format}))}));s.push(...t)}c[e]=l.length}const l=Promise.all(s).then((o=>{for(let t=0;t<o.length;t++)if(!o[t]||!o[t].buffer)return Promise.resolve(null);const s=[];let u=0;for(let t=0;t<c.length;t++){const e=c[t];s.push({geoBuffer:{data:o[u].buffer.data},textureBuffers:o.slice(u+1,e+u+1).map((t=>({data:t.buffer.data,mimeType:t.mimeType,format:t.format})))}),u+=1+e}const l=function(t,e,n,r,a,o){const s={asset:{generator:"i3s",version:"2.0"},extensions:{},scene:0,scenes:[{nodes:[]}],nodes:{},meshes:{},materials:[],skins:[],animations:null,textures:[],transferables:[]},c=[];for(let u=0;u<t.meshes.length;u++){let{material:l}=t.meshes[u];const{geometry:f}=t.meshes[u];let h;const y=e[u].geoBuffer.data;if(!y)continue;h=un(y)?Ke(s,u,f,y,t.transform,t.center,a,o):Ze(s,u,f,y,t.transform,t.center,a,o),c.push(h),s.nodes[u]={mesh:u,nodeIndex:u,matrix:i([])},s.scenes[0].nodes[u]=s.nodes[u],l||(l=Xe);const d=tn(u,s,l,e[u].textureBuffers,n,r);c.push(d)}return Promise.all(c).then((()=>({gltf:s,featureTable:{BATCH_LENGTH:0},transferables:s.transferables})))}(t,s,e,a,n,r);return l}));return l.xhr=u,l}const Ye={"magFilter":9728,"minFilter":9728,"wrapR":33071,"wrapS":33071,"wrapT":33071};function Ke(t,e,n,r,a,o,i,s){const c=n.info.compressedAttributes.attributes.reduce(((t,e,n)=>{const r=He[e];if(!r)return t;return t[r.name||e]=n,t}),{});return Ge(r,{attributes:c,metadatas:{"POSITION":[{name:"i3s-scale_x",type:"double"},{name:"i3s-scale_y",type:"double"}]},useUniqueIDs:!1,skipAttributeTransform:!1}).then((n=>We(n,t,e,a,o,i,s)))}const Qe={position:function(t,e,n){const r=3*t.vertexCount,a=new Float32Array(e,n,r);return t.position={array:a,componentType:5126,itemSize:3,count:r/3,meta:{"i3s-scale_x":1,"i3s-scale_y":1},type:"VEC3"},n+=4*r},normal:function(t,e,n){const r=3*t.vertexCount,a=new Float32Array(e,n,r);return t.normal={array:a,componentType:5126,itemSize:3,count:r/3,type:"VEC3"},n+=4*r},uv0:function(t,e,n){const r=2*t.vertexCount,a=new Float32Array(e,n,r);return t.uv0={array:a,componentType:5126,itemSize:2,count:r/2,type:"VEC2"},n+=4*r},color:function(t,e,n){const r=4*t.vertexCount,a=new Uint8Array(e,n,r);return t.color={array:a,componentType:5121,itemSize:4,count:r/4,type:"VEC4"},n+=r},featureId:function(t,e,n){return n+=8*t.featureCount},id:function(t,e,n){return n+=8*t.featureCount},faceRange:function(t,e,n){const r=2*t.featureCount,a=new Uint32Array(e,n,r);return t.faceRange={array:a,componentType:5125,itemSize:2,count:r/2,type:"VEC2"},n+=4*r},uvRegion:function(t,e,n){const r=4*t.vertexCount,a=new Uint16Array(e,n,r);return t["uv-region"]={array:a,componentType:5123,itemSize:4,count:r/4,type:"VEC4"},n+=2*r},region:function(t,e,n){const r=4*t.vertexCount,a=new Uint16Array(e,n,r);return t["uv-region"]={array:a,componentType:5123,itemSize:4,count:r/4,type:"VEC4"},n+=2*r}};function Ze(t,e,n,r,a,o,i,s){const c={vertexCount:0},u=new DataView(r);try{let t=0;c.vertexCount=u.getUint32(t,1),t+=4,c.featureCount=u.getUint32(t,1),t+=4;const e=n.info.ordering?null:n.info;if(e){const n=[];for(const t in e)"offset"!==t&&""!==t&&n.push(t);for(let e=0;e<n.length;e++)Qe[n[e]]?t=Qe[n[e]](c,r,t):console.error("Unknown decoder for",n[e])}else{const e=n.info;let a=e.ordering,o=e.featureAttributeOrder;const i=null;i&&i.geometryData&&i.geometryData[0]&&i.geometryData[0].params;for(let e=0;e<a.length;e++){const n=Qe[a[e]];n||console.log(a[e]),t=n(c,r,t)}for(let e=0;e<o.length;e++){const n=Qe[o[e]];n||console.log(o[e]),t=n(c,r,t)}}}catch(t){}c.scale_x=1,c.scale_y=1;const l={};for(const t in c){const e=He[t]&&He[t].name;e&&(l[e]=c[t])}if(c.faceRange){const t=c.faceRange.array,e=t.length/2,n=(f=e)<=255?Uint8Array:f<=65535?Uint16Array:Uint32Array,r=new n(l.POSITION.array.length/3);for(let e=0;e<t.length-1;e+=2){const n=e/2,a=t[e],o=t[e+1];for(let t=a;t<=o;t++)r[3*t]=n,r[3*t+1]=n,r[3*t+2]=n}l._BATCHID={componentType:Bt(n),array:r,itemSize:1,count:r.length,type:"SCALAR"}}var f;return We({attributes:l},t,e,a,o,i,s)}function We(t,e,n,r,a,o,i){const s={attributes:t.attributes,material:n,indices:t.indices,mode:4};!function(t){const e=t.array,n=t.meta&&t.meta["i3s-scale_x"],r=t.meta&&t.meta["i3s-scale_y"];if(n&&r&&(1!==n||1!==r))for(let t=0;t<e.length;t+=3)e[t]*=n.value,e[t+1]*=r.value}(t.attributes.POSITION);const u=function(t,e,n,r,a){let o,i=[0,0,0,1];const s=[0,0],u=je([],n,r,a);u[2]=n[2];const l=e&&c(Ve,e);return ye(t,(t=>(i[0]=t[0],i[1]=t[1],i[2]=t[2],l||(i=p(i,i,e)),n&&d(i,i,n),je(s,i,r,a),o=i[2],t[0]=s[0]-u[0],t[1]=s[1]-u[1],t[2]=o-u[2],t))),u}(t.attributes.POSITION,r,a,o,i);e.meshes[n]={primitives:[s],index:n},e.extensions.MAPTALKS_RTC={projCenter:u},e.extensions.CESIUM_RTC={rtcCoord:a};for(const n in t.attributes)cn(e.transferables,t.attributes[n].array.buffer);return t.indices&&cn(e.transferables,t.indices.array.buffer),s}function tn(t,e,n,r,a,o){const i=r.map((t=>function(t,e,n,r,a){if("dds"===e){const e=ve(t),r=e.images.map((e=>new Uint8Array(t,e.offset,e.length))),a="dxt1"===e.format?33777:33779;return Promise.resolve({image:{mipmap:r,width:e.shape[0],height:e.shape[1],mimeType:n},sampler:Ye,format:a})}if("png"===e||"jpg"===e)return function(t,e){rn||(rn=new OffscreenCanvas(2,2),an=rn.getContext("2d",{willReadFrequently:!0}));const n=new Blob([new Uint8Array(t)]);return createImageBitmap(n).then((t=>{let{width:n,height:r}=t;on(n)||(n=sn(n)),on(r)||(r=sn(r));const a=e;a&&(n=Math.min(a,n),r=Math.min(a,r)),rn.width=n,rn.height=r,an.drawImage(t,0,0,n,r),t.close();const o=an.getImageData(0,0,n,r);return{width:n,height:r,array:new Uint8Array(o.data)}})).catch((()=>({width:2,height:2,array:new Uint8Array(4)})))}(t,a).then((t=>{t.mimeType=n;return{image:t,sampler:Ye,format:6408}}));if("ktx2"===e)return $e(t,r).then((t=>(t.mimeType=n,{image:t,sampler:Ye,format:t.format})));return null}(t.data,t.format,t.mimeType,a,o).then((t=>{if(t.image)if(t.image.array)cn(e.transferables,t.image.array.buffer);else if(t.image.mipmap)for(let n=0;n<t.image.mipmap.length;n++)cn(e.transferables,t.image.mipmap[n].buffer);return t}))));return Promise.all(i).then((r=>{en(t,e,n,r)}))}function en(t,e,n,r){const a=JSON.parse(JSON.stringify(n)),o=e.textures;r.ptr||(r.ptr=0);for(const t in n)n[t]&&n[t].url?(o.push(r[r.ptr++]),a[t]={index:o.length-1},void 0!==n[t].factor&&(a[t].scale=n[t].factor)):yt(n[t])&&(a[t]=en(-1,e,n[t],r));return t>=0&&(e.materials[t]=a),a}function nn(t,e){for(const n in t)t[n]&&t[n].url?e.push({url:t[n].url,mimeType:t[n].mimeType,format:t[n].format}):yt(t[n])&&nn(t[n],e)}let rn,an;function on(t){return!(t&t-1)&&0!==t}function sn(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}function cn(t,e){e&&(t.indexOf(e)>=0||t.push(e))}function un(t){const e=new Uint8Array(t,0,5);return e[0]==="D".charCodeAt()&&e[1]==="R".charCodeAt()&&e[2]==="A".charCodeAt()&&e[3]==="C".charCodeAt()&&e[4]==="O".charCodeAt()}var ln="undefined"!=typeof Float32Array?Float32Array:Array;function fn(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}var hn=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t};!function(){var t=function(){var t=new ln(3);return ln!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}()}();const yn=[];const dn=[],bn=[],mn=[],pn=[],gn=[],vn=[],wn=[];function Mn(t,e,n,r,a,o){fn(pn,t[3*e],t[3*e+1],t[3*e+2]),fn(gn,t[3*n],t[3*n+1],t[3*n+2]),fn(vn,t[3*r],t[3*r+1],t[3*r+2]);const i=hn(dn,vn,gn),s=hn(bn,pn,gn),c=function(t,e,n){var r=e[0],a=e[1],o=e[2],i=n[0],s=n[1],c=n[2];return t[0]=a*c-o*s,t[1]=o*i-r*c,t[2]=r*s-a*i,t}(mn,i,s);!function(t,e){var n=e[0],r=e[1],a=e[2],o=n*n+r*r+a*a;o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o)}(wn,c),a[3*e]=a[3*e]||0,a[3*n]=a[3*n]||0,a[3*r]=a[3*r]||0,a[3*e+1]=a[3*e+1]||0,a[3*n+1]=a[3*n+1]||0,a[3*r+1]=a[3*r+1]||0,a[3*e+2]=a[3*e+2]||0,a[3*n+2]=a[3*n+2]||0,a[3*r+2]=a[3*r+2]||0,a[3*e]+=wn[0],a[3*n]+=wn[0],a[3*r]+=wn[0],a[3*e+1]+=wn[1],a[3*n+1]+=wn[1],a[3*r+1]+=wn[1],a[3*e+2]+=wn[2],a[3*n+2]+=wn[2],a[3*r+2]+=wn[2],o[e]+=1,o[n]+=1,o[r]+=1}const{Ajax:Tn,GLTFLoader:An}=a(),kn=[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1],_n=[0,0,1,0,0,1,0,0,-1,0,0,0,0,0,0,1],On=2*Math.PI*6378137/360,Sn="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;let xn,Fn,In=!1;if("undefined"!=typeof OffscreenCanvas){try{Fn=new OffscreenCanvas(2,2).getContext("2d",{willReadFrequently:!0})}catch(t){}Fn&&"undefined"!=typeof createImageBitmap&&(In=!0)}const Cn=i([]),En=[0,0,0],Un=[],Nn=[],zn=[],Ln=[],jn={"POSITION":1,"TEXCOORD_0":1,"TEXCOORD_1":1,"NORMAL":1,"TANGENT":1},Dn={"TEXCOORD_0":1e-4,"TEXCOORD_1":1e-4};let Pn;class Bn{constructor(t,e,n,r){this.id=t,this.options=e,this.U=(...t)=>this.requestImage.call(this,...t),this.N=n,this.L={},r(null,{},[])}j(t){this.D||(this.u=t,this.P=new Wt,this.D=new $t(this.U,An,t),this.B=new Jt(this.U,An,t))}requestImage(t,e){In?fetch(t).then((t=>t.arrayBuffer())).then((t=>{const e=new self.Blob([new Uint8Array(t)]);return createImageBitmap(e)})).then((t=>{xn.width=t.width,xn.height=t.height,Fn.drawImage(t,0,0);const n=Fn.getImageData(0,0,xn.width,xn.height);t.close(),e(null,{width:t.width,height:t.height,data:new Uint8Array(n.data)})})):this.N("requestImage",{url:t},null,e)}loadTile(t,e){this.j(t.supportedFormats);const{service:n,url:r,arraybuffer:a}=t,o=n.fetchOptions||{};if(o.referrer=t.referrer,o.referrerPolicy=o.referrerPolicy||"origin",function(t){return t.indexOf("i3s:")>=0}(r)){const a=t.i3sInfo,i=n.maxTextureSize||0,s=Je(a,t.supportedFormats,this.options.projection,t.projection,i,o);return s.then((t=>{if(delete this.L[r],!t)return void e({status:404,url:r,i3sInfo:a});if(!Object.keys(t.gltf.meshes).length)return void e({status:404,url:r,i3sInfo:a});t.gltf.url=r;const{transferables:o}=t;t.magic="b3dm",n.createNormalIfMissed&&this.q(t.gltf),Yn(n)&&this.R(t.gltf),e(null,t,o)})),void(this.L[r]=s.xhr)}if(a){delete this.L[r];const n=St(new DataView(a),0);if("{"===n[0]||" "===n[0]||"<"===n[0]){const n=function(t,e,n){if(Sn){const r=new Uint8Array(t,e,n);return Sn.decode(r)}return mt(new Uint8Array(t,e,n))}(a,0,a.byteLength),o=JSON.parse(n);o.accessors?this.V(o,r,t,"gltf",e):this.G(t.rootIdx,o,a,r,e)}else this.V(a,r,t,n,e)}else{let a=n.urlParams;a&&(a=(r.indexOf("?")>0?"&":"?")+a);const i=r.replace(/\\+/g,"%2B");let s=Tn.getArrayBuffer(i+(a||""),o);const c=s.xhr;s=s.then((n=>{delete this.L[r],n&&n.status?e(n):(t.arraybuffer=n&&n.data,this.loadTile(t,e))})).catch((t=>{delete this.L[r],e(t)})),this.L[r]=c}}V(t,e,n,r,a){r=r&&r.toLowerCase();const{service:o}=n;if("b3dm"===r){this.D.load(e,t,0,0,{maxTextureSize:o.maxTextureSize||0}).then((t=>{if(t.error)return void a(t);const{content:e,transferables:r}=this.$(t,n);o.createNormalIfMissed&&this.q(e.gltf),Yn(o)&&this.R(e.gltf),a(null,e,r)})).catch((t=>{a(t)}))}else if("pnts"===r){const r=n.transform||Cn;this.P.load(e,t).then((t=>{const{content:e,transferables:o}=this.X(t,r,n.rootIdx);this.H(e),a(null,e,o)}))}else if("i3dm"===r){const r=n.transform||Cn;this.B.load(e,t,0,0,{maxTextureSize:o.maxTextureSize||0}).then((t=>{const{content:e,transferables:i}=this.J(t,r,n.rootIdx);o.createNormalIfMissed&&this.q(e.gltf),Yn(o)&&this.R(e.gltf),a(null,e,i)}))}else if("cmpt"===r){new re(this.U,An,this.u,o.maxTextureSize||0).load(e,t,0,0,{maxTextureSize:o.maxTextureSize||0}).then((t=>{const{content:e,transferables:r}=this.Y(t,n);this.K(e,o),Yn(o)&&this.Z(e),a(null,e,r)})).catch((t=>{a(t)}))}else if("gltf"===r){this.h||(this.h=Rt());const r=e.substring(0,e.lastIndexOf("/")),i=t instanceof ArrayBuffer&&{buffer:t,byteOffset:0,byteLength:t.byteLength}||t;let s;try{s=new An(r,i,{transferable:!0,requestImage:this.U,decoders:this.h,supportedFormats:this.u,maxTextureSize:o.maxTextureSize||0})}catch(t){a(t)}s.load({skipAttributeTransform:!1}).then((t=>{t.url=e,this.W(t,null,n),o.createNormalIfMissed&&this.q(t),Yn(o)&&this.R(t),a(null,{magic:"gltf",gltf:t},s.transferables)}))}else a(new Error("unsupported tile format: "+r))}K(t,e){t.content?t.content.forEach((t=>{this.K(t,e)})):e.createNormalIfMissed&&this.q(t.gltf)}Z(t){t.content?t.content.forEach((t=>{this.Z(t)})):this.R(t.gltf)}tt(t,e){if(this.et(t,e)&&!t.attributes.NORMAL){const e=t.attributes.POSITION.array,n=e.length,r=this.nt()?Pn.subarray(0,n):e,a=function(t,e,n){const r=n||[];r.setLength&&r.setLength(t.length);const a=yn;a.length<t.length/3&&(a.length=t.length/3),a.fill(0,0,t.length/3);const o=void 0===e.length?e:e.length;for(let n=0;n<o/3;n++)void 0===e.length?Mn(t,3*n,3*n+1,3*n+2,r,a):Mn(t,e[3*n],e[3*n+1],e[3*n+2],r,a);for(let t=0;t<r.length;t+=3){const e=a[t/3];0!==e?(r[t]/=e,r[t+1]/=e,r[t+2]/=e):(r[t]=0,r[t+1]=0,r[t+2]=0)}return r}(r,t.indices.array,new Float32Array(r.length));t.attributes.NORMAL={array:a,byteLength:a.byteLength,byteOffset:0,byteStride:0,componentType:5126,count:a.length/3,itemSize:3,name:"NORMAL",type:"VEC3"}}}R(t){if(!t||!t.meshes||t.extensionsUsed&&t.extensionsUsed.indexOf("KHR_techniques_webgl")>-1)return;if(t.asset&&t.asset.sharePosition)return;const e=t.meshes;for(const t in e){e[t].primitives.forEach((t=>{t.compressed_int16_params={};const e=t.attributes;for(const n in e)if(jn[n]&&e[n].array&&e[n].array instanceof Float32Array){let r=1;this.nt()&&"POSITION"===n&&(r=On,t.compressed_int16_params.compressed_ratio=r);const a=Xn(e[n].array,r,e[n].min,e[n].max,n);if(!a)continue;const{array:o,range:i}=a;e[n].componentType=5124,e[n].array=o,t.compressed_int16_params[n]=i}}))}}q(t){if(!t||!t.meshes||t.extensionsUsed&&t.extensionsUsed.indexOf("KHR_techniques_webgl")>-1)return;if(t.asset&&t.asset.sharePosition)return;const e=t.meshes;for(const n in e){e[n].primitives.forEach((e=>{this.tt(e,t)}))}}H(t){if(!t||!t.pnts)return;const e=t.pnts;t.compressed_int16_params={};for(const n in e)if(jn[n]&&e[n].array&&e[n].array instanceof Float32Array){let r=1;this.nt()&&"POSITION"===n&&(r=On,t.compressed_int16_params.compressed_ratio=r);const{array:a,range:o}=Xn(e[n].array,r,e[n].min,e[n].max,n);e[n].array=a,t.compressed_int16_params[n]=o}}rt(t){const e=[];for(let n=0;n<t.length;n++){const r=t[n];if(!r.childTile)continue;const a={boundingVolume:{sphere:[r.boundingSphere.center.x,r.boundingSphere.center.y,r.boundingSphere.center.z,r.boundingSphere.radius]},content:{uri:r.childTile},geometricError:r.boundingSphere.radius/r.rangeList*16,refine:"REPLACE"};e.push(a)}return e}G(t,e,n,r,a){return e.capabilities,void a(null,e)}Y(t,e){const{tiles:n}=t,r={magic:"cmpt",content:[]},a=[];for(let t=0;t<n.length;t++){const{magic:o}=n[t];if("b3dm"===o){const{content:o,transferables:i}=this.$(n[t],e);Gn(a,i),r.content.push(o)}else if("i3dm"===o){const{transform:o,rootIdx:i}=e,{content:s,transferables:c}=this.J(n[t],o,i);Gn(a,c),r.content.push(s)}else if("pnts"===o){const{transform:o,rootIdx:i}=e,{content:s,transferables:c}=this.X(n[t],o,i);Gn(a,c),r.content.push(s)}else if("cmpt"===o){const{content:o,transferables:i}=this.Y(n[t],e);Gn(a,i),r.content.push(o)}}return{content:r,transferables:a}}$(t,e){const{gltf:n,transferables:r,featureTable:a}=t;return this.W(n,a,e),delete t.transferables,{content:t,transferables:r}}W(t,e,n){const r=function(t){if(!t||!t.meshes)return!1;if(t.extensions&&t.extensions.KHR_techniques_webgl)return!0;const e="visited";let n=1;const r=[];for(const a in t.meshes){const o=t.meshes[a],{primitives:i}=o;if(i)for(let t=0;t<i.length;t++){const a=i[t].attributes&&i[t].attributes.POSITION;if(!a||!a.array)continue;a.array.buffer[e]||(a.array.buffer[e]=n++);const o=n-1+"-"+(a.byteOffset||0);if(r.indexOf(o)>=0)return!0;r.push(o)}}return!1}(t);this.ot(t);n.service.createNormalIfMissed||this.it(t),t.asset||(t.asset={}),r?(t.asset.sharePosition=!0,this.st(t,e,n.upAxis,n.transform)):this.ct(t,e,n.upAxis,n.transform)}J(t,e,n){const{featureTable:r}=t,a=t.i3dm,o=r&&r.RTC_CENTER||[0,0,0],i=this.options.projection,s=e&&c(Cn,e),u={xmin:1/0,xmax:-1/0,ymin:1/0,ymax:-1/0,hmin:1/0,hmax:-1/0};Rn(a.POSITION.array,3,o,Cn,u);const l=Vn(u);e&&!s&&p(l,l,e);const f=this.ut(l),d=[];je(d,f,i),d[2]=f[2];const b=h([],l),m=[0,0,0],g=[0,0,0],v=[0,0],M=[1/0,1/0,1/0],T=[-1/0,-1/0,-1/0];ye(a.POSITION,(t=>{m[0]=t[0]+o[0],m[1]=t[1]+o[1],m[2]=t[2]+o[2],e&&!s&&p(m,m,e),0===w(m)?y(g,0,0,-6378137):Tt(g,m),je(v,g,i),t[0]=v[0]-d[0],t[1]=v[1]-d[1],t[2]=g[2]-d[2],t[0]<M[0]&&(M[0]=t[0]),t[1]<M[1]&&(M[1]=t[1]),t[2]<M[2]&&(M[2]=t[2]),t[0]>T[0]&&(T[0]=t[0]),t[1]>T[1]&&(T[1]=t[1]),t[2]>T[2]&&(T[2]=t[2])})),a.POSITION.min=M,a.POSITION.max=T,e&&p(l,l,e),t.rtcCenter=b,t.rtcCoord=f,t.projCenter=d,t.rootIdx=n;const A=t.transferables;return delete t.transferables,{content:t,transferables:A}}X(t,e,n){const{featureTable:r}=t,a=t.pnts,o=r&&r.RTC_CENTER||[0,0,0],i=this.options.projection,s=e&&c(Cn,e),u={xmin:1/0,xmax:-1/0,ymin:1/0,ymax:-1/0,hmin:1/0,hmax:-1/0};Rn(a.POSITION.array,3,o,e,u);const l=Vn(u),f=this.lt(l),d=h([],l),b=[1/0,1/0,1/0],m=[-1/0,-1/0,-1/0];let g=[0,0,0,1];const v=[0,0,0],M=[0,0];ye(a.POSITION,(t=>(g[0]=t[0]+o[0],g[1]=t[1]+o[1],g[2]=t[2]+o[2],e&&!s&&(g=p(g,g,e)),0===w(g)?y(v,0,0,-6378137):Tt(v,g),je(M,v,i),t[0]=M[0]-f[0],t[1]=M[1]-f[1],t[2]=v[2]-f[2],t[0]<b[0]&&(b[0]=t[0]),t[1]<b[1]&&(b[1]=t[1]),t[2]<b[2]&&(b[2]=t[2]),t[0]>m[0]&&(m[0]=t[0]),t[1]>m[1]&&(m[1]=t[1]),t[2]>m[2]&&(m[2]=t[2]),t))),a.POSITION.min=b,a.POSITION.max=m,e&&p(l,l,e);const T=this.ut(l);t.rtcCenter=d,t.projCenter=f,t.rtcCoord=T,t.rootIdx=n;const A=t.transferables;return delete t.transferables,{content:t,transferables:A}}ot(t){if(!Array.isArray(t.textures))return;const e=t.textures;for(let t=0;t<e.length;t++){const n=e[t]&&e[t].image&&e[t].image.array;if(n&&n.length){const r=n[0],a=n[1],o=n[2],i=n[3];let s=!0;for(let t=4;t<n.length;t+=4)if(n[t]!==r||n[t+1]!==a||n[t+2]!==o||n[t+3]!==i){s=!1;break}s&&(e[t].image.color=[r/255,a/255,o/255,i/255],delete e[t].image.array)}}}it(t){const e=t.meshes;for(const n in e){const r=e[n];if(!r)continue;const a=r.primitives;if(a)for(let e=0;e<a.length;e++){if(!a[e])continue;if(!a[e].attributes||a[e].attributes.NORMAL)continue;const n=a[e].material;if(!ht(n)){const e=t.materials[n];if(!e)continue;e.extensions||(e.extensions={}),e.extensions.KHR_materials_unlit={}}}}}abortTileLoading(t,e){const n=this.L[t.url];if(Array.isArray(n))for(let t=0;t<n.length;t++)n[t].abort();else n&&n.abort&&n.abort();delete this.L[t.url],e(null)}ft(t,e,n,r){const a=e&&e.RTC_CENTER||t.extensions&&t.extensions.CESIUM_RTC&&t.extensions.CESIUM_RTC.center;let o=kn;"X"===(n=n&&n.toUpperCase())?o=_n:"Z"===n&&(o=Cn),t.extensions=t.extensions||{},t.extensions.CESIUM_RTC||(t.extensions.CESIUM_RTC={}),a&&(t.extensions.CESIUM_RTC.center=a),t.extensions.MAPTALKS_RTC={};const c={xmin:1/0,xmax:-1/0,ymin:1/0,ymax:-1/0,hmin:1/0,hmax:-1/0};oe(t,(t=>{if(!(t.attributes&&t.attributes.POSITION))return;const e=i(Un);t.matrices&&$n(e,t.matrices);const n=t.attributes.POSITION.array,u=t.attributes.POSITION.itemSize;s(e,o,e),r&&s(e,r,e),Rn(n,u,a||En,e,c,t.compressUniforms)}));const u=Vn(c);return{rtcCenter:a,modelCenter:u,upAxisTransform:o}}st(t,e,n,r){const{modelCenter:a,upAxisTransform:o,rtcCenter:c}=this.ft(t,e,n),u=this.lt(a);t.extensions.MAPTALKS_RTC.projCenter=u,t.extensions.MAPTALKS_RTC.rtcCoord=t.extensions.CESIUM_RTC.rtcCoord=this.ut(a);const l=h([],a);r&&p(a,a,r),t.extensions.CESIUM_RTC.rtcCoord=this.ut(a),c||(oe(t,(t=>{if(t.attributes&&t.attributes.POSITION){const e=t.attributes.POSITION;if(e.array.buffer.projected&&e.array.buffer.projected[e.byteOffset])return;const n=i(Un);t.matrices&&$n(n,t.matrices),s(n,o,n);const r=function(t,e){var n=e[0],r=e[1],a=e[2],o=e[3],i=e[4],s=e[5],c=e[6],u=e[7],l=e[8],f=e[9],h=e[10],y=e[11],d=e[12],b=e[13],m=e[14],p=e[15],g=n*s-r*i,v=n*c-a*i,w=n*u-o*i,M=r*c-a*s,T=r*u-o*s,A=a*u-o*c,k=l*b-f*d,_=l*m-h*d,O=l*p-y*d,S=f*m-h*b,x=f*p-y*b,F=h*p-y*m,I=g*F-v*x+w*S+M*O-T*_+A*k;return I?(I=1/I,t[0]=(s*F-c*x+u*S)*I,t[1]=(a*x-r*F-o*S)*I,t[2]=(b*A-m*T+p*M)*I,t[3]=(h*T-f*A-y*M)*I,t[4]=(c*O-i*F-u*_)*I,t[5]=(n*F-a*O+o*_)*I,t[6]=(m*w-d*A-p*v)*I,t[7]=(l*A-h*w+y*v)*I,t[8]=(i*x-s*O+u*k)*I,t[9]=(r*O-n*x-o*k)*I,t[10]=(d*T-b*w+p*g)*I,t[11]=(f*w-l*T-y*g)*I,t[12]=(s*_-i*S-c*k)*I,t[13]=(n*S-r*_+a*k)*I,t[14]=(b*v-d*M-m*g)*I,t[15]=(l*M-f*v+h*g)*I,t):null}(Nn,n),a=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0];ye(e,(t=>{p(t,t,n),t[0]=t[0]-l[0],t[1]=t[1]-l[1],t[2]=t[2]-l[2],p(t,t,r),t[0]<a[0]&&(a[0]=t[0]),t[1]<a[1]&&(a[1]=t[1]),t[2]<a[2]&&(a[2]=t[2]),t[0]>c[0]&&(c[0]=t[0]),t[1]>c[1]&&(c[1]=t[1]),t[2]>c[2]&&(c[2]=t[2])})),e.min=a,e.max=c,e.array.buffer.projected||(e.array.buffer.projected={}),e.array.buffer.projected[e.byteOffset]=1}})),t.extensions.CESIUM_RTC.center=l)}ct(t,e,n,r){const{modelCenter:a,rtcCenter:o}=this.ft(t,e,n,r),i=this.lt(a);t.extensions.MAPTALKS_RTC.projCenter=i,t.extensions.MAPTALKS_RTC.rtcCoord=t.extensions.CESIUM_RTC.rtcCoord=this.ut(a),oe(t,(e=>{if(e.attributes&&e.attributes.POSITION){const a=this.et(e,t);if(a){const t=e.attributes.POSITION.array.length;(!Pn||Pn.length<t)&&(Pn=new Float32Array(t))}e.attributes.NORMAL&&this.ht(e.attributes.NORMAL,e.matrices,n),e.attributes.TANGENT&&this.ht(e.attributes.TANGENT,e.matrices,n);const{newPositions:i}=this.yt(e.attributes.POSITION,e.matrices,o,t.extensions.MAPTALKS_RTC,n,r,e.compressUniforms,a),{componentType:s}=e.attributes.POSITION;5126!==s&&(e.attributes.POSITION.array=new Float32Array(i))}}));for(const e in t.nodes){t.nodes[e].matrix=Cn}}lt(t){const e=this.options.projection;"identity"===e?h(zn,t):0===w(t)?y(zn,0,0,-6378137):Tt(zn,t),je(Ln,zn,e);const n=zn[2],r=[];return r[0]=Ln[0],r[1]=Ln[1],r[2]=n,r}ht(t,e,n){let r;r="Y"===n?kn:"X"===n?_n:Cn;const a=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}([],r);if($n(a,e),c(a,Cn))return;const o=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t}([],a),i=[];ye(t,(t=>(function(t,e,n){var r=e[0],a=e[1],o=e[2];t[0]=r*n[0]+a*n[3]+o*n[6],t[1]=r*n[1]+a*n[4]+o*n[7],t[2]=r*n[2]+a*n[5]+o*n[8]}(i,t,o),b(i,i),h(t,i),i)))}yt(t,e,n,r,a,o,s,u){if(t.array.buffer.projected&&t.array.buffer.projected[t.byteOffset])return null;const l=i([]);$n(l,e);const f=this.options.projection;a=a&&a.toUpperCase();const h=n;let b=null;"Y"===a?b=kn:"X"===a&&(b=_n);let m=[0,0,0,1];const g=[0,0,0],v=[0,0],M=r.projCenter,T=je([],r.rtcCoord,"EPSG:3857"),A=o&&c(Cn,o),k=t.min=t.min||[],_=t.max=t.max||[];y(k,1/0,1/0,1/0),y(_,-1/0,-1/0,-1/0);const O=s||{},{decode_position_min:S,decode_position_normConstant:x}=O;let F=[0,0,0,0],I=1;S&&(F=S),x&&(I=x);const C=[];return ye(t,((e,n)=>{if(m[0]=e[0]*I+F[0],m[1]=e[1]*I+F[1],m[2]=e[2]*I+F[2],m=p(m,m,l),b&&(m=p(m,m,b)),h&&d(m,m,h),o&&!A&&(m=p(m,m,o)),0===w(m)?y(g,0,0,-6378137):Tt(g,m),u){const t=Pn;je(v,g,f),t[3*n]=v[0]-T[0],t[3*n+1]=v[0]-T[1],t[3*n+2]=v[0]-T[2]}if(je(v,g,f),e instanceof Float32Array)e[0]=v[0]-M[0],e[1]=v[1]-M[1],e[2]=g[2]-M[2];else{const n=v[0]-M[0],r=v[1]-M[1],a=g[2]-M[2];5126!==t.componentType&&(C.push(n),C.push(r),C.push(a),C.push(e[3]))}return e[0]<k[0]&&(k[0]=e[0]),e[1]<k[1]&&(k[1]=e[1]),e[2]<k[2]&&(k[2]=e[2]),e[0]>_[0]&&(_[0]=e[0]),e[1]>_[1]&&(_[1]=e[1]),e[2]>_[2]&&(_[2]=e[2]),e})),t.array.buffer.projected||(t.array.buffer.projected={}),t.array.buffer.projected[t.byteOffset]=1,{projCenter:M,newPositions:C}}ut(t){return 0===w(t)?y([],0,0,-6378137):Tt([],t)}onRemove(){}nt(){return"EPSG:4326"===this.options.projection||"EPSG:4490"===this.options.projection}et(t,e){if(!t.attributes.POSITION||function(t,e){const n=e.materials[t.material],r=n&&n.extensions&&n.extensions.KHR_materials_unlit;return r}(t,e))return!1;return!t.attributes.TANGENT}}const qn=[];function Rn(t,e,n,r,a,o){const i=o||{},{decode_position_min:s,decode_position_normConstant:c}=i;let u=[0,0,0,0],l=1;s&&(u=s),c&&(l=c);for(let o=0,i=t.length;o<i;o+=e){const{xmin:i,ymin:s,xmax:c,ymax:f,hmin:h,hmax:b}=a;y(qn,t[o]*l+u[0],t[o+1]*l+u[1],t[o+2]*l+u[2]),p(qn,qn,r);const m=d(qn,n,qn);m[0]<i&&(a.xmin=m[0]),m[0]>c&&(a.xmax=m[0]),m[1]<s&&(a.ymin=m[1]),m[1]>f&&(a.ymax=m[1]),e>2&&(m[2]<h&&(a.hmin=m[2]),m[2]>b&&(a.hmax=m[2]))}}function Vn(t){const{xmax:e,ymax:n,xmin:r,ymin:a,hmin:o,hmax:i}=t,s=[(r+e)/2,(a+n)/2,(o+i)/2];return e===-1/0&&(s[0]=0),n===-1/0&&(s[1]=0),i===-1/0&&(s[2]=0),isNaN(s[2])&&(s[2]=0),s}function Gn(t,e){for(let n=0;n<e.length;n++)t.indexOf(e[n])<0&&t.push(e[n])}function $n(t,e){const n=t;for(let t=e.length-1;t>=0;t--)s(n,e[t],n);return n}function Xn(t,e,n,r,a){if(e&&e>1)for(let n=0;n<t.length;n++)(n+1)%3!=0&&(t[n]*=e);let o,i;if(n&&r&&1===e)o=Math.min(...n),i=Math.max(...r);else{const{min:e,max:n}=function(t){let e=1/0,n=-1/0;for(let r=0;r<t.length;r++)t[r]>n&&(n=t[r]),t[r]<e&&(e=t[r]);return{min:e,max:n}}(t);o=e,i=n}return!function(t,e,n,r){for(let a=0;a<t.length;a++){const o=Hn(Jn(t[a],e,n),e,n);if(Math.abs(o-t[a])>Dn[r])return!1}return!0}(t,o,i,a)&&Dn[a]?null:function(t,e,n){const r=new Int16Array(t.length);for(let a=0;a<t.length;a++)r[a]=Jn(t[a],e,n);return{array:r,range:[e,n]}}(t,o,i)}function Hn(t,e,n){return((t>=32768?-(65536-t)/32768:t/32767)+1)*(n-e)/2+e}function Jn(t,e,n){const r=2*(t-e)/(n-e)-1,a=Math.max(-1,Math.min(1,r));return a<0?32768*a:32767*a}function Yn(t){return void 0===t.compressGeometry||t.compressGeometry}let Kn=0;class Qn{constructor(t){this.workerId=t,this.workers={},this.dt={}}addLayer({actorId:t,mapId:e,layerId:n,params:r},a){if(this.bt(e,n))return;const o=this.gt(e,n),i=r.options;this.workers[o]=new Bn(n,i,((...e)=>this.send.call(this,t,...e)),a)}removeLayer({mapId:t,layerId:e},n){const r=this.bt(t,e),a=this.gt(t,e);delete this.workers[a],r&&r.onRemove(n)}loadTile({mapId:t,layerId:e,params:n},r){const a=this.bt(t,e);a&&a.loadTile(n,r)}abortTileLoading({mapId:t,layerId:e,params:n},r){const a=this.bt(t,e);a&&a.abortTileLoading(n,r)}receive(t){const e=t.callback,n=this.dt[e];delete this.dt[e],n&&t.error?n(new Error(t.error)):n&&n(null,t.data)}send(t,e,n,r,a){const o=a?\`${kV}t}-${kV}Kn++}\`:null;a&&(this.dt[o]=a),postMessage({type:"<request>",workerId:this.workerId,actorId:t,command:e,params:n,callback:String(o)},r||[])}gt(t,e){return\`${kV}t}-${kV}e}\`}bt(t,e){const n=this.gt(t,e);return this.workers[n]}}t.initialize=function(){},t.onmessage=function(t,e){const n=t.data;this.dispatcher||(this.dispatcher=new Qn(t.workerId)),"<response>"===t.type?this.dispatcher.workerId===t.workerId&&this.dispatcher.receive(t):this.dispatcher[n.command]({actorId:n.actorId,mapId:n.mapId,layerId:n.layerId,params:n.params},((t,n,r)=>{t&&404!==t.status&&204!==t.status&&console.error(t),t instanceof Error&&(t={message:t.message}),e(t,n,r)}))}}`;var EV={exports:{}},RV={exports:{}},LV=function(e){return!(!e||"string"==typeof e)&&(e instanceof Array||Array.isArray(e)||e.length>=0&&(e.splice instanceof Function||Object.getOwnPropertyDescriptor(e,e.length-1)&&"String"!==e.constructor.name))},DV=Array.prototype.concat,FV=Array.prototype.slice,HV=RV.exports=function(e){for(var t=[],n=0,i=e.length;n<i;n++){var s=e[n];LV(s)?t=DV.call(t,FV.call(s)):t.push(s)}return t};HV.wrap=function(e){return function(){return e(HV(arguments))}};var NV={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},BV=RV.exports,zV=Object.hasOwnProperty,GV=Object.create(null);for(var UV in NV)zV.call(NV,UV)&&(GV[NV[UV]]=UV);var VV=EV.exports={to:{},get:{}};function jV(e,t,n){return Math.min(Math.max(t,e),n)}function WV(e){var t=Math.round(e).toString(16).toUpperCase();return t.length<2?"0"+t:t}VV.get=function(e){var t,n;switch(e.substring(0,3).toLowerCase()){case"hsl":t=VV.get.hsl(e),n="hsl";break;case"hwb":t=VV.get.hwb(e),n="hwb";break;default:t=VV.get.rgb(e),n="rgb"}return t?{model:n,value:t}:null},VV.get.rgb=function(e){if(!e)return null;var t,n,i,s=[0,0,0,1];if(t=e.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(i=t[2],t=t[1],n=0;n<3;n++){var o=2*n;s[n]=parseInt(t.slice(o,o+2),16)}i&&(s[3]=parseInt(i,16)/255)}else if(t=e.match(/^#([a-f0-9]{3,4})$/i)){for(i=(t=t[1])[3],n=0;n<3;n++)s[n]=parseInt(t[n]+t[n],16);i&&(s[3]=parseInt(i+i,16)/255)}else if(t=e.match(/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)){for(n=0;n<3;n++)s[n]=parseInt(t[n+1],0);t[4]&&(s[3]=t[5]?.01*parseFloat(t[4]):parseFloat(t[4]))}else{if(!(t=e.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)))return(t=e.match(/^(\w+)$/))?"transparent"===t[1]?[0,0,0,0]:zV.call(NV,t[1])?((s=NV[t[1]])[3]=1,s):null:null;for(n=0;n<3;n++)s[n]=Math.round(2.55*parseFloat(t[n+1]));t[4]&&(s[3]=t[5]?.01*parseFloat(t[4]):parseFloat(t[4]))}for(n=0;n<3;n++)s[n]=jV(s[n],0,255);return s[3]=jV(s[3],0,1),s},VV.get.hsl=function(e){if(!e)return null;var t=e.match(/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(t){var n=parseFloat(t[4]);return[(parseFloat(t[1])%360+360)%360,jV(parseFloat(t[2]),0,100),jV(parseFloat(t[3]),0,100),jV(isNaN(n)?1:n,0,1)]}return null},VV.get.hwb=function(e){if(!e)return null;var t=e.match(/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(t){var n=parseFloat(t[4]);return[(parseFloat(t[1])%360+360)%360,jV(parseFloat(t[2]),0,100),jV(parseFloat(t[3]),0,100),jV(isNaN(n)?1:n,0,1)]}return null},VV.to.hex=function(){var e=BV(arguments);return"#"+WV(e[0])+WV(e[1])+WV(e[2])+(e[3]<1?WV(Math.round(255*e[3])):"")},VV.to.rgb=function(){var e=BV(arguments);return e.length<4||1===e[3]?"rgb("+Math.round(e[0])+", "+Math.round(e[1])+", "+Math.round(e[2])+")":"rgba("+Math.round(e[0])+", "+Math.round(e[1])+", "+Math.round(e[2])+", "+e[3]+")"},VV.to.rgb.percent=function(){var e=BV(arguments),t=Math.round(e[0]/255*100),n=Math.round(e[1]/255*100),i=Math.round(e[2]/255*100);return e.length<4||1===e[3]?"rgb("+t+"%, "+n+"%, "+i+"%)":"rgba("+t+"%, "+n+"%, "+i+"%, "+e[3]+")"},VV.to.hsl=function(){var e=BV(arguments);return e.length<4||1===e[3]?"hsl("+e[0]+", "+e[1]+"%, "+e[2]+"%)":"hsla("+e[0]+", "+e[1]+"%, "+e[2]+"%, "+e[3]+")"},VV.to.hwb=function(){var e=BV(arguments),t="";return e.length>=4&&1!==e[3]&&(t=", "+e[3]),"hwb("+e[0]+", "+e[1]+"%, "+e[2]+"%"+t+")"},VV.to.keyword=function(e){return GV[e.slice(0,3)]};var qV=EV.exports,ZV={exports:{}},XV={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},YV={};for(var JV in XV)XV.hasOwnProperty(JV)&&(YV[XV[JV]]=JV);var QV=ZV.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var $V in QV)if(QV.hasOwnProperty($V)){if(!("channels"in QV[$V]))throw new Error("missing channels property: "+$V);if(!("labels"in QV[$V]))throw new Error("missing channel labels property: "+$V);if(QV[$V].labels.length!==QV[$V].channels)throw new Error("channel and label counts mismatch: "+$V);var KV=QV[$V].channels,ej=QV[$V].labels;delete QV[$V].channels,delete QV[$V].labels,Object.defineProperty(QV[$V],"channels",{value:KV}),Object.defineProperty(QV[$V],"labels",{value:ej})}QV.rgb.hsl=function(e){var t,n,i=e[0]/255,s=e[1]/255,o=e[2]/255,a=Math.min(i,s,o),l=Math.max(i,s,o),h=l-a;return l===a?t=0:i===l?t=(s-o)/h:s===l?t=2+(o-i)/h:o===l&&(t=4+(i-s)/h),(t=Math.min(60*t,360))<0&&(t+=360),n=(a+l)/2,[t,100*(l===a?0:n<=.5?h/(l+a):h/(2-l-a)),100*n]},QV.rgb.hsv=function(e){var t,n,i,s,o,a=e[0]/255,l=e[1]/255,h=e[2]/255,c=Math.max(a,l,h),u=c-Math.min(a,l,h),f=function(e){return(c-e)/6/u+.5};return 0===u?s=o=0:(o=u/c,t=f(a),n=f(l),i=f(h),a===c?s=i-n:l===c?s=1/3+t-i:h===c&&(s=2/3+n-t),s<0?s+=1:s>1&&(s-=1)),[360*s,100*o,100*c]},QV.rgb.hwb=function(e){var t=e[0],n=e[1],i=e[2];return[QV.rgb.hsl(e)[0],1/255*Math.min(t,Math.min(n,i))*100,100*(i=1-1/255*Math.max(t,Math.max(n,i)))]},QV.rgb.cmyk=function(e){var t,n=e[0]/255,i=e[1]/255,s=e[2]/255;return[100*((1-n-(t=Math.min(1-n,1-i,1-s)))/(1-t)||0),100*((1-i-t)/(1-t)||0),100*((1-s-t)/(1-t)||0),100*t]},QV.rgb.keyword=function(e){var t=YV[e];if(t)return t;var n,i,s,o=1/0;for(var a in XV)if(XV.hasOwnProperty(a)){var l=(i=e,s=XV[a],Math.pow(i[0]-s[0],2)+Math.pow(i[1]-s[1],2)+Math.pow(i[2]-s[2],2));l<o&&(o=l,n=a)}return n},QV.keyword.rgb=function(e){return XV[e]},QV.rgb.xyz=function(e){var t=e[0]/255,n=e[1]/255,i=e[2]/255;return[100*(.4124*(t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92)),100*(.2126*t+.7152*n+.0722*i),100*(.0193*t+.1192*n+.9505*i)]},QV.rgb.lab=function(e){var t=QV.rgb.xyz(e),n=t[0],i=t[1],s=t[2];return i/=100,s/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116)-16,500*(n-i),200*(i-(s=s>.008856?Math.pow(s,1/3):7.787*s+16/116))]},QV.hsl.rgb=function(e){var t,n,i,s,o,a=e[0]/360,l=e[1]/100,h=e[2]/100;if(0===l)return[o=255*h,o,o];t=2*h-(n=h<.5?h*(1+l):h+l-h*l),s=[0,0,0];for(var c=0;c<3;c++)(i=a+1/3*-(c-1))<0&&i++,i>1&&i--,s[c]=255*(o=6*i<1?t+6*(n-t)*i:2*i<1?n:3*i<2?t+(n-t)*(2/3-i)*6:t);return s},QV.hsl.hsv=function(e){var t=e[0],n=e[1]/100,i=e[2]/100,s=n,o=Math.max(i,.01);return n*=(i*=2)<=1?i:2-i,s*=o<=1?o:2-o,[t,100*(0===i?2*s/(o+s):2*n/(i+n)),(i+n)/2*100]},QV.hsv.rgb=function(e){var t=e[0]/60,n=e[1]/100,i=e[2]/100,s=Math.floor(t)%6,o=t-Math.floor(t),a=255*i*(1-n),l=255*i*(1-n*o),h=255*i*(1-n*(1-o));switch(i*=255,s){case 0:return[i,h,a];case 1:return[l,i,a];case 2:return[a,i,h];case 3:return[a,l,i];case 4:return[h,a,i];case 5:return[i,a,l]}},QV.hsv.hsl=function(e){var t,n,i,s=e[0],o=e[1]/100,a=e[2]/100,l=Math.max(a,.01);return i=(2-o)*a,n=o*l,[s,100*(n=(n/=(t=(2-o)*l)<=1?t:2-t)||0),100*(i/=2)]},QV.hwb.rgb=function(e){var t,n,i,s,o,a,l,h=e[0]/360,c=e[1]/100,u=e[2]/100,f=c+u;switch(f>1&&(c/=f,u/=f),i=6*h-(t=Math.floor(6*h)),1&t&&(i=1-i),s=c+i*((n=1-u)-c),t){default:case 6:case 0:o=n,a=s,l=c;break;case 1:o=s,a=n,l=c;break;case 2:o=c,a=n,l=s;break;case 3:o=c,a=s,l=n;break;case 4:o=s,a=c,l=n;break;case 5:o=n,a=c,l=s}return[255*o,255*a,255*l]},QV.cmyk.rgb=function(e){var t=e[1]/100,n=e[2]/100,i=e[3]/100;return[255*(1-Math.min(1,e[0]/100*(1-i)+i)),255*(1-Math.min(1,t*(1-i)+i)),255*(1-Math.min(1,n*(1-i)+i))]},QV.xyz.rgb=function(e){var t,n,i,s=e[0]/100,o=e[1]/100,a=e[2]/100;return n=-.9689*s+1.8758*o+.0415*a,i=.0557*s+-.204*o+1.057*a,t=(t=3.2406*s+-1.5372*o+-.4986*a)>.0031308?1.055*Math.pow(t,1/2.4)-.055:12.92*t,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,i=i>.0031308?1.055*Math.pow(i,1/2.4)-.055:12.92*i,[255*(t=Math.min(Math.max(0,t),1)),255*(n=Math.min(Math.max(0,n),1)),255*(i=Math.min(Math.max(0,i),1))]},QV.xyz.lab=function(e){var t=e[0],n=e[1],i=e[2];return n/=100,i/=108.883,t=(t/=95.047)>.008856?Math.pow(t,1/3):7.787*t+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(t-n),200*(n-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},QV.lab.xyz=function(e){var t,n,i;t=e[1]/500+(n=(e[0]+16)/116),i=n-e[2]/200;var s=Math.pow(n,3),o=Math.pow(t,3),a=Math.pow(i,3);return n=s>.008856?s:(n-16/116)/7.787,t=o>.008856?o:(t-16/116)/7.787,i=a>.008856?a:(i-16/116)/7.787,[t*=95.047,n*=100,i*=108.883]},QV.lab.lch=function(e){var t,n=e[0],i=e[1],s=e[2];return(t=360*Math.atan2(s,i)/2/Math.PI)<0&&(t+=360),[n,Math.sqrt(i*i+s*s),t]},QV.lch.lab=function(e){var t,n=e[1];return t=e[2]/360*2*Math.PI,[e[0],n*Math.cos(t),n*Math.sin(t)]},QV.rgb.ansi16=function(e){var t=e[0],n=e[1],i=e[2],s=1 in arguments?arguments[1]:QV.rgb.hsv(e)[2];if(0===(s=Math.round(s/50)))return 30;var o=30+(Math.round(i/255)<<2|Math.round(n/255)<<1|Math.round(t/255));return 2===s&&(o+=60),o},QV.hsv.ansi16=function(e){return QV.rgb.ansi16(QV.hsv.rgb(e),e[2])},QV.rgb.ansi256=function(e){var t=e[0],n=e[1],i=e[2];return t===n&&n===i?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(n/255*5)+Math.round(i/255*5)},QV.ansi16.rgb=function(e){var t=e%10;if(0===t||7===t)return e>50&&(t+=3.5),[t=t/10.5*255,t,t];var n=.5*(1+~~(e>50));return[(1&t)*n*255,(t>>1&1)*n*255,(t>>2&1)*n*255]},QV.ansi256.rgb=function(e){if(e>=232){var t=10*(e-232)+8;return[t,t,t]}var n;return e-=16,[Math.floor(e/36)/5*255,Math.floor((n=e%36)/6)/5*255,n%6/5*255]},QV.rgb.hex=function(e){var t=(((255&Math.round(e[0]))<<16)+((255&Math.round(e[1]))<<8)+(255&Math.round(e[2]))).toString(16).toUpperCase();return"000000".substring(t.length)+t},QV.hex.rgb=function(e){var t=e.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!t)return[0,0,0];var n=t[0];3===t[0].length&&(n=n.split("").map((function(e){return e+e})).join(""));var i=parseInt(n,16);return[i>>16&255,i>>8&255,255&i]},QV.rgb.hcg=function(e){var t,n=e[0]/255,i=e[1]/255,s=e[2]/255,o=Math.max(Math.max(n,i),s),a=Math.min(Math.min(n,i),s),l=o-a;return t=l<=0?0:o===n?(i-s)/l%6:o===i?2+(s-n)/l:4+(n-i)/l+4,t/=6,[360*(t%=1),100*l,100*(l<1?a/(1-l):0)]},QV.hsl.hcg=function(e){var t,n=e[1]/100,i=e[2]/100,s=0;return(t=i<.5?2*n*i:2*n*(1-i))<1&&(s=(i-.5*t)/(1-t)),[e[0],100*t,100*s]},QV.hsv.hcg=function(e){var t=e[2]/100,n=e[1]/100*t,i=0;return n<1&&(i=(t-n)/(1-n)),[e[0],100*n,100*i]},QV.hcg.rgb=function(e){var t=e[1]/100,n=e[2]/100;if(0===t)return[255*n,255*n,255*n];var i,s=[0,0,0],o=e[0]/360%1*6,a=o%1,l=1-a;switch(Math.floor(o)){case 0:s[0]=1,s[1]=a,s[2]=0;break;case 1:s[0]=l,s[1]=1,s[2]=0;break;case 2:s[0]=0,s[1]=1,s[2]=a;break;case 3:s[0]=0,s[1]=l,s[2]=1;break;case 4:s[0]=a,s[1]=0,s[2]=1;break;default:s[0]=1,s[1]=0,s[2]=l}return[255*(t*s[0]+(i=(1-t)*n)),255*(t*s[1]+i),255*(t*s[2]+i)]},QV.hcg.hsv=function(e){var t=e[1]/100,n=t+e[2]/100*(1-t),i=0;return n>0&&(i=t/n),[e[0],100*i,100*n]},QV.hcg.hsl=function(e){var t=e[1]/100,n=e[2]/100*(1-t)+.5*t,i=0;return n>0&&n<.5?i=t/(2*n):n>=.5&&n<1&&(i=t/(2*(1-n))),[e[0],100*i,100*n]},QV.hcg.hwb=function(e){var t=e[1]/100,n=t+e[2]/100*(1-t);return[e[0],100*(n-t),100*(1-n)]},QV.hwb.hcg=function(e){var t=1-e[2]/100,n=t-e[1]/100,i=0;return n<1&&(i=(t-n)/(1-n)),[e[0],100*n,100*i]},QV.apple.rgb=function(e){return[e[0]/65535*255,e[1]/65535*255,e[2]/65535*255]},QV.rgb.apple=function(e){return[e[0]/255*65535,e[1]/255*65535,e[2]/255*65535]},QV.gray.rgb=function(e){return[e[0]/100*255,e[0]/100*255,e[0]/100*255]},QV.gray.hsl=QV.gray.hsv=function(e){return[0,0,e[0]]},QV.gray.hwb=function(e){return[0,100,e[0]]},QV.gray.cmyk=function(e){return[0,0,0,e[0]]},QV.gray.lab=function(e){return[e[0],0,0]},QV.gray.hex=function(e){var t=255&Math.round(e[0]/100*255),n=((t<<16)+(t<<8)+t).toString(16).toUpperCase();return"000000".substring(n.length)+n},QV.rgb.gray=function(e){return[(e[0]+e[1]+e[2])/3/255*100]};var tj=ZV.exports,nj=tj;function rj(e,t){return function(n){return t(e(n))}}function ij(e,t){for(var n=[t[e].parent,e],i=nj[t[e].parent][e],s=t[e].parent;t[s].parent;)n.unshift(t[s].parent),i=rj(nj[t[s].parent][s],i),s=t[s].parent;return i.conversion=n,i}var sj=tj,oj=function(e){for(var t=function(e){var t=function(){for(var e={},t=Object.keys(nj),n=t.length,i=0;i<n;i++)e[t[i]]={distance:-1,parent:null};return e}(),n=[e];for(t[e].distance=0;n.length;)for(var i=n.pop(),s=Object.keys(nj[i]),o=s.length,a=0;a<o;a++){var l=s[a],h=t[l];-1===h.distance&&(h.distance=t[i].distance+1,h.parent=i,n.unshift(l))}return t}(e),n={},i=Object.keys(t),s=i.length,o=0;o<s;o++){var a=i[o];null!==t[a].parent&&(n[a]=ij(a,t))}return n},aj={};Object.keys(sj).forEach((function(e){aj[e]={},Object.defineProperty(aj[e],"channels",{value:sj[e].channels}),Object.defineProperty(aj[e],"labels",{value:sj[e].labels});var t=oj(e);Object.keys(t).forEach((function(n){var i=t[n];aj[e][n]=function(e){var t=function(t){if(null==t)return t;arguments.length>1&&(t=Array.prototype.slice.call(arguments));var n=e(t);if("object"==typeof n)for(var i=n.length,s=0;s<i;s++)n[s]=Math.round(n[s]);return n};return"conversion"in e&&(t.conversion=e.conversion),t}(i),aj[e][n].raw=function(e){var t=function(t){return null==t?t:(arguments.length>1&&(t=Array.prototype.slice.call(arguments)),e(t))};return"conversion"in e&&(t.conversion=e.conversion),t}(i)}))}));var lj=qV,hj=aj,cj=[].slice,uj=["keyword","gray","hex"],fj={};Object.keys(hj).forEach((function(e){fj[cj.call(hj[e].labels).sort().join("")]=e}));var dj={};function pj(e,t){if(!(this instanceof pj))return new pj(e,t);if(t&&t in uj&&(t=null),t&&!(t in hj))throw new Error("Unknown model: "+t);var n,i;if(null==e)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(e instanceof pj)this.model=e.model,this.color=e.color.slice(),this.valpha=e.valpha;else if("string"==typeof e){var s=lj.get(e);if(null===s)throw new Error("Unable to parse color from string: "+e);this.model=s.model,this.color=s.value.slice(0,i=hj[this.model].channels),this.valpha="number"==typeof s.value[i]?s.value[i]:1}else if(e.length){this.model=t||"rgb";var o=cj.call(e,0,i=hj[this.model].channels);this.color=Aj(o,i),this.valpha="number"==typeof e[i]?e[i]:1}else if("number"==typeof e)e&=16777215,this.model="rgb",this.color=[e>>16&255,e>>8&255,255&e],this.valpha=1;else{this.valpha=1;var a=Object.keys(e);"alpha"in e&&(a.splice(a.indexOf("alpha"),1),this.valpha="number"==typeof e.alpha?e.alpha:0);var l=a.sort().join("");if(!(l in fj))throw new Error("Unable to parse color from object: "+JSON.stringify(e));this.model=fj[l];var h=hj[this.model].labels,c=[];for(n=0;n<h.length;n++)c.push(e[h[n]]);this.color=Aj(c)}if(dj[this.model])for(i=hj[this.model].channels,n=0;n<i;n++){var u=dj[this.model][n];u&&(this.color[n]=u(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function gj(e,t,n){return(e=Array.isArray(e)?e:[e]).forEach((function(e){(dj[e]||(dj[e]=[]))[t]=n})),e=e[0],function(i){var s;return arguments.length?(n&&(i=n(i)),(s=this[e]()).color[t]=i,s):(s=this[e]().color[t],n&&(s=n(s)),s)}}function mj(e){return function(t){return Math.max(0,Math.min(e,t))}}function Aj(e,t){for(var n=0;n<t;n++)"number"!=typeof e[n]&&(e[n]=0);return e}pj.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(e){var t=this.model in lj.to?this:this.rgb(),n=1===(t=t.round("number"==typeof e?e:1)).valpha?t.color:t.color.concat(this.valpha);return lj.to[t.model](n)},percentString:function(e){var t=this.rgb().round("number"==typeof e?e:1),n=1===t.valpha?t.color:t.color.concat(this.valpha);return lj.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var e={},t=hj[this.model].channels,n=hj[this.model].labels,i=0;i<t;i++)e[n[i]]=this.color[i];return 1!==this.valpha&&(e.alpha=this.valpha),e},unitArray:function(){var e=this.rgb().color;return e[0]/=255,e[1]/=255,e[2]/=255,1!==this.valpha&&e.push(this.valpha),e},unitObject:function(){var e=this.rgb().object();return e.r/=255,e.g/=255,e.b/=255,1!==this.valpha&&(e.alpha=this.valpha),e},round:function(e){return e=Math.max(e||0,0),new pj(this.color.map(function(e){return function(t){return function(e,t){return Number(e.toFixed(t))}(t,e)}}(e)).concat(this.valpha),this.model)},alpha:function(e){return arguments.length?new pj(this.color.concat(Math.max(0,Math.min(1,e))),this.model):this.valpha},red:gj("rgb",0,mj(255)),green:gj("rgb",1,mj(255)),blue:gj("rgb",2,mj(255)),hue:gj(["hsl","hsv","hsl","hwb","hcg"],0,(function(e){return(e%360+360)%360})),saturationl:gj("hsl",1,mj(100)),lightness:gj("hsl",2,mj(100)),saturationv:gj("hsv",1,mj(100)),value:gj("hsv",2,mj(100)),chroma:gj("hcg",1,mj(100)),gray:gj("hcg",2,mj(100)),white:gj("hwb",1,mj(100)),wblack:gj("hwb",2,mj(100)),cyan:gj("cmyk",0,mj(100)),magenta:gj("cmyk",1,mj(100)),yellow:gj("cmyk",2,mj(100)),black:gj("cmyk",3,mj(100)),x:gj("xyz",0,mj(100)),y:gj("xyz",1,mj(100)),z:gj("xyz",2,mj(100)),l:gj("lab",0,mj(100)),a:gj("lab",1),b:gj("lab",2),keyword:function(e){return arguments.length?new pj(e):hj[this.model].keyword(this.color)},hex:function(e){return arguments.length?new pj(e):lj.to.hex(this.rgb().round().color)},rgbNumber:function(){var e=this.rgb().color;return(255&e[0])<<16|(255&e[1])<<8|255&e[2]},luminosity:function(){for(var e=this.rgb().color,t=[],n=0;n<e.length;n++){var i=e[n]/255;t[n]=i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4)}return.2126*t[0]+.7152*t[1]+.0722*t[2]},contrast:function(e){var t=this.luminosity(),n=e.luminosity();return t>n?(t+.05)/(n+.05):(n+.05)/(t+.05)},level:function(e){var t=this.contrast(e);return t>=7.1?"AAA":t>=4.5?"AA":""},isDark:function(){var e=this.rgb().color;return(299*e[0]+587*e[1]+114*e[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var e=this.rgb(),t=0;t<3;t++)e.color[t]=255-e.color[t];return e},lighten:function(e){var t=this.hsl();return t.color[2]+=t.color[2]*e,t},darken:function(e){var t=this.hsl();return t.color[2]-=t.color[2]*e,t},saturate:function(e){var t=this.hsl();return t.color[1]+=t.color[1]*e,t},desaturate:function(e){var t=this.hsl();return t.color[1]-=t.color[1]*e,t},whiten:function(e){var t=this.hwb();return t.color[1]+=t.color[1]*e,t},blacken:function(e){var t=this.hwb();return t.color[2]+=t.color[2]*e,t},grayscale:function(){var e=this.rgb().color,t=.3*e[0]+.59*e[1]+.11*e[2];return pj.rgb(t,t,t)},fade:function(e){return this.alpha(this.valpha-this.valpha*e)},opaquer:function(e){return this.alpha(this.valpha+this.valpha*e)},rotate:function(e){var t=this.hsl(),n=t.color[0];return n=(n=(n+e)%360)<0?360+n:n,t.color[0]=n,t},mix:function(e,t){if(!e||!e.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof e);var n=e.rgb(),i=this.rgb(),s=void 0===t?.5:t,o=2*s-1,a=n.alpha()-i.alpha(),l=((o*a==-1?o:(o+a)/(1+o*a))+1)/2,h=1-l;return pj.rgb(l*n.red()+h*i.red(),l*n.green()+h*i.green(),l*n.blue()+h*i.blue(),n.alpha()*s+i.alpha()*(1-s))}},Object.keys(hj).forEach((function(e){if(-1===uj.indexOf(e)){var t=hj[e].channels;pj.prototype[e]=function(){if(this.model===e)return new pj(this);if(arguments.length)return new pj(arguments,e);var n,i="number"==typeof arguments[t]?t:this.valpha;return new pj((n=hj[this.model][e].raw(this.color),Array.isArray(n)?n:[n]).concat(i),e)},pj[e]=function(n){return"number"==typeof n&&(n=Aj(cj.call(arguments),t)),new pj(n,e)}}}));var yj,_j=(yj=pj)&&yj.t&&Object.prototype.hasOwnProperty.call(yj,"default")?yj.default:yj;function vj(e){return null==e}function xj(e){for(let t=1;t<arguments.length;t++){const n=arguments[t];for(const t in n)e[t]=n[t]}return e}function bj(e){return null!=e&&("function"==typeof e||null!==e.constructor&&e.constructor===Function)}function wj(e){return"object"==typeof e&&!!e}function Tj(e){return"number"==typeof e&&!isNaN(e)}function Sj(e){return e*Math.PI/180}function Mj(e){return e/Math.PI*180}function Cj(e){let t=document.createElement("a");return t.href=e,e=t.href,t=null,e}function Pj(e){return Math.sign?Math.sign(e):0==(e=+e)||isNaN(e)?Number(e):e>0?1:-1}const Ij=[1,1,1,1,2,2,3,0];function kj(e){const t=e.length;let n="";for(let i=0;i<t;){let s=e[i++];if(128&s){let n=Ij[s>>3&7];if(!(64&s)||!n||i+n>t)return null;for(s&=63>>n;n>0;n-=1){const t=e[i++];if(128!=(192&t))return null;s=s<<6|63&t}}n+=String.fromCharCode(s)}return n}function Oj(e,t,n){return e[3*n]=t[0],e[3*n+1]=t[1],e[3*n+2]=t[2],e}function Ej(e){return e.flat?e.flat(1/0):e.reduce(((e,t)=>e.concat(t)),[])}function Rj(e){return e<256?Uint8Array:e<65536?Uint16Array:Uint32Array}function Lj(e){return 0===e.indexOf("data:")}function Dj(e){const t=e.indexOf("base64,"),n=e.substring(t+7),i=window.atob(n),s=i.length,o=new Uint8Array(s);for(let e=0;e<s;e++)o[e]=i.charCodeAt(e);return o.buffer}function Fj(e){for(let t=1;t<arguments.length;t++){const n=arguments[t];if(n)for(let t=0,i=n.length;t<i;t++)e.push(n[t])}return e.length}const Hj={};function Nj(e,t){if(!Array.isArray(t)){t=Hj[t]=Hj[t]||_j(t).array().map((e=>e/255))}for(let n=0;n<t.length;n++)e[n]=t[n];return 3===t.length&&(e[3]=1),e}var Bj=Object.freeze({__proto__:null,base64URLToArrayBuffer:Dj,extend:xj,flatArr:Ej,getAbsoluteURL:Cj,getBatchIdArrayType:Rj,isBase64:Lj,isFunction:bj,isNil:vj,isNumber:Tj,isObject:wj,normalizeColor:Nj,pushIn:Fj,setColumn3:Oj,sign:Pj,stringFromUTF8Array:kj,toDegree:Mj,toRadian:Sj});function zj(e){return-1===e.indexOf("http://")&&-1===e.indexOf("https://")&&-1===e.indexOf("file://")}function Gj(e){return(e=e||{}).referrerPolicy=e.referrerPolicy||"origin",e.referrer=window&&window.location.href,e}const Uj=function(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")},Vj=Uj(),jj=Vj.gl_trans__coders=Vj.gl_trans__coders||{};
/*!
   * @maptalks/gl v0.110.0
   * LICENSE : UNLICENSED
   * (c) 2016-2025 maptalks.com
   */function Wj(){return Uj().maptalks_gltf_loader}jj.inject=function(e){const t=e.toString(),n=t.indexOf("{")+1,i=t.substring(0,n),s=Vj.gl_trans__coders=Vj.gl_trans__coders||{};let o=`${i}\n    const _____getGlobal = ${Uj.toString()};\n    const g___lobals = _____getGlobal()\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};`;for(const e in s)"inject"!==e&&"getTranscoder"!==e&&"registerTranscoder"!==e&&(o+='tran_____scoders["'+e+'"] ='+s[e].toString()+"\n;");return o+="\n("+Uj().maptalks_gltf_loader_bundle.toString()+")({});\n",o+="\n"+t.substring(i.length),o},jj.registerTranscoder=function(e,t){jj[e]=t},jj.getTranscoder=function(e){return jj[e]};const qj="undefined"==typeof document?null:document.createElement("canvas");let Zj=class jt extends Um.Actor{constructor(e,t,n){super(e),this.mapId=t,this.i=n}initialize(e){e(null)}loadTile(e,t,n){let i=null;t&&t.arraybuffer&&(i=[t.arraybuffer]);this.send({mapId:this.mapId,layerId:e,command:"loadTile",params:t},i,n)}abortTileLoading(e,t,n){this.broadcast({mapId:this.mapId,layerId:e,command:"abortTileLoading",params:{url:t}},null,n)}addLayer(e,t,n){this.broadcast({actorId:this.actorId,mapId:this.mapId,layerId:e,command:"addLayer",params:{options:t}},null,n)}removeLayer(e,t){this.broadcast({mapId:this.mapId,layerId:e,command:"removeLayer"},null,t)}requestImage({url:e},t){const n=new Image;n.onload=()=>{if(!this.isActive())return;if(!qj)return void t(new Error("There is no canvas to draw image!"));const e=this.i?n:function(e){if(Xj(e.width)&&Xj(e.height))return e;let t=e.width,n=e.height;Xj(t)||(t=Yj(t)),Xj(n)||(n=Yj(n));const i=document.createElement("canvas");i.width=t,i.height=n,i.getContext("2d").drawImage(e,0,0,t,n);const s=e.src,o=s.lastIndexOf("/")+1,a=s.substring(o);return console.warn(`Texture(${a})'s size is not power of two, resize from (${e.width}, ${e.height}) to (${t}, ${n})`),i}(n);qj.width=e.width,qj.height=e.height;const i=qj.getContext("2d",{willReadFrequently:!0});i.drawImage(e,0,0,e.width,e.height);const s=i.getImageData(0,0,e.width,e.height),o={width:e.width,height:e.height,data:new Uint8Array(s.data)};t(null,o,[o.data.buffer])},n.onerror=function(e){t(e)},n.src=e}};function Xj(e){return!(e&e-1)&&0!==e}function Yj(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))}const{GLTFLoader:Jj}=Wj();function Qj(e,t){if(e.scenes&&e.scenes.length)for(let n=0,i=e.scenes.length;n<i;n++){const i=e.scenes[n].nodes;for(let n=0,s=i.length;n<s;n++){iW(i[n],[],e,t)}}}const $j=[],Kj=[],eW=[],tW=[0,0,0],nW=Qy([]),rW=[1,1,1];function iW(e,t,n,i){const s=t.slice(0);if(e.matrix)s.push(e.matrix);else if(e.rotation||e.translation||e.scale){const t=TA($j,e.translation||tW),n=RA(Kj,e.rotation||nW),i=SA(eW,e.scale||rW);vA(i,n,i);const o=vA([],t,i);s.push(o)}if(e.children&&e.children.length)for(let t=0,o=e.children.length;t<o;t++)iW(e.children[t],s,n,i);if(void 0!==e.mesh){const t=e.mesh,o=n.meshes[t];if(o){const e=s.slice(0),a=o.primitives;for(let s=0,o=a.length;s<o;s++){const o=a[s];o&&(o.matrices=e,i(o,t,s,n))}}}}function sW(e,t,n){let{byteOffset:i,byteStride:s}=t;const{componentType:o,itemSize:a}=t,l=t.array.buffer,h=o?Jj.getTypedArrayCtor(o):t.array.constructor;if(i=void 0===i?t.array.byteOffset:i,s=s||0,!s||s===a*h.BYTES_PER_ELEMENT&&i%h.BYTES_PER_ELEMENT==0){const t=new h(l,i+n*a*h.BYTES_PER_ELEMENT,a);return e.set(t),e}s||(s=a*h.BYTES_PER_ELEMENT);const c=new Uint8Array(l,s*n+i,a*h.BYTES_PER_ELEMENT);return new Uint8Array(e.buffer).set(c),e}function oW(e,t,n,i){e[4*t]=n[i],e[4*t+1]=n[i+4],e[4*t+2]=n[i+8],e[4*t+3]=n[i+12]}var aW="#include <gl2_vert>\n\nconst float SHIFT_RIGHT_11 = 1.0 / 2048.0;\n\nconst float SHIFT_RIGHT_5 = 1.0 / 32.0;\n\nconst float SHIFT_LEFT_11 = 2048.0;\n\nconst float SHIFT_LEFT_5 = 32.0;\n\nconst float NORMALIZE_6 = 1.0 / 64.0;\n\nconst float NORMALIZE_5 = 1.0 / 32.0;\n\n\n\n#ifdef HAS_POSITION\n\n    attribute vec3 POSITION;\n\n#endif\n\n\n\n#if defined(HAS_RGB)\n\n    attribute vec3 RGB;\n\n#elif defined(HAS_RGBA)\n\n    attribute vec4 RGBA;\n\n#elif defined(HAS_RGB565)\n\n    attribute float RGB565;\n\n#endif\n\n\n\nuniform vec4 pointColor;\n\nuniform float pointSize;\n\n\n\nuniform mat4 projViewModelMatrix;\n\nuniform float pointOpacity;\n\n\n\nvarying vec4 vColor;\n\n\n\n#ifdef HAS_NORMAL\n\n    #ifdef HAS_NORMAL_OCT16P\n\n        attribute vec2 NORMAL_OCT16P;\n\n        float signNotZero(float value) {\n\n            return value >= 0.0 ? 1.0 : -1.0;\n\n        }\n\n        vec2 signNotZero(vec2 value) {\n\n            return vec2(signNotZero(value.x), signNotZero(value.y));\n\n        }\n\n        vec3 octDecode(vec2 encoded, float range) {\n\n            if (encoded.x == 0.0 && encoded.y == 0.0) {\n\n                return vec3(0.0, 0.0, 0.0);\n\n            }\n\n            encoded = encoded / range * 2.0 - 1.0;\n\n            vec3 v = vec3(encoded.x, encoded.y, 1.0 - abs(encoded.x) - abs(encoded.y));\n\n            if (v.z < 0.0) {\n\n                v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\n\n            }\n\n            return normalize(v);\n\n        }\n\n        vec3 octDecode(vec2 encoded) {\n\n            return octDecode(encoded, 255.0);\n\n        }\n\n    #else\n\n        attribute vec3 NORMAL;\n\n    #endif\n\n    uniform vec3 lightDir;\n\n    uniform mat3 modelNormalMatrix;\n\n    uniform mat4 positionMatrix;\n\n    float getLambertDiffuse(vec3 lightDir, vec3 normal) {\n\n        return max(dot(-lightDir, normal), 0.0);\n\n    }\n\n#endif\n\n#ifdef PICKING_MODE\n\n    #include <fbo_picking_vert>\n\n#endif\n\n#include <draco_decode_vert>\n\nvoid main() {\n\n    #ifdef HAS_POSITION\n\n        vec3 localPos = decode_getPosition(POSITION);\n\n    #endif\n\n    gl_Position = projViewModelMatrix * vec4(localPos, 1.0);\n\n    gl_PointSize = pointSize;\n\n\n\n    #ifdef PICKING_MODE\n\n        fbo_picking_setData(gl_Position.w, true);\n\n    #else\n\n        #if defined(HAS_RGB)\n\n            vColor = vec4(RGB / 255.0, 1.0) * pointOpacity;\n\n        #elif defined(HAS_RGBA)\n\n            vColor = RGBA / 255.0 * pointOpacity;\n\n        #elif defined(HAS_RGB565)\n\n            float compressed = RGB565;\n\n            float r = floor(compressed * SHIFT_RIGHT_11);\n\n            compressed -= r * SHIFT_LEFT_11;\n\n            float g = floor(compressed * SHIFT_RIGHT_5);\n\n            compressed -= g * SHIFT_LEFT_5;\n\n            float b = compressed;\n\n            vec3 rgb = vec3(r * NORMALIZE_5, g * NORMALIZE_6, b * NORMALIZE_5);\n\n            vColor = vec4(rgb, 1.0);\n\n        #else\n\n            vColor = pointColor;\n\n        #endif\n\n\n\n        #ifdef HAS_NORMAL\n\n            mat3 positionNormalMatrix = mat3(positionMatrix);\n\n            mat3 normalMatrix = modelNormalMatrix * positionNormalMatrix;\n\n            #ifdef HAS_NORMAL_OCT16P\n\n                vec3 localNormal = octDecode(NORMAL_OCT16P);\n\n            #else\n\n                vec3 localNormal = NORMAL;\n\n            #endif\n\n            vec3 normal = normalize(normalMatrix * localNormal);\n\n            float colorStrength = getLambertDiffuse(lightDir, normal);\n\n            colorStrength = max(colorStrength, 0.5);\n\n            vColor *= colorStrength;\n\n        #endif\n\n    #endif\n\n\n\n\n\n\n\n\n\n}\n\n";const lW=new Array(3),hW=new Array(3),cW=[40680631590769,40680631590769,40408299984661.445];function uW(e,t,n,i){const s=cW,o=Math.cos(n);lW[0]=o*Math.cos(t),lW[1]=o*Math.sin(t),lW[2]=Math.sin(n),bW(lW,lW),JA(hW,s,lW);const a=Math.sqrt(iy(lW,hW));var l,h,c;return(l=hW)[0]=(h=hW)[0]/(c=a),l[1]=h[1]/c,l[2]=h[2]/c,$A(lW,lW,i),XA(e,hW,lW)}const fW=[1/6378137,1/6378137,1/6356752.314245179],dW=[1/40680631590769,1/40680631590769,1/40408299984661.445],pW=new Array(3),gW=new Array(3),mW=new Array(3);function AW(e,t){const n=dW,i=function(e,t,n,i,s){const o=t[0],a=t[1],l=t[2],h=n[0],c=n[1],u=n[2],f=o*o*h*h,g=a*a*c*c,m=l*l*u*u,A=f+g+m,w=Math.sqrt(1/A),T=$A(yW,t,w);if(A<.1)return isFinite(w)?T:void 0;const S=i[0],M=i[1],C=i[2],I=_W;I[0]=T[0]*S*2,I[1]=T[1]*M*2,I[2]=T[2]*C*2;let E,D,H,N,B,z,U,j,W,q,Z,X=(1-w)*xW(t)/(.5*xW(I)),Y=0;do{X-=Y,H=1/(1+X*S),N=1/(1+X*M),B=1/(1+X*C),z=H*H,U=N*N,j=B*B,W=z*H,q=U*N,Z=j*B,E=f*z+g*U+m*j-1,D=f*W*S+g*q*M+m*Z*C,Y=E/(-2*D)}while(Math.abs(E)>vW);return e[0]=o*H,e[1]=a*N,e[2]=l*B,e}(pW,t,fW,n);let s=dy(gW,i,n);s=bW(s,s);const o=fy(mW,t,i),a=Math.atan2(s[1],s[0]),l=Math.asin(s[2]),h=Pj(iy(o,t))*xW(o);return e[0]=Mj(a),e[1]=Mj(l),e[2]=h,e}const yW=new Array(3),_W=new Array(3),vW=1e-12;function xW(e){return jA(e)}function bW(e,t){const n=t[0],i=t[1],s=t[2];let o=n*n+i*i+s*s;return o>0&&(o=Math.sqrt(o),e[0]=t[0]/o,e[1]=t[1]/o,e[2]=t[2]/o),e}function wW(e,t){return JA(t,e,dW),ry(t,t)}function TW(e,t){const n=e[0],i=e[1],s=Math.cos(i),o=s*Math.cos(n),a=s*Math.sin(n),l=Math.sin(i);return t.x=o,t.y=a,t.z=l,ry(t,t)}var SW=Object.freeze({__proto__:null,cartesian3ToDegree:AW,geodeticSurfaceNormal:wW,geodeticSurfaceNormalCartographic:TW,normalizeCartesian:bW,radianToCartesian3:uW});function MW(e,t,n,i){n=n||0,i=i||n;const s=Math.abs(e-t);return s<=i||s<=n*Math.max(Math.abs(e),Math.abs(t))}function CW(e,t){let n="";for(let i=0;i<4;i++){const s=e.getUint8(t+i);n+=String.fromCharCode(s)}return n}const PW="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function IW(e,t,n){const i=new Uint8Array(e,t,n);return PW?JSON.parse(PW.decode(i)):JSON.parse(kj(i))}function kW(e,t,n){const i=new Uint8Array(e,t,n);return PW?JSON.parse(PW.decode(i)):JSON.parse(kj(i))}function OW(e,t,n){return{offset:t,byteLength:n}}function EW(e,t,n,i){const{byteOffset:s,componentType:o,type:a}=e,{ctor:l,type:h}=NW(o||"UNSIGNED_SHORT"),c=FW(a);return{byteStride:0,byteOffset:s+n,itemSize:c,count:i*c,componentType:h,array:new l(t,n+s,i*c)}}function RW(e,t,n,i){const s=EW(e,t,n,i);return s.array.buffer.byteLength!==t.byteLength&&(s.array=s.array.slice()),s}function LW(e,t,n,i){const{byteOffset:s,componentType:o,type:a}=e,{ctor:l}=NW(o||"UNSIGNED_SHORT"),h=FW(a),c=new l(t,s,n*h);return 1===h?c[i]:c.subarray(i*h,i*h+h)}const DW={SCALAR:1,VEC2:2,VEC3:3,VEC4:4};function FW(e){return e?DW[e]:1}const HW={BYTE:{ctor:Int8Array,type:5120,name:"Int8Array"},UNSIGNED_BYTE:{ctor:Uint8Array,type:5121,name:"Uint8Array"},SHORT:{ctor:Int16Array,type:5122,name:"Int16Array"},UNSIGNED_SHORT:{ctor:Uint16Array,type:5123,name:"Uint16Array"},INT:{ctor:Int32Array,type:5124,name:"Int32Array"},UNSIGNED_INT:{ctor:Uint32Array,type:5125,name:"Uint32Array"},FLOAT:{ctor:Float32Array,type:5126,name:"Float32Array"},DOUBLE:{ctor:Float64Array,type:5126,name:"Float64Array"}};function NW(e){return HW[e]}function BW(e){for(const t in HW)if(e===HW[t].ctor)return HW[t].type;throw new Error("unrecognized ctor:"+e)}function zW(e,t,n,i){const s=e,o=t.length/3;for(let e=0;e<o;e++)s[3*e]=t[3*e]/65535*i[0]+n[0],s[3*e+1]=t[3*e+1]/65535*i[1]+n[1],s[3*e+2]=t[3*e+2]/65535*i[2]+n[2];return s}function GW(e,t,n){const i=e.getUint32(12,!0),s=e.getUint32(16,!0),o=e.getUint32(20,!0),a=e.getUint32(24,!0),l=e.buffer;let h,c={},u={},f=null;i>0&&(c=IW(l,t,i),t+=i),s>0&&(h=function(e,t,n){return{offset:t,byteLength:n}}(0,t,s),t+=s),o>0&&(u=kW(l,t,o),t+=o);const g=OW(0,t,a);return f=l.slice(g.offset,g.offset+g.byteLength),n.push(f),{featureTable:c,featureTableBin:h,batchTable:u,batchTableBin:f}}const UW={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},VW={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},jW={},WW={east:[],north:[],up:[],west:[],south:[],down:[]};let qW=[],ZW=[],XW=[];const YW=[0,0,0];function JW(e,t,n){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=e[15],n}const QW=function(e,t){const n=UW[e][t];let i;const s=e+t;return jW[s]?i=jW[s]:(i=function(i,s,o){if(cy(i,YW))qA(qW,VW[e]),qA(ZW,VW[t]),qA(XW,VW[n]);else if(MW(i[0],0,1e-14)&&MW(i[1],0,1e-14)){const s=Pj(i[2]);qA(qW,VW[e]),qA(ZW,VW[t]),$A(ZW,ZW,s),qA(XW,VW[n]),$A(XW,XW,s)}else{wW(i,WW.up);const s=WW.up,o=WW.east;o[0]=-i[1],o[1]=i[0],o[2]=0,ry(WW.east,o),sy(WW.north,s,o),$A(WW.down,WW.up,-1),$A(WW.west,WW.east,-1),$A(WW.south,WW.north,-1),qW=WW[e],ZW=WW[t],XW=WW[n]}return o[0]=qW[0],o[1]=qW[1],o[2]=qW[2],o[3]=0,o[4]=ZW[0],o[5]=ZW[1],o[6]=ZW[2],o[7]=0,o[8]=XW[0],o[9]=XW[1],o[10]=XW[2],o[11]=0,o[12]=i[0],o[13]=i[1],o[14]=i[2],o[15]=1,o},jW[s]=i),i}("east","north"),$W=[],KW=[],eq=[],tq=[],nq=[],rq=[],iq=[],sq={x:0,y:0},oq={x:0,y:0},aq=Math.PI/180;let lq;const hq={width:100,height:10};let cq=!1;try{new OffscreenCanvas(1,1).getContext("2d").fillText("hello",0,0),cq=!0}catch(yj){cq=!1}class an{constructor(e,t={}){if(!Array.isArray(e))return void console.error("colors is not array");if(e.length<2)return void console.error("colors.length should >1");this.colors=e;let n=1/0,i=-1/0;for(let t=0,s=e.length;t<s;t++){const s=e[t][0];n=Math.min(s,n),i=Math.max(s,i)}this.min=n,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},hq,t),this.o()}getImageData(){return this.imgData}o(){const e=function(){if(!lq){const{width:e,height:t}=hq;cq?lq=new OffscreenCanvas(e,t):(lq=document.createElement("canvas"),lq.width=e,lq.height=t)}return lq}(),{width:t,height:n}=this.options;e.width=t,e.height=n;const i=e.getContext("2d");i.clearRect(0,0,e.width,e.height);const s=i.createLinearGradient(0,0,e.width,0),{colors:o,valueOffset:a}=this;for(let e=0,t=o.length;e<t;e++){const[t,n]=o[e];s.addColorStop((t-this.min)/a,n)}i.fillStyle=s,i.fillRect(0,0,e.width,e.height),this.imgData=i.getImageData(0,0,e.width,e.height)}getColor(e){e=Math.max(this.min,e);const t=((e=Math.min(e,this.max))-this.min)/this.valueOffset;let n=Math.round(t*this.imgData.width);n=Math.min(n,this.imgData.width-1);const i=4*n;return[this.imgData.data[i],this.imgData.data[i+1],this.imgData.data[i+2],this.imgData.data[i+3]]}}var uq;function fq(e){return null==e}function dq(e){return!fq(e)}function pq(e){return""===e}function gq(e,t){var n,i,s;if(Sq(e)){var o,a=e.stops&&"object"==typeof e.stops[0][0],l=a||dq(e.property),h=a||!l,c=e.type||t||"exponential";if("exponential"===c)o=yq;else if("interval"===c)o=Aq;else if("categorical"===c)o=mq;else if("identity"===c)o=xq;else if("color-interpolate"===c)o=vq;else{if("calculate-expression"!==c)throw new Error('Unknown function type "'+c+'"');o=bq}if(a){var u={},f=[];for(let t=0;t<e.stops.length;t++){var g=e.stops[t];void 0===u[g[0].zoom]&&(u[g[0].zoom]={zoom:g[0].zoom,type:e.type,property:e.property,default:e.default,stops:[]}),u[g[0].zoom].stops.push([g[0].value,g[1]])}for(let e in u)f.push([u[e].zoom,gq(u[e])]);n=function(t,n){const i=yq({stops:f,base:e.base},t)(t,n);return"function"==typeof i?i(t,n):i},i=!1,s=!1}else h?(n=function(t){const n=o(e,t);return"function"==typeof n?n(t):n},i=!0,s=!1):(n=function(t,n){const i=o(e,n?n[e.property]:null);return"function"==typeof i?i(t,n):i},i=!1,s=!0)}else n=function(){return e},i=!0,s=!0;return n.isZoomConstant=s,n.isFeatureConstant=i,n}function mq(e,t){for(let n=0;n<e.stops.length;n++)if(t===e.stops[n][0])return e.stops[n][1];return e.default}function Aq(e,t){for(var n=0;n<e.stops.length&&!(t<e.stops[n][0]);n++);return e.stops[Math.max(n-1,0)][1]}function yq(e,t){for(var n=dq(e.base)&&!pq(e.base)?e.base:1,i=0;!(i>=e.stops.length||t<=e.stops[i][0]);)i++;return 0===i?e.stops[i][1]:i===e.stops.length?e.stops[i-1][1]:wq(t,n,e.stops[i-1][0],e.stops[i][0],e.stops[i-1][1],e.stops[i][1])}"function"==typeof Map&&(uq=new Map);const _q={width:100,height:1};function vq(e,t){const n=e.stops;if(n&&n.length>1){let e;if(uq){const t=JSON.stringify(n);if(!uq.has(t)){const e=new an(n,_q);uq.set(t,e)}e=uq.get(t)}else e=new an(n,_q);const[i,s,o,a]=e.getColor(t);return[i/255,s/255,o/255,a/255]}return n&&1===n.length?n[0][1]:null}function xq(e,t){return i=e.default,dq(n=t)?n:dq(i)?i:dq(s)?s:null;var n,i,s}function bq(e,t){const n=String(e.property),i=e.expression,s=t;function o(t){return fq(t)||pq(t)||isNaN(t)?e.default:t}if(!dq(t)||pq(t)||isNaN(t)||t<0)return o(e.default);{const t=function e(t,n,i){const s=Number(i),o=String(n);return Array.isArray(t)?t.map((t=>e(t,o,s))):t===o?s:t}(i,n,s);return o(function t(n){if(!Array.isArray(n)){if("number"==typeof n)return n;throw new Error("Invalid expression format")}{const i=n[0];if(!["+","-","*","/"].includes(i))throw new Error(`Unknown operator: ${i}`);const s=n.slice(1).map((e=>t(e)));switch(i){case"+":return s.reduce(((e,t)=>e+t),0);case"-":return s.reduce(((e,t)=>e-t));case"*":return s.reduce(((e,t)=>e*t),1);case"/":return s.some((e=>0===e))?e.default:s.reduce(((e,t)=>e/t));default:throw new Error(`Unsupported operator: ${i}`)}}}(t))}}function wq(e,t,n,i,s,o){return"function"==typeof s?function(){var a=s.apply(void 0,arguments),l=o.apply(void 0,arguments);return wq(e,t,n,i,a,l)}:s.length?function(e,t,n,i,s,o){var a=[];for(let l=0;l<s.length;l++)a[l]=Tq(e,t,n,i,s[l],o[l]);return a}(e,t,n,i,s,o):Tq(e,t,n,i,s,o)}function Tq(e,t,n,i,s,o){var a,l=i-n,h=e-n;return s*(1-(a=1===t?h/l:(Math.pow(t,h)-1)/(Math.pow(t,l)-1)))+o*a}function Sq(e){return e&&"object"==typeof e&&(e.stops||e.property&&"identity"===e.type||e.expression&&"calculate-expression"===e.type)}function Mq(e){return Cq(e,"exponential")}function Cq(e,t){if(!Sq(e))return function(){return e};let n=!0,i=!0;const s=(e=JSON.parse(JSON.stringify(e))).stops;if(s)for(let e=0;e<s.length;e++)if(Sq(s[e][1])){const o=Cq(s[e][1],t);n=n&&o.isZoomConstant,i=i&&o.isFeatureConstant,s[e]=[s[e][0],o]}const o=gq(e,t);return o.isZoomConstant=n&&o.isZoomConstant,o.isFeatureConstant=i&&o.isFeatureConstant,o}const{getTextureMagFilter:Pq,getTextureMinFilter:Iq,getTextureWrap:kq,getMaterialType:Oq,getMaterialFormat:Eq,getPrimitive:Rq,getUniqueREGLBuffer:Lq,getArrayType:Dq}=CM.REGLHelper,Fq=[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1],Hq=[0,0,1,0,0,1,0,0,-1,0,0,0,0,0,0,1],{loginIBLResOnCanvas:Nq,logoutIBLResOnCanvas:Bq,getIBLResOnCanvas:zq,getPBRUniforms:Gq}=CM.pbr.PBRUtils,Uq={factor:0,units:0},Vq=[1,1,1,1],jq=[0,0,0],Wq={specularStrength:0,materialShininess:1},qq=[1,1,1],Zq=AA([]),Xq=[0,0,0],Yq=[0,0],Jq=[],Qq=e=>e.material instanceof CM.PhongMaterial,$q=e=>e.material instanceof CM.pbr.StandardMaterial,Kq=[],eZ=new fl(0,0),tZ=new Re(0,0),nZ=new Re(0,0),rZ=new Re(0,0),iZ=[],sZ=[],oZ=[],aZ=[],lZ=[],hZ=[],cZ=[],uZ=[],fZ=[],dZ=[],pZ=[],gZ=[],mZ=[],AZ=[],yZ={POSITION:"POSITION",NORMAL:"NORMAL",TEXCOORD_0:"TEXCOORD_0",TEXCOORD_1:"TEXCOORD_1",COLOR_0:"COLOR_0",TANGENT:"TANGENT",_BATCHID:"_BATCHID"},_Z=[0,1,1,2,2,3,3,0,0,4,1,5,2,6,3,7,4,5,5,6,6,7,7,4],vZ=function(e,t){const n=2*Math.PI/e,i=[],s=[];for(let t=0;t<=e;t++){const e=1*Math.cos(n*t),s=1*Math.sin(n*t),o=0;i[3*t]=e,i[3*t+1]=s,i[3*t+2]=o}for(let t=e;t<=200;t++){const e=1*Math.cos(n*t),s=1*Math.sin(n*t);i[3*t]=0,i[3*t+1]=e,i[3*t+2]=s}for(let e=200;e<=300;e++){const t=1*Math.cos(n*e),s=1*Math.sin(n*e),o=0;i[3*e]=t,i[3*e+1]=o,i[3*e+2]=s}const o=i.length/3-1;for(let e=0;e<o;e++)99!==e&&199!==e&&(s[2*e]=e,s[2*e+1]=e+1);return i.push(0,0,0),i.push(1,0,0),i.push(0,1,0),i.push(0,0,1),s.push(o+1,o+2),s.push(o+1,o+3),s.push(o+1,o+4),{vertices:i,indices:s}}(100),xZ=[0,0,0,1],bZ=[1,1,1];class vr{constructor(e,t){this.h=t,this.u=t.getRenderer().canvas,this.pickingFBO=t.getRenderer().pickingFBO,this.m=e,this.p=new CM.Renderer(e),this.v={},this.T={},this._={},this.M={},this.O={},this.A={},this.I=new CM.Scene,this.S=new CM.Scene,this.C=new CM.Scene,this.k=new CM.Scene,this.N=new CM.ResourceLoader(e.texture(2)),this.L=(...e)=>this.R.call(this,...e),this.P=new CM.KHRTechniquesWebglManager(this.m,this.U(),this.N);const n=this.getMap();this.B=n.altitudeToPoint(100,n.getGLRes())/100}getI3DMMeshes(){return this.M}getPNTSMeshes(){return this._}getB3DMMeshes(){return this.T}getPaintedMeshes(){return this.G}getMap(){return this.h.getMap()}paint(e,t,n){const i=n&&n.renderTarget,s=n&&n.sceneFilter,o=this.getMap();if(!e.length||!o)return null;const a=this.D(),l=o.projViewMatrix,h=[],c=[],u=[],f=[],g=[];for(let t=0,i=e.length;t<i;t++){const i=e[t].data.node;let s=this.F(i);if(!s)continue;const o=this.h.j(i.H),a=o.debugNodes,m=o.heightOffset||0,A=o.coordOffset||Yq;this.O[i.id]&&(s=this.O[i.id],s=Ej(s));let w=o.polygonOffset||Uq;bj(w)&&(w=w()),Array.isArray(s)||(h[0]=s,s=h);for(let h=0,T=s.length;h<T;h++){if(!s[h]||!s[h].isValid||!s[h].isValid())continue;const T=s[h].properties.magic;if(s[h].properties.heightOffset===m&&s[h].properties.coordOffset[0]===A[0]&&s[h].properties.coordOffset[1]===A[1]||(this.q(s[h]),s[h].$=mA([],s[h].localTransform)),s[h].V=i,"b3dm"===T){if(s[h].getBoundingBox&&!mV(l,s[h].getBoundingBox()))continue;const{batchIdData:e,batchIdMap:t}=s[h].geometry.properties;if(e&&t){const e=s[h].properties.node.H;this.J&&this.J[e]?Vk.highlightMesh(this.m,s[h],this.J[e],this.Y,t):this.J&&this.J[e]||Vk.highlightMesh(this.m,s[h],null,this.Y,t),Vk.showOnly(this.m,s[h],this.Z&&this.Z[e],this.K,t)}if(a&&a.length&&a.indexOf(s[h].V.id)<0)continue;n&&n.bloom&&s[h].properties.hlBloomMesh&&(s[h].properties.hlBloomMesh.properties.depthFunc="always",u.push(s[h].properties.hlBloomMesh)),u.push(s[h])}else"pnts"===T?f.push(s[h]):"i3dm"===T&&g.push(s[h]);s[h].properties.isLeaf=e[t].leave,s[h].properties.branchRootId=e[t].branchRootId;const S=255-e[t].selectionDepth;s[h].properties.selectionDepth=S,s[h].properties.polygonOffset=w;const M=void 0===o.cullFace||!!o.cullFace;s[h].properties.cullFace=M;const C=s[h].properties.hlBloomMesh;if(C){const n=C.properties;n.branchRootId=e[t].branchRootId,n.selectionDepth=S,n.polygonOffset=w,n.cullFace=M}e[t].leave||c.push(s[h]),this.X(s[h]),this.W(s[h],i)}}let m=0;const A=this.P.getExcludeFilter();nI.setIncludeUniformValues(a,n),m+=this.tt(this.et,a,[s,Qq,A],i,c,u,g),m+=this.tt(this.nt,a,[s,$q,A],i,c,u,g),this.P.forEachShader(((e,t,n)=>{const o=this.D(n);m+=this.tt(e,o,[s,t],i,c,u,g)})),this.S.setMeshes(f);const w=this.rt();return m+=this.p.render(this.st,w,this.S,i&&i.fbo),this.G={pntsMeshes:f,i3dmMeshes:g,b3dmMeshes:u},this.k.setMeshes(t),this.p.render(this.it,a,this.k,i&&i.fbo),m}prepareRender(e){this.ot(e)}ot(e){e&&e.states&&e.states.includesChanged&&(this.nt.dispose(),delete this.nt,this.et.dispose(),delete this.et),this.ct(e)}tt(e,t,n,i,s,o,a){e.filter=n.filter((e=>!!e)),t.stencilEnable=!1,t.cullFace="back";const l=i&&i.fbo;let h=0;const c=[],u=[];let f=!1,g=o[0]&&o[0].properties.branchRootId;for(let n=0;n<o.length;n++){const{branchRootId:i}=o[n].properties;i!==g&&(f?(u.length&&(h+=this.lt(e,t,l,!1,u),u.length=0),h+=this.lt(e,t,l,f,c)):Fj(u,c),g=i,f=!1,c.length=0),c.push(o[n]),o[n].properties.selectionDepth<255&&(f=!0),n===o.length-1&&(f||(Fj(u,c),c.length=0),u.length&&(h+=this.lt(e,t,l,!1,u)),h+=this.lt(e,t,l,f,c))}return this.I.setMeshes(o.filter((e=>e.properties.isLeaf))),this.C.setMeshes(a),h+=this.p.render(e,t,this.C,i&&i.fbo),h}lt(e,t,n,i,s){return s.length?(this.I.setMeshes(s),t.stencilEnable=!1,i&&(this.ht(n),t.stencilEnable=!1,t.cullFace="front",this.p.render(e,t,this.I,n),t.cullFace="back",t.stencilEnable=!0),this.p.render(e,t,this.I,n)):0}ht(e){this.m.clear({stencil:255,framebuffer:e})}getCurrentB3DMMeshes(){return this.I.getMeshes()}getCurrentI3DMMeshes(){return this.C.getMeshes()}ut(e,t){return t.V.ft-e.V.ft}deleteTile(e){const t=e.node;t.dt&&(t.dt.geometry.dispose(),t.dt.dispose(),delete t.dt);this.yt(t.id)}yt(e){const t=this.T[e]||this._[e]||this.M[e]||this.O[e]||this.v[e];this.O[e]?this.bt(e):t&&(this.gt(t),delete this.T[e],delete this._[e],delete this.M[e],delete this.v[e])}bt(e){let t=this.O[e];t=Ej(t);for(let e=0;e<t.length;e++){const{id:n}=t[e].properties;this.yt(n)}delete this.O[e]}gt(e){if(Array.isArray(e))for(let t=0,n=e.length;t<n;t++)this.gt(e[t]);else{Vk.showOnly(this.m,e),Vk.highlightMesh(this.m,e);const t=e.geometry.properties.url;if(t){const n=this.A[t];n&&n.refMeshes&&(n.refMeshes.delete(e.uuid),n.refMeshes.size||(n.geometry.dispose(),n.material.dispose(),delete this.A[t]))}else e.geometry.dispose(),e.material&&e.material.dispose();e.dispose()}}remove(){const e=this.h;Bq(e.getRenderer().canvas,e.getMap());for(const e in this.O)this.bt(e);this.O={};for(const e in this.T)this.yt(e);this.T={};for(const e in this._)this.yt(e);this._={};for(const e in this.M)this.yt(e);this.M={};for(const e in this.v)this.yt(e);this.v={},this.et&&(this.et.dispose(),delete this.et),this.nt&&(this.nt.dispose(),delete this.nt),this.st&&(this.st.dispose(),delete this.st),this.it&&(this.it.dispose(),delete this.it),this.P.dispose(),this.picking&&this.picking.dispose()}F(e){return this.T[e.id]||this._[e.id]||this.M[e.id]||this.O[e.id]}has(e){return this.F(e)||this.v[e.id]}q(e){const t=e.properties.magic;"b3dm"===t?this.wt(e):"i3dm"===t?this.vt(e):"pnts"===t&&this.Tt(e)}createPntsMesh(e,t,n,i){if(this._[t]){const e=this._[t];return console.warn(`pnts mesh with id(${t}) was already created.`),i(null,{id:t,mesh:e}),e}const{pnts:s,featureTable:o,rootIdx:a,compressed_int16_params:l}=e,h=o.POINTS_LENGTH;s.BATCH_ID||(s.BATCH_ID=new Uint8Array(h),s.BATCH_ID.fill(0));const c=new CM.Geometry(s,null,h,{static:!0,primitive:"points",positionAttribute:"POSITION",pickingIdAttribute:"BATCH_ID"});c.generateBuffers(this.m);const u={};s.POSITION?u.HAS_POSITION=1:s.POSITION_QUANTIZED&&(u.HAS_POSITION_QUANTIZED=1),s.RGB?u.HAS_RGB=1:s.RGBA?u.HAS_RGBA=1:s.RGB565&&(u.HAS_RGB565=1),(s.NORMAL||s.NORMAL_OCT16P)&&(u.HAS_NORMAL=1,s.NORMAL_OCT16P&&(u.HAS_NORMAL_OCT16P=1)),this._t(u,l),e.featureTable.CONSTANT_RGBA&&(e.featureTable.CONSTANT_RGBA=e.featureTable.CONSTANT_RGBA.map((e=>e/255)));const{rtcCenter:f,rtcCoord:g,projCenter:m}=e,A=this.h.j(a),w=new CM.Mesh(c);w.properties.magic="pnts",w.properties.id=t,w.properties.node=n,w.properties.count=h,w.properties.batchTable=e.batchTable,w.properties.batchTableBin=e.batchTableBin,w.properties.serviceIndex=a,w.properties.rtcCoord=g,w.properties.rtcCenter=f,w.properties.projCenter=m,w.setDefines(u),w.setFunctionUniform("pointColor",(function(){return e.featureTable.CONSTANT_RGBA?e.featureTable.CONSTANT_RGBA:A&&A.pointColor||[1,1,1,1]}));const T=this.getMap();let S=null,M=null;w.setFunctionUniform("pointSize",(function(){if(!A)return 2;if(Sq(A.pointSize)){const e=JSON.stringify(A.pointSize);return e!==S&&(M=Mq(A.pointSize),S=e),M(T.getZoom())}return A.pointSize||2}));let C=null,I=null;return w.setFunctionUniform("pointOpacity",(function(){if(!A)return 1;if(Sq(A.pointOpacity)){const e=JSON.stringify(A.pointOpacity);return e!==C&&(I=Mq(A.pointOpacity),C=e),I(T.getZoom())}return A.pointOpacity||1})),this.Mt(w,l),this.Tt(w),w.$=mA([],w.localTransform),this._[t]=w,i(null,{id:t,mesh:[w]}),[w]}Tt(e){const t=e.localTransform||[],{rtcCoord:n,node:i,projCenter:s}=e.properties;this.Ot(t,n,s,i.H),e.setLocalTransform(t)}createI3DMMesh(e,t,n,i){if(this.M[t]){const e=this.M[t];return console.warn(`i3dm mesh with id(${t}) was already created.`),this.v[t]||i(null,{id:t,mesh:e}),e}const s=this.h.j(n.H),o=this.At(n.xt),{i3dm:a,featureTable:l,gltf:h,batchTable:c,batchTableBin:u,count:f}=e,g=l.INSTANCES_LENGTH,{rtcCenter:m,rtcCoord:A,projCenter:w}=e,T=this.It(aZ,n,m,A);JW(T,Xq,T);const S=OA(lZ,T);C_(S,S);const M=kA(hZ,T),C=SA(cZ,M),I=this.St(uZ,w,n),E=this.Ct(pZ),D=this.kt(gZ,A),H=py(mZ,D,E),N=SA(AZ,H),{POSITION:B,NORMAL_UP:z,NORMAL_RIGHT:U,SCALE:j,SCALE_NON_UNIFORM:W}=a,q={instance_vectorA:new Float32Array(4*g),instance_vectorB:new Float32Array(4*g),instance_vectorC:new Float32Array(4*g),aPickingId:new Uint16Array(g)};for(let e=0;e<g;e++)q.aPickingId[e]=e;const Z=new Float32Array(3),X=new Float32Array(3),Y=[],J=new Float32Array(1),Q=new Float32Array(3),$=[],K=[],ee=[],te=[];!function(e,t){let{byteOffset:n,byteStride:i,count:s}=e;const{componentType:o,itemSize:a}=e,l=e.array.buffer,h=o?Jj.getTypedArrayCtor(o):e.array.constructor;if(n=void 0===n?e.array.byteOffset:n,i=i||0,s=s||e.array.length/a,(!i||i===a*h.BYTES_PER_ELEMENT)&&n%h.BYTES_PER_ELEMENT==0){const e=new h(l,n,s*a);for(let i=0;i<s*a;i+=a)t(new h(e.buffer,n+i*h.BYTES_PER_ELEMENT,a),i/a);return}const c=new Uint8Array(a*h.BYTES_PER_ELEMENT);i||(i=a*h.BYTES_PER_ELEMENT);for(let e=0;e<s;e++){const s=new Uint8Array(l,i*e+n,a*h.BYTES_PER_ELEMENT);c.set(s),t(new h(c.buffer),e),s.set(c)}}(B,((e,t)=>{z?(sW(X,U,t),sW(Z,z,t),sy(Y,X,Z),ry(Y,Y),Oj($,X,0),Oj($,Z,1),Oj($,Y,2),o_(K,$),C_(K,K),Ky(K,S,K)):Qy(K),j?(sW(J,j,t),ZA(ee,J[0],J[0],J[0])):W?(sW(Q,W,t),ZA(ee,...Q)):ZA(ee,1,1,1),EA(te,K,e,ee),oW(q.instance_vectorA,t,te,0),oW(q.instance_vectorB,t,te,1),oW(q.instance_vectorC,t,te,2)}));const re={};for(const e in q)re[e]={buffer:this.m.buffer({dimension:q[e].length/g,data:q[e],name:e}),divisor:1};const se=s.shader||"pbr";let oe=0,le=!0;const he=[],ue=[];return Qj(h,((e,i,s,a)=>{const h=this.Nt(e,i,s,a,n,!0,se,ue),{geometry:S,material:M}=h;M&&!M.isReady()&&(le=!1,oe++);const E=new CM.InstancedMesh(re,g,S,M);h.refMeshes||(h.refMeshes=new Set,h.refMeshes.add(E.uuid)),E.properties.magic="i3dm",E.properties.id=t,E.properties.count=f,E.properties.batchTable=c,E.properties.batchTableBin=u,E.properties.serviceIndex=n.H,E.properties.rtcCoord=A,E.properties.rtcCenter=m,E.properties.projCenter=w,E.properties.node=n;const D=this.Lt(e,S,M,n.H,a);e.compressed_int16_params&&this.Mt(E,e.compressed_int16_params),this.Et(E,e.attributes);const H=AA([]);if(e.matrices&&e.matrices.length)for(let t=0;t<e.matrices.length;t++)vA(H,H,e.matrices[t]);vA(H,o,H),vA(H,N,H),vA(H,l.EAST_NORTH_UP||z?C:T,H),E.setPositionMatrix(H),this.vt(E,I),E.setDefines(D),E.properties.polygonOffset={offset:0,factor:0},he.push(E),delete e.attributes,E.$=mA([],E.localTransform)})),wZ(ue),le?(this.M[t]=he,i(null,{id:t,mesh:he})):(this.v[t]={meshes:he,count:oe},he.Rt=i),he}vt(e,t){const{rtcCoord:n,node:i,projCenter:s}=e.properties;t||(t=this.St(uZ,s,i));const o=this.h.j(i.H),a=e.localTransform||[];if(o.coordOffset){vA(a,this.Pt(aZ,i.H,n),t)}else mA(a,t);e.setLocalTransform(a),e.properties.heightOffset=o.heightOffset||0,e.properties.coordOffset=o.coordOffset&&o.coordOffset.slice(0)||Yq}St(e,t,n){SA(e,this.Ct(pZ));const i=this.Ut(sZ,t,n.H);return vA(e,TA(fZ,i),e),e}createB3DMMesh(e,t,n,i){if(e.gltf&&(e.gltf.transferables=null),this.T[t]||this.v[t]){const e=this.T[t];return console.warn(`mesh with id(${t}) was already created.`),this.v[t]||i(null,{id:t,mesh:e}),e}let s;if(n.maxExtent){const e=new Ml(n.maxExtent).convertTo((e=>this._pointToPrj(e)));s=[e.xmin,e.ymin,e.xmax,e.ymax]}const o=e.gltf,{projCenter:a}=o.extensions.MAPTALKS_RTC,{rtcCoord:l,center:h}=o.extensions.CESIUM_RTC,c=o.asset.sharePosition,u=this.At(n.xt),f=this.Bt(uZ,c,l,h,a,n),g=this.h.j(n.H);let m=g.shader||"pbr";if(g.unlit)m="phong";else if(o.materials)for(let e=0;e<o.materials.length;e++)if(o.materials[e]&&o.materials[e].extensions&&o.materials[e].extensions.KHR_materials_unlit){m="phong";break}const A=[],w=[];let T=0,S=!0;return Qj(o,((i,o,M,C)=>{const I=this.Nt(i,o,M,C,n,!1,m,A),{geometry:E,material:D}=I;D&&!D.isReady()&&(S=!1,T++);const H=new CM.Mesh(E,D);I.refMeshes||(I.refMeshes=new Set,I.refMeshes.add(H.uuid)),H.properties.magic="b3dm",H.properties.id=t,H.properties.node=n,e.batchTable&&(H.properties.batchTable=e.batchTable,H.properties.batchTableBin=e.batchTableBin),H.properties.count=e.featureTable&&e.featureTable.BATCH_LENGTH||0,H.properties.serviceIndex=n.H;const N=this.Lt(i,E,D,n.H,C);H.setDefines(N);const B=i.compressUniforms;if(B)for(const e in B)H.setUniform(e,B[e]);i.compressed_int16_params&&this.Mt(H,i.compressed_int16_params),this.Et(H,i.attributes),s&&(N.USE_MAX_EXTENT=1,H.setUniform("maxPrjExtent",s)),H.hasFunctionUniform("polygonOpacity")||H.setFunctionUniform("polygonOpacity",(function(){return Tj(g.opacity)?g.opacity:1})),H.hasFunctionUniform("polygonFill")||H.setFunctionUniform("polygonFill",(function(){return Nj([],g.polygonFill||Vq)})),H.material.hasFunctionUniform("hsv")||H.material.setFunctionUniform("hsv",(function(){return g.hsv||jq}));const z=AA([]);if(c&&i.matrices&&i.matrices.length)for(let e=0;e<i.matrices.length;e++)vA(z,z,i.matrices[e]);c&&vA(z,u,z),H.properties.node=n,H.properties.projCenter=a,H.properties.nodeMatrix=z,H.properties.isSharedPosition=c,H.properties.rtcCoord=l,H.properties.rtcCenter=h,this.wt(H,f),w.push(H),delete i.attributes,H.$=mA([],H.localTransform)})),wZ(A),S?(this.T[t]=w,i(null,{id:t,mesh:w})):(this.v[t]={meshes:w,count:T},w.Rt=i),w}Gt(e){const t=this.h.Dt(e.id);if(!t||e.dt)return;let n,i,s,o;if(t.obbox)n=t.boxPosition,i=_Z,s=t.boxCenter,o=bZ;else if(t.sphereBox){const e=t.sphereBox[1];n=vZ.vertices,i=vZ.indices,s=t.sphereBox[0],o=[e,e,e]}const a=new CM.Geometry({POSITION:n},i,0,{primitive:"lines",positionAttribute:"POSITION"}),l=new CM.Mesh(a,new CM.Material({lineColor:[.8,.8,.1,1],lineOpacity:1})),h=[];EA(h,xZ,s,o),l.localTransform=h,l.$=mA([],h),l.properties.node=e,e.dt=l}Ft(e){e.dt&&(e.dt.geometry.dispose(),e.dt.dispose(),delete e.dt)}Mt(e,t){t.POSITION&&e.setUniform("compressedPositionRange",t.POSITION),t.TEXCOORD_0&&e.setUniform("compressedTexcoordRange_0",t.TEXCOORD_0),t.TEXCOORD_1&&e.setUniform("compressedTexcoordRange_1",t.TEXCOORD_0),t.NORMAL&&e.setUniform("compressedNormalRange",t.NORMAL),t.TANGENT&&e.setUniform("compressedTangentRange",t.TANGENT),t.compressed_ratio&&e.setUniform("compressed_ratio",t.compressed_ratio)}wt(e,t){const{isSharedPosition:n,rtcCoord:i,rtcCenter:s,projCenter:o,nodeMatrix:a,node:l}=e.properties;t||(t=this.Bt(t||uZ,n,i,s,o,l));const h=e.localTransform||AA([]);vA(h,t,a);const c=this.h.j(l.H);if(c.coordOffset){vA(h,this.Pt(aZ,l.H,i),h)}e.setLocalTransform(h),e.properties.heightOffset=c.heightOffset||0,e.properties.coordOffset=c.coordOffset&&c.coordOffset.slice(0)||Yq}Bt(e,t,n,i,s,o){if(t){const t=this.kt(gZ,n),s=SA(oZ,t);vA(e,this.It(aZ,o,i,n),s)}else this.Ot(e,n,s,o.H);return e}Et(e,t){if(t&&t.TEXCOORD_0&&t.TEXCOORD_0.extensions&&t.TEXCOORD_0.extensions.WEB3D_quantized_attributes){e.setUniform("decodeMatrix",t.TEXCOORD_0.extensions.WEB3D_quantized_attributes.decodeMatrix)}}It(e,t,n,i){const s=this.getMap(),o=this.h.j(t.H).heightOffset||0,a=t.matrix?mA(e,t.matrix):AA(e);n&&JW(a,oy(Kq,n,a),a);const l=function(e,t,n,i,s,o,a){t=qA($W,t);const l=uW($W,t[0]*aq,t[1]*aq,t[2]),h=PA(KW,n),c=i.ellipsoid;let u;u=0===Ay(h)?ZA(eq,0,0,-6378137):AW(eq,h),sq.x=u[0],sq.y=u[1];const f=i.project(sq,oq);tq[0]=f.x/s,tq[1]=f.y/s,tq[2]=(u[2]+a)*o;const g=QW(l,c,nq);return JW(function(e,t,n){const i=e[0],s=e[1],o=e[2],a=e[4],l=e[5],h=e[6],c=e[8],u=e[9],f=e[10],g=t[0],m=t[1],A=t[2],w=t[3],T=t[4],S=t[5],M=t[6],C=t[7],I=t[8],E=s*g+l*m+u*A,D=o*g+h*m+f*A,H=i*w+a*T+c*S,N=s*w+l*T+u*S,B=o*w+h*T+f*S,z=i*M+a*C+c*I,U=s*M+l*C+u*I,j=o*M+h*C+f*I;return n[0]=i*g+a*m+c*A,n[1]=E,n[2]=D,n[3]=0,n[4]=H,n[5]=N,n[6]=B,n[7]=0,n[8]=z,n[9]=U,n[10]=j,n[11]=0,n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}(_A(rq,g),oA(iq,n),e),tq,e),e}(a,i,a,s.getProjection(),s.getGLRes(),this.B,o),h=function(e,t){return ZA(e,t[12],t[13],t[14]),e}(sZ,l);let c=this.h.options.offset;if(bj(c)){const e=this.h.Dt(t.id).boxCoord;c=c.call(this.h,e)}return ZA(iZ,c[0],c[1],0),fy(h,h,iZ),JW(l,h,l),l}Pt(e,t,n){const i=this.h.j(t);if(!i.coordOffset)return null;const s=this.getMap(),o=s.getGLRes();eZ.set(n[0],n[1]);const a=s.coordToPointAtRes(eZ,o,nZ),l=i.coordOffset,h=eZ.set(n[0]+l[0],n[1]+l[1]),c=s.coordToPointAtRes(h,o,rZ);return TA(e,ZA(iZ,c.x-a.x,c.y-a.y,(l[2]||0)*this.B))}createCMPTMesh(e,t,n,i){if(this.O[t]){const e=this.O[t];return console.warn(`mesh with id(${t}) was already created.`),i(null,{id:t,mesh:e}),e}const{content:s}=e,o=[];for(let e=0;e<s.length;e++){const{magic:i}=s[e],a=t+"."+e;"b3dm"===i?this.createB3DMMesh(s[e],a,n,((e,{mesh:t})=>{o.push(t)})):"i3dm"===i?this.createI3DMMesh(s[e],a,n,((e,{mesh:t})=>{o.push(t)})):"pnts"===i?this.createPntsMesh(s[e],a,n,((e,{mesh:t})=>{o.push(t)})):"cmpt"===i&&this.createCMPTMesh(s[e],a,n,((e,{mesh:t})=>{o.push(t)}))}return this.O[t]=o,i(null,{id:t,mesh:o}),o}Lt(e,t,n,i,s){const o=("phong"===(this.h.j(i).shader||"pbr")?this.et:this.nt).getGeometryDefines(t);return s.asset&&"S3M"===s.asset.generator&&this.jt(o,t),t.data.uvRegion&&(o.HAS_I3S_UVREGION=1),t.data[t.desc.normalAttribute]&&(o.VertexNormal=1),t.data[t.desc.color0Attribute]&&(o.VertexColor=1),t.data[t.desc.uv0Attribute]&&(o.TexCoord=1),t.data[t.desc.textureCoordMatrixAttribute]&&(o.HAS_TextureCoordMatrix=1),n.get("uTexture")&&(o.COMPUTE_TEXCOORD=1),n.get("uTexture2")&&(o.TexCoord2=1),"MESHOPT"===this.h.zt&&(o.MeshOPT_Compress=1),this.hasIBL()&&(o.HAS_IBL_LIGHTING=1),e.attributes&&e.attributes.TEXCOORD_0&&"WEB3D_quantized_attributes"===e.attributes.TEXCOORD_0.extensions&&(o.HAS_WEB3D_quantized_attributes_TEXCOORD=1),o.HAS_MIN_ALTITUDE=1,this._t(o,e.compressed_int16_params),xj(o,e.compressDefines),o}_t(e,t){t&&Object.keys(t).length>0&&(e.HAS_COMPRESSED_INT16=1,t.POSITION&&(e.HAS_COMPRESSED_INT16_POSITION=1),t.TEXCOORD_0&&(e.HAS_COMPRESSED_INT16_TEXCOORD_0=1),t.TEXCOORD_1&&(e.HAS_COMPRESSED_INT16_TEXCOORD_1=1),t.NORMAL&&(e.HAS_COMPRESSED_INT16_NORMAL=1),t.TANGENT&&(e.HAS_COMPRESSED_INT16_TANGENT=1),t.compressed_ratio&&(e.HAS_COMPRESSED_INT16_RATIO=1))}X(e){const t=this.h.getRenderer();t&&t.updateMaskDefines(e)}jt(e,t){t.data.aNormal&&(e.VertexNormal=1),t.data.instanceId&&(e.Instance=1),t.data.aTexCoord0&&(e.TexCoord=1),t.data.aColor&&(e.VertexColor=1),t.data.aTexCoord1&&(e.TexCoord2=1),t.data.uv2&&(e.InstanceBim=1)}Nt(e,t,n,i,s,o,a,l){let h=!1;i.asset&&"S3M"===i.asset.generator&&(h=!0,i.extensions=i.extensions||{});const c=i.url+"-"+t+"-"+n;if(this.A[c])return this.A[c];let u,f;l.push(e);const g=i.materials&&i.materials[e.material],m=i.extensions&&i.extensions.KHR_techniques_webgl,A=this.h.j(s.H);if(m&&g.extensions&&g.extensions.KHR_techniques_webgl){if(this.getMap().getRenderer().isWebGPU())throw new Error("3dtiles with KHR_techniques_webgl extension is not supported in webgpu");const t=this.Ht(e,i,o,h);u=t.material,f=t.geometry,A.fillEmptyDataInMissingAttribute&&(f.desc.fillEmptyDataInMissingAttribute=!0)}else{f=this.qt(e,o,yZ);u=this.$t(e.material,i,a,A.material||Wq,l,A)}u&&(u.setFunctionUniform("alphaTest",(function(){const e=A.alphaTest;return vj(e)?.1:e})),u.setFunctionUniform("environmentExposure",(()=>{const e=A.ambientLight;let t=A.environmentExposure;const n=this.getMap().getLightManager(),i=n&&n.getAmbientLight();if(e&&(!i||i.color)&&void 0===t){t=e[0]/(i&&i.color?i.color[0]:.2)}return t||1}))),u&&!u.isReady()?u.Vt=s.id:u||(u=new CM.PhongMaterial({baseColorFactor:[1,1,1,1]}));const w={geometry:f,material:u};return f.properties.url=c,this.A[c]=w,w}Ht(e,t,n,i){const{geometry:s,material:o}=this.P.createMesh(e,t,n,i);return{geometry:s,material:o}}qt(e,t,n){const i=e.attributes,s="COLOR_0";let o=i._BATCHID&&i._BATCHID.array;if(o&&o.byteOffset&&(o=new o.constructor(o)),i[s]){const e=i[s].array||i[s];if(e instanceof Float32Array){const t=new Uint8Array(e.length);for(let n=0;n<t.length;n++)t[n]=Math.round(255*e[n]);i[s].array?(i[s].array=t,i[s].componentType=5121):i[s]=t}}const a=this.getMap().getRenderer().isWebGPU(),l={};let h=0,c=0;for(const e in i){const t=n[e]||e,s=t===n.POSITION;if(s&&(h=i[e].itemSize),a){const t=i[e].array,n=CM.Geometry.padGPUBufferAlignment(i[e].array,i[e].count);if(t!==n){s&&(h+=1),i[e].array=n,i[e].byteLength=n.byteLength,i[e].itemSize+=1;const t=i[e].type;i[e].type=t.substring(0,t.length-1)+i[e].itemSize}}const o=Lq(this.m,i[e],{dimension:i[e].itemSize,name:e});l[t]=xj({},i[e]),l[t].buffer=o,l[t].type=Dq(l[t].array),delete l[t].array,t===n.POSITION&&(l[t].array=i[e].array,c=i[e].array.length/3)}const u=n._BATCHID;if(!l[u]&&!t){const e=new Uint8Array(c);l[u]=e}const f=e.indices?e.indices.array?e.indices.array.slice():e.indices:null,g=new CM.Geometry(l,f,0,{positionSize:h,positionAttribute:n.POSITION,normalAttribute:n.NORMAL,uv0Attribute:n.TEXCOORD_0,uv1Attribute:n.TEXCOORD_1,color0Attribute:n.COLOR_0,tangentAttribute:n.TANGENT,pickingIdAttribute:n._BATCHID,primitive:void 0===e.mode?"triangles":Rq(e.mode)});return o&&f&&(g.properties.batchIdData=o,g.properties.batchIdMap=function(e,t){if(!t)return null;const n=new Map;for(let i=0;i<t.length;i++){const s=t[i],o=e[s];let a=n.get(o);a||(a=[],n.set(o,a)),a.push(s)}return n}(o,f)),g.generateBuffers(this.m,{excludeElementsInVAO:t}),g}Ot(e,t,n,i){const s=AA(e),o=this.Ct(qq);return this.Ut(sZ,n,i),xA(s,s,sZ),bA(s,s,o),s}Ut(e,t,n){const i=this.B;eZ.x=t[0],eZ.y=t[1];const s=this._prjToPoint(eZ);let o=this.h.options.offset;bj(o)&&(o=o.call(this.h,eZ));const a=this.h.j(n).heightOffset||0;return ZA(e,s.x-o[0],s.y-o[1],i*t[2]+i*a),e}W(e,t){const n=this.h.Jt(dZ,t);e.localTransform=vA(e.localTransform,n,e.$)}kt(e,t){const n=this.getMap();eZ.x=t[0],eZ.y=t[1];const i=n.distanceToPointAtRes(100,100,n.getGLRes(),eZ);return ZA(e,i.x/100,i.y/100,this.B),e}ct(e){if(this.nt)return;const t=[],n=[];this.st=new CM.MeshShader({vert:aW,frag:"#define SHADER_NAME PNTS\n\nprecision mediump float;\n\n\n\nuniform float layerOpacity;\n\nvarying vec4 vColor;\n\n\n\nvoid main() {\n\n    vec2 circCoord = 2.0 * gl_PointCoord - 1.0;\n\n    if (dot(circCoord, circCoord) > 1.0) {\n\n        discard;\n\n    } else {\n\n        gl_FragColor = vColor;\n\n    }\n\n    #ifdef HAS_LAYER_OPACITY\n\n        gl_FragColor *= layerOpacity;\n\n    #endif\n\n}\n\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(e,t)=>vA(n,t.projViewMatrix,t.modelMatrix)},{name:"modelNormalMatrix",type:"function",fn:(e,n)=>oA(t,n.modelMatrix)}],extraCommandProps:{viewport:{x:0,y:0,width:()=>this.u?this.u.width:1,height:()=>this.u?this.u.height:1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},depth:{enable:!0,func:"<"}}});const i={},s=[];nI.fillIncludes(i,s,e);const o=this.U();this.et=new CM.PhongShader({uniforms:s,defines:i,extraCommandProps:o}),this.nt=new CM.pbr.StandardShader({uniforms:s,defines:i,extraCommandProps:o}),this.it=new CM.EdgeShader({extraCommandProps:{viewport:{x:0,y:0,width:()=>this.u?this.u.width:1,height:()=>this.u?this.u.height:1},blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}});const a=this.h;Nq(a.getRenderer().canvas,this.m,a.getMap()),this.picking=new CM.FBORayPicking(this.p,{vert:"#include <gl2_vert>\n\n#define SHADER_NAME GEO_3DTILES_PICKING\n\n\n\nattribute vec3 aPosition;\n\n\n\n#if defined(HAS_COLOR)\n\n    attribute vec4 aColor;\n\n#endif\n\n#if defined(HAS_COLOR0)\n\n    #if COLOR0_SIZE == 3\n\n        attribute vec3 aColor0;\n\n        varying vec3 vColor0;\n\n    #else\n\n        attribute vec4 aColor0;\n\n        varying vec4 vColor0;\n\n    #endif\n\n#endif\n\n\n\n\n\nuniform mat4 modelMatrix;\n\nuniform mat4 modelViewMatrix;\n\nuniform mat4 positionMatrix;\n\nuniform mat4 projMatrix;\n\n\n\n#include <line_extrusion_vert>\n\n#include <get_output>\n\n\n\n#include <fbo_picking_vert>\n\nvoid main() {\n\n    mat4 localPositionMatrix = getPositionMatrix();\n\n    vec4 localVertex = getPosition(aPosition);\n\n\n\n    vec4 position = localPositionMatrix * localVertex;\n\n    vec4 viewVertex = modelViewMatrix * position;\n\n\n\n    #ifdef HAS_MASK_EXTENT\n\n        gl_Position = projMatrix * getMaskPosition(position, modelMatrix);\n\n    #else\n\n        gl_Position = projMatrix * viewVertex;\n\n    #endif\n\n\n\n    float alpha = 1.0;\n\n    #if defined(HAS_COLOR)\n\n        alpha *= aColor.a;\n\n    #endif\n\n    #if defined(HAS_COLOR0) && COLOR0_SIZE == 4\n\n        alpha *= aColor0.a;\n\n    #endif\n\n\n\n    fbo_picking_setData(gl_Position.w, alpha != 0.0);\n\n\n\n\n\n}\n\n",extraCommandProps:o,uniforms:this.nt.uniforms,defines:{PICKING_MODE:1,ENABLE_PICKING:1,HAS_PICKING_ID:1}},this.pickingFBO,this.getMap()),this.Yt=new CM.FBORayPicking(this.p,{vert:aW,extraCommandProps:o,uniforms:this.st.uniforms,defines:{PICKING_MODE:1,ENABLE_PICKING:1,HAS_PICKING_ID:1}},this.pickingFBO,this.getMap())}U(){return{viewport:{x:0,y:0,width:()=>this.u?this.u.width:1,height:()=>this.u?this.u.height:1},cull:{enable:(e,t)=>t.meshProperties.cullFace,face:(e,t)=>t.cullFace||"back"},stencil:{enable:(e,t)=>t.stencilEnable,func:{cmp:"<=",ref:(e,t)=>t.meshProperties.selectionDepth},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,func:(e,t)=>t.meshProperties.depthFunc||"<="},blend:{enable:!0,func:{src:1,dst:"one minus src alpha"},equation:"add"},polygonOffset:{enable:!0,offset:(e,t)=>t.meshProperties.polygonOffset}}}rt(e){const t=this.getMap(),n=t.getLightManager(),i=(n&&n.getDirectionalLight()||{}).direction||[1,1,-1],s=e&&e.pointOpacity||1;let o=this.h.options.opacity;return o=vj(o)?1:o,{projViewMatrix:t.projViewMatrix,pointOpacity:s,lightDir:ry(Jq,i),layerOpacity:o}}D(){const e=this.getMap(),t=this.h,n=t.getRenderer().canvas,{iblTexes:i,dfgLUT:s}=zq(n),o=Gq(e,i,s),a=this.h.getRenderer().getMaskUniforms();o.minAltitude=t.options.altitude||0;let l=t.options.opacity;return l=vj(l)?1:l,o.layerOpacity=l,xj(o,{czm_lightDirectionEC:o.light0_viewDirection,lightSpecular:[1,1,1],viewMatrix:e.viewMatrix,projMatrix:e.projMatrix,projViewMatrix:e.projViewMatrix,outSize:[n.width,n.height],polygonFill:[1,1,1,1],polygonOpacity:1}),o.ambientColor||(o.ambientColor=[.2,.2,.2]),xj(o,a),o}$t(e,t,n,i,s,o){const a=t.materials&&t.materials[e];if(!a||!a.baseColorTexture&&!a.pbrMetallicRoughness)return null;const l=xj({},i);if(a.baseColorTexture){const e=t.textures[a.baseColorTexture.index];let n;e&&!e.image.color&&(n=this.Zt(e,s)),l.baseColorFactor=e&&e.image.color||a.baseColorFactor||[1,1,1,1],n&&(l.baseColorTexture=n)}else{if(a.normalTexture){const e=this.Zt(t.textures[a.normalTexture.index],s);if(e){const t=a.normalTexture.scale||1;l.normalTexture=e,l.normalMapFactor=t}}if(a.occlusionTexture){const e=this.Zt(t.textures[a.occlusionTexture.index],s);if(e){const t=a.occlusionTexture.strength||1;l.occlusionTexture=e,l.occlusionFactor=t}}if(a.emissiveTexture){const e=this.Zt(t.textures[a.emissiveTexture.index],s);e&&(l.emissiveTexture=e)}a.emissiveFactor&&(l.emissiveFactor=a.emissiveFactor);const e=a.pbrMetallicRoughness;if(e){if(e.baseColorFactor&&(l.baseColorFactor=e.baseColorFactor),e.baseColorTexture&&void 0!==e.baseColorTexture.index){const n=t.textures[e.baseColorTexture.index];if(n&&n.image&&n.image.color)l.baseColorFactor=l.baseColorFactor?Py(l.baseColorFactor,l.baseColorFactor,n.image.color):n.image.color;else{const e=this.Zt(n,s);e&&(l.baseColorTexture=e,l.baseColorTexture.getREGLTexture(this.m))}}if(vj(e.metallicFactor)||(l.metallicFactor=e.metallicFactor),vj(e.roughnessFactor)||(l.roughnessFactor=e.roughnessFactor),a.metallicRoughnessTexture){const e=this.Zt(t.textures[a.metallicRoughnessTexture.index],s);e&&(l.metallicRoughnessTexture=e)}}}if(a.s3mMaterial)return new CM.Material(l);if(o.unlit||a.extensions&&a.extensions.KHR_materials_unlit){const e=new CM.PhongMaterial(l);return e.unlit=void 0===o.unlit||!!o.unlit,e}let h=new CM.pbr.StandardMaterial(l);"phong"===n&&(h=CM.PhongMaterial.convertFrom(h));const c=a.pbrMetallicRoughness,u=c&&c.baseColorTexture&&c.baseColorTexture.extensions;return u&&u.KHR_texture_transform&&(h.set("khr_offset",u.KHR_texture_transform.offset||[0,0]),h.set("khr_rotation",u.KHR_texture_transform.rotation||0),h.set("khr_scale",u.KHR_texture_transform.scale||[1,1])),h.doubleSided=!(!o.doubleSided&&!a.doubleSided),h.once("complete",this.L),h}Zt(e,t){if(!e)return null;const n={type:e.type?Oq(e.type):"uint8",format:e.format?Eq(e.format):"rgba",flipY:!!e.flipY},i=e.image;if(t.push(i),i.array?n.data=i.array:i.mipmap&&(n.mipmap=i.mipmap),!n.data&&!n.mipmap)return null;if(n.width=i.width,n.height=i.height,n.mipmap&&(n.width<4||n.height<4))return null;const s=e.sampler||e.texture&&e.texture.sampler;return s&&(s.magFilter&&(n.mag=Pq(s.magFilter)),s.minFilter&&(n.min=Iq(s.minFilter)),s.wrapS&&(n.wrapS=kq(s.wrapS)),s.wrapT&&(n.wrapT=kq(s.wrapT))),new CM.Texture2D(n,this.N)}R({target:e}){const t=e.Vt,n=this.v[t];if(n.count--,!n.count){const e=n.meshes;this.T[t]=e,delete this.v[t];const i=e.Rt;delete e.Rt,i(null,{mesh:n.meshes,id:t})}}Ct(e){const t=1/this.getMap().getGLRes(),n=this.B;return e[0]=e[1]=t,e[2]=n,e}Kt(e){return this.h.Kt(e)}_pointToPrj(e){const t=this.getMap();return t.getGLZoom?t._pointToPrj(e,t.getGLZoom()):t._pointToPrjAtRes(e,t.getGLRes())}_prjToPoint(e){const t=this.getMap();return t.getGLZoom?t._prjToPoint(e,t.getGLZoom()):t._prjToPointAtRes(e,t.getGLRes(),tZ)}At(e){return"Y"===e?Fq:"X"===e?Hq:Zq}pick(e,t,n=3){const i=this.h;if(!i||!i.options.picking)return[];if(!this.pickingFBO||!this.picking)return[];const s=[],o=this.D(),a=this.Xt(this.picking,o,this.I,e,t,n);a&&s.push(a);const l=this.Xt(this.picking,o,this.C,e,t,n);l&&s.push(l);const h=this.rt(),c=this.Xt(this.Yt,h,this.S,e,t,n);return c&&s.push(c),s}Xt(e,t,n,i,s,o){if(!n.getMeshes().length)return null;const a=this.h,l=this.getMap();e.render(n.getMeshes().filter((e=>!e.bloom)),t,!0);let h={};e.getRenderedMeshes().length&&(h=e.pick(i,s,o,t,{viewMatrix:l.viewMatrix,projMatrix:l.projMatrix,returnPoint:a.options.pickingPoint}));const{meshId:c,pickingId:u,point:f,coordinate:g}=h,m=(0===c||c)&&e.getMeshAt(c);if(!m||!m.geometry)return null;const A=m.properties;f&&f.length&&(f[0]=Math.round(1e5*f[0])/1e5,f[1]=Math.round(1e5*f[1])/1e5,f[2]=Math.round(1e5*f[2])/1e5);const w={batchId:u},T=a.options.services,S=T&&T[m.properties.serviceIndex];if(S&&S.debug&&(w.debugInfo=A),A&&A.batchTable){const{batchTable:e,batchTableBin:t,count:n}=A,i=u;for(const s in e)w[s]=void 0!==e[s].byteOffset?LW(e[s],t,n,i):e[s][i]}return{service:m.properties.serviceIndex,data:w,point:f,coordinate:g}}highlight(e){this.J=e;const t=this.h.getRenderer();this.Y=t.getFrameTimestamp(),t.setToRedraw(!0)}cancelAllHighlight(){this.J=null;const e=this.h.getRenderer();this.Y=e.getFrameTimestamp(),e.setToRedraw(!0)}showOnly(e){this.Z=e;const t=this.h.getRenderer();this.K=t.getFrameTimestamp(),t.setToRedraw(!0)}cancelShowOnly(){this.Z=null;const e=this.h.getRenderer();this.K=e.getFrameTimestamp(),e.setToRedraw(!0)}Wt(){if(!this.G)return[];const e={},t=[];for(const n in this.G){const i=this.G[n];if(i)for(let n=0;n<i.length;n++){const s=i[n],o=s&&s.geometry;if(!s||!o)continue;const a=s.properties.serviceIndex;e[a]||(e[a]=new Set);const l=o.properties.batchIdData;if(l)for(let n=0;n<l.length;n++)e[a].has(l[n])||(t.push({id:l[n],service:a}),e[a].add(l[n]))}}return t}hasIBL(){const e=this.getMap().getLightManager();return!(!e||!e.getAmbientResource())}}function wZ(e){for(let t=0;t<e.length;t++)e[t]&&(e[t].array&&(e[t].array=null),e[t].mipmap&&(e[t].mipmap=null),e[t].indices&&(e[t].indices=null))}function TZ(e,t){if(t)for(let n=0;n<t.length;n++)e[t[n].id||t[n].index]=t[n]}const SZ=[];class Or{constructor(e,t,n,i,s){this.h=i,this.Qt=e,this.H=t,this.te=s,this.ee=n.version,e.indexOf("i3s:tileset:")<0?(this.ne=this.ee<=1.6?"root":0,n.version=this.ee):(this.ne=e.substring(12),this.ee>1.6&&(this.ne=parseInt(this.ne))),this.Qt=e,this.re=n}load(){const e=this.re,t=e.layerScene.baseUrl;if(this.ee<=1.6)return e[this.ne]&&e[this.ne].lodSelection?(this.se=e[this.ne],this.ie()):new Promise((n=>{let i=t+"/nodes/"+this.ne;e.layerScene.eslpk&&(i+="/3dNodeIndexDocument.json"),this.te(this.H,i,(()=>{this.se=e[this.ne],n(this.ie())}))}));if(this.ee>=1.7){if(e[this.ne])return this.se=e[this.ne],this.ie();const n=Math.floor(this.ne/e.nodesPerPage);return new Promise((i=>{let s=t+"/nodepages/"+n;e.layerScene.eslpk&&(s+=".json"),this.te(this.H,s,(()=>{this.se=e[this.ne],i(this.ie())}))}))}return null}getTileset(){return this.oe}getChildrenURL(){return this.ae}ie(){const e=this.re,t=e.layerScene.baseUrl,n=this.se.children,i=[],s={};if(n)for(let o=0;o<n.length;o++)if(this.ee<=1.6){const a=n[o].id;if(e[a])continue;const l=a;s[l]||(s[l]=new Promise((n=>{let i=t+"/nodes/"+l;e.layerScene.eslpk&&(i+="/3dNodeIndexDocument.json"),this.te(this.H,i,(()=>{n()}))})),i.push(s[l]))}else{const a=n[o];if(e[a])continue;const l=Math.floor(a/e.nodesPerPage);s[l]||(s[l]=new Promise((n=>{let i=t+"/nodepages/"+l;e.layerScene.eslpk&&(i+=".json"),this.te(this.H,i,(()=>{n()}))})),i.push(s[l]))}return i.length?Promise.all(i).then((()=>this.ce())):this.ce()}ce(){return Promise.resolve(this.le())}he(e){TZ(this.re,e)}le(){return{asset:{i3s:!0,version:"1.0",gltfUpAxis:"Z"},geometricError:Number.MAX_VALUE,root:this.ue(this.se,!0)}}ue(e){const t=this.h.getRenderer(),n=this.re.projection,i=!n||n&&4326===n.wkid,s=this.ee,o=this.re,a=e,l=a.obb,h=a.mbs,c={};let u;if(h)u=ZA([],h[0],h[1],h[2]),i||(u=t.fe(u,u)),u=MZ([],u[0],u[1],u[2]),c.sphere=[...u,h[3]];else if(l){u=ZA([],l.center[0],l.center[1],l.center[2]),i||(u=t.fe(u,u)),u=MZ([],u[0],u[1],u[2]);const e=function(e,t,n){const i=fA([],n);return i[0]=i[0]*t[0],i[1]=i[1]*t[0],i[2]=i[2]*t[0],i[3]=i[3]*t[1],i[4]=i[4]*t[1],i[5]=i[5]*t[1],i[6]=i[6]*t[2],i[7]=i[7]*t[2],i[8]=i[8]*t[2],[...e,...i]}(u,l.halfSize,l.quaternion);ZA(SZ,e[3]+e[6]+e[9],e[4]+e[7]+e[10],e[5]+e[8]+e[11]);const n=Ay(SZ);c.sphere=[...u,n]}let f=1/0,g=0;if(a.mbs?g=a.mbs[3]:a.obb&&(g=Math.max(Math.max(a.obb.halfSize[0],a.obb.halfSize[1]),a.obb.halfSize[2])),void 0!==a.lodThreshold)"maxScreenThresholdSQ"===o.lodSelectionMetricType?f=g/(Math.sqrt(a.lodThreshold)/(.25*Math.PI)):console.error("Unsupported lodSelectionMetricType in Layer");else if(void 0!==a.lodSelection)for(let e=0;e<a.lodSelection.length;e++)"maxScreenThreshold"===a.lodSelection[e].metricType&&(f=g/a.lodSelection[e].maxError);(f===1/0||isNaN(f))&&(f=1e5);const m=16*f,A=AA([]),w=a.children;let T;if(w){T=[];const e=this.re;for(let t=0;t<w.length;t++){const n=s<=1.6?w[t].id:w[t];if(!e[n]){T=null;break}T.push(this.ue(e[n]))}}const S={refine:"REPLACE",boundingVolume:c,transform:A,geometricError:m};return s<=1.6?e.lodSelection?e.geometryData&&(S.content={uri:"i3s:mesh:"+(e.id||e.index)}):S.content={uri:"i3s:tileset:"+(e.id||e.index)}:w&&w.length&&!T?S.content={uri:"i3s:tileset:"+(e.id||e.index)}:a.mesh&&(S.content={uri:"i3s:mesh:"+(e.id||e.index)}),T&&T.length&&(S.children=T),S}getJSON(){return this.se}}function MZ(e,t,n,i){return uW(e,Sj(t),Sj(n),i)}const CZ=!!jj.ktx2,PZ=AA([]),IZ=(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1})();function kZ(e){return e.indexOf("i3s:mesh")>=0}function OZ(e,t,n,i,s){const o=t.layerScene.eslpk,a=function(e,t){const n=t.substring(9);return e>=1.7?parseInt(n):n}(t.version,e),l=t[a],h=t.layerScene.baseUrl,c=[];let u=!1;const f=PZ;let g,m;if(t.version<=1.6){if(!l.geometryData)return null;const e=l.geometryData.length;if(!e)return null;let n=h+`/nodes/${l.id}/`+l.geometryData[e-1].href;o&&(n+=".bin");const i={geometry:{url:n,info:t.layerScene.store.defaultGeometrySchema}};let s=l.textureData&&l.textureData[0]&&l.textureData[0].href;if(s){const e=t.layerScene.store.textureEncoding[0];let n;n="image/jpeg"===e?"jpg":"png",o&&(s+="."+n);i.material={pbrMetallicRoughness:{baseColorTexture:{url:h+`/nodes/${l.id}/`+s,factor:1,format:n,mimeType:e},metallicFactor:0}}}c.push(i)}else{g=l.mesh.geometry,m=l.mesh.material;const e=(t.layerScene.store||{}).textureEncoding,a=t.layerScene.geometryDefinitions[g.definition],{geometryBuffers:f}=a;u=i&&2===f.length;let A=h+`/nodes/${g.resource}/geometries/`+(jj.draco&&u?1:0);o&&(A+=".bin");const w={geometry:{url:A,info:jj.draco&&u?f[1]:f[0]}};if(s&&IZ&&u&&!jj.draco)throw new Error("Must import @maptalks/transcoder.draco to load i3s draco compressed geometry");const T=t.layerScene.materialDefinitions;let S,M=0;m&&(M=T[m.definition]),S=T?function(e,t,n,i,s,o,a){const l=JSON.parse(JSON.stringify(t));return EZ(e,l,n,i,s,o,a),l}(e,M,t.layerScene.textureSetDefinitions,h,m.resource,n,t.layerScene.eslpk):{pbrMetallicRoughness:{metallicFactor:0}},w.material=S,c.push(w)}return{dracoCompression:u,meshes:c,nodeIndex:a,center:l.obb&&l.obb.center||l.mbs&&[l.mbs[0],l.mbs[1],l.mbs[2]],transform:f}}function EZ(e,t,n,i,s,o,a){for(const l in t)if(t[l]&&t[l].textureSetDefinitionId>=0){const h=n[t[l].textureSetDefinitionId],c="images/"+h.formats[0].format,u=LZ(h.formats,o,e),f={url:i+`/nodes/${s}/textures/${u.name}`,factor:void 0===t[l].factor?1:t[l].factor,format:u.format,mimeType:c};if(a){let e="";switch(u.format){case"dds":e="bin.dds";break;case"jpg":case"png":e=u.format}f.url+="."+e}t[l]=f}else wj(t[l])&&EZ(e,t[l],n,i,s,o,a)}const RZ={"image/jpeg":"jpg","image/jpg":"jpg","image/png":"jpg","image/vnd-ms.dds":"dds","image/ktx":"jpg"};function LZ(e,t,n){if(n&&n.length){const t=n[n.length-1],i=RZ[t];if(i){for(let t=0,n=e.length;t<n;t++)if(e[t].format===i)return e[t]}else console.error("i3s not find texture format type from:",RZ,"current textureEncoding:",t)}for(let n=0;n<=e.length;n++){const i=e[n].format;if("dds"===i&&t.hasExtension("WEBGL_compressed_texture_s3tc"))return e[n];if("jpg"===i||"png"===i)return e[n];if("ktx2"===i&&CZ)return e[n]}return null}const{Ajax:DZ}=Wj(),FZ=new fl(0,0),HZ=new fl(0,0),NZ=new Set,BZ=[],zZ=new class{constructor(e,t){this.max=e,this.currentSize=0,this.data=new Map,this.onRemove=t}reset(e){if(this.data){const t=this.data.keys();for(const n of t){const t=this.data.get(n);e&&e!==t.renderer||this.de(n,t)}}return e||(this.data=new Map,this.currentSize=0),this}clear(e){this.reset(e)}add(e,t){if(!t)return this;if(t.node&&t.node.memorySize&&(this.currentSize+=t.node.memorySize),this.has(e)){const n=this.data.get(e);n&&n.node&&n.node.memorySize&&(this.currentSize-=n.node.memorySize),this.data.delete(e),this.data.set(e,t)}else this.data.set(e,t);return this}shrink(){if(this.currentSize>this.max){let e=!1;const t=this.data.keys();let n=t.next();for(;this.currentSize>this.max&&void 0!==n.value;){!e&&this.data.get(n.value).current&&(e=!0,console.warn(`current maxGPUMemory(${this.max/1024/1024}) for Geo3DTilesLayer is not enough, one or more current tiles will be discarded.`));const i=this.getAndRemove(n.value);i&&this.onRemove(i),n=t.next()}}}has(e){return this.data.has(e)}keys(){const e=new Array(this.data.size);let t=0;const n=this.data.keys();for(const i of n)e[t++]=i;return e}getAndRemove(e){if(!this.has(e))return null;const t=this.data.get(e);return t.node&&t.node.memorySize&&(this.currentSize-=t.node.memorySize),this.data.delete(e),t}get(e){if(!this.has(e))return null;const t=this.data.get(e);return this.data.delete(e),this.data.set(e,t),t}remove(e){if(!this.has(e))return this;const t=this.data.get(e);return this.de(e,t),this}de(e,t){t.node&&t.node.memorySize&&(this.currentSize-=t.node.memorySize),this.data.delete(e),this.onRemove(t)}setMaxSize(e){return this.max=e,this.shrink(),this}getMemorySize(){let e=0;const t=this.data.values();for(const n of t){const t=n&&n.node;t&&t.memorySize&&(e+=t.memorySize)}return e}markAll(e,t){const n=this.data.values();for(const i of n)e&&i.renderer!==e||(i.current=t)}}(1024*(ye.mobile?32:1024)*1024,(e=>{const t=e.renderer;delete e.renderer,t.deleteTile(e)}));let GZ=0;class zr extends(gI(OP(Om.LayerAbstractRenderer))){constructor(e){super(e);const t=1024*e.options.maxGPUMemory*1024;t>zZ.max&&zZ.setMaxSize(t),this.tileCache=zZ,GZ++,this.tilesLoading={},this.me={},this.pe=[],this.te=(...e)=>this.ye.call(this,...e)}getAnalysisMeshes(){if(!this.painter)return BZ;const e=this.painter.getPaintedMeshes();if(!e)return BZ;const t=[],{b3dmMeshes:n,pntsMeshes:i,i3dmMeshes:s}=e;return n.length&&Fj(t,n.filter((e=>!(!e||!e.geometry)))),i.length&&Fj(t,i.filter((e=>!(!e||!e.geometry)))),s.length&&Fj(t,s.filter((e=>!(!e||!e.geometry)))),t}needToRedraw(){return!!this.getMap().isInteracting()||!!this.pe.length||super.needToRedraw()}getFrameTimestamp(){return this.be}drawOnInteracting(e,t,n){this.draw(t,n)}draw(e,t){this.be=e;const n=this.prepareCanvas();if(n&&!n.intersects(this.canvasExtent2D))return void this.completeRender();const{root:i,tiles:s}=this.layer.getTiles();if(!s||!s.length)return void this.completeRender();this.painter.prepareRender(t),this.ge(),this.we(t);const{selectedTiles:o,requests:a}=this.ve(i,s);a.length&&this.loadTiles(a),this.Te(o,t),this._e(),a.length||this.completeRender()}ve(e,t){let n=[];this.Me();let i=0;const s=this.Oe(),o={};let a=!1,l=!1;for(let e=0;e<t.length;e++){const s=t[e],h=s.node;if(o[h.id])continue;o[h.id]=1;let c=!1;const u=this.getCachedTile(h.id);(this.Ae(h.id)?(i++,c=l=!0,this.tilesLoading[h.id].current=!0):u?(this.getTileOpacity(u)<1&&(c=l=!0),a=!0,s.selected=!0,s.data=u):this.painter.has(h)||(c=l=!0,n.push(h)),c)&&((this.xe(s)||this.Ie(s).length)&&(a=!0))}const h=a?this.Se(e):[];if(n.length>1&&(n.sort(UZ),s)){const e=s-i;n=e>0?n.slice(0,e):[]}return{loading:l,requests:n,selectedTiles:h}}Se(e){const t=[];let n,i;const s=[e],o=[];for(;s.length>0||o.length>0;){if(o.length>0){const e=o[o.length-1];if(e.Ce===s.length){o.pop(),e===n&&(e.leave=!0),e.branchRootId=i,t.push(e),0===o.length&&(i=null);continue}}const e=s.pop(),a=e.children;if(e.selected)if("add"===e.node.refine)e.leave=!0,e.selectionDepth=o.length,e.branchRootId=i,t.push(e);else{if(e.selectionDepth=o.length,n=e,0===a.length){e.leave=!0,e.branchRootId=i,t.push(e);continue}0===o.length&&(i=e.node.id),o.push(e),e.Ce=s.length}for(let e=0;e<a.length;e++)s.push(a[e])}return t}xe(e){if(!e.parent)return null;let t=e.parent;for(;t&&t.level>=0;){const e=t.node.id;if(this.tileCache.has(e))return t.selected=!0,t.data=this.tileCache.get(e),t;t=t.parent}return null}Ie(e){const t=[];if(!e.node.children||!e.node.children.length)return t;const n=e.ke+1,i=[e.node];for(;i.length>0;){const s=i.pop().children;for(let o=0,a=s.length;o<a;o++){if((!s[o].content||!s[o].content.url)&&s[o].children&&s[o].children.length){i.push(s[o]);continue}const a=s[o].id;if(this.tileCache.has(a)){const n=this.layer.Ne(s[o],e);n.selected=!0,n.data=this.tileCache.get(a),e.children.push(n),t.push(n)}else s[o].ke<=n&&i.push(s[o])}}return t}Te(e,t){this.tileCache.markAll(this,!1);const n=[];for(let t=0,i=e.length;t<i;t++){const i=e[t].data;i.current=!0,i.renderer=this,this.tileCache.add(e[t].node.id,i);const s=i.node,o=this.layer.j(s.H);s.dt&&o.debug&&!Array.isArray(o.debug)&&n.push(s.dt)}const i=this.layer.options.services;for(let e=0;e<i.length;e++){const t=i[e],s=Array.isArray(t.debug)&&t.debug;if(s)for(const e of s){const t=this.layer.Dt(e),i=t&&t.node;i&&i.dt&&n.push(i.dt)}}const s={tiles:e};this.onDrawTileStart(s);const o=this.painter.paint(e,n,t);this.layer.fire("drawtiles",{count:o}),this.onDrawTileEnd(s),o&&this.layer.fire("canvasisdirty",{renderCount:o}),this.tileCache.shrink()}onDrawTileStart(){}onDrawTileEnd(){}loadTiles(e){for(let t=0,n=e.length;t<n;t++){const n=e[t];this.tilesLoading[n.id]={current:!0,node:n},this.loadTile(n)}}loadTile(e){let t=e.content.url;if(Lj(t)){const n=Dj(t);return this.Le(t,n,e),null}if(function(e){return e.indexOf("i3s:tileset")>=0}(t)){const n=e.H;return new Or(t,n,this.Ee[n],this.layer,this.te).load().then((n=>{this.onTilesetLoad(n,e,t)}))}return e&&zj(t)&&!kZ(t)&&(t=e.baseUrl+t),this.Le(t,null,e),null}Le(e,t,n){let i=this.Re;i||(i=CM.Util.getSupportedFormats(this.gl||this.device),this.Re=i);const s=this.layer.j(n.H);s.isSuperMapiServer&&(e=function(e,t){const n=e.substring(t.length).split("/"),i=[];for(let e=0;e<n.length;e++)i.push(encodeURIComponent(n[e]));return t+i.join("/")}(e,n.baseUrl));const o={url:this.layer.getTileUrl(e,this.layer.Pe[n.H]),arraybuffer:t,rootIdx:n.H,upAxis:n.xt,transform:n.matrix,supportedFormats:i};if(kZ(e)){const t=this.Ee[n.H];if(o.projection=t.projection,o.i3sInfo=OZ(e,t,this.regl||this.device,this.layer.options.enableI3SCompressedGeometry,this.layer.options.forceI3SCompressedGeometry),!o.i3sInfo)return void this.onTileError({status:404},n,e)}o.service=xj({},s),s.offset&&delete o.service.offset,o.referrer=window&&window.location.href,this.workerConn.loadTile(this.layer.getId(),o,((t,i)=>{if(t)return void this.onTileError(t,n,e);const{magic:s}=i;"b3dm"===s||"pnts"===s||"i3dm"===s||"cmpt"===s||"gltf"===s?this.pe.push({data:i,tile:n}):this.onTilesetLoad(i,n,e)}))}Gt(e){this.painter&&this.painter.Gt(e)}Ft(e){this.painter&&this.painter.Ft(e)}we(){const e=this.getMap(),t=this.layer.options.meshLimitPerFrame;let n=0;for(;this.pe.length&&(n<t||!e.isInteracting());){const{data:e,tile:t}=this.pe.shift(),{magic:i}=e;"b3dm"===i||"gltf"===i?this.painter.createB3DMMesh(e,t.id,t,((n,{mesh:i})=>{this.Ue(e,t,n,i)})):"pnts"===i?this.painter.createPntsMesh(e,t.id,t,((n,{mesh:i})=>{this.Ue(e,t,n,i)})):"i3dm"===i?this.painter.createI3DMMesh(e,t.id,t,((n,{mesh:i})=>{this.Ue(e,t,n,i)})):"cmpt"===i&&this.painter.createCMPTMesh(e,t.id,t,((n,{mesh:i})=>{this.Ue(e,t,n,i)})),n++}}Ue(e,t,n,i){if(this.Be(i),n)this.onTileError(n,t);else{const n=this.Ge(i);t.memorySize=n,this.onTileLoad(e,t)}}Be(e){if(Array.isArray(e)){for(let t=0;t<e.length;t++)if(e[t])if(Array.isArray(e[t]))this.Be(e[t]);else{const n=e[t].defines||{};n.HAS_LAYER_OPACITY=1,e[t].setDefines(n)}}else if(e)if(Array.isArray(e))this.Be(e);else{const t=e.defines||{};t.HAS_LAYER_OPACITY=1,e.setDefines(t)}}Ge(e){let t=0;if(Array.isArray(e))for(let n=0;n<e.length;n++)e[n]&&(t+=this.Ge(e[n]));else e&&(t+=e.getMemorySize());return t}onTileLoad(e,t){this.layer&&(delete this.tilesLoading[t.id],this.layer.onTileLoad(e,t),this.De(t),this.setToRedraw(),this.layer.fire("tileload",{node:t}))}onTilesetLoad(e,t,n){this.layer&&(this.layer.zt=e.extensions&&e.extensions["s3m:VertexCompressionType"],e.capabilities||e.layers&&e.layers[0]&&e.layers[0].capabilities?this.Fe(e,t,n):(delete this.tilesLoading[t.id],this.layer.onTilesetLoad(e,t,n)))}onTileError(e,t,n){if(!this.layer)return;const i=n||t.content.url,s=e&&e.message||e;e&&(404===e.status||204===e.status)||NZ.has(s)||(console.warn("failed to load 3d tile: "+i),console.warn(e),NZ.add(s)),delete this.tilesLoading[t.id],(!this.layer.options.onlyCacheNoContentTileWhenError||e&&!Zi.isNoContentHttpCode(e.status))&&this.je(t,e),this.layer.fire("tileerror",{node:t,error:e})}getCachedTile(e){return this.tileCache.get(e)}getShadowMeshes(){if(!this.painter)return[];const e=[],t=this.painter.getCurrentB3DMMeshes();for(const n in t)t[n]&&t[n].isValid&&t[n].isValid()&&e.push(t[n]);const n=this.painter.getCurrentI3DMMeshes();for(const t in n)n[t]&&n[t].isValid&&n[t].isValid()&&e.push(n[t]);return e}je(e,t){const n={loadTime:Zi.now(),current:!0,error:t,node:e};n.renderer=this,this.tileCache.add(e.id,n)}De(e){const t={loadTime:Zi.now(),current:!0,node:e};t.renderer=this,this.tileCache.add(e.id,t)}abortTileLoading(e){if(!e||!this.workerConn)return;const t=e.node.content.url;this.workerConn.abortTileLoading(this.layer.getId(),t),delete this.me[t]}Me(){if(this.tilesLoading)for(const e in this.tilesLoading)this.tilesLoading[e].current=!1}deleteTile(e){this.painter.deleteTile(e)}initContext(){super.initContext();const e=this.layer,{regl:t,reglGL:n,device:i}=this.context;this.regl=t,this.device=i,this.gl=n;const s=t||i;this.prepareWorker(),this.canvas.pickingFBO=this.canvas.pickingFBO||s.framebuffer(this.canvas.width,this.canvas.height),this.pickingFBO=this.canvas.pickingFBO||s.framebuffer(this.canvas.width,this.canvas.height),this.painter=new vr(s,e),this.layer.ze(),this.layer.fire("contextcreate",{regl:t,device:i})}prepareWorker(){const e=this.getMap();this.workerConn||(this.workerConn=new Zj("@maptalks/3dtiles",e.id,CM.Util.supportNPOT(this.regl||this.device)));const t=this.workerConn;if(!t.isActive())return;let n=this.layer.options||{};n=xj({},n),delete n.offset;const i=e.options.spatialReference;n.projection=i&&i.coordType||i&&i.projection||e.getSpatialReference().getProjection().code;const s=this.layer.getId();t.addLayer(s,n,(e=>{if(e)throw e;this.layer&&(this.ready=!0,this.layer.fire("workerready"))}))}onRemove(){this.painter&&this.painter.remove(),this.pickingFBO&&(this.canvas.pickingFBO||this.pickingFBO.destroy(),delete this.pickingFBO),this.workerConn&&(this.workerConn.removeLayer(this.layer.getId(),(e=>{if(e)throw e})),this.workerConn.remove(),delete this.workerConn),GZ--,GZ||zZ.reset(),this.clear(),delete this.tileCache,delete this.gl,delete this.regl,super.onRemove()}clear(){this._e(!0),this.tileCache.reset(this),this.tilesLoading={},super.clear()}getTileOpacity(){return 1}getStencilValue(){return 0}_e(e){this.He||(this.He=Date.now());const t=Date.now();if(!e&&t-this.He<this.layer.options.retireInterval)return;this.He=t;const n=[];for(const t in this.tilesLoading){const i=this.tilesLoading[t];!e&&i.current||(n.push(t),this.abortTileLoading(i))}for(let e=0;e<n.length;e++)delete this.tilesLoading[n[e]]}Oe(){return this.getMap().isInteracting()?this.layer.options.loadingLimitOnInteracting:this.layer.options.loadingLimit}qe(e,t){const n=["webgl","experimental-webgl"];let i=null;for(let s=0;s<n.length;++s){try{i=e.getContext(n[s],t)}catch(e){}if(i)break}return i}Ae(e){return!!this.tilesLoading[e]}getI3DMMeshes(){return this.painter.getI3DMMeshes()}getPNTSMeshes(){return this.painter.getPNTSMeshes()}getB3DMMeshes(){return this.painter.getB3DMMeshes()}readBatchData(e,t,n){return EW(e,t,0,n)}ge(){if(!this.$e)return;const e=this.layer.options.i3sNodepageLimitPerFrame||Number.MAX_VALUE;let t=0;const n=[];for(const i in this.$e){const s=this.$e[i];if("pending"===s.status)continue;s.status="pending";const o=s.rootIdx,a=Gj(this.layer.j(o).fetchOptions);if(n.push(DZ.getJSON(i,a).then((e=>{delete this.$e[i];const t=this.Ee[o];if(t){e.nodes?TZ(t,e.nodes):(t[e.id]=e,TZ(t,e.children));for(let e=0;e<s.length;e++)s[e]();this.setToRedraw()}else this.setToRedraw()}))),t++,t>=e)break}n.length&&Promise.all(n)}ye(e,t,n){this.$e||(this.$e={}),this.$e[t]=this.$e[t]||[],this.$e[t].rootIdx=e,this.$e[t].push(n),this.setToRedraw()}Fe(e,t,n){this.Ee||(this.Ee=[]);const i=t.H;this.Ee[i]||(this.Ee[i]={});const s=this.Ee[i],o=this.layer.j(i);e.layers&&(e=e.layers[0],"/"!==n[n.length-1]&&(n+="/"),n+="layers/0"),s.version=+(o.i3sVersion||e.store.version),!e.spatialReference||e.spatialReference.wkid&&4326===e.spatialReference.wkid||console.warn("i3s has a spatialReference other than 4326.",e.spatialReference),e.spatialReference&&4490===e.spatialReference.wkid&&(console.warn("i3s spatialReference is 4490,auto set spatialReference to 4326,This may cause some location issues, please ensure that your service is 4326"),e.spatialReference.wkid=4326),s.projection=e.spatialReference,function(e,t,n,i,s,o,a){if(!o.layerScene){o.layerScene=t,o.nodesPerPage=t.nodePages&&t.nodePages.nodesPerPage||64,o.lodSelectionMetricType=t.nodePages&&t.nodePages.lodSelectionMetricType;let e=s;if(o.layerScene.eslpk=e.indexOf("3dSceneLayer.json")>=0,e.endsWith(".json")){const t=s.lastIndexOf("/");e=t<0?"./":s.substring(0,t)}o.layerScene.baseUrl=function(e){return e.split("?")[0]}(e)}return new Or(s,n,o,e,a).load()}(this.layer,e,i,0,n,s,this.te).then((e=>{this.onTilesetLoad(e,t,n)}))}pick(e,t,n){if(!this.painter)return[];const i=this.pickingFBO,{width:s,height:o}=this.canvas;return!this.pickingFBO||i.width===s&&i.height===o||i.resize(s,o),this.painter.pick(e,t,n&&n.tolerance)}highlight(e){if(this.J||(this.J=[]),Array.isArray(e))for(let t=0;t<e.length;t++){const n=e[t].service||0;let i=this.J[n];i||(i=this.J[n]=new Map),i.set(e[t].id,e[t])}else{const t=e.service||0;let n=this.J[t];n||(n=this.J[t]=new Map),n.set(e.id,e)}this.painter.highlight(this.J)}cancelHighlight(e,t){if(!this.J)return;const n=this.J[e];if(n){if(Array.isArray(t))for(let e=0;e<t.length;e++)n.delete(t[e]);else n.delete(t);n.size||(this.J[e]=null),this.painter.highlight(this.J)}}cancelAllHighlight(){delete this.J,this.painter.cancelAllHighlight()}showOnly(e){if(this.Z||(this.Z=[]),Array.isArray(e))for(let t=0;t<e.length;t++){const n=e[t].service||0;let i=this.Z[n];i||(i=this.Z[n]=new Map),i.set(e[t].id,e[t])}else{const t=e.service||0;let n=this.Z[t];n||(n=this.Z[t]=new Map),n.set(e.id,e)}this.painter.showOnly(this.Z)}cancelShowOnly(){delete this.Z,this.painter.cancelShowOnly()}Wt(){return this.painter?this.painter.Wt():[]}fe(e,t){const n=this.getMap();if("identity"===n.getProjection().code.toLowerCase()){const n=this.Ve();return FZ.set(t[0],t[1]),n.unproject(FZ,HZ),e[0]=HZ.x,e[1]=HZ.y,e}return FZ.set(t[0],t[1]),n.getProjection().unproject(FZ,HZ),e[0]=HZ.x,e[1]=HZ.y,e}Je(e,t){const n=this.Ve();return FZ.set(t[0],t[1]),n.project(FZ,HZ),e[0]=HZ.x,e[1]=HZ.y,e}Ye(e,t){const n=this.Ve();return FZ.set(t[0],t[1]),n.unproject(FZ,HZ),e[0]=HZ.x,e[1]=HZ.y,e}Ve(){const e=this.getMap().options.spatialReference.coordType;if(!e)throw new Error("Missing coordType in map spatialReference.");return this.Ze||(this.Ze=uu.getProjectionInstance(e)),this.Ze}}function UZ(e,t){return e.ft-t.ft}function VZ(e,t,n){return e[0]=t[n],e[1]=t[n+3],e[2]=t[n+6],e}const jZ=[],WZ=[],qZ=[],ZZ=[],XZ=[],YZ=2*Math.PI;class Wr{constructor(e,t,n,i){this.west=e,this.south=t,this.east=n,this.north=i}static contains(e,t){let n=t[0];const i=t[1],s=e.west;let o=e.east;return o<s&&(o+=YZ,n<0&&(n+=YZ)),(n>s||MW(n,s,1e-14))&&(n<o||MW(n,o,1e-14))&&i>=e.south&&i<=e.north}static southwest(e,t){return t[0]=e.west,t[1]=e.south,t[2]=0,t}static northeast(e,t){return t[0]=e.east,t[1]=e.north,t[2]=0,t}static southeast(e,t){return t[0]=e.east,t[1]=e.south,t[2]=0,t}static northwest(e,t){return t[0]=e.west,t[1]=e.north,t[2]=0,t}}const JZ=[0,0,1];function QZ(e,t){return uW(t,e[0],e[1],e[2])}class es{constructor(e,t){this.normal=qA([],e),this.distance=t}static fromPointNormal(e,t,n){const i=-iy(t,e);return qA(n.normal,t),n.distance=i,n}}const $Z=[],KZ=[],eX=[],tX=[],nX=[],rX=[],iX=[],sX=[],oX=[],aX=[],lX=new es([1,0,0],0),hX=[];class ms{constructor(e){this.southwestCornerCartesian=[],this.northeastCornerCartesian=[],this.westNormal=[],this.eastNormal=[],this.southNormal=[],this.northNormal=[],this.rectangle=new Wr(...e),this.minimumHeight=e[4],this.maximumHeight=e[5],this.computeBox(this.rectangle)}distanceToCamera(e,t){let n=0;if(!Wr.contains(this.rectangle,t)){const t=this.northeastCornerCartesian,i=this.westNormal,s=this.southNormal,o=this.eastNormal,a=this.northNormal,l=YA(hX,e,this.southwestCornerCartesian),h=iy(l,i),c=iy(l,s),u=YA(hX,e,t),f=iy(u,o),g=iy(u,a);h>0?n+=h*h:f>0&&(n+=f*f),c>0?n+=c*c:g>0&&(n+=g*g)}const i=t[2],s=this.minimumHeight,o=this.maximumHeight;if(i>o){const e=i-o;n+=e*e}else if(i<s){const e=s-i;n+=e*e}return Math.sqrt(n)}computeBox(e){const t=this;QZ(Wr.southwest(e,KZ),t.southwestCornerCartesian),QZ(Wr.northeast(e,KZ),t.northeastCornerCartesian),$Z[0]=e.west,$Z[1]=.5*(e.south+e.north),$Z[2]=0;const n=QZ($Z,eX),i=sy(nX,n,JZ);ry(t.westNormal,i),$Z[0]=e.east;const s=QZ($Z,sX),o=sy(nX,JZ,s);ry(t.eastNormal,o);const a=YA(nX,n,s),l=ry(tX,a),h=e.south;let c;if(h>0){$Z[0]=.5*(e.west+e.east),$Z[1]=h;const n=QZ($Z,oX);qA(aX,l);const i=es.fromPointNormal(t.southwestCornerCartesian,t.westNormal,lX);cX(oX,aX,i,t.southwestCornerCartesian),c=wW(n,rX)}else c=TW(Wr.southeast(e,KZ),rX);const u=sy(iX,c,a);ry(t.southNormal,u);const f=e.north;let g;if(f<0){$Z[0]=.5*(e.west+e.east),$Z[1]=f;const n=QZ($Z,oX);$A(aX,l,-1);const i=es.fromPointNormal(t.northeastCornerCartesian,t.eastNormal,lX);cX(oX,aX,i,t.northeastCornerCartesian),g=wW(n,rX)}else g=TW(Wr.northwest(e,KZ),rX);const m=sy(iX,a,g);ry(t.northNormal,m)}}function cX(e,t,n,i){const s=e,o=t,a=n.normal,l=iy(a,o);if(Math.abs(l)<1e-15)return;const h=(-n.distance-iy(a,s))/l;return h<0?void 0:XA(i=$A(i,o,h),s,i)}function uX(e){return[e.xmin,e.ymin,e.xmax,e.ymax]}const fX=Ss,dX={services:[],maxGPUMemory:ye.mobile?32:1536,retireInterval:2e3,loadingLimitOnInteracting:5,loadingLimit:10,debug:!1,meshLimitPerFrame:1,i3sNodepageLimitPerFrame:1,enableI3SCompressedGeometry:!0,forceI3SCompressedGeometry:!0,onlyCacheNoContentTileWhenError:!0,picking:!0,pickingPoint:!0,geometryEvents:!1,alwaysShowTopTiles:!0,antialias:!1,offset:[0,0],renderer:"gl",forceRenderOnZooming:!0,forceRenderOnRotating:!0,forceRenderOnMoving:!0,optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","WEBGL_compressed_texture_astc","WEBGL_compressed_texture_etc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_compressed_texture_s3tc_srgb"]},pX=[0,0,0],gX=[0,0,0],mX=[0,0,0],AX=[0,0,0],yX=[0,0,0],_X=[0,0,0],vX=[0,0,0],xX=[1,1,1],bX=[1,1,1],wX=[0,0,0,0],TX=[],SX=new fl(0,0),MX=new Re(0,0),CX=[0,0,0,0,0,0,0,0,0],PX=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],IX=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],kX=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],OX=new Re(0,0),EX=AA([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),RX=[0,0],LX=[0,0,0],DX=[1,1,1],FX=[0,0,0],HX=[0,0,0],NX=[0,0,0,0],BX=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1];class $s extends(YI(Lu)){static fromJSON(e){return e&&"Geo3DTilesLayer"===e.type?new $s(e.id,e.options):null}static getEnuTransform(e,t=[1,1,1],n=[0,0,0]){const i=uW([],e[0]*Math.PI/180,e[1]*Math.PI/180,e[2]||0),s=QW(i,null,[]),o=EA([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],a_([0,0,0,0],...n),[0,0,0],t);return vA(o,s,o)}constructor(e,t){super(e,t),this.isGeo3DTilesLayer=!0,this.Ke(),this.Xe=[]}Ke(){const e=this.options.services.map((e=>e.url));this.We=this.We||{},this.Pe=this.Pe||[];for(let t=0;t<e.length;t++){const n=e[t];let i=this.We[n];void 0===i&&(i=this.We[n]=this.Pe.length),this.Pe[i]=UX(n,i,this.options.services[t])}this.fire("rootready",{roots:this.Pe.slice(0)})}showService(e){return this.updateService(e,{visible:!0}),this}hideService(e){return this.updateService(e,{visible:!1}),this}setToRedraw(){return this.Qe(),this}addService(e){return this.options.services=this.options.services||[],this.options.services.push(e),this.Ke(),this.Qe(),this}updateService(e,t){if(!t)return this;const n=this.options.services;let i=!1;n&&n[e]&&(i=!(WX(n[e].coordOffset,t.coordOffset)&&WX(n[e].heightOffset,t.heightOffset)&&WX(n[e].scale,t.scale)&&WX(n[e].rotation,t.rotation)),xj(n[e],t));const s=this.Pe&&this.Pe[this.We[n[e].url]];return s&&(vj(t.visible)||(s.visible=t.visible),i&&s.version++),this.Qe(),this}removeService(e){const t=this.options.services;if(t&&t[e]){const n=t[e].url,i=this.We[n];this.Pe[i]&&(this.Pe[i]=null),delete this.We[n],t.splice(e,1)}return this.Qe(),this}getTileUrl(e,t){const n=t&&t.service&&t.service.subdomains;if(n&&t.domainKey){const i=n.length;if(i){const s=[...e].reduce(((e,t)=>e+t.charCodeAt(0)),0)%i;return e.replace(t.domainKey,n[s])}}return e}getExtent(e){if(!e&&0!==e){const e=new Ml;for(let t=0;t<this.Pe.length;t++){const n=this.Pe[t];if(n&&n.boundingVolume){const t=this.boundingVolumeToExtent(n);e._combine(t)}}return e}const t=this.Pe[e];return t&&t.boundingVolume?this.boundingVolumeToExtent(t):null}boundingVolumeToExtent(e){const t=e.boundingVolume.tn?EX:e.matrix,n=this.getMap(),i="identity"===n.getProjection().code.toLowerCase(),s=this.getRenderer();if(e.boundingVolume.region){const t=e.boundingVolume.region;return new Ml(Mj(t[0]),Mj(t[1]),Mj(t[2]),Mj(t[3]))}if(e.boundingVolume.sphere){const o=e.boundingVolume.sphere,a=AW([],oy([0,0,0],o,t));i&&s.Je(a,a);const l=o[3],h=n.locate(a,-l,l),c=n.locate(a,l,-l);return new Ml(h,c)}if(e.boundingVolume.box){const o=e.boundingVolume.box,a=oy([0,0,0],o,t),l=new fl(AW([],a));i&&s.Je(l,l);const h=o.slice(3);cA(h,oA([0,0,0,0,0,0,0,0,0],e.matrix),h);const c=jA(h.slice(0,3)),u=jA(h.slice(3,6)),f=jA(h.slice(6,9)),g=Math.max(c,u,f),m=n.locate(l,-g,g),A=n.locate(l,g,-g);return new Ml(m,A)}return null}getRootTiles(){return this.Pe}getTiles(){const e=this.getRenderer();if(!e.ready)return this.Qe(),{tiles:TX};const t=this.getMap(),n=t.cameraPosition,i=t.pointAtResToDistance(n[2],0,t.getGLRes()),s=this.nn(n);this.rn=this.rn||[0,0,0],ZA(this.rn,Sj(s.x),Sj(s.y),i),this.sn=uW(this.sn||[],this.rn[0],this.rn[1],this.rn[2]),this.an=2*Math.tan(.5*Sj(t.getFov()));const o=t.projViewMatrix;let a;if(t.getPitch()<=80){const e=t.getExtent(),n=e.getWidth()/2,i=e.getHeight()/2;e.xmin-=n,e.ymin-=i,e.xmax+=n,e.ymax+=i,a=uX(e)}const l=(this.getMasks()||[]).filter((e=>e&&e instanceof ClipOutsideMask));l.forEach((e=>{if(!e.maskGeoJSON&&e.toGeoJSON)try{e.maskGeoJSON=e.toGeoJSON();const t=e.getExtent();e.maskGeoJSON.bbox=uX(t)}catch(e){console.error(e)}}));const h={children:[],level:-1};let c=h;const u=[];for(let t=0;t<this.Pe.length;t++){const n=this.Pe[t];if(!n||!n.visible)continue;const i=n.service,s=[n],h=this.cn(t);for(;s.length>0;){const t=s.pop();for(t.id||this.ln(t);c.level>=t.ke;)c=c.parent;const n=this.hn(t,h,o,a,l);if(t.service=i,!(n===qX.VISIBLE||n!==qX.OUT_OF_FRUSTUM&&this.options.alwaysShowTopTiles&&jX(t))){let e=c;for(;e&&!e.content;)e=e.parent;n===qX.SCREEN_ERROR_TOO_SMALL&&e&&e.content&&this.un(u,e);continue}t.ft<1/0&&this.dn(t);const f=this.Ne(t,c);c.children.push(f);const g=t.children,m=g&&g.length,A=f.content;if(A&&(!m||n===qX.SCREEN_ERROR_TOO_SMALL)&&this.un(u,f),n!==qX.SCREEN_ERROR_TOO_SMALL&&m){A&&"add"===t.refine&&this.un(u,f),c=f;const n=g[0].parent;let i=!1;for(let o=0,a=g.length;o<a;o++){if(n){const t=e.getCachedTile(g[o].id);if(t&&t.error&&404!==t.error.status)continue;i=!0}else{i=!0,g[o].parent=t,g[o].xt=t.xt,g[o].baseUrl=t.baseUrl;const e=g[o].content&&(g[o].content.url||g[o].content.uri);e&&(Lj(e)||e.indexOf("i3s:")>=0?g[o].baseUrl=t.baseUrl:zj(e)?g[o].content.url=t.baseUrl+e:g[o].baseUrl=e.substring(0,e.lastIndexOf("/")+1))}s.push(g[o])}!i&&A&&this.un(u,f)}}}return{root:h,tiles:u}}un(e,t){const{viewerRequestVolume:n,matrix:i}=t.node;n&&!function(e,t,n,i){if(n.region){const t=n.region;if(e[0]>=t[0]&&e[0]<=t[2]&&e[1]>=t[1]&&e[1]<=t[3])return!0}else{if(n.sphere)return zX(n,t,i)<=0;if(n.box)return 0===GX(n,t,i)}return!1}(this.rn,this.sn,n,i)||e.push(t)}Ne(e,t){return{id:e.id,node:e,children:[],level:e.ke,parent:t,content:e.content&&e.content.url}}ln(e){const t=this.getId();e.id=t+":"+Zi.GUID(),e.matrix=e.transform||AA([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),e.mn=this.pn(e),e.parent&&(function(e){return e.content&&e.content.uri&&e.content.uri.indexOf("i3s:")>=0}(e)||(e.matrix=vA(e.matrix,e.parent.matrix,e.matrix)),e.H=e.parent.H,void 0===e.ke&&(e.ke=e.parent.ke+1),e.maxExtent=e.parent.maxExtent),e.refine=e.refine&&e.refine.toLowerCase()||"replace",e.content&&!e.content.url&&e.content.uri&&(e.content.url=e.content.uri)}j(e){return this.Pe[e].service}yn(e){const t=e.boundingVolume;if(!t||t.tn&&!this.bn(e))return;const n=this.j(e.H),i=n.heightOffset||0,s=this.options.offset,o=bj(s)||s[0]||s[1],a=n.coordOffset||RX;if(!Array.isArray(a))throw new Error("service.coordOffset must be an array");if(!t.tn&&(!e.boundingVolume||!i&&zA(e.matrix,EX)&&!o&&a===RX))return;t.box&&t.region&&delete t.region;const{region:l,box:h,sphere:c}=t;if(t.coordOffset=[a[0],a[1]],t.heightOffset=i,l){t.originalVolume||(t.originalVolume=l.slice(0));const e=t.originalVolume,n=this.gn([Mj(e[0]),Mj(e[1])]);l[0]=Sj(n.x+a[0]),l[1]=Sj(n.y+a[1]);const s=this.gn([Mj(e[2]),Mj(e[3])]);l[2]=Sj(s.x+a[0]),l[3]=Sj(s.y+a[1]),l[4]=e[4]+i+(a[2]||0),l[5]=e[5]+i+(a[2]||0)}else if(h||c){t.originalVolume||(t.originalVolume=(h||c).slice(0));const n=h||c,s=oy(pX,t.originalVolume,e.matrix),o=AW(gX,s),l=this.gn([o[0]+a[0],o[1]+a[1]]);o[0]=l.x,o[1]=l.y,o[2]+=i+(a[2]||0),uW(n,Sj(o[0]),Sj(o[1]),o[2])}t.tn=!0;try{e.extent=this.boundingVolumeToExtent(e)}catch(e){console.error(e)}}bn(e){const t=e.boundingVolume,n=this.j(e.H),i=n.coordOffset||RX;return t.coordOffset[0]!==i[0]||t.coordOffset[1]!==i[1]||t.heightOffset!==(n.heightOffset||0)}pn(e){return void 0===e.geometricError||!e.boundingVolume}dn(e){let t=e.parent;for(;t&&t.mn&&!(t.ft<=e.ft);)t.ft=e.ft,t=e.parent}onTileLoad(e,t){if(e.children&&(!t.children||!t.children.length)){t.children=e.children;const n=t.content.url;t.baseUrl=n.substring(0,n.lastIndexOf("/")+1),this.Qe()}}onTilesetLoad(e,t,n){if(!e)return void console.warn("invalid tileset at : "+n);const i=(e.asset&&e.asset.gltfUpAxis||t&&t.xt||"Y").toUpperCase();e.root.baseUrl=n.substring(0,n.lastIndexOf("/")+1);const s=n.indexOf("realspace/")>-1;0===t.ke&&e.asset&&e.asset.s3mType&&s&&(e.root.baseUrl+="data/path/");const o=e.asset.i3s;if(e.root.xt=i,t){const n=t.boundingVolume,i=t.wn;i&&delete t.wn,xj(t,e.root),t.refine=t.refine&&t.refine.toLowerCase()||"replace",n&&(t.boundingVolume=n);let s=e.root.transform;if(i){const e=this.j(t.H);e.ecefTransform&&(s=vA([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e.ecefTransform,s||EX))}s&&(t.parent?o||(t.matrix=vA([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t.parent.matrix,s)):t.matrix=vA([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t.matrix,s)),delete t.content,e.root.content&&(t.content=e.root.content),t.mn=this.pn(t);const a=t.content&&(t.content.url||t.content.uri);a&&t.content.uri&&(t.content.url=t.content.uri,delete t.content.uri),!o&&a&&!Lj(a)&&zj(a)&&(t.content.url=t.baseUrl+a),e.root&&!t.parent&&this.vn(t)}this.Qe(),this.fire("loadtileset",{tileset:e,index:t&&t.H,url:n})}Tn(e,t,n){if(!e.extent||!fX)return!0;const i=e.extent;if(NX[0]=i.xmin,NX[1]=i.ymin,NX[2]=i.xmax,NX[3]=i.ymax,t&&!fX.bboxIntersect(NX,t))return!1;if(n.length){for(let e=0,t=n.length;e<t;e++){const t=n[e].maskGeoJSON;if(!t||!t.bbox||fX.bboxInMask(NX,t))return!0}return!1}return!0}hn(e,t,n,i,s){if(!this.Tn(e,i,s))return qX.OUT_OF_FRUSTUM;if(e.ft=1/0,0===e.ke||e.mn)return this.vn(e),qX.VISIBLE;if(this.yn(e),!this._n(e,t,n))return qX.OUT_OF_FRUSTUM;if(0===e.geometricError)return qX.VISIBLE;let o=this.j(e.H).maximumScreenSpaceError;null==o&&(o=16);let a=this.Mn(e);return 0===a&&e.parent&&(a=.5*(e.parent.On||0)),a>=o?qX.VISIBLE:qX.SCREEN_ERROR_TOO_SMALL}Kt(e,t){t||(t=new Re(0,0));const n=this.getMap();return n.coordToPointAtRes(e,n.getGLRes(),t)}_n(e,t,n){const i=e.id;let s=this.Xe[i];const{boundingVolume:o}=e,a=o.region,l=o.box,h=o.sphere,c=this.An(e.H),u=this.getRenderer();return s&&s.version===c.version||(a?s=this.Xe[i]=this.xn(e):l?s=this.Xe[i]=this.In(e):h&&(s=this.Xe[i]=this.Sn(e)),s.version=c.version,e.dt&&(u.Ft(e.dt),delete e.dt)),this.j(e.H).debug&&(this.Xe[i].node=e,u.Gt(e)),s.obbox?function(e,t,n){CV(e);for(var i=0;i<6;i++)if(!MV(dV[i],t))return!1;return!0}(n,s.obbox):!!h&&function(e,t,n){CV(e);for(var i=t[0],s=-t[1],o=0;o<6;o++)if(IV(dV[o],i)<s)return!1;return!0}(n,s.sphereBox)}xn(e){const t=this.getMap(),n=t.getGLRes(),i=e.boundingVolume.region;let{ws:s,en:o}=function(e){const t=e[2],n=e[3],i=e[5],s=uW([],e[0],e[1],e[4]),o=uW([],t,n,i);return{ws:AW(s,s),en:AW(o,o)}}(i);s=new fl(s),o=new fl(o);const a=t.coordToPointAtRes(s,n);a.z=t.altitudeToPoint(s.z,n);const l=t.coordToPointAtRes(o,n);l.z=t.altitudeToPoint(o.z,n);const h=[l.x,a.y,l.z,l.x,l.y,l.z,a.x,l.y,l.z,a.x,a.y,l.z,l.x,a.y,a.z,l.x,l.y,a.z,a.x,l.y,a.z,a.x,a.y,a.z],c=[(h[0]+h[18])/2,(h[1]+h[19])/2,(h[2]+h[20])/2],u=this.An(e.H);e!==u||u.Cn||(u.Cn=c);const f=this.Jt([],e),g=zA(EX,f);if(!g){oy(c,c,f);const e=pX;for(let t=0;t<h.length;t+=3){let n=ZA(e,h[t],h[t+1],h[t+2]);g||(n=oy(n,n,f)),h[t]=n[0],h[t+1]=n[1],h[t+2]=n[2]}}const m=t.pointAtResToCoord(new Re(c),n);m.z=(s.z+o.z)/2;const A=this.kn(h,c);for(let e=0;e<h.length;e++)h[e]-=c[e%3];return{obbox:A,boxPosition:h,boxCenter:c,boxCoord:m}}In(e){const t=this.getRenderer(),n=this.getMap(),i="identity"===n.getProjection().code.toLowerCase(),s=n.getGLRes(),{boxCenter:o,boxCoord:a}=this.Nn(e),l=e.boundingVolume.box,h=function(e,t,n,i,s,o,a,l,h,c,u,f,g,m,A,w,T){return e[0]=t||0,e[1]=o||0,e[2]=c||0,e[3]=0,e[4]=n||0,e[5]=a||0,e[6]=u||0,e[7]=0,e[8]=i||0,e[9]=l||0,e[10]=f||0,e[11]=0,e[12]=s||0,e[13]=h||0,e[14]=g||0,e[15]=1,e}([],(c=this.Ln(l,e.matrix))[0],c[3],c[6],(u=l)[0],c[1],c[4],c[7],u[1],c[2],c[5],c[8],u[2]);var c,u;const f=this.Jt([],e),g=zA(EX,f);g||oy(o,o,f);const m=[],A=pX;for(let e=0;e<BX.length;e+=3){A[0]=BX[e],A[1]=BX[e+1],A[2]=BX[e+2],oy(A,A,h),AW(A,A),i&&t.Je(A,A);const o=SX.set(A[0],A[1],A[2]);n.coordToPointAtRes(o,s,MX);let a=ZA(A,MX.x,MX.y,n.altitudeToPoint(o.z,s));g||(a=oy(a,a,f)),m[e]=a[0],m[e+1]=a[1],m[e+2]=a[2]}const w=this.kn(m,o);for(let e=0;e<m.length;e++)m[e]-=o[e%3];return{obbox:w,boxPosition:m,boxCenter:o,boxCoord:a}}Sn(e){const t=this.getMap(),n=this.getRenderer(),i="identity"===t.getProjection().code.toLowerCase(),s=e.boundingVolume.sphere;let o=pX;0===s[0]&&0===s[1]&&0===s[2]?o=[0,0,-6378137]:AW(o,s),i&&n.Je(o,o);const a=new fl(o),l=this.Kt(a,MX).toArray();l[2]=t.altitudeToPoint(a.z,t.getGLRes());const h=this.En(a);return{boxCenter:l,boxCoord:a,sphereBox:[l,s[3]*h[2]]}}kn(e,t){const n=VX(yX,e,0,1,4,5),i=VX(_X,e,0,3,4,7),s=VX(vX,e,0,1,2,3);return[...t,...fy(pX,n,t),...fy(gX,i,t),...fy(mX,s,t)]}Nn(e){const t=this.getMap(),n=this.getRenderer(),i="identity"===t.getProjection().code.toLowerCase(),s=t.getGLRes(),o=e.boundingVolume.box.slice(0,3);AW(o,o),i&&n.Je(o,o);const a=new fl(o),l=t.coordToPointAtRes(a,s);return{boxCenter:[l.x,l.y,t.altitudeToPoint(a.z,s)],boxCoord:a}}Jt(e,t){const n=this.An(t.H),i=this.j(t.H),s=n.Cn,o=TA(PX,ZA(pX,-s[0],-s[1],-s[2])),a=TA(IX,s),l=a_(wX,...i.rotation||LX),h=i.scale;let c;c=Array.isArray(h)?ZA(FX,h[0],h[1],h[2]):h&&ZA(FX,h,h,h)||DX;return e=vA(e,EA(kX,l,HX,c),o),vA(e,a,e)}vn(e){const t=this.j(e.H);if(!e.boundingVolume||this.Rn(e,t))return;const n=e.boundingVolume.region,i=e.boundingVolume.sphere;let s=null;e.boundingVolume.box?s=this.Pn(e).boxCenter:n?s=this.Un(e).boxCenter:i&&(s=this.Sn(e).boxCenter);const o=t.heightOffset||0,a=t.coordOffset||[0,0];e.Bn=[a[0]||0,a[1]||0],e.Gn=o,e.Cn=s}Rn(e,t){if(!e.Bn)return!1;const n=t.coordOffset||RX;return e.Bn[0]===n[0]&&e.Bn[1]===n[1]&&e.Gn===(t.heightOffset||0)}Un(e){return this.yn(e),this.xn(e)}Pn(e){return this.yn(e),this.Nn(e)}Ln(e,t){let n=e.slice(3,12);return n=cA(n,oA(CX,t),n),n}En(e){const t=this.getMap(),n=t.distanceToPointAtRes(100,100,t.getGLRes(),e);let i;return i=t.altitudeToPoint?t.altitudeToPoint(100,t.getGLRes())/100:n.y/100,ZA(xX,n.x/100*1.01,n.y/100*1.01,i),xX}gn(e){Array.isArray(e)&&(e=new fl(e));let t=this.options.offset;if(bj(t)&&(t=t.call(this,Array.isArray(e)?new fl(e):e)),t[0]||t[1]){const n=this.getMap(),i=n.getGLRes(),s=n.coordToPointAtRes(e,i);return MX.set(t[0],t[1]),s._sub(MX),n.pointAtResToCoord(s,i)}return e}An(e){return this.Pe[e]}cn(e){const t=this.j(e).maxExtent;if(!t)return null;const n=this.Pe[e];return n.maxExtent||(n.maxExtent=new Ml(t).convertTo((e=>this.Kt(e)))),n.maxExtent}Mn(e){const t=this.an,n=e.geometricError;if(0===n)return e.On=0,0;const i=this.j(e.H);let s=i.scale||1;if(Array.isArray(s)&&(s=jA(s)),i.ecefTransform){const e=kA(bX,i.ecefTransform);s*=Ay(e)}const o=this.getMap();let a;e.boundingVolume.region?a=function(e,t,n){return e.Dn||(e.Dn=new ms(e.boundingVolume.region)),e.Dn.distanceToCamera(t,n)}(e,this.sn,this.rn):e.boundingVolume.sphere?a=zX(e.boundingVolume,this.sn):e.boundingVolume.box&&(a=GX(e.boundingVolume,this.sn));const l=Math.max(Math.abs(a),1e-7),h=n*s*o.height/(l*t);return e.ft=a,e.On=h,h}Qe(){const e=this.getRenderer();e&&e.setToRedraw()}Dt(e){return this.Xe[e]}identify(e,t={}){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];Array.isArray(e)&&(e=new fl(e));const s=n.coordToContainerPoint(e);return this.identifyAtPoint(s,t)}identifyAtPoint(e,t={}){const n=[];if(!t.excludeMasks){const i=this.identifyMask(e,t);i&&i.length&&Fj(n,i)}const i=this.getMap(),s=this.getRenderer();if(!i||!s)return[];const o=i.getDevicePixelRatio();return Fj(n,s.pick(e.x*o,e.y*o,t)),t&&t.filter&&!t.excludeMasks?n.filter((e=>t.filter(e))):n}getCurrentBatchIDs(){const e=this.getMap(),t=this.getRenderer();return e&&t?t.Wt():[]}highlight(e){const t=this.getRenderer();return Array.isArray(e)||(e=[e]),t?(t.highlight(e),this):(this.J||(this.J=[]),this.J.push(e),this)}ze(){if(this.J){for(let e=0;e<this.J.length;e++)this.highlight(this.J[e]);delete this.J}}cancelHighlight(e,t){const n=this.getRenderer();return n?(n.cancelHighlight(e,t),this):this}cancelAllHighlight(){const e=this.getRenderer();return e?(e.cancelAllHighlight(),this):this}showOnly(e){const t=this.getRenderer();return t?(t.showOnly(e),this):(this.Z||(this.Z=[]),this.Z.push(e),this)}Fn(){if(this.Z){for(let e=0;e<this.Z.length;e++)this.showOnly(this.Z[e]);delete this.Z}}cancelShowOnly(e){const t=this.getRenderer();return t?(t.cancelShowOnly(e),this):this}setServiceOpacity(e,t){const n=this.options.services[e];return n&&(n.opacity=t),this.getRenderer()?(this.Qe(),this):this}setServiceDebug(e,t){const n=this.options.services[e];return n&&(n.debug=t),this.getRenderer()?(this.Qe(),this):this}nn(e){const t=this.getMap(),n=t.getGLRes();OX.set(e[0],e[1]);const i=t.pointAtResToCoord(OX,n);return"identity"===t.getProjection().code.toLowerCase()?(gX[0]=i.x,gX[1]=i.y,this.getRenderer().Ye(pX,gX),i.set(pX[0],pX[1]),i):i}toJSON(){return{type:this.getJSONType(),id:this.getId(),options:this.config()}}}function zX(e,t,n){let i=e.sphere;n&&(i=oy([0,0,0],i,n));const s=gy(i,t),o=e.sphere[3];return s<o?0:s-o}function GX(e,t,n){const i=e.box;let s=ZA(pX,i[0],i[1],i[2]);return n&&(s=oy([0,0,0],s,n)),function(e,t,n){return Math.sqrt(function(e,t,n){const i=YA(jZ,n,e),s=VZ(WZ,t,0),o=VZ(qZ,t,1),a=VZ(ZZ,t,2),l=Ay(s),h=Ay(o),c=Ay(a);ry(s,s),ry(o,o),ry(a,a);const u=XZ;u[0]=iy(i,s),u[1]=iy(i,o),u[2]=iy(i,a);let f,g=0;return u[0]<-l?(f=u[0]+l,g+=f*f):u[0]>l&&(f=u[0]-l,g+=f*f),u[1]<-h?(f=u[1]+h,g+=f*f):u[1]>h&&(f=u[1]-h,g+=f*f),u[2]<-c?(f=u[2]+c,g+=f*f):u[2]>c&&(f=u[2]-c,g+=f*f),g}(e,t,n))}(s,aA(CX,i[3],i[4],i[5],i[6],i[7],i[8],i[9],i[10],i[11]),t)}function UX(e,t,n){const i=(e=Cj(e)).indexOf("{s}")>=0?"{s}":e.indexOf("%7Bs%7D")>=0?"%7Bs%7D":null;return{version:0,mn:!0,service:n,visible:!!vj(n.visible)||n.visible,baseUrl:e.substring(0,e.lastIndexOf("/"))+"/",content:{url:e},refine:"replace",matrix:AA([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),H:t,ke:0,wn:!0,domainKey:i}}function VX(e,t,n,i,s,o){const a=ZA(pX,t[3*n],t[3*n+1],t[3*n+2]),l=ZA(gX,t[3*i],t[3*i+1],t[3*i+2]),h=ZA(mX,t[3*s],t[3*s+1],t[3*s+2]),c=ZA(AX,t[3*o],t[3*o+1],t[3*o+2]);return e[0]=(a[0]+l[0]+h[0]+c[0])/4,e[1]=(a[1]+l[1]+h[1]+c[1])/4,e[2]=(a[2]+l[2]+h[2]+c[2])/4,e}function jX(e){if(!e.content||e.hasParentContent)return!1;let t=e.parent;if(t&&(t.content||t.hasParentContent))return e.hasParentContent||(e.hasParentContent=!0),!1;for(;t;){if(t.content||t.hasParentContent)return e.hasParentContent||(e.hasParentContent=!0),!1;t=t.parent}return!0}function WX(e,t){return Array.isArray(e)&&Array.isArray(t)?2===e.length?ev(e,t):hy(e,t):e===t}var qX;$s.mergeOptions(dX),$s.registerRenderer("gl",zr),$s.registerJSONType("Geo3DTilesLayer"),function(e){e[e.OUT_OF_FRUSTUM=0]="OUT_OF_FRUSTUM",e[e.SCREEN_ERROR_TOO_SMALL=1]="SCREEN_ERROR_TOO_SMALL",e[e.VISIBLE=2]="VISIBLE"}(qX||(qX={}));let ZX=null;function XX(){return ZX||(ZX={"image/crn":jj.crn&&jj.crn(),"image/ktx2":jj.ktx2&&jj.ktx2(),"image/cttf":jj.ktx2&&jj.ktx2(),draco:jj.draco&&jj.draco()}),ZX}const{Ajax:YX,GLTFLoader:JX}=Wj();class ri{constructor(e,t,n){this.jn=e,this.zn=t||JX,this.Re=n,this.Hn=XX()}static createEmptyB3DM(){return{featureTable:null,batchTable:null,gltf:{}}}load(e,t,n=0,i=0,s){return t?(i||(i=t.byteLength),this.qn(e,t,n,i,s)):YX.getArrayBuffer(e,{}).then((t=>{const s=t.data;return i||(i=s.byteLength),this.qn(e,s,n,i)}))}qn(e,t,n,i,s){const o=s&&s.maxTextureSize,a=this.$n(t,n,i,e);if(a.error)return Promise.resolve(a);const l=e.substring(0,e.lastIndexOf("/"));let h;try{h=new this.zn(l,a.glb,{transferable:!0,requestImage:this.jn,decoders:this.Hn,supportedFormats:this.Re,maxTextureSize:o})}catch(e){return Promise.resolve({error:e})}return h.load({skipAttributeTransform:!1}).then((t=>{t.url=`${e}-${n}-${i}`;const s=h.transferables;for(let e=0;e<a.transferables.length;e++)s.indexOf(a.transferables[e])<0&&s.push(a.transferables[e]);return{magic:"b3dm",count:a.count,transferables:s,featureTable:a.featureTable,batchTable:a.batchTable,batchTableBin:a.batchTableBin,gltf:t}}))}$n(e,t,n,i){const s=new DataView(e,t,n),o=s.getUint32(4,!0);if(1!==o){const e="Unsupported b3dm version: "+o+", url:"+i;return console.warn(e),{error:e}}if(s.getUint32(8,!0)!==s.byteLength){const e="Length in b3dm header is inconsistent with b3dm's byte length, url: "+i;return console.warn(e),{error:e}}let a,l=s.getUint32(12,!0),h=s.getUint32(16,!0),c=s.getUint32(20,!0),u=s.getUint32(24,!0),f=28+t;c>=570425344?(f-=8,a=l,c=h,u=0,l=0,h=0):u>=570425344&&(f-=4,a=c,c=l,u=h,l=0,h=0);const g=[e];let m,A,w;if(l>0?(m=IW(e,f,l),f+=l,a=m.BATCH_LENGTH):m={BATCH_LENGTH:a},h>0&&(f+=h),c>0&&(A=kW(e,f,c),f+=c,u>0)){const t=OW(0,f,u);w=e.slice(t.offset,t.offset+t.byteLength),f+=u,g.push(w)}const T=m.BATCH_LENGTH,S={};if(m&&m.BATCH_ID){S.BATCH_ID=RW(m.BATCH_ID,e,(void 0).offset,T);const t=S.BATCH_ID.array&&S.BATCH_ID.array.buffer;t&&g.indexOf(t)<0&&g.push(t)}return{count:a,transferables:g,featureTable:m,batchTable:A,batchTableBin:w,b3dm:S,glb:{buffer:e,byteOffset:f,byteLength:s.byteLength+s.byteOffset-f}}}Vn(){return null}}const{Ajax:QX,GLTFLoader:$X}=Wj();class oi{constructor(e,t,n,i){this.jn=e,this.zn=t||$X,this.Re=n,this.Hn=XX(),this.Jn=i}load(e,t,n=0,i=0,s){return t?(i||(i=t.byteLength),this.qn(e,t,n,i,s)):QX.getArrayBuffer(e,{}).then((t=>{const s=t.data;return i||(i=s.byteLength),this.qn(e,s,n,i)}))}qn(e,t,n,i,s){return this.Yn(e,t,n,i,s).then((({gltf:s,transferables:o})=>{const a=this.Zn(t,n,i,e);if(a.error)return Promise.resolve(a);for(let e=0;e<o.length;e++)-1===a.transferables.indexOf(o[e])&&a.transferables.push(o[e]);return delete s.transferables,Promise.resolve({magic:"i3dm",count:a.count,transferables:a.transferables,featureTable:a.featureTable,batchTable:a.batchTable,batchTableBin:a.batchTableBin,i3dm:a.i3dm,gltf:s})}))}Yn(e,t,n,i,s){const o={transferable:!0,requestImage:this.jn,decoders:this.Hn,supportedFormats:this.Re,maxTextureSize:s&&s.maxTextureSize},a=new DataView(t,n,i),l=32+a.getUint32(12,!0)+a.getUint32(16,!0)+a.getUint32(20,!0)+a.getUint32(24,!0);if(0===a.getUint32(28,!0)){let i=kj(new Uint8Array(t,l+n,a.byteLength-l));return-1==i.indexOf("://")&&(i=e.substring(0,e.lastIndexOf("/"))+"/"+i),i.indexOf(".glb")>0?QX.getArrayBuffer(i,{}).then((e=>this.Kn(i,{buffer:e.data,byteOffset:0},o))):QX.getJSON(i,{}).then((e=>this.Kn(i,e,o)))}return this.Kn(e,{buffer:t,byteOffset:l+n,byteLength:a.byteLength-l},o)}Kn(e,t,n){const i=e.substring(0,e.lastIndexOf("/")),s=new this.zn(i,t,n);return s.load({skipAttributeTransform:!0}).then((n=>{let i=0,o=0;return t.buffer&&(i=t.byteOffset||0,o=t.byteLength||0),n.url=`${e}-${i}-${o}`,{transferables:s.transferables,gltf:n}}))}Zn(e,t,n,i){const s=new DataView(e,t,n),o=s.getUint32(4,!0);if(1!==o){const e="Unsupported pnts version: "+o+", url:"+i;return console.warn(e),{error:e}}if(s.getUint32(8,!0)!==s.byteLength){const e="Length in pnts header is inconsistent with pnts's byte length, url: "+i;return console.warn(e),{error:e}}const a=[e],{featureTable:l,featureTableBin:h,batchTable:c,batchTableBin:u}=GW(s,32+t,a),f={},g=l.INSTANCES_LENGTH;if(l.POSITION){const{byteOffset:t}=l.POSITION;f.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:g,componentType:5126,array:new Float32Array(e,t+h.offset,3*g).slice()},a.push(f.POSITION.array.buffer)}else if(l.POSITION_QUANTIZED){const t=l.QUANTIZED_VOLUME_OFFSET,n=l.QUANTIZED_VOLUME_SCALE,{byteOffset:i}=l.POSITION_QUANTIZED;f.POSITION={byteStride:12,byteOffset:0,itemSize:3,count:g,componentType:5126,array:this.Xn(new Uint16Array(e,i+h.offset,3*g),t,n)},a.push(f.POSITION.array.buffer)}if(l.BATCH_ID){f.BATCH_ID=RW(l.BATCH_ID,e,h.offset,g);const t=f.BATCH_ID.array&&f.BATCH_ID.array.buffer;t&&a.indexOf(t)<0&&a.push(t)}if(l.NORMAL_UP){let{byteOffset:t}=l.NORMAL_UP;f.NORMAL_UP={byteStride:0,byteOffset:0,itemSize:3,count:g,componentType:5126,array:new Float32Array(e,t+h.offset,3*g).slice()},a.push(f.NORMAL_UP.array.buffer),t=l.NORMAL_RIGHT.byteOffset,f.NORMAL_RIGHT={byteStride:0,byteOffset:0,itemSize:3,count:g,componentType:5126,array:new Float32Array(e,t+h.offset,3*g).slice()},a.push(f.NORMAL_RIGHT.array.buffer)}else if(l.NORMAL_UP_OCT32P){let{byteOffset:t}=l.NORMAL_UP_OCT32P;f.NORMAL_UP={byteStride:0,byteOffset:0,itemSize:3,count:g,componentType:5126,array:this.Wn(new Uint16Array(e,t+h.offset,2*g))},a.push(f.NORMAL_UP.array.buffer),t=l.NORMAL_RIGHT_OCT32P.byteOffset,f.NORMAL_RIGHT={byteStride:0,byteOffset:0,itemSize:3,count:g,componentType:5126,array:this.Wn(new Uint16Array(e,t+h.offset,2*g))},a.push(f.NORMAL_RIGHT.array.buffer)}if(l.SCALE){const{byteOffset:t}=l.SCALE;f.SCALE={byteStride:0,byteOffset:0,itemSize:1,count:g,componentType:5126,array:new Float32Array(e,t+h.offset,g).slice()},a.push(f.SCALE.array.buffer)}else if(l.SCALE_NON_UNIFORM){const{byteOffset:t}=l.SCALE_NON_UNIFORM;f.SCALE_NON_UNIFORM={byteStride:0,byteOffset:0,itemSize:3,count:g,componentType:5126,array:new Float32Array(e,t+h.offset,3*g).slice()},a.push(f.SCALE_NON_UNIFORM.array.buffer)}return{count:g,batchTable:c,batchTableBin:u,featureTable:l,i3dm:f,transferables:a}}Wn(e){const t=e.length/2,n=new Float32Array(3*t),i=[];for(let s=0;s<t;s++)KX(i,e[2*s],e[2*s+1],65535),n[3*s]=i[0],n[3*s+1]=i[1],n[3*s+2]=i[2];return n}Xn(e,t,n){return zW(new Float32Array(e.length),e,t,n)}Vn(){return null}}function KX(e,t,n,i){if(e[0]=eY(t,i),e[1]=eY(n,i),e[2]=1-(Math.abs(e[0])+Math.abs(e[1])),e[2]<0){const t=e[0];e[0]=(1-Math.abs(e[1]))*tY(t),e[1]=(1-Math.abs(t))*tY(e[1])}return ry(e,e)}function eY(e,t){return function(e,t,n){return e<0?0:e>n?n:e}(e,0,t=function(e,t){return null!=e?e:255}(t))/t*2-1}function tY(e){return e<0?-1:1}const{Ajax:nY}=Wj();class ui{constructor(){}load(e,t,n=0,i=0){return t?(i||(i=t.byteLength),this.qn(e,t,n,i)):nY.getArrayBuffer(e,{}).then((t=>{const s=t.data;return i||(i=s.byteLength),this.qn(e,s,n,i)}))}qn(e,t,n,i){return this.Qn(t,n,i,e).then((e=>e.error?e:{magic:"pnts",count:e.count,transferables:e.transferables,featureTable:e.featureTable,batchTable:e.batchTable,batchTableBin:e.batchTableBin,pnts:e.pnts}))}Qn(e,t,n,i){const s=new DataView(e,t,n),o=s.getUint32(4,!0);if(1!==o){const e="Unsupported pnts version: "+o+", url:"+i;return console.warn(e),{error:e}}if(s.getUint32(8,!0)!==s.byteLength){const e="Length in pnts header is inconsistent with pnts's byte length, url: "+i;return console.warn(e),{error:e}}const a=[e],{featureTable:l,featureTableBin:h,batchTable:c,batchTableBin:u}=GW(s,t+28,a),f=l.QUANTIZED_VOLUME_OFFSET,g=l.QUANTIZED_VOLUME_SCALE,m=l.POINTS_LENGTH;let A,w={};if(l.extensions&&l.extensions["3DTILES_draco_point_compression"]){w=l.extensions["3DTILES_draco_point_compression"],A=new DataView(e,w.byteOffset+h.offset,w.byteLength);const t={attributes:w.properties,useUniqueIDs:!1};return this.tr||(this.tr=XX().draco),this.tr(A,t).then((t=>{const n=t.attributes;!l.POSITION&&!l.POSITION_QUANTIZED||n.POSITION||n.POSITION_QUANTIZED||(n.POSITION=l.POSITION,n.POSITION_QUANTIZED=l.POSITION_QUANTIZED),!(l.RGB||l.RGBA||l.RGB565)||n.RGB||n.RGBA||n.RGB565||(n.RGB=l.RGB,n.RGBA=l.RGBA,n.RGB565=l.RGB565),!l.NORMAL&&!l.NORMAL_OCT16P||n.NORMAL||n.NORMAL_OCT16P||(n.NORMAL=l.NORMAL,n.NORMAL_OCT16P=l.NORMAL_OCT16P);const i=this.er(e,t.attributes,h.offset,m,a,f,g);if(t.attributes.BATCH_ID){const e=t.attributes.BATCH_ID.array;i.BATCH_ID={byteStride:0,byteOffset:0,itemSize:1,count:e.length,componentType:BW(e.constructor),array:e},a.push(e.buffer)}else if(l.BATCH_ID||Object.keys(c).length){i.BATCH_ID=l.BATCH_ID?RW(l.BATCH_ID,e,h.offset,m):rY(m);const t=i.BATCH_ID.array&&i.BATCH_ID.array.buffer;t&&a.indexOf(t)<0&&a.push(t)}return{count:m,batchTable:c,batchTableBin:u,featureTable:l,pnts:i,transferables:a}}))}const T=this.er(e,l,h.offset,m,a,f,g);if(l.BATCH_ID||Object.keys(c).length){T.BATCH_ID=l.BATCH_ID?RW(l.BATCH_ID,e,h.offset,m):rY(m);const t=T.BATCH_ID.array&&T.BATCH_ID.array.buffer;t&&a.indexOf(t)<0&&a.push(t)}return Promise.resolve({count:m,batchTable:c,batchTableBin:u,featureTable:l,pnts:T,transferables:a})}er(e,t,n,i,s,o,a){const l={};if(t.POSITION){let{byteOffset:o,array:a}=t.POSITION;o=o||0;const h=a?0:n;if(!a){const t=e.slice(o+h,o+h+3*i*4);a=new Float32Array(t)}l.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:i,componentType:5126,array:a},s.push(a.buffer)}else if(t.POSITION_QUANTIZED){let{byteOffset:h}=t.POSITION_QUANTIZED;const{array:c}=t.POSITION_QUANTIZED;h=h||0;l.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:i,componentType:5126,array:this.Xn(c||new Uint16Array(e,h+(c?0:n),3*i),o,a)},s.push(l.POSITION.array.buffer)}if(t.RGBA){let{byteOffset:o,array:a}=t.RGBA;o=o||0;const h=a?0:n;if(!a){const t=e.slice(o+h,o+h+4*i);a=new Uint8Array(t)}l.RGBA={byteStride:0,byteOffset:0,itemSize:4,count:i,componentType:5121,array:a},s.push(a.buffer)}else if(t.RGB){let{byteOffset:o,array:a}=t.RGB;o=o||0;const h=a?0:n;if(!a){const t=e.slice(o+h,o+h+3*i);a=new Uint8Array(t)}l.RGB={byteStride:0,byteOffset:0,itemSize:3,count:i,componentType:5121,array:a},s.push(a.buffer)}else if(t.RGB565){let{byteOffset:o,array:a}=t.RGB565;o=o||0;const h=a?0:n;if(!a){const t=e.slice(o+h,o+h+2*i);a=new Uint16Array(t)}l.RGB565={byteStride:0,byteOffset:0,itemSize:1,count:i,componentType:5123,array:a},s.push(a.buffer)}if(t.NORMAL){let{byteOffset:o,array:a}=t.NORMAL;o=o||0;const h=a?0:n;if(!a){const t=e.slice(o+h,o+h+3*i*4);a=new Float32Array(t)}l.NORMAL={byteStride:0,byteOffset:0,itemSize:3,count:i,componentType:5126,array:a},s.push(a.buffer)}else if(t.NORMAL_OCT16P){let{byteOffset:o,array:a}=t.NORMAL_OCT16P;o=o||0;const h=a?0:n;if(!a){const t=e.slice(o+h,o+h+2*i);a=new Uint8Array(t)}l.NORMAL_OCT16P={byteStride:0,byteOffset:0,itemSize:2,count:i,componentType:5121,array:a},s.push(a.buffer)}return l}Xn(e,t,n){return zW(new Float32Array(e.length),e,t,n)}Vn(){return null}}function rY(e){const t=Rj(e),n=new t(e);for(let t=0;t<e;t++)n[t]=t;return{byteStride:0,byteOffset:0,itemSize:1,count:e,componentType:BW(t),array:n}}const{Ajax:iY,GLTFLoader:sY}=Wj();class pi{constructor(e,t,n,i){this.Re=n,this.jn=e,this.zn=t||sY,this.Jn=i}load(e,t,n=0,i=0,s){return t?this.qn(e,t,n,i,s):iY.getArrayBuffer(e,{}).then((t=>this.qn(e,t.data,n,i)))}qn(e,t,n,i,s){i||(i=t.byteLength);const o=this.nr(t,e,n,i),a=[];for(let n=0;n<o.length;n++){let i;if("b3dm"===o[n].magic)i=new ri(this.jn,this.zn,this.Re);else if("i3dm"===o[n].magic)i=new oi(this.jn,this.zn,this.Re,this.Jn);else if("pnts"===o[n].magic)i=new ui;else{if("cmpt"!==o[n].magic){console.warn("Unsupported magic in CMPT tile:",o[n].magic);continue}i=new pi(this.jn,this.zn,this.Re,this.Jn)}a.push(i.load(e,t,o[n].offset,o[n].byteLength,s).then((e=>e)))}return Promise.all(a).then((e=>({magic:"cmpt",tiles:e})))}nr(e,t,n,i){const s=new DataView(e,n,i),o=s.getUint32(4,!0);if(1!==o){const e="Unsupported cmpt version: "+o+", url:"+t;return console.warn(e),{error:e}}if(16===s.byteLength)return[];const a=[],l=s.getUint32(12,!0);let h=16;for(let t=0;t<l;t++){const t=CW(s,h),i=s.getUint32(h+8,!0);a.push({magic:t,buffer:e,offset:h+n,byteLength:i}),h+=i}return a}}if(ox){const e=zu.VERSION;if(e.indexOf("1.0.0-beta")>=0||e.indexOf("1.0.0-alpha")>=0){co("@maptalks/3dtiles",ox.inject(OV))}else co("@maptalks/3dtiles",(function(){return ox.inject(OV)}))}else co("@maptalks/3dtiles",OV);"undefined"!=typeof console&&console.log("@maptalks/3dtiles v0.106.6");
/*!
   * @maptalks/gltf-layer v0.106.0
   * LICENSE : UNLICENSED
   * (c) 2016-2025 maptalks.org
   */
const oY='function(e){\n/*!\n     * @maptalks/gl v0.110.0\n     * LICENSE : UNLICENSED\n     * (c) 2016-2025 maptalks.com\n     */\nconst n=function(){if("undefined"!=typeof undefinedThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof undefined)return global;throw new Error("unable to locate global object")},t=n(),r=t.gl_trans__coders=t.gl_trans__coders||{};r.inject=function(e){const r=e.toString(),o=r.indexOf("{")+1,s=r.substring(0,o),a=t.gl_trans__coders=t.gl_trans__coders||{};let c=`${s}\\n    const _____getGlobal = ${n.toString()};\\n    const g___lobals = _____getGlobal()\\n    const tran_____scoders = g___lobals[\'gl_trans__coders\'] = g___lobals[\'gl_trans__coders\'] || {};`;for(const e in a)"inject"!==e&&"getTranscoder"!==e&&"registerTranscoder"!==e&&(c+=\'tran_____scoders["\'+e+\'"] =\'+a[e].toString()+"\\n;");return c+="\\n("+n().maptalks_gltf_loader_bundle.toString()+")({});\\n",c+="\\n"+r.substring(s.length),c},r.registerTranscoder=function(e,n){r[e]=n},r.getTranscoder=function(e){return r[e]};const o=n().maptalks_gltf_loader,s={"image/crn":r.crn&&r.crn(),"image/ktx2":r.ktx2&&r.ktx2(),"image/cttf":r.ktx2&&r.ktx2(),"draco":r.draco&&r.draco()};let a;const c={};function i(e,n,t){return new o.GLTFLoader(e,n,t).load({skipAttributeTransform:!0})}function f(e,n,t,r){const a=n.lastIndexOf("/"),c=n.slice(0,a);r&&(n=r(n));const f=(...n)=>l.call(this,e,...n);return function(e,n){return o.Ajax.getArrayBuffer(e,n)}(n,t).then((e=>{if(e.message)return e;const a=e.data;return new DataView(a,a.byteOffset,a.byteLength).getUint32(4,!0)>2?function(e,n){return o.Ajax.getJSON(e,n)}(n,t).then((e=>e.message?e:i(c,e,{requestImage:f,decoders:s,transferable:!0,fetchOptions:t,urlModifier:r}))):i(c,{buffer:e.data,byteOffset:0},{requestImage:f,decoders:s,transferable:!0,fetchOptions:t,urlModifier:r})}))}function l(e,n,t,r){e?c[n]?c[n].push(r):(c[n]=[r],self.postMessage({type:"<request>",command:"sendImageData",actorId:e,workerId:a,params:n})):function(e,n){const t=new Image;t.onload=()=>{if(!u)return void n(new Error("There is no canvas to draw image!"));u.width=t.width,u.height=t.height;const e=u.getContext("2d");e.drawImage(t,0,0,t.width,t.height);const r=e.getImageData(0,0,t.width,t.height),o={width:t.width,height:t.height,data:new Uint8Array(r.data)};n(null,o,[o.data.buffer])},t.onerror=function(e){n(e)},t.src=e}(n,r)}const u="undefined"==typeof document?null:document.createElement("canvas");e.loadGLTF=f,e.onmessage=function(e){const n=e.data,t=n.url;if("addLayer"===n.command||"removeLayer"===n.command)a=e.workerId,self.postMessage({type:"<response>",actorId:n.actorId,workerId:a,params:"ok"});else if(t)!function(e){const n=e.data,t=e.callback,r=e.actorId,o=n.url,s=n.fetchOptions||{};s.referrerPolicy=s.referrerPolicy||"origin",s.referrer=n.referrer,f(r,o,s).then((e=>{e.message?self.postMessage({callback:t,error:e}):self.postMessage({callback:t,data:e},e.transferables)})).catch((e=>{self.postMessage({callback:t,error:e})})),c.receive=t}(e);else if(n.imageUrl){const e=c[n.imageUrl];if(delete c[n.imageUrl],e)for(let t=0;t<e.length;t++)e[t](null,n.result)}}}';function aY(e){return null==e}function lY(e){return!aY(e)}function hY(e,t){if(!e||!t)return null;let n=t;if(Array.isArray(t)){if(!Zi.isNumber(t[0]))return null;n=new fl(t)}const i=e.coordinateToPointAtRes(n,e.getGLRes()),s=e.altitudeToPoint(n.z||0,e.getGLRes());return[i.x,i.y,s]}function cY(e,t){return Math.abs(e)*Math.sign(t)}function uY(e,t,n){const i=Wl.Measurer.getInstance().measureLenBetween(e,t);let s=n.count;s&&n.snapToEndVertexes&&(s-=1);const o=s>0?i/s:n.gapLength+n.bboxWidth,a=Math.floor(i/o),l=[],h=n.rotateAlongLine+function(e,t,n){const i=n.getGLRes(),s=n.coordinateToPointAtRes(e,i),o=n.coordinateToPointAtRes(t,i);return Zi.computeDegree(o.x,o.y,s.x,s.y)/Math.PI*180}(e,t,n.map);if(a>=1){const s=0,c=a;if(n.snapToEndVertexes)for(let n=s;n<=c;n++){const s={coordinates:fY(e,t,o*n/i),scale:[1,1,1],rotation:[0,0,h]};l.push(s)}else for(let n=s+1;n<=c;n++){const s={coordinates:fY(e,t,o*(n-.5)/i),scale:[1,1,1],rotation:[0,0,h]};l.push(s)}if(n.scaleEndModel){const n=(i-o*a)/o,s={coordinates:fY(e,t,(o*a+(i-o*a)/2)/i),scale:[n,1,1],rotation:[0,0,h]};l.push(s)}}else if(n.scaleEndModel){const n=i/o,s={coordinates:fY(e,t,.5),scale:[n,1,1],rotation:[0,0,h]};l.push(s)}return l}function fY(e,t,n){const i=dY(e.x,t.x,n),s=dY(e.y,t.y,n);return new fl(i,s)}function dY(e,t,n){return e+n*(t-e)}const pY={},gY="undefined"==typeof document?null:document.createElement("canvas");let mY=class P extends Um.Actor{constructor(e,t){super(e),this.mapId=t.getMap().id,this.i=t}loadGLTF(e){const t=function(e){let t=document.createElement("a");return t.href=e,e=t.href,t=null,e}(e),n={url:t,referrer:window&&window.location.href,fetchOptions:this.i.options.fetchOptions};return new Promise(((e,t)=>{this.send(n,null,((n,i)=>{n?t(n):e(i)}))}))}sendImageData(e,t){!function(e,t){const n=new Image;n.onload=()=>{if(!gY)return void t(new Error("There is no canvas to draw image!"));gY.width=n.width,gY.height=n.height;const e=gY.getContext("2d");e.drawImage(n,0,0,n.width,n.height);const i=e.getImageData(0,0,n.width,n.height),s={width:n.width,height:n.height,data:new Uint8Array(i.data)};t(null,s)},n.onerror=function(e){t(e)},n.src=e}(e,((n,i)=>{n||this.isActive()&&t(null,{result:i,imageUrl:e})}))}addLayer(e,t,n){this.broadcast({actorId:this.actorId,mapId:this.mapId,layerId:e,command:"addLayer",params:{options:t}},null,n)}removeLayer(e,t,n){this.broadcast({mapId:this.mapId,layerId:e,command:"removeLayer"},null,n)}};
/*!
   * @maptalks/gl v0.110.0
   * LICENSE : UNLICENSED
   * (c) 2016-2025 maptalks.com
   */const AY=function(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")},yY=AY(),_Y=yY.gl_trans__coders=yY.gl_trans__coders||{};_Y.inject=function(e){const t=e.toString(),n=t.indexOf("{")+1,i=t.substring(0,n),s=yY.gl_trans__coders=yY.gl_trans__coders||{};let o=`${i}\n    const _____getGlobal = ${AY.toString()};\n    const g___lobals = _____getGlobal()\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};`;for(const e in s)"inject"!==e&&"getTranscoder"!==e&&"registerTranscoder"!==e&&(o+='tran_____scoders["'+e+'"] ='+s[e].toString()+"\n;");return o+="\n("+AY().maptalks_gltf_loader_bundle.toString()+")({});\n",o+="\n"+t.substring(i.length),o},_Y.registerTranscoder=function(e,t){_Y[e]=t},_Y.getTranscoder=function(e){return _Y[e]};const vY=AY().maptalks_gltf_loader,xY={"image/crn":_Y.crn&&_Y.crn(),"image/ktx2":_Y.ktx2&&_Y.ktx2(),"image/cttf":_Y.ktx2&&_Y.ktx2(),draco:_Y.draco&&_Y.draco()};let bY;const wY={};function TY(e,t,n){return new vY.GLTFLoader(e,t,n).load({skipAttributeTransform:!0})}function SY(e,t,n,i){const s=t.lastIndexOf("/"),o=t.slice(0,s);i&&(t=i(t));const a=(...t)=>MY.call(this,e,...t);return function(e,t){return vY.Ajax.getArrayBuffer(e,t)}(t,n).then((e=>{if(e.message)return e;const s=e.data;return new DataView(s,s.byteOffset,s.byteLength).getUint32(4,!0)>2?function(e,t){return vY.Ajax.getJSON(e,t)}(t,n).then((e=>e.message?e:TY(o,e,{requestImage:a,decoders:xY,transferable:!0,fetchOptions:n,urlModifier:i}))):TY(o,{buffer:e.data,byteOffset:0},{requestImage:a,decoders:xY,transferable:!0,fetchOptions:n,urlModifier:i})}))}function MY(e,t,n,i){e?wY[t]?wY[t].push(i):(wY[t]=[i],self.postMessage({type:"<request>",command:"sendImageData",actorId:e,workerId:bY,params:t})):function(e,t){const n=new Image;n.onload=()=>{if(!CY)return void t(new Error("There is no canvas to draw image!"));CY.width=n.width,CY.height=n.height;const e=CY.getContext("2d");e.drawImage(n,0,0,n.width,n.height);const i=e.getImageData(0,0,n.width,n.height),s={width:n.width,height:n.height,data:new Uint8Array(i.data)};t(null,s,[s.data.buffer])},n.onerror=function(e){t(e)},n.src=e}(t,i)}const CY="undefined"==typeof document?null:document.createElement("canvas"),PY=[],IY=[],kY=[],OY=[],EY=[1,1,1],RY=[],LY=[],DY=[1,1,1],FY=[],HY=new CM.BoundingBox,NY=function(e,t){const n=[];return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=0,n[4]=e[3],n[5]=e[4],n[6]=e[5],n[7]=0,n[8]=e[6],n[9]=e[7],n[10]=e[8],n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1,n}(function(e){const t=Math.cos(e),n=Math.sin(e),i=[];return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=t,i[5]=n,i[6]=0,i[7]=-n,i[8]=t,i}(.5*Math.PI),[0,0,0]),BY=new Re(0,0),zY=[186/255,186/255,186/255,1],GY={lightAmbient:[1,1,1],lightDiffuse:[1,1,1],lightSpecular:[1,1,1],lightDirection:[1,1,1]},UY=new Set(["url","translationX","translationY","translationZ","rotationX","rotationY","rotationZ","scaleX","scaleY","scaleZ","anchorZ","markerPixelHeight","modelHeight"]),VY=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1],jY=[0,1,1,2,2,3,3,0,0,4,1,5,2,6,3,7,4,5,5,6,6,7,7,4],WY=[.8,.8,.1,1];class ct extends mf{constructor(e,t){const n=Zi.extend({},t),i=n.symbol;super(e,n),this.options.symbol=i,this.o=!1,this.h=AA([]),this.l="gltfmarker",this.u=!0,this.m=!0,this.p={get translation(){return[0,0,0]},get rotation(){return[0,0,0]},get scale(){return[1,1,1]}},this._()}static parseJSONData(e){const t=ct.fromJSON(e);return t.setZoomOnAdded(e.zoomOnAdded),t}static fromJSON(e){return new ct(e.coordinates,e.options)}static getGLTFAnchorsAlongLineString(e,t,n,i){const s=[];for(let o=0;o<e.length-1;o++){const a=uY(e[o],e[o+1],{map:n,bboxWidth:t,gapLength:i.gapLength||0,count:i.count,rotateAlongLine:i.rotateAlongLine,snapToEndVertexes:i.snapToEndVertexes,scaleEndModel:i.scaleEndModel});Zi.pushIn(s,a)}return s}static combineGLTFBoundingBox(e){const t=[];for(let n=0;n<e.length;n++){const i=e[n].getBoundingBox();t.push([i.min,i.max])}const n=t[0];if(!n)return null;const i=qA([],n[0]),s=qA([],n[1]);for(let e=1;e<t.length;e++){const n=t[e],o=qA([],n[0]),a=qA([],n[1]);o[0]<i[0]&&(i[0]=o[0]),o[1]<i[1]&&(i[1]=o[1]),o[2]<i[2]&&(i[2]=o[2]),a[0]>s[0]&&(s[0]=a[0]),a[1]>s[1]&&(s[1]=a[1]),a[2]>s[2]&&(s[2]=a[2])}return{min:i,max:s}}setTransformOrigin(e){this.M=e}getTransformOrigin(){return this.M||this.getCenter()}getMeshes(e,t,n){let i=[];const s=this.getMap();if(t&&(this.regl=t),this.getLayer().isVisible()&&this.isVisible()&&this.S()){if(!this.O)return this.k(e,t),i;let o=this.isAnimated()||this.A()&&s.isZooming()||this.m||"multigltfmarker"===this.getGLTFMarkerType()&&this.u||"effectmarker"===this.getGLTFMarkerType();if(!o){const e=this.h;mA(RY,e),this._(),o=!zA(e,RY)}o&&this.T(this.O,n),i=this.O.filter((e=>!!(mV(s.projViewMatrix,e.getBoundingBox())||e instanceof CM.InstancedMesh)&&(this.v(e,n),this.L(e),!0))),this.I(!1)}return i}getGLTFJSON(){return this.F}getAllMeshes(){return this.O}C(){return this.F}P(e){this.F=e}N(e,t){this._externSymbol=this._externSymbol||{},this._externSymbol[e]=t,"uniforms"===e&&(this.D=!0)}setUrl(e){return this.updateSymbol({url:e}),this}setSymbol(e){const t=this.getUrl();super.setSymbol(e);const n=this.getShader(),i=this.G;i&&e.url!==t&&(i.logoutGLTF(t),this.B=!1,this.R(!1),delete this.O),this.U&&this.U!==n&&this.J(i,this.regl),this.U=n,this.D=!0,this.u=!0}getCenter(){const e=this.getMap();if(!e)return null;const t=hY(e,super.getCenter()||this.getCoordinates());if(!t)return null;const n=this.j(),i=new Re([t[0]+n[0],t[1]+n[1],t[2]+n[2]]),s=e.getGLRes(),o=e.pointAtResToCoord(i,s);return o.z=i.z/e.altitudeToPoint(100,s)*100,o}getPointZ(){const e=this.getCoordinates(),t=this.getMap();return t&&e?t.altitudeToPoint(e.z||0,t.getGLRes()):null}getUrl(){const e=this._getInternalSymbol();return e&&e.url||"pyramid"}addTo(e){if(this.getLayer())throw new Error("GLTFMarker cannot be added to two or more layers at the same time.");return e.addGeometry(this),this}k(e,t){const n=this.getUrl();if(this.G=e,!this.B){const t=this.getLayer().getRenderer();e.loginGLTF(n,((...e)=>t.Z.apply(t,e))),this.B=!0}const i=e.getGLTF(n);i&&!i.then&&(this.R(!0),this.H(i,e,t))}v(e,t){"effectmarker"===this.getGLTFMarkerType()?this.updateUV(t):"glowmarker"===this.getGLTFMarkerType()&&this.q();const n=this.getUniforms();if(n&&this.isDirty()&&this.V())for(const t in n)e.setUniform(t,n[t]);this.W()&&(e.transparent=!0),e.setUniform("uPickingId",this.X()),e.properties.isAnimated=this.isAnimated()}L(e){const t=this.getShader(),n=e.getDefines();let i=!1;if("pbr"===t||"pbr-lite"===t){const e=this.getLayer(),{iblTexes:t}=CM.pbr.PBRUtils.getIBLResOnCanvas(e.getRenderer().canvas);t?n.HAS_IBL_LIGHTING||(n.HAS_IBL_LIGHTING=1,i=!0):n.HAS_IBL_LIGHTING&&(i=!0,delete n.HAS_IBL_LIGHTING)}i&&e.setDefines(n);const s=this.getLayer().getRenderer();s&&s.updateMaskDefines(e)}J(e){const t=this.getUrl(),n=this.O;e&&n&&(e.isSimpleModel(t)?this.Y(n):e.getGLTF(t)&&(n.forEach((e=>{this.v(e)})),this.Y(n)))}Y(e){const t=this.getShader();e.forEach((e=>{const n=this.$(e.properties.geometryResource);"wireframe"===t?(e.properties.geometryResource&&!e.properties.geometryResource.copyGeometry&&e.properties.geometryResource.copyEdgeGeometry(),e.geometry=e.properties.geometryResource.copyGeometry):e.geometry=e.properties.geometryResource.geometry,e.material=n}))}T(e,t){ZA(EY,1,1,1);const n=AA(RY),i=this.isAnimated();this._();const s=this.getModelMatrix(),{nodeMatrixMap:o,skinMap:a}=this.K(t);this.tt(EY);let l=0;e.forEach((e=>{const t=e.properties.geometryResource.nodeIndex,h=o[t],c=i&&h?h:e.nodeMatrix;bA(n,s,EY),vA(n,n,NY),e.st=e.st||AA([]);const u=vA(FY,e.st,c);e instanceof CM.InstancedMesh?(e.positionMatrix=vA(e.positionMatrix,n,u),e.localTransform=this.it(),this.et(e)):e.localTransform=vA(e.localTransform,n,u);const f=e.geometry.boundingBox.copy(HY);f.transform(e.positionMatrix,e.localTransform);const g=this.nt(f);if(Math.abs(g)>Math.abs(l)&&(l=g),i){const n=a[t];n&&(e.material.set("skinAnimation",1),e.material.set("jointTextureSize",n.jointTextureSize),e.material.set("numJoints",n.numJoints),e.material.set("jointTexture",n.jointTexture));const i=e.geometry.properties.morphWeights;i&&this.rt(i,e.material)}else e.material.set("skinAnimation",0)}));const h=this.ot();if(h&&(bA(n,s,EY),vA(n,n,NY),this.ht.localTransform=vA(this.ht.localTransform,n,this.ht.ct)),0!==l){ZA(LY,0,0,l);const t=TA(RY,LY);e.forEach((e=>{if(e instanceof CM.InstancedMesh)e.positionMatrix=vA(e.positionMatrix,t,e.positionMatrix),this.et(e);else{const n=vA(e.localTransform,t,e.localTransform);e.localTransform=n}})),h&&(this.ht.localTransform=vA(this.ht.localTransform,t,this.ht.localTransform))}e.forEach((e=>{e instanceof CM.InstancedMesh&&this.et(e)})),this.fire("updatematrix",{target:this})}getBoundingBoxCenter(){const e=this.lt,t=this.getMap();if(!e||!this.ht||!t)return null;const n=t.getGLRes(),{min:i,max:s}=e,o=XA([],i,s);$A(o,o,.5),oy(o,o,this.ht.localTransform);const a=new Re(o),l=t.pointAtResToCoordinate(a,n);return l.z=100/t.altitudeToPoint(100,n)*o[2],l}getBoundingBoxWidth(e){const t=this.lt;if(!t)return 0;let n=0;"x"===e?n=0:"y"===e?n=2:"z"===e&&(n=1);const{min:i,max:s}=t,o=this.ut()[n];return(s[n]-i[n])*o}getAxisXWidth(){return this.getBoundingBoxWidth("x")}getAxisYWidth(){return this.getBoundingBoxWidth("y")}getAxisZWidth(){return this.getBoundingBoxWidth("z")}tt(e){const t=this.getMap(),n=t.getGLRes(),i=t.altitudeToPoint(100,n);return e[0]*=i/100,e[1]*=i/100,e[2]*=i/100,e}ft(e,t){return this.gltfPack.calModelHeightScale(e,t)}dt(e,t){const n=this.lt;if(!t||t<0||!n)return e;const i=this.getMap(),s=Math.abs(n.max[1]-n.min[1]),o=i.altitudeToPoint(s,i.getGLRes()),a=t*i.getGLScale()/o;return ZA(e,a,a,a)}getCurrentPixelHeight(){const e=this.getBoundingBox();return Math.abs(e.max[2]-e.min[2])/this.getMap().getGLScale()}getFitTranslate(e){const t=this.lt,n=ZA(e,(t.min[0]+t.max[0])/2,(t.min[1]+t.max[1])/2,(t.min[2]+t.max[2])/2);return $A(n,n,-1)}nt(e){const t=this.getSymbol(),n=t&&t.anchorZ||"center";let i=0;const s=e.max[2]-e.min[2];return"bottom"===n?i=s/2:"top"===n&&(i=-s/2),i}K(e){const t=this.isAnimated(),n=this.gt(),i={},s=this._t();if(e&&t&&this.gltfPack&&n){const t=this.yt();if(lY(t)){this.wt(e);const n=this.bt(),o=this.isAnimationLooped(),a=this.getAnimationSpeed(),l=this.getSymbol(),h=l&&l.animationNodes;for(let l=0;l<t.length;l++)this.gltfPack.updateAnimation(e,o,a,t[l],n,i,s,h)}else console.warn("animation specified does not exist!")}return{nodeMatrixMap:i,skinMap:s}}H(e,t,n){const i=this.getUrl();this.P(e.json),this.Mt(i,t,n),this.J(t,n),this.createdBygltfmarker||(this.fire("load",{data:e.json}),this.fire("setUrl-debug"),this._fireEvent("meshcreate",{url:i}))}Mt(e,t,n){const i=[],s=this.getShader(),o=t.getGLTF(e);if(o&&o.resources){if(!o.resources.length)return void this._fireEvent("modelerror",{url:e,info:"there are no geomtries in the gltf model"});this.gltfPack=o.gltfPack,o.resources.forEach((e=>{const t=this.xt(e,s,n);i.push(t)}))}this.O=i,this.lt=this.St(),this.Ot(this.O),this.fire("createscene-debug",{meshes:this.O})}Ot(e){this.T(e);const t=this.getBoundingBox();if(!t)return;const n=this.getMap(),{max:i,min:s}=t;jA([i[0]-s[0],i[1]-s[1],i[2]-s[2]])/n.getGLScale()<20&&(console.warn("Model's size on screen is too small, try to increase its symbol.scaleX/Y/Z"),this.fire("smallonscreen"))}ot(){if(this.ht)return this.ht.material.set("lineColor",this.kt||WY),this.ht.material.set("lineOpacity",this.At||1),this.ht;const e=this.lt;if(!e)return null;const{min:t,max:n}=e;VY[0]=n[0],VY[1]=t[1],VY[2]=n[2],VY[3]=n[0],VY[4]=n[1],VY[5]=n[2],VY[6]=t[0],VY[7]=n[1],VY[8]=n[2],VY[9]=t[0],VY[10]=t[1],VY[11]=n[2],VY[12]=n[0],VY[13]=t[1],VY[14]=t[2],VY[15]=n[0],VY[16]=n[1],VY[17]=t[2],VY[18]=t[0],VY[19]=n[1],VY[20]=t[2],VY[21]=t[0],VY[22]=t[1],VY[23]=t[2];const i=new CM.Geometry({POSITION:VY},jY,0,{primitive:"lines",positionAttribute:"POSITION"});i.generateBuffers(this.regl);const s=new CM.Mesh(i,new CM.Material({lineColor:this.kt||WY,lineOpacity:this.At||1}));return this.ht=s,this.ht.ct=mA([],s.localTransform),s}showBoundingBox(e){this.options.showDebugBoundingBox=!0,this.kt=e&&e.lineColor,this.At=e&&e.lineOpacity,this.u=!0}hideBoundingBox(){this.options.showDebugBoundingBox=!1,this.u=!0}getBoundingBox(){const e=this.O;if(!e||!e.length)return null;if(!this.m)return this.Tt;"multigltfmarker"===this.getGLTFMarkerType()&&e.forEach((e=>{this.et(e),e.updateBoundingBox()}));const t=e[0].getBoundingBox(),n=qA([],t[0]),i=qA([],t[1]);for(let t=1;t<e.length;t++){const s=e[t].getBoundingBox(),o=qA([],s[0]),a=qA([],s[1]);o[0]<n[0]&&(n[0]=o[0]),o[1]<n[1]&&(n[1]=o[1]),o[2]<n[2]&&(n[2]=o[2]),a[0]>i[0]&&(i[0]=a[0]),a[1]>i[1]&&(i[1]=a[1]),a[2]>i[2]&&(i[2]=a[2])}const s={min:n,max:i};return this.Tt=s,"multigltfmarker"===this.getGLTFMarkerType()?this.vt.length&&(this.m=!1):this.m=!1,s}St(){return this.gltfPack.getGLTFBBox()}xt(e,t,n){const i=this.Lt(e,t,n),s=i.getDefines();return i instanceof CM.InstancedMesh?(s.HAS_PICKING_ID=1,s.HAS_INSTANCE_COLOR=1):s.HAS_PICKING_ID=2,i.geometry.data.COLOR_0&&(s.HAS_COLOR0=1),s.HAS_MIN_ALTITUDE=1,s.HAS_LAYER_OPACITY=1,i.setDefines(s),i}Lt(e,t,n){const i=this.getGLTFMarkerType();let s=null;const o=this.$(e);let a=e.geometry;if("wireframe"===t&&(e.copyEdgeGeometry(),a=e.copyGeometry),n?a.generateBuffers(n):(this.It=this.It||[],this.It.push(a)),"multigltfmarker"===i){this.Ft();const e=this.Ct(AA(OY)),t=this.Pt();s=new CM.InstancedMesh(e.attributesData,t,a,o),s.setUniform("instance",1),n?s.generateInstancedBuffers(n):(this.Nt=this.Nt||[],this.Nt.push(s))}else s=new CM.Mesh(a,o),s.setUniform("instance",0);s.nodeMatrix=mA([],e.nodeMatrix),s.properties.geometryResource=e,s.properties.nodeIndex=e.nodeIndex,this.isBloom()&&(s.bloom=1),s.transparent=this.W(),"BLEND"===e.extraInfo.alphaMode&&(s.transparent=!0),s.properties.pickingId=this.X(),this.Dt(s);const l=this.getLayer();return Object.defineProperty(s.uniforms,"minAltitude",{enumerable:!0,get:()=>l.options.altitude||0}),s}$(e){let t=null;const n=this.getShader(),i=this.getUniforms()||{},s=e.materialInfo||{},o=this.getLayer().getRenderer();if("phong"===n)if("pbrSpecularGlossiness"===s.name)t=new CM.PhongSpecularGlossinessMaterial(s);else{for(const e in GY)i[e]=i[e]||GY[e];t=new CM.PhongMaterial(s)}else if("pbr"===n){if(t="pbrSpecularGlossiness"===s.name?new CM.pbr.StandardSpecularGlossinessMaterial(s):new CM.pbr.StandardMaterial(s),o.regl&&!CM.pbr.PBRUtils.isSupported(o.regl)){t=CM.PhongMaterial.convertFrom(t);for(const e in GY)i[e]=i[e]||GY[e]}}else t="pbr-lite"===n?new CM.StandardLiteMaterial(s):new CM.Material(s);const a=this.getSymbol(),l=a&&a.doubleSided;lY(l)&&(t.doubleSided=l);for(const e in i)t.set(e,i[e]);return e.morphWeights&&this.rt(e.morphWeights,t),e.skin&&t.set("skinAnimation",0),t}rt(e,t){const n=t.get("morphWeights1")||[],i=t.get("morphWeights2")||[];for(let t=0;t<4;t++)n[t]=e[t]||0,i[t]=e[t+4]||0;t.set("morphWeights1",n),t.set("morphWeights2",i)}Dt(e){const t=this.getSymbol();t&&t.uniforms?(e.setUniform("polygonFill",t.uniforms.polygonFill||zY),e.setUniform("polygonOpacity",void 0===t.uniforms.polygonOpacity?1:t.uniforms.polygonOpacity),e.setUniform("lineColor",t.uniforms.lineColor||zY),e.setUniform("lineOpacity",void 0===t.uniforms.lineOpacity?1:t.uniforms.lineOpacity)):(e.setUniform("polygonFill",zY),e.setUniform("polygonOpacity",1),e.setUniform("lineColor",zY),e.setUniform("lineOpacity",1))}Gt(){const e=this.getLayer();if(!e)return null;const t=e.getMap();if(!t)return null;const n=this.getBoundingBox();if(!n)return null;const i=n.min,s=n.max,o=Sy(IY,(i[0]+s[0])/2,(i[1]+s[1])/2,i[2],1),a=Sy(kY,(i[0]+s[0])/2,(i[1]+s[1])/2,s[2],1),l=Ny(o,o,t.projViewMatrix),h=Ny(a,a,t.projViewMatrix),c=(l[0]/l[3]+1)*t.width/2,u=(1-l[1]/l[3])*t.height/2,f=(h[0]/h[3]+1)*t.width/2,g=(1-h[1]/h[3])*t.height/2,m=Math.min(c,f),A=Math.max(c,f),w=Math.min(u,g),T=Math.max(u,g);return new Ml({xmin:m,ymin:w,xmax:A,ymax:T})}onAdd(){const e=this.getLayer().getMap();if(e&&!lY(this.Bt)){const t=e.getZoom();this.Bt=t}}onRemove(){this.Rt()}remove(){const e=this.getUrl();if(this.G&&(delete this.O,this.G.logoutGLTF(e),delete this.G),this.Et){for(const e in this.Et)this.Et[e]&&this.Et[e].jointTexture&&this.Et[e].jointTexture.destroy();delete this.Et}this.ht&&(this.ht.geometry.dispose(),this.ht.dispose(),delete this.ht),this.O&&this.O.forEach((e=>{e.dispose(),e.properties.bloomMesh&&(e.properties.bloomMesh.dispose(),delete e.properties.bloomMesh)})),this.B=!1,delete this.F,delete this.gltfPack,super.remove()}show(){return super.updateSymbol({visible:!0}),this}hide(){super.updateSymbol({visible:!1})}setBloom(e){return this.updateSymbol({bloom:e}),this}isBloom(){const e=this._getInternalSymbol();return e&&e.bloom}setCastShadow(e){return super.updateSymbol({shadow:e}),this}isCastShadow(){const e=this._getInternalSymbol();return e&&(e.shadow||void 0===e.shadow)}outlineNodes(e){const t=this.O;return t?(t.forEach((t=>{e.indexOf(t.properties.nodeIndex)>-1&&(t.properties.outline=!0)})),this.u=!0,this):this}outline(){this.updateSymbol({outline:!0});const e=this.O;return e?(e.forEach((e=>{e.properties.outline=!0})),this.u=!0,this):this}cancelOutline(e){this.updateSymbol({outline:!1});const t=this.O;return t?(t.forEach((t=>{e?e.indexOf(t.properties.nodeIndex)>-1&&(t.properties.outline=!1):t.properties.outline=!1})),this.u=!0,this):this}isOutline(){const e=this._getInternalSymbol();return!(!e||!lY(e.outline))&&e.outline}isVisible(){const e=this._getInternalSymbol();return!e||!lY(e.visible)||e.visible}setCoordinates(e){return super.setCoordinates(e),this.u=!0,this.m=!0,this}copy(){const e=this.toJSON(),t=ct.fromJSON(e);return t.setZoomOnAdded(this.Bt),t}setShader(e){return super.updateSymbol({shader:e}),this}getShader(){const e=this._getInternalSymbol();return e&&e.shader||"pbr"}setUniforms(e){return super.updateSymbol({uniforms:e}),this.D=!0,this}getUniforms(){const e=this._getInternalSymbol();return e&&e.uniforms}setUniform(e,t){const n=this.getUniforms()||{};return n[e]=t,super.updateSymbol({uniforms:n}),this.D=!0,this}getUniform(e){const t=this._getInternalSymbol();return t&&t.uniforms&&t.uniforms[e]}isAnimated(){const e=this._getInternalSymbol();return e&&e.animation&&this.F&&this.F.animations}isDashAnimated(){const e=this._getInternalSymbol();return e&&e.uniforms&&e.uniforms.dashEnabled&&e.uniforms.dashAnimate}setAnimation(e){return super.updateSymbol({animation:e}),delete this.Ut,this}setAnimationLoop(e){return super.updateSymbol({loop:e}),delete this.Ut,this.u=!0,this}isAnimationLooped(){const e=this._getInternalSymbol();return e&&e.loop}getAnimationSpeed(){const e=this._getInternalSymbol();return e&&lY(e.speed)?e.speed:1}setAnimationSpeed(e){return super.updateSymbol({speed:e}),this}Jt(e){const t=this.getMap();return t?hY(t,e||this.getCoordinates()):null}setTRS(e,t,n){const i=e||this.p.translation;return this.updateSymbol({translationX:i[0],translationY:i[1],translationZ:i[2],rotationX:t[0],rotationY:t[1],rotationZ:t[2],scaleX:n[0],scaleY:n[1],scaleZ:n[2]}),this}jt(){const e=this.j(),t=this.Jt();return t?XA(e,e,t):e}updateSymbol(e){for(const t in e)if("bloom"===t&&this.O&&this.O.forEach((n=>{n.bloom=+!!e[t]})),UY.has(t)){this.m=!0;break}return super.updateSymbol(e)}setTranslation(e,t,n){return this.updateSymbol({translationX:e,translationY:t,translationZ:n}),this}setRotation(e,t,n){return this.updateSymbol({rotationX:e,rotationY:t,rotationZ:n}),this}rotateAround(e,t){const n=this.getMap();if(!n)return;const i=n.getGLRes();let s=this.getCoordinates();const o=n.coordinateToPointAtRes(s,i),a=n.coordinateToPointAtRes(e,i),l=o.x-a.x,h=o.y-a.y,c=180*Math.atan2(h,l)/Math.PI+t,u=Math.sqrt(l*l+h*h),f=Math.PI*c/180,g=u*Math.cos(f)+a.x,m=u*Math.sin(f)+a.y;BY.set(g,m),s=n.pointAtResToCoordinate(BY,i),this.setCoordinates(s),this.updateSymbol({rotationZ:c})}setScale(e,t,n){return this.updateSymbol({scaleX:e,scaleY:t,scaleZ:n}),this}getTranslation(){const e=this._getInternalSymbol();return ZA(this.p.translation,e&&e.translationX||0,e&&e.translationY||0,e&&e.translationZ||0)}j(){const e=this.getTranslation();return this.getMap()?this.Zt(e):this.p.translation}Zt(e){const t=this.getMap(),n=t.distanceToPointAtRes(e[0],e[1],t.getGLRes(),BY),i=t.altitudeToPoint(e[2],t.getGLRes());return ZA(LY,cY(n.x,e[0]),cY(n.y,e[1]),cY(i,e[2]))}getRotation(){const e=this._getInternalSymbol();return ZA(this.p.rotation,e&&e.rotationX||0,e&&e.rotationY||0,e&&e.rotationZ||0)}getScale(){const e=this._getInternalSymbol();if(!e)return ZA(this.p.scale,1,1,1);const t=Zi.isNil(e.scaleX)?1:e.scaleX,n=Zi.isNil(e.scaleY)?1:e.scaleY,i=Zi.isNil(e.scaleZ)?1:e.scaleZ;return ZA(this.p.scale,t,n,i)}ut(){const e=this.getScale();if(this.lt){const t=this.A(),n=this.getModelHeight();if(t&&t>0){const n=this.dt(DY,t);return JA(n,n,e)}if(n){const t=this.ft(DY,n);return JA(t,t,e)}}return e}cancelMarkerPixelHeight(){return this.updateSymbol({markerPixelHeight:null})}setAnchorZ(e){return this.updateSymbol({anchorZ:e}),this}getAnchorZ(){const e=this._getInternalSymbol();return e&&e.anchorZ||"bottom"}_setExternSymbol(e){return this.u=!0,super._setExternSymbol(e)}zt(e){return IE(e,(()=>{const e=this.getMap();return e?[e.getZoom()]:null}))}_prepareSymbol(e){super._prepareSymbol(e);const t=this.zt(e);return t&&t.uniforms&&(t.uniforms=this.zt(e.uniforms)),delete this.Ht,t}hasFunctionDefinition(){if(lY(this.Ht))return this.Ht;const e=this._getInternalSymbol();return this.Ht=ME(e)||e&&e.uniforms&&ME(e.uniforms),this.Ht}setModelMatrix(e){const t=PA(this.p.translation,e),n=OA(this.p.rotation,e),i=kA(this.p.scale,e);return this.setTranslation(t[0],t[1],t[2]),this.setRotation(n[0],n[1],n[2]),this.setScale(i[0],i[1],i[2]),this}getModelMatrix(){return this.h}_(){const e=this.jt(),t=this.getRotation(),n=a_(PY,t[0],t[1],t[2]),i=this.ut();this.h=EA(this.h,n,e,i)}isDirty(){return this.u}I(e){return this.u=e,this}qt(){const e=this.toJSON();return e.zoomOnAdded=this.Bt,e}toJSON(){const e=JSON.parse(JSON.stringify({coordinates:this.getCoordinates(),options:this.options||{},type:"GLTFMarker"})),t=this.getId();Zi.isNil(t)||(e.options.id=t);const n=this.getProperties();n&&(e.options.properties=JSON.parse(JSON.stringify(n)));const i=this.getSymbol();return i&&(e.options.symbol=JSON.parse(JSON.stringify(i))),e}setZoomOnAdded(e){this.Bt=e}getZoomOnAdded(){return this.Bt}W(){return this.S()<1}S(){const e=this.getUniforms(),t=this.getShader();return"pbr"===t||"phong"===t?e&&lY(e.polygonOpacity)?e.polygonOpacity:1:"wireframe"===t&&e&&lY(e.lineOpacity)?e.lineOpacity:1}R(e){this.o=e}isLoaded(){return this.o}getGLTFMarkerType(){return this.l}Vt(e){this.Wt=e}X(){return this.Wt}getCount(){return 1}getContainerExtent(){return this.Gt()}getGLTFAsset(){return this.F&&this.F.asset}openInfoWindow(e){this.F?super.openInfoWindow(e):this.once("load",(()=>{super.openInfoWindow(e)}))}getAnimations(){if(!this.F)return null;const e=this.F,t=e.animations?e.animations.map(((e,t)=>({name:lY(e.name)?e.name:t}))):null;return t?t.map(((e,t)=>e.name||t)):null}getCurrentAnimation(){const e=this._getInternalSymbol();return e&&e.animationName}yt(){const e=this.getAnimations();if(!e)return null;let t=this.getCurrentAnimation();if(!lY(t))return e.slice(0,1);const n=[];t=Array.isArray(t)?t:[t];for(let i=0;i<t.length;i++)e.indexOf(t[i])>-1&&n.push(t[i]);return n.length?n:null}setCurrentAnimation(e){this.updateSymbol({animationName:e})}wt(e){lY(this.Ut)||(this.Ut=e)}bt(){return this.Ut||0}_t(){return this.Et=this.Et||{},this.Et}A(){const e=this._getInternalSymbol();return e&&e.markerPixelHeight}setModelHeight(e){return this.updateSymbol({modelHeight:e}),this}getModelHeight(){const e=this._getInternalSymbol();return e&&e.modelHeight}getGLTFBBox(){return this.lt}zoomTo(e={animation:!0},t){const n=this.getBoundingBox(),i=this.getMap();if(!i||!n)return;const{min:s,max:o}=n;BY.set((s[0]+o[0])/2,(s[1]+o[1])/2);const a=i.getGLRes(),l=i.pointAtResToCoordinate(BY,a);return l.z=(s[2]+o[2])/2/i.altitudeToPoint(1,a),this.Xt(l,e,t)}Xt(e,t,n){const i=this.getMap(),s=t.pitch||i.getPitch(),o=t.bearing||i.getBearing(),a=t.duration||500,l=t.easing||"linear",h=this.Yt(t.heightOffset||0)+(t.zoomOffset||0);return t.animation||void 0===t.animation?i.animateTo({center:e,zoom:h,bearing:o,pitch:s},{duration:a,easing:l},n):i.setView({center:e,zoom:h,bearing:o,pitch:s}),this}Yt(e){const t=this.getMap(),n=t.getGLRes(),i=t.distanceToPointAtRes(100,0,n).x/100,s=this.getBoundingBox(),{min:o,max:a}=s,l=a[2]/t.altitudeToPoint(1,n)+e,h=t.getFitZoomForAltitude(l*i);BY.set(o[0],o[1]);const c=t.pointAtResToCoordinate(BY,t.getGLRes());BY.set(a[0],a[1]);const u=t.pointAtResToCoordinate(BY,t.getGLRes()),f=new Ml(c,u),g=t.getFitZoom(f);return h<g?h:g}V(){return this.D}$t(){this.D=!1}setAnimationTimeframe(e){const t=this.bt(),n=this._t();this.gltfPack.updateAnimation(e,this.isAnimationLooped(),this.getAnimationSpeed(),t,{},n)}Rt(){delete this.Tt,delete this.Bt}gt(){return"effectmarker"!==this.getGLTFMarkerType()&&"glowmarker"!==this.getGLTFMarkerType()}_onEvent(e,t){const n=this.getLayer();if(!n)return;const i=n.getId();this.Kt=e.gltfPickingInfo&&e.gltfPickingInfo[i]||{},super._onEvent(e,t)}_fireEvent(e,t){for(const e in this.Kt)t[e]=this.Kt[e];delete this.Kt,super._fireEvent(e,t)}Qt(){let e=[];return this.O&&this.isVisible()&&this.S()?this.isOutline&&this.isOutline()?this.O:(e=this.O.filter((e=>e.properties.outline)),e):e}highlightNodes(e){const t=this.O;t?this.ts(e,t):this.once("load",(()=>{this.ts(e,this.O)}),this)}ts(e,t){e.forEach((e=>{t.forEach((t=>{t.properties.nodeIndex===e.nodeIndex&&this.ss(t,e.color,e.opacity,e.bloom)}))})),this.u=!0}highlight(e){const{color:t,opacity:n,bloom:i}=e,s=this.O;s?(s.forEach((e=>{this.ss(e,t,n,i)})),this.u=!0):this.once("load",(()=>{this.O.forEach((e=>{this.ss(e,t,n,i)})),this.u=!0}),this)}ss(e,t,n,i){e.properties.polygonFill||(e.properties.polygonFill=e.getUniform("polygonFill")||zY),e.properties.polygonOpacity||(e.properties.polygonOpacity=e.getUniform("polygonOpacity")||1),e.setUniform("polygonFill",t||zY),e.setUniform("polygonOpacity",n||1),e.bloom=i}es(){if(this.ns)if(Array.isArray(this.ns)){const e=this.ns.map((e=>e.nodeIndex));this.cancelHighlight(e)}else this.cancelHighlight(this.ns.nodeIndex)}cancelHighlight(e){const t=this.getLayer();if(!t)return;const n=t.getRenderer();if(!n)return;let i=this.O;if(i){if(e){let t=e;Array.isArray(t)||(t=[t]),i=i.filter((e=>t.indexOf(e.properties.nodeIndex)>-1))}i.forEach((e=>{const{polygonFill:t,polygonOpacity:n}=e.properties;e.setUniform("polygonFill",t),e.setUniform("polygonOpacity",n),e.bloom=!1})),n.setToRedraw()}}setNodeTRS(e,t={}){const n=this.O;if(!n)return;const i=t.translation||this.p.translation,s=t.rotation||this.p.rotation,o=a_(PY,s[0],s[1],s[2]),a=t.scale||this.p.scale;return n.forEach((t=>{t.properties.nodeIndex===e&&(t.st=EA(t.st||[],o,i,a))})),this.T(n),this.u=!0,this}}ct.mergeOptions({symbol:null}),ct.registerJSONType("GLTFMarker");const qY=[1,1,1,1],ZY=[],XY=[],YY=[1,1,1],JY=new fl(0,0),QY=[1,1,1],$Y=[1,1,1];class _t extends ct{constructor(e,t){super(null,t),this.vt=e||[],this.rs=[],this.os=[0,0,0],this.hs=AA([]),this.l="multigltfmarker",this.cs=[]}static fromJSON(e){return new _t(e.data,e.options)}setCoordinates(e){if(!Array.isArray(e)){const t=this.getCenter(),n=e.sub(t);for(let e=0;e<this.vt.length;e++)this.vt[e].coordinates instanceof fl?this.vt[e].coordinates=this.vt[e].coordinates.add(n):(this.vt[e].coordinates[0]+=n.x,this.vt[e].coordinates[1]+=n.y);return this.u=!0,this}return this.ls=Array.isArray(e[0])?e.map((e=>new fl(e))):e,this.updateAllData("coordinates",this.ls),this.u=!0,this}getCoordinates(e){if(e&&this.vt&&this.vt.length){return this.vt[e.index].coordinates}return null}addData(e){this.vt||(this.vt=[]),this.vt.push(e);const t=this.getLayer();return t&&t.us(),this.u=!0,this}removeData(e){this.vt.splice(e,1),this.rs&&this.rs.splice(e,1);const t=this.getLayer();return t&&t.us(),this.u=!0,this}getData(e){return this.vt[e]}updateData(e,t,n){return this.vt[e][t]=n,this.u=!0,this}getAllData(){return this.vt}updateAllData(e,t){for(let n=0;n<this.vt.length;n++)this.updateData(n,e,t[n]);return this}removeAllData(){this.vt&&(this.vt=[],this.rs=[],this.u=!0)}Ft(){const e=this.getMap();if(this.vt&&e){this.fs(),this.rs=this.rs||[];for(let e=0;e<this.vt.length;e++)if(!1!==this.vt[e].visible){const t=this.ds(e);this.rs[e]=t}}}openInfoWindow(e){let t=null;t=lY(e)&&this.vt[e]?this.vt[e].coordinates:this.getCenter(),super.openInfoWindow(t)}getCenter(){let e=0,t=0,n=0,i=0;for(let s=0,o=this.vt.length;s<o;s++){let o=this.vt[s].coordinates;o instanceof fl&&(o=o.toArray()),e+=o[0],t+=o[1],n+=o[2]||0,i++}return 0===i?null:JY.set(e/i,t/i,n/i)}getMap(){return super.getMap()||this.i&&this.i.getMap()}gs(e){this.i=e}getLayer(){return super.getLayer()||this.i}fs(){const e=this.getMap(),t=this.getCenter();if(!t)return;this.os=hY(e,t);const n=a_(XY,0,0,0);EA(this.hs,n,this.os,YY)}ds(e){const t=this.vt[e],n=this.Jt(t.coordinates);if(!n)return null;const i=fy(ZY,n,this.os),s=this.Zt(t.translation||this.p.translation),o=XA(ZY,s||this.p.translation,i||this.p.translation),a=t.rotation||this.p.rotation,l=this.ps(e),h=a_(XY,a[0]||0,a[1]||0,a[2]||0);return EA(this.rs[e]||[],h,o,l)}ps(e){const t=this.vt[e],{modelHeight:n,markerPixelHeight:i}=t,s=t.scale||this.p.scale;if(this.lt){if(i&&i>0){const e=this.dt(QY,i);return JA(e,e,s)}if(n){const e=this.ft(QY,n);return JA(e,e,s)}}return s}R(e){if(super.R(e),this.vt)for(let t=0;t<this.vt.length;t++){const n=this.vt[t];n.target&&n.target instanceof ct&&n.target.R(e)}}_(){super._(),this.Ft()}_s(){this.ys={instance_vectorA:[],instance_vectorB:[],instance_vectorC:[],instance_color:[],aPickingId:[],aOutline:[],highlight_color:[],aBloom:[]},this.ws={instance_vectorA:[],instance_vectorB:[],instance_vectorC:[],instance_color:[],aPickingId:[],aOutline:[],highlight_color:[],aBloom:[]};for(let e=0;e<this.rs.length;e++){let t=this.ys;this.vt[e].bloom&&(t=this.ws);const n=this.rs[e],i=t.instance_vectorA.length/4;this.bs(t,"instance_vectorA",i,n,0),this.bs(t,"instance_vectorB",i,n,1),this.bs(t,"instance_vectorC",i,n,2);const s=this.vt[e].color||qY,o=this.vt[e].highlightColor||qY;t.instance_color[4*i]=s[0],t.instance_color[4*i+1]=s[1],t.instance_color[4*i+2]=s[2],t.instance_color[4*i+3]=s[3],t.aPickingId[i]=this.X()+e,t.aOutline[i]=this.vt[e].outline?1:0,t.highlight_color[4*i]=o[0],t.highlight_color[4*i+1]=o[1],t.highlight_color[4*i+2]=o[2],t.highlight_color[4*i+3]=o[3],t.aBloom[i]=this.vt[e].bloom?1:0}return{attributesData:this.ys,bloomAttributesData:this.ws}}et(e){const{attributesData:t,bloomAttributesData:n}=this.Ct();for(const n in t)e.updateInstancedData(n,t[n]);if(this.regl?e.generateInstancedBuffers(this.regl):(this.Nt=this.Nt||[],this.Nt.push(e)),e.instanceCount=this.ys.instance_vectorA.length/4,this.Ms()){const t=n,i=t.aBloom.length;e.properties.bloomMesh=e.properties.bloomMesh||new CM.InstancedMesh(t,i,e.geometry,e.material);const s=e.properties.bloomMesh;s.positionMatrix=e.positionMatrix,s.localTransform=e.localTransform;for(const e in t)s.updateInstancedData(e,t[e]);s.generateInstancedBuffers(this.regl);const o=e.getDefines();s.setDefines(o),s.uniforms=e.uniforms,s.bloom=1,s.instanceCount=i}else e.properties.bloomMesh&&(e.properties.bloomMesh.dispose(),delete e.properties.bloomMesh)}xs(e,t,n,i){this.ws[e]&&n&&(this.ws[e][4*t]=n[i],this.ws[e][4*t+1]=n[i+4],this.ws[e][4*t+2]=n[i+8],this.ws[e][4*t+3]=n[i+12])}Ms(){return this.ws&&this.ws.aBloom.length}bs(e,t,n,i,s){e[t]&&i&&(e[t][4*n]=i[s],e[t][4*n+1]=i[s+4],e[t][4*n+2]=i[s+8],e[t][4*n+3]=i[s+12])}Ct(e){return!this.u&&this.ys?{attributesData:this.ys,bloomAttributesData:this.ws}:this._s(e)}it(){return this.hs}getCount(){return this.vt.length}Ss(){return this.Ft(),this.ws?this.ws.aBloom.length:0}Pt(){return this.getCount()-this.Ss()}toJSON(){const e=JSON.parse(JSON.stringify({data:this.vt,options:this.options,type:"MultiGLTFMarker"})),t=this.getProperties();return e.options&&(e.options.properties=t),e}getIndexByPickingId(e){return e-this.X()}outline(e){return lY(e)&&this.updateData(e,"outline",!0),this}cancelOutline(e){return lY(e)&&this.updateData(e,"outline",!1),this}isOutline(){if(!this.vt||!this.vt.length)return!1;for(let e=0;e<this.vt.length;e++)if(this.vt[e].outline)return!0;return!1}W(){const e=this.getAllData();for(let t=0;t<e.length;t++){const n=e[t].color;if(n&&n[3]<1)return!0}return!1}highlightNodes(e,t){const n=this.O;if(!n)return;const i=this.vt[e];i&&(t.forEach((e=>{n.forEach((t=>{if(t.properties.nodeIndex===e.nodeIndex){const{color:n,opacity:s,bloom:o}=e;i.highlightColor=n||$Y,i.highlightColor[3]=s||1,i.highlightBloom=o;const a=t.getDefines();a.HAS_INSTANCE_HIGHLIGHT=1,t.setDefines(a)}}))})),this.u=!0)}highlight(e,t){const{color:n,opacity:i,bloom:s}=t,o=this.O;if(!o)return;const a=this.vt[e];a&&(a.highlightColor=n||$Y,a.highlightColor[3]=i||1,a.highlightBloom=s,o.forEach((e=>{const t=e.getDefines();t.HAS_INSTANCE_HIGHLIGHT=1,e.setDefines(t)})),this.u=!0)}cancelHighlight(e,t){let n=this.O;if(!n)return;const i=this.vt[e];if(i){if(t){let e=t;Array.isArray(e)||(e=[e]),n=n.filter((t=>e.indexOf(t.properties.nodeIndex)>-1))}n.forEach((e=>{const t=e.getDefines();delete t.HAS_INSTANCE_HIGHLIGHT,e.setDefines(t),i.highlightColor=$Y,i.highlightColor[3]=1,i.highlightBloom=0})),this.u=!0}}zoomAt(e,t={animation:!0,zoomOffset:0},n){const i=this.vt[e];if(!i)throw new Error("data item is not exist");const s=new fl(i.coordinates);return this.Xt(s,t,n)}}_t.registerJSONType("MultiGLTFMarker");const KY=CM.ShaderLib.get("mesh_picking_vert"),eJ=CM.WgslShaderLib.get("mesh_picking").vert,tJ=[],nJ=[],rJ=["points","lines","line strip","line loop"];class St extends(gI(OP(Om.OverlayLayerGLRenderer))){constructor(e){super(e),this.Os={},this.ks=[],this.As={}}onAdd(){super.onAdd(),this.prepareWorker()}draw(e,t){this.prepareCanvas(),this.Ts(t,e)}drawOnInteracting(e,t,n){this.Ts(n,t)}Ts(e,t){this.vs=e,this.Ls=t;let n=0;this.Is(e),this.Fs={},this.Cs(e);const i=this.Ps(e);this.Ns(t);const s=e&&e.renderTarget?e.renderTarget.fbo:null;let o=0;for(const t in this.Os){if("pointline"===t)continue;if(e){const{newShader:n,uniforms:s}=this.Ds(e,t);this.Os[t].shader=n,Zi.extend(i,s)}const a=this.Gs(t),l=this.Os[t].shader;l.filter=e&&e.sceneFilter||null,o+=this.renderer.render(l,i,a,s),n++}const a=this.Gs("pointline");if(a.getMeshes().length){i.pointSize=this.layer.options.pointSize||1;const t=this.Os.pointline.shader;t.filter=e&&e.sceneFilter||null,o+=this.renderer.render(t,i,a,s),n++}this.Bs(i,s),o&&this.layer.fire("canvasisdirty",{renderCount:o}),this.Rs=!0,this.completeRender(),this.layer.fire("rendercomplete-debug",{count:n})}Bs(e,t){this.Es||(this.Es=new CM.Scene);const n=this.layer.getGeometries(),i=[];for(let e=0;e<n.length;e++){if(!n[e].options.showDebugBoundingBox)continue;const t=n[e].ot();t&&i.push(t)}i.length&&(this.Es.setMeshes(i),this.renderer.render(this.Os.wireframe.shader,e,this.Es,t))}Us(e){const t=e.getUniform("polygonFill")||[1,1,1,1],n=e.getUniform("polygonOpacity")||1;return t[3]=n,{coordinates:e.getCoordinates(),translation:e.getTranslation(),rotation:e.getRotation(),scale:e.getScale(),visible:e.isVisible(),color:t,bloom:e.isBloom(),outline:e.isOutline(),modelHeight:e.getModelHeight(),markerPixelHeight:e.A(),anchorZ:e.getAnchorZ(),pickingId:e.X(),target:e}}Js(e){const t=this.Us(e),n=new _t([t],{symbol:{url:e.getUrl(),shader:e.getShader(),shadow:e.isCastShadow()}});return n.js=n.js||[],e.Zs=!0,n.js.push(e),n.gs(e.getLayer()),n}zs(){for(const e in this.As)this.As[e].removeAllData()}Hs(e,t){const n=e.getMeshes(this.G,this.regl,t),i=e.getShader();if(n.length){this.ks.push(e),this.Fs[i]=this.Fs[i]||[],Zi.pushIn(this.Fs[i],n);for(let e=0;e<n.length;e++)n[e].properties.bloomMesh&&this.Fs[i].push(n[e].properties.bloomMesh)}}Ns(e){this.ks.length=0;const t=this.layer.getGeometries();this.qs()&&this.zs();for(let n=0;n<t.length;n++){const i=t[n],s=i.getUrl();if(i instanceof _t||i.isAnimated()||!i.Zs)this.Hs(i,e);else if(this.qs()){const e=`${s}_${i.getShader()}_${i.isCastShadow()?1:0}`;this.As[e]?this.As[e].addData(this.Us(i)):this.As[e]=this.Js(i)}}for(const t in this.As){const n=this.As[t];n.createdBygltfmarker=!0,this.Hs(n,e)}}Ps(){const e={};this.Vs.outSize=[this.canvas.width,this.canvas.height],this.Vs.halton=[0,0];e.layerOpacity=this.canvas.gl&&this.canvas.gl.wrap?this.layer.options.opacity||0:1,Zi.extend(e,this.Vs);const t=this.getMaskUniforms();return Zi.extend(e,t),e}Gs(e){const t=[],n=[];if("pointline"===e){for(const e in this.Fs)"wireframe"!==e&&this.Fs[e].forEach((e=>{rJ.indexOf(e.geometry.desc.primitive)>-1&&t.push(e)}));const e=new CM.Scene(t);return e.sortMeshes(this.Vs.cameraPosition),e}for(const t in this.Fs){t===e&&this.Fs[t].forEach((t=>{(rJ.indexOf(t.geometry.desc.primitive)<0||"wireframe"===e)&&n.push(t)}))}const i=this.Ws=this.Ws||new CM.Scene;return i.setMeshes(n),i.sortMeshes(this.Vs.cameraPosition),i}needToRedraw(){return!!super.needToRedraw()||this.qs()}qs(){const e=this.layer.getGeometries();for(let t=0;t<e.length;t++)if(this.ks.indexOf(e[t])>-1&&(e[t].isDirty()||e[t].isAnimated()))return!0;return!1}onRemove(){this.workerConn&&(this.workerConn.removeLayer(this.layer.getId(),(e=>{if(e)throw e})),this.workerConn.remove(),delete this.workerConn),super.onRemove()}hitDetect(){return!1}initContext(){super.initContext();const{regl:e,device:t,reglGL:n}=this.context,i=e||t;this.regl=e||t,this.gl=n,this.device=e||t;this.canvas.pickingFBO=this.canvas.pickingFBO||i.framebuffer({colorFormat:t?"bgra8unorm":"rgba",depthStencil:!0,width:this.canvas.width,height:this.canvas.height}),this.pickingFBO=this.canvas.pickingFBO,this.G=i.gltfManager=i.gltfManager||this.Xs(),this.Ys(),this.Nt&&this.Nt.forEach((e=>{e.generateInstancedBuffers(this.regl)})),this.It&&this.It.forEach((e=>{e.generateBuffers(this.regl)})),this.layer.fire("contextcreate",{regl:e,device:t})}getGLTFManager(){return this.G}Xs(){return new CM.GLTFManager(this.regl)}Ys(){const e=this.layer.getMap(),t=new CM.Renderer(this.regl);this.renderer=t,this.Vs={projMatrix:e.projMatrix,projViewMatrix:e.projViewMatrix,viewMatrix:e.viewMatrix,cameraPosition:e.cameraPosition,altitudeScale:1},CM.pbr.PBRUtils.loginIBLResOnCanvas(this.canvas,this.regl,e);const n=[],i=[];this.$s=new CM.FBORayPicking(t,{name:"gltf-picking",vert:KY,wgslVert:eJ,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,t){return vA(n,t.projViewMatrix,t.modelMatrix)}},{name:"modelViewMatrix",type:"function",fn:function(e,t){return vA(i,t.viewMatrix,t.modelMatrix)}}]},this.pickingFBO,e)}prepareWorker(){this.workerConn||(this.workerConn=new mY("@maptalks/gltf-layer",this.layer));const e=this.workerConn;if(!e.isActive())return;const t=this.layer.options||{},n=this.layer.getId();e.addLayer(n,{markerType:t.markerTypes,pointSize:t.pointSize},(e=>{if(e)throw e;this.layer&&(this.ready=!0,this.layer.fire("workerready"))}))}Z(e){let t;if(this.layer.getURLModifier()){t=SY(null,e,this.layer.options.fetchOptions,(e=>{const t=this.layer.getURLModifier();return t?t(e):e}))}else t=this.workerConn.loadGLTF(e);return t.then((e=>(this.setToRedraw(),this.Ks=!0,e))).catch((t=>{console.error(t),this.layer.fire("modelerror",{type:"modelerror",url:e,info:t})}))}Cs(e){const t=pY;for(const n in t){if(this.Os[n])continue;const i=t[n];this.Qs(e,i.name,i.type,i.config)}}Qs(e,t,n,i){this.viewport||(this.viewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1}),i.extraCommandProps||(i.extraCommandProps={});const s={};e&&this.ti(s,tJ,e);const o=Zi.extend({},i);o.extraCommandProps=Zi.extend({},i.extraCommandProps),o.extraCommandProps.viewport=this.viewport,o.uniforms=Zi.extend([],i.uniforms,tJ),o.defines=Zi.extend({},o.defines,s),n.indexOf(".")>-1?(n=n.split("."),this.Os[t]={shader:new CM[n[0]][n[1]](o),type:n}):this.Os[t]={shader:new CM[n](o),type:n}}remove(){this.si();const e=this.Os;for(const t in e)e[t].shader.dispose();this.extentShader&&this.extentShader.dispose(),super.remove()}resizeCanvas(e){super.resizeCanvas(e),this.pickingFBO&&this.pickingFBO.resize(this.canvas.width,this.canvas.height),this.layer.fire("resizecanvas",{size:e})}getFrameTimestamp(){return this.Ls}getFrameContext(){return this.vs}needRetireFrames(){return this.Ks}ti(e,t,n){const i=n&&n.includes;if(i)for(const s in i)i[s]&&(n[s].uniformDeclares&&(t.length=0,t.push(...n[s].uniformDeclares)),n[s].defines&&Zi.extend(e,n[s].defines))}ii(e,t){const n=t&&t.includes;if(n)for(const i in n)n[i]&&t[i].renderUniforms&&Zi.extend(e,t[i].renderUniforms)}Ds(e,t){const{shader:n,type:i}=this.Os[t];let s=null;const o={};if(this.ii(o,e),e.states.includesChanged){const t={};this.ti(t,tJ,e);const o={vert:n.vert,frag:n.frag,uniforms:n.uniforms,extraCommandProps:n.extraCommandProps};o.defines=t,o.uniforms=Zi.extend([],o.uniforms,tJ),s=Array.isArray(i)?new CM[i[0]][i[1]](o):new CM[i](o),n.dispose()}else s=n;return{uniforms:o,newShader:s}}ei(e,t,n){if(e.viewshed){for(const t in e.viewshed.renderUniforms)n[t]=e.viewshed.renderUniforms[t];Zi.extend(t.shaderDefines,e.viewshed.defines)}if(e.floodAnalysis){for(const t in e.floodAnalysis.renderUniforms)n[t]=e.floodAnalysis.renderUniforms[t];Zi.extend(t.shaderDefines,e.floodAnalysis.defines)}return n}getShadowMeshes(){const e=[];if(!this.layer||!this.layer.isVisible()||!this.Fs)return e;const t=this.layer.getGeometries();for(let n=0;n<t.length;n++)if(t[n].isCastShadow()&&t[n].isVisible()&&t[n].S()&&!t[n].Zs){Zi.pushIn(e,t[n].O||[])}for(const t in this.As){const n=this.As[t];if(n.isCastShadow()&&n.isVisible()&&n.S()){Zi.pushIn(e,n.O||[])}}return e}ni(){const e=[];if(!this.Fs||!Object.keys(this.Fs).length)return e;for(const t in this.Fs)Zi.pushIn(e,this.Fs[t]);return e}getAnalysisMeshes(){return this.ni()}getRayCastData(e){const t=this.layer.getGeometries();for(let n=0;n<t.length;n++){const i=t[n].O;if(i&&i.indexOf(e)>-1)return t[n]}return null}drawOutline(e){this.extentShader||(this.extentShader=new CM.MeshShader({vert:"attribute vec3 aPosition;\n\nattribute float aOutline;\n\nuniform mat4 projMatrix;\n\nuniform mat4 modelMatrix;\n\nuniform mat4 modelViewMatrix;\n\nuniform mat4 positionMatrix;\n\nuniform float instance;\n\n#include <get_output>\n\n\n\nvarying float vOutline;\n\nvoid main()\n\n{\n\n    mat4 localPositionMatrix = getPositionMatrix();\n\n    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * getPosition(aPosition);\n\n    if (instance == 0.0) {\n\n        vOutline = 1.0;\n\n    } else {\n\n        vOutline = aOutline;\n\n    }\n\n}\n\n",frag:"precision highp float;\n\nvarying float vOutline;\n\nvoid main() {\n\n    gl_FragColor = vec4(vOutline);\n\n}\n\n",uniforms:[{name:"modelViewMatrix",type:"function",fn:(e,t)=>vA([],t.viewMatrix,t.modelMatrix)}],positionAttribute:"POSITION",extraCommandProps:{viewport:this.viewport,cull:{enable:!1},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}}));const t=this.getOutlineMeshes();t.length&&(this.ri=this.ri||new CM.Scene,this.ri.setMeshes(t),this.renderer.render(this.extentShader,{projMatrix:this.Vs.projMatrix,viewMatrix:this.Vs.viewMatrix},this.ri,e))}getOutlineMeshes(){const e=[];if(!this.layer)return e;const t=this.layer.getGeometries();for(let n=0;n<t.length;n++){if(t[n].Zs)continue;const i=t[n].Qt();Zi.pushIn(e,i)}for(const t in this.As){const n=this.As[t].Qt();Zi.pushIn(e,n)}return e}si(){this.canvas&&CM.pbr.PBRUtils.logoutIBLResOnCanvas(this.canvas,this.getMap())}Is(e){const t=this.layer.getMap(),{iblTexes:n,dfgLUT:i}=CM.pbr.PBRUtils.getIBLResOnCanvas(this.canvas);if(t&&t.getLights()){const s=CM.pbr.PBRUtils.getPBRUniforms(t,n,i,e&&e.ssr,e&&e.jitter),o=t.getLights();this.Vs.ambientColor=o.ambient&&o.ambient.color?o.ambient.color:[.2,.2,.2],s&&Zi.extend(this.Vs,s)}else{const n=CM.pbr.PBRUtils.getPBRUniforms(t,null,i,e&&e.ssr,e&&e.jitter);Zi.extend(this.Vs,n)}}oi(e,t){const n=["webgl","experimental-webgl"];let i=null;for(let s=0;s<n.length;++s){try{i=e.getContext(n[s],t)}catch(e){}if(i)break}return i}hi(e,t,n={}){if(!this.$s||!this.layer.isVisible())return null;const i=this.layer.getMap();if(this.Rs||this.canvas.gl&&this.canvas.gl.wrap){if(!this.Fs||!Object.keys(this.Fs).length)return null;const e=this.ni(),t=Zi.extend({},this.Vs);t.pointSize=this.layer.options.pointSize||1,this.$s.render(e,t,!0),this.Rs=!1}const s=this.$s[n.returnAll?"pickAll":"pick"](e,t,n.tolerance||3,{projMatrix:i.projMatrix,viewMatrix:i.viewMatrix,projViewMatrix:i.projViewMatrix,pointSize:this.layer.options.pointSize||1},{viewMatrix:i.viewMatrix,projMatrix:i.projMatrix,returnPoint:!0});if(s.length){const e={},t=[];for(let n=0;n<s.length;n++)if(!e[s[n].pickingId]){const i=this.ai(s[n]);e[s[n].pickingId]=!0,t.push(i)}return t}return this.ai(s)}ai(e){const{meshId:t,pickingId:n,point:i,coordinate:s}=e,o=this.ni()[t],a=this.ci(n);return{meshId:t,mesh:o,data:this.layer.li()[a],pickingId:n,point:i,coordinate:s,index:n-a,nodeIndex:this.ui(t)}}ui(e){const t=this.ni()[e];return t&&t.properties.nodeIndex}ci(e){if(!lY(e))return null;if(this.layer.li()[e])return e;const t=Object.keys(this.layer.li()),n=t.length;let i=0,s=n-1,o=Math.floor((i+s)/2);for(;i<=n-1&&s>=0;){if(i===s)return t[i];if(t[o]<=e&&e<t[o+1])return t[o];e<t[o]?(s=o-1,o=Math.floor((i+s)/2)):t[o+1]<e&&(i=o+1,o=Math.floor((i+s)/2))}return null}isInFrustum(e){const t=this.layer.getMap(),n=e.getBoundingBox();if(!n||"multigltfmarker"===e.getGLTFMarkerType())return!0;const i=U_(nJ,n.min,n.max);return!!mV(t.projViewMatrix,i)}getRenderMeshesTest(){return this.ni()}isMarkerTransparent(e){return e.W()}getMarkerFitSizeScale(e){return e.fi()}getMarkerFitTranslate(e){return e.di()}getFBORayPicking(){return this.$s}getShaderList(){return this.Os}}const iJ=/\{ *([\w_]+) *\}/g;class kt extends ct{constructor(e,t){super(e,t),this.l="effectmarker"}static fromJSON(e){return new kt(e.coordinates,e.options)}isAnimated(){return!0}setTexture(e){const t=this.getLayer()&&this.getLayer().getRenderer();if(t){const n=this.getTextureUrl();t.mi(n),t.gi(e)}return super.updateSymbol({textureUrl:e}),this}pi(e){const t=this.getTextureUrl(),n=this.getLayer()&&this.getLayer().getRenderer();if(n){let i=t;const s=this._i();if(s){const n=this.isAnimationLooped(),o=this.getAnimationSpeed()||1,a=n?Math.floor(.01*e*o)%s.length:Math.floor(.01*e);i=t.replace(iJ,s[a]),this.setUniform("width",1),this.setUniform("height",1),this.setUniform("uvOffset",[0,0])}return n.yi(i,this.X())}return null}_i(){const e=this._getInternalSymbol();return e&&e.textureNames}getTextureUrl(){const e=this._getInternalSymbol();return e&&e.textureUrl||"default"}getUrl(){return"plane"}getShader(){return"effect"}setTransparent(e){return this.options.symbol.transparent=e,this}isTransparent(){return this.options.symbol.transparent}updateUV(e){const t=this.isAnimationLooped(),n=this.getAnimationSpeed()||1,i=this.getUniforms()||{},s=i.width||1,o=i.height||1;let a;const l=this.getEffectType();"uv"===l?a=t?.01*e*n%(s*o):.01*e:"sequence"===l&&(a=t?Math.floor(.01*e*n)%(s*o):Math.floor(.01*e));const h=Math.floor(a%s),c=Math.floor(a/s),u=this.pi(e);this._getSymbol()?(this.setUniform("uvOffset",[h,c]),this.setUniform("width",s),this.setUniform("height",o),this.setUniform("texture",u)):this.N("uniforms",{uvOffset:[h,c],width:s,height:o,texture:u})}_setExternSymbol(e){super._setExternSymbol(e);const t=this.getLayer()&&this.getLayer().getRenderer();if(t){const e=this.getTextureUrl();t.gi(e)}}getEffectType(){const e=this._getInternalSymbol();return e&&e.effect||"uv"}setEffectType(e){return this._getInternalSymbol().effect=e,this}remove(){const e=this.getLayer()&&this.getLayer().getRenderer();if(e){const t=this.getTextureUrl();e.mi(t)}super.remove()}}const sJ=["Point","Polygon","LineString","MultiPoint","MultiPolygon","MultiLineString","GeometryCollection","Feature","FeatureCollection"].reduce(((e,t)=>(e[t]=!0,e)),{}),oJ={toGeometry:function(e,t){if(Zi.isString(e)&&(e=Zi.parseJSON(e)),Array.isArray(e)){const n=[];for(let i=0,s=e.length;i<s;i++){const s=oJ.wi(e[i],t);Array.isArray(s)?Zi.pushIn(n,s):n.push(s)}return n}return oJ.wi(e,t)},wi:function(e,t){if(!e||Zi.isNil(e.type))return null;const n=e.type;if("Feature"===n){const n=oJ.wi(e.geometry,t);return n?(n.setId(e.id),n.setProperties(e.properties),n):null}if("FeatureCollection"===n){const n=e.features;return n?oJ.toGeometry(n,t):null}if("Point"===n)return function(e,t){return"EffectLayer"===t?new kt(e):new ct(e)}(e.coordinates,t);if("GeometryCollection"===n){const n=e.geometries,i=[],s=n.length;for(let e=0;e<s;e++)i.push(oJ.wi(n[e],t));return i}throw new Error("geometry's type is invalid, only support type of Point")},isGeoJSON:function(e){return!(!e||"object"!=typeof e||!e.type||!sJ[e.type]||e instanceof gu)}},aJ=/\{*(\$root)*\}/g;class Lt extends ed{constructor(e,t,n){!t||t instanceof gu||Array.isArray(t)||sJ[t.type]||(n=t,t=null),super(e,null,n),this.pickingId=0,this.bi={},this.Mi={},this.xi={};this.setStyle(n&&n.style),t&&this.addGeometry(t)}static registerShader(e,t,n,i){pY[e]={name:e,type:t,config:n,uniforms:i}}static removeShader(e){delete pY[e]}static getShaders(){const e=[];for(const t in pY)e.push({shader:t,uniforms:pY[t].uniforms});return e}static getShaderMap(){return pY}addGeometry(e,t){let n=oJ.isGeoJSON(e)?oJ.toGeometry(e,this.getJSONType()):e;n=Array.isArray(n)?n:[n];for(let e=0;e<n.length;e++)if(!this.Si(n[e]))return void console.error("type of geometry is invalid");super.addGeometry(n,t),Array.isArray(n)&&this.addMarker(n)}addMarker(e){for(let t=0;t<e.length;t++){const n=e[t];n.Vt(this.pickingId),this.bi[this.pickingId]=n;const i=n.getId();i&&(this.xi[i]=n),n.fire("add",{type:"add",target:n,layer:this});const s=n.getUrl(),o=this.getRenderer();if(o&&o.As[s]){n.fire("load",{type:"load",target:n,data:o.As[s].C()})}if("multigltfmarker"===n.getGLTFMarkerType()){const e=n.getCount()||1;this.pickingId+=e}else this.pickingId++}}Oi(e){const t=this.getRenderer();t&&t.loginGLTFMarker(e)}toJSON(e){e||(e={});const t={type:this.getJSONType(),id:this.getId(),options:this.config()};if((aY(e.style)||e.style)&&(t.style=this.getStyle()),aY(e.geometries)||e.geometries){const e=[],n=this._geoList;for(let t=0;t<n.length;t++){const i=n[t].qt();e.push(i)}t.geometries=e}return t}Si(e){return!!e.getGLTFMarkerType&&this.options.markerTypes.indexOf(e.getGLTFMarkerType())>-1}setStyle(e){return e?(this.options.style=e,this.ki=JSON.parse(JSON.stringify(e)),this.Ai(),this.fire("setstyle",{target:this,style:this.ki}),this):(delete this.ki,delete this.options.style,this)}getStyle(){return this.options.style}updateSymbol(e,t){const n=this.getStyle();this.Ti(e,t,n),this.Ti(e,t,this.ki),this.Ai(),this.fire("updatesymbol",{target:this,index:e,symbol:t})}Ti(e,t,n){if(!n)return;const i=(n.style?n.style:n)[e].symbol||{};for(const e in t)i[e]=t[e]}Ai(){this._processRootUrl(this.ki);this.vi=tR(this.ki.style?this.ki.style:this.ki),this._geoList.forEach((function(e){this.Li(e)}),this)}getGLTFUrls(){return Object.keys(this.Mi)}_processRootUrl(e){Zi.isString(e.$root)&&e.style.forEach((t=>{const n=t.symbol.url;n&&n.indexOf("{$root}")>-1&&(t.symbol.url=n.replace(aJ,e.$root))}))}Li(e){if(!this.vi)return!1;for(let t=0,n=this.vi.length;t<n;t++)if(!0===this.vi[t].filter({properties:e.getProperties()})){const n=this.vi[t].symbol;return e.N("url",n.url),e.updateSymbol(n),!0}return!1}Ii(e){if(this.vi)for(let t=0,n=this.vi.length;t<n;t++)!0===this.vi[t].filter({properties:e.getProperties()})&&this.vi[t].outline&&e.outline()}Fi(e){const t=Zi.isString(e)?this.xi[e].X():e.X(),n=this.getRenderer();n&&n.Ci(t),delete this.bi[t],delete this.xi[e]}clear(){return super.clear(),this.bi={},this.xi={},this}li(){return this.bi}hi(e,t,n){const i=this.getRenderer();return i?i.hi(e,t,n):null}_isModelsLoadComplete(){const e=this._geoList;for(let t=0;t<e.length;t++)if(!e[t].isLoaded())return!1;return!0}Gt(e){const t=this.getRenderer();return t?t.Gt(e):null}J(e){const t=this.getRenderer();t&&t.J(e)}outlineBatch(e){const t=this.ki.style?this.ki.style:this.ki;t[e].outline=!0,this.vi=tR(t),this._geoList.forEach((e=>{this.Ii(e)}))}outlineAll(){this._geoList.forEach((e=>{e.outline()}))}cancelOutline(){this.ki&&(this.ki.style?this.ki.style:this.ki).forEach((e=>{delete e.outline})),this._geoList.forEach((e=>{e.cancelOutline()}))}}Lt.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,markerEvents:!0,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0});class It extends(YI(Lt)){static initDefaultShader(){const e={shader:{positionAttribute:"POSITION",normalAttribute:"NORMAL",extraCommandProps:{blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},material:new CM.PhongMaterial};It.registerShader("phong","PhongShader",e.shader,e.material.getUniforms());const t={shader:{positionAttribute:"POSITION",normalAttribute:"NORMAL",tangentAttribute:"TANGENT",colorAttribute:"COLOR_0",uv0Attribute:"TEXCOORD_0",uv1Attribute:"TEXCOORD_1",extraCommandProps:{cull:{enable:!0},frontFace:"ccw",blend:{enable:(e,t)=>!!t.meshConfig.transparent,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}},material:new CM.pbr.StandardMaterial({})};It.registerShader("pbr","pbr.StandardShader",t.shader,t.material.getUniforms()),It.registerShader("depth","pbr.StandardDepthShader",t.shader,t.material.getUniforms());const n={shader:{positionAttribute:"POSITION",color0Attribute:"COLOR_0",extraCommandProps:{blend:{enable:!1,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},material:new CM.Material};It.registerShader("pointline","PointLineShader",n.shader,n.material.getUniforms());const i={shader:{positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}},material:new CM.Material({lineColor:[0,0,0,1],lineOpacity:1})};It.registerShader("wireframe","EdgeShader",i.shader,i.material.getUniforms());const s={shader:{positionAttribute:"POSITION",normalAttribute:"NORMAL",extraCommandProps:{blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},material:new CM.StandardLiteMaterial};It.registerShader("pbr-lite","StandardLiteShader",s.shader,s.material.getUniforms())}static fromJSON(e){if(!e||"GLTFLayer"!==e.type)return null;const t=new It(e.id,e.options),n=e.geometries,i=[];for(let e=0;e<n.length;e++){const t=n[e].type,s=ct.getJSONClass(t);if(!s||!s.fromJSON)throw new Error("unsupported gltfmarker type:"+t);const o=s.fromJSON(n[e]);o&&i.push(o)}return t.addGeometry(i),e.style&&t.setStyle(e.style),t}setURLModifier(e){return this.Pi=e,this}getURLModifier(){return this.Pi}onAdd(){const e=this.getMap();this._geoList.forEach((t=>{lY(t.getZoomOnAdded())||t.setZoomOnAdded(e.getZoom())})),super.onAdd()}onRemove(){super.onRemove(),this.clear()}identify(e,t){const n=this.getMap();if(!n)return[];const i=n.coordinateToContainerPoint(new fl(e));return this.identifyAtPoint(i,t)}identifyAtPoint(e,t={}){const n=[];if(!t.excludeMasks){const i=this.identifyMask(e,t);i&&i.length&&Zi.pushIn(n,i)}const i=this.getMap();if(!i)return[];const s=i.getDevicePixelRatio(),o=this.hi(e.x*s,e.y*s,t);if(o&&(o.data||o.length))if(t.includeInternals&&!t.excludeMasks){n.push(o.data);const e=t.domEvent;e&&(e.gltfPickingInfo=e.gltfPickingInfo||{},e.gltfPickingInfo[this.getId()]=o)}else n.push(o);return t&&t.filter&&!t.excludeMasks?n.filter((e=>t.filter(e.data||e))):n}us(){this.pickingId=0;const e={};for(const t in this.bi){const n=this.bi[t];n.Vt(this.pickingId),n.I(!0),e[this.pickingId]=n;const i=n.getCount()||1;this.pickingId+=i}this.bi=e}_onGeometryEvent(e){if(!e||!e.target)return;const t=e.type;if("meshcreate"===t)this.Ni(e);else if("modelerror"===t)this.Di(e);else if("positionchange"===t){const e=this.getRenderer();e&&e.setToRedraw()}super._onGeometryEvent(e)}Di(e){const{url:t,info:n}=e;console.error(n),this.fire("modelerror",{type:"modelerror",url:t,info:n})}Ni(e){this.Mi[e.url]=1,this.getRenderer().setToRedraw(),this._isModelsLoadComplete()&&this.fire("modelload",{models:this.getGLTFUrls()})}}It.initDefaultShader(),It.mergeOptions({markerTypes:["gltfmarker","multigltfmarker"],pointSize:1}),It.registerJSONType("GLTFLayer"),It.registerRenderer("gl",St);const lJ=new fl(0,0),hJ=new Re(0,0),cJ=new Re(0,0),uJ=new Re(0,0);const fJ=new fl(0,0),dJ=[],pJ=new Re(0,0),gJ=new Re(0,0);class Jt extends _t{constructor(e,t){super(null,t),this.on("load",(()=>{this.setCoordinates(e)}))}static fromJSON(e){return new Jt(e.data,e.options)}setCoordinates(e){this.ls=e,this.Gi()}getCoordinates(){return this.ls}toJSON(){const e=JSON.parse(JSON.stringify({coordinates:this.ls,options:this.options,type:"GLTFLineString"})),t=this.getId();Zi.isNil(t)||(e.options.id=t);const n=this.getProperties();return e.options&&(e.options.properties=n),e}Gi(){const e=this.ls;if(!e)return;this.removeAllData();const t=this.getMap(),n=t.getGLRes(),i=t.getProjection(),s=this.Bi();for(let o=0;o<e.length-1;o++){const a=this.Ri(e[o]),l=this.Ri(e[o+1]),h=t.coordinateToPointAtRes(a,n,pJ),c=t.coordinateToPointAtRes(l,n,gJ),u=this.Ei(a,l),f=i.measureLenBetween(a,l);this.gltfPack.arrangeAlongLine(h,c,f,s,u,this.options).forEach((e=>{e.coordinates=mJ(a,l,e.t),this.addData(e)}))}this.u=!0}Bi(){const e=[1,1,1],t=this.getModelHeight();t&&this.ft(e,t);const n=this.getSymbol();return ZA(dJ,Zi.isNil(n.scaleX)?1:n.scaleX,Zi.isNil(n.scaleY)?1:n.scaleY,Zi.isNil(n.scaleZ)?1:n.scaleZ),JA(e,e,dJ)}Ei(e,t){const n=this.getMap(),i=n.getGLRes();return fJ.set(0,(e.y+t.y)/2),n.altitudeToPoint(100,i,fJ)/n.altitudeToPoint(100,i)}Ri(e){return Array.isArray(e)?new fl(e):e}}function mJ(e,t,n){const i=AJ(e.x,t.x,n),s=AJ(e.y,t.y,n),o=AJ(e.z||0,t.z||0,n);return new e.constructor(i,s,o)}function AJ(e,t,n){return e+n*(t-e)}if(Jt.mergeOptions({direction:0,gapLength:0,scaleVertex:!0}),Jt.registerJSONType("GLTFLineString"),ox){const e=zu.VERSION;if(e.indexOf("1.0.0-beta")>=0||e.indexOf("1.0.0-alpha")>=0){co("@maptalks/gltf-layer",ox.inject(oY))}else co("@maptalks/gltf-layer",(function(){return ox.inject(oY)}))}else co("@maptalks/gltf-layer",oY);"undefined"!=typeof console&&console.log("@maptalks/gltf-layer v0.106.0");
/*!
   * @maptalks/transform-control v0.106.7
   * LICENSE : UNLICENSED
   * (c) 2016-2025 maptalks.org
   */
const yJ={yuanhuan:{accessors:[{name:"����С��_1_0_positions",componentType:5126,count:104,min:[-5.407599925994873,-5.404099941253662,0],max:[5.405200004577637,5.406300067901611,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"����С��_1_0_normals",componentType:5126,count:104,min:[0,0,1],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"����С��_1_0_indices",componentType:5123,count:288,min:[0],max:[103],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"缩放圈-新",byteLength:3072,uri:"data:application/octet-stream;base64,KVyjQLbzPT4AAAAAZvesQLbzPT4AAAAAhsmqQC7/YT8AAAAAZ0ShQDC7Vz8AAAAA+u2lwGKhxr8AAAAArK2cwLpJvL8AAAAAEFihwB04V78AAAAAXdyqwE7RYb8AAAAAat6lQEaUxj8AAAAAApqcQG+BvD8AAAAAB18EQFOWlcAAAAAA+u0LQLBynsAAAAAARPoxQNSalMAAAAAAJzEoQIxKjMAAAAAAQBNVQFyPiMAAAAAAIEFJQMDsgMAAAAAA0950QK36dMAAAAAAejZnQFRSZ8AAAAAAXdyAQBBYScAAAAAA+n6IQI0oVcAAAAAAcoqUQAMJMsAAAAAAKjqMQIlBKMAAAAAAXdyAQFdbSUAAAAAA+n6IQDsBVUAAAAAA0950QBTQdEAAAAAAejZnQA5PZ0AAAAAA+n6IwI0oVcAAAAAAwOyAwBBYScAAAAAAXkuMwIlBKMAAAAAA0ZGUwAMJMsAAAAAA5j+8P9ejnMAAAAAAkDFXP65HocAAAAAA1JrGPz7opcAAAAAA/7I7PvhTo8AAAAAA/7I7PmPurMAAAAAAM8RhP/vLqsAAAAAADwutwLbzPT4AAAAA0m+jwLbzPT4AAAAAEFihwDC7Vz8AAAAAXdyqwC7/YT8AAAAArK2cwG+BvD8AAAAA+u2lwEaUxj8AAAAADXGewN/gC0AAAAAAa5qVwIV8BEAAAAAAXkuMwAFNKEAAAAAA0ZGUwD7oMUAAAAAAlIeVQIV8BEAAAAAAlWWeQN/gC0AAAAAAcoqUQD7oMUAAAAAAKjqMQAFNKEAAAAAAQBNVQBB6iEAAAAAAIEFJQKfogEAAAAAAW9N0wK36dMAAAAAAsVBnwFRSZ8AAAAAAlWWeQM/3C8AAAAAAlIeVQNxoBMAAAAAA+n6IwDsBVUAAAAAAwOyAwFdbSUAAAAAAsVBnwA5PZ0AAAAAAW9N0wBTQdEAAAAAAd74LwLBynsAAAAAAkxi8v9ejnMAAAAAAwFsEwFOWlcAAAAAARpRWv65HocAAAAAAayvGvz7opcAAAAAA2c43vvhTo8AAAAAA2c43vmPurMAAAAAAt9Fgv/vLqsAAAAAAt9Fgv7fRqkAAAAAAayvGvybkpUAAAAAAd74LwAponkAAAAAA2c43vv5lo0AAAAAA2c43vmkArUAAAAAARpRWvzxOoUAAAAAAkxi8v9ejnEAAAAAAOdYxwHKKlEAAAAAAwFsEwDqSlUAAAAAA+zoowNBEjEAAAAAAJlNJwKfogEAAAAAAUPxUwBB6iEAAAAAAat6lQGKhxr8AAAAAApqcQLpJvL8AAAAAhsmqQE7RYb8AAAAAZ0ShQB04V78AAAAAZvesQP+yO74AAAAAKVyjQP+yO74AAAAAM8RhP7fRqkAAAAAA/7I7PmkArUAAAAAA/7I7Pv5lo0AAAAAA+u0LQAponkAAAAAA1JrGPybkpUAAAAAAkDFXPzxOoUAAAAAA5j+8P9ejnEAAAAAARPoxQHKKlEAAAAAAB18EQDqSlUAAAAAAJzEoQNBEjEAAAAAA+zoowIxKjMAAAAAAOdYxwNSalMAAAAAAUPxUwFyPiMAAAAAAJlNJwMDsgMAAAAAAa5qVwNxoBMAAAAAADXGewM/3C8AAAAAA0m+jwP+yO74AAAAADwutwP+yO74AAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAAACAAMABAAFAAYABAAGAAcAAwACAAgAAwAIAAkACgALAAwACgAMAA0ADQAMAA4ADQAOAA8ADwAOABAADwAQABEAEgATABQAEgAUABUAFgAXABgAFgAYABkAGgAbABwAGgAcAB0AHgALAAoAHwALAB4AHwAgAAsAIQAgAB8AIgAjACAAIgAgACEAJAAlACYAJAAmACcAJwAmACgAJwAoACkAKgArACwAKgAsAC0ALgAvADAALgAwADEAGQAYADIAGQAyADMANAA1ABsANAAbABoAFQAUADYAFQA2ADcAOAA5ADoAOAA6ADsAPAA9AD4APAA/AD0AQAA/ADwAQABBAD8AQgBBAEAAQgBAAEMARABFAEYARABGAEcARABHAEgARgBJAEcARgBKAEkASwBKAEYASwBMAEoASwBNAEwACQAIAC8ACQAvAC4ALQAsADkALQA5ADgAOwA6AE4AOwBOAE8ATwBOAE0ATwBNAEsAKQAoACsAKQArACoANwA2AFAANwBQAFEAUQBQAFIAUQBSAFMAUwBSAFQAUwBUAFUAVgBXAFgAVgBYAFkAVgBZAFoAWwBZAFgAXABZAFsAXABdAFkAXgBdAFwAXwBdAF4APAA+AGAAPABgAGEAMQAwABcAMQAXABYAYgBjADUAYgA1ADQAYQBgAGMAYQBjAGIAMwAyAF0AMwBdAF8AHQAcAGQAHQBkAGUAZQBkAAUAZQAFAAQAZgBnAAcAZgAHAAYAEQAQABMAEQATABIA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:1248,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:1248,byteOffset:1248,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:576,byteOffset:2496,target:34963}],materials:[{name:"SVGMat_001",pbrMetallicRoughness:{baseColorFactor:[.5,.5,.5,1],metallicFactor:0,roughnessFactor:1},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"����С��_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"����С��",mesh:0}],scene:0,scenes:[{nodes:[0]}]},yuanhuan41:{accessors:[{name:"Բ��_1_0_positions",componentType:5126,count:39,min:[0,0,0],max:[5.489999771118164,0,5.488900184631348],type:"VEC3",bufferView:0,byteOffset:0},{name:"Բ��_1_0_normals",componentType:5126,count:39,min:[0,-.999939501285553,-1],max:[.13969914615154266,1,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"Բ��_1_0_indices",componentType:5123,count:105,min:[0],max:[38],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"yh41",byteLength:1148,uri:"data:application/octet-stream;base64,8tKXQAAAAACoNU09FK6vQAAAAAB1Ako/FK6vQAAAAAAAAACATfOAQAAAAAACmkg+K4dWQAAAAAAIrNw+WvUtQAAAAABbsT8/X5gIQAAAAACMSpI/OUWbQAAAAAD0/VQ/LbKHQAAAAAD0/XQ/W0JqQAAAAAC6SZQ/dLXNPwAAAACfq80/H4VHQAAAAAB0JLc/ZognQAAAAAA1XuI/YVSSPwAAAAAukAhABaMKQAAAAAB4nApABcU/PwAAAACF6y1Aw2TiPwAAAACRfidASS63PwAAAABKe0dAJLncPgAAAACze1ZAj1OUPwAAAADjNmpAAppIPgAAAADu64BAnRF1PwAAAAD8qYdAqDVNPQAAAADBypdAgQRVPwAAAAAIPZtAAAAAAAAAAAASpa9AAwlKPwAAAAASpa9AJJd/PAAAAAASpa9AAwlKPwAAAAASpa9AAAAAAAAAAAASpa9Asp1vPQAAAAASpa9AJLn8PQAAAAASpa9AqoJRPgAAAAASpa9ARwOYPgAAAAASpa9AHhbKPgAAAAASpa9A2hv8PgAAAAASpa9A5q4VPwAAAAASpa9A+n4qPwAAAAASpa9AQxw7PwAAAAASpa9AwhdGPwAAAAASpa9AAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAJ5X/OwL+fz8AAACAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIC/Kzs0PAn8f78AAACApLK/PA7uf78AAACAeJkZPefRfz8AAACA+ZldPQSgf78AAACA6XSTPelVfz8AAACALLO3PdT3fr8AAACAfkjZPR2Ofr8AAACANf32Paohfj8AAACAeUYHPqDBfT8AAACASw0PPlt9fb8AAACAAAABAAIAAwABAAAABAABAAMABQABAAQABgAHAAUABwABAAUABgAIAAcABgAJAAgACgAJAAYACgALAAkACgAMAAsADQAMAAoADQAOAAwADwAOAA0ADwAQAA4ADwARABAAEgARAA8AEgATABEAFAATABIAFAAVABMAFgAVABQAFgAXABUAGAAXABYAGAAZABcAGgAbABwAHQAbABoAHgAbAB0AHwAbAB4AIAAbAB8AIQAbACAAIgAbACEAIwAbACIAJAAbACMAJQAbACQAJgAbACUAAAA="}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:468,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:468,byteOffset:468,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:212,byteOffset:936,target:34963}],materials:[{name:"SVGMat_002",pbrMetallicRoughness:{baseColorFactor:[.588,.588,.588,1],metallicFactor:0,roughnessFactor:.99},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"Բ��_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"Բ��",mesh:0}],scene:0,scenes:[{nodes:[0]}]},yuanhuan411:{accessors:[{name:"����СȦ_1_0_positions",componentType:5126,count:28,min:[.026000000536441803,-4.6834001541137695,0],max:[4.696700096130371,-.014800000004470348,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"����СȦ_1_0_normals",componentType:5126,count:28,min:[0,0,1],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"����СȦ_1_0_indices",componentType:5123,count:78,min:[0],max:[27],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"yuanhuan411",byteLength:828,uri:"data:application/octet-stream;base64,ufwXQLN7Mr8AAAAAObRAQLFQK78AAAAA1ediQMWP8b4AAAAAGQQ6QCv2174AAAAAqFdeQHUCWr4AAAAA7FGCQL6fmr0AAAAAHHyDQDLmrr4AAAAAXkuWQJf/kL4AAAAAXkuWQLN7crwAAAAAMCrxP2RdhL8AAAAA/BgDQJeQn78AAAAADeARQAg9i78AAAAAukkIQISeXb8AAAAAZaogQH/Zbb8AAAAA7Q3ePr4wOcAAAAAA5IMuP9/gP8AAAAAAJQZxPwrXH8AAAAAAPZs1P6UsF8AAAAAAdy2hP0VHAsAAAAAAb/CFP5eQ778AAAAA0ES4P32utr8AAAAAAprQPyL9zr8AAAAAi/1lPqqCXcAAAAAA9dv3PtcSYsAAAAAADi2yPZvmgcAAAAAAYTK1PssQg8AAAAAA9P3UPGrelcAAAAAA4liXPmrelcAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAAACAAMAAwACAAQABQAGAAcABQAHAAgABAACAAYABAAGAAUACQAKAAsACQALAAwAAAANAAEADgAPABAADgAQABEAEQAQABIAEQASABMAFAAVAAoAFAAKAAkADAALAA0ADAANAAAAFgAXAA8AFgAPAA4AGAAZABcAGAAXABYAGgAZABgAGgAbABkAEwASABUAEwAVABQA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:336,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:336,byteOffset:336,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:156,byteOffset:672,target:34963}],materials:[{name:"SVGMat",pbrMetallicRoughness:{baseColorFactor:[.588,.588,.588,1],metallicFactor:0,roughnessFactor:.99},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"����СȦ_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"����СȦ",mesh:0}],scene:0,scenes:[{nodes:[0]}]},yuanpan:{accessors:[{name:"Circle001_1_0_positions",componentType:5126,count:28,min:[-1.9510999917984009,0,-1.9510999917984009],max:[1.9510999917984009,0,1.9510999917984009],type:"VEC3",bufferView:0,byteOffset:0},{name:"Circle001_1_0_normals",componentType:5126,count:28,min:[0,1,0],max:[0,1,0],type:"VEC3",bufferView:1,byteOffset:0},{name:"Circle001_1_0_indices",componentType:5123,count:78,min:[0],max:[27],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"yuanpan",byteLength:828,uri:"data:application/octet-stream;base64,S+rkvgAAAADRIvM/AAAAAAAAAAClvfk/S+rkPgAAAADRIvM/0SLzvwAAAABL6uQ+MlXgvwAAAACsi1s/c9fCvwAAAACvJZw/pb35vwAAAAAAAAAA0SLzvwAAAABL6uS+MlXgvwAAAACsi1u/c9fCvwAAAACvJZy/ryWcvwAAAABz18K/rItbvwAAAAAyVeC/S+rkvgAAAADRIvO/AAAAgAAAAAClvfm/S+rkPgAAAADRIvO/rItbPwAAAAAyVeC/ryWcPwAAAABz18K/c9fCPwAAAACvJZy/MlXgPwAAAACsi1u/0SLzPwAAAABL6uS+pb35PwAAAAAAAACA0SLzPwAAAABL6uQ+MlXgPwAAAACsi1s/c9fCPwAAAACvJZw/ryWcvwAAAABz18I/ryWcPwAAAABz18I/rItbvwAAAAAyVeA/rItbPwAAAAAyVeA/AAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAABAAIAAwAEAAUABgADAAUABwAGAAUACAAHAAUACQAIAAUACgAJAAUACwAKAAUADAALAAUADQAMAAUADgANAAUADwAOAAUAEAAPAAUAEQAQAAUAEgARAAUAEwASAAUAFAATAAUAFQAUAAUAFgAVAAUAFwAWAAUAFwAFABgAGQAXABgAGQAYABoAGwAZABoAAgAbABoAAAACABoA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:336,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:336,byteOffset:336,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:156,byteOffset:672,target:34963}],materials:[{name:"wire_008110135",pbrMetallicRoughness:{baseColorFactor:[.0314,.4314,.5294,1],metallicFactor:0,roughnessFactor:.968},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"Circle001_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"Circle001",mesh:0}],scene:0,scenes:[{nodes:[0]}]},zzhou:{accessors:[{name:"Cube.001-Mesh_0_positions",componentType:5126,count:45,min:[-.2711470127105713,-5.473427772521973,-.2711470127105713],max:[.2711470127105713,.46298399567604065,.2711470127105713],type:"VEC3",bufferView:0,byteOffset:0},{name:"Cube.001-Mesh_0_normals",componentType:5126,count:45,min:[-1,-1,-1],max:[1,1,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"Cube.001-Mesh_0_texcoords",componentType:5126,count:45,min:[.125,0],max:[.875,1],type:"VEC2",bufferView:2,byteOffset:0},{name:"Cube.001-Mesh_0_indices",componentType:5123,count:72,min:[0],max:[44],type:"SCALAR",bufferView:3,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"Z",byteLength:1584,uri:"data:application/octet-stream;base64,/waNvZMdK77/Bo09/waNPZMdK77/Bo09/waNPR4Kr8D/Bo09l+KKPVImr8D/Bo09/waNvVImr8D/Bo09yNOKPsjTir7I04o+AAAAAD0M7T4AAAAAyNOKvsjTir7I04o+yNOKvsjTir7I04o+AAAAAD0M7T4AAAAAyNOKvsjTir7I04q+yNOKvsjTir7I04q+yNOKPsjTir7I04q+yNOKPsjTir7I04o+yNOKvsjTir7I04o+yNOKPsjTir7I04q+AAAAAD0M7T4AAAAAyNOKPsjTir7I04o+yNOKvsjTir7I04q+AAAAAD0M7T4AAAAAyNOKPsjTir7I04q+/waNPZMdK77/Bo09/waNPZMdK77/Bo29/waNPVImr8D/Bo29/waNPVImr8D/Bo09/waNPR4Kr8D/Bo09/waNvZMdK77/Bo09/waNvVImr8D/Bo09/waNvVImr8D/Bo29/waNvZMdK77/Bo29/waNvZMdK77/Bo29/waNvVImr8D/Bo29/waNPVImr8D/Bo29/waNPZMdK77/Bo29/waNPZMdK77/Bo09/waNvZMdK77/Bo09/waNvZMdK77/Bo29/waNPZMdK77/Bo29/waNvVImr8D/Bo09cooOO1Imr8BAMTI7/waNvVImr8D/Bo29/waNPVImr8D/Bo29/waNPVImr8D/Bo09l+KKPVImr8D/Bo09/waNPVImr8D/Bo09AAAAAAAAAAAAAIC/AAAAAAAAAAAAAIC/AAAAAAAAAAAAAIC/AAAAAAAAAAAAAIC/AAAAAAAAAAAAAIC/AAAAAFFmsT5wJHA/AAAAAFFmsT5wJHA/AAAAAFFmsT5wJHA/cCRwv1FmsT4AAAAAcCRwv1FmsT4AAAAAcCRwv1FmsT4AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAcCRwP1FmsT4AAAAAcCRwP1FmsT4AAAAAcCRwP1FmsT4AAAAAAAAAAFFmsT5wJHC/AAAAAFFmsT5wJHC/AAAAAFFmsT5wJHC/AACAvwAAAAAAAAAAAACAvwAAAAAAAAAAAACAvwAAAAAAAAAAAACAvwAAAAAAAAAAAACAvwAAAAAAAAAAAACAPwAAAAAAAAAAAACAPwAAAAAAAAAAAACAPwAAAAAAAAAAAACAPwAAAAAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgD8AAAAAAAAAAAAAgD8AAAAAAAAAAAAAgD8AAAAAAAAAAAAAgD8AAAAAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAAAAAAAAAAAAgD8AAAAAAADAPgAAQD8AAMA+AACAP2L1Hz8AAIA/AAAgP3uDfz8AACA/AABAPwAAwD4AAIA+AAAgPwAAAAAAAMA+AAAAAAAAwD4AAIA/AAAgPwAAQD8AAMA+AABAPwAAAD4AAAA/AADAPgAAAD8AAMA+AACAPgAAAD4AAIA+AADAPgAAAD8AACA/AACAPgAAwD4AAIA+AADAPgAAQD8AACA/AAAAPwAAwD4AAAA/AADAPgAAAD8AAMA+AABAPwAAID8AAEA/AAAgPwAAAD9i9R8/AAAAPwAAwD4AAAA/AAAgPwAAAD8AACA/AACAPgAAwD4AAIA+AADAPgAAgD4AACA/AACAPgAAID8AAAAAAADAPgAAAAAAAAA+AAAAPwAAwD4AAAA/AADAPgAAgD4AAAA+AACAPgAAID8AAAA/vAJBP/mGwj4AACA/AACAPgAAYD8AAIA+AAAgPwAAgD97g18/AAAAPwAAYD8AAAA/AAABAAIAAgADAAQAAgAEAAAABQAGAAcACAAJAAoACwAMAA0ACwANAA4ADwAQABEAEgATABQAFQAWABcAFwAYABkAFwAZABUAGgAbABwAGgAcAB0AHgAfACAAHgAgACEAIgAjACQAIgAkACUAJgAnACgAKAAnACkAAwACACoAKQAnACsAKQArACwAJwAmACsA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:540,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:540,byteOffset:540,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:360,byteOffset:1080,byteStride:8,target:34962},{name:"bufferView_3",buffer:0,byteLength:144,byteOffset:1440,target:34963}],materials:[{name:"Material.001",pbrMetallicRoughness:{baseColorFactor:[.8,.8,.8,1],metallicFactor:0,roughnessFactor:.676000006},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"Cube.001-Mesh",primitives:[{attributes:{POSITION:0,NORMAL:1,TEXCOORD_0:2},indices:3,material:0,mode:4}]}],nodes:[{name:"Cube.001",mesh:0}],scene:0,scenes:[{nodes:[0]}]},jiantou:{accessors:[{name:"��ͷ_1_0_positions",componentType:5126,count:7,min:[-.47690001130104065,-.8044000267982483,0],max:[.47780001163482666,0,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"��ͷ_1_0_normals",componentType:5126,count:7,min:[0,0,1],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"��ͷ_1_0_indices",componentType:5123,count:15,min:[0],max:[6],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"jiantou",byteLength:200,uri:"data:application/octet-stream;base64,bxIDOintTb8AAAAAH/RsvsKGp74AAAAAPSz0vsKGp74AAAAANs17PsKGp74AAAAANKL0PsKGp74AAAAANs17PgAAAAAAAAAAH/RsvgAAAAAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAAADAAEAAAAEAAMAAQAFAAYAAQADAAUAAAA="}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:84,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:84,byteOffset:84,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:32,byteOffset:168,target:34963}],materials:[{name:"SVGMat_003",pbrMetallicRoughness:{baseColorFactor:[.588,.588,.588,1],metallicFactor:0,roughnessFactor:.99},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"��ͷ_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"��ͷ",mesh:0}],scene:0,scenes:[{nodes:[0]}]},xuanzhuan:{accessors:[{name:"��ת001_1_0_positions",componentType:5126,count:369,min:[-6.572299957275391,-7.298999786376953,0],max:[6.5742998123168945,7.298299789428711,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"��ת001_1_0_normals",componentType:5126,count:369,min:[0,-1,0],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"��ת001_1_0_indices",componentType:5123,count:1089,min:[0],max:[368],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"旋转-新",byteLength:11036,uri:"data:application/octet-stream;base64,1zQDwHql3kAAAAAA48e4vgMJ1kAAAAAAQmD1v6yL6UAAAAAA2qxqv1Fr0EAAAAAAVHSkvnuD1UAAAAAAF7eRvjXv1EAAAAAAyeV/vqVO1EAAAAAA5INevsuh00AAAAAAW7E/vpHt0kAAAAAAZogjvoMv0kAAAAAAAwkKvrpr0UAAAAAA+aDnvTSi0EAAAAAAXCDBvWfVz0AAAAAAqoLZv4NRy0AAAAAALv+hvfcGz0AAAAAAAwmKvVg5zkAAAAAA/Yd0vYtszUAAAAAAak1zvSBBzUAAAAAA1xJyveQUzUAAAAAAIEFxvTLmzEAAAAAARdhwvd21zEAAAAAARdhwvbaEzEAAAAAAIEFxvb1SzEAAAAAAs3tyvSEfzEAAAAAARrZzvYXry0AAAAAAayt2vRe3y0AAAAAAkKB4vQaBy0AAAAAASFB8vfVKy0AAAAAAhXwcwLRZw0AAAAAAbjSAveQUy0AAAAAA3EaDvcX+ykAAAAAAb/CFvTLmykAAAAAAcM6IvRTQykAAAAAAcayLvSS5ykAAAAAAcoqOvQWjykAAAAAA4XqUvWx4ykAAAAAAUI2XvSBjykAAAAAACD2bvQFNykAAAAAAUrievbU3ykAAAAAAeJyivTojykAAAAAA5x2nve0NykAAAAAAMCqpvaMBykAAAAAAVp+rvVr1yUAAAAAAexSuvbPqyUAAAAAAxSCwvTvfyUAAAAAA6pWyvfLSyUAAAAAAoda0vUvIyUAAAAAAx0u3vQK8yUAAAAAAWvW5vVuxyUAAAAAA7Z68vYenyUAAAAAA7ny/veCcyUAAAAAAgSbCvQyTyUAAAAAAgQTFvQmKyUAAAAAA1CvlvRUdyUAAAAAAXW0FviS5yEAAAAAALNQavjVeyEAAAAAADi0yvqYKyEAAAAAAlkNLvki/x0AAAAAA5q5lvhx8x0AAAAAAZaqAvqs+x0AAAAAA4L6OvsgHx0AAAAAAyAedvnPXxkAAAAAAlkOrvqytxkAAAAAAEFi5vs6IxkAAAAAAH4XLvpVlxkAAAAAAAwnKvjhnxkAAAAAA54zIvjhnxkAAAAAAsAPHvgpoxkAAAAAAOwHNvsNkxkAAAAAAO3DOvvFjxkAAAAAA0ETYvpJcxkAAAAAAV+zPvk5ixkAAAAAAV1vRvtlfxkAAAAAAWMrSvgdfxkAAAAAAWDnUvmRdxkAAAAAAIo7VvpJcxkAAAAAA6+LWvpJcxkAAAAAAiIXavgRWxkAAAAAAJLncvkhQxkAAAAAA2/nevl5LxkAAAAAAkzrhvhdIxkAAAAAASnvjvtBExkAAAAAAMzPzvoY4xkAAAAAAArzlvrhAxkAAAAAAufznvkI+xkAAAAAAcT3qvs07xkAAAAAAKH7svlg5xkAAAAAAxLHuvoY4xkAAAAAAfPLwvoY4xkAAAAAA9Gz2vsoyxkAAAAAAtab5vj0sxkAAAAAAduD8vlInxkAAAAAAqRMAvzojxkAAAAAApb0Bv08exkAAAAAAE2EDvzcaxkAAAAAAnREFv00VxkAAAAAAC7UGvzQRxkAAAAAAlWUIv0oMxkAAAAAAHhYKv18HxkAAAAAAGsALv6MBxkAAAAAADk8Pv7n8xUAAAAAAgEgPv7n8xUAAAAAApHANv7n8xUAAAAAAUwWrv90kwkAAAAAASS4Pv7n8xUAAAAAApHANv7n8xUAAAAAAgEgPv7n8xUAAAAAA9wYPv7n8xUAAAAAAidIOv7n8xUAAAAAAG54Ov7n8xUAAAAAAIGMOv7n8xUAAAAAAJCgOv7n8xUAAAAAAKe0Nv7n8xUAAAAAASL8Nv7n8xUAAAAAA9pcNv7n8xUAAAAAAv30Nv7n8xUAAAAAABoFJwDm0uEAAAAAAZvcEwJtVu0AAAAAAwcoxwOzAsUAAAAAARiUFQFdbu8AAAAAAdZMcQM9mw8AAAAAA9pdJQIPAuMAAAAAAtvMxQEvIscAAAAAA2IFzQISeq8AAAAAAjLlbQECkpcAAAAAAZveMQPkxnMAAAAAAPQqBQNEil8AAAAAA+zqeQJOpisAAAAAAdk+SQPd1hsAAAAAAA3ihQFafZ8AAAAAAnl6tQN5xbsAAAAAAsi66QCEfRMAAAAAASFCuQLTIPsAAAAAA4XrEQPW5FsAAAAAAHqe4QJ/NEsAAAAAA1xLMQJhMzb8AAAAA6UjAQFInyL8AAAAAnMTQQM4ZUb8AAAAAsAPFQKMBTL8AAAAAduCMwKMjWcAAAAAA9P1wwOauOcAAAAAA6GqDwG1WGcAAAAAA46WZwA5PM8AAAAAANKLGQBe30TkAAAAAqmDSQBe30TkAAAAAdQLMwEYlzT8AAAAALUPAwAAAyD8AAAAAvp+4wFK4EkAAAAAArWnEwAWjFkAAAAAAF0iuwGizPkAAAAAATx66wI4GREAAAAAAXW2hwAmKZ0AAAAAAPE6twEtZbkAAAAAAW0KSwFFrhkAAAAAAayuewO2eikAAAAAAUPyAwPwYl0AAAAAA1eeMwK8lnEAAAAAAyJhbwA+cpUAAAAAAoWdzwDqSq0AAAAAA6GqrP8cpwsAAAAAA+zoQP6MBxsAAAAAAbqPZPxNhy8AAAAAAYHYPPxsNxsAAAAAAukkMPzQRxsAAAAAA0gAOPxsNxsAAAAAARPoNPxsNxsAAAAAAexQOPxsNxsAAAAAAPzUOPxsNxsAAAAAAIGMOPxsNxsAAAAAAcooOPxsNxsAAAAAAUrgOPxsNxsAAAAAAMuYOPxsNxsAAAAAAoBoPPxsNxsAAAAAAZDsPPxsNxsAAAAAAKVwPPxsNxsAAAAAA0m8PPxsNxsAAAAAAMZkKP00VxsAAAAAAp+gIPzcaxsAAAAAAqz4HPyEfxsAAAAAAIo4FP90kxsAAAAAAmN0DP2srxsAAAAAADi0CPycxxsAAAAAAhXwAP+M2xsAAAAAA9pf9PnE9xsAAAAAA/kP6PltCxsAAAAAA6+L2PqJFxsAAAAAA2IHzPulIxsAAAAAAc2jxPl5LxsAAAAAADk/vPtNNxsAAAAAAqDXtPkhQxsAAAAAAKA/rPr1SxsAAAAAAjNvoPmFUxsAAAAAAC7XmPjJVxsAAAAAAVHTkPgRWxsAAAAAA003iPnlYxsAAAAAAGw3gPh1axsAAAAAAZMzdPpJcxsAAAAAArIvbPgdfxsAAAAAA9UrZPnxhxsAAAAAA2c7XPvFjxsAAAAAA2V/WPpVlxsAAAAAA2PDUPgpoxsAAAAAA847TPn9qxsAAAAAA8x/SPiJsxsAAAAAA8rDQPvRsxsAAAAAA8kHPPphuxsAAAAAAKe3NPg1xxsAAAAAAKH7MPt5xxsAAAAAADALLPlR0xsAAAAAADJPJPsl2xsAAAAAA8BbIPj55xsAAAAAA4za6PryWxsAAAAAATRWsPvW5xsAAAAAASL+dPuvixsAAAAAAYHaPPp0Rx8AAAAAA5WGBPgtGx8AAAAAAi2xnPtiBx8AAAAAAOwFNPtbFx8AAAAAA6gQ0PmIQyMAAAAAAP8YcPiBjyMAAAAAA3pMHPrG/yMAAAAAAZ0TpPdEiycAAAAAAg1HJPcWPycAAAAAAy6HFPQ+cycAAAAAA7lrCPYenycAAAAAAEhS/PdCzycAAAAAAowG8PRrAycAAAAAAEFi5PZLLycAAAAAAfa62PdzXycAAAAAA6gS0PVTjycAAAAAAxY+xPZ7vycAAAAAADk+vPef7ycAAAAAA6NmsPV8HysAAAAAAn82qPakTysAAAAAAeVioPfMfysAAAAAAwaikPT81ysAAAAAA5WGhPYxKysAAAAAACRuePapgysAAAAAACD2bPcl2ysAAAAAAB1+YPbmNysAAAAAAdLWVPamkysAAAAAAvJaQPVvTysAAAAAABFaOPRzrysAAAAAA3+CLPd4Cy8AAAAAAldSJPXEby8AAAAAAcF+HPTMzy8AAAAAA3bWEPc9my8AAAAAALNRqP1Z90MAAAAAAuECCPciYy8AAAAAA3GiAPZLLy8AAAAAAtvN9PS7/y8AAAAAASFB8PScxzMAAAAAA/kN6PSBjzMAAAAAAI9t5PUaUzMAAAAAAI9t5PRHHzMAAAAAAI9t5PTj4zMAAAAAA/kN6PV8pzcAAAAAAkX57PYZazcAAAAAAJLl8PQmKzcAAAAAAcoqOPdZWzsAAAAAAMEymPaMjz8AAAAAAXW3FPZ7vz8AAAAAAjLnrPfW50MAAAAAAqz4DQN213sAAAAAAgy8MPmN/0cAAAAAA5q4lPrhA0sAAAAAAE/JBPn/70sAAAAAAnMRgPhSu08AAAAAAJQaBPnlY1MAAAAAAPL2SPpT21MAAAAAAeHqlPgmK1cAAAAAAhxa5Pr8O1sAAAAAA63P1P2iR6cAAAAAApb1Bv4xKsEAAAAAAMlVAP4xKsEAAAAAAw2QquxDpsUAAAAAAMne9v/OOq0AAAAAA3bW8P/OOq0AAAAAAYqEKwG/wo0AAAAAAcT0KQG/wo0AAAAAA/7IzwG6jmUAAAAAAak0zQG6jmUAAAAAA8IVZwAHejEAAAAAAHcklvw6+lkAAAAAAw2Qqu8UgmEAAAAAAxm0kPw6+lkAAAAAAuB5ZQAHejEAAAAAAc2ihP5aykkAAAAAA1xKiv5aykkAAAAAAKH7sP+AtjEAAAAAAjSjtv+AtjEAAAAAAuK97wBSue0AAAAAAOUV7QBSue0AAAAAAnl4ZQHBfg0AAAAAAdLUZwHBfg0AAAAAAXro5QGDlcEAAAAAA7Q06wGDlcEAAAAAAduCMwPCFWUAAAAAAZaqMQPCFWUAAAAAAqvFWQJAxV0AAAAAA3EZXwJAxV0AAAAAA46WZwEa2M0AAAAAA0m+ZQEa2M0AAAAAAHqdwQIv9OUAAAAAA9P1wwIv9OUAAAAAAIEGDQLWmGUAAAAAA6GqDwLWmGUAAAAAAnzyMwMZt7L8AAAAAiPSjwHE9CsAAAAAAIEGDQG1WGcAAAAAA0m+ZQA5PM8AAAAAA07yjQHE9CsAAAAAANBGMQMZt7L8AAAAA+1yrQAisvL8AAAAA6pWSQBBYob8AAAAAOpKrwAisvL8AAAAAVcGSwBBYob8AAAAA+8uWwI9TJL8AAAAA002wwG40QL8AAAAAYqGWQMbcJT8AAAAA8BawQPfkQT8AAAAA+1yrQE2EvT8AAAAA6pWSQJEPoj8AAAAAVTCYwInSXjsAAAAA+u2xwInSXjsAAAAA6gSYQInSXjsAAAAARraxQInSXjsAAAAAObTQwEXYUD8AAAAAIv3EwBrASz8AAAAAYqGWQI9TJL8AAAAA8BawQG40QL8AAAAA+8uWwMbcJT8AAAAA002wwPfkQT8AAAAAVcGSwJEPoj8AAAAAOpKrwE2EvT8AAAAAnzyMwOQU7T8AAAAAiPSjwEymCkAAAAAA07yjQEymCkAAAAAANBGMQOQU7T8AAAAAHqdwQOauOcAAAAAAZaqMQKMjWcAAAAAA3EZXwOviVsAAAAAAqvFWQOviVsAAAAAA7Q06wLyWcMAAAAAAXro5QLyWcMAAAAAAOUV7QMdLe8AAAAAAuK97wMdLe8AAAAAAdLUZwHo2g8AAAAAAnl4ZQHo2g8AAAAAAuB5ZQE+vjMAAAAAA8IVZwE+vjMAAAAAAjSjtv+oEjMAAAAAAKH7sP+oEjMAAAAAA1xKiv86IksAAAAAAc2ihP86IksAAAAAAak0zQGB2mcAAAAAA/7IzwGB2mcAAAAAAHcklv0aUlsAAAAAAxm0kP0aUlsAAAAAAw2Qqu/32l8AAAAAAcT0KQDPEo8AAAAAAYqEKwDPEo8AAAAAA3bW8P4hjq8AAAAAAMne9v4hjq8AAAAAAMlVAPyEfsMAAAAAApb1BvyEfsMAAAAAAw2Qqu3e+scAAAAAASFDSwG8Sg7oAAAAASZ3GwG8Sg7oAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAwABAAAAAwAEAAEAAwAFAAQAAwAGAAUAAwAHAAYAAwAIAAcAAwAJAAgAAwAKAAkAAwALAAoAAwAMAAsADQAMAAMADQAOAAwADQAPAA4ADQAQAA8ADQARABAADQASABEADQATABIADQAUABMADQAVABQADQAWABUADQAXABYADQAYABcADQAZABgADQAaABkADQAbABoAHAAbAA0AHAAdABsAHAAeAB0AHAAfAB4AHAAgAB8AHAAhACAAHAAiACEAHAAjACIAHAAkACMAHAAlACQAHAAmACUAHAAnACYAHAAoACcAHAApACgAHAAqACkAHAArACoAHAAsACsAHAAtACwAHAAuAC0AHAAvAC4AHAAwAC8AHAAxADAAHAAyADEAHAAzADIAHAA0ADMAHAA1ADQAHAA2ADUAHAA3ADYAHAA4ADcAHAA5ADgAHAA6ADkAHAA7ADoAHAA8ADsAHAA9ADwAHAA+AD0AHAA/AD4AHABAAD8AQABBAD8AQQBCAD8AQgBDAD8AHABAAEQAHABEAEUAHABGAEUARgBHAEUARgBIAEcARgBJAEgARgBKAEkARgBLAEoARgBMAEsAHABNAEYAHABOAE0AHABPAE4AHABQAE8AHABRAFAAHABSAFEAUgBTAFEAUgBUAFMAUgBVAFQAUgBWAFUAUgBXAFYAUgBYAFcAHABZAFIAHABaAFkAHABbAFoAHABcAFsAHABdAFwAHABeAF0AHABfAF4AHABgAF8AHABhAGAAHABiAGEAHABjAGIAHABjAGQAZABlAGMAZQBmAGMAHABnAGQAaABpAGoAawBpAGgAbABpAGsAbQBpAGwAbgBpAG0AbwBpAG4AcABpAG8AcQBpAHAAcgBpAHEAcwBpAHIAdABnABwAdAB1AGcAdAB2AHUAdwB4AHkAdwB5AHoAegB5AHsAegB7AHwAfAB7AH0AfAB9AH4AfgB9AH8AfgB/AIAAgQCCAIMAgQCDAIQAhACDAIUAhACFAIYAhgCFAIcAhgCHAIgAiACHAIkAiACJAIoAiwCMAI0AiwCNAI4AjwCKAJAAigCJAJAAkQCSAJMAkQCTAJQAlACTAJUAlACVAJYAlgCVAJcAlgCXAJgAgAB/AIIAgACCAIEAmACXAJkAmACZAJoAmgCZAJsAmgCbAJwAnACbAJ0AnACdAJ4AngCdAHYAngB2AHQAnwB4AHcAoAB4AJ8AoAChAHgAogChAKAAowCkAKUAowCmAKQAowCnAKYAowCoAKcAowCpAKgAowCqAKkAowCrAKoAowCsAKsAowCtAKwAowCuAK0AowCvAK4AowCiAK8AowChAKIAsAChAKMAsQChALAAsgChALEAswChALIAtAChALMAtQChALQAtgChALUAtwChALYAuAChALcAuQChALgAugChALkAuwChALoAvAChALsAvQChALwAvgChAL0AvwChAL4AwAChAL8AwQChAMAAwgChAMEAwwChAMIAxAChAMMAxQChAMQAxgChAMUAxwChAMYAyAChAMcAyQChAMgAygChAMkAywChAMoAzAChAMsAzQChAMwAzgChAM0AzwChAM4A0AChAM8A0QChANAA0gChANEA0wChANIA1AChANMA1QChANQA1gChANUA1wChANYA2AChANcA2QChANgA2gChANkA2wChANoA3AChANsA3QChANwA3gChAN0A3wChAN4A4AChAN8A4QChAOAA4gChAOEA4wChAOIA5AChAOMA5QChAOQA5gChAOUA5wChAOYA6AChAOcA6QChAOgA6gChAOkA6wChAOoA7AChAOsA7QChAOwA7gChAO0A7wChAO4A8AChAO8A8QChAO8A8gChAPEA8wChAPIA9AChAPMA9QChAPQA9gChAPUA9gD3AKEA+AD3APYA+QD3APgA+gD3APkA+wD3APoA/AD3APsA/QD3APwA/gD3AP0A/wD3AP4AAAH3AP8AAQH3AAABAgH3AAEBAwH3AAIBBAH3AAMBBQH3AAQBBgH3AAUBBgEHAfcACAEHAQYBCQEHAQgBCgEHAQkBCwEHAQoBDAEHAQsBDQEHAQwBDgEHAQ0BDwEHAQ4BEAEHAQ8BEQESARMBFAESAREBFAEVARIBFgEVARQBFgEXARUBGAEXARYBGAEZARcBGgEbARgBGwEcARgBHAEZARgBHAEdARkBHQEeARkBHwEeAR0BGgEgARsBIQEeAR8BGgEiASABIwEiARoBIQEkAR4BJQEkASEBIwEmASIBJwEkASUBIwEoASYBKQEoASMBJwEqASQBKwEqAScBKQEsASgBLQEsASkBKwEuASoBLwEuASsBLQEwASwBMQEuAS8BLQEyATABjgCNADMBjgAzATQBNQE2ATcBNQE3ATgBOAE3ATkBOAE5AToBOwE8AT0BOwE9AT4BPwFAAUEBPwFBAUIBPgE9AUMBPgFDAUQBRQFGAUABRQFAAT8BRwFIAZIARwGSAJEASQFKAUYBSQFGAUUBRAFDAUsBRAFLAUwBOgE5AUoBOgFKAUkBTAFLAU0BTAFNAU4BTgFNAU8BTgFPAVABQgFBAVEBQgFRAVIBUgFRAS4BUgEuATEBNAEzATwBNAE8ATsBUwFUATYBUwE2ATUBUAFPATIBUAEyAS0BiwBVAYwAVgFUAVMBiwBXAVUBWAFUAVYBWAFZAVQBWgFXAYsAWgFbAVcBXAFZAVgBXAFdAVkBXgFbAVoBXgFfAVsBYAFdAVwBXgFhAV8BYgFdAWABYgFjAV0BZAFhAV4BZAFlAWEBZgFjAWIBZAFnAWUBZwFjAWYBZAFjAWcBZAFoAWMBaQFoAWQBaQFqAWgBawFqAWkBawFsAWoBbQFsAWsBbQFuAWwBbwFwAUgBbwFIAUcBAAA="}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:4428,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:4428,byteOffset:4428,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:2180,byteOffset:8856,target:34963}],materials:[{name:"SVGMat",pbrMetallicRoughness:{baseColorFactor:[.5,.5,.5,1],metallicFactor:0,roughnessFactor:1},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"��ת001_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"��ת001",mesh:0}],scene:0,scenes:[{nodes:[0]}]},plane:{accessors:[{name:"Rectangle001_1_0_positions",componentType:5126,count:4,min:[-5,-5,0],max:[5,5,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"Rectangle001_1_0_normals",componentType:5126,count:4,min:[0,0,1],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"Rectangle001_1_0_indices",componentType:5123,count:6,min:[0],max:[3],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"plane",byteLength:108,uri:"data:application/octet-stream;base64,AACgQAAAoEAAAAAAAACgwAAAoEAAAAAAAACgwAAAoMAAAAAAAACgQAAAoMAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAgADAAAA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:48,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:48,byteOffset:48,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:12,byteOffset:96,target:34963}],materials:[{name:"wire_225198087",pbrMetallicRoughness:{baseColorFactor:[.8824,.7765,.3412,1],metallicFactor:0,roughnessFactor:.968},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"Rectangle001_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"Rectangle001",mesh:0}],scene:0,scenes:[{nodes:[0]}]},xyzScale:{asset:{generator:"Khronos glTF Blender I/O v1.6.16",version:"2.0"},scene:0,scenes:[{name:"Scene",nodes:[0,1,2,3,4,5,6]}],nodes:[{mesh:0,name:"Cube",scale:[.7008190751075745,.014999999664723873,.014999999664723873]},{mesh:1,name:"Cube.001",scale:[.10000000149011612,.10000000149011612,.10000000149011612]},{mesh:2,name:"Cube.004",rotation:[0,-.7071068286895752,0,.7071068286895752],scale:[.7008190751075745,.014999999664723873,.014999999664723873]},{mesh:3,name:"Cube.003",rotation:[0,-.7071068286895752,0,.7071068286895752],scale:[.10000000149011612,.10000000149011612,.10000000149011612]},{mesh:4,name:"Cube.006",rotation:[0,0,.7071068286895752,.7071068286895752],scale:[.7008190751075745,.014999999664723873,.014999999664723873]},{mesh:5,name:"Cube.005",rotation:[0,0,.7071068286895752,.7071068286895752],scale:[.10000000149011612,.10000000149011612,.10000000149011612]},{mesh:6,name:"Cube.002",scale:[.10000000149011612,.10000000149011612,.10000000149011612]}],materials:[{doubleSided:!0,name:"Material",pbrMetallicRoughness:{baseColorFactor:[.6938720345497131,.020288480445742607,.011612260714173317,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.001",pbrMetallicRoughness:{baseColorFactor:[.6938720345497131,.020288480445742607,.011612260714173317,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.002",pbrMetallicRoughness:{baseColorFactor:[.626582869887352,.626582869887352,.626582869887352,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.006",pbrMetallicRoughness:{baseColorFactor:[.11193240433931351,.5583405494689941,.033104799687862396,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.005",pbrMetallicRoughness:{baseColorFactor:[.11193240433931351,.5583405494689941,.033104799687862396,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.010",pbrMetallicRoughness:{baseColorFactor:[.004391402006149292,.21223078668117523,.5209956169128418,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.009",pbrMetallicRoughness:{baseColorFactor:[.004391402006149292,.21223078668117523,.5209956169128418,1],metallicFactor:0,roughnessFactor:.4000000059604645}}],meshes:[{name:"Cube",primitives:[{attributes:{POSITION:0,NORMAL:1,TEXCOORD_0:2},indices:3,material:0}]},{name:"Cube.001",primitives:[{attributes:{POSITION:4,NORMAL:5,TEXCOORD_0:6},indices:3,material:1}]},{name:"Cube.006",primitives:[{attributes:{POSITION:10,NORMAL:11,TEXCOORD_0:12},indices:3,material:3}]},{name:"Cube.005",primitives:[{attributes:{POSITION:13,NORMAL:14,TEXCOORD_0:15},indices:3,material:4}]},{name:"Cube.010",primitives:[{attributes:{POSITION:16,NORMAL:17,TEXCOORD_0:18},indices:3,material:5}]},{name:"Cube.009",primitives:[{attributes:{POSITION:19,NORMAL:20,TEXCOORD_0:21},indices:3,material:6}]},{name:"Cube.002",primitives:[{attributes:{POSITION:7,NORMAL:8,TEXCOORD_0:9},indices:3,material:2}]}],accessors:[{bufferView:0,componentType:5126,count:24,max:[2.0003609657287598,1,1],min:[.0003610849380493164,-1,-1],type:"VEC3"},{bufferView:1,componentType:5126,count:24,type:"VEC3"},{bufferView:2,componentType:5126,count:24,type:"VEC2"},{bufferView:3,componentType:5123,count:36,type:"SCALAR"},{bufferView:4,componentType:5126,count:24,max:[14.549108505249023,1,1],min:[12.549108505249023,-1,-1],type:"VEC3"},{bufferView:5,componentType:5126,count:24,type:"VEC3"},{bufferView:6,componentType:5126,count:24,type:"VEC2"},{bufferView:7,componentType:5126,count:24,max:[1,1,1],min:[-1,-1,-1],type:"VEC3"},{bufferView:8,componentType:5126,count:24,type:"VEC3"},{bufferView:9,componentType:5126,count:24,type:"VEC2"},{bufferView:10,componentType:5126,count:24,max:[2.0003609657287598,1,1],min:[.0003610849380493164,-1,-1],type:"VEC3"},{bufferView:11,componentType:5126,count:24,type:"VEC3"},{bufferView:12,componentType:5126,count:24,type:"VEC2"},{bufferView:13,componentType:5126,count:24,max:[14.549108505249023,1,1],min:[12.549108505249023,-1,-1],type:"VEC3"},{bufferView:14,componentType:5126,count:24,type:"VEC3"},{bufferView:15,componentType:5126,count:24,type:"VEC2"},{bufferView:16,componentType:5126,count:24,max:[2.0003609657287598,1,1],min:[.0003610849380493164,-1,-1],type:"VEC3"},{bufferView:17,componentType:5126,count:24,type:"VEC3"},{bufferView:18,componentType:5126,count:24,type:"VEC2"},{bufferView:19,componentType:5126,count:24,max:[14.549108505249023,1,1],min:[12.549108505249023,-1,-1],type:"VEC3"},{bufferView:20,componentType:5126,count:24,type:"VEC3"},{bufferView:21,componentType:5126,count:24,type:"VEC2"}],bufferViews:[{buffer:0,byteLength:288,byteOffset:0},{buffer:0,byteLength:288,byteOffset:288},{buffer:0,byteLength:192,byteOffset:576},{buffer:0,byteLength:72,byteOffset:768},{buffer:0,byteLength:288,byteOffset:840},{buffer:0,byteLength:288,byteOffset:1128},{buffer:0,byteLength:192,byteOffset:1416},{buffer:0,byteLength:288,byteOffset:1608},{buffer:0,byteLength:288,byteOffset:1896},{buffer:0,byteLength:192,byteOffset:2184},{buffer:0,byteLength:288,byteOffset:2376},{buffer:0,byteLength:288,byteOffset:2664},{buffer:0,byteLength:192,byteOffset:2952},{buffer:0,byteLength:288,byteOffset:3144},{buffer:0,byteLength:288,byteOffset:3432},{buffer:0,byteLength:192,byteOffset:3720},{buffer:0,byteLength:288,byteOffset:3912},{buffer:0,byteLength:288,byteOffset:4200},{buffer:0,byteLength:192,byteOffset:4488},{buffer:0,byteLength:288,byteOffset:4680},{buffer:0,byteLength:288,byteOffset:4968},{buffer:0,byteLength:192,byteOffset:5256}],buffers:[{byteLength:5448,uri:"data:application/octet-stream;base64,6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAAAQAOABQAAQAUAAcACgAGABMACgATABcAFQASAAwAFQAMAA8AEAADAAkAEAAJABYABQACAAgABQAIAAsAEQANAAAAEQAAAAQAJsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAAAACAPwAAgD8AAIC/AACAPwAAgD8AAIC/AACAPwAAgD8AAIC/AACAPwAAgL8AAIC/AACAPwAAgL8AAIC/AACAPwAAgL8AAIC/AACAPwAAgD8AAIA/AACAPwAAgD8AAIA/AACAPwAAgD8AAIA/AACAPwAAgL8AAIA/AACAPwAAgL8AAIA/AACAPwAAgL8AAIA/AACAvwAAgD8AAIC/AACAvwAAgD8AAIC/AACAvwAAgD8AAIC/AACAvwAAgL8AAIC/AACAvwAAgL8AAIC/AACAvwAAgL8AAIC/AACAvwAAgD8AAIA/AACAvwAAgD8AAIA/AACAvwAAgD8AAIA/AACAvwAAgL8AAIA/AACAvwAAgL8AAIA/AACAvwAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAA6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAAJsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAA6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAAJsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAA"}]}},_J=function(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")},vJ=_J(),xJ=vJ.gl_trans__coders=vJ.gl_trans__coders||{};xJ.inject=function(e){const t=e.toString(),n=t.indexOf("{")+1,i=t.substring(0,n),s=vJ.gl_trans__coders=vJ.gl_trans__coders||{};let o=`${i}\n    const _____getGlobal = ${_J.toString()};\n    const g___lobals = _____getGlobal()\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};`;for(const e in s)"inject"!==e&&"getTranscoder"!==e&&"registerTranscoder"!==e&&(o+='tran_____scoders["'+e+'"] ='+s[e].toString()+"\n;");return o+="\n("+_J().maptalks_gltf_loader_bundle.toString()+")({});\n",o+="\n"+t.substring(i.length),o},xJ.registerTranscoder=function(e,t){xJ[e]=t},xJ.getTranscoder=function(e){return xJ[e]};const bJ=_J().maptalks_gltf_loader;function wJ(e,t,n,i,s,o){const a=[],l=EA([],a_([],n[0],n[1],n[2]),t,i),h=function(e){return new bJ.GLTFLoader("",JSON.parse(JSON.stringify(yJ[e]))).load().then((e=>e))}(e);return h.then((e=>{CM.GLTFHelper.exportGLTFPack(e).getMeshesInfo().forEach(((e,h)=>{const c=new CM.Material({color:s||e.materialInfo.baseColorFactor}),u=new CM.Mesh(e.geometry,c);u.setUniform("uPickingId",o+h);const f=u.getDefines();f.HAS_PICKING_ID=2,u.setDefines(f),u.translate=t,u.rotation=n,u.scaling=i,vA(u.localTransform,l,e.nodeMatrix),u.originTransform=mA([],u.localTransform),u.originColor=s||e.materialInfo.baseColorFactor,a.push(u)})),o>100&&(a[0].properties.relatedMeshes=a.slice(1,2),a[1].properties.relatedMeshes=a.slice(0,1),a[2].properties.relatedMeshes=a.slice(3,4),a[3].properties.relatedMeshes=a.slice(2,3),a[4].properties.relatedMeshes=a.slice(5,6),a[5].properties.relatedMeshes=a.slice(4,5),a[6].properties.relatedMeshes=a.slice(0,6))})),a}function TJ(e,t){return Math.abs(e)*Math.sign(t)}function SJ(e,t){const n=e.getCoordinates(),i=t.coordinateToPointAtRes(n,t.getGLRes()),s=[i.x,i.y,0];XA(s,s,MJ(t,e.getTranslation()));const o=function(e,t,n,i){return e._pointAtResToContainerPoint(t,n,void 0)}(t,new Re(s[0],s[1]),t.getGLRes());o.x+=85;const a=function(e,t,n,i){{const i=e.containerPointToCoordinate(t);return e.coordinateToPointAtRes(i,n)}}(t,o,t.getGLRes());return Math.sqrt(Math.pow(a.x-s[0],2)+Math.pow(a.y-s[1],2))/5.272881136101205}function MJ(e,t){if(!e)return t;const n=e.distanceToPointAtRes(t[0],t[1],e.getGLRes()),i=e.altitudeToPoint(t[2],e.getGLRes());return ZA([],TJ(n.x,t[0]),TJ(n.y,t[1]),TJ(i,t[2]))}let CJ=class y{constructor(e){this.A=e,this._meshes=this.t()}setCoordinate(e){this.A=e}t(){const e=[],t=340/177,n=wJ("jiantou",[1.2*t,0,0],[0,0,90],[t,t,t],[89/255,206/255,147/255,0],7),i=wJ("jiantou",[0,1.2*t,0],[0,0,180],[t,t,t],[89/255,206/255,147/255,0],8),s=wJ("jiantou",[-1.2*t,0,0],[0,0,270],[t,t,t],[89/255,206/255,147/255,0],9),o=wJ("jiantou",[0,-1.2*t,0],[0,0,0],[t,t,t],[89/255,206/255,147/255,0],10);return e.push(n,i,s,o),e}getMeshes(){return this._meshes}},PJ=class p{constructor(e){this.A=e,this._meshes=this.t()}setCoordinate(e){this.A=e}t(){const e=[],t=340/177,n=wJ("xuanzhuan",[0,0,0],[180,0,0],[.5*t,.5*t,.5*t],[50/255,130/255,184/255,.8],11);return e.push(n),e}getMeshes(){return this._meshes}},IJ=class v{constructor(e){this.A=e,this._meshes=this.t()}setCoordinate(e){this.A=e}t(){const e=[],t=340/177,n=wJ("yuanhuan",[0,0,0],[0,0,0],[.5*t,.5*t,.5*t],[149/255,179/255,199/255,.5],12);return e.push(n),e}getMeshes(){return this._meshes}};class d{constructor(e){this.A=e,this._meshes=this.t()}setCoordinate(e){this.A=e}t(){const e=[],t=wJ("plane",[0,0,0],[0,0,0],[10,10,10],[1,0,0,.5],16);return e.push(t),e}getMeshes(){return this._meshes}}class L{constructor(e){this.A=e,this._meshes=this.t()}setCoordinate(e){this.A=e}t(){const e=[],t=wJ("xyzScale",[0,0,0],[0,0,0],[2,2,2],null,113);return e.push(t),e}getMeshes(){return this._meshes}}const kJ=[],OJ=[],EJ=[],RJ=[],LJ=[],DJ=[177/170,177/170,177/170],FJ=[],HJ=[1,2,3,4,12];class k{constructor(){this.translate=new CJ,this.rotation=new PJ,this.scaling=new IJ,this.planeHelper=new d,this.xyzScaleHelper=new L,this._meshes=this.t(),this.i=!0}t(){const e={};e.translate=this.translate.getMeshes(),e.rotation=this.rotation.getMeshes(),e.scaling=this.scaling.getMeshes(),e.planeHelper=this.planeHelper.getMeshes(),e.xyzScale=this.xyzScaleHelper.getMeshes();const t=340/177,n=wJ("yuanhuan41",[-2.745*t,2.745*t,0],[90,0,0],[.5*t,.5*t,.5*t],[149/255,179/255,199/255,.6],1),i=wJ("yuanhuan41",[2.745*t,2.745*t,0],[-90,0,180],[.5*t,.5*t,.5*t],[50/255,130/255,184/255,.5],2),s=wJ("yuanhuan41",[2.745*t,-2.745*t,0],[90,0,180],[.5*t,.5*t,.5*t],[149/255,179/255,199/255,.6],3),o=wJ("yuanhuan41",[-2.745*t,-2.745*t,0],[-90,0,0],[.5*t,.5*t,.5*t],[50/255,130/255,184/255,.5],4),a=wJ("yuanpan",[0,0,0],[90,0,0],[.5*t,.5*t,.5*t],[89/255,206/255,147/255,.5],5),l=wJ("zzhou",[0,0,6.5],[90,0,0],[1,1,1],[14/255,127/255,191/255,1],6);return e.translate.push(n,i,s,o,a,l),e}updateMatrix(e,t,n,i,s){const o=t.getCoordinates(),a=e.coordinateToPointAtRes(o,e.getGLRes()),l=t.o();ZA(OJ,a.x,a.y,l);const h=qA(kJ,s),c=MJ(e,t.getTranslation());XA(OJ,OJ,c),XA(OJ,OJ,h);for(const s in this._meshes)for(let o=0;o<this._meshes[s].length;o++){const a=this._meshes[s][o];for(let o=0;o<a.length;o++){const l=a[o],h=l.getUniform("uPickingId"),c=qA(kJ,l.translate);let u=qA(FJ,l.rotation);const f=l.scaling;if(11===h&&(this.i?(u[2]+=n,l.rotation[2]+=n):this.i||(u[2]+=n,l.rotation[2]+=n,u[0]=360,u[2]-=90)),h>100&&1===t.getTargets().length&&(u=t.getTargets()[0].getRotation()),HJ.indexOf(h)>-1)if(12!==h)f[0]+=i,f[1]+=i,f[2]+=i;else{const e=this._meshes.translate[4][0];f[0]=1.2*e.scaling[0],f[1]=1.2*e.scaling[0],f[2]=1.2*e.scaling[0]}let g=SJ(t,e);if(g=ZA(EJ,g,g,g),JA(c,c,g),JA(g,g,f),1===h||2===h||3===h||4===h){const e=JA(LJ,f,DJ);JA(c,c,e)}const m=a_(RJ,u[0],u[1],u[2]);if(XA(c,c,OJ),"xyzScale"===s){const e=EA([],m,c,g);vA(l.localTransform,e,l.originTransform)}else EA(l.localTransform,m,c,g)}}}getMeshes(e){const t={};return e?("xyzScale"===e?t[e]=this._meshes[e]:(t.translate=this._meshes.translate,"translate"!==e&&(t[e]=this._meshes[e])),t):t}I(e){this.i=e}dispose(){for(const e in this._meshes)for(let t=0;t<this._meshes[e].length;t++){const n=this._meshes[e][t];for(let e=0;e<n.length;e++){const t=n[e];t.geometry.dispose(),t.dispose()}}}}const NJ=[],BJ=[],zJ=[],GJ=new Re(0,0),UJ=[],VJ=[],jJ=[],WJ=[0,0,0];class G{constructor(){this.C=[],this.h=[0,0,0],this.l=[1,1,1],this.P=[0,0,0]}D(e){Array.isArray(e)?e.forEach((e=>{this.D(e)})):(e.on("remove",this.u,this),e.m={coordinate:e.getCoordinates(),translation:e.getTranslation(),rotation:e.getRotation(),scale:e.getScale()},this.C.push(e))}B(){this.C.forEach((e=>{e.off("remove",this.u,this)})),this.C=[]}p(e,t,n,i,s,o,a){for(let a=0;a<this.C.length;a++){const l=this.C[a],h=l.getRotation(),c=l.getScale(),u=this.v(o,l,i,n,t);let f=null;f=i>=0?i:i*(this.options&&this.options.scaleStrength||1);const g=XA(jJ,ZA(NJ,f*c[0],f*c[1],f*c[2]),c),m=Math.min(...g);if(Math.abs(m)<s){const e=Math.abs(m);g[0]=g[0]*(s/e),g[1]=g[1]*(s/e),g[2]=g[2]*(s/e)}const A=XA(h,n,h);l.setCoordinates(u),this.L(e,g,c);const w=l.getTranslation();l.setTRS(w,A,g)}ZA(jJ,i,i,i),XA(this.P,n,this.P),XA(this.l,jJ,this.l),XA(this.h,t,this.h),e.indexOf("translate")>-1?a.fire("positionchange",{action:e,type:"positionchange",transformtarget:this.C,center:this.getCoordinates(),scale:this.l,rotation:this.P,translation:this.h,deltaTranslate:t,deltaRotation:n,deltaScale:i}):a.fire("transforming",{action:e,type:"transforming",transformtarget:this.C,center:this.C[0].getTransformOrigin(),scale:this.l,rotation:this.P,translation:this.h,deltaTranslate:t,deltaRotation:n,deltaScale:i})}v(e,t,n,i,s){const o=t.getCenter(),a=t.getTransformOrigin(),l=e.getGLRes(),h=e.coordinateToPointAtRes(o,l,GJ);h.z=e.altitudeToPoint(o.z,l),ZA(UJ,h.x,h.y,h.z||0);const c=e.coordinateToPointAtRes(a,l,GJ);c.z=e.altitudeToPoint(a.z,l),ZA(VJ,c.x,c.y,c.z||0);const u=fy(NJ,UJ,VJ),f=a_(BJ,0,0,i[2]);ZA(jJ,n+1,n+1,n+1);oy(u,u,EA(zJ,f,s,jJ)),XA(u,u,VJ),GJ.set(u[0],u[1]);const g=e.pointAtResToCoordinate(GJ,l);return g.z=u[2]/e.altitudeToPoint(1,l),g}L(e,t,n){return"x-scale"===e&&(t[1]=n[1],t[2]=n[2]),"y-scale"===e&&(t[0]=n[0],t[2]=n[2]),"z-scale"===e&&(t[0]=n[0],t[1]=n[1]),t}M(){this.C.forEach((e=>{if(e.m){const{coordinate:t,translation:n,rotation:i,scale:s}=e.m;e.setCoordinates(t),e.setTRS(n,i,s)}}))}getScale(){return this.l}getTranslation(){return 1===this.C.length&&this.C[0].getTranslation()||WJ}getRotation(){return this.P}O(){return this.C[0]?this.C[0].getLayer():null}getCoordinates(){let e=0,t=0,n=0;const i=this.C.length;if(!i)return null;for(let s=0;s<i;s++){const i=this.C[s].getCenter();e+=i.x,t+=i.y,n+=i.z||0}e/=i,t/=i,n/=i;const s=new fl(e,t,n);for(let e=0;e<i;e++)this.C[e].setTransformOrigin(s);return s}u(e){const t=e.target,n=this.C.indexOf(t);n>-1&&(delete t.m,this.C.splice(n,1))}getTargets(){return this.C}o(){let e=0;const t=this.C.length;for(let n=0;n<t;n++)e+=this.C[n].getPointZ();return e/=t,e}F(){for(let e=0;e<this.C.length;e++)if(this.C[e].isVisible())return!0;return!1}}const qJ=[5,6,7,8,9,10],ZJ=[5,7,8,9,10],XJ=[2,4,11],YJ=[1,3,12],JJ=[12,16],QJ=[1,2,3,4],$J=[1,2,3,4,12],KJ=[],eQ=[],tQ=[],nQ=[],rQ=[],iQ=[],sQ=[];class IA extends(Ba(al(Ua))){constructor(e={}){super(e),this.options=e,this.mouseAction="moving",this.U=this.options.mode||"translate",this.V=!0,this.TransformHelper=new k,this.S=new G,this.helperScene=new CM.Scene([]),this.addToMapCount=0,this.k()}setCoordinates(e){this.T.setCoordinates(e),this.transform(this.T)}enable(){return this.V=!0,this.layerRenderer&&this.layerRenderer.setToRedraw(),this}disable(){return this.V=!1,this.layerRenderer&&this.layerRenderer.setToRedraw(),this.map&&this.map.resetCursor(),this}setMode(e){this.U=e,this._(),this.layerRenderer&&this.layerRenderer.setToRedraw(),this.fire("modechange",{mode:e,type:"modechange"})}getMode(){return this.U}isEnable(){return this.V}H(e){qJ.indexOf(e)>-1?this.U="translate":XJ.indexOf(e)>-1?this.U="rotation":YJ.indexOf(e)>-1?this.U="scaling":"xyzScale"!==this.U&&(this.U="translate")}J(){return this.U}addTo(e){if(this.map)return this.N(),void console.warn("transform control has been added to a map, it suggest remove from the map before");this.addToMapCount++,this.map=e;const t=e.getLayers((e=>e instanceof GroupGLLayer))[0];this.R.addTo(t||this.map),this.container=e.getContainer(),e.on("dom:mousemove",this.K,this),e.on("dom:mousedown",this.G,this),e.on("dom:mouseup",this.j,this),e.on("zooming moving dragrotating",this.Z,this),this.Y()}k(){this.R=new It(`${vt}_transformcontrol`),this.T=new ct([0,0],{symbol:{url:"cube",modelHeight:1,uniforms:{polygonOpacity:.01}}}).addTo(this.R)}remove(){this.map&&(this.N(),this.TransformHelper.dispose(),this.R.remove(),this.layerRenderer&&this.layerRenderer.setToRedraw(),delete this.T,delete this.R,delete this.map,delete this.layer,delete this.layerRenderer,delete this.container,delete this.S)}N(){this.container&&this.map&&(this.map.off("dom:mousemove",this.K,this),this.map.off("dom:mousedown",this.G,this),this.map.off("dom:mouseup",this.j,this),this.map.off("zooming moving dragrotating",this.Z,this),this.layer&&this.layer.off("renderend",this.render,this))}K(e){if(this.W()){if(this.currentMousePosition={x:e.containerPoint.x,y:e.containerPoint.y},"moving"===this.mouseAction){const e=this.q();this.currentPickingObject=this.X(this.currentMousePosition,e,"meshes"),this.currentPickingObject&&null!=this.currentPickingObject.pickingId?(this.H(this.currentPickingObject.pickingId),this.$(6===this.currentPickingObject.pickingId)):(this.$(!1),this.H()),this.AA()}this.eA(this.currentMousePosition)}}G(e){if(!this.W()||0!==e.domEvent.button)return;const t=this.q();this.currentMousePosition={x:e.containerPoint.x,y:e.containerPoint.y},this.tA=!0,this.currentPickingObject=this.X(this.currentMousePosition,t,"meshes"),this.firstDownPoint=this.X(this.currentMousePosition,t,"meshes"),this.currentPickingObject&&null!=this.currentPickingObject.meshId?(this.mouseAction="transform",this.sA(this.currentPickingObject.pickingId),this.map.config("zoomable",!1),this.map.config("draggable",!1),this.layerRenderer&&this.layerRenderer.setToRedraw()):(this.mouseAction="pan",this.map.config("zoomable",!0),this.map.config("draggable",!0),this._()),this.lastMousePosition=this.currentMousePosition,this.lastPickingObject=this.currentPickingObject,this.lastPickingMesh=t[this.currentPickingObject.meshId]}j(){"transform"===this.mouseAction&&(this.firstDownPoint=null,this._(),this.tA=!0,this.fire("transformend",{action:this.iA,type:"transformend",transformtarget:this.S.getTargets()})),this.mouseAction="moving","xyzScale"!==this.U&&(this.U="translate"),this.map.config("zoomable",!0),this.map.config("draggable",!0),this.layerRenderer&&this.layerRenderer.setToRedraw()}Z(){const e=this.TransformHelper.planeHelper.getMeshes()[0][0],t=this.map.getBearing();e.rotation[2]=-t,this.nA()}nA(){this.W()&&(this.TransformHelper.updateMatrix(this.map,this.S,0,0,[0,0,0]),this.tA=!0)}picked(e){if(!this.layerRenderer)return!1;const t=this.q();let n=e;e instanceof Re||(n=this.map.coordinateToContainerPoint(new fl(e)));const i=this.X(n,t,"picked");return!(!i||null===i.meshId)}_(){const e=this.TransformHelper.getMeshes("scaling").scaling[0][0],t=340/177;e.scaling=[.6*t,.6*t,.6*t],this.layerRenderer&&(this.oA(e),this.IA())}IA(){this.TransformHelper._meshes.translate.forEach((e=>{for(let t=0;t<e.length;t++){const n=e[t];QJ.indexOf(n.getUniform("uPickingId"))>-1&&n.material.set("color",n.originColor)}}))}oA(e){const t=this.S.getCoordinates(),n=this.map.coordinateToPointAtRes(t,this.map.getGLRes()),i=[n.x,n.y,0],s=MJ(this.map,this.S.getTranslation());XA(i,i,s);const o=qA([],e.translate),a=e.scaling;let l=SJ(this.S,this.map);l=ZA([],l,l,l),JA(o,o,l),JA(l,l,a),XA(o,o,i),EA(e.localTransform,[0,0,0,1],o,l),this.q().forEach((e=>{const t=e.getUniform("uPickingId");if(1===t||3===t||2===t||4===t){const t=qA([],e.translate),n=170/177;e.scaling=[n,n,n];const s=e.scaling,o=e.rotation;let a=SJ(this.S,this.map);a=ZA([],a,a,a),JA(t,t,a),JA(a,a,s),XA(t,t,i);const l=a_([],o[0],o[1],o[2]);EA(e.localTransform,l,t,a)}}))}gA(e){const t=this.map.containerPointToCoordinate(e),n=this.map.coordinateToPointAtRes(t,this.map.getGLRes());return{point:[n.x,n.y]}}eA(e){if("transform"===this.mouseAction){const e=this.J(),t=MJ(this.map,this.S.getTranslation()),n=this.S.o();let i=null,s=null;if(t[2]+n<.01&&"z-translate"!==this.iA)i=this.gA(this.currentMousePosition),s=this.gA(this.lastMousePosition);else{const e=this.TransformHelper.planeHelper.getMeshes()[0];if(i=this.X(this.currentMousePosition,e,"plane"),s=this.X(this.lastMousePosition,e,"plane"),!i||null===i.meshId||!s||null===s.meshId)return}const o=[0,0,0],a=[0,0,0];let l=0,h=0,c=0;if("translate"===e){if("xy-translate"===this.iA){const e=i.point[1]-s.point[1];o[0]=i.point[0]-s.point[0],o[1]=e}else if("x-translate"===this.iA){o[0]=i.point[0]-s.point[0]}else if("y-translate"===this.iA){o[1]=i.point[1]-s.point[1]}else if("z-translate"===this.iA){let e=0;if(this.rA()){const t=this.map.getGLRes(),n=this.map._pointAtResToContainerPoint(new Re(s.point[0],s.point[1]),t),o=this.map._pointAtResToContainerPoint(new Re(i.point[0],i.point[1]),t),a=J_(U_(nQ,i.point[0]-s.point[0],i.point[1]-s.point[1]));e=o.y<n.y?a:-a}else e=i.point[2]-s.point[2];o[2]=e}}else if("rotation"===e)h=this.aA(i.point,s.point),this.TransformHelper.I(h>=0),a[2]+=h;else if("scaling"===e||"xyzScale"===e){const e=this.CA(),t=J_(U_(nQ,this.firstDownPoint.point[0]-e[0],this.firstDownPoint.point[1]-e[1])),n=J_(U_(nQ,s.point[0]-e[0],s.point[1]-e[1]));l=this.hA(i.point,s.point,e,n),c=this.hA(i.point,s.point,e,t)}this.TransformHelper.updateMatrix(this.map,this.S,h,c,o),this.S.p(this.iA,o,a,l,.01,this.map,this)}this.lastMousePosition=e,this.lastPickingObject=this.currentPickingObject;const t=this.q();this.lastPickingMesh=t[this.currentPickingObject.meshId]}hA(e,t,n,i,s){const o=(J_(U_(nQ,e[0]-n[0],e[1]-n[1]))-J_(U_(nQ,t[0]-n[0],t[1]-n[1])))/i;return s?(s[0]-.01)*o:o}CA(){const e=this.map,t=this.S.getCoordinates(),n=e.coordinateToPointAtRes(t,e.getGLRes()),i=ZA(rQ,n.x,n.y,0);return XA(i,i,MJ(e,this.S.getTranslation())),i}$(e){const t=this.TransformHelper.planeHelper.getMeshes()[0][0],n=PA(tQ,t.localTransform),i=kA(eQ,t.localTransform);let s=a_(KJ,0,0,0);const o=this.map.getBearing();e&&!this.rA()?(s=a_(KJ,90,0,-o),0===t.rotation[0]&&(this.tA=!0),ZA(t.rotation,90,0,-o)):(90===t.rotation[0]&&(this.tA=!0),ZA(t.rotation,0,0,-o)),EA(t.localTransform,s,n,i)}rA(){if(this.map.getPitch())return!1;const e=this.map.cameraPosition,t=this.map.coordinateToPointAtRes(this.map.getCenter(),this.map.getGLRes());ZA(t,t.x,t.y,0);const n=this.S.getCoordinates(),i=this.map.coordinateToPointAtRes(n,this.map.getGLRes()),s=MJ(this.map,this.S.getTranslation()),o=ZA(tQ,i.x,i.y,0);return ly(YA([],e,XA(o,o,s)),YA([],e,t))<1/180*Math.PI}AA(){const e=this.q();if(this.currentPickingObject&&null!=this.currentPickingObject.meshId){this.wA(),this.lastPickingObject&&null!=this.lastPickingObject.meshId&&this.lastPickingObject.meshId!==this.currentPickingObject.meshId&&this.cA();const t=e[this.currentPickingObject.meshId];if(t&&JJ.indexOf(this.currentPickingObject.pickingId)<0)if(this.currentPickingObject.pickingId>100)this.QA(t);else{t.material.set("color",[t.originColor[0],t.originColor[1],t.originColor[2],.8]),this.fA(t,.5)}this.layerRenderer.setToRedraw()}else this.lastPickingObject&&null!=this.lastPickingObject.meshId&&(this.map.resetCursor(),this.cA(),this.layerRenderer.setToRedraw())}QA(e){const t=[1,179/255,2/255,1];e.material.set("color",t),e.properties.relatedMeshes&&e.properties.relatedMeshes.forEach((e=>{e.material.set("color",t)}))}wA(){6===this.currentPickingObject.pickingId?this.map.setCursor("ns-resize"):ZJ.indexOf(this.currentPickingObject.pickingId)>-1?this.map.setCursor("move"):this.map.setCursor("pointer")}cA(){const e=this.lastPickingMesh;if(!e)return;const t=e.getUniform("uPickingId"),n=this.q();ZJ.indexOf(t)>-1?n.forEach((e=>{ZJ.indexOf(e.getUniform("uPickingId"))>-1&&e.material.set("color",e.originColor)})):$J.indexOf(t)>-1?n.forEach((e=>{const t=e.getUniform("uPickingId");QJ.indexOf(t)>-1&&e.material.set("color",e.originColor)})):11===t&&n.forEach((e=>{QJ.indexOf(e.getUniform("uPickingId"))>-1&&e.material.set("color",e.originColor)})),e.material.set("color",e.originColor),e.properties.relatedMeshes&&e.properties.relatedMeshes.forEach((e=>{e.material.set("color",e.originColor)}))}fA(e,t){const n=e.getUniform("uPickingId"),i=this.q();ZJ.indexOf(n)>-1?i.forEach((n=>{if(ZJ.indexOf(n.getUniform("uPickingId"))>-1&&n.getUniform("uPickingId")!==e.getUniform("uPickingId")){n.material.set("color",[n.originColor[0],n.originColor[1],n.originColor[2],t])}})):"scaling"===this.U?i.forEach((e=>{const t=e.getUniform("uPickingId");if(1===t||3===t||2===t||4===t){e.material.set("color",[149/255,179/255,199/255,.8])}})):"rotation"===this.U&&i.forEach((e=>{const t=e.getUniform("uPickingId");if(1===t||3===t||2===t||4===t){const t=e.originColor;e.material.set("color",[t[0],t[1],t[2],0])}}))}reset(){this.map&&this.S&&(this.S.M(),this.TransformHelper.updateMatrix(this.map,this.S,0,0,[0,0,0]))}aA(e,t){const n=this.CA(),i=U_(iQ,t[0]-n[0],t[1]-n[1]),s=U_(sQ,e[0]-n[0],e[1]-n[1]),o=Math.atan2(i[1],i[0]);return(Math.atan2(s[1],s[0])-o)/Math.PI*180}sA(e){return this.iA=113===e||114===e?"x-scale":115===e||116===e?"z-scale":117===e||118===e?"y-scale":119===e?"xyz-scale":5===e?"xy-translate":6===e?"z-translate":7===e||9===e?"x-translate":8===e||10===e?"y-translate":11===e?"z-rotate":"scale",this.iA}transform(e){if(!e)return;if(this.layerRenderer&&this.layerRenderer.layer&&(this.layerRenderer.layer.off("renderend",this.render),this.layerRenderer.layer.off("resizeCanvas",this.lA)),!this.map)return void console.error("should add to a target first");if(this.S&&(this.S.B(),this.S.D(e)),!this.S.getTargets().length)return;this.TransformHelper.updateMatrix(this.map,this.S,0,0,[0,0,0]),this.PA(),this.tA=!0}getTransformTarget(){return this.S}u(){delete this.S}PA(){const e=this.S.O();e&&(e.off("renderend",this.render),e.off("resizeCanvas",this.lA));const t=this.map,n=e.getRenderer();this.layerRenderer=n,this.regl=n.regl,this.renderer=n.renderer,this.DA=this.layerRenderer.getFBORayPicking(),this.uA={projViewMatrix:t.projViewMatrix,projMatrix:t.projMatrix,viewMatrix:t.viewMatrix,pointSize:1},e.on("renderend",this.render,this),e.on("resizeCanvas",this.lA,this),n.setToRedraw()}lA(){this.DA.clear(),this.tA=!0}X(e,t,n){const i=this.map;if(!(i&&this.DA&&this.layerRenderer&&this.layerRenderer.canvas))return null;const s=i.getDevicePixelRatio(),o=e.x*s,a=e.y*s,l=this.uA;return(this.tA||this.layerRenderer.canvas.gl&&this.layerRenderer.canvas.gl.wrap||!this.mA||this.mA!==n)&&(this.DA.render(t,l,!0),this.mA=n,this.tA=!1),this.DA.pick(o,a,10,l,{viewMatrix:this.map.viewMatrix,projMatrix:this.map.projMatrix,returnPoint:!0})}Y(){const e=this.map.getDevicePixelRatio();this.bA=new CM.MeshShader({vert:"attribute vec3 aPosition;\n\nuniform mat4 projViewModelMatrix;\n\n\n\nvoid main()\n\n{\n\n    gl_Position = projViewModelMatrix * vec4(aPosition, 1.0);\n\n\n\n}\n\n",frag:"precision mediump float;\n\nuniform vec4 color;\n\n\n\nvoid main() {\n\n    gl_FragColor = color;\n\n}\n\n",uniforms:["color",{name:"projViewModelMatrix",type:"function",fn:function(e,t){return vA([],t.projViewMatrix,t.modelMatrix)}}],extraCommandProps:{viewport:{x:0,y:0,width:()=>this.map?this.map.width*e:1,height:()=>this.map?this.map.height*e:1},depth:{enable:!0,func:"always",mask:!0,range:[0,0]},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}},defines:{}})}render(){if(!this.W())return;const e=this.q();this.helperScene.setMeshes(e);const t=this.layerRenderer.getFrameContext();if(t&&t.renderTarget&&this.layerRenderer.getFrameTimestamp()!==t.timestamp)return;this.nA(),this.bA.filter=t&&t.sceneFilter;this.renderer.render(this.bA,this.uA,this.helperScene,t&&t.renderTarget&&t.renderTarget.fbo)}q(){let e=[];const t=this.TransformHelper.getMeshes(this.U);for(const n in t){if("translate"===n)continue;const i=t[n];for(let t=0;t<i.length;t++)e=e.concat(i[t])}const n=t.translate;if(n)for(let t=0;t<n.length;t++)e=e.concat(n[t]);return e}W(){const e=this.layerRenderer,t=e&&e.layer;return e&&this.S&&t&&t.isVisible()&&this.S.F()&&this.regl&&this.V}}IA.mergeOptions({scaleStrength:2}),"undefined"!=typeof console&&console.log("@maptalks/transform-control v0.106.7");
/*!
   * @maptalks/video-layer v0.103.0
   * LICENSE : UNLICENSED
   * (c) 2016-2025 maptalks.org
   */
/*!
  * Contains code from THREE.js
  * MIT License
  * https://github.com/mrdoob/three.js
  */
for(var oQ=[],aQ=0;aQ<6;aQ++)oQ[aQ]=[];var lQ=[];function hQ(e,t,n){var i,s,o,a,l,h,c,u,f,g,m,A,w,T,S,M,C;s=(i=e)[0],o=i[1],a=i[2],c=i[5],u=i[6],m=i[9],A=i[10],S=i[13],M=i[14],cQ(oQ[0],(l=i[3])-s,(f=i[7])-(h=i[4]),(w=i[11])-(g=i[8]),(C=i[15])-(T=i[12])),cQ(oQ[1],l+s,f+h,w+g,C+T),cQ(oQ[2],l+o,f+c,w+m,C+S),cQ(oQ[3],l-o,f-c,w-m,C-S),cQ(oQ[4],l-a,f-u,w-A,C-M),cQ(oQ[5],l+a,f+u,w+A,C+M);for(var I=0;I<6;I++){var E=oQ[I];if(lQ[0]=E[0]>0?t[1][0]:t[0][0],lQ[1]=E[1]>0?t[1][1]:t[0][1],lQ[2]=E[2]>0?t[1][2]:t[0][2],uQ(E,lQ)<0)return!1}return!0}function cQ(e,t,n,i,s){var o=1/Math.sqrt(t*t+n*n+i*i);return e[0]=t*o,e[1]=n*o,e[2]=i*o,e[3]=s*o,e}function uQ(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]}const fQ={vert:"\n    attribute vec3 aPosition;\n    attribute vec2 aTexCoord;\n    uniform mat4 projViewModelMatrix;\n    uniform mat4 positionMatrix;\n    uniform mat4 modelMatrix;\n    varying vec2 vTexCoords;\n    #include <get_output>\n    void main()\n    {\n        mat4 localPositionMatrix = getPositionMatrix();\n        vec4 localPosition = getPosition(aPosition);\n        gl_Position = projViewModelMatrix * localPositionMatrix * localPosition;\n        vTexCoords = aTexCoord;\n    }\n",frag:"\n    precision mediump float;\n    uniform sampler2D videoTexture;\n    uniform float opacity;\n\n    varying vec2 vTexCoords;\n    void main() {\n        vec4 color = texture2D(videoTexture, vTexCoords);\n        gl_FragColor = color * opacity;\n    }\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(e,t)=>vA([],t.projViewMatrix,t.modelMatrix)},"texture","opacity"],positionAttribute:"POSITION",extraCommandProps:{depth:{enable:!0,func:"always"},cull:{enable:!1,face:"back"},frontFace:"cw",blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},dQ=[1,0,3,3,2,1];function pQ(e,t,n){if(!e)return null;const i=e.coordinateToPointAtRes(t,e.getGLRes());return[i.x,i.y,n]}class y extends(Ba(al(Ua))){constructor(e,t){super(t),this.setCoordinates(e),this.I()}setCoordinates(e){this.R=e}getCoordinates(){return this.R}setVideo(e){this.D="stop",this.options.url=e,delete this.options.elementId,this.I()}setElementId(e){this.D="stop",this.options.elementId=e,delete this.options.url,this.I()}I(){this.D="stop";const e=this.options.url;let t=document.getElementById(this.options.elementId);if(e&&(t=document.createElement("video"),t.src=e),!t)throw new Error("there is no element or url setting for video mask");t.autoplay=!0,t.loop=!0,t.muted=!0,t.play(),t.addEventListener("playing",(()=>{this.D="playing",this.fire("playing",{state:this.D,url:e})})),t.addEventListener("pause",(()=>{this.D="pause",this.fire("pause",{state:this.D,url:e})})),t.addEventListener("error",(()=>{throw this.D="pause",this.fire("error",{state:this.D,url:e}),new Error("video resource load error")})),this.video=t}getVideo(){return this.video}L(e){this.j=e}C(){return this.j}addTo(e){if(this.F)throw new Error("VideoSurface cannot be added to two or more layers at the same time.");return e.addSurfaces(this),this}show(){return this.options.visible=!0,this}hide(){return this.options.visible=!1,this}isVisible(){return this.options.visible}play(){this.video&&this.video.play()}pause(){this.video&&this.video.pause()}setAudio(e){this.video.muted=e}setOpacity(e){this.options.opacity=e}getOpacity(){return this.options.opacity}remove(){delete this.video;const e=this.getLayer();e&&e.removeVideoSurfaces(this),this.endEdit()}getLayer(){return this.F}A(){return"playing"===this.D}startEdit(){const e=this.getLayer();if(!e)return void console.warn("videosurface should be added to a map before edit");const t=e.getMap();if(!t)return void console.warn("videosurface should be added to a map before edit");if(this.N(),!this.G){const n=e.getId();this.G=new td(`internal_${n}_edit`).addTo(t)}const n=this.getCoordinates();this.H=new df(n,{symbol:{lineColor:"#34495e",lineWidth:2,polygonFill:"rgb(135,196,240)",polygonOpacity:.1}}).addTo(this.G),this.H.startEdit({newVertexHandleSymbol:{polygonFill:"rgba(0, 0, 0, 0)",polygonOpacity:0,markerType:"ellipse",markerWidth:1,markerHeight:1}}),this.H.on("shapechange",(t=>{const n=t.target.getCoordinates()[0].slice(0,4).map((e=>[e.x,e.y,0]));this.setCoordinates(n),e.getRenderer().M(this)}),this)}endEdit(){this.G&&(this.H.endEdit(),this.H.remove(),this.G.remove()),delete this.G,delete this.H}N(){this.G&&this.G.clear(),delete this.H}}y.mergeOptions({opacity:1,visible:!0});class b extends Lu{constructor(e,t,n){!t||Array.isArray(t)||t instanceof y||(n=t,t=null),super(e,n),this.W={},this.videoId=0,this.W={},this.videoId=0,t&&this.addSurfaces(t)}addSurfaces(e){if(e)if(Array.isArray(e))e.forEach((e=>{this.addMarker(e)}));else{e.F=this,this.W[this.videoId]=e,e.L(this.videoId);const t=this.getRenderer();t?t.m()&&t.u(e):this.on("renderercreate",(t=>{t.renderer.m()&&t.renderer.u(e)})),this.videoId++}}showTopAlways(e){this.options.showTopAlways=e;const t=this.getRenderer();t&&t._()}setDoubleSide(e){this.options.doubleSide=e;const t=this.getRenderer();t&&t._()}getVideoSurfaces(){const e=[];for(const t in this.W)e.push(this.W[t]);return e}removeVideoSurfaces(e){if(Array.isArray(e))e.forEach((e=>{this.removeVideoSurfaces(e)}));else{const t=e.C(),n=this.getRenderer();n&&n.k(t),delete this.W[t]}}remove(){this.clear(),super.remove()}clear(){const e=this.getVideoSurfaces();for(let t=0;t<e.length;t++)e[t].remove()}}b.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,markerEvents:!0,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,showTopAlways:!0,doubleSide:!0}),b.registerJSONType("VideoLayer"),b.registerRenderer("gl",class x extends Om.CanvasRenderer{constructor(e){super(e),this.t={}}draw(e,t){this.prepareCanvas(),this.i(t)}drawOnInteracting(e,t,n){this.i(n)}needToRedraw(){return!0}hitDetect(){return!1}createContext(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl;else{const e=this.layer.options.glOptions||{alpha:!0,depth:!0,stencil:!0};this.glOptions=e,this.gl=this.gl||this.o(this.canvas,e),this.regl=Wm({gl:this.gl,extensions:["ANGLE_instanced_arrays","OES_texture_float","OES_texture_half_float","OES_texture_float_linear","OES_texture_half_float_linear","EXT_shader_texture_lod","OES_element_index_uint","OES_standard_derivatives","WEBGL_depth_texture"],optionalExtensions:this.layer.options.glExtensions||[]})}this.h(),this.l();const e=this.layer.getVideoSurfaces();for(let t=0;t<e.length;t++)this.u(e[t])}o(e,t){const n=["webgl","experimental-webgl"];let i=null;for(let s=0;s<n.length;++s){try{i=e.getContext(n[s],t)}catch(e){}if(i)break}return i}l(){const e=this.layer.getMap(),t=new CM.Renderer(this.regl);this.renderer=t,this.p={projMatrix:e.projMatrix,projViewMatrix:e.projViewMatrix,viewMatrix:e.viewMatrix,halton:[.2107,-.0202],uHalton:[.2107,-.0202],uCameraPosition:e.cameraPosition,cameraPosition:e.cameraPosition,globalTexSize:[e.width,e.height]}}m(){return this.regl}h(){this.viewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},this._()}_(){this.v&&this.v.dispose(),this.layer.options.showTopAlways?(fQ.extraCommandProps.depth.mask=!1,fQ.extraCommandProps.depth.range=[0,0]):(delete fQ.extraCommandProps.depth.mask,delete fQ.extraCommandProps.depth.range),fQ.extraCommandProps.cull.enable=!this.layer.options.doubleSide,this.v=new CM.MeshShader(fQ)}u(e){const t=this.regl.texture(),n=new CM.Material({videoTexture:t,opacity:1}),i=e.getCoordinates(),{worldCenter:s,points:o}=this.O(i),a=this.S(o),l=new CM.Mesh(a,n);this.T(l,s);const h=new CM.Scene(l),c=e.C();this.t[c]=h}M(e){const t=e.C(),n=this.t[t].getMeshes()[0],i=e.getCoordinates();n.geometry.dispose();const{worldCenter:s,points:o}=this.O(i),a=this.S(o);n.geometry=a,this.T(n,s)}i(e){const t=this.layer.getVideoSurfaces().filter((e=>e.isVisible()));if(!t.length)return;const n=this.P(t);if(!n)return;let i=null;e&&(i=e.renderTarget&&e.renderTarget.fbo),this.renderer.render(this.v,this.p,n,i)}S(e){return new CM.Geometry({POSITION:e,TEXCOORD:[0,0,1,0,1,1,0,1]},dQ,0,{primitive:"triangles",positionAttribute:"POSITION",uv0Attribute:"TEXCOORD",normalAttribute:"NORMAL",positionSize:3})}O(e){let t=[];const n=this.getMap(),i=new df(e).getCenter(),s=pQ(n,i,0);return this.V=s,n&&e.forEach((e=>{const i=new fl(e[0],e[1]),o=n.altitudeToPoint(e[2]||0,n.getGLRes()),a=pQ(n,i,o);a[0]=a[0]-s[0],a[1]=a[1]-s[1],t=t.concat(a)})),{worldCenter:s,points:t}}P(e){const t=[],n=this.layer.getMap();for(let i=0;i<e.length;i++){const s=e[i],o=this.t[s.C()];if(!o)continue;const a=o.getMeshes();for(let e=0;e<a.length;e++){const i=a[e],o=i.getMaterial(),l=o.get("videoTexture");l&&s.A()&&(l(s.video),o.set("opacity",s.getOpacity())),hQ(n.projViewMatrix,i.getBoundingBox())&&t.push(i)}}return t.length?new CM.Scene(t):null}T(e,t){EA(e.localTransform,a_([],0,0,0),t,[1,1,1])}remove(){this.v&&this.v.dispose(),super.remove()}k(e){const t=this.t[e];t&&t.getMeshes().forEach((e=>{e.geometry.dispose(),e.material&&e.material.dispose(),e.dispose()}))}}),"undefined"!=typeof console&&console.log("@maptalks/video-layer v0.103.0"),"undefined"!=typeof window&&(window.maptalksgl=window.maptalksgl||{},window.maptalksgl.transcoders=window.maptalksgl.transcoders||ox),e.Ajax=Jn,e.ArcConnectorLine=Qf,e.ArcCurve=zf,e.Area3DTool=class Area3DTool extends Measure3DTool{_addHelperLayer(){super._addHelperLayer(),this._helperLayer=new td(vt+"_area3dtool").addTo(this._map),this._markerLayer=new td(vt+"_area3dtool_marker").addTo(this._map)}_drawVertexMarker(){const e=this._getPolygonCoordinates(this._drawCoordinates);this._helperGeometry.setCoordinates(e),this._polygon.setCoordinates(e);const t=this._markerLayer.getGeometries(),n=this._helperLayer.getGeometries().length;for(let e=0;e<t.length;e++){const i=t[e].getId();i!=="label"+n&&i.indexOf(`${n}_`)>-1&&t[e].remove()}for(let e=0;e<this._drawCoordinates.length;e++)new mf(this._drawCoordinates[e],{id:n+"_"+e,symbol:this.options.vertexSymbol}).addTo(this._markerLayer);this._drawLabel()}_getPolygonCoordinates(e){const t=e.map((e=>e));return e.length>2&&t.push(e[0]),t}_drawLabel(){const e=this.getMeasureResult(),t=(("zh-CN"===this.options.language?0:1)?"area: ":"面积: ")+this._getUnitContent(e),n=this._drawCoordinates[this._drawCoordinates.length-1],i=this._helperLayer.getGeometries().length,s=Zi.extend({id:"label"+i},this.options.labelSymbol);this._label?(this._label.setContent(t),this._label.setCoordinates(n)):this._label=new Zf(t,n,s).addTo(this._markerLayer)}_getUnitContent(e){let t;t="zh-CN"===this.options.language?[" 平方米"," 平方公里"," 平方英尺"," 平方英里"]:[" sq.m"," sq.km"," sq.ft"," sq.mi"];let n="";if(this.options.metric&&(this._measure=e<1e6?e.toFixed(2):(e/1e6).toFixed(2),this._units=e<1e6?t[0]:t[1]),this.options.imperial){n.length>0&&(n+="\n");const i=27878400;this._measure=(e*=3.2808399)<i?e.toFixed(2):(e/i).toFixed(2),this._units=e<i?t[2]:t[3]}return n+=this._measure+this._units,n}_addHelperGeometry(e){this._helperGeometry||(this._helperGeometry=new yf([e],{symbol:this.options.symbol}).addTo(this._helperLayer),this._polygon=new df([e])),this._drawVertexMarker(),this._first=!0}getMeasureResult(){return this._polygon.getArea()}},e.AreaTool=Dd,e.B3DMLoader=ri,e.BBOXUtil=Ss,e.BillBoardPainter=ia,e.BillBoardPlugin=SG,e.BoxInsideClipMask=class BoxInsideClipper extends BoxClipMask{constructor(e,t){super(e,t),this._mode="clip-inside"}},e.BoxOutsideClipMask=class BoxOutsideClipper extends BoxClipMask{constructor(e,t){super(e,t),this._mode="clip-outside"}},e.Browser=ye,e.CMPTLoader=pi,e.COLOR_PROPERTIES=Ct,e.CRS=dl,e.Canvas=Ea,e.CanvasCompatible=OP,e.CanvasLayer=Ig,e.CanvasTileLayer=$p,e.Circle=Lf,e.Class=Ua,e.ClipInsideMask=class ClipInsideMask extends ClipMask{constructor(e,t){super(e,t),this._mode="clip-inside"}},e.ClipOutsideMask=ClipOutsideMask,e.CollisionIndex=ha,e.ColorMask=class ColorMask extends Mask{constructor(e,t){super(e,t),this._mode="color"}setHeightRange(e){this.options.heightRange=e,this._fireEvent("heightrangechange")}_createMesh(e){const t=this._createGeometry(e),n=new Mesh(t);return this._setDefines(n),this._setLocalTransform(n),n}_updateUniforms(e,t,n){const i=this._getMaskMode();e.setUniform("maskMode",i);const s=this._getMaskColor();if(e.setUniform("maskColor",s),bC(t)){const i=this._getHeightRange();i[0]=(i[0]-n)*t,i[1]=(i[1]-n)*t,e.setUniform("heightRange",i)}}_setDefines(e){const t=e.getDefines();t.HAS_MASK_COLOR=1,e.setDefines(t)}_getHeightRange(){const e=[0,0];return this.options.heightRange&&(e[0]=this._altitudeToPoint(this.options.heightRange[0]),e[1]=this._altitudeToPoint(this.options.heightRange[1])),e}},e.ConnectorLine=Jf,e.ContextUtil=nI,e.Coordinate=fl,e.CubicBezierCurve=Gf,e.Curve=Bf,e.DEFAULT_TEXT_SIZE=Pt,e.Distance3DTool=class Distance3DTool extends Measure3DTool{_addHelperLayer(){super._addHelperLayer(),this._helperLayer=new td(vt+"_distance3dtool").addTo(this._map),this._markerLayer=new td(vt+"_distance3dtool_marker").addTo(this._map)}_drawVertexMarker(){this._helperGeometry.setCoordinates(this._drawCoordinates);const e=this._markerLayer.getGeometries(),t=this._helperLayer.getGeometries().length;for(let n=0;n<e.length;n++){const i=e[n].getId();i!=="label"+t&&i.indexOf(`${t}_`)>-1&&e[n].remove()}for(let e=0;e<this._drawCoordinates.length;e++)new mf(this._drawCoordinates[e],{id:t+"_"+e,symbol:this.options.vertexSymbol}).addTo(this._markerLayer);this._drawLabel()}_drawLabel(){const e=this.getMeasureResult(),t=(("zh-CN"===this.options.language?0:1)?"distance: ":"距离: ")+this._getUnitContent(e),n=this._drawCoordinates[this._drawCoordinates.length-1],i=this._helperLayer.getGeometries().length,s=Zi.extend({id:"label"+i},this.options.labelSymbol);this._label?(this._label.setContent(t),this._label.setCoordinates(n)):this._label=new Zf(t,n,s).addTo(this._markerLayer)}_getUnitContent(e){let t;t="zh-CN"===this.options.language?[" 米"," 公里"," 英尺"," 英里"]:[" m"," km"," feet"," mile"];let n="";return this.options.metric&&(this._measure=e<1e3?e.toFixed(1):(e/1e3).toFixed(2),this._units=e<1e3?t[0]:t[1]),this.options.imperial&&(n.length>0&&(n+="\n"),this._measure=(e*=3.2808399)<5280?e.toFixed(1):(e/5280).toFixed(2),this._units=e<5280?t[2]:t[3]),n+=this._measure+this._units,n}_addHelperGeometry(e){this._helperGeometry||(this._helperGeometry=new yf([e],{symbol:this.options.symbol}).addTo(this._helperLayer)),this._drawVertexMarker(),this._first=!0}getMeasureResult(){return this._helperGeometry.getLength()}},e.DistanceTool=Ld,e.DomUtil=Xn,e.DragHandler=ul,e.DrawTool=od,e.DrawToolLayer=td,e.ElevateMask=class ElevateMask extends FlatMask{constructor(e,t){super(e,t),this.setElevation(t.elevation),this._mode="elevate"}setElevation(e){this.options.elevation=e,this.setFlatheight(this.options.elevation)}},e.Ellipse=Ff,e.Eventable=Ba,e.Extent=Ml,e.ExtrudePolygonLayer=ph,e.FillPainter=tH,e.FillPlugin=uG,e.FilterUtil=hV,e.FlatInsideMask=class FlatInsideMask extends FlatMask{constructor(e,t){super(e,t),this._mode="flat-inside"}},e.FlatOutsideMask=class FlatInsideMask extends FlatMask{constructor(e,t){super(e,t),this._mode="flat-outside"}},e.GEOJSON_TYPES=bt,e.GEOMETRY_COLLECTION_TYPES=xt,e.GLContext=ex,e.GLTFGeometry=class Ft extends ct{tt(e){const t=this.getMap(),n=t.getGLRes(),i=t.distanceToPointAtRes(100,100,n,this.getCenter()),s=t.altitudeToPoint(100,n);return e[0]*=i.x/100,e[1]*=i.y/100,e[2]*=s/100,e}},e.GLTFLayer=It,e.GLTFLineString=Jt,e.GLTFMarker=ct,e.GLTFMercatorGeometry=class Gt extends ct{tt(e){const t=this.getMap(),n=t.getGLRes(),i=this.getCoordinates(),s=t.coordToPointAtRes(i,n,cJ),o=bh.EPSG3857.project(i,lJ)._add(1,1),a=bh.EPSG3857.unproject(o,hJ),l=t.coordToPointAtRes(a,n,uJ),h=l.x-s.x,c=l.y-s.y,u=t.altitudeToPoint(100,n);return e[0]*=h,e[1]*=c,e[2]*=u/100,e}},e.GLTFPhongPlugin=xG,e.GLTFStandardPlugin=bG,e.Geo3DTilesLayer=$s,e.Geo3DTilesUtil=Bj,e.Geo3DTransform=SW,e.GeoJSON=Rf,e.GeoJSONVectorTileLayer=wa,e.Geometry=gu,e.GeometryCollection=vf,e.GlobalConfig=o,e.GlobalEvent=Wa,e.GroundPainter=GroundPainter,e.GroupGLLayer=GroupGLLayer,e.GroupTileLayer=Zp,e.Handler=za,e.Handlerable=al,e.HeatmapPlugin=wG,e.HeatmapProcess=HeatmapProcess,e.Height3DTool=class Height3DTool extends Measure3DTool{_addHelperLayer(){super._addHelperLayer(),this._helperLayer=new td(vt+"_height3dtool").addTo(this._map),this._markerLayer=new td(vt+"_height3dtool_marker").addTo(this._map)}_msOnDrawVertex(e){super._msOnDrawVertex(e),this._drawCoordinates.length>1&&(this._drawEnd(),this.disable())}_drawVertexMarker(){const e=this._markerLayer.getGeometries(),t=this._helperLayer.getGeometries().length;for(let n=0;n<e.length;n++){const i=e[n].getId();i!=="label"+t+"_"+n&&0===i.indexOf(`${t}_`)&&e[n].remove()}for(let e=0;e<this._drawCoordinates.length;e++)new mf(this._drawCoordinates[e],{id:t+"_"+e,symbol:this.options.vertexSymbol}).addTo(this._markerLayer);const n=this._drawCoordinates.length;if(n>1){const e=new fl([this._drawCoordinates[n-1].x,this._drawCoordinates[n-1].y,this._drawCoordinates[n-2].z]);new mf(e,{id:t+"_2",symbol:this.options.vertexSymbol}).addTo(this._markerLayer);const i=[].concat(this._drawCoordinates);i.push(e),i.push(this._drawCoordinates[0]);const s=i.map((e=>e.z));this._helperGeometry.setCoordinates(i),this._helperGeometry.setProperties({altitude:s});const o=this._map.getProjection().measureLenBetween(i[0],i[2]),a=i[1].z-i[2].z,l=Math.sqrt(Math.pow(o,2)+Math.pow(a,2));this._drawLabel(i,[l,a,o])}}_drawLabel(e,t){for(let n=0;n<e.length-1;n++){const i=e[n],s=e[n+1],o="zh-CN"===this.options.language?0:1,a=this._getUnitContent(t[n]),l=gO[o][n]+":"+a,h="label"+this._helperLayer.getGeometries().length+"_"+n,c=JSON.parse(JSON.stringify(this.options.labelSymbol));c.id=h,n<2&&(c.boxStyle.symbol.textDx*=-1);const u=1===n?i:new fl((i.x+s.x)/2,(i.y+s.y)/2,(i.z+s.z)/2),f=this._markerLayer.getGeometryById(h),g=`${h}_marker`,m=this._markerLayer.getGeometryById(g);f?(f.setContent(l),f.setCoordinates(u),m.setCoordinates(u)):(new Zf(l,u,c).addTo(this._markerLayer),new mf(u,{id:g,symbol:this.options.vertexSymbol}).addTo(this._markerLayer))}}_getUnitContent(e){let t;t="zh-CN"===this.options.language?[" 米"," 公里"," 英尺"," 英里"]:[" m"," km"," feet"," mile"];let n="";return this.options.metric&&(this._measure=e<1e3?e.toFixed(1):(e/1e3).toFixed(2),this._units=e<1e3?t[0]:t[1]),this.options.imperial&&(n.length>0&&(n+="\n"),this._measure=(e*=3.2808399)<5280?e.toFixed(1):(e/5280).toFixed(2),this._units=e<5280?t[2]:t[3]),n+=this._measure+this._units,n}_addHelperGeometry(e){this._helperGeometry||(this._helperGeometry=new yf([e],{symbol:this.options.symbol}).addTo(this._helperLayer)),this._drawVertexMarker(),this._first=!0}getMeasureResult(){return this._helperGeometry.getLength()}},e.HighlightUtil=Vk,e.INTERNAL_LAYER_PREFIX=vt,e.IconPainter=$N,e.IconPlugin=pG,e.ImageLayer=yg,e.ImageMask=class ImageMask extends Mask{constructor(e,t){super(e,t),this._mode="texture"}setUrl(e){this.options.url=e;const t=this._mesh;if(t&&t.material){const e=t.material.get("maskTexture");if(e){this._createTexture(e);const t=this.getLayer();t&&t.getRenderer().setToRedraw()}}}_createMesh(e){const{geometry:t,copyGeometry:n}=this._createGeometry(e),i=new Mesh(t),s=e.texture();return this._createTexture(s),i.material=new Material({maskTexture:s}),this._setDefines(i),this._setLocalTransform(i),this._copyMesh=new Mesh(n),this._setLocalTransform(this._copyMesh),i}_updateUniforms(e){const t=this._getMaskMode();e.setUniform("maskMode",t);const n=this._getMaskColor();if(e.setUniform("maskColor",n),this._positions&&this._positions.length)for(let t=0;t<4;t++)e.setUniform("mask_position"+t,this._positions.slice(3*t,3*t+3))}_setDefines(e){const t=e.getDefines();t.HAS_TEXTURE=1,e.setDefines(t)}_createTexture(e){const t=new Image;t.src=this.options.url,t.crossOrigin="anonymous",t.onload=function(){e(t)},t.onerror=function(){console.warn("Image load error")}}getBBox(){return this._copyMesh.getBoundingBox()}},e.JSONAble=ol,e.LRUCache=Fo,e.Label=Zf,e.Layer=Lu,e.LineGradientPlugin=dG,e.LinePainter=oH,e.LinePlugin=fG,e.LineString=yf,e.LineStringLayer=tl,e.LitPlugin=_G,e.Map=zu,e.MapTool=rd,e.MapboxUtil=hi,e.MapboxVectorTileLayer=ba,e.Marker=mf,e.MaskLayerMixin=YI,e.MaskRendererMixin=gI,e.Measure3DTool=Measure3DTool,e.MicroTask=Do,e.MultiGLTFMarker=_t,e.MultiLineString=Mf,e.MultiPoint=Tf,e.MultiPolygon=Cf,e.NUMERICAL_PROPERTIES=Mt,e.NativeLinePainter=Bo,e.NativeLinePlugin=mG,e.NativePointPainter=zo,e.OverlayLayer=ed,e.PackUtil=lV,e.ParticleLayer=Og,e.PhongPainter=uz,e.PhongPlugin=AG,e.Point=Re,e.PointExtent=Pl,e.PointLayer=Qa,e.Polygon=df,e.PolygonLayer=rl,e.QuadBezierCurve=Uf,e.RESOURCE_PROPERTIES=wt,e.RESOURCE_SIZE_PROPERTIES=Tt,e.RayCaster=RayCaster,e.Rectangle=Hf,e.ResourceProxy=sr,e.SYMBOLS_NEED_REBUILD_IN_VECTOR=uV,e.SYMBOLS_NEED_REBUILD_IN_VT=cV,e.Sector=Nf,e.Size=Ot,e.SpatialReference=uu,e.StringUtil=nn,e.TerrainFlatMaskPainter=sa,e.TerrainFlatMaskPlugin=MG,e.TextBox=qf,e.TextMarker=Wf,e.TextPainter=Eo,e.TextPlugin=gG,e.TileConfig=yp,e.TileLayer=Up,e.TileSystem=mp,e.TransformControl=IA,e.Transformation=kl,e.TubePlugin=vG,e.Util=Zi,e.Vector3DLayer=LD,e.VectorLayer=Mg,e.VectorTileLayer=CD,e.VectorTileLayerRenderer=pD,e.VideoLayer=b,e.VideoMask=class VideoMask extends Mask{constructor(e,t){super(e,t),this._mode="texture"}play(){this._video&&this._video.play()}pause(){this._video&&this._video.pause()}setAudio(e){this._video&&(this.video.muted=e)}setUrl(e){this.options.url=e,this._createVideo(e)}getState(){return this._videoState}_createMesh(e){const{geometry:t,copyGeometry:n}=this._createGeometry(e),i=new Mesh(t),s=this._createVideoTexture(e);return i.material=new Material({maskTexture:s}),this._setDefines(i),this._setLocalTransform(i),this._copyMesh=new Mesh(n),this._setLocalTransform(this._copyMesh),i}_updateUniforms(e){const t=this._getMaskMode();if(e.setUniform("maskMode",t),this._positions&&this._positions.length)for(let t=0;t<4;t++)e.setUniform("mask_position"+t,this._positions.slice(3*t,3*t+3));const n=this._getMaskColor();e.setUniform("maskColor",n)}_setDefines(e){const t=e.getDefines();t.HAS_TEXTURE=1,e.setDefines(t)}_createVideoTexture(e){this._createVideo();return e.texture()}_createVideo(){this._videoState="stop";const e=this.options.url;let t=document.getElementById(this.options.elementId);if(e&&(t=document.createElement("video"),t.src=e),!t)throw new Error("there is no element or url setting for video mask");t.autoplay=this.options.autoplay||!0,t.loop=this.options.loop||!0,t.muted=this.options.muted||!0,t.play(),t.addEventListener("playing",(()=>{this._videoState="playing"})),t.addEventListener("pause",(()=>{this._videoState="pause"})),this._video=t}_update(){const e=this._mesh;if(e&&e.material){const t=e.material.get("maskTexture");t&&this._video&&this._needUpdate()&&t(this._video)}}_needUpdate(){return"playing"===this._videoState}},e.VideoSurface=y,e.WMSTileLayer=Qp,e.WaterPlugin=TG,e.WireframePainter=dz,e.WireframePlugin=yG,e.animate=of,e.animation=af,e.color=AC,e.control=gp,e.createREGL=Wm,e.earcut=Wx,e.formatResourceUrl=or,e.getDefaultSpatialReference=function(){return JSON.parse(JSON.stringify(cu()))},e.getResouceCacheInstance=Ps,e.mat2=tA,e.mat2d=iA,e.mat3=pA,e.mat4=UA,e.math=to,e.measurer=Wl,e.parseSVG=lr,e.projection=bh,e.quat=R_,e.quat2=B_,e.registerWorkerAdapter=co,e.renderer=Om,e.reshader=CM,e.symbolizer=zc,e.transcoders=ox,e.ui=np,e.vec2=hv,e.vec3=vy,e.vec4=Yy,e.worker=Um,"undefined"!=typeof console&&console.log("maptalks-gl v0.114.0")}));
//# sourceMappingURL=maptalks-gl.js.map
